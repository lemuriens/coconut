[{"id":"acf9afadecece0b1","type":"tab","label":"Core","disabled":false,"info":"","env":[]},{"id":"5c0ec3337dae79c1","type":"tab","label":"Inputs","disabled":false,"info":"","env":[]},{"id":"4f899d35193d55b5","type":"tab","label":"Presence","disabled":false,"info":"","env":[]},{"id":"d52fd5b6a729155c","type":"tab","label":"Light","disabled":false,"info":"","env":[]},{"id":"6b59b3ce4612b9de","type":"tab","label":"Climate","disabled":false,"info":"","env":[]},{"id":"b74c6c18ccf2525f","type":"tab","label":"Devices","disabled":false,"info":"","env":[]},{"id":"2ee810558baaf606","type":"tab","label":"Heater","disabled":false,"info":"","env":[]},{"id":"e997555db6460f97","type":"tab","label":"Hot Water","disabled":true,"info":"","env":[]},{"id":"7cd318f787c94137","type":"tab","label":"Ventilation","disabled":true,"info":"","env":[]},{"id":"1c19891b5d34ae49","type":"tab","label":"Alarm clock","disabled":false,"info":"","env":[]},{"id":"1cd5c3048d47b41c","type":"tab","label":"Cover","disabled":false,"info":"","env":[]},{"id":"c999983c9e171848","type":"tab","label":"Cover OLD","disabled":true,"info":"","env":[]},{"id":"7cd5e5aaa4574eb4","type":"tab","label":"Sport","disabled":false,"info":""},{"id":"563661a0890d9e09","type":"tab","label":"Updates","disabled":false,"info":"","env":[]},{"id":"471d8d84d3052fd9","type":"subflow","name":"send remote command","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"162ef022269421e0"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"d42c5135b9bc5f3a","type":"subflow","name":"motivation","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"4ba5920aba30d978"}]}],"out":[{"x":420,"y":60,"wires":[{"id":"dfd014496172b58b","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"73a2a4f8b5d2b7d9","type":"subflow","name":"area light notif","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"0b297d7ed883029a"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"linked_lights = [obj,obj]"},{"name":"2*","type":"str","value":"effects = { count: 0, color: 0-360, saturation: 0-100, time: ms }"}],"meta":{},"color":"#DDAA99"},{"id":"f884e97a0daa4ce2","type":"subflow","name":"at home ?","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"190aea95e801d9c5"}]}],"out":[{"x":300,"y":40,"wires":[{"id":"190aea95e801d9c5","port":0}]},{"x":300,"y":120,"wires":[{"id":"190aea95e801d9c5","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"e4503a3be0539251","type":"subflow","name":"notif üì±","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"ec98ea15c67bf9ec"}]}],"out":[],"env":[{"name":"1","type":"str","value":"title"},{"name":"2","type":"str","value":"message"},{"name":"3","type":"str","value":"data"},{"name":"4","type":"str","value":"send_mobile"}],"meta":{},"color":"#DDAA99"},{"id":"3dd3ba0d3b3a0ffd","type":"subflow","name":"notif üè†","category":"","in":[{"x":60,"y":60,"wires":[{"id":"62f77bea9c5ee2e0"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"speak = \"XX\" || sound = \"XX\" || link = \"XX\""},{"name":"2","type":"str","value":"linked_area = \"XX\""},{"name":"3","type":"str","value":"volume_level = 0-1"},{"name":"4","type":"str","value":"effects = { count: 0, color: 0 - 360, time: ms }"}],"meta":{},"color":"#DDAA99"},{"id":"2f44a0de1e92d674","type":"subflow","name":"call service","info":"","category":"","in":[{"x":80,"y":80,"wires":[{"id":"d495ba6f94ce8da8"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"entity_id (string)"},{"name":"2*","type":"str","value":"state (string, number)"}],"meta":{},"color":"#DDAA99"},{"id":"759003382b0f7bfd","type":"subflow","name":"send bug to dashboard","info":"","category":"","in":[{"x":60,"y":40,"wires":[{"id":"3a4539013276671b"}]}],"out":[{"x":520,"y":100,"wires":[{"id":"cd6f5ecb873cd244","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"fe184c2d23704568","type":"subflow","name":"notification","info":"","category":"","in":[{"x":40,"y":60,"wires":[{"id":"6c66a08ade49eaa8"}]}],"out":[{"x":920,"y":380,"wires":[{"id":"67a0d0fca585c9fe","port":0},{"id":"dd1b8bd875f92e36","port":0}]}],"env":[{"name":"1*","type":"str","value":"notification_id (string)"},{"name":"2","type":"str","value":"title (string)"},{"name":"3","type":"str","value":"message (string)"},{"name":"4","type":"str","value":"alert_type (string)"},{"name":"5","type":"str","value":"send_mobile (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"4b7531d5c394bfa5","type":"subflow","name":"dev enable","info":"","category":"","in":[{"x":80,"y":80,"wires":[{"id":"ac0adff31b292daa"}]}],"out":[{"x":320,"y":40,"wires":[{"id":"ac0adff31b292daa","port":0}]},{"x":320,"y":120,"wires":[{"id":"ac0adff31b292daa","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"27aabf8cb913bb7c","type":"subflow","name":"config loaded","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"8b8b9881deb1ae38"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"085c10b4399ebc56","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"87a3c75768fca823","type":"subflow","name":"get entities","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"5a38299561de1060"}]}],"out":[{"x":300,"y":60,"wires":[{"id":"5a38299561de1060","port":0}]}],"env":[{"name":"1*","type":"str","value":"msg.search = { \"is\": { linked_class: \"\" }, \"not\": { linked_area: \"\" }}"},{"name":"2*","type":"str","value":"msg.output_name (string)"},{"name":"3","type":"str","value":"msg.output_empty_results (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"f0e72aab323e485e","type":"junction","z":"563661a0890d9e09","x":380,"y":180,"wires":[["7f38351774f7bee5"]]},{"id":"217182b034268e80","type":"junction","z":"563661a0890d9e09","x":200,"y":240,"wires":[["aed46d5fbb783010"]]},{"id":"b319ffa018a776b1","type":"junction","z":"7cd5e5aaa4574eb4","x":800,"y":120,"wires":[["361809a5b5200466"]]},{"id":"3edec4cc20d8a1e2","type":"junction","z":"7cd5e5aaa4574eb4","x":220,"y":420,"wires":[["ea6d4c718216b66d"]]},{"id":"8669a50831201699","type":"junction","z":"d52fd5b6a729155c","x":460,"y":440,"wires":[["6f640486cab5736a"]]},{"id":"67a0d0fca585c9fe","type":"junction","z":"fe184c2d23704568","x":460,"y":380,"wires":[[]]},{"id":"749de854a27038b7","type":"junction","z":"2ee810558baaf606","x":280,"y":300,"wires":[["68215847e990edf2"]]},{"id":"a24f1c5572c59d9e","type":"junction","z":"e997555db6460f97","x":220,"y":240,"wires":[["300fa7067e4de6a6"]]},{"id":"cd4bc74f56f8b1c1","type":"junction","z":"c999983c9e171848","x":200,"y":760,"wires":[["f4b9f341141753e6"]]},{"id":"150689f7e4403d97","type":"junction","z":"c999983c9e171848","x":200,"y":760,"wires":[["f4b9f341141753e6"]]},{"id":"3fd12f3709b0be01","type":"junction","z":"c999983c9e171848","x":260,"y":300,"wires":[["dbbf9aed3285dd1e"]]},{"id":"a4cddb356bda222f","type":"junction","z":"c999983c9e171848","x":260,"y":300,"wires":[["86ebb3f022191c90"]]},{"id":"f1ac6cfbcc15ceb8","type":"junction","z":"7cd5e5aaa4574eb4","x":720,"y":360,"wires":[["9f443d2836038c51"]]},{"id":"e1cc1ebe8f1068a2","type":"junction","z":"acf9afadecece0b1","x":980,"y":960,"wires":[["5906249810aabddb"]]},{"id":"62502a0a7bba9f3e","type":"junction","z":"73a2a4f8b5d2b7d9","x":760,"y":60,"wires":[["34906ca8bca8f9b4"]]},{"id":"c648843db607c708","type":"junction","z":"d52fd5b6a729155c","x":200,"y":1240,"wires":[["a55133cd4f28e3c3"]]},{"id":"275178840749fbef","type":"junction","z":"d52fd5b6a729155c","x":240,"y":500,"wires":[["c85e2d58bf904752"]]},{"id":"e376ea9dd587c304","type":"junction","z":"2ee810558baaf606","x":280,"y":300,"wires":[["2029acb2d9698e8a"]]},{"id":"38b88579e1456ada","type":"junction","z":"2ee810558baaf606","x":280,"y":620,"wires":[["d31c215f914d2681"]]},{"id":"bdda6a1e8762c590","type":"junction","z":"2ee810558baaf606","x":340,"y":680,"wires":[["236ba841642e04c3"]]},{"id":"814894a852d89dbd","type":"junction","z":"2ee810558baaf606","x":240,"y":420,"wires":[["3a2b27dcb68716f2"]]},{"id":"ade6eff6cb3524f9","type":"junction","z":"1c19891b5d34ae49","x":320,"y":120,"wires":[["a7c350ea8d86f6cd"]]},{"id":"c247e9c908e165df","type":"junction","z":"471d8d84d3052fd9","x":280,"y":60,"wires":[["0c360bf8de632261"]]},{"id":"a6c1cc0280459efb","type":"junction","z":"c999983c9e171848","x":640,"y":620,"wires":[["90fc285811f53013"]]},{"id":"7143b797d355f7fb","type":"junction","z":"fe184c2d23704568","x":460,"y":380,"wires":[["dd1b8bd875f92e36"]]},{"id":"78fc362f15c68873","type":"junction","z":"7cd5e5aaa4574eb4","x":240,"y":180,"wires":[["18be117d99f9cac5"]]},{"id":"75c38959e03cda0f","type":"junction","z":"4f899d35193d55b5","x":440,"y":500,"wires":[["d03b93e0906a12c0"]]},{"id":"723908611010fca2","type":"junction","z":"4f899d35193d55b5","x":520,"y":440,"wires":[["a03b2613cde1f8c5"]]},{"id":"10afb58252c91ffb","type":"junction","z":"4f899d35193d55b5","x":840,"y":320,"wires":[["278aa52a78449f78"]]},{"id":"1cef3e1b2fe479eb","type":"junction","z":"4f899d35193d55b5","x":520,"y":440,"wires":[["1ab1d90ecd3bbd5f"]]},{"id":"5b61c82c297376c3","type":"junction","z":"4f899d35193d55b5","x":340,"y":320,"wires":[["e349153b57fa812d"]]},{"id":"1dce0f707a52041f","type":"junction","z":"4f899d35193d55b5","x":600,"y":380,"wires":[["2c25e45eb96ffb44"]]},{"id":"2ebbb3558143410d","type":"junction","z":"5c0ec3337dae79c1","x":1140,"y":1040,"wires":[["5c0800c2187c3880"]]},{"id":"9d4c4c17ae927277","type":"junction","z":"5c0ec3337dae79c1","x":1140,"y":2060,"wires":[["b8ddcb09c43c340f"]]},{"id":"6b89526ae3f6d4f8","type":"junction","z":"5c0ec3337dae79c1","x":1260,"y":1280,"wires":[["6a68f2de087a6e67"]]},{"id":"ce0aa73004d1e959","type":"junction","z":"5c0ec3337dae79c1","x":1260,"y":2420,"wires":[["981ccab95507ea30"]]},{"id":"a7ea97033a782d57","type":"junction","z":"1cd5c3048d47b41c","x":200,"y":760,"wires":[["5768825481ed7f96"]]},{"id":"1c50af2f0ee6387b","type":"junction","z":"1cd5c3048d47b41c","x":200,"y":760,"wires":[["5768825481ed7f96"]]},{"id":"46b4150fea2150b6","type":"junction","z":"1cd5c3048d47b41c","x":240,"y":300,"wires":[["3bb95425b4f18ba2"]]},{"id":"41e3388590abf861","type":"junction","z":"1cd5c3048d47b41c","x":240,"y":300,"wires":[["4f536d716fddf3c5"]]},{"id":"6314bf30a930663d","type":"junction","z":"1cd5c3048d47b41c","x":640,"y":620,"wires":[["81ac8a362a00703d"]]},{"id":"e829eeb8fe4643da","type":"junction","z":"1cd5c3048d47b41c","x":580,"y":240,"wires":[["be53211e2c176c24"]]},{"id":"0d9bc83ee952fc19","type":"junction","z":"b74c6c18ccf2525f","x":720,"y":200,"wires":[["82f9b197e7b82827"]]},{"id":"3812603bf7eec17e","type":"junction","z":"b74c6c18ccf2525f","x":260,"y":200,"wires":[["79845bfa53ceef65"]]},{"id":"e4ba25357bac5965","type":"junction","z":"b74c6c18ccf2525f","x":260,"y":200,"wires":[["420611d4ab2fb22d"]]},{"id":"cfc2bd9c1c8aeaef","type":"junction","z":"5c0ec3337dae79c1","x":960,"y":1160,"wires":[["c6639c073cb2e0ad"]]},{"id":"4c3450536e643820","type":"junction","z":"5c0ec3337dae79c1","x":1260,"y":1160,"wires":[["4d28aab6ebce6747"]]},{"id":"fa1e848a111d1619","type":"junction","z":"d52fd5b6a729155c","x":280,"y":820,"wires":[["d7748a59b286ed90","11e915e666b244fc"]]},{"id":"b5dd0a30e2a0ceb7","type":"junction","z":"d52fd5b6a729155c","x":280,"y":1040,"wires":[["4eae095e57e3326b"]]},{"id":"f54e6f1d9d9fbf83","type":"junction","z":"4f899d35193d55b5","x":580,"y":680,"wires":[["99be64a67f242785"]]},{"id":"75f9c09001eabef8","type":"junction","z":"acf9afadecece0b1","x":180,"y":460,"wires":[["0f1dec3ad88e7ae1"]]},{"id":"ac5a0eb7e6805f0b","type":"junction","z":"acf9afadecece0b1","x":200,"y":320,"wires":[["09eb8a5a90025624"]]},{"id":"c87720f17866318d","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":": ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"264582abd80fb1fb","type":"global-config","name":"global-config","env":[]},{"id":"162ef022269421e0","type":"function","z":"471d8d84d3052fd9","name":"prepare remote","func":"let linked_device = msg.linked_device\nlet entity_id = msg.entity_id\nlet new_state = msg.new_state\nlet old_state = msg.old_state\nlet remote = msg.remote\nlet entity_msgs = []\nlet msgs = []\n\nif (typeof remote.decrease === \"string\" && typeof remote.increase === \"string\" && typeof msg.delay === \"number\") {\n    let diff = new_state - old_state\n    msgs.push(\n        {\n            payload: {\n                data: {\n                    entity_id: linked_device,\n                    command: (diff < 0 ? remote.decrease : remote.increase),\n                    num_repeats: Math.abs(diff),\n                    delay_secs: msg.delay\n                }\n            }\n        }\n    )\n    return [msgs, null]\n} else if (remote[new_state] !== undefined) {\n    for (let i = 0, c = remote[new_state]; i < c.length; i++) {\n        if (typeof c[i].command === \"string\" && typeof c[i].delay === \"number\") {\n            msgs.push(\n                {\n                    payload: {\n                        data: {\n                            entity_id: linked_device,\n                            command: c[i].command,\n                            num_repeats: 1,\n                            hold_secs: 0\n                        }\n                    },\n                    delay: c[i].delay * 1000\n                }\n            )\n        }\n    }\n    if (msg.turn_off_after_command) {\n        entity_msgs.push({ entity_id: entity_id, state: \"off\" })\n    }\n    return [msgs, entity_msgs]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[["c247e9c908e165df"],["b0f1ce7bac72b240"]]},{"id":"7ede213ed7902a5e","type":"api-call-service","z":"471d8d84d3052fd9","name":"send command to remote","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"remote","service":"send_command","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":850,"y":60,"wires":[[]]},{"id":"0c360bf8de632261","type":"delay","z":"471d8d84d3052fd9","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":true,"outputs":1,"x":500,"y":60,"wires":[["3c772a479d482a55"]]},{"id":"3c772a479d482a55","type":"delay","z":"471d8d84d3052fd9","name":"","pauseType":"rate","timeout":"0","timeoutUnits":"seconds","rate":"2","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":true,"outputs":1,"x":650,"y":60,"wires":[["7ede213ed7902a5e"]]},{"id":"b0f1ce7bac72b240","type":"subflow:2f44a0de1e92d674","z":"471d8d84d3052fd9","name":"","x":350,"y":60,"wires":[]},{"id":"dfd014496172b58b","type":"function","z":"d42c5135b9bc5f3a","name":"motivation","func":"switch (msg.payload) {\n  case 1:\n    msg.payload = \"Personne n‚Äôest trop vieux pour se fixer un nouvel objectif ou r√©aliser de nouveaux r√™ves. ‚Äì Les Brown\"\n    break\n  case 2:\n    msg.payload = \"La seule fa√ßon de faire du bon travail est d‚Äôaimer ce que vous faites. Si vous n‚Äôavez pas encore trouv√©, continuez √† chercher. - Steve Jobs\"\n    break\n  case 3:\n    msg.payload = \"Pour r√©ussir, votre d√©sir de r√©ussite doit √™tre plus grand que votre peur de l‚Äô√©chec. - Bill Cosby\"\n    break\n  case 4:\n    msg.payload = \"Un √©norme succ√®s est la meilleure des vengeances. - Frank Sinatra\"\n    break\n  case 5:\n    msg.payload = \"Je suis reconnaissant √† tous ceux qui m‚Äôont dit NON. C‚Äôest √† gr√¢ce √† eux que je suis moi-m√™me. - Albert Einstein\"\n    break\n  case 6:\n    msg.payload = \"La seule chose qui se dresse entre vous et votre r√™ve, c‚Äôest la volont√© d‚Äôessayer et la conviction qu‚Äôil est r√©ellement possible. - Joel Brown\"\n    break\n  case 7:\n    msg.payload = \"Un pessimiste voit la difficult√© dans chaque opportunit√©, un optimiste voit l‚Äôopportunit√© dans chaque difficult√©. - Winston Churchill\"\n    break\n  case 8:\n    msg.payload = \"Le succ√®s c‚Äôest d‚Äôaller d‚Äô√©chec en √©chec sans perdre son enthousiasme. - Winston Churchill\"\n    break\n  case 9:\n    msg.payload = \"Le succ√®s n‚Äôest pas la cl√© du bonheur. Le bonheur est la cl√© du succ√®s. Si vous aimez ce que vous faites, vous r√©ussirez. - Albert Schweitzer\"\n    break\n  case 10:\n    msg.payload = \"Les gagnants trouvent des moyens, les perdants des excuses. -  F. D. Roosevelt\"\n    break\n  case 11:\n    msg.payload = \"Celui qui attend que tout danger soir √©cart√© pour mettre les voiles ne prendra jamais la mer. - Thomas Fuller\"\n    break\n  case 12:\n    msg.payload = \"Ce n‚Äôest pas parce que les choses sont difficiles que nous n‚Äôosons pas, c‚Äôest parce que nous n‚Äôosons pas qu‚Äôelles sont difficiles. -  S√©n√®que\"\n    break\n  case 13:\n    msg.payload = \"Certains veulent que √ßa arrive, d‚Äôautres aimeraient que √ßa arrive et d‚Äôautres font que √ßa arrive. - Michael Jordan\"\n    break\n  case 14:\n    msg.payload = \"La plus grande erreur que puisse faire un homme est d‚Äôavoir peur d‚Äôen faire une. - Elbert Hubbard\"\n    break\n  case 15:\n    msg.payload = \"Le g√©nie est fait d‚Äôun pour cent d‚Äôinspiration et de quatre-vingt-dix-neuf pour cent de transpiration. - Thomas Edison\"\n    break\n  case 16:\n    msg.payload = \"Ce n‚Äôest pas le vent qui d√å cide de votre destination, c‚Äôest l‚Äôorientation que vous donnez √† votre voile. Le vent est pareil pour tous. - Jim Rohn\"\n    break\n  case 17:\n    msg.payload = \"L‚Äôhumanit√© se divise en trois cat√©gories : ceux qui ne peuvent pas bouger, ceux qui peuvent bouger, et ceux qui bougent. - Benjamin Franklin\"\n    break\n  case 18:\n    msg.payload = \"Dans vingt ans vous serez plus d√©√ßus par les choses que vous n‚Äôavez pas faites que par celles que vous avez faites. Alors sortez des sentiers battus. Mettez les voiles. Explorez. R√™vez. D√©couvrez. - Mark Twain\"\n    break\n  case 19:\n    msg.payload = \"Il n‚Äôy a pas de r√©ussites faciles ni d‚Äô√©checs d√©finitifs. - Marcel Proust\"\n    break\n  case 20:\n    msg.payload = \"J‚Äôai d√©cid√© d‚Äô√™tre heureux parce que c‚Äôest bon pour la sant√©. - Voltaire\"\n    break\n  case 21:\n    msg.payload = \"Celui qui veut atteindre un objectif lointain doit faire de petits pas. - Saul Bellow\"\n    break\n  case 22:\n    msg.payload = \"La plupart des choses importantes dans le monde ont √©t√© accomplies par des personnes qui ont continu√© √† essayer quand il semblait y avoir aucun espoir. - Dale Carnegie\"\n    break\n  case 23:\n    msg.payload = \"Pour r√©ussir, retenez bien ces trois maximes: voir c‚Äôest savoir, vouloir c‚Äôest pouvoir, oser c‚Äôest avoir. - Alfred de Musset\"\n    break\n  case 24:\n    msg.payload = \"Les chanceux sont ceux qui arrivent √† tout  Les malchanceux, ceux √† qui tout arrive. - Eug√®ne Labiche\"\n    break\n  case 25:\n    msg.payload = \"Pour ce qui est de l‚Äôavenir, il ne s‚Äôagit pas de le pr√©voir, mais de le rendre possible. - Antoine de Saint-Exup√©ry\"\n    break\n  case 26:\n\tmsg.payload = \"Il faut viser la lune, parce qu‚Äôau moins, si vous √©chouez, vous finirez dans les √©toiles. - Oscar Wilde\"\n\tbreak\n  case 27:\n\tmsg.payload = \"La meilleure fa√ßon de pr√©dire l‚Äôavenir est de le cr√©er. - Peter Drucker\"\n\tbreak\n  case 28:\n\tmsg.payload = \"Le d√©sir de bien faire est un puissant moteur. Celui de faire du bien est plus puissant encore. - Michael Aguilar\"\n\tbreak\n  case 29:\n\tmsg.payload = \"Croyez en vos r√™ves et ils se r√©aliseront peut-√™tre. Croyez en vous et ils se r√©aliseront s√ªrement. - Martin Luther King\"\n\tbreak\n  case 30:\n\tmsg.payload = \"Vous ne trouverez jamais ce que vous ne cherchez pas. - Confucius\"\n\tbreak\n  case 31:\n\tmsg.payload = \"Si vous pensez que vous ne valez pas grand-chose, vous ne trouverez personne pour augmenter votre prix. - Michael Aguilar\"\n\tbreak\n  case 32:\n\tmsg.payload = \"La sagesse supr√™me, c‚Äôest d‚Äôavoir des r√™ves assez grands pour ne pas les perdre de vue pendant qu‚Äôon les poursuit. - Francis Scott Fitzgerald\"\n\tbreak\n  case 33:\n\tmsg.payload = \"Si vous pouvez le r√™ver, vous pouvez le faire. - Walt Disney\"\n\tbreak\n  case 34:\n\tmsg.payload = \"Notre vie vaut ce qu‚Äôelle nous a co√ªt√© d‚Äôefforts. - Fran√ßois Mauriac\"\n\tbreak\n  case 35:\n\tmsg.payload = \"Ce sont nos choix qui montrent qui nous sommes, bien  plus que nos capacit√©s. - Joanne K.Rowling\"\n\tbreak\n  case 36:\n\tmsg.payload = \"On peut tout ce qui ne d√©pende que de notre volont√©. - Marcel Proust\"\n\tbreak\n  case 37:\n\tmsg.payload = \"Le but de la vie, ce n‚Äôest pas l‚Äôespoir de devenir parfait, c‚Äôest la volont√© d‚Äô√™tre toujours meilleur. - Ralph Waldo Emerson\"\n\tbreak\n  case 38:\n\tmsg.payload = \"La pers√©v√©rance, c‚Äôest ce qui rend l‚Äôimpossible possible, le possible probable et le probable r√©alis√å . - L√©on Trotsky\"\n\tbreak\n  case 39:\n\tmsg.payload = \"Il n‚Äôy a qu‚Äôune fa√ßon d‚Äô√©chouer, c‚Äôest d‚Äôabandonner avant d‚Äôavoir r√©ussi. - Georges Cl√©menceau\"\n\tbreak\n  case 40:\n\tmsg.payload = \"Rien de grand ne s‚Äôest accompli sans passion. - Hegel\"\n\tbreak\n  case 41:\n\tmsg.payload = \"Ne craignez pas la perfection, vous n‚Äôy parviendrez jamais. - Salvador Dali\"\n\tbreak\n  case 42:\n\tmsg.payload = \"Il vaut mieux exceller dans une seule discipline plut√¥t que d‚Äô√™tre m√©diocre dans plusieurs. - Proverbe latin\"\n\tbreak\n  case 43:\n\tmsg.payload = \"En suivant le chemin qui s‚Äôappelle plus tard, nous arrivons sur la place qui s‚Äôappelle jamais. - S√©n√∑  que\"\n\tbreak\n  case 44:\n\tmsg.payload = \"La vie est comme une bicyclette, il faut avancer pour ne pas perdre l‚Äô√©quilibre. - Albert Einstein\"\n\tbreak\n  case 45:\n\tmsg.payload = \"Les portes de l‚Äôavenir sont ouvertes √† ceux qui savent les pousser. - Coluche\"\n\tbreak\n  case 46:\n\tmsg.payload = \"Le monde n‚Äôa progress√© que gr√¢ce aux choses impossibles qui ont √©t√© r√©alis√©es. - Andr√© Maurois\"\n\tbreak\n  case 47:\n\tmsg.payload = \"Les obstacles sont ces choses effrayantes que vous apercevez lorsque vous d√©tournez les yeux de vos objectifs. - Henry Ford\"\n\tbreak\n  case 48:\n\tmsg.payload = \"Pour pouvoir contempler un arc-en-ciel, il faut d‚Äôabord endurer la pluie. - Proverbe chinois\"\n\tbreak\n  case 49:\n\tmsg.payload = \"Commencez par changer en vous ce que vous voulez changer autour de vous. - Gandhi\"\n\tbreak\n  case 50:\n\tmsg.payload = \"La folie, c‚Äôest de refaire la m√™me chose et d‚Äôen attendre un r√©sultat diff√©rent. - Albert Einstein\"\n\tbreak\n  case 51:\n\tmsg.payload = \"Agissez toujours comme s‚Äôil √©tait impossible d‚Äô√©chouer. - Winston Churchill\"\n\tbreak\n  case 52:\n\tmsg.payload = \"Il est difficile d‚Äô√©chouer. Mais il est encore plus difficile de ne pas avoir essay√© de r√©ussir. - Th√©odore Roosevelt\"\n\tbreak\n  case 53:\n\tmsg.payload = \"Se lamenter sur un malheur pass√©, voil√† le plus s√ªr moyen d‚Äôen attirer un autre. - William Shakespeare\"\n\tbreak\n  case 54:\n\tmsg.payload = \"L‚Äô√©chec n‚Äôest qu‚Äôune opportunit√© pour recommencer la m√™me chose plus intelligemment. - Henry Ford\"\n}\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":60,"wires":[[]]},{"id":"4ba5920aba30d978","type":"random","z":"d42c5135b9bc5f3a","name":"random","low":"1","high":"54","inte":"true","property":"payload","x":160,"y":60,"wires":[["dfd014496172b58b"]]},{"id":"cb03ecb91889a810","type":"api-call-service","z":"73a2a4f8b5d2b7d9","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":830,"y":60,"wires":[[]]},{"id":"fbd0075804bb69c7","type":"delay","z":"73a2a4f8b5d2b7d9","name":"delay","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":570,"y":60,"wires":[["c46aa3e710e31004"]]},{"id":"a3ad8b8e076b60eb","type":"function","z":"73a2a4f8b5d2b7d9","name":"lights","func":"let light_control = global.get(\"light_control\") ?? {}\nlet effects = msg.effects\neffects.time = effects.time / 2\nlet msgs = []\n\n// NE PAS FAIRE DE NOTIF QUAND LA LAMPE EST ETEINTE ET BLOQUEE\n\nmsgs.push({ reset: \"reset\" })\nfor (let l of msg.linked_lights) {\n    let is_locked = light_control[l.entity_id].locked\n    if (!is_locked || is_locked && l.state === \"on\") {\n\n        let brightness = l.attributes.brightness ?? 0\n        let diff_light_pct = 50\n        let light_brightness_pct = brightness_pct_limiter(100 * brightness / 255, diff_light_pct)\n        let color_temp_kelvin = l.attributes.color_temp_kelvin ?? (l.attributes.min_color_temp_kelvin + l.attributes.max_color_temp_kelvin) / 2\n\n        if (l.attributes.flowing !== undefined) {\n            let delay = 0\n            if (l.state === \"off\" || l.attributes.flowing === true) {\n                msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: l.entity_id, transition: effects.time } } })\n                delay = effects.time\n            }\n\n            if ((l.attributes.supported_color_modes ?? []).find(s => [\"hs\", \"rgb\", \"xy\"].includes(s)) && effects.saturation !== 0) {\n                msgs.push({\n                    delay: delay,\n                    domain: \"yeelight\", service: \"start_flow\", payload: {\n                        data: {\n                            entity_id: l.entity_id, count: effects.count, action: \"recover\",\n                            transitions: [\n                                { \"HSVTransition\": [effects.color, effects.saturation, effects.time, light_brightness_pct[0]] },\n                                { \"HSVTransition\": [effects.color, effects.saturation, effects.time, light_brightness_pct[1]] }\n                            ]\n                        }\n                    }\n                })\n            } else if ((l.attributes.supported_color_modes ?? []).find(s => [\"color_temp\"].includes(s))) {\n                msgs.push({\n                    delay: delay,\n                    domain: \"yeelight\", service: \"start_flow\", payload: {\n                        data: {\n                            entity_id: l.entity_id, count: effects.count, action: \"recover\",\n                            transitions: [\n                                { \"TemperatureTransition\": [color_temp_kelvin, effects.time, light_brightness_pct[0]] },\n                                { \"TemperatureTransition\": [color_temp_kelvin, effects.time, light_brightness_pct[1]] }\n                            ]\n                        }\n                    }\n                })\n            }\n        } else {\n            for (let i = 0; i < effects.count * 2; i++) {\n                let support = (l.attributes.supported_color_modes ?? []).find(s => [\"hs\", \"rgb\", \"xy\"].includes(s))\n                let parameters = { [support && effects.saturation !== 0 ? \"hs_color\" : \"color_temp_kelvin\"]: support && effects.saturation !== 0 ? [effects.color, effects.saturation] : color_temp_kelvin }\n                msgs.push({\n                    delay: effects.time * i,\n                    domain: \"light\",\n                    service: \"turn_on\",\n                    payload: { data: { entity_id: l.entity_id, brightness_pct: light_brightness_pct[i % 2], transition: effects.time, ...parameters } }\n                })\n            }\n        }\n    }\n}\n\nif (msgs.length > 1) {\n    msgs.push({ flow: \"stop\", delay: effects.count * effects.time * 2, payload: { data: { transition: 0.5 } } })\n    return [msgs]\n}\n\nfunction brightness_pct_limiter(brightness_pct, diff_light_pct) {\n    if (brightness_pct < diff_light_pct) {\n        return [0, diff_light_pct]\n    } else if (brightness_pct > (100 - diff_light_pct)) {\n        return [(100 - diff_light_pct), 100]\n    } else {\n        return [brightness_pct - diff_light_pct / 2, brightness_pct + diff_light_pct / 2]\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":60,"wires":[["fbd0075804bb69c7"]]},{"id":"c46aa3e710e31004","type":"switch","z":"73a2a4f8b5d2b7d9","name":"stop ?","property":"flow","propertyType":"msg","rules":[{"t":"eq","v":"stop","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":690,"y":60,"wires":[["62502a0a7bba9f3e"],["cb03ecb91889a810"]]},{"id":"0b8329cb14bef5d0","type":"function","z":"73a2a4f8b5d2b7d9","name":"check lights","func":"if (\n    Array.isArray(msg.linked_lights) && msg.linked_lights.length > 0 &&\n    msg.effects !== undefined &&\n    typeof msg.effects.count === \"number\" &&\n    typeof msg.effects.color === \"number\" &&\n    typeof msg.effects.saturation === \"number\" &&\n    typeof msg.effects.time === \"number\"\n) {\n    return msg\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":60,"wires":[["a3ad8b8e076b60eb"]]},{"id":"34906ca8bca8f9b4","type":"ha-fire-event","z":"73a2a4f8b5d2b7d9","name":"restore lights","server":"c87720f17866318d","version":0,"event":"restore_lights","data":"","dataType":"json","x":990,"y":60,"wires":[[]]},{"id":"0b297d7ed883029a","type":"ha-wait-until","z":"73a2a4f8b5d2b7d9","name":"at_home","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"input_boolean.at_home","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"5","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":160,"y":60,"wires":[["0b8329cb14bef5d0"],[]]},{"id":"190aea95e801d9c5","type":"api-current-state","z":"f884e97a0daa4ce2","name":"at_home ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.at_home","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":170,"y":80,"wires":[[],[]]},{"id":"1592dd164825f6ea","type":"function","z":"e4503a3be0539251","name":"prepare notification","func":"let persons = msg.persons\nlet msgs = []\n\nif (msg.error === true) {\n    persons = msg.persons.filter(p => (p.notify_mobile_app_on_errors ?? false))\n} else if (Array.isArray(msg.send_to) && msg.send_to.length !== 0) {\n    persons = msg.persons.filter(p => msg.send_to.includes(p.name))\n}\n\nfor (let p of persons.filter(p => p.mobile_app_name !== \"\")) {\n    let notification = { service: p.mobile_app_name, payload: { data: { message: msg.dismiss === true ? \"clear_notification\" : (msg.message ?? \"\"), data: {} } } }\n\n    if (msg.title) {\n        notification.payload.data.title = msg.title\n    }\n\n    let actions = [{ action: \"done\", title: \"Trait√©\" }, ...(msg.data?.actions || [])]\n    notification.payload.data[\"data\"] = { ttl: 0, priority: \"high\", ...(msg.data || {}), actions }\n    \n    notification.payload.data[\"data\"][\"tag\"] = msg.notification_id || new Date().getTime()\n    msgs.push(notification)\n}\n\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":60,"wires":[["8346a9d91d4c30ee"]]},{"id":"8346a9d91d4c30ee","type":"api-call-service","z":"e4503a3be0539251","name":"send to mobile","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"notify","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"all","x":680,"y":60,"wires":[[]]},{"id":"ec98ea15c67bf9ec","type":"function","z":"e4503a3be0539251","name":"persons >","func":"if (msg.send_mobile === true || msg.dismiss === true) {\n    msg.search = { \"is\": { linked_class: \"person\" } }\n    msg.output_name = \"persons\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":60,"wires":[["07cd636cabb6c05b"]]},{"id":"07cd636cabb6c05b","type":"subflow:87a3c75768fca823","z":"e4503a3be0539251","name":"","x":310,"y":60,"wires":[["1592dd164825f6ea"]]},{"id":"2f50462c34ec48c0","type":"subflow:87a3c75768fca823","z":"3dd3ba0d3b3a0ffd","name":"","x":555,"y":60,"wires":[["397999cb96602a2d"]],"l":false},{"id":"5cf6d4991340fc70","type":"link out","z":"3dd3ba0d3b3a0ffd","name":"link out 668","mode":"link","links":["9d1f74b8a9d2ac54"],"x":255,"y":60,"wires":[]},{"id":"a3c00a20c9653488","type":"link in","z":"3dd3ba0d3b3a0ffd","name":"link in 587","links":["d160280618e29267"],"x":335,"y":180,"wires":[["eeb12be5e9c65d2e"]]},{"id":"9d1f74b8a9d2ac54","type":"link in","z":"3dd3ba0d3b3a0ffd","name":"link in 588","links":["5cf6d4991340fc70"],"x":335,"y":60,"wires":[["0f6528d1f27fb519"]]},{"id":"492dbba33e04fd9c","type":"change","z":"3dd3ba0d3b3a0ffd","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":555,"y":120,"wires":[["f5254929f35c4175"]],"l":false},{"id":"f5254929f35c4175","type":"api-call-service","z":"3dd3ba0d3b3a0ffd","name":"set volume","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volume_level}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":670,"y":120,"wires":[[]]},{"id":"f607933fb118cc43","type":"api-call-service","z":"3dd3ba0d3b3a0ffd","name":"set speaker","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":450,"y":120,"wires":[["492dbba33e04fd9c"]]},{"id":"2246095761e7697f","type":"link in","z":"3dd3ba0d3b3a0ffd","name":"link in 5","links":["d160280618e29267"],"x":335,"y":120,"wires":[["f607933fb118cc43"]]},{"id":"d160280618e29267","type":"link out","z":"3dd3ba0d3b3a0ffd","name":"link out 4","mode":"link","links":["2246095761e7697f","a3c00a20c9653488"],"x":785,"y":60,"wires":[]},{"id":"094ee1921fdbde43","type":"delay","z":"3dd3ba0d3b3a0ffd","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":true,"outputs":1,"x":735,"y":60,"wires":[["d160280618e29267"]],"l":false},{"id":"397999cb96602a2d","type":"function","z":"3dd3ba0d3b3a0ffd","name":"msgs","func":"let linked_area = msg.linked_area\nlet audio_type = msg.audio_type\nlet speakers = msg.speakers\nlet msgs = []\n\nif (speakers.length == 1) {\n    set_msgs(speakers[0].entity_id, audio_type, msg[audio_type])\n} else {\n    for (let speaker of speakers.filter(s => s.linked_area == (linked_area ?? s.linked_area))) {\n        set_msgs(speaker.entity_id, audio_type, msg[audio_type])\n    }\n}\nreturn [msgs]\n\nfunction set_msgs(entity_id, audio_type, content) {\n\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    let tts = home_configuration.tts ?? \"\"\n    let message = {\n        entity_id: entity_id,\n        volume_level: msg.volume_level,\n        rate: (audio_type === \"speak\" ? 125 * content.length : 10 * 1000),\n        effects: msg.effects\n    }\n\n    if (audio_type === \"speak\" && tts.voice !== \"\") {\n        msgs.push({\n            ...message,\n            domain: \"tts\",\n            service: tts.voice,\n            payload: {\n                data: {\n                    entity_id: entity_id,\n                    message: content,\n                    options: tts.options ?? {},\n                    cache: true\n                }\n            }\n        })\n    } else if (audio_type === \"sound\") {\n        msgs.push({\n            ...message,\n            domain: \"media_player\",\n            service: \"play_media\",\n            payload: {\n                data: {\n                    entity_id: entity_id,\n                    media_content_id: \"media-source://media_source/media/\" + content,\n                    media_content_type: \"music\"\n                }\n            }\n        })\n    } else if (audio_type === \"link\") {\n        msgs.push({\n            ...message,\n            domain: \"media_player\",\n            service: \"play_media\",\n            payload: {\n                data: {\n                    entity_id: entity_id,\n                    media_content_id: content,\n                    media_content_type: \"music\"\n                }\n            }\n        })\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":60,"wires":[["094ee1921fdbde43"]]},{"id":"54576fb78d781f52","type":"subflow:87a3c75768fca823","z":"3dd3ba0d3b3a0ffd","name":"","x":675,"y":180,"wires":[["23b16e948086b147"]],"l":false},{"id":"23b16e948086b147","type":"subflow:73a2a4f8b5d2b7d9","z":"3dd3ba0d3b3a0ffd","name":"","x":800,"y":180,"wires":[]},{"id":"eeb12be5e9c65d2e","type":"function","z":"3dd3ba0d3b3a0ffd","name":"get lights from active motions >","func":"let motion_areas = global.get(\"motion_areas\") ?? {}\nlet active_areas = Object.keys(motion_areas).filter(a => (motion_areas[a] == \"on\" || motion_areas[a] == \"last\"))\n\nreturn {\n    search: { \"is\": { linked_class: \"light\", linked_area: active_areas, state: [\"on\", \"off\"] } },\n    output_name: \"linked_lights\",\n    output_empty_results: false,\n    effects: msg.effects\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":180,"wires":[["54576fb78d781f52"]]},{"id":"0f6528d1f27fb519","type":"function","z":"3dd3ba0d3b3a0ffd","name":"speakers >","func":"let audio_type = Object.keys(msg).find(a => [\"speak\", \"sound\", \"link\"].includes(a))\nif (audio_type) {\n    let functions = global.get(\"functions\") ?? {}\n    return {\n        audio_type: audio_type,\n        [audio_type]: msg[audio_type],\n        volume_level: msg.volume_level ?? functions[\"get_volume_level\"](),\n        effects: msg.effects,\n        search: { \"is\": { linked_class: \"speaker\" }, \"not\": { state: \"unavailable\" } },\n        output_name: \"speakers\",\n        output_empty_results: false\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":60,"wires":[["2f50462c34ec48c0"]]},{"id":"62f77bea9c5ee2e0","type":"ha-wait-until","z":"3dd3ba0d3b3a0ffd","name":"at_home","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"input_boolean.at_home","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"5","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":160,"y":60,"wires":[["5cf6d4991340fc70"],[]]},{"id":"d495ba6f94ce8da8","type":"function","z":"2f44a0de1e92d674","name":"call prepare","func":"if (msg.entity_id === undefined) {\n    return node.error(\"entity_id is undefined\", msg)\n} else if (msg.state === undefined) {\n    return node.error(\"state is undefined\", msg)\n}\n\nmsg.domain = msg.entity_id.split(\".\")[0]\n\nif ([\"input_boolean\", \"switch\", \"light\"].includes(msg.domain) && msg.state) {\n    msg.service = msg.state === \"toggle\" ? msg.state : \"turn_\" + msg.state\n    msg.payload = {\n        data: {\n            entity_id: msg.entity_id\n        }\n    }\n    return [msg, null]\n} else if ([\"input_select\", \"select\"].includes(msg.domain) && msg.state) {\n    msg.service = \"select_option\"\n    msg.payload = {\n        data: {\n            entity_id: msg.entity_id, option: msg.state\n        }\n    }\n    return [msg, null]\n} else if ([\"input_number\", \"input_text\"].includes(msg.domain) && (msg.domain == \"input_number\" && !isNaN(msg.state) || msg.domain == \"input_text\")) {\n    msg.service = \"set_value\"\n    msg.payload = {\n        data: {\n            entity_id: msg.entity_id, value: msg.state\n        }\n    }\n    return [msg, null]\n} else if (msg.domain === \"alarm_control_panel\" && msg.state) {\n    let states = {\n        \"armed_custom_bypass\": \"alarm_arm_custom_bypass\",\n        \"armed_vacation\": \"alarm_arm_vacation\",\n        \"armed_night\": \"alarm_arm_night\",\n        \"armed_away\": \"alarm_arm_away\",\n        \"armed_home\": \"alarm_arm_home\",\n        \"disarmed\": \"alarm_disarm\",\n        \"triggered\": \"alarm_trigger\"\n    }\n    msg.service = states[msg.state]\n    msg.payload = {\n        data: {\n            entity_id: msg.entity_id\n        }\n    }\n    return [msg, null]\n} else if (msg.domain === \"input_datetime\" && msg.state) {\n    let type =\n        msg.state.search(/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}/) == 0 ? \"datetime\"\n            : msg.state.search(/[0-9]{4}-[0-9]{2}-[0-9]{2}/) == 0 ? \"date\"\n                : msg.state.search(/[0-9]{2}:[0-9]{2}/) == 0 ? \"time\" : \"\"\n    if (type) {\n        msg.service = \"set_datetime\"\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id, [type]: msg.state\n            }\n        }\n        return [msg, null]\n    }\n} else if (msg.domain === \"execute\") {\n    return [{ ...msg.state }, null]\n} else if (msg.domain === \"emulate\") {\n    msg.payload = {\n        event: \"emulate\",\n        data: {\n            entity_id: msg.entity_id.replace(msg.domain + \".\", \"\"),\n            ...msg.state\n        }\n    }\n    return [null, msg]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":80,"wires":[["908fcdaac2e4a673"],["b6dc4006fc5c9a33"]]},{"id":"908fcdaac2e4a673","type":"api-call-service","z":"2f44a0de1e92d674","name":"call service","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":370,"y":40,"wires":[[]]},{"id":"b6dc4006fc5c9a33","type":"ha-fire-event","z":"2f44a0de1e92d674","name":"fire event","server":"c87720f17866318d","version":0,"event":"","data":"","dataType":"json","x":360,"y":120,"wires":[[]]},{"id":"e903cf0042e29cd3","type":"function","z":"759003382b0f7bfd","name":"send dashboard bug","func":"if (msg.error?.message) {\n    let notAllowedError = msg.blockedErrors.find(e => (msg.error.message.includes(e)))\n    if (!notAllowedError) {\n        let notifications = global.get(\"notifications\") ?? {}\n\n        msg.notification_id = \"error_\" + msg.flowTitle + \"_\" + (msg.error?.source.id ?? new Date().getTime())\n        msg.title = \"Erreur d√©t√©ct√©e\"\n        msg.message = \"Erreur : \" + msg.flowTitle + \" > \" + msg.error?.source?.name + \" > \" + msg.error?.message\n        msg.alert_type = \"error\"\n\n        if (notifications[msg.notification_id]) {\n            msg.message += \", apparue \" + (notifications[msg.notification_id].count + 1) + \" fois.\"\n        } else {\n            msg.send_mobile = true\n        }\n        msg.error = true\n        return msg\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":100,"wires":[["cd6f5ecb873cd244"]]},{"id":"cd6f5ecb873cd244","type":"delay","z":"759003382b0f7bfd","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":400,"y":100,"wires":[[]]},{"id":"6657aeff0321973e","type":"debug","z":"759003382b0f7bfd","name":"debug 1","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":630,"y":40,"wires":[]},{"id":"921c7a4c16b38434","type":"subflow:27aabf8cb913bb7c","z":"759003382b0f7bfd","name":"","x":470,"y":40,"wires":[["6657aeff0321973e","0eae7abe15dcca5e"]]},{"id":"d1fc9d1f5d2de155","type":"subflow:4b7531d5c394bfa5","z":"759003382b0f7bfd","name":"","x":990,"y":40,"wires":[["e7077bd46d98f92b"],["382b8a6f2001a6f3"]]},{"id":"7fcd29c64abe6a39","type":"file","z":"759003382b0f7bfd","name":"save error","filename":"/homeassistant/node-red/errors.txt","filenameType":"str","appendNewline":true,"createDir":true,"overwriteFile":"false","encoding":"none","x":480,"y":160,"wires":[[]]},{"id":"e7077bd46d98f92b","type":"link out","z":"759003382b0f7bfd","name":"link out 536","mode":"link","links":["826737c1cc785894"],"x":1095,"y":40,"wires":[]},{"id":"826737c1cc785894","type":"link in","z":"759003382b0f7bfd","name":"link in 483","links":["e7077bd46d98f92b"],"x":55,"y":100,"wires":[["e903cf0042e29cd3"]]},{"id":"382b8a6f2001a6f3","type":"link out","z":"759003382b0f7bfd","name":"link out 537","mode":"link","links":["85faac4588035169"],"x":1095,"y":40,"wires":[]},{"id":"85faac4588035169","type":"link in","z":"759003382b0f7bfd","name":"link in 484","links":["382b8a6f2001a6f3"],"x":55,"y":160,"wires":[["d22b391cef063d62"]]},{"id":"1c1bb838d6cebe2d","type":"function","z":"759003382b0f7bfd","name":"allowedError ?","func":"if (msg.error?.source?.name) {\n    let isAllowedError = msg.blockedErrors.filter(error => msg.error.message.includes(error)).length == 0\n    if (isAllowedError) {\n        msg.payload = { time: msg.current_time, ...msg }\n        return msg\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":160,"wires":[["7fcd29c64abe6a39"]]},{"id":"0eae7abe15dcca5e","type":"function","z":"759003382b0f7bfd","name":"blockedErrors","func":"msg.blockedErrors = [\n    \"The write socket is closed\",\n    \"Error: target link-in node\",\n    \"Connection closed\"\n]\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":40,"wires":[["d1fc9d1f5d2de155"]]},{"id":"d22b391cef063d62","type":"function","z":"759003382b0f7bfd","name":"get date","func":"let d = new Date()\nlet year = d.getFullYear()\nlet month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1)\nlet day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate()\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n\nmsg.current_time = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":160,"wires":[["1c1bb838d6cebe2d"]]},{"id":"3a4539013276671b","type":"change","z":"759003382b0f7bfd","name":"set topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"error.source.id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":160,"y":40,"wires":[["80028bca68c3d879"]]},{"id":"80028bca68c3d879","type":"trigger","z":"759003382b0f7bfd","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":310,"y":40,"wires":[["921c7a4c16b38434"]]},{"id":"d89d3cecbc7f08eb","type":"function","z":"fe184c2d23704568","name":"create notification","func":"let notifications = global.get(\"notifications\") ?? {}\n\nif (!notifications[msg.notification_id] || msg.override) {\n    let d = new Date()\n    let local_time = (d.getMonth() + 1) + \" \" + d.getDate() + \" \" + d.getHours() + \":\" + (d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes())\n    notifications[msg.notification_id] = {}\n    notifications[msg.notification_id].count = 1\n    notifications[msg.notification_id].creation_date = msg.restore ? msg.creation_date : local_time\n} else {\n    notifications[msg.notification_id].count++\n}\n\nnotifications[msg.notification_id].title = msg.title ?? \"\"\nnotifications[msg.notification_id].message = msg.message ?? \"\"\nnotifications[msg.notification_id].speak = msg.speak ?? \"\"\nnotifications[msg.notification_id].alert_type = msg.alert_type ?? \"info\"\n\nglobal.set(\"notifications\", notifications)\nmsg.notifications = notifications\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":180,"wires":[["800e7676409ca54b","467f853833449c99"]]},{"id":"22825c48516ef1c7","type":"link out","z":"fe184c2d23704568","name":"link out 196","mode":"link","links":["ba1aa91bb8947867"],"x":455,"y":240,"wires":[]},{"id":"666a84cf02a145d2","type":"subflow:3dd3ba0d3b3a0ffd","z":"fe184c2d23704568","name":"","x":360,"y":300,"wires":[]},{"id":"b3fa1a66e0a1ddc6","type":"link out","z":"fe184c2d23704568","name":"link out 226","mode":"link","links":["ba1aa91bb8947867"],"x":835,"y":180,"wires":[]},{"id":"34e8ad6be989806b","type":"subflow:e4503a3be0539251","z":"fe184c2d23704568","name":"","x":220,"y":300,"wires":[]},{"id":"200aa5f00b5ad3de","type":"function","z":"fe184c2d23704568","name":"process notification","func":"switch (msg.notification?.event?.service ?? \"\") {\n    case \"create\":\n        return [msg, null]\n    case \"dismiss\":\n        msg.notifications = global.get(\"notifications\") ?? {}\n        msg.notification_id = msg.notification.event.service_data.notification_id\n        msg.dismiss = true\n        delete msg.notifications[msg.notification.event.service_data.notification_id]\n        global.set(\"notifications\", msg.notifications)\n        return [null, msg]\n    case \"dismiss_all\":\n        msg.notifications = {}\n        global.set(\"notifications\", msg.notifications)\n        return [null, msg]\n    default:\n        return [null, null]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":380,"wires":[["67a0d0fca585c9fe"],["e5d14b9803429a22","7143b797d355f7fb"]]},{"id":"4b6bde41cdd7f7ae","type":"yaml","z":"fe184c2d23704568","property":"notifications","name":"","x":150,"y":500,"wires":[["517efd47b388efe8"]]},{"id":"dfa94818a7d5896a","type":"file","z":"fe184c2d23704568","name":"","filename":"/config/notifications.yaml","filenameType":"str","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":390,"y":500,"wires":[["7f70a6067d2f338c"]]},{"id":"eb6e20a6ca488209","type":"link in","z":"fe184c2d23704568","name":"write notifications","links":[],"x":55,"y":500,"wires":[["4b6bde41cdd7f7ae"]]},{"id":"3cca80dcd9c07acb","type":"link out","z":"fe184c2d23704568","name":"link out 450","mode":"return","links":[],"x":585,"y":500,"wires":[]},{"id":"467f853833449c99","type":"link call","z":"fe184c2d23704568","name":"","links":["eb6e20a6ca488209"],"linkType":"static","timeout":"30","x":710,"y":180,"wires":[["b3fa1a66e0a1ddc6"]]},{"id":"dd1b8bd875f92e36","type":"link call","z":"fe184c2d23704568","name":"","links":["eb6e20a6ca488209"],"linkType":"static","timeout":"30","x":790,"y":380,"wires":[[]]},{"id":"83e1cb771d75a303","type":"link in","z":"fe184c2d23704568","name":"link in 496","links":["98a18c581fb8acd5"],"x":335,"y":60,"wires":[["4d8127b0e781e457"]]},{"id":"800e7676409ca54b","type":"api-call-service","z":"fe184c2d23704568","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"persistent_notification","service":"create","areaId":[],"deviceId":[],"entityId":[],"data":"{\"title\":\"{{title}}\",\"message\":\"{{message}}\",\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":180,"wires":[[]]},{"id":"ac319d598bc40725","type":"api-call-service","z":"fe184c2d23704568","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"persistent_notification","service":"dismiss","areaId":[],"deviceId":[],"entityId":[],"data":"{\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":290,"y":240,"wires":[["22825c48516ef1c7"]]},{"id":"6daad6ae73449073","type":"server-events","z":"fe184c2d23704568","name":"persistent_notification","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"call_service","eventData":"{\"domain\":\"persistent_notification\"}","waitForRunning":true,"outputProperties":[{"property":"notification","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":140,"y":380,"wires":[["200aa5f00b5ad3de"]]},{"id":"c4072a3d7303f219","type":"server-events","z":"fe184c2d23704568","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":440,"wires":[["af8e33ece8b967f4"]]},{"id":"ba1aa91bb8947867","type":"link in","z":"fe184c2d23704568","name":"link in 551","links":["b3fa1a66e0a1ddc6","22825c48516ef1c7","bdae8c87ccc31fd9"],"x":125,"y":300,"wires":[["34e8ad6be989806b","666a84cf02a145d2"]]},{"id":"988ef688c0a9ad7c","type":"function","z":"fe184c2d23704568","name":"msg to json","func":"msg.template = JSON.stringify(msg)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":120,"wires":[["018014fd3ae16491"]]},{"id":"018014fd3ae16491","type":"api-render-template","z":"fe184c2d23704568","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":380,"y":120,"wires":[["4ed64677e20ea526"]]},{"id":"4ed64677e20ea526","type":"function","z":"fe184c2d23704568","name":"json to msg","func":"msg = { ...JSON.parse(msg.payload.replace(/(?<![\\[{:,])\"(?![\\]}:,])/g, '\\\\\"')) }\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":120,"wires":[["33ae9f5820fa1414"]]},{"id":"517efd47b388efe8","type":"change","z":"fe184c2d23704568","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"notifications","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":235,"y":500,"wires":[["dfa94818a7d5896a"]],"l":false},{"id":"4d8127b0e781e457","type":"switch","z":"fe184c2d23704568","name":"notification_id ?","property":"notification_id","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":460,"y":60,"wires":[["c8d3ea12009ad38a"]]},{"id":"c8d3ea12009ad38a","type":"switch","z":"fe184c2d23704568","name":"dismiss ?","property":"dismiss","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":620,"y":60,"wires":[["b05949a5c1acd55b"],["f0712b07d536b920"]]},{"id":"b05949a5c1acd55b","type":"link out","z":"fe184c2d23704568","name":"link out 624","mode":"link","links":["0ce97487b373f3ee"],"x":715,"y":60,"wires":[]},{"id":"0ce97487b373f3ee","type":"link in","z":"fe184c2d23704568","name":"link in 560","links":["b05949a5c1acd55b"],"x":125,"y":240,"wires":[["ac319d598bc40725"]]},{"id":"f0712b07d536b920","type":"link out","z":"fe184c2d23704568","name":"link out 625","mode":"link","links":["5c40ab13c8fd359b"],"x":715,"y":60,"wires":[]},{"id":"5c40ab13c8fd359b","type":"link in","z":"fe184c2d23704568","name":"link in 561","links":["f0712b07d536b920"],"x":125,"y":120,"wires":[["988ef688c0a9ad7c"]]},{"id":"33ae9f5820fa1414","type":"link out","z":"fe184c2d23704568","name":"link out 626","mode":"link","links":["a50dc8f8179d6e13"],"x":635,"y":120,"wires":[]},{"id":"a50dc8f8179d6e13","type":"link in","z":"fe184c2d23704568","name":"link in 562","links":["33ae9f5820fa1414"],"x":125,"y":180,"wires":[["d89d3cecbc7f08eb"]]},{"id":"7f70a6067d2f338c","type":"change","z":"fe184c2d23704568","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"delete","p":"notifications","pt":"msg"},{"t":"delete","p":"filename","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":535,"y":500,"wires":[["3cca80dcd9c07acb"]],"l":false},{"id":"af8e33ece8b967f4","type":"function","z":"fe184c2d23704568","name":"delete notification","func":"let notifications = global.get(\"notifications\") ?? {}\nlet notification_id = msg.payload?.event?.tag ?? \"\"\nlet action = msg.payload.event.action ?? \"\"\n\nif (notifications[notification_id] && action === \"done\") {\n    return { notification_id: notification_id, dismiss: true }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":440,"wires":[["98a18c581fb8acd5"]]},{"id":"98a18c581fb8acd5","type":"link out","z":"fe184c2d23704568","name":"link out 639","mode":"link","links":["83e1cb771d75a303"],"x":415,"y":440,"wires":[]},{"id":"6c66a08ade49eaa8","type":"change","z":"fe184c2d23704568","name":"","rules":[{"t":"delete","p":"payload.data","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":190,"y":60,"wires":[["4d8127b0e781e457"]]},{"id":"e5d14b9803429a22","type":"switch","z":"fe184c2d23704568","name":"notification_id ?","property":"notification_id","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":540,"y":380,"wires":[["bdae8c87ccc31fd9"]]},{"id":"bdae8c87ccc31fd9","type":"link out","z":"fe184c2d23704568","name":"link out 27","mode":"link","links":["ba1aa91bb8947867"],"x":655,"y":380,"wires":[]},{"id":"ac0adff31b292daa","type":"function","z":"4b7531d5c394bfa5","name":"mode dev ?","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (home_configuration.mode === \"dev\") {\n    return [msg, null]\n} else {\n    return [null, msg]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":80,"wires":[[],[]]},{"id":"8b8b9881deb1ae38","type":"api-current-state","z":"27aabf8cb913bb7c","name":"services_loaded","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"services_loaded","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.services_loaded","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":180,"y":80,"wires":[["085c10b4399ebc56"],[]]},{"id":"085c10b4399ebc56","type":"function","z":"27aabf8cb913bb7c","name":"homeassistant is running ?","func":"let homeassistant = global.get(\"homeassistant\")?.homeAssistant ?? {}\n\nif ((homeassistant.isRunning ?? false) && (homeassistant.isConnected ?? false)) {\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":80,"wires":[[]]},{"id":"5a38299561de1060","type":"function","z":"87a3c75768fca823","name":"search entities","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet entities = global.get(\"homeassistant\").homeAssistant.states;\nlet found = [];\n\nfor (let id in entities) {\n    let entity = entities[id];\n    if (home_configuration[id]) {\n        entity = { ...entity, ...home_configuration[id] };\n    }\n\n    let extended = { ...entity, ...entity.attributes };\n\n    if (searchMatch(extended, msg.search)) {\n        entity.state = isNaN(entity.state) ? entity.state : parseFloat(entity.state);\n        found.push(entity);\n    }\n}\n\nlet output_empty_results = (msg.output_empty_results ?? false) || found.length > 0;\nif (output_empty_results) {\n    msg[msg.output_name] = found;\n    delete msg.output_empty_results;\n    delete msg.output_name;\n    delete msg.search;\n    return msg;\n}\n\nfunction searchMatch(entity, search) {\n    if (search[\"is\"]) {\n        for (let key of Object.keys(search[\"is\"])) {\n            const expected = search[\"is\"][key];\n            const actual = entity[key];\n            if (Array.isArray(expected)) {\n                if (!expected.includes(actual)) return false;\n            } else if (actual != expected) return false;\n        }\n    }\n    if (search[\"not\"]) {\n        for (let key of Object.keys(search[\"not\"])) {\n            const notExpected = search[\"not\"][key];\n            const actual = entity[key];\n            if (Array.isArray(notExpected)) {\n                if (notExpected.includes(actual)) return false;\n            } else if (actual == notExpected) return false;\n        }\n    }\n    return true;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[[]]},{"id":"9694220b0328c946","type":"function","z":"87a3c75768fca823","name":"search entities","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet entities = global.get(\"homeassistant\").homeAssistant.states\nlet found = []\n\nfor (let entity_id of Object.keys(entities)) {\n    let entity = entities[entity_id]\n    if (home_configuration[entity_id]) {\n        entity = { ...entity, ...home_configuration[entity_id] }\n    }\n    let entity_search = { ...entity, ...entity.attributes }\n    if (search(entity_search)) {\n        entity.state = isNaN(entity.state) ? entity.state : parseFloat(entity.state)\n        found.push(entity)\n    }\n}\n\nlet output_empty_results = (msg.output_empty_results ?? false) || found.length > 0\nif (output_empty_results) {\n    msg[msg.output_name] = found\n    delete msg.output_empty_results\n    delete msg.output_name\n    delete msg.search\n    return msg\n}\n\nfunction search(entity) {\n    if (msg.search[\"is\"]) {\n        for (let search_key of Object.keys(msg.search[\"is\"])) {\n            if (Array.isArray(msg.search[\"is\"][search_key])) {\n                if (!(msg.search[\"is\"][search_key].includes(entity[search_key]))) {\n                    return false\n                }\n            } else if (msg.search[\"is\"][search_key] === undefined || !(entity[search_key] == msg.search[\"is\"][search_key])) {\n                return false\n            }\n        }\n    }\n    if (msg.search[\"not\"]) {\n        for (let search_key of Object.keys(msg.search[\"not\"])) {\n            if (Array.isArray(msg.search[\"not\"][search_key])) {\n                if (msg.search[\"not\"][search_key].includes(entity[search_key])) {\n                    return false\n                }\n            } else if (msg.search[\"not\"][search_key] === undefined || entity[search_key] == msg.search[\"not\"][search_key]) {\n                return false\n            }\n        }\n    }\n    return true\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":120,"wires":[[]]},{"id":"edf766390651f7a3","type":"subflow:fe184c2d23704568","z":"acf9afadecece0b1","name":"","x":170,"y":180,"wires":[["03dad2ae54d80734"]]},{"id":"8edaeb40fc5e5069","type":"link in","z":"acf9afadecece0b1","name":"notification","links":["a040176db3a7fb3c","f1f60e1c80842745","05ae5808716abaef","236ba841642e04c3","4752c8fce2b90709","7948fc02c0d1009c","1643cd5536be6d9c","c8e24a01855093fd","f6b90722ca4e4123","661ecc9b363d33d6","3c4fb4043f10b06b","b870595011d959da","d703caa1e057a125","eb2c263a5025643f","1553725d3c5db4a4","0f4c525cf8c33c43","5e76dc7eb6b4da39","96d13d515f9e5afa","55bfc3f974404f10","c76da9c70d0ede49","22318be840827f7b","3120eadee3d161e8","cc07290ba37159f5","c532cf082b759e0f","ca53cd93cc90a3d7","72df1d9f4529031d","a0d49596c9f1a004","1858b90a9dc619e6","86aa32dc1153c87c","882df0c40df764ed","bfed323c053316c9","d39cb5bbe614d942","45ae6ac8e35162b4","88a55a8caaf596e7","bc7e6036b5c7f488","80ab5909764dad58","c399324c356b412d","a03b2613cde1f8c5","d03b93e0906a12c0","38a8c1f4cf8476cf","c8f3d7df018472fd","08e1fd8d576bead7","981ccab95507ea30","4ed795b7eaa8dd47","80639b96a5ded4ef","b5799cb009771706","6ebdb53b486b3e8f","36554a24b2f2084b","82f9b197e7b82827","4554534001c77a38","ae37041f32807f0f","7cebe4bdcff72e77"],"x":55,"y":180,"wires":[["edf766390651f7a3"]]},{"id":"d1f98898442dabc1","type":"catch","z":"acf9afadecece0b1","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["ad09b4e538705b10"]]},{"id":"089486ca3c121bf5","type":"subflow:759003382b0f7bfd","z":"acf9afadecece0b1","name":"","x":460,"y":40,"wires":[["55bfc3f974404f10"]]},{"id":"ad09b4e538705b10","type":"change","z":"acf9afadecece0b1","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Core","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["089486ca3c121bf5"]]},{"id":"786f1e48ba1cdeb7","type":"comment","z":"acf9afadecece0b1","name":"Notifications ++","info":"Object.entries(windows).forEach(([key, value]) => {\n    \n})\n________________________________________________________________________________\nconst array1 = [true, false, true, true]\nconst initialValue = true\nconst sumWithInitial = array1.reduce(\n  (accumulator, currentValue) => accumulator && currentValue,\n  initialValue\n)\n________________________________________________________________________________\nlight.attributes.supported_color_modes ?? []).some(mode => mode == \"hs\")\n________________________________________________________________________________","x":120,"y":120,"wires":[]},{"id":"3c4299289b5064c4","type":"function","z":"acf9afadecece0b1","name":"prepare options","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet ambiances = msg.ambiances\nlet options = []\nlet msgs = []\n\nlet ambiancesTypeKeys = Object.keys(home_configuration.ambiance_config.ambiances_type)\nfor (let key of ambiancesTypeKeys) {\n    options.push(key)\n}\n\nfor (let ambiance of ambiances) {\n    msgs.push({ payload: { data: { entity_id: ambiance.entity_id, options: options } } })\n}\nreturn [msgs]\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":640,"wires":[["f8d5eaaf428a18a1"]]},{"id":"0958a34599e07f4e","type":"link in","z":"acf9afadecece0b1","name":"ambiances restore","links":["6bbacc14f0eb603b"],"x":935,"y":640,"wires":[["44fdf70e4537c2df"]]},{"id":"6f96bd174e57c9b1","type":"comment","z":"acf9afadecece0b1","name":"Elevation","info":"","x":1200,"y":380,"wires":[]},{"id":"4baa6b20bc4a6ae7","type":"comment","z":"acf9afadecece0b1","name":"Global context management","info":"","x":160,"y":740,"wires":[]},{"id":"f7bb429ffdbb29fb","type":"link in","z":"acf9afadecece0b1","name":"notifications restore","links":["6bbacc14f0eb603b"],"x":55,"y":1000,"wires":[["03791a7c33e5ef8a"]]},{"id":"ce0675a7cc350445","type":"function","z":"acf9afadecece0b1","name":"restore notifications","func":"let notifications = msg.payload ?? {}\nlet notificationsKeys = Object.keys(notifications)\nlet msgs = []\n\nfor (let key of notificationsKeys) {\n    msgs.push({\n        notification_id: key,\n        count: notifications[key].count,\n        alert_type: notifications[key]?.alert_type ?? \"info\",\n        title: notifications[key]?.title ?? \"\",\n        message: notifications[key]?.message ?? \"\",\n        creation_date: notifications[key]?.creation_date ?? \"\",\n        restore: true\n    })\n}\n\nif (msgs.length !== 0) {\n    return [msgs]\n} else {\n    global.set(\"notifications\", {})\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":1000,"wires":[["1643cd5536be6d9c"]]},{"id":"1643cd5536be6d9c","type":"link out","z":"acf9afadecece0b1","name":"link out 448","mode":"link","links":["8edaeb40fc5e5069"],"x":495,"y":1000,"wires":[]},{"id":"03791a7c33e5ef8a","type":"file in","z":"acf9afadecece0b1","name":"get yaml notifications","filename":"/config/notifications.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":115,"y":1000,"wires":[["22eaf2778e390483"]],"l":false},{"id":"22eaf2778e390483","type":"yaml","z":"acf9afadecece0b1","property":"payload","name":"","x":210,"y":1000,"wires":[["ce0675a7cc350445"]]},{"id":"04a8b3f20b5e4036","type":"link out","z":"acf9afadecece0b1","name":"ha reloaded","mode":"link","links":["0ac28b430fb0e0a5"],"x":635,"y":800,"wires":[]},{"id":"44fdf70e4537c2df","type":"function","z":"acf9afadecece0b1","name":"ambiance >","func":"msg.search = { \"is\": { linked_class: \"ambiance\" } }\nmsg.output_name = \"ambiances\"\nmsg.output_empty_results = true\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":640,"wires":[["52fe229ed96203ed"]]},{"id":"c570d591a675c9e2","type":"link in","z":"acf9afadecece0b1","name":"persons restore","links":["6bbacc14f0eb603b"],"x":935,"y":700,"wires":[["f05081a15302e6a1","e7d879e2f6c52b7a"]]},{"id":"f05081a15302e6a1","type":"function","z":"acf9afadecece0b1","name":"jsons setup","func":"let json_entities = [\"json_exterior_average_temp\", \"json_activities\"]\nlet msgs = []\n\nfor (let json_entity of json_entities) {\n    let entity_id = \"input_text.\" + json_entity\n    let state = global.get(\"homeassistant\").homeAssistant.states[entity_id].state\n    if (state == \"unknown\" || state == \"\") {\n        msgs.push({\n            entity_id: entity_id,\n            state: \"{}\"\n        })\n    }\n}\n\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":700,"wires":[["9377e814aa893123"]]},{"id":"9377e814aa893123","type":"subflow:2f44a0de1e92d674","z":"acf9afadecece0b1","name":"","x":1350,"y":700,"wires":[]},{"id":"2fb230d4b09370b6","type":"comment","z":"acf9afadecece0b1","name":"Silent speaker","info":"","x":110,"y":540,"wires":[]},{"id":"f0d87a6279823de3","type":"comment","z":"acf9afadecece0b1","name":"Exterior average temperature","info":"","x":1040,"y":120,"wires":[]},{"id":"12a3e46ae9e7beca","type":"subflow:2f44a0de1e92d674","z":"acf9afadecece0b1","name":"","x":1270,"y":180,"wires":[]},{"id":"f8d5eaaf428a18a1","type":"api-call-service","z":"acf9afadecece0b1","name":"set ambiance options","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"options\":\"{{options}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1480,"y":640,"wires":[[]]},{"id":"15d0ab828e0ee65f","type":"api-call-service","z":"acf9afadecece0b1","name":"set elevation","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.elevation"],"data":"{\"value\":\"{{data.new_state.attributes.elevation}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1330,"y":440,"wires":[[]]},{"id":"21b39f8bc3785772","type":"api-call-service","z":"acf9afadecece0b1","name":"purge history > 7 days","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"recorder","service":"purge","areaId":[],"deviceId":[],"entityId":[],"data":"{\"keep_days\":\"7\",\"repack\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1300,"y":320,"wires":[[]]},{"id":"d437d16f9d47a536","type":"server-state-changed","z":"acf9afadecece0b1","name":"zone.home","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"zone.home","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"","ifStateType":"num","ifStateOperator":"gt","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":180,"wires":[["03dad2ae54d80734"]]},{"id":"52e78fed0e92d760","type":"server-state-changed","z":"acf9afadecece0b1","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1190,"y":440,"wires":[["15d0ab828e0ee65f"]]},{"id":"fb27b3006cac74dd","type":"server-state-changed","z":"acf9afadecece0b1","name":"speaker_day_night_volume","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_number.speaker_day_mode_volume","input_number.speaker_night_mode_volume"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":440,"y":600,"wires":[["64e6badeb4fa7838"]]},{"id":"291a757769aa390d","type":"server-state-changed","z":"acf9afadecece0b1","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":970,"y":180,"wires":[["dbe8ef3bb3be75e7"]]},{"id":"d89c0e653fc5fd75","type":"ha-time","z":"acf9afadecece0b1","name":"day_time","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.day_time","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"on","valueType":"str"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":100,"y":600,"wires":[["64e6badeb4fa7838"]]},{"id":"a38175fcfdd0527e","type":"ha-time","z":"acf9afadecece0b1","name":"night_time","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.night_time","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"off","valueType":"str"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":240,"y":600,"wires":[["64e6badeb4fa7838"]]},{"id":"99e52124a76e2eee","type":"watch","z":"acf9afadecece0b1","name":"home_configuration changes","files":"/homeassistant/home_configuration.yaml","recursive":"","x":55,"y":860,"wires":[["afe7217eaa41ad52"]],"l":false},{"id":"9104c61d6cd6f6f0","type":"yaml","z":"acf9afadecece0b1","property":"payload","name":"","x":415,"y":740,"wires":[["21b2baac1f38f96c"]],"l":false},{"id":"de4208af56bb2b3c","type":"file in","z":"acf9afadecece0b1","name":"read file","filename":"/homeassistant/home_configuration.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":365,"y":740,"wires":[["9104c61d6cd6f6f0"]],"l":false},{"id":"21b2baac1f38f96c","type":"function","z":"acf9afadecece0b1","name":"set global home_configuration","func":"let home_configuration = msg.payload ?? {}\nglobal.set(\"home_configuration\", home_configuration)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":740,"wires":[["a41dbdc2b11ed09c"]]},{"id":"52fe229ed96203ed","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":1155,"y":640,"wires":[["3c4299289b5064c4"]],"l":false},{"id":"9f8ce6d30730d260","type":"link in","z":"acf9afadecece0b1","name":"set home_configuration","links":[],"x":315,"y":740,"wires":[["de4208af56bb2b3c"]]},{"id":"e7d879e2f6c52b7a","type":"function","z":"acf9afadecece0b1","name":"sun calc","func":"let sun_attributes = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes\nlet sun_light_time_setting = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_setting\"].state\nlet sun_light_time_dusk = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dusk\"].state\nlet sun_light_time_midnight = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_midnight\"].state\nlet sun_light_time_dawn = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn\"].state\nlet sun_light_time_dawn_angle = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn_angle\"].state\nlet sun_light_time_rising = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_rising\"].state\nlet msgs = []\n\nif (sun_light_time_setting == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_setting\", state: clean_date(sun_attributes.next_setting) })\n}\n\nif (sun_light_time_dusk == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dusk\", state: clean_date(sun_attributes.next_dusk) })\n}\n\nif (sun_light_time_dawn == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dawn\", state: clean_date(sun_attributes.next_dawn) })\n}\n\nif (sun_light_time_dawn_angle == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dawn_angle\", state: clean_date(sun_attributes.next_dawn) })\n}\n\nif (sun_light_time_rising == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_rising\", state: clean_date(sun_attributes.next_rising) })\n}\nreturn [msgs]\n\nfunction clean_date(time_txt) {\n    time_txt = time_txt.split(\"T\")[1].split(\".\")[0]\n    time_txt = time_txt.split(\":\")\n    return time_txt[0] + \":\" + time_txt[1]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1200,"y":700,"wires":[["9377e814aa893123"]]},{"id":"1e1f0743a596e6b5","type":"inject","z":"acf9afadecece0b1","name":"1 min","props":[{"p":"linked_class","v":"time","vt":"str"}],"repeat":"","crontab":"*/1 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":990,"y":500,"wires":[["1232d4fba5198a05"]]},{"id":"bf1b75f730ec217a","type":"link out","z":"acf9afadecece0b1","name":"every 1 min hour","mode":"link","links":["510800acac086021","afb59a3d8183bdb6"],"x":1375,"y":500,"wires":[]},{"id":"1232d4fba5198a05","type":"subflow:27aabf8cb913bb7c","z":"acf9afadecece0b1","name":"","x":1130,"y":500,"wires":[["041d975a2b48af87"]]},{"id":"041d975a2b48af87","type":"function","z":"acf9afadecece0b1","name":"get time","func":"let d = new Date()\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n\nmsg.current_time = hour + \":\" + minute\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":500,"wires":[["bf1b75f730ec217a"]]},{"id":"ce584e3435bf2ecc","type":"inject","z":"acf9afadecece0b1","name":"@ 00:00","props":[],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","x":1000,"y":320,"wires":[["96d13d515f9e5afa"]]},{"id":"96d13d515f9e5afa","type":"link out","z":"acf9afadecece0b1","name":"@ 00:00","mode":"link","links":["8edaeb40fc5e5069","1b8b1ab1d5f32f39"],"x":1095,"y":320,"wires":[]},{"id":"a396216276976092","type":"comment","z":"acf9afadecece0b1","name":"Time Triggers","info":"","x":990,"y":260,"wires":[]},{"id":"64e6badeb4fa7838","type":"link out","z":"acf9afadecece0b1","name":"link out 585","mode":"link","links":["332f65443ce0f931"],"x":595,"y":600,"wires":[]},{"id":"20ec8510aed3b595","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":275,"y":660,"wires":[["a18be1d1202b398b"]],"l":false},{"id":"7b461c42b288880f","type":"function","z":"acf9afadecece0b1","name":"speakers >","func":"let functions = global.get(\"functions\") ?? {}\nmsg.volume_level = functions[\"get_volume_level\"]()\n\nmsg.search = { \"is\": { linked_class: \"speaker\" }, \"not\": { state: \"unavailable\" } }\nmsg.output_name = \"speakers\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":660,"wires":[["20ec8510aed3b595"]]},{"id":"aa68bb05ced07573","type":"server-events","z":"acf9afadecece0b1","name":"home assistant","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"home_assistant_client","eventData":"","waitForRunning":false,"outputProperties":[],"event_type":"","x":120,"y":800,"wires":[["756a2ffd79f6d52d"]]},{"id":"756a2ffd79f6d52d","type":"function","z":"acf9afadecece0b1","name":"services_loaded ?","func":"if (msg.payload == \"services_loaded\") {\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":235,"y":800,"wires":[["2abe11fa818206c0"]],"l":false},{"id":"f11433afd6138c6b","type":"server-state-changed","z":"acf9afadecece0b1","name":"services_loaded","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_select.services_loaded","entityIdType":"exact","outputInitially":true,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"x":360,"y":800,"wires":[["048f0dd482239504"]]},{"id":"048f0dd482239504","type":"function","z":"acf9afadecece0b1","name":"services_loaded ?","func":"if (msg.state != \"services_loaded\") {\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":475,"y":800,"wires":[["2abe11fa818206c0"]],"l":false},{"id":"2abe11fa818206c0","type":"api-call-service","z":"acf9afadecece0b1","name":"set services_loaded","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":["input_select.services_loaded"],"data":"{\"options\":[\"services_loaded\"]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":535,"y":800,"wires":[["a9c4d4c07989e25b"]],"l":false},{"id":"a9c4d4c07989e25b","type":"function","z":"acf9afadecece0b1","name":"empty","func":"return {}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":585,"y":800,"wires":[["04a8b3f20b5e4036"]],"l":false},{"id":"65a411199abe2b2f","type":"comment","z":"acf9afadecece0b1","name":"Store / Restore global","info":"","x":1020,"y":780,"wires":[]},{"id":"a17349585adb4873","type":"link in","z":"acf9afadecece0b1","name":"store global","links":[],"x":935,"y":840,"wires":[["2e896be22d8ac5d2"]]},{"id":"0363d155c574e68b","type":"link out","z":"acf9afadecece0b1","name":"store global","mode":"return","links":[],"x":1435,"y":840,"wires":[]},{"id":"2e896be22d8ac5d2","type":"function","z":"acf9afadecece0b1","name":"get global","func":"let acceptedGlobals = [\"light_control\"]\n\nlet globalStored = {}\nfor (let key of acceptedGlobals) {\n    getGlobal(key)\n}\nmsg.payload = globalStored\nreturn msg\n\nfunction getGlobal(key) {\n    globalStored[key] = global.get(key)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":840,"wires":[["ae40d07312727b03"]]},{"id":"617eef4f00ea6d55","type":"file","z":"acf9afadecece0b1","name":"write global file","filename":"/config/global.yaml","filenameType":"str","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":1320,"y":840,"wires":[["0363d155c574e68b"]]},{"id":"ac26a339de0281fd","type":"link in","z":"acf9afadecece0b1","name":"restore global","links":[],"x":935,"y":900,"wires":[["a69d1711f4026393"]]},{"id":"065ff24c2e2e5718","type":"function","z":"acf9afadecece0b1","name":"set global","func":"let globalStored = msg.payload\n\nfor (let key of Object.keys(globalStored)) {\n    setGlobal(key)\n}\n\nfunction setGlobal(key) {\n    global.set(key, globalStored[key])\n}\n\nmsg.payload = {}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1340,"y":900,"wires":[["c909220ccd060ff2"]]},{"id":"ae40d07312727b03","type":"yaml","z":"acf9afadecece0b1","property":"payload","name":"","x":1170,"y":840,"wires":[["617eef4f00ea6d55"]]},{"id":"741779655ab585ab","type":"yaml","z":"acf9afadecece0b1","property":"payload","name":"","x":1210,"y":900,"wires":[["065ff24c2e2e5718"]]},{"id":"a69d1711f4026393","type":"file in","z":"acf9afadecece0b1","name":"read global file","filename":"/config/global.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":1060,"y":900,"wires":[["741779655ab585ab"]]},{"id":"a41dbdc2b11ed09c","type":"link out","z":"acf9afadecece0b1","name":"set global home_configuration","mode":"return","links":[],"x":755,"y":740,"wires":[]},{"id":"afe7217eaa41ad52","type":"link call","z":"acf9afadecece0b1","name":"","links":["9f8ce6d30730d260"],"linkType":"static","timeout":"30","x":250,"y":860,"wires":[["12cb1b38ba18986b"]]},{"id":"6bbacc14f0eb603b","type":"link out","z":"acf9afadecece0b1","name":"home_config reloaded","mode":"link","links":["b6c9b37db7b0ee60","c570d591a675c9e2","f7bb429ffdbb29fb","346474bc037af36f","bdebcfad2aaa4c2f","0958a34599e07f4e","f71a0c1818898451","b84c4de4488b36e0","a13e36cfc4599277","e31bbfb1859b5c4b"],"x":715,"y":860,"wires":[]},{"id":"c909220ccd060ff2","type":"link out","z":"acf9afadecece0b1","name":"link out 621","mode":"return","links":[],"x":1435,"y":900,"wires":[]},{"id":"39b8c49a0dfd80ed","type":"file","z":"acf9afadecece0b1","name":"erase global file","filename":"/config/global.yaml","filenameType":"str","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1300,"y":960,"wires":[["4fa2975bd7054012"]]},{"id":"9bc72ac561d10f07","type":"comment","z":"acf9afadecece0b1","name":"Purge history > 7 days","info":"","x":1240,"y":260,"wires":[]},{"id":"5906249810aabddb","type":"function","z":"acf9afadecece0b1","name":"empty globals","func":"let notAcceptedGlobals = [\"homeassistant\"]\nlet acceptedGlobals = global.keys().filter(g => !(notAcceptedGlobals.includes(g)))\n\nfor (let key of acceptedGlobals) {\n    setGlobal(key)\n}\nmsg.payload = {}\nreturn msg\n\nfunction setGlobal(name) {\n    global.set(name, undefined)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1120,"y":960,"wires":[["39b8c49a0dfd80ed"]]},{"id":"55bfc3f974404f10","type":"link out","z":"acf9afadecece0b1","name":"link out 628","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"67827c358afab680","type":"comment","z":"acf9afadecece0b1","name":"HA startup / reloading","info":"","x":1020,"y":580,"wires":[]},{"id":"b6c9b37db7b0ee60","type":"link in","z":"acf9afadecece0b1","name":"ambiances restore","links":["6bbacc14f0eb603b"],"x":55,"y":1120,"wires":[["6b6943157d9c825a"]]},{"id":"6b6943157d9c825a","type":"function","z":"acf9afadecece0b1","name":"get temperature devices >","func":"return { search: { \"is\": { linked_class: \"temperature\" } }, output_name: \"temperatures\", output_empty_results: false }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":1120,"wires":[["e298eaddea284d52"]],"l":false},{"id":"e298eaddea284d52","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":155,"y":1120,"wires":[["9f549dea4fc95ed6"]],"l":false},{"id":"9f549dea4fc95ed6","type":"function","z":"acf9afadecece0b1","name":"set temperatures","func":"let msgs = []\n\nfor (let temperature of msg.temperatures) {\n    msgs.push({ ...temperature, new_state: temperature.state })\n}\n\nreturn [msgs];","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":1120,"wires":[["a85d801de5cad16b"]]},{"id":"a85d801de5cad16b","type":"link out","z":"acf9afadecece0b1","name":"link out 644","mode":"link","links":["40c7ed2cde5e0b7a"],"x":415,"y":1120,"wires":[]},{"id":"346474bc037af36f","type":"link in","z":"acf9afadecece0b1","name":"ambiances restore","links":["6bbacc14f0eb603b"],"x":55,"y":1180,"wires":[["5251372d40e8a93b"]]},{"id":"5251372d40e8a93b","type":"function","z":"acf9afadecece0b1","name":"get temperature devices >","func":"return { search: { \"is\": { linked_class: \"humidity\" } }, output_name: \"humidities\", output_empty_results: false }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":1180,"wires":[["9d64695d1af80b7b"]],"l":false},{"id":"9d64695d1af80b7b","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":155,"y":1180,"wires":[["6a764c0fc8755107"]],"l":false},{"id":"6a764c0fc8755107","type":"function","z":"acf9afadecece0b1","name":"set humidities","func":"let msgs = []\n\nfor (let humidity of msg.humidities) {\n    msgs.push({ ...humidity, new_state: humidity.state })\n}\n\nreturn [msgs];","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":1180,"wires":[["95fbe6401846cf7e"]]},{"id":"95fbe6401846cf7e","type":"link out","z":"acf9afadecece0b1","name":"link out 645","mode":"link","links":["104bb863e8274015"],"x":395,"y":1180,"wires":[]},{"id":"e59d2ff4d007146f","type":"function","z":"acf9afadecece0b1","name":"set illuminances","func":"let regex = /^\\d+(\\.\\d+)?$/\nlet areas = {}\nlet msgs = []\n\nfor (let entity of msg.entities) {\n    if (regex.test(entity.state)) {\n        if (!(entity.linked_area in areas)) {\n            areas[entity.linked_area] = { linked_entity: entity.linked_entity, states: [] }\n            areas[entity.linked_area][\"states\"].push(entity.state)\n        } else {\n            areas[entity.linked_area][\"states\"].push(entity.state)\n        }\n    }\n}\n\nfor (let keys of Object.keys(areas)) {\n    msgs.push({\n        linked_area: keys,\n        linked_entity: areas[keys][\"linked_entity\"],\n        state: areas[keys][\"states\"].reduce((ps, a) => ps + a, 0) / areas[keys][\"states\"].length\n    })\n}\n\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":1240,"wires":[["af25144d1632cef5"]]},{"id":"bdebcfad2aaa4c2f","type":"link in","z":"acf9afadecece0b1","name":"","links":["6bbacc14f0eb603b"],"x":55,"y":1240,"wires":[["2eac9d46d08c8326"]]},{"id":"2eac9d46d08c8326","type":"function","z":"acf9afadecece0b1","name":"illuminances >","func":"msg.search = { \"is\": { linked_class: \"illuminance\" }, \"not\": { state: [\"unknown\", \"unvailable\"] } }\nmsg.output_name = \"entities\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":1240,"wires":[["34b0f29bf844fe9b"]],"l":false},{"id":"34b0f29bf844fe9b","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":155,"y":1240,"wires":[["e59d2ff4d007146f"]],"l":false},{"id":"af25144d1632cef5","type":"link out","z":"acf9afadecece0b1","name":"link out 646","mode":"link","links":["10d69c1c8f176d53"],"x":395,"y":1240,"wires":[]},{"id":"402949350591993c","type":"inject","z":"acf9afadecece0b1","name":"@ 4:00","props":[],"repeat":"","crontab":"00 04 * * *","once":false,"onceDelay":0.1,"topic":"","x":1000,"y":380,"wires":[["c55ca644e31c56c3"]]},{"id":"c55ca644e31c56c3","type":"link out","z":"acf9afadecece0b1","name":"@ 4:00","mode":"link","links":["8ffa2a7d44b0d3c2","e61d0ee809e604e1","626db9bda8ef4a69","cde22598a9ecef7b"],"x":1095,"y":380,"wires":[]},{"id":"8ffa2a7d44b0d3c2","type":"link in","z":"acf9afadecece0b1","name":"link in 569","links":["c55ca644e31c56c3"],"x":1155,"y":320,"wires":[["21b39f8bc3785772"]]},{"id":"e33b8ec1dbee9d6f","type":"inject","z":"acf9afadecece0b1","name":"1 min","props":[{"p":"linked_class","v":"time","vt":"str"}],"repeat":"","crontab":"*/1 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":990,"y":440,"wires":[["68f8f65865e43fb3"]]},{"id":"68f8f65865e43fb3","type":"link out","z":"acf9afadecece0b1","name":"every 1 min","mode":"link","links":["b8ac8f7952d8c752"],"x":1075,"y":440,"wires":[]},{"id":"557e6638781e2e82","type":"comment","z":"acf9afadecece0b1","name":"Global context management","info":"","x":160,"y":940,"wires":[]},{"id":"f71a0c1818898451","type":"link in","z":"acf9afadecece0b1","name":"ambiances restore","links":["6bbacc14f0eb603b"],"x":55,"y":1060,"wires":[["6007413589a1b1d4"]]},{"id":"6007413589a1b1d4","type":"function","z":"acf9afadecece0b1","name":"get persons >","func":"return { search: { \"is\": { linked_class: \"person\" } }, output_name: \"persons\", output_empty_results: true }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":1060,"wires":[["9a6ca08772a5bfda"]],"l":false},{"id":"9a6ca08772a5bfda","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":155,"y":1060,"wires":[["ae0715f5b82e09e5"]],"l":false},{"id":"b84c4de4488b36e0","type":"link in","z":"acf9afadecece0b1","name":"persons restore","links":["6bbacc14f0eb603b"],"x":55,"y":1300,"wires":[["a6d3e97bc8a1aa29"]]},{"id":"a6d3e97bc8a1aa29","type":"function","z":"acf9afadecece0b1","name":"lights >","func":"msg.search = { \"is\": { linked_class: \"light\" } }\nmsg.output_name = \"lights\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":1300,"wires":[["5a42aefc07569e5a"]],"l":false},{"id":"5a42aefc07569e5a","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":155,"y":1300,"wires":[["4775a05314d58b2a"]],"l":false},{"id":"4775a05314d58b2a","type":"function","z":"acf9afadecece0b1","name":"set light control","func":"let light_control = {}\n\nfor (let l of msg.lights) {\n    light_control[l.entity_id] = {\n        action: \"auto\",\n        locked: false,\n        color_temp_step: 3,\n        brightness_step: 3,\n        hs_color_step: [0, 100]\n    }\n}\n\nglobal.set(\"light_control\", light_control)","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":1300,"wires":[]},{"id":"0ac28b430fb0e0a5","type":"link in","z":"acf9afadecece0b1","name":"link in 586","links":["04a8b3f20b5e4036","f306b2c6155e238b"],"x":105,"y":860,"wires":[["afe7217eaa41ad52"]]},{"id":"f306b2c6155e238b","type":"link out","z":"acf9afadecece0b1","name":"link out 674","mode":"link","links":["0ac28b430fb0e0a5","e75e495ae3101914"],"x":1235,"y":1020,"wires":[]},{"id":"2970ac11229bf862","type":"server-state-changed","z":"acf9afadecece0b1","name":"reset_global_node_red","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.reset_global_node_red","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":935,"y":960,"wires":[["4ad99e413c30e495","e1cc1ebe8f1068a2"],[]],"l":false},{"id":"4ad99e413c30e495","type":"api-call-service","z":"acf9afadecece0b1","name":"reset_global_node_red off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.reset_global_node_red"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":995,"y":960,"wires":[[]],"l":false},{"id":"0a7e797864a5ecc8","type":"file","z":"acf9afadecece0b1","name":"","filename":"/config/notifications.yaml","filenameType":"str","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1090,"y":1020,"wires":[["f306b2c6155e238b"]]},{"id":"4fa2975bd7054012","type":"link out","z":"acf9afadecece0b1","name":"link out 3","mode":"link","links":["84b1615ed5c337fe"],"x":1415,"y":960,"wires":[]},{"id":"84b1615ed5c337fe","type":"link in","z":"acf9afadecece0b1","name":"link in 3","links":["4fa2975bd7054012"],"x":935,"y":1020,"wires":[["0a7e797864a5ecc8"]]},{"id":"e75e495ae3101914","type":"link in","z":"acf9afadecece0b1","name":"link in 4","links":["f306b2c6155e238b"],"x":415,"y":180,"wires":[["03dad2ae54d80734"]]},{"id":"6eee3a866db74979","type":"function","z":"acf9afadecece0b1","name":"set distances","func":"let distances = {}\nlet persons = msg.persons\nlet wifis = msg.wifis\n\nfor (let p of persons) {\n    let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\n    if (typeof p.attributes.latitude === \"number\" && typeof p.attributes.longitude === \"number\") {\n        let lat1 = zone_home.latitude\n        let lon1 = zone_home.longitude\n        let lat2 = p.attributes.latitude\n        let lon2 = p.attributes.longitude\n        distances[p.entity_id] = calculateDistance(lat1, lon1, lat2, lon2)\n    } else {\n        let wifi = wifis.filter(w => w.linked_person === p.entity_id)\n        if (wifi.length > 0) {\n            let home_wifis = wifi[0].home_wifis\n            let state = wifi[0].state\n            if (home_wifis.includes(state)) {\n                distances[p.entity_id] = 0\n            } else {\n                distances[p.entity_id] = (zone_home.radius + 1)\n            }\n        }\n    }\n}\nglobal.set(\"distances\", distances)\n\nfunction calculateDistance(lat1, lon1, lat2, lon2) {\n    let R = 6371e3\n    lat1 = lat1 * (Math.PI / 180)\n    lon1 = lon1 * (Math.PI / 180)\n    lat2 = lat2 * (Math.PI / 180)\n    lon2 = lon2 * (Math.PI / 180)\n    let dlat = lat2 - lat1\n    let dlon = lon2 - lon1\n    let a = Math.pow(Math.sin(dlat / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(dlon / 2), 2)\n    let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))\n    let d = R * c\n    return Math.round(d)\n}","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":1060,"wires":[]},{"id":"ae0715f5b82e09e5","type":"function","z":"acf9afadecece0b1","name":"get persons >","func":"return { ...msg, search: { \"is\": { linked_class: \"wifi\" } }, output_name: \"wifis\", output_empty_results: true }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":215,"y":1060,"wires":[["2f847f16f2ea6ffd"]],"l":false},{"id":"2f847f16f2ea6ffd","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":265,"y":1060,"wires":[["6eee3a866db74979"]],"l":false},{"id":"a18be1d1202b398b","type":"function","z":"acf9afadecece0b1","name":"msgs","func":"return { payload: { data: { entity_id: msg.speakers.map(s => s.entity_id), volume_level: msg.volume_level } } }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":660,"wires":[["0bce8ad1973f8241"]]},{"id":"03dad2ae54d80734","type":"function","z":"acf9afadecece0b1","name":"dashboard notification","func":"let notifications = global.get(\"notifications\") ?? {}\nlet notifications_keys = Object.keys(notifications)\nlet html_lines = []\nlet msgs = []\n\nlet alert_priority = { \"error\": 1, \"warning\": 2, \"success\": 3, \"info\": 4 }\nnotifications_keys.sort(function (a, b) { return alert_priority[notifications[a].alert_type] - alert_priority[notifications[b].alert_type] })\nfor (let key of notifications_keys) {\n    if (notifications[key].alert_type) {\n        html_lines.push('<ha-alert alert-type=\"' + notifications[key].alert_type + '\" >' + date_to_display(notifications[key].creation_date) + notifications[key].message + \"</ha-alert>\")\n    } else {\n        html_lines.push(notifications[key].title)\n    }\n}\nhtml_lines.push(\"</center>\")\n\nlet html = \"<center><h2>Notifications \" + (notifications_keys.length == 0 ? \"‚úÖ\" : \":\") + \"</h2>\" + html_lines.join(\"</br>\")\nfor (let i = 0, gap = 0; i < 10; i++) {\n    msgs.push({\n        payload: {\n            data: {\n                entity_id: \"input_text.notification_\" + (i + 1),\n                value: html.substring(gap, (gap + 254))\n            }\n        }\n    })\n    gap += 254\n}\nreturn [msgs]\n\nfunction date_to_display(notif_creation_date) {\n    let d = new Date()\n    let current_month = d.getMonth() + 1\n    let current_day = d.getDate()\n\n    let notifCreationDateSplit = notif_creation_date.split(\" \")\n    let notifMonth = parseInt(notifCreationDateSplit[0])\n    let notifDay = parseInt(notifCreationDateSplit[1])\n    let notifHour = notifCreationDateSplit[2]\n    let month_trad_fr = {\n        1: \"Janvier\",\n        2: \"F√©vrier\",\n        3: \"Mars\",\n        4: \"Avril\",\n        5: \"Mai\",\n        6: \"Juin\",\n        7: \"Juillet\",\n        8: \"Ao√ªt\",\n        9: \"Septembre\",\n        10: \"Octobre\",\n        11: \"Novembre\",\n        12: \"D√©cembre\"\n    }\n\n    if (current_day == notifDay && current_month == notifMonth) {\n        return notifHour + \" : \"\n    } else if (current_day - notifDay == 1 && current_month == notifMonth) {\n        return \"Hier √† \" + notifHour + \" : \"\n    } else if (current_day - notifDay == 2 && current_month == notifMonth) {\n        return \"Avant-hier √† \" + notifHour + \" : \"\n    } else {\n        return \"Le \" + notifDay + \" \" + month_trad_fr[notifMonth] + \" √† \" + notifHour + \" : \"\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":180,"wires":[["46851242dc1a55f5"]]},{"id":"46851242dc1a55f5","type":"api-call-service","z":"acf9afadecece0b1","name":"notifs","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"all","x":730,"y":180,"wires":[[]]},{"id":"332f65443ce0f931","type":"link in","z":"acf9afadecece0b1","name":"link in 9","links":["64e6badeb4fa7838"],"x":55,"y":660,"wires":[["7b461c42b288880f"]]},{"id":"0bce8ad1973f8241","type":"api-call-service","z":"acf9afadecece0b1","name":"volume set","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":660,"wires":[[]]},{"id":"17800bdb0daa153c","type":"function","z":"acf9afadecece0b1","name":"functions","func":"let functions = {}\n\nfunctions[\"get_volume_level\"] = function get_volume_level() {\n    let day_time = hm_txt_to_min_int(global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.day_time\"].state)\n    let night_time = hm_txt_to_min_int(global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.night_time\"].state)\n    let day_volume = parseFloat(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_day_mode_volume\"].state)\n    let night_volume = parseFloat(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_night_mode_volume\"].state)\n    let current_minutes = get_current_minutes()\n    return (day_time <= current_minutes && current_minutes < night_time ? day_volume : night_volume) / 100\n}\n\nfunctions[\"get_persons_sport\"] = function get_persons_sport(persons) {\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    return persons.filter(p =>\n        home_configuration[p.sport] &&\n        home_configuration[p.sport].days_to_ojective &&\n        home_configuration[p.sport].objective_limits &&\n        home_configuration[p.sport].objective_calendar)\n        .map(p => ({ ...p, sport: home_configuration[p.sport] }))\n}\n\nglobal.set(\"functions\", functions)\nreturn msg\n\nfunction hm_txt_to_min_int(txt) {\n    txt = txt.split(\":\").map(s => parseInt(s))\n    return txt[0] * 60 + txt[1]\n}\n\nfunction get_current_minutes() {\n    let date = new Date()\n    return date.getHours() * 60 + date.getMinutes()\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":860,"wires":[["6bbacc14f0eb603b"]]},{"id":"12cb1b38ba18986b","type":"link call","z":"acf9afadecece0b1","name":"","links":["ac26a339de0281fd"],"linkType":"static","timeout":"30","x":460,"y":860,"wires":[["17800bdb0daa153c"]]},{"id":"09eb8a5a90025624","type":"function","z":"acf9afadecece0b1","name":"notification","func":"let notifications = global.get(\"notifications\") ?? {}\nlet rain_alarm = global.get(\"rain_alarm\") ?? \"\"\nlet calendars = []\nlet speaks = []\n\nif (rain_alarm === \"True\") {\n    speaks.push(\"De la pluie est d√©tect√©e aux alentours\")\n}\n\nfor (let key of Object.keys(notifications)) {\n    if (notifications[key].speak !== \"\") {\n        if (key.startsWith(\"calendar_\")) {\n            calendars.push(notifications[key].speak)\n        } else {\n            speaks.push(notifications[key].speak)\n        }\n    }\n}\n\nif (calendars.length > 0) {\n    speaks.push(\n        calendars.length === 1 ?\n            (\"Vous avez un √©v√©nement. \" + calendars[0])\n            : (\"Vous avez plusieurs √©v√©nements. \" + calendars.join(\". \"))\n    )\n}\n\nif (speaks.length > 0) {\n    return { speak: speaks.join(\". \") + \".\" }\n} else {\n    return { speak: \"\" }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":320,"wires":[["1b418997ebdc00c9"]]},{"id":"63b89bf958e767a1","type":"comment","z":"acf9afadecece0b1","name":"Home recap","info":"","x":110,"y":260,"wires":[]},{"id":"9769cccc0a88c320","type":"server-state-changed","z":"acf9afadecece0b1","name":"home_recap","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.home_recap","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":320,"wires":[["61555e855a2da372","ac5a0eb7e6805f0b"],[]]},{"id":"61555e855a2da372","type":"api-call-service","z":"acf9afadecece0b1","name":"home_recap off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.home_recap"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":215,"y":320,"wires":[[]],"l":false},{"id":"1b418997ebdc00c9","type":"subflow:3dd3ba0d3b3a0ffd","z":"acf9afadecece0b1","name":"","x":480,"y":320,"wires":[]},{"id":"dbe8ef3bb3be75e7","type":"function","z":"acf9afadecece0b1","name":"average calc","func":"let average = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state)\nlet temp_hum = global.get(\"temp_hum\") ?? {}\n\nif (\n    temp_hum[\"exterior\"]?.[\"temperature\"]?.value &&\n    temp_hum[\"exterior\"]?.[\"temperature\"]?.last_changed &&\n    ((new Date().getTime() - temp_hum[\"exterior\"]?.[\"temperature\"]?.last_changed) / 1000) < 60 * 60\n) {\n    if (!Array.isArray(average)) {\n        average = [temp_hum[\"exterior\"][\"temperature\"].value, 1]\n    } else if (Array.isArray(average)) {\n        if (average[1] < 10) {\n            average[0] = calculateAverage(average)\n            average[1]++\n        } else {\n            average[0] = calculateAverage(average)\n        }\n    }\n    return { entity_id: \"input_text.json_exterior_average_temp\", state: JSON.stringify(average) }\n}\n\nfunction calculateAverage(average) {\n    return Math.round(((average[0] * average[1] + temp_hum[\"exterior\"][\"temperature\"].value) / (average[1] + 1)) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1110,"y":180,"wires":[["12a3e46ae9e7beca"]]},{"id":"b1c93595db02afb6","type":"comment","z":"acf9afadecece0b1","name":"day / night cycles","info":"","x":1000,"y":1100,"wires":[]},{"id":"5b6d1e649c3842c5","type":"ha-time","z":"acf9afadecece0b1","name":"day_time","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.day_time","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":980,"y":1160,"wires":[["17eda753ef78d92a"]]},{"id":"a88b610535548903","type":"ha-time","z":"acf9afadecece0b1","name":"night_time","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.night_time","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":1120,"y":1160,"wires":[["17eda753ef78d92a"]]},{"id":"504ac831071d308c","type":"server-state-changed","z":"acf9afadecece0b1","name":"elevation","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.elevation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":1260,"y":1160,"wires":[["17eda753ef78d92a"]]},{"id":"e165d282c3f67dc6","type":"function","z":"acf9afadecece0b1","name":"is_day_time ?","func":"let sun_angle_day_time = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_day_time\"].state)\nlet night_time = timeConversion(global.get('homeassistant').homeAssistant.states[\"input_datetime.night_time\"].state)\nlet day_time = timeConversion(global.get('homeassistant').homeAssistant.states[\"input_datetime.day_time\"].state)\nlet is_day_time = global.get('homeassistant').homeAssistant.states[\"input_boolean.is_day_time\"].state === \"on\"\nlet elevation = parseFloat(global.get('homeassistant').homeAssistant.states[\"input_number.elevation\"].state)\n\nlet d = new Date()\nlet current_time = d.getHours() * 60 + d.getMinutes()\n\nlet should_be_day = (day_time <= current_time && current_time < night_time) || elevation > sun_angle_day_time\n\nif (should_be_day && !is_day_time){\n    return { entity_id: \"input_boolean.is_day_time\", state: \"on\" }\n}\n\nif (!should_be_day && is_day_time) {\n    return { entity_id: \"input_boolean.is_day_time\", state: \"off\" }\n}\n\nfunction timeConversion(text) {\n    let split = text.split(\":\")\n    let hours = parseFloat(split[0])\n    let minutes = parseFloat(split[1])\n    return hours * 60 + minutes\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1060,"y":1220,"wires":[["c5472f2efc2b8990"]]},{"id":"c5472f2efc2b8990","type":"subflow:2f44a0de1e92d674","z":"acf9afadecece0b1","name":"","x":1230,"y":1220,"wires":[]},{"id":"17eda753ef78d92a","type":"link out","z":"acf9afadecece0b1","name":"link out 2","mode":"link","links":["99cacc42c4df886e"],"x":1355,"y":1160,"wires":[]},{"id":"99cacc42c4df886e","type":"link in","z":"acf9afadecece0b1","name":"link in 6","links":["17eda753ef78d92a"],"x":935,"y":1220,"wires":[["e165d282c3f67dc6"]]},{"id":"e31bbfb1859b5c4b","type":"link in","z":"acf9afadecece0b1","name":"persons restore","links":["6bbacc14f0eb603b"],"x":55,"y":1360,"wires":[["f6ef41627af8d64c"]]},{"id":"f6ef41627af8d64c","type":"function","z":"acf9afadecece0b1","name":"set dc_mapping","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet devices_controls = home_configuration.devices_controls ?? {}\nlet dc_mapping = {}\n\nlet key = 0\nfor (let dc of devices_controls) {\n    for (let t of dc.triggers) {\n        if (dc_mapping[t] === undefined) {\n            dc_mapping[t] = []\n        }\n        dc_mapping[t].push(key)\n    }\n    key++\n}\n\nglobal.set(\"dc_mapping\", dc_mapping)","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":1360,"wires":[]},{"id":"7ebd0b71c8503628","type":"function","z":"acf9afadecece0b1","name":"notification","func":"let still_open = msg.still_open\nlet speaks = []\n\nif (still_open.length > 0) {\n    speaks.push(\"Rappel de vuln√©rabilit√©, \" + set_still_open_text(still_open))\n    return { speak: speaks.join(\". \") + \".\" }\n} else {\n    return { speak: \"\" }\n}\n\nfunction set_still_open_text(still_open) {\n    let alias = still_open.map(a => a.alias)\n    if (alias.length === 1) {\n        return \"la \" + alias[0] + \" est ouverte\"\n    } else {\n        let joined = alias.slice(0, -1).join(\", \") + \" et \" + alias[alias.length - 1]\n        return \"les \" + joined + \" sont ouvertes\"\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":460,"wires":[["dd91bb8c5f5e949c"]]},{"id":"3e40eeb8819bd6fd","type":"comment","z":"acf9afadecece0b1","name":"Still open","info":"","x":100,"y":400,"wires":[]},{"id":"31a5763f312b84c8","type":"server-state-changed","z":"acf9afadecece0b1","name":"still_open","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.still_open","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":100,"y":460,"wires":[["2f83f3c3b4a36761","75f9c09001eabef8"],[]]},{"id":"2f83f3c3b4a36761","type":"api-call-service","z":"acf9afadecece0b1","name":"still_open off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.still_open"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":195,"y":460,"wires":[[]],"l":false},{"id":"dd91bb8c5f5e949c","type":"subflow:3dd3ba0d3b3a0ffd","z":"acf9afadecece0b1","name":"","x":760,"y":460,"wires":[]},{"id":"0f1dec3ad88e7ae1","type":"function","z":"acf9afadecece0b1","name":"get windows - doors on >","func":"msg.search = { \"is\": { linked_class: [\"window\", \"motion\"], state: \"on\", security_intrusion: true } }\nmsg.output_name = \"still_open\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":460,"wires":[["60cf6d08f7820ef7"]]},{"id":"60cf6d08f7820ef7","type":"subflow:87a3c75768fca823","z":"acf9afadecece0b1","name":"","x":495,"y":460,"wires":[["7ebd0b71c8503628"]],"l":false},{"id":"ea7ad577901c4143","type":"catch","z":"5c0ec3337dae79c1","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["6f9d1e3b083d95bb"]]},{"id":"8c4a145a6a4668f8","type":"subflow:759003382b0f7bfd","z":"5c0ec3337dae79c1","name":"","x":460,"y":40,"wires":[["08e1fd8d576bead7"]]},{"id":"6f9d1e3b083d95bb","type":"change","z":"5c0ec3337dae79c1","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Inputs","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8c4a145a6a4668f8"]]},{"id":"0d81f5567820f17b","type":"server-events","z":"5c0ec3337dae79c1","name":"state_changed","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"state_changed","eventData":"","waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":120,"y":180,"wires":[["bedcb5b2aaf76620","2d54055090d53463"]]},{"id":"b50c5a9ea609967c","type":"function","z":"5c0ec3337dae79c1","name":"merge home configuration","func":"let notAcceptedStates = [\"none\", \"unavailable\", \"unknown\", \"\"]\nlet new_state = msg.event?.new_state?.state\nlet old_state = msg.event?.old_state?.state\n\nnew_state = notAcceptedStates.includes(new_state.toLowerCase()) ? undefined : new_state\nold_state = notAcceptedStates.includes(old_state.toLowerCase()) ? undefined : old_state\n\nmsg = {\n    ...msg.entities[0],\n    new_state: format_state(new_state),\n    old_state: format_state(old_state),\n    attributes: msg.event?.new_state?.attributes,\n    target: \"linked_class_\" + msg.entities[0].linked_class\n}\n\nreturn msg\n\nfunction format_state(state) {\n    return typeof state === \"undefined\" ? null : isNaN(state) ? state : parseFloat(state)\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":180,"wires":[["7f9f6b7d0c007065"]]},{"id":"4b12500b997b0b74","type":"subflow:2f44a0de1e92d674","z":"5c0ec3337dae79c1","name":"","x":1270,"y":320,"wires":[]},{"id":"b3a5924980fd4dc2","type":"subflow:2f44a0de1e92d674","z":"5c0ec3337dae79c1","name":"","x":1270,"y":440,"wires":[]},{"id":"3d5f1a6dc5d97e45","type":"link out","z":"5c0ec3337dae79c1","name":"detect cover","mode":"link","links":["3ab36654e5f6e5a4","96642412f3189640"],"x":1325,"y":560,"wires":[]},{"id":"5740179cddee99f3","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_cover","links":[],"x":55,"y":560,"wires":[["3d5f1a6dc5d97e45","6cacc61acb38e4cc"]]},{"id":"fcfe4627c9a0949d","type":"function","z":"5c0ec3337dae79c1","name":"set","func":"let acceptedStates = [\"on\", \"off\"]\n\nif (acceptedStates.includes(msg.old_state) && acceptedStates.includes(msg.new_state) && msg.old_state != msg.new_state) {\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":680,"wires":[["43b78688a296e686"]]},{"id":"5d364c8d1e653ab3","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_window","links":[],"x":55,"y":680,"wires":[["fcfe4627c9a0949d","cc3393aabe2a22b5","3938aa4312c7e513"]]},{"id":"43b78688a296e686","type":"link out","z":"5c0ec3337dae79c1","name":"detect windows","mode":"link","links":["c6d4bb922b20b4d3","6145aea0d0920aa7","ed6dbafa163a421c","74fd5fab259ae129","de7142bc47adf762","a4ef8b4c39f3ac7b"],"x":1325,"y":680,"wires":[]},{"id":"c135537d902ea23c","type":"function","z":"5c0ec3337dae79c1","name":"initialize light","func":"let at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state === \"on\"\nlet light_control = global.get(\"light_control\") ?? {}\nlet motion_areas = global.get(\"motion_areas\") ?? {}\n\nif (msg.old_state === null && [\"on\", \"off\"].includes(msg.new_state)) {\n    if (at_home && !light_control[msg.entity_id].locked) {\n        let state = motion_areas[msg.linked_area] ?? \"off\"\n        msg = { linked_area: msg.linked_area, state: state }\n        return [msg, null]\n    } else {\n        msg = { entity_id: msg.entity_id, state: \"off\" }\n        return [null, msg]\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":1040,"wires":[["2ebbb3558143410d"],["0b5d8a173e28a7a9"]]},{"id":"5c0800c2187c3880","type":"link out","z":"5c0ec3337dae79c1","name":"detect light","mode":"link","links":["29f1c94d15fef0c5"],"x":1325,"y":1040,"wires":[]},{"id":"0b5d8a173e28a7a9","type":"subflow:2f44a0de1e92d674","z":"5c0ec3337dae79c1","name":"","x":1210,"y":1040,"wires":[]},{"id":"2d9570331f126007","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_light","links":[],"x":55,"y":1040,"wires":[["64a0c2c1427f7737","886b9ed968b88214"]]},{"id":"0b627da33b5e2f76","type":"server-events","z":"5c0ec3337dae79c1","name":"cube bluetooth","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"xiaomi_aqara.cube_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"x":460,"y":1280,"wires":[["763bb17b04bcc880"]]},{"id":"b87c0e7644e2e73b","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_cube","links":[],"x":55,"y":1280,"wires":[["298399d47e5305fe","3a08775a7771dcbd"]]},{"id":"6d013fc518336c00","type":"link out","z":"5c0ec3337dae79c1","name":"ambiance","mode":"link","links":["1b2b75f6bfef0964","db7766aa306c4476"],"x":1325,"y":1460,"wires":[]},{"id":"1929171e1e6fad42","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_ambiance","links":[],"x":55,"y":1460,"wires":[["6d013fc518336c00","a2471ce053416f42"]]},{"id":"298399d47e5305fe","type":"switch","z":"5c0ec3337dae79c1","name":"zigbee","property":"linked_type","propertyType":"msg","rules":[{"t":"eq","v":"zigbee","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":730,"y":1280,"wires":[["147799316ce81127"]]},{"id":"147799316ce81127","type":"function","z":"5c0ec3337dae79c1","name":"cube >","func":"let at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\n\nif (at_home) {\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    if (msg.entity_id in home_configuration) {\n        msg.search = { \"is\": { entity_id: msg.entity_id } }\n        msg.output_name = \"entities\"\n        msg.output_empty_results = false\n        return msg\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":1280,"wires":[["28641aadc99146d6"]]},{"id":"577e532fa4ced343","type":"link out","z":"5c0ec3337dae79c1","name":"detect persons position","mode":"link","links":["3ab78227bbad6368"],"x":1325,"y":1580,"wires":[]},{"id":"76dc4f9f2ab9f611","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_person","links":[],"x":55,"y":1580,"wires":[["a83706eb44eb3b47","cb27974e332a4bba"]]},{"id":"2177a74f49c55bc9","type":"link out","z":"5c0ec3337dae79c1","name":"security intrusion","mode":"link","links":["25430d24bf9a4895","a6c776732b964c3d","904e87601ddec8eb"],"x":1325,"y":920,"wires":[]},{"id":"b6fb2942df9a5a1f","type":"subflow:471d8d84d3052fd9","z":"5c0ec3337dae79c1","name":"","x":1240,"y":2300,"wires":[]},{"id":"1788ee8575ebfbf5","type":"subflow:2f44a0de1e92d674","z":"5c0ec3337dae79c1","name":"","x":1210,"y":2060,"wires":[]},{"id":"a4ecfed616f6c333","type":"function","z":"5c0ec3337dae79c1","name":"set","func":"let acceptedStates = [\"on\", \"off\"]\n\nif (\n    msg.security_intrusion    \n    && acceptedStates.includes(msg.new_state)\n    && acceptedStates.includes(msg.old_state)\n    && msg.old_state !== msg.new_state\n) {\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":920,"wires":[["2177a74f49c55bc9"]]},{"id":"b8ddcb09c43c340f","type":"link out","z":"5c0ec3337dae79c1","name":"illuminance","mode":"link","links":["222c4f1e0871bee0"],"x":1325,"y":2060,"wires":[]},{"id":"64214a41d80809d7","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_remote","links":[],"x":55,"y":2300,"wires":[["b6fb2942df9a5a1f","7629fc6e417c8d91"]]},{"id":"bedcb5b2aaf76620","type":"link out","z":"5c0ec3337dae79c1","name":"link out 6","mode":"link","links":["af07bd46b8ab4f0c"],"x":235,"y":180,"wires":[]},{"id":"7eaa2394f39f1b6c","type":"server-events","z":"5c0ec3337dae79c1","name":"","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"emulate","eventData":"","waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"x":720,"y":180,"wires":[["3314dbeca0b52541"]]},{"id":"35221897ded992cd","type":"function","z":"5c0ec3337dae79c1","name":"merge home configuration","func":"msg = {\n    ...msg.entities[0],\n    ...msg.event,\n    target: \"linked_class_\" + msg.entities[0].linked_class\n}\n\ndelete msg.state\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":180,"wires":[["7f9f6b7d0c007065"]]},{"id":"2d54055090d53463","type":"function","z":"5c0ec3337dae79c1","name":"get linked home configuration","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet new_state_exist = msg.event.new_state?.state !== undefined\nlet old_state_exist = msg.event.old_state?.state !== undefined\n\nif (home_configuration[msg.event.entity_id] && new_state_exist && old_state_exist) {\n    msg.search = { \"is\": { entity_id: msg.event.entity_id } }\n    msg.output_name = \"entities\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":295,"y":180,"wires":[["8b098ee1f9745724"]],"l":false},{"id":"8b098ee1f9745724","type":"subflow:87a3c75768fca823","z":"5c0ec3337dae79c1","name":"","x":355,"y":180,"wires":[["b50c5a9ea609967c"]],"l":false},{"id":"3314dbeca0b52541","type":"function","z":"5c0ec3337dae79c1","name":"get linked home configuration","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (home_configuration[msg.event.entity_id]) {\n    msg.search = { \"is\": { entity_id: msg.event.entity_id } }\n    msg.output_name = \"entities\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":835,"y":180,"wires":[["df15861262f8d38b"]],"l":false},{"id":"df15861262f8d38b","type":"subflow:87a3c75768fca823","z":"5c0ec3337dae79c1","name":"","x":895,"y":180,"wires":[["35221897ded992cd"]],"l":false},{"id":"48008522c919ac7b","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_temperature","info":"","x":150,"y":260,"wires":[]},{"id":"0869c7fbe661e3d6","type":"comment","z":"5c0ec3337dae79c1","name":"inputs","info":"","x":90,"y":120,"wires":[]},{"id":"417c95fdfef719fe","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_cover","info":"","x":130,"y":500,"wires":[]},{"id":"6a8edd6e6603b477","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_window","info":"","x":140,"y":620,"wires":[]},{"id":"d54642bed3ece12d","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_motion","info":"","x":130,"y":740,"wires":[]},{"id":"d47ff5db33df720b","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_light","info":"","x":120,"y":980,"wires":[]},{"id":"5efdfff36742a032","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_ambiance","info":"","x":140,"y":1400,"wires":[]},{"id":"1e929f5cc958286a","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_person","info":"","x":130,"y":1520,"wires":[]},{"id":"08931e990f12cbfa","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_illuminance","info":"","x":150,"y":2000,"wires":[]},{"id":"c24761d125d705d7","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class motion / window","info":"","x":160,"y":860,"wires":[]},{"id":"223931efdd617bf7","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_remote","info":"","x":130,"y":2240,"wires":[]},{"id":"b59f31ca470ed47a","type":"function","z":"5c0ec3337dae79c1","name":"set global illuminance","func":"if (typeof msg.state === \"number\") {\n    let illuminances = global.get(\"illuminances\") ?? {}\n    let low_light_compensation_changed = false\n    let linked_area = msg.linked_area\n    let smooth_intensity = 10\n\n    if (!illuminances[linked_area]) {\n        illuminances[linked_area] = {}\n    }\n\n    let value = illuminances[linked_area].value ?? msg.state\n    let mean_value = Math.round((value * smooth_intensity + msg.state) / (smooth_intensity + 1))\n\n    if (linked_area == \"exterior\") {\n        let low_light_compensation = global.get('homeassistant').homeAssistant.states[\"input_boolean.low_light_compensation\"].state == \"on\"\n        let low_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.low_light_compensation\"].state)\n        let low_light_compensation_on = low_light_compensation && mean_value < low_light && illuminances[linked_area].value > low_light\n        let low_light_compensation_off = low_light_compensation && mean_value > low_light && illuminances[linked_area].value < low_light\n        low_light_compensation_changed = low_light_compensation_on || low_light_compensation_off\n    }\n\n    illuminances[linked_area].value = mean_value\n    illuminances[linked_area].last_changed = new Date().getTime()\n    global.set(\"illuminances\", illuminances)\n\n    msg = { entity_id: msg.linked_entity, state: mean_value }\n    return [msg, low_light_compensation_changed ? msg : null]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1020,"y":2060,"wires":[["1788ee8575ebfbf5"],["9d4c4c17ae927277"]]},{"id":"d279ab5d0d82b944","type":"comment","z":"5c0ec3337dae79c1","name":"devices control","info":"","x":120,"y":2600,"wires":[]},{"id":"339dd88aa9333998","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_motion","links":[],"x":55,"y":800,"wires":[["e18ce4ccf08f3c80","ef52ee42c310a632","1e5881718ce69f76"]]},{"id":"1ce929ac616df668","type":"link out","z":"5c0ec3337dae79c1","name":"detect motion","mode":"link","links":["29f1c94d15fef0c5","c6d4bb922b20b4d3","74fd5fab259ae129","904e87601ddec8eb","a4ef8b4c39f3ac7b"],"x":1325,"y":800,"wires":[]},{"id":"77fa6904c3b81d15","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_calendar","info":"","x":140,"y":2360,"wires":[]},{"id":"684560c505414ec3","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_calendar","links":[],"x":55,"y":2420,"wires":[["17f7b50c2c37989e","9fd72f00250b06d5"]]},{"id":"146c37beceae46af","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_light_control","info":"","x":150,"y":1100,"wires":[]},{"id":"4d70b67f4454069b","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_light_control","links":[],"x":55,"y":1160,"wires":[["f1c790f2321f2ff0","e3dd9c683fb88ba0"]]},{"id":"08e1fd8d576bead7","type":"link out","z":"5c0ec3337dae79c1","name":"link out 9","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"104bb863e8274015","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_humidity","links":["95fbe6401846cf7e"],"x":55,"y":440,"wires":[["5b48ecd694f36282","cab9736c6076387d"]]},{"id":"6be1a03782934451","type":"function","z":"5c0ec3337dae79c1","name":"set global","func":"let value = msg.new_state\n\nif (typeof value === \"number\") {\n    let temperature_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state)\n    let temperature_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state)\n    let temp_hum = global.get(\"temp_hum\") ?? {}\n    let linked_area = msg.linked_area\n\n    if (!temp_hum[linked_area]) { temp_hum[linked_area] = {} }\n    if (!temp_hum[linked_area][\"temperature\"] || isNaN(temp_hum[linked_area][\"temperature\"].value) || isNaN(temp_hum[linked_area][\"temperature\"].mean_hour)) {\n        temp_hum[linked_area][\"temperature\"] = { value: value, mean_hour: value, last_changed: new Date().getTime() }\n    }\n\n    let timeElapsed = parseInt((new Date().getTime() - temp_hum[linked_area][\"temperature\"].last_changed) / 1000)\n    let mean_10min = meanCalc(timeElapsed, 600, value, temp_hum[linked_area][\"temperature\"].value)\n    let mean_hour = meanCalc(timeElapsed, 3600, mean_10min, temp_hum[linked_area][\"temperature\"].mean_hour)\n    let mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000\n\n    temp_hum[linked_area][\"temperature\"].high = temperature_max <= (Math.ceil(10 * mean_10min) / 10)\n    temp_hum[linked_area][\"temperature\"].low = (Math.ceil(10 * mean_10min) / 10) <= temperature_min\n    temp_hum[linked_area][\"temperature\"].last_changed = new Date().getTime()\n    temp_hum[linked_area][\"temperature\"].tendency = mean_hour_tendency\n    temp_hum[linked_area][\"temperature\"].mean_hour = mean_hour\n    temp_hum[linked_area][\"temperature\"].value = mean_10min\n    temp_hum[linked_area].alias = msg.alias ?? msg.linked_area\n\n    global.set(\"temp_hum\", temp_hum)\n    msg = { entity_id: msg.linked_entity, state: mean_10min }\n    return msg\n}\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1120,"y":320,"wires":[["4b12500b997b0b74"]]},{"id":"cab9736c6076387d","type":"function","z":"5c0ec3337dae79c1","name":"set global","func":"let value = msg.new_state\n\nif (typeof value === \"number\") {\n    let humidity_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state)\n    let humidity_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state)\n    let temp_hum = global.get(\"temp_hum\") ?? {}\n    let linked_area = msg.linked_area\n\n    if (!temp_hum[linked_area]) { temp_hum[linked_area] = {} }\n    if (!temp_hum[linked_area][\"humidity\"] || isNaN(temp_hum[linked_area][\"humidity\"].value) || isNaN(temp_hum[linked_area][\"humidity\"].mean_hour)) {\n        temp_hum[linked_area][\"humidity\"] = { value: value, mean_hour: value, last_changed: new Date().getTime() }\n    }\n\n    let timeElapsed = parseInt((new Date().getTime() - temp_hum[linked_area][\"humidity\"].last_changed) / 1000)\n    let mean_10min = meanCalc(timeElapsed, 600, value, temp_hum[linked_area][\"humidity\"].value)\n    let mean_hour = meanCalc(timeElapsed, 3600, mean_10min, temp_hum[linked_area][\"humidity\"].mean_hour)\n    let mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000\n\n    temp_hum[linked_area][\"humidity\"].high = humidity_max <= (Math.ceil(10 * mean_10min) / 10)\n    temp_hum[linked_area][\"humidity\"].low = (Math.ceil(10 * mean_10min) / 10) <= humidity_min\n    temp_hum[linked_area][\"humidity\"].last_changed = new Date().getTime()\n    temp_hum[linked_area][\"humidity\"].tendency = mean_hour_tendency\n    temp_hum[linked_area][\"humidity\"].mean_hour = mean_hour\n    temp_hum[linked_area][\"humidity\"].value = mean_10min\n    temp_hum[linked_area].alias = msg.alias\n\n    global.set(\"temp_hum\", temp_hum)\n    msg = { entity_id: msg.linked_entity, state: mean_10min }\n    return msg\n}\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1120,"y":440,"wires":[["b3a5924980fd4dc2"]]},{"id":"2da311d5da2155b5","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_humidity","info":"","x":140,"y":380,"wires":[]},{"id":"10d69c1c8f176d53","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_illuminance","links":["af25144d1632cef5"],"x":55,"y":2060,"wires":[["2dd05ef06ec07943","b59f31ca470ed47a"]]},{"id":"763bb17b04bcc880","type":"function","z":"5c0ec3337dae79c1","name":"cube >","func":"let at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\n\nif (at_home) {\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    if (msg.payload.entity_id in home_configuration) {\n        msg.search = { \"is\": { entity_id: msg.payload.entity_id } }\n        msg.output_name = \"entities\"\n        msg.output_empty_results = false\n        msg = { ...msg, ...msg.payload.event }\n        return msg\n    }\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":1280,"wires":[["28641aadc99146d6"]]},{"id":"28641aadc99146d6","type":"subflow:87a3c75768fca823","z":"5c0ec3337dae79c1","name":"","x":935,"y":1280,"wires":[["5170df19a7b99a74"]],"l":false},{"id":"5170df19a7b99a74","type":"function","z":"5c0ec3337dae79c1","name":"set cube","func":"return { ...msg, ...msg.entities[0] }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":1280,"wires":[["c9f977743ff13cb9"]]},{"id":"6a68f2de087a6e67","type":"link out","z":"5c0ec3337dae79c1","name":"link out 10","mode":"link","links":["df789372ee48b3ab"],"x":1325,"y":1280,"wires":[]},{"id":"c9f977743ff13cb9","type":"function","z":"5c0ec3337dae79c1","name":"get action","func":"let msgs_actions = []\nlet msgs_lights = []\n\nif (msg.listen !== undefined && Array.isArray(msg.listen)) {\n    for (let l of msg.listen) {\n        let s = l[\"if\"] ? l[\"if\"].replaceAll(\" \", \"\").split(\"=\") : []\n        if (s.length > 0) {\n            if (msg[s[0]] === s[1] && l[\"then\"] && l[\"for\"]) {\n                msgs_lights.push(set_msg(l[\"then\"], l[\"for\"], l[\"transition\"]))\n            } else if (typeof msg[s[0]] === \"number\" && l[\"then\"] && l[\"for\"]) {\n                let val = msg[s[0]] > 0 ? \"pos_val\" : \"neg_val\"\n                if (l[\"if\"].replaceAll(\" \", \"\") === (s[0] + \"=\" + val)) {\n                    msgs_lights.push(set_msg(s[1] === msg[s[0]] > 0 ? l[\"then\"] : l[\"then\"], l[\"for\"], l[\"transition\"]))\n                }\n            } else if (msg[s[0]] === s[1] && l[\"then\"]) {\n                msgs_actions.push({ then: l[\"then\"] })\n            }\n        }\n    }\n    return [msgs_lights, msgs_actions]\n}\n\nfunction set_msg(action, linked_lights, transition) {\n    return {\n        search: { \"is\": { linked_class: \"light\", entity_id: linked_lights } },\n        output_name: \"lights\",\n        output_empty_results: false,\n        action: action,\n        transition: transition ?? 1\n    }\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":1280,"wires":[["6b89526ae3f6d4f8"],["8432ae2dda8596a2"]]},{"id":"8432ae2dda8596a2","type":"link out","z":"5c0ec3337dae79c1","name":"cube action","mode":"link","links":["c1e41f1b4eb08365"],"x":1275,"y":1280,"wires":[]},{"id":"4d43b179ab718974","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_wifi","info":"","x":120,"y":1760,"wires":[]},{"id":"af41bdefbde838b5","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_wifi","links":[],"x":55,"y":1820,"wires":[["42d80a9915252c36","4824fc0d8fa30aaf"]]},{"id":"1905d4ac1b511d2d","type":"link out","z":"5c0ec3337dae79c1","name":"link out 13","mode":"link","links":["3ab78227bbad6368"],"x":1325,"y":1820,"wires":[]},{"id":"42d80a9915252c36","type":"function","z":"5c0ec3337dae79c1","name":"set wifi","func":"let linked_person = msg.linked_person ?? \"\"\nlet home_wifis = msg.home_wifis ?? []\nlet state = msg.state\n\nif (linked_person !== \"\") {\n    if (home_wifis.includes(state)) {\n        return { entity_id: msg.linked_person, payload: 0 }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1070,"y":1820,"wires":[["0b3b0c58abab7a47"]]},{"id":"5a2e3d8ff8e7de97","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_next_alarm","links":[],"x":55,"y":1940,"wires":[["5c26f688abda30b1","d7b488caf18b260f"]]},{"id":"d3ad5b45b7e6a2ff","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_next_alarm","info":"","x":150,"y":1880,"wires":[]},{"id":"102b87cea48bde20","type":"link out","z":"5c0ec3337dae79c1","name":"link out 14","mode":"link","links":["1b8b1ab1d5f32f39"],"x":1325,"y":1940,"wires":[]},{"id":"5c26f688abda30b1","type":"delay","z":"5c0ec3337dae79c1","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1265,"y":1940,"wires":[["102b87cea48bde20"]],"l":false},{"id":"b429a42fac43231d","type":"link out","z":"5c0ec3337dae79c1","name":"link out 15","mode":"link","links":["af07bd46b8ab4f0c"],"x":1275,"y":2420,"wires":[]},{"id":"15dcad771bbed6f0","type":"link out","z":"5c0ec3337dae79c1","name":"security panel","mode":"link","links":["a783a1816f6a4b4b"],"x":1325,"y":2180,"wires":[]},{"id":"8e509f95a276f55d","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_security_panel","links":[],"x":55,"y":2180,"wires":[["21cef4f8f66046f3","76c7ce40a82bb0dd"]]},{"id":"33fd319860609e66","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_security_panel","info":"","x":160,"y":2120,"wires":[]},{"id":"21cef4f8f66046f3","type":"function","z":"5c0ec3337dae79c1","name":"set","func":"if (msg.new_state && Array.isArray(msg.code)) {\n    return {\n        arming_time: msg.arming_time ?? 30,\n        code: msg.code,\n        states: msg.new_state\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":2180,"wires":[["15dcad771bbed6f0"]]},{"id":"0c0c226dd8541fa3","type":"function","z":"5c0ec3337dae79c1","name":"set distances","func":"let distances = global.get(\"distances\") ?? {}\nlet person = msg.entity_id\n\nif (distances[person] !== undefined && msg.payload === \"unknown\") {\n    delete distances[person]\n    global.set(\"distances\", distances)\n} else if (distances[person] !== msg.payload) {\n    distances[person] = msg.payload\n    global.set(\"distances\", distances)\n    return {}\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":1580,"wires":[["577e532fa4ced343"]]},{"id":"a83706eb44eb3b47","type":"function","z":"5c0ec3337dae79c1","name":"calculate distance","func":"let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\nif (msg.new_state === \"home\") {\n    msg.payload = 0\n} else if (typeof msg.attributes.latitude === \"number\" && typeof msg.attributes.longitude === \"number\") {\n    let lat1 = zone_home.latitude\n    let lon1 = zone_home.longitude\n    let lat2 = msg.attributes.latitude\n    let lon2 = msg.attributes.longitude\n    msg.payload = calculateDistance(lat1, lon1, lat2, lon2)\n} else if (msg.new_state === \"not_home\") {\n    msg.payload = (zone_home.radius + 1)\n} else if (msg.state === \"unknown\") {\n    msg.payload = \"unknown\"\n}\nreturn msg\n\nfunction calculateDistance(lat1, lon1, lat2, lon2) {\n    let R = 6371e3\n    lat1 = lat1 * (Math.PI / 180)\n    lon1 = lon1 * (Math.PI / 180)\n    lat2 = lat2 * (Math.PI / 180)\n    lon2 = lon2 * (Math.PI / 180)\n    let dlat = lat2 - lat1\n    let dlon = lon2 - lon1\n    let a = Math.pow(Math.sin(dlat / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(dlon / 2), 2)\n    let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))\n    let d = R * c\n    return Math.round(d)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1030,"y":1580,"wires":[["0c0c226dd8541fa3"]]},{"id":"0b3b0c58abab7a47","type":"function","z":"5c0ec3337dae79c1","name":"set distances","func":"let distances = global.get(\"distances\") ?? {}\nlet person = msg.entity_id\n\nif (distances[person] !== msg.payload) {\n    distances[person] = msg.payload\n    global.set(\"distances\", distances)\n    return {}\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":1820,"wires":[["1905d4ac1b511d2d"]]},{"id":"e18ce4ccf08f3c80","type":"function","z":"5c0ec3337dae79c1","name":"set motions","func":"if (msg.linked_area) {\n    let acceptedStates = [\"on\", \"off\"]\n    let new_state = state_converter(msg.new_state)\n    let old_state = state_converter(msg.old_state)\n\n    if (acceptedStates.includes(old_state) && acceptedStates.includes(new_state) && old_state != new_state) {\n        let motion_state = msg.inverted_motion ? { \"on\": \"off\", \"off\": \"on\" }[new_state] : new_state\n        let motion_areas = global.get(\"motion_areas\") ?? {}\n        let motions = flow.get(\"motions\") ?? {}\n        let msgs = []\n\n        set_motion(motions, motion_state)\n        if (motion_state === \"on\") {\n            motion_areas[msg.linked_area] = \"on\"\n            msgs.push({ linked_area: msg.linked_area, state: motion_state, linked_class: msg.linked_class, alias: msg.alias })\n            let last_motion_area = Object.keys(motion_areas).filter(m => motion_areas[m] === \"last\")\n\n            if (last_motion_area.length === 1 && last_motion_area[0] !== msg.linked_area) {\n                motion_areas[last_motion_area[0]] = \"off\"\n                msgs.push({ linked_area: last_motion_area[0], state: \"off\", linked_class: msg.linked_class, alias: msg.alias })\n            }\n\n            global.set(\"motion_areas\", motion_areas)\n            return [msgs]\n\n        } else if (motion_state === \"off\") {            \n            let area_state = Object.keys(motions).filter(m => motions[m].linked_area === msg.linked_area)\n                .map(m => motions[m].state).reduce((a, b) => a || b === \"on\", false)\n            if (!area_state) {\n                let last_area_on = Object.keys(motion_areas).filter(m => motion_areas[m] === \"on\")\n\n                if (last_area_on.length === 1 && last_area_on[0] === msg.linked_area) {\n                    motion_areas[msg.linked_area] = \"last\"\n                    msgs.push({ linked_area: msg.linked_area, state: \"last\", linked_class: msg.linked_class, alias: msg.alias })\n                } else {\n                    motion_areas[msg.linked_area] = \"off\"\n                    msgs.push({ linked_area: msg.linked_area, state: \"off\", linked_class: msg.linked_class, alias: msg.alias })\n                }\n\n                global.set(\"motion_areas\", motion_areas)\n                return [msgs]\n\n            }\n        }\n    }\n}\n\nfunction state_converter(state) {\n    let convert = {\n        \"has one\": \"on\",\n        \"no one\": \"off\",\n        \"on\": \"on\",\n        \"off\": \"off\"\n    }\n    return convert[state]\n}\n\nfunction set_motion(motions, state) {\n    motions[msg.entity_id] = { linked_area: msg.linked_area, state: state }\n    flow.set(\"motions\", motions)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":800,"wires":[["1ce929ac616df668"]]},{"id":"318fb8b03d61b124","type":"subflow:87a3c75768fca823","z":"5c0ec3337dae79c1","name":"","x":935,"y":800,"wires":[["6d0aa659cb802f15"]],"l":false},{"id":"6d0aa659cb802f15","type":"function","z":"5c0ec3337dae79c1","name":"reset motion","func":"let areas = [...new Set(msg.motions.map(a => a.linked_area))]\nlet ha_motions = msg.motions\nlet motion_areas = {}\nlet motions = {}\n\nfor (let m of ha_motions) {\n    let state = [\"on\", \"off\"].includes(m.state) ? (m.inverted_motion ? { \"on\": \"off\", \"off\": \"on\" }[m.state] : m.state) : \"off\"\n    motions[m.entity_id] = { linked_area: m.linked_area, state: state }\n}\n\nfor (let a of areas) {\n    motion_areas[a] = ha_motions.filter(m => m.linked_area === a)\n        .map(m => (m.inverted_motion ? { \"on\": \"off\", \"off\": \"on\" }[m.state] : m.state))\n        .reduce((a, b) => a === \"on\" || b === \"on\", false)\n    motion_areas[a] = motion_areas[a] ? \"on\" : \"off\"\n}\n\nglobal.set(\"motion_areas\", motion_areas)\nflow.set(\"motions\", motions)\n\nreturn msg","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":800,"wires":[]},{"id":"a13e36cfc4599277","type":"link in","z":"5c0ec3337dae79c1","name":"persons restore","links":["6bbacc14f0eb603b"],"x":835,"y":800,"wires":[["1db2a0495063a450"]]},{"id":"1db2a0495063a450","type":"function","z":"5c0ec3337dae79c1","name":"motions >","func":"msg = {\n    search: { \"is\": { linked_class: \"motion\" } },\n    output_name: \"motions\",\n    output_empty_results: false\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":885,"y":800,"wires":[["318fb8b03d61b124"]],"l":false},{"id":"64a0c2c1427f7737","type":"api-current-state","z":"5c0ec3337dae79c1","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":870,"y":1040,"wires":[["c135537d902ea23c"],[]]},{"id":"5841032ed5627d4f","type":"server-events","z":"5c0ec3337dae79c1","name":"listen google assistant","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"google_assistant_command","eventData":"","waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"x":140,"y":1340,"wires":[["0214bdbbdd700c49"]]},{"id":"4b0bf6056b4362e1","type":"function","z":"5c0ec3337dae79c1","name":"lock/unlock light","func":"let light_control = global.get(\"light_control\") ?? {}\nlet entity_ids = msg.event?.entity_id ?? []\nlet params = msg.event?.execution[0]?.params ?? {}\n\nlet auto = false\nlet lights = entity_ids.filter(e => light_control[e])\nif (params && lights.length > 0) {\n    for (let l of lights) {\n        if (params.brightness === 42) {\n            light_control[l].locked = false\n            auto = true\n        } else {\n            light_control[l].locked = true\n        }\n    }\n}\n\nglobal.set(\"light_control\", light_control)\nreturn auto ? { transition: 5 } : null","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1200,"y":1340,"wires":[["799a86a9f46c8d74"]]},{"id":"799a86a9f46c8d74","type":"link out","z":"5c0ec3337dae79c1","name":"link out 16","mode":"link","links":["222c4f1e0871bee0"],"x":1325,"y":1340,"wires":[]},{"id":"0214bdbbdd700c49","type":"subflow:f884e97a0daa4ce2","z":"5c0ec3337dae79c1","name":"","x":1040,"y":1340,"wires":[["4b0bf6056b4362e1"],[]]},{"id":"981ccab95507ea30","type":"link out","z":"5c0ec3337dae79c1","name":"link out 17","mode":"link","links":["8edaeb40fc5e5069"],"x":1325,"y":2420,"wires":[]},{"id":"17f7b50c2c37989e","type":"function","z":"5c0ec3337dae79c1","name":"calendar >","func":"let state = msg.state ?? \"\"\n\nif (state === \"on\") {\n    msg.search = { \"is\": { linked_class: \"calendar\" } }\n    msg.output_name = \"calendars\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":2420,"wires":[["5ee1135b22de9738"]]},{"id":"5ee1135b22de9738","type":"subflow:87a3c75768fca823","z":"5c0ec3337dae79c1","name":"","x":725,"y":2420,"wires":[["8a2912d483acb05e"]],"l":false},{"id":"8a2912d483acb05e","type":"function","z":"5c0ec3337dae79c1","name":"set data","func":"let d = new Date()\nlet year = d.getFullYear()\nlet month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1)\nlet day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate()\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\nlet start_date_time = year + \"-\" + month + \"-\" + day + \" 00:00:00\"\nlet end_date_time = year + \"-\" + month + \"-\" + day + \" 23:59:59\"\n\nlet calendars = {}\nfor(let c of msg.calendars){\n    calendars[c.entity_id] = c\n}\n\nreturn {\n    current_time: year + \"-\" + month + \"-\" + day + \"T\" + hour + \":\" + minute,\n    calendars: calendars,\n    payload: {\n        data: {\n            entity_id: Object.keys(calendars),\n            start_date_time: start_date_time,\n            end_date_time: end_date_time\n        }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":2420,"wires":[["a29aae1d88feff50"]]},{"id":"a29aae1d88feff50","type":"api-call-service","z":"5c0ec3337dae79c1","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"calendar","service":"get_events","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"results","propertyType":"msg","value":"","valueType":"results"},{"property":"sent_data","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1000,"y":2420,"wires":[["50b14b03f8b8a531"]]},{"id":"50b14b03f8b8a531","type":"function","z":"5c0ec3337dae79c1","name":"send to","func":"let executes = []\nlet events = []\nfor (let key of Object.keys(msg.results)) {\n    if (msg.results[key].events.length > 0) {\n        for (let e of msg.results[key].events) {\n            if (\n                e.start.includes(\"T\") && e.start.includes(msg.current_time) ||\n                (!(e.start.includes(\"T\"))) && e.start.includes(msg.current_time.split(\"T\")[0])\n            ) {\n                events.push({ ...e, ...msg.calendars[key] })\n            }\n        }\n    }\n}\n\nif (events.length > 0) {\n    let notifications = []\n    let count = 0\n    for (let e of events) {\n        is_devices_control(e.description ?? \"\")\n        notifications.push({\n            notification_id: \"calendar_\" + count + new Date().getTime().toString(),\n            send_to: e.send_to ?? [],\n            alert_type: \"success\",\n            send_mobile: true,\n            message: \"üìÜ \" + (e.alias ?? \"\") + \" > \" + e.summary,\n            speak: e.summary,\n        })\n        count++\n    }\n    return [notifications, executes]\n}\n\nfunction is_devices_control(description) {\n    let regex = /devices_control:\"([^\"]*)\"/\n    if (regex.test(description)) {\n        executes.push({\n            event: {\n                entity_id: description.match(regex)[1],\n                new_state: { state: msg.new_state },\n                old_state: { state: msg.old_state }\n            }\n        })\n    }\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":2420,"wires":[["ce0aa73004d1e959"],["b429a42fac43231d"]]},{"id":"40c7ed2cde5e0b7a","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_temperature","links":["a85d801de5cad16b"],"x":55,"y":320,"wires":[["1cba6419b4740a6d","6be1a03782934451"]]},{"id":"57b031e718115980","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_plant","links":[],"x":55,"y":2540,"wires":[["8cb09d1ccc6bb29f","039e632875e03578"]]},{"id":"51b481b3d2c3f1ca","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_plant","info":"","x":130,"y":2480,"wires":[]},{"id":"8cb09d1ccc6bb29f","type":"function","z":"5c0ec3337dae79c1","name":"plant","func":"let notification_id = \"plant_\" + msg.entity_id.split(\".\")[1]\nlet notifications = global.get(\"notifications\") ?? {}\nlet name = msg.name ?? msg.attributes.friendly_name\nlet limits = msg.limits ?? [20, 80]\nlet new_state = msg.new_state\nlet old_state = msg.old_state\n\nif (old_state != new_state) {\n  if (notifications[notification_id] === undefined) {\n    name = name + \" \" + (name.split(\" \")[0].toLowerCase() === \"les\" ? \" ont \" : \" √† \")\n    if (new_state < limits[0]) {\n      return {\n        notification_id: notification_id,\n        alert_type: \"warning\",\n        title: \"Plantes\",\n        message: \"üí¶ü™¥ \" + name + \"besoin d'eau\",\n        speak: name + \"besoin d'eau\",\n        send_mobile: true,\n        data: {}\n      }\n    } else if (notifications[notification_id] === undefined && new_state > limits[1]) {\n      return {\n        notification_id: notification_id,\n        alert_type: \"warning\",\n        title: \"Plantes\",\n        message: \"üåäü™¥ \" + name + \"trop d'eau\",\n        speak: name + \"trop d'eau\",\n        send_mobile: true,\n        data: {}\n      }\n    }\n  } else if (new_state > (limits[0] + (limits[1] - limits[0]) / 2)) {\n    return {\n      notification_id: notification_id,\n      dismiss: true\n    }\n  }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":2540,"wires":[["4ed795b7eaa8dd47"]]},{"id":"4ed795b7eaa8dd47","type":"link out","z":"5c0ec3337dae79c1","name":"link out 5","mode":"link","links":["8edaeb40fc5e5069"],"x":1325,"y":2540,"wires":[]},{"id":"7f9f6b7d0c007065","type":"link call","z":"5c0ec3337dae79c1","name":"target","links":[],"linkType":"dynamic","timeout":"30","x":1290,"y":180,"wires":[[]]},{"id":"50aba4b568cb8031","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_cube","info":"","x":130,"y":1220,"wires":[]},{"id":"7f852f5f326b74b9","type":"link in","z":"5c0ec3337dae79c1","name":"security_intrusion","links":["1e5881718ce69f76","3938aa4312c7e513"],"x":55,"y":920,"wires":[["a4ecfed616f6c333"]]},{"id":"1cba6419b4740a6d","type":"link out","z":"5c0ec3337dae79c1","name":"link out 20","mode":"return","links":[],"x":105,"y":320,"wires":[]},{"id":"5b48ecd694f36282","type":"link out","z":"5c0ec3337dae79c1","name":"link out 22","mode":"return","links":[],"x":105,"y":440,"wires":[]},{"id":"6cacc61acb38e4cc","type":"link out","z":"5c0ec3337dae79c1","name":"link out 25","mode":"return","links":[],"x":105,"y":560,"wires":[]},{"id":"cc3393aabe2a22b5","type":"link out","z":"5c0ec3337dae79c1","name":"link out 26","mode":"return","links":[],"x":105,"y":680,"wires":[]},{"id":"ef52ee42c310a632","type":"link out","z":"5c0ec3337dae79c1","name":"link out 41","mode":"return","links":[],"x":155,"y":800,"wires":[]},{"id":"886b9ed968b88214","type":"link out","z":"5c0ec3337dae79c1","name":"link out 42","mode":"return","links":[],"x":105,"y":1040,"wires":[]},{"id":"f1c790f2321f2ff0","type":"link out","z":"5c0ec3337dae79c1","name":"link out 43","mode":"return","links":[],"x":105,"y":1160,"wires":[]},{"id":"3a08775a7771dcbd","type":"link out","z":"5c0ec3337dae79c1","name":"link out 44","mode":"return","links":[],"x":105,"y":1280,"wires":[]},{"id":"a2471ce053416f42","type":"link out","z":"5c0ec3337dae79c1","name":"link out 45","mode":"return","links":[],"x":105,"y":1460,"wires":[]},{"id":"cb27974e332a4bba","type":"link out","z":"5c0ec3337dae79c1","name":"link out 46","mode":"return","links":[],"x":105,"y":1580,"wires":[]},{"id":"4824fc0d8fa30aaf","type":"link out","z":"5c0ec3337dae79c1","name":"link out 47","mode":"return","links":[],"x":105,"y":1820,"wires":[]},{"id":"d7b488caf18b260f","type":"link out","z":"5c0ec3337dae79c1","name":"link out 48","mode":"return","links":[],"x":105,"y":1940,"wires":[]},{"id":"2dd05ef06ec07943","type":"link out","z":"5c0ec3337dae79c1","name":"link out 49","mode":"return","links":[],"x":105,"y":2060,"wires":[]},{"id":"76c7ce40a82bb0dd","type":"link out","z":"5c0ec3337dae79c1","name":"link out 50","mode":"return","links":[],"x":105,"y":2180,"wires":[]},{"id":"7629fc6e417c8d91","type":"link out","z":"5c0ec3337dae79c1","name":"link out 52","mode":"return","links":[],"x":115,"y":2300,"wires":[]},{"id":"9fd72f00250b06d5","type":"link out","z":"5c0ec3337dae79c1","name":"link out 53","mode":"return","links":[],"x":105,"y":2420,"wires":[]},{"id":"039e632875e03578","type":"link out","z":"5c0ec3337dae79c1","name":"link out 54","mode":"return","links":[],"x":105,"y":2540,"wires":[]},{"id":"3938aa4312c7e513","type":"link out","z":"5c0ec3337dae79c1","name":"link out 51","mode":"link","links":["7f852f5f326b74b9"],"x":155,"y":680,"wires":[]},{"id":"1e5881718ce69f76","type":"link out","z":"5c0ec3337dae79c1","name":"link out 55","mode":"link","links":["7f852f5f326b74b9"],"x":105,"y":800,"wires":[]},{"id":"3514ac7a8be544e8","type":"comment","z":"5c0ec3337dae79c1","name":"linked_class_phone_state","info":"","x":150,"y":1640,"wires":[]},{"id":"459e8c21efa073c5","type":"link in","z":"5c0ec3337dae79c1","name":"linked_class_phone_state","links":[],"x":55,"y":1700,"wires":[["42c89e3ec39ea195","bc031b0fc0f3829d"]]},{"id":"42c89e3ec39ea195","type":"link out","z":"5c0ec3337dae79c1","name":"link out 28","mode":"return","links":[],"x":105,"y":1700,"wires":[]},{"id":"1cc0bbaaab268d23","type":"function","z":"5c0ec3337dae79c1","name":"calc","func":"let active_calls = global.get(\"homeassistant\").homeAssistant.states[\"input_text.active_calls\"].state\nactive_calls = active_calls === \"\" ? [] : active_calls.split(\"|\")\n\nfor (let p of msg.persons) {\n    if (p.state === \"home\") {\n        let phone_state = msg.phone_states.find(phone => phone.linked_person === p.entity_id)?.state\n        if (phone_state !== \"idle\" && !active_calls.includes(p.name)) {\n            active_calls.push(p.name)\n        } else if (phone_state === \"idle\" && active_calls.includes(p.name)) {\n            active_calls = active_calls.filter(c => c !== p.name)\n        }\n    }\n}\n\nreturn { entity_id: \"input_text.active_calls\", state: active_calls.join(\"|\") }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1130,"y":1700,"wires":[["d044dab3eb9e1111"]]},{"id":"bc031b0fc0f3829d","type":"function","z":"5c0ec3337dae79c1","name":"persons >","func":"if (msg.linked_person && [\"ringing\", \"offhook\", \"idle\"].includes(msg.state)) {\n    msg.search = { \"is\": { linked_class: \"person\" } }\n    msg.output_name = \"persons\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":1700,"wires":[["069f257fdac2f348"]]},{"id":"069f257fdac2f348","type":"subflow:87a3c75768fca823","z":"5c0ec3337dae79c1","name":"","x":795,"y":1700,"wires":[["a07e2ab6f91558b8"]],"l":false},{"id":"a07e2ab6f91558b8","type":"function","z":"5c0ec3337dae79c1","name":"phone_state >","func":"msg.search = { \"is\": { linked_class: \"phone_state\" } }\nmsg.output_name = \"phone_states\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":1700,"wires":[["e2201f7b778dc6b2"]]},{"id":"e2201f7b778dc6b2","type":"subflow:87a3c75768fca823","z":"5c0ec3337dae79c1","name":"","x":1035,"y":1700,"wires":[["1cc0bbaaab268d23"]],"l":false},{"id":"d044dab3eb9e1111","type":"subflow:2f44a0de1e92d674","z":"5c0ec3337dae79c1","name":"","x":1270,"y":1700,"wires":[]},{"id":"af07bd46b8ab4f0c","type":"link in","z":"5c0ec3337dae79c1","name":"link in 24","links":["b429a42fac43231d","bedcb5b2aaf76620"],"x":55,"y":2660,"wires":[["f84aec816e9e6ddb"]]},{"id":"f84aec816e9e6ddb","type":"subflow:27aabf8cb913bb7c","z":"5c0ec3337dae79c1","name":"","x":170,"y":2660,"wires":[["7bf93e6f1ac1941e"]]},{"id":"7603c876e842df51","type":"link out","z":"5c0ec3337dae79c1","name":"devices_control","mode":"link","links":["c1e41f1b4eb08365"],"x":1325,"y":2660,"wires":[]},{"id":"7bf93e6f1ac1941e","type":"function","z":"5c0ec3337dae79c1","name":"conditions","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet dc_mapping = global.get(\"dc_mapping\") ?? {}\nlet devices_controls = home_configuration.devices_controls ?? {}\nlet entity_id = msg.event?.new_state?.entity_id\nlet state = msg.event?.new_state?.state\nlet msgs = []\n\nif (entity_id !== undefined && state !== undefined && Array.isArray(devices_controls) && Array.isArray(dc_mapping[entity_id])) {\n    let waits = global.get(\"waits\") ?? {}\n    for (let dc_key of dc_mapping[entity_id]) {\n        let count = 0\n        for (let c_key of Object.keys(devices_controls[dc_key].conditions)) {\n            for (let w_key of Object.keys(waits)) {\n                if (waits[w_key].template.includes(entity_id)) {\n                    msgs.push({\n                        template: update_template(waits[w_key].template),\n                        then: waits[w_key].intime,\n                        id: w_key\n                    })\n                }\n            }\n            msgs.push({\n                template: update_template(c_key),\n                then: devices_controls[dc_key].conditions[c_key],\n                id_part: `${dc_key}_${count}`\n            })\n            count++\n        }\n    }\n}\n\nreturn [msgs]\n\nfunction update_template(template) {\n    if (template.startsWith(\"raw \")) {\n        return add_globals(template) + template.substring(4)\n    }\n    let ts = template.replace(/\\{\\{|\\}\\}/g, \"\").trim().split(\" \")\n    let updated_template = []\n    for (let i = 0; i < ts.length; i++) {\n        updated_template.push((ts[i].includes(`states(\"${entity_id}\")`) ?\n            (!isNaN(state) && state.trim() !== \"\" ? state : `\"${state}\"`) : ts[i]))\n    }\n    return add_globals(template) + `{{ ${updated_template.join(\" \")} }}`\n}\n\nfunction add_globals(template) {\n    if (template.includes(\"global.\")) {\n        let included_globals = global.keys().filter(g => template.includes(\"global.\" + g))\n        return \"{% set global = {\" + included_globals.map(x => (`\"${x}\": ${JSON.stringify(global.get(x) ?? {})}`)).join(\",\") + \"} %}\"\n    }\n    return \"\"\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":2660,"wires":[["8296150e3a9ae595"]]},{"id":"8296150e3a9ae595","type":"api-render-template","z":"5c0ec3337dae79c1","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":1275,"y":2660,"wires":[["7603c876e842df51"]],"l":false},{"id":"e3dd9c683fb88ba0","type":"function","z":"5c0ec3337dae79c1","name":"get action","func":"let at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet msgs_actions = []\nlet msgs_lights = []\n\nif (at_home && msg.listen !== undefined && Array.isArray(msg.listen)) {\n    for (let l of msg.listen) {\n        let s = l[\"if\"] ? l[\"if\"].replaceAll(\" \", \"\").split(\"=\") : []\n        if (s.length > 0 && msg[s[0]] === s[1] && l[\"then\"] && l[\"for\"]) {\n            msgs_lights.push({\n                search: { \"is\": { linked_class: \"light\", entity_id: l[\"for\"] } },\n                output_name: \"lights\",\n                output_empty_results: false,\n                action: l[\"then\"],\n                transition: l[\"transition\"] ?? 1\n            })\n        } else if (s.length > 0 && msg[s[0]] === s[1] && l[\"then\"]) {\n            msgs_actions.push({ then: l[\"then\"] })\n        }\n    }\n    return [msgs_lights, msgs_actions]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":1160,"wires":[["cfc2bd9c1c8aeaef"],["4125a760160a803e"]]},{"id":"c6639c073cb2e0ad","type":"subflow:87a3c75768fca823","z":"5c0ec3337dae79c1","name":"","x":1075,"y":1160,"wires":[["a6b2ddd0ba7fa5ab"]],"l":false},{"id":"4d28aab6ebce6747","type":"api-call-service","z":"5c0ec3337dae79c1","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1325,"y":1160,"wires":[[]],"l":false},{"id":"9e33fb2b0690abfd","type":"link out","z":"5c0ec3337dae79c1","name":"link out 56","mode":"link","links":["222c4f1e0871bee0"],"x":1275,"y":1160,"wires":[]},{"id":"4125a760160a803e","type":"link out","z":"5c0ec3337dae79c1","name":"light_control action","mode":"link","links":["c1e41f1b4eb08365"],"x":975,"y":1160,"wires":[]},{"id":"df789372ee48b3ab","type":"link in","z":"5c0ec3337dae79c1","name":"link in 16","links":["6a68f2de087a6e67"],"x":1025,"y":1160,"wires":[["c6639c073cb2e0ad"]]},{"id":"a6b2ddd0ba7fa5ab","type":"function","z":"5c0ec3337dae79c1","name":"set lights","func":"let light_control = global.get(\"light_control\") ?? {}\nlet transition = msg.transition\nlet action = msg.action\nlet msgs = []\n\nfor (let l of msg.lights) {\n\n    if (action.includes(\"auto_\")) {\n        action = [\"on\", \"off\"].includes(light_control[l.entity_id].action) ? \"auto\" : action.replace(\"auto_\", \"\")\n    }\n\n    if (action === \"auto\") {\n        // reset\n        light_control[l.entity_id].action = \"auto\"\n        light_control[l.entity_id].locked = false\n    } else {\n        // Activate last config on lock\n\n        /*\n        if (!light_control[l.entity_id].locked) {\n             light_control[l.entity_id].locked = true\n            action = \"turn_on\"\n        }\n        */\n        \n        light_control[l.entity_id].locked = true\n        // toggle / turn_on / turn_off\n        if ([\"toggle\", \"turn_on\", \"turn_off\"].includes(action)) {\n            let l_action = light_control[l.entity_id].action\n            l_action = action === \"toggle\" ? l_action === \"auto\" ? \"on\" : l_action === \"on\" ? \"off\" : \"on\" : action === \"turn_on\" ? \"on\" : \"off\"\n            light_control[l.entity_id].action = l_action\n            msgs.push({ domain: \"light\", service: l_action !== \"toggle\" ? (\"turn_\" + l_action) : l_action, payload: { data: { entity_id: l.entity_id, transition: transition } } })\n        }\n        else {\n            light_control[l.entity_id].action = \"on\"\n            // brightness_step_up / brightness_step_down / brightness_step_loop\n            if (action.includes(\"brightness_step_\")) {\n                let x = light_control[l.entity_id].brightness_step\n                x = action.includes(\"_down\") ? (x - 1 < 1 ? 1 : x - 1) : (x + 1 > 5 ? (action.includes(\"_loop\") ? 1 : 5) : x + 1)\n                light_control[l.entity_id].brightness_step = x\n                msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: l.entity_id, brightness_pct: formula([1, 100], x), transition: transition } } })\n            }\n            // color_temp_step_up / color_temp_step_down / color_temp_step_loop\n            else if (action.includes(\"color_temp_step_\")) {\n                let x = light_control[l.entity_id].color_temp_step\n                x = action.includes(\"_down\") ? (x - 1 < 1 ? 1 : x - 1) : (x + 1 > 5 ? (action.includes(\"_loop\") ? 1 : 5) : x + 1)\n                light_control[l.entity_id].color_temp_step = x\n                msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: l.entity_id, color_temp_kelvin: formula([2250, 6500], x), transition: transition } } })\n            }\n            // color_step_up / color_step_down / color_step_loop\n            else if (action.includes(\"color_step_\") && light_control[l.entity_id].hs_color_step) {\n                let x = light_control[l.entity_id].hs_color_step\n                x[0] = action.includes(\"_down\") ? (x[0] - 30 < 0 ? 330 : x[0] - 30) : (x[0] + 30 > 360 ? 30 : x[0] + 30)\n                light_control[l.entity_id].hs_color_step = x\n                if (l.attributes.supported_color_modes.find(c => [\"xy\", \"hs\", \"rgb\"].includes(c))) {\n                    msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: l.entity_id, hs_color: x, transition: transition } } })\n                }\n            }\n            // saturation_step_up / saturation_step_down\n            else if (action.includes(\"saturation_step_\") && light_control[l.entity_id].hs_color_step) {\n                let x = light_control[l.entity_id].hs_color_step\n                x[1] = action.includes(\"_down\") ? (x[1] - 25 < 0 ? (action.includes(\"_loop\") ? 100 : 0) : x[1] - 25) : (x[1] + 25 > 100 ? (action.includes(\"_loop\") ? 0 : 100) : x[1] + 25)\n                light_control[l.entity_id].hs_color_step = x\n                if (l.attributes.supported_color_modes.find(c => [\"xy\", \"hs\", \"rgb\"].includes(c))) {\n                    msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: l.entity_id, hs_color: x, transition: transition } } })\n                }\n            }\n        }\n    }\n}\n\nglobal.set(\"light_control\", light_control)\n\nif (action === \"auto\") {\n    return [null, { transition: transition }]\n} else if (msgs.length > 0) {\n    return [msgs, null]\n}\n\nfunction formula(range, number) {\n    let step = (range[1] - range[0]) / 4\n    return range[0] + step * (number - 1)\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":1160,"wires":[["4c3450536e643820"],["9e33fb2b0690abfd"]]},{"id":"bddb5460cc766a94","type":"server-state-changed","z":"5c0ec3337dae79c1","name":"is_day_time","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.is_day_time","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"x":930,"y":2540,"wires":[["47ae1163d5460867"],[]]},{"id":"47ae1163d5460867","type":"function","z":"5c0ec3337dae79c1","name":"reset plants","func":"let notifications = global.get(\"notifications\") ?? {}\nlet msgs = []\n\nfor (let key of Object.keys(notifications)) {\n  if (key.startsWith(\"plant_\")) {\n    msgs.push({\n      notification_id: key,\n      dismiss: true\n    })\n  }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":2540,"wires":[["4ed795b7eaa8dd47"]]},{"id":"0b32c01e4f2a3f7b","type":"catch","z":"4f899d35193d55b5","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["4ff5e5c8bdd1176e"]]},{"id":"6e129aaa8f367e5a","type":"subflow:759003382b0f7bfd","z":"4f899d35193d55b5","name":"","x":460,"y":40,"wires":[["80ab5909764dad58"]]},{"id":"4ff5e5c8bdd1176e","type":"change","z":"4f899d35193d55b5","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Presence","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["6e129aaa8f367e5a"]]},{"id":"567080e9af5a15d8","type":"comment","z":"4f899d35193d55b5","name":"Zones detect","info":"","x":110,"y":1220,"wires":[]},{"id":"ad42bfb24ece17aa","type":"function","z":"4f899d35193d55b5","name":"notification","func":"if (msg.payload > 0 && (msg.zone[0].google_keep_list ?? false)) {\n    return {\n        title: \"Voici votre liste de courses\",\n        data: { clickAction: msg.zone[0].google_keep_list },\n        send_mobile: true\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":1280,"wires":[["13ee9a601823ebc3"]]},{"id":"13ee9a601823ebc3","type":"subflow:e4503a3be0539251","z":"4f899d35193d55b5","name":"","x":640,"y":1280,"wires":[]},{"id":"25430d24bf9a4895","type":"link in","z":"4f899d35193d55b5","name":"security","links":["2177a74f49c55bc9"],"x":55,"y":440,"wires":[["b1ee2169308132b2"]]},{"id":"a556a3a083363351","type":"comment","z":"4f899d35193d55b5","name":"Presence","info":"","x":100,"y":120,"wires":[]},{"id":"c3778b142a22e2ba","type":"comment","z":"4f899d35193d55b5","name":"Invitation","info":"","x":100,"y":820,"wires":[]},{"id":"b129ea86311f160d","type":"server-state-changed","z":"4f899d35193d55b5","name":"detect zones","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"^zone.","entityIdType":"regex","outputInitially":true,"stateType":"num","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":110,"y":1280,"wires":[["421d0841ce4a0bf8"]]},{"id":"e9d18f5507b0068a","type":"subflow:87a3c75768fca823","z":"4f899d35193d55b5","name":"","x":335,"y":1280,"wires":[["af093ff3837aa4df"]],"l":false},{"id":"421d0841ce4a0bf8","type":"function","z":"4f899d35193d55b5","name":"zone > ","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (home_configuration[msg.data.entity_id]) {\n    msg.topic = msg.data.entity_id\n    msg.search = { \"is\": { entity_id: msg.data.entity_id } }\n    msg.output_name = \"zone\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":1280,"wires":[["e9d18f5507b0068a"]]},{"id":"af093ff3837aa4df","type":"delay","z":"4f899d35193d55b5","name":"","pauseType":"queue","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":385,"y":1280,"wires":[["ad42bfb24ece17aa"]],"l":false},{"id":"0e1c98def973e674","type":"server-state-changed","z":"4f899d35193d55b5","name":"invitation / at_home","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_boolean.invitation","input_boolean.at_home"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":130,"y":880,"wires":[["a75829a2951eaee3"]]},{"id":"a6c776732b964c3d","type":"link in","z":"4f899d35193d55b5","name":"security","links":["2177a74f49c55bc9"],"x":55,"y":940,"wires":[["fd766939e575f2a8"]]},{"id":"0d58ab151de71347","type":"switch","z":"4f899d35193d55b5","name":"invitation_off","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"invitation_off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":555,"y":1000,"wires":[["0926a6429fa2d726"]],"l":false},{"id":"88a55a8caaf596e7","type":"link out","z":"4f899d35193d55b5","name":"link out 29","mode":"link","links":["8edaeb40fc5e5069"],"x":975,"y":1000,"wires":[]},{"id":"964c3e9fae6df32d","type":"function","z":"4f899d35193d55b5","name":"notification","func":"return { notification_id: \"invitation\", dismiss: true } ","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":1000,"wires":[["88a55a8caaf596e7"]]},{"id":"0926a6429fa2d726","type":"api-call-service","z":"4f899d35193d55b5","name":"home_invitation off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.invitation"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":1000,"wires":[["964c3e9fae6df32d"]]},{"id":"20fd9053aa4f2fb6","type":"server-events","z":"4f899d35193d55b5","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":450,"y":1000,"wires":[["0d58ab151de71347"]]},{"id":"904e87601ddec8eb","type":"link in","z":"4f899d35193d55b5","name":"security","links":["2177a74f49c55bc9","1ce929ac616df668"],"x":475,"y":940,"wires":[["53570f87c84df295"]]},{"id":"cfd936c3d15718d3","type":"function","z":"4f899d35193d55b5","name":"notification","func":"flow.set(\"wait_no_motion\", false)\n\nreturn {\n    notification_id: \"invitation\",\n    title: \"Mode invit√©\",\n    alert_type: \"success\",\n    message: \"L'invit√© est parti\",\n    data: { actions: [{ \"action\": \"invitation_off\", \"title\": \"D√©sactiver mode invit√©\" }] },\n    send_mobile: true\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":940,"wires":[["bc7e6036b5c7f488"]]},{"id":"bc7e6036b5c7f488","type":"link out","z":"4f899d35193d55b5","name":"link out 30","mode":"link","links":["8edaeb40fc5e5069"],"x":955,"y":940,"wires":[]},{"id":"80ab5909764dad58","type":"link out","z":"4f899d35193d55b5","name":"link out 31","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"a783a1816f6a4b4b","type":"link in","z":"4f899d35193d55b5","name":"control panel","links":["15dcad771bbed6f0"],"x":55,"y":320,"wires":[["03bc322582d8e2c3"]]},{"id":"e349153b57fa812d","type":"join","z":"4f899d35193d55b5","name":"","mode":"custom","build":"array","property":"states","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"10","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":635,"y":320,"wires":[["360e4d8e4ed217b7"]],"l":false},{"id":"7b170fc0055bb3c0","type":"trigger","z":"4f899d35193d55b5","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":true,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":400,"y":320,"wires":[["c0c7177a9201e3d6"]]},{"id":"c0c7177a9201e3d6","type":"function","z":"4f899d35193d55b5","name":"complete","func":"return { complete: \"\" }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":320,"wires":[["e349153b57fa812d"]]},{"id":"d98a9fc74584bd3e","type":"comment","z":"4f899d35193d55b5","name":"Security","info":"","x":100,"y":260,"wires":[]},{"id":"360e4d8e4ed217b7","type":"function","z":"4f899d35193d55b5","name":"validate code ","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet alarm_control_panel = global.get('homeassistant').homeAssistant.states[\"alarm_control_panel.alarm\"].state\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\n\nlet home_configuration = global.get(\"home_configuration\") ?? {}\nlet linked_lights = home_configuration?.security?.linked_lights ?? []\nlet arming_time = (home_configuration?.security?.arming_time ?? 0) * 1000\n\nif (msg.code.length === msg.states.length) {\n    let is_valid = msg.code.join(\"\") === msg.states.join(\"\")\n    if (is_valid) {\n        let msgs = []\n        if (alarm_control_panel === \"arming\" || alarm_control_panel !== \"disarmed\") {\n            msgs.push({ entity_id: \"alarm_control_panel.alarm\", state: \"disarmed\" })\n            return [null, msgs]\n\n        } else if (alarm_control_panel !== \"armed_away\") {\n            msgs.push({ entity_id: \"alarm_control_panel.alarm\", state: \"armed_away\" })\n            return [null, msgs]\n        }\n    } else {\n        let lights = []\n        if (alarm_control_panel === \"triggered\") {\n            set_lights_effect(300, 0, 1000, linked_lights, lights)\n        } else {\n            set_lights_effect(5, 15, 1000, linked_lights, lights)\n        }\n        return [lights, null]\n\n    }\n}\n\nfunction set_lights_effect(count, color, time, linked_lights, lights) {\n    if (linked_lights.length > 0) {\n        lights.push({ effects: { count: count, color: color, saturation: 100, time: time }, linked_lights: linked_lights })\n    }\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":320,"wires":[["10afb58252c91ffb"],["bbadb21e26c2de71"]]},{"id":"8e913ef53db55ea1","type":"function","z":"4f899d35193d55b5","name":"notification","func":"let alarm_control_panel = msg.alarm_control_panel\nlet msgs = []\n\nif (alarm_control_panel === \"armed_away\") {\n    msgs.push({ notification_id: \"security_intrusion\", alert_type: \"success\", message: \"Surveillance active üõ°Ô∏è\", send_mobile: false, data: {} })\n    return [msgs]\n} else if (alarm_control_panel === \"armed_night\") {\n    msgs.push({ notification_id: \"security_intrusion\", alert_type: \"success\", message: \"Surveillance üåô active üõ°Ô∏è\", send_mobile: false, data: {} })\n    return [msgs]\n} else if (alarm_control_panel === \"triggered\") {\n    msgs.push({ notification_id: \"security_intrusion\", alert_type: \"error\", message: \"üö® Alarme d√©clench√©e üö®\", send_mobile: true, data: {} })\n    return [msgs]\n} else if (alarm_control_panel === \"disarmed\") {\n    let security_intrusions = Object.keys(global.get(\"notifications\") ?? {}).filter(s => s.includes(\"security_intrusion_\"))\n    for (let s of security_intrusions) {\n        msgs.push({ notification_id: s, dismiss: true })\n    }\n    msgs.push({ notification_id: \"security_intrusion\", dismiss: true })\n    return [msgs]\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":560,"wires":[["c399324c356b412d"]]},{"id":"c399324c356b412d","type":"link out","z":"4f899d35193d55b5","name":"link out 32","mode":"link","links":["8edaeb40fc5e5069"],"x":655,"y":560,"wires":[]},{"id":"a03b2613cde1f8c5","type":"link out","z":"4f899d35193d55b5","name":"link out 33","mode":"link","links":["8edaeb40fc5e5069"],"x":745,"y":440,"wires":[]},{"id":"cbe8e593bedcee93","type":"function","z":"4f899d35193d55b5","name":"security_alarm","func":"let alarm_control_panel = global.get('homeassistant').homeAssistant.states[\"alarm_control_panel.alarm\"].state\n\nif (alarm_control_panel === \"armed_home\" && msg.state === \"on\") {\n    // disarm in armed_home status\n    return [null, { entity_id: \"alarm_control_panel.alarm\", state: \"disarmed\" }, null]\n} else if ([\"armed_away\", \"armed_night\"].includes(alarm_control_panel) && msg.state === \"on\" && msg.security_intrusion || alarm_control_panel === \"triggered\") {\n    // trigger in armed_away, armed_night status\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    let linked_lights = home_configuration?.security?.linked_lights ?? []\n\n    return [\n        {\n            notification_id: \"security_intrusion_\" + msg.linked_area + \"_\" + msg.linked_class,\n            title: \"üö® Intrusion üö®\",\n            message: \"D√©tection \" + (msg.linked_class === \"window\" ? \"ouverture \" : \"\") + msg.alias,\n            alert_type: \"error\",\n            send_mobile: true\n        },\n        alarm_control_panel !== \"triggered\" ? { entity_id: \"alarm_control_panel.alarm\", state: \"triggered\" } : null,\n        { linked_lights: linked_lights, effects: { count: 300, color: 0, saturation: 100, time: 1000 } }\n    ]\n}","outputs":3,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":440,"wires":[["723908611010fca2"],["59c2348faed8b0f0"],["1cef3e1b2fe479eb"]]},{"id":"f91859976e5535c5","type":"function","z":"4f899d35193d55b5","name":"invitation ?","func":"let invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\n\nif (invitation) {\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":1000,"wires":[["0926a6429fa2d726"]]},{"id":"b1ee2169308132b2","type":"api-current-state","z":"4f899d35193d55b5","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":210,"y":440,"wires":[["cbe8e593bedcee93"],[]]},{"id":"03bc322582d8e2c3","type":"api-current-state","z":"4f899d35193d55b5","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":210,"y":320,"wires":[["7b170fc0055bb3c0","5b61c82c297376c3"],[]]},{"id":"f7bc4a9ba5cac53c","type":"api-current-state","z":"4f899d35193d55b5","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":350,"y":560,"wires":[["8e913ef53db55ea1"],[]]},{"id":"1159f3a80e345e65","type":"server-state-changed","z":"4f899d35193d55b5","name":"module_security_intrusion","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_security_intrusion","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":150,"y":500,"wires":[["22c9674c144bc29a"]]},{"id":"d03b93e0906a12c0","type":"link out","z":"4f899d35193d55b5","name":"link out 34","mode":"link","links":["8edaeb40fc5e5069"],"x":615,"y":500,"wires":[]},{"id":"2dda8de3a565be05","type":"subflow:2f44a0de1e92d674","z":"4f899d35193d55b5","name":"","x":510,"y":500,"wires":[]},{"id":"38a8c1f4cf8476cf","type":"link out","z":"4f899d35193d55b5","name":"link out 35","mode":"link","links":["8edaeb40fc5e5069","3ab78227bbad6368"],"x":415,"y":880,"wires":[]},{"id":"2492f62d3fed618f","type":"subflow:2f44a0de1e92d674","z":"4f899d35193d55b5","name":"","x":670,"y":380,"wires":[]},{"id":"04653756ea87dd94","type":"subflow:73a2a4f8b5d2b7d9","z":"4f899d35193d55b5","name":"","x":280,"y":740,"wires":[]},{"id":"aee99cedbaabbcce","type":"function","z":"4f899d35193d55b5","name":"lights >","func":"msg.search = { \"is\": { entity_id: msg.linked_lights, state: [\"on\", \"off\"] } }\nmsg.output_name = \"linked_lights\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":740,"wires":[["38a142eb81b7bee5"]],"l":false},{"id":"38a142eb81b7bee5","type":"subflow:87a3c75768fca823","z":"4f899d35193d55b5","name":"","x":155,"y":740,"wires":[["04653756ea87dd94"]],"l":false},{"id":"bbadb21e26c2de71","type":"subflow:2f44a0de1e92d674","z":"4f899d35193d55b5","name":"","x":910,"y":320,"wires":[]},{"id":"53570f87c84df295","type":"function","z":"4f899d35193d55b5","name":"invitate left home ?","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\nlet at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state === \"on\"\nlet wait_no_motion = flow.get(\"wait_no_motion\") ?? false\n\nif (invitation && at_home && !in_home_zone) {\n    if (msg.security_intrusion && msg.state === \"on\") {\n        flow.set(\"wait_no_motion\", true)\n        return msg\n    } else if (msg.state === \"on\" && wait_no_motion) {\n        flow.set(\"wait_no_motion\", false)\n        return { reset: \"reset\" }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":940,"wires":[["2ba44f74a8b203e0"]]},{"id":"2ba44f74a8b203e0","type":"delay","z":"4f899d35193d55b5","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":735,"y":940,"wires":[["cfd936c3d15718d3"]],"l":false},{"id":"fd766939e575f2a8","type":"function","z":"4f899d35193d55b5","name":"invitate in home ?","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\nlet at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state === \"on\"\n\nif (invitation && !in_home_zone && !at_home && msg.state === \"on\") {\n    return { entity_id: \"input_boolean.at_home\", state: \"on\" }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":940,"wires":[["1231b2148263b0b8"]]},{"id":"1231b2148263b0b8","type":"subflow:2f44a0de1e92d674","z":"4f899d35193d55b5","name":"","x":370,"y":940,"wires":[]},{"id":"3ca019b4d995a284","type":"link in","z":"4f899d35193d55b5","name":"link in 10","links":["d734711c722649cb","278aa52a78449f78","1ab1d90ecd3bbd5f","3c786fa60d66144a"],"x":55,"y":740,"wires":[["aee99cedbaabbcce"]]},{"id":"d734711c722649cb","type":"link out","z":"4f899d35193d55b5","name":"link out 36","mode":"link","links":["3ca019b4d995a284"],"x":915,"y":380,"wires":[]},{"id":"278aa52a78449f78","type":"link out","z":"4f899d35193d55b5","name":"link out 37","mode":"link","links":["3ca019b4d995a284"],"x":1015,"y":320,"wires":[]},{"id":"22c9674c144bc29a","type":"function","z":"4f899d35193d55b5","name":"notification","func":"let msgs = []\n\nif (msg.payload == \"off\") {\n    msgs.push({ entity_id: \"alarm_control_panel.alarm\", state: \"disarmed\" })\n    return [null, msgs]\n} else {\n    return [{ notification_id: \"module_security_intrusion\", dismiss: true }, null]\n}\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":500,"wires":[["75c38959e03cda0f"],["2dda8de3a565be05"]]},{"id":"59c2348faed8b0f0","type":"subflow:2f44a0de1e92d674","z":"4f899d35193d55b5","name":"","x":590,"y":440,"wires":[]},{"id":"1ab1d90ecd3bbd5f","type":"link out","z":"4f899d35193d55b5","name":"link out 38","mode":"link","links":["3ca019b4d995a284"],"x":695,"y":440,"wires":[]},{"id":"a75829a2951eaee3","type":"function","z":"4f899d35193d55b5","name":"notification","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\nlet notifications = global.get(\"notifications\") ?? {}\n\nif (invitation && !in_home_zone) {\n    return [{\n        notification_id: \"invitation\",\n        title: \"Mode invit√©\",\n        alert_type: \"success\",\n        message: \"L'invit√© est entr√©\",\n        send_mobile: true\n    }]\n} else if (invitation && in_home_zone) {\n    return [{\n        notification_id: \"invitation\",\n        title: \"Mode invit√©\",\n        alert_type: \"success\",\n        message: \"Mode invit√© activ√©\",\n        send_mobile: true\n    }]\n} else if (notifications[\"invitation\"] !== undefined) {\n    return [{\n        notification_id: \"invitation\",\n        dismiss: true\n    }]\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":880,"wires":[["38a8c1f4cf8476cf"]]},{"id":"d8121e00415da85c","type":"function","z":"4f899d35193d55b5","name":"get windows - doors on >","func":"msg.search = { \"is\": { linked_class: [\"window\", \"motion\"], state: \"on\", security_intrusion: true } }\nmsg.output_name = \"still_open\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":1140,"wires":[["f9ba0819bea73f83"]]},{"id":"f9ba0819bea73f83","type":"subflow:87a3c75768fca823","z":"4f899d35193d55b5","name":"","x":475,"y":1140,"wires":[["3bb30cd0b2ec547b"]],"l":false},{"id":"3bb30cd0b2ec547b","type":"function","z":"4f899d35193d55b5","name":"notification","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet notifications = global.get(\"notifications\") ?? {}\nlet notification_id = \"still_open\"\nlet still_open = msg.still_open\n\nif (!in_home_zone && still_open.length > 0) {\n    let message = \"Rappel de vuln√©rabilit√©, \" + set_still_open_text(still_open)\n    return {\n        notification_id: notification_id,\n        title: \"üö® Rappel de vuln√©rabilit√© üö®\",\n        alert_type: \"warning\",\n        message: message,\n        speak: message,\n        send_mobile: true\n\n    }\n} else if (in_home_zone && notifications[notification_id] !== undefined) {\n    return {\n        notification_id: notification_id,\n        dismiss: true\n    }\n}\n\nfunction set_still_open_text(still_open) {\n    let alias = still_open.map(a => a.alias)\n    if (alias.length === 1) {\n        return capitalize_first_letter(\"la \" + alias[0] + \" est ouverte\")\n    } else {\n        let joined = alias.slice(0, -1).join(\", \") + \" et \" + alias[alias.length - 1]\n        return capitalize_first_letter(\"les \" + joined + \" sont ouvertes\")\n    }\n}\n\nfunction capitalize_first_letter(val) {\n    return String(val).charAt(0).toUpperCase() + String(val).slice(1);\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":1140,"wires":[["c8f3d7df018472fd"]]},{"id":"c8f3d7df018472fd","type":"link out","z":"4f899d35193d55b5","name":"link out 40","mode":"link","links":["8edaeb40fc5e5069"],"x":695,"y":1140,"wires":[]},{"id":"d6a2d6482b1b61f9","type":"comment","z":"4f899d35193d55b5","name":"Home breach","info":"","x":110,"y":1080,"wires":[]},{"id":"2c25e45eb96ffb44","type":"subflow:3dd3ba0d3b3a0ffd","z":"4f899d35193d55b5","name":"","x":820,"y":380,"wires":[]},{"id":"4f9d8afecc0aa36e","type":"server-state-changed","z":"4f899d35193d55b5","name":"alarm_control_panel","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"alarm_control_panel.alarm","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"event_data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"new_state","propertyType":"msg","value":"","valueType":"str"}],"x":130,"y":380,"wires":[["4b58c8405ffc51e6"]]},{"id":"b59501c0ab782e71","type":"server-state-changed","z":"4f899d35193d55b5","name":"alarm_control_panel","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"alarm_control_panel.alarm","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"alarm_control_panel","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":560,"wires":[["f7bc4a9ba5cac53c"]]},{"id":"ca3dbcb70af846a4","type":"subflow:2f44a0de1e92d674","z":"4f899d35193d55b5","name":"","x":450,"y":180,"wires":[]},{"id":"3ab78227bbad6368","type":"link in","z":"4f899d35193d55b5","name":"set nearest","links":["38a8c1f4cf8476cf","577e532fa4ced343","1905d4ac1b511d2d"],"x":55,"y":180,"wires":[["a6696150e02e590c"]]},{"id":"a6696150e02e590c","type":"function","z":"4f899d35193d55b5","name":"alarm_control_panel distances","func":"let distances = global.get(\"distances\") ?? {}\nlet min_distance = Math.min(...Object.keys(distances).map(a => distances[a]))\n\nif (min_distance !== Infinity) {\n    let invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\n    let alarm_control_panel = global.get(\"homeassistant\").homeAssistant.states[\"alarm_control_panel.alarm\"].state\n    let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\n    let in_home_zone = min_distance <= zone_home.radius\n    let msgs = []\n\n    msgs.push({ entity_id: \"input_boolean.in_home_zone\", state: in_home_zone ? \"on\" : \"off\" })\n    msgs.push({ entity_id: \"input_number.min_distance_from_home\", state: min_distance })\n\n    if (!invitation && alarm_control_panel === \"disarmed\" && !in_home_zone) {\n        msgs.push({ entity_id: \"alarm_control_panel.alarm\", state: \"armed_away\" })\n    } else if (alarm_control_panel === \"armed_away\" && in_home_zone) {\n        msgs.push({ entity_id: \"alarm_control_panel.alarm\", state: \"armed_home\" })\n    } else if ([\"triggered\", \"pending\"].includes(alarm_control_panel) && in_home_zone) {\n        msgs.push({ entity_id: \"alarm_control_panel.alarm\", state: \"disarmed\" })\n    }\n\n    return [msgs]\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":180,"wires":[["ca3dbcb70af846a4"]]},{"id":"4b58c8405ffc51e6","type":"api-current-state","z":"4f899d35193d55b5","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":350,"y":380,"wires":[["c013d31873e11ffb"],[]]},{"id":"c013d31873e11ffb","type":"function","z":"4f899d35193d55b5","name":"core","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet at_home = global.get('homeassistant').homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet home_configuration = global.get(\"home_configuration\") ?? {}\nlet linked_lights = home_configuration?.security?.linked_lights ?? []\nlet arming_time = (home_configuration?.security?.arming_time ?? 0) * 1000\nlet event_data = msg.event_data\n\nlet entities = []\nlet notifs = []\nlet lights = []\n\nif (event_data.new_state.state === \"arming\") {\n    lights.push({ linked_lights: linked_lights, effects: { count: 30, color: 30, saturation: 100, time: 1000 } })\n    notifs.push({ speak: \"La maison va entr√©e en mode surveillance; dans 30 secondes.\", volume_level: 0.58 })\n\n} else if (event_data.new_state.state === \"armed_away\") {\n    entities.push({ entity_id: \"input_boolean.at_home\", state: \"off\" })\n    entities.push({ entity_id: \"input_boolean.invitation\", state: \"off\" })\n\n} else if (event_data.new_state.state === \"disarmed\") {\n    if (event_data.old_state.state === \"arming\") {\n        lights.push({ linked_lights: linked_lights, effects: { count: 5, color: 120, saturation: 100, time: 1000 } })\n        notifs.push({ speak: \"Annulation du mode surveillance.\", volume_level: 0.58 })\n    } else if (event_data.old_state.state !== \"armed_night\") {\n        lights.push({ linked_lights: linked_lights, effects: { count: 5, color: 120, saturation: 100, time: 1000 } })\n        let distances = global.get(\"distances\") ?? {}\n        let persons = Object.keys(distances).filter(p => distances[p] === 0).map(p => global.get('homeassistant').homeAssistant.states[p].attributes.friendly_name)\n        let speak = (persons.length <= 1 ?\n            \"Heureux de vous revoir \" + (persons[0] ?? \"\") :\n            \"Bienvenue √† la maison \" + persons.join(\" et \")\n        ) + \". Surveillance d√©sactiv√©e.\"\n        notifs.push({ speak: speak, volume_level: 0.58 })\n        entities.push({ entity_id: \"input_boolean.at_home\", state: \"on\" })\n        entities.push({ entity_id: \"input_boolean.invitation\", state: in_home_zone ? \"off\" : \"on\" })\n    }\n}\n\nreturn [entities, lights, notifs]","outputs":3,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":380,"wires":[["2492f62d3fed618f"],["d734711c722649cb"],["1dce0f707a52041f"]]},{"id":"7fa0f7c7d2dd55a2","type":"server-state-changed","z":"4f899d35193d55b5","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_boolean.in_home_zone"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":1140,"wires":[["d8121e00415da85c"]]},{"id":"3d51a4d38769b1b5","type":"server-state-changed","z":"4f899d35193d55b5","name":"alarm_control_panel","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"alarm_control_panel.alarm","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"armed_home","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":130,"y":620,"wires":[["8f293f5c07d0a4ae"],[]]},{"id":"824e4c1b0d090dbf","type":"subflow:2f44a0de1e92d674","z":"4f899d35193d55b5","name":"","x":510,"y":620,"wires":[]},{"id":"8f293f5c07d0a4ae","type":"function","z":"4f899d35193d55b5","name":"from armed away ?","func":"if (msg.data.old_state.state !== \"armed_away\") {\n    return { entity_id: \"alarm_control_panel.alarm\", state: msg.data.old_state.state }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":620,"wires":[["824e4c1b0d090dbf"]]},{"id":"dd9b82879e2d666b","type":"server-state-changed","z":"4f899d35193d55b5","name":"in zone.home ?","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"zone.home","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"0","ifStateType":"num","ifStateOperator":"gt","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":1000,"wires":[["f91859976e5535c5"],[]]},{"id":"93bd2d880ceaca13","type":"api-current-state","z":"4f899d35193d55b5","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":330,"y":680,"wires":[["ab78884e511644d5"],[]]},{"id":"ab78884e511644d5","type":"function","z":"4f899d35193d55b5","name":"core","func":"let alarm = global.get('homeassistant').homeAssistant.states[\"alarm_control_panel.alarm\"].state\nlet home_configuration = global.get(\"home_configuration\") ?? {}\nlet linked_lights = home_configuration?.security?.linked_lights ?? []\n\nlet entities = []\nlet notifs = []\nlet lights = []\n\nif ([\"triggered\", \"pending\"].includes(alarm)) {\n    lights.push({ linked_lights: linked_lights, effects: { count: 5, color: 120, saturation: 100, time: 1000 } })\n    notifs.push({ speak: \"Mode surveillance d√©sactiv√©; bienvenue √† la maison.\", volume_level: 0.58 })\n    entities.push({ entity_id: \"input_boolean.at_home\", state: \"on\" })\n    entities.push({ entity_id: \"input_boolean.invitation\", state: \"off\" })\n}\n\nreturn [entities, lights, notifs]","outputs":3,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":680,"wires":[["bc9d8961295c6d55"],["3c786fa60d66144a"],["f54e6f1d9d9fbf83"]]},{"id":"a0f1f225a9949d81","type":"server-state-changed","z":"4f899d35193d55b5","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":680,"wires":[[],[]]},{"id":"bc9d8961295c6d55","type":"subflow:2f44a0de1e92d674","z":"4f899d35193d55b5","name":"","x":650,"y":680,"wires":[]},{"id":"3c786fa60d66144a","type":"link out","z":"4f899d35193d55b5","name":"link out 80","mode":"link","links":["3ca019b4d995a284"],"x":895,"y":680,"wires":[]},{"id":"99be64a67f242785","type":"subflow:3dd3ba0d3b3a0ffd","z":"4f899d35193d55b5","name":"","x":800,"y":680,"wires":[]},{"id":"29f1c94d15fef0c5","type":"link in","z":"d52fd5b6a729155c","name":"light on/off/last","links":["491ec626c9d6df24","5c0800c2187c3880","1ce929ac616df668"],"x":55,"y":180,"wires":[["a8b1b3543ba12286"]]},{"id":"ed891747ae72ce7a","type":"catch","z":"d52fd5b6a729155c","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["93eb91dfd5fa7d30"]]},{"id":"d52ef6fb79735cf3","type":"subflow:759003382b0f7bfd","z":"d52fd5b6a729155c","name":"","x":460,"y":40,"wires":[["c76da9c70d0ede49"]]},{"id":"93eb91dfd5fa7d30","type":"change","z":"d52fd5b6a729155c","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Lights","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["d52ef6fb79735cf3"]]},{"id":"1b2b75f6bfef0964","type":"link in","z":"d52fd5b6a729155c","name":"ambiance","links":["6d013fc518336c00"],"x":55,"y":820,"wires":[[]]},{"id":"29fe6a12e3c5e657","type":"function","z":"d52fd5b6a729155c","name":"restore lights","func":"let motion_areas = global.get(\"motion_areas\") ?? {}\nlet areas = [... new Set(msg.lights.filter(l => motion_areas[l.linked_area] !== undefined).map(a => a.linked_area))]\n\nif (msg.transition !== undefined) {\n    return [areas.map(a => ({ linked_area: a, state: motion_areas[a], transition: msg.transition }))]\n} else {\n    return [areas.map(a => ({ linked_area: a, state: motion_areas[a] }))]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":560,"wires":[["491ec626c9d6df24"]]},{"id":"491ec626c9d6df24","type":"link out","z":"d52fd5b6a729155c","name":"link out 373","mode":"link","links":["29f1c94d15fef0c5"],"x":475,"y":560,"wires":[]},{"id":"222c4f1e0871bee0","type":"link in","z":"d52fd5b6a729155c","name":"light restore","links":["6f640486cab5736a","b8ddcb09c43c340f","799a86a9f46c8d74","9e33fb2b0690abfd","f8b89d141b6b6194","8b6cd4c16e532bfe"],"x":55,"y":500,"wires":[["3af4c62b5c0b2c75"]]},{"id":"42ab88e352160166","type":"link out","z":"d52fd5b6a729155c","name":"link out 374","mode":"link","links":["db09871305e332e0"],"x":645,"y":300,"wires":[]},{"id":"8663b08c5e9cd805","type":"function","z":"d52fd5b6a729155c","name":"lights on","func":"let lights = msg.lights.filter(l => l.entity_id.includes(\"light.\"))\nreturn [lights.map(l => ({ payload: { data: { entity_id: l.entity_id, brightness_pct: 100, color_color_temp_kelvin: 4500 } } }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":1240,"wires":[["13e6268619055aa1"]]},{"id":"a8b1b3543ba12286","type":"function","z":"d52fd5b6a729155c","name":"area lights >","func":"let module_lights = global.get('homeassistant').homeAssistant.states[\"input_boolean.module_lights\"].state == \"on\"\n\nif (module_lights) {\n    msg.search = { \"is\": { linked_class: \"light\", linked_area: msg.linked_area, state: [\"on\", \"off\"] } }\n    msg.output_name = \"lights\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":180,"wires":[["e93a98019043086b"]]},{"id":"dc111b91a03742ee","type":"function","z":"d52fd5b6a729155c","name":"area covers >","func":"msg.search = { \"is\": { linked_class: \"cover\", linked_area: msg.linked_area, state: 0 } }\nmsg.output_name = \"covers\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":180,"wires":[["003139cf4fd1ce59"]]},{"id":"8ef8c70272f422f5","type":"function","z":"d52fd5b6a729155c","name":"lights >","func":"msg.search = { \"is\": { linked_class: \"light\", state: [\"on\", \"off\"] } }\nmsg.output_name = \"lights\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":1240,"wires":[["6b4f787f86bd19da"]]},{"id":"13e6268619055aa1","type":"api-call-service","z":"d52fd5b6a729155c","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":970,"y":1240,"wires":[[]]},{"id":"c85e2d58bf904752","type":"api-current-state","z":"d52fd5b6a729155c","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":490,"y":500,"wires":[["015b56ca9e22908c"],[]]},{"id":"f09b0a22ed683667","type":"api-current-state","z":"d52fd5b6a729155c","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":430,"y":680,"wires":[["d8342352d2e44302"],[]]},{"id":"469ed0157d79fca6","type":"server-state-changed","z":"d52fd5b6a729155c","name":"lights triggers","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_boolean.color_reverse","input_number.color_segment","input_number.color_rotate","input_number.low_light_compensation","input_boolean.low_light_compensation"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":570,"y":440,"wires":[["6f640486cab5736a"]]},{"id":"e93a98019043086b","type":"subflow:87a3c75768fca823","z":"d52fd5b6a729155c","name":"","x":275,"y":180,"wires":[["dc111b91a03742ee"]],"l":false},{"id":"003139cf4fd1ce59","type":"subflow:87a3c75768fca823","z":"d52fd5b6a729155c","name":"","x":555,"y":180,"wires":[["e9b7a51d8d4400a4"]],"l":false},{"id":"baf576db3bbb7153","type":"subflow:87a3c75768fca823","z":"d52fd5b6a729155c","name":"","x":255,"y":560,"wires":[["29fe6a12e3c5e657"]],"l":false},{"id":"6b4f787f86bd19da","type":"subflow:87a3c75768fca823","z":"d52fd5b6a729155c","name":"","x":715,"y":1240,"wires":[["8663b08c5e9cd805"]],"l":false},{"id":"ad957ee0af53388d","type":"server-state-changed","z":"d52fd5b6a729155c","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":250,"y":440,"wires":[["0f47524a710e9d97"]]},{"id":"e5fda16242b2186f","type":"subflow:2f44a0de1e92d674","z":"d52fd5b6a729155c","name":"","x":475,"y":440,"wires":[],"l":false},{"id":"0f47524a710e9d97","type":"function","z":"d52fd5b6a729155c","name":"sun calc","func":"let sun_light_angle_setting_rising = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_setting_rising\"].state)\nlet sun_light_angle_dusk_dawn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_dusk_dawn\"].state)\n\nlet old_elevation = msg.data.old_state.attributes.elevation\nlet new_elevation = msg.data.new_state.attributes.elevation\nlet rising = msg.data.new_state.attributes.rising\n\nlet d = new Date()\nlet local_time = d.getHours() + \":\" + d.getMinutes()\n\nif (rising) {\n    if (old_elevation < sun_light_angle_setting_rising && sun_light_angle_setting_rising < new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_rising\", state: local_time }, msg]\n    } else if (old_elevation < sun_light_angle_dusk_dawn && sun_light_angle_dusk_dawn < new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_dawn_angle\", state: local_time }, msg]\n    }\n} else {\n    if (old_elevation > sun_light_angle_setting_rising && sun_light_angle_setting_rising > new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_setting\", state: local_time }, msg]\n    } else if (old_elevation > sun_light_angle_dusk_dawn && sun_light_angle_dusk_dawn > new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_dusk\", state: local_time }, msg]\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":440,"wires":[["e5fda16242b2186f"],["8669a50831201699"]]},{"id":"6f640486cab5736a","type":"link out","z":"d52fd5b6a729155c","name":"link out 582","mode":"link","links":["222c4f1e0871bee0"],"x":835,"y":440,"wires":[]},{"id":"db09871305e332e0","type":"link in","z":"d52fd5b6a729155c","name":"link in 529","links":["42ab88e352160166"],"x":325,"y":180,"wires":[["dc111b91a03742ee"]]},{"id":"b00d72dd58983f20","type":"api-current-state","z":"d52fd5b6a729155c","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":330,"y":300,"wires":[["ebf4c64ffa7892b0"],[]]},{"id":"c9948014e1689d01","type":"comment","z":"d52fd5b6a729155c","name":"light core","info":"","x":100,"y":120,"wires":[]},{"id":"f300b96f804135d7","type":"comment","z":"d52fd5b6a729155c","name":"light triggers","info":"","x":110,"y":380,"wires":[]},{"id":"5d960a6f637f49d7","type":"comment","z":"d52fd5b6a729155c","name":"light update","info":"","x":110,"y":240,"wires":[]},{"id":"84e618bb107ec08b","type":"comment","z":"d52fd5b6a729155c","name":"ambiance control","info":"","x":120,"y":760,"wires":[]},{"id":"ebf4c64ffa7892b0","type":"function","z":"d52fd5b6a729155c","name":"lights >","func":"let motion_areas = global.get(\"motion_areas\") ?? {}\nlet active_areas = Object.keys(motion_areas).filter(a => (motion_areas[a] == \"on\" || motion_areas[a] == \"last\"))\nlet msgs = active_areas.map(a => ({\n    linked_area: a,\n    search: {\n        \"is\": {\n            linked_class: \"light\",\n            linked_area: a,\n            state: \"on\"\n        }\n    },\n    output_name: \"lights\",\n    output_empty_results: false,\n    state: motion_areas[a]\n}\n))\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":300,"wires":[["ab1f9a62e949edfc"]]},{"id":"ab1f9a62e949edfc","type":"subflow:87a3c75768fca823","z":"d52fd5b6a729155c","name":"","x":595,"y":300,"wires":[["42ab88e352160166"]],"l":false},{"id":"a343f5620e5b00c3","type":"function","z":"d52fd5b6a729155c","name":"set lights","func":"let light_control = global.get(\"light_control\") ?? {}\nlet lights = []\n\nfor (let key of Object.keys(light_control)) {\n    if (light_control[key].locked) {\n        light_control[key].action = \"auto\"\n        light_control[key].locked = false\n    }\n}\n\nfor (let light of msg.lights) {\n    if (light.state === \"on\") {\n        lights.push(light.entity_id)\n    }\n}\n\nglobal.set(\"light_control\", light_control)\nif (lights.length > 0) {\n    return { lights: lights }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":680,"wires":[["dfcc80ea590a647d"]]},{"id":"d8342352d2e44302","type":"function","z":"d52fd5b6a729155c","name":"lights >","func":"msg.search = { \"is\": { linked_class: \"light\", state: [\"on\", \"off\"] } }\nmsg.output_name = \"lights\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":680,"wires":[["afebad90241aa520"]]},{"id":"afebad90241aa520","type":"subflow:87a3c75768fca823","z":"d52fd5b6a729155c","name":"","x":695,"y":680,"wires":[["a343f5620e5b00c3"]],"l":false},{"id":"4d68a09b3e860bfd","type":"comment","z":"d52fd5b6a729155c","name":"turn lights off when not home","info":"","x":160,"y":620,"wires":[]},{"id":"84e0522bcd0f3d65","type":"api-current-state","z":"d52fd5b6a729155c","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":680,"wires":[[],["f09b0a22ed683667"]]},{"id":"dfcc80ea590a647d","type":"api-call-service","z":"d52fd5b6a729155c","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["{{lights}}"],"data":"{\"transition\":0}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":950,"y":680,"wires":[[]]},{"id":"e9b7a51d8d4400a4","type":"function","z":"d52fd5b6a729155c","name":"light calc","func":"// @ts-nocheck\nlet sun_light_angle_setting_rising = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_setting_rising\"].state)\nlet sun_light_angle_dusk_dawn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_dusk_dawn\"].state)\nlet sun_light_time_setting = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_setting\"].state)\nlet sun_light_time_rising = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_rising\"].state)\nlet sun_angle_day_time = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_day_time\"].state)\nlet at_home = global.get('homeassistant').homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet sun = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes\nlet light_control = global.get(\"light_control\") ?? {}\nlet min_low_light_brightness = 100\nlet commun_brightness = {}\nlet msgs = []\n\nlet low_light_brightness_pct = low_light_brightness_pct_calc()\nlet night_brightness_pct = night_brightness_pct_calc()\nlet light_time = night_brightness_pct[0]\nlet light_color = get_color(light_time)\n\nif (sun.elevation < sun_light_angle_setting_rising) {\n    commun_brightness[\"night_brightness_pct\"] = night_brightness_pct[1]\n}\n\nif (low_light_brightness_pct > 0) {\n    commun_brightness[\"low_light_brightness_pct\"] = low_light_brightness_pct\n}\n\nfor (let light of msg.lights) {\n    if (light.auto && !(light_control[light.entity_id].locked)) {\n        let state = (msg.state == \"last\" ? light.auto.last_light ? \"on\" : \"off\" : msg.state) == \"on\"\n        state = state && at_home\n        if (state || state != (light.state == \"on\")) {\n            let light_brightness = {}\n            if (light.auto.day_light) {\n                light_brightness[\"day_brightness_pct\"] = day_brightness_pct_calc(light)\n            } else if (msg.covers.length != 0 && sun.elevation > sun_angle_day_time) {\n                light_brightness[\"cover_brightness_pct\"] = light.parameters.bright_range[1]\n            }\n            let brightnesss = { ...commun_brightness, ...light_brightness }\n            let brightnessKeys = Object.keys(brightnesss)\n            if (brightnessKeys.includes(\"night_brightness_pct\")) {\n                let brightness_pct_list = [brightnesss[\"night_brightness_pct\"](light)]\n                if (brightnessKeys.includes(\"day_brightness_pct\")) {\n                    brightness_pct_list.push(brightnesss[\"day_brightness_pct\"])\n                } else if (brightnessKeys.includes(\"low_light_brightness_pct\")) {\n                    brightness_pct_list.push(brightnesss[\"low_light_brightness_pct\"])\n                }\n                let brightness_pct = brightness_pct_list.reduce((ps, a) => ps + a, 0)\n                brightness_pct = brightness_pct > light.parameters.bright_range[1] ? light.parameters.bright_range[1] : brightness_pct\n                light_action(state, brightness_pct, light)\n            } else {\n                if (brightnessKeys.includes(\"day_brightness_pct\")) {\n                    light_action(state, brightnesss[\"day_brightness_pct\"], light)\n                } else if (brightnessKeys.includes(\"cover_brightness_pct\")) {\n                    light_action(state, brightnesss[\"cover_brightness_pct\"], light)\n                } else if (brightnessKeys.includes(\"low_light_brightness_pct\")) {\n                    let brightness_pct = brightnesss[\"low_light_brightness_pct\"] * light.parameters.bright_range[1] / 100\n                    light_action(state, brightness_pct, light)\n                } else if (light.state == \"on\") {\n                    light_action(false, 0, light)\n                }\n            }\n        }\n    }\n}\nreturn [msgs]\n\nfunction night_brightness_pct_calc() {\n    let sun_light_time_dusk = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dusk\"].state)\n    let sun_light_time_midnight = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_midnight\"].state)\n    let sun_light_time_dawn = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn\"].state)\n    let sun_light_time_dawn_angle = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn_angle\"].state)\n    let current_time = in_minutes(new Date().toString().slice(16, 21))\n\n    // Pivot\n    sun_light_time_rising = sun_light_time_rising + 1440 - sun_light_time_setting\n    sun_light_time_dawn_angle = sun_light_time_dawn_angle + 1440 - sun_light_time_setting\n    sun_light_time_dawn = sun_light_time_dawn + 1440 - sun_light_time_setting\n    sun_light_time_midnight = sun_light_time_dusk < sun_light_time_midnight ? sun_light_time_midnight - sun_light_time_setting : sun_light_time_midnight + 1440 - sun_light_time_setting\n    sun_light_time_dusk = sun_light_time_dusk - sun_light_time_setting\n    current_time = sun_light_time_setting <= current_time ? current_time - sun_light_time_setting : 1440 - sun_light_time_setting + current_time\n    sun_light_time_setting = 0\n\n    // Choix de l'heure de l'aube la plus petite \n    sun_light_time_dawn = sun_light_time_dawn < sun_light_time_dawn_angle ? sun_light_time_dawn : sun_light_time_dawn_angle\n\n    if (sun_light_time_setting <= current_time && current_time < sun_light_time_dusk) {\n        return [pct_calc(sun_light_time_setting, sun_light_time_midnight, current_time, false),\n        function (light) { return brightness_formula_calc(pct_calc(sun_light_time_setting, sun_light_time_dusk, current_time, false), light) }]\n    } else if (sun_light_time_dusk <= current_time && current_time < sun_light_time_midnight - 60) {\n        return [pct_calc(sun_light_time_setting, sun_light_time_midnight, current_time, false),\n        function (light) { return light.parameters.bright_range[1] }]\n    } else if (sun_light_time_midnight - 60 <= current_time && current_time < sun_light_time_midnight) {\n        return [pct_calc(sun_light_time_setting, sun_light_time_midnight, current_time, false),\n        function (light) { return brightness_formula_calc(pct_calc(sun_light_time_midnight - 60, sun_light_time_midnight, current_time, true), light) }]\n    } else if (sun_light_time_midnight <= current_time && current_time < sun_light_time_dawn - 60) {\n        return [100, function (light) { return light.auto.night_light ? light.parameters.bright_range[0] : 0 }]\n    } else if (sun_light_time_dawn - 60 <= current_time && current_time < sun_light_time_dawn) {\n        return [pct_calc(sun_light_time_dawn - 60, sun_light_time_rising, current_time, true),\n        function (light) { return brightness_formula_calc(pct_calc(sun_light_time_dawn - 60, sun_light_time_dawn, current_time, true), light) }]\n    } else if (sun_light_time_dawn <= current_time && current_time < (sun_light_time_dawn + sun_light_time_rising) / 2) {\n        return [pct_calc(sun_light_time_dawn - 60, sun_light_time_rising, current_time, true),\n        function (light) { return light.parameters.bright_range[1] }]\n    } else if ((sun_light_time_dawn + sun_light_time_rising) / 2 <= current_time && current_time < sun_light_time_rising) {\n        return [pct_calc(sun_light_time_dawn - 60, sun_light_time_rising, current_time, true),\n        function (light) { return brightness_formula_calc(pct_calc((sun_light_time_dawn + sun_light_time_rising) / 2, sun_light_time_rising, current_time, true), light) }]\n    } else {\n        return [0, function (light) { return light.parameters.bright_range[0] }]\n    }\n}\n\nfunction low_light_brightness_pct_calc() {\n    let low_light_compensation = global.get('homeassistant').homeAssistant.states[\"input_boolean.low_light_compensation\"].state == \"on\"\n    if (low_light_compensation) {\n        let low_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.low_light_compensation\"].state)\n        let illuminances = global.get(\"illuminances\") ?? {}\n        let up_to_date = illuminances[\"exterior\"]?.last_changed && (new Date().getTime() - illuminances[\"exterior\"].last_changed) / 1000 < 60 * 60 * 24\n        if (up_to_date && illuminances[\"exterior\"]?.[\"value\"] && illuminances[\"exterior\"][\"value\"] < low_light && sun.elevation > sun_light_angle_setting_rising) {\n            return pct_calc(min_low_light_brightness, low_light, illuminances[\"exterior\"][\"value\"], true)\n        } else if (up_to_date && illuminances[\"exterior\"]?.[\"value\"] && illuminances[\"exterior\"][\"value\"] < low_light && sun.elevation > sun_light_angle_dusk_dawn) {\n            return pct_calc(min_low_light_brightness, low_light, illuminances[\"exterior\"][\"value\"], true) * pct_calc(sun_light_angle_dusk_dawn, sun_light_angle_setting_rising, sun.elevation, false) / 100\n        }\n    }\n    return 0\n}\n\nfunction day_brightness_pct_calc(light) {\n    if (sun.elevation > sun_light_angle_setting_rising) {\n        return light.parameters.bright_range[1]\n    } else if (sun.elevation > sun_light_angle_dusk_dawn) {\n        return light.parameters.bright_range[1] * pct_calc(sun_light_angle_dusk_dawn, sun_light_angle_setting_rising, sun.elevation, false) / 100\n    } else {\n        return 0\n    }\n}\n\nfunction brightness_formula_calc(brightness_pct, light) {\n    brightness_pct = Math.cos((9 * brightness_pct / 10 - 90) * Math.PI / 180)\n    return light.parameters.bright_range[0] + (light.parameters.bright_range[1] - light.parameters.bright_range[0]) * brightness_pct\n}\n\nfunction pct_calc(min, max, nb, reverse) {\n    return nb < min ? (reverse ? 100 : 0) : nb > max ? (reverse ? 0 : 100) : reverse ? (max - nb) / Math.abs(min - max) * 100 : (nb - min) / Math.abs(min - max) * 100\n}\n\nfunction in_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\")\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1])\n}\n\nfunction light_action(state, brightness_pct, light) {\n    let lp = light.parameters\n    let transition = msg.transition !== undefined ? msg.transition : lp.transition_range[state ? 0 : 1]\n    if ((light.attributes.supported_color_modes ?? []).find(s => [\"hs\", \"rgb\", \"xy\", \"color_temp\"].includes(s))) {\n        if (state) {\n            let type = lp.color == \"on\" ? \"hs_color\" : \"color_temp_kelvin\"\n            let value = lp.color == \"on\" ? [light_color, lp.hs_saturation] : (lp.kelvin_range[1] - lp.kelvin_range[0]) * (100 - light_time) / 100 + lp.kelvin_range[0]\n            msgs.push({\n                domain: \"light\", service: \"turn_on\",\n                payload: { data: { entity_id: light.entity_id, transition: transition, brightness_pct: brightness_pct, [type]: value } }\n            })\n        } else {\n            if (light.attributes.flowing !== undefined) {\n                let transitions = []\n                if (lp.color !== \"off\") {\n                    transitions.push({ \"HSVTransition\": [light_color, lp.hs_saturation, transition * 1000, lp.bright_range[0]] })\n                } else {\n                    let color_temp_kelvin = light_time * (light.parameters.kelvin_range[1] - light.parameters.kelvin_range[0]) / 100 + light.parameters.kelvin_range[0]\n                    transitions.push({ \"TemperatureTransition\": [color_temp_kelvin, transition * 1000, lp.bright_range[0]] })\n                }\n                msgs.push({ domain: \"yeelight\", service: \"start_flow\", payload: { data: { entity_id: light.entity_id, action: \"off\", count: 1, transitions: transitions } } })\n            } else {\n                msgs.push({ domain: \"light\", service: \"turn_off\", payload: { data: { entity_id: light.entity_id, transition: transition } } })\n            }\n        }\n    }\n}\n\nfunction get_color(light_time) {\n    let color_rotate = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_rotate\"].state)\n    let color_segment = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_segment\"].state)\n    let color_reverse = global.get('homeassistant').homeAssistant.states[\"input_boolean.color_reverse\"].state == \"on\"\n    let color = (((360 * (color_segment * light_time / (360 * 100)) + color_rotate) % 360))\n    return color_reverse ? 360 - color : color\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":180,"wires":[["92d12d4089734155"]]},{"id":"92d12d4089734155","type":"api-call-service","z":"d52fd5b6a729155c","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":810,"y":180,"wires":[[]]},{"id":"c76da9c70d0ede49","type":"link out","z":"d52fd5b6a729155c","name":"link out 631","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"b8ac8f7952d8c752","type":"link in","z":"d52fd5b6a729155c","name":"link in 572","links":["68f8f65865e43fb3"],"x":55,"y":300,"wires":[["863c645d90edbf6d"]]},{"id":"c97b84b9ebfc0f74","type":"server-state-changed","z":"d52fd5b6a729155c","name":"midnight time","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_datetime.sun_light_time_midnight","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":440,"wires":[["6f640486cab5736a"]]},{"id":"e45d9c29524ee4bf","type":"function","z":"d52fd5b6a729155c","name":"notification","func":"msg.notification_id = \"module_light\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Lumi√®res d√©sactiv√©\"\n    msg.message = \"Module Lumi√®res d√©sactiv√©, les lumi√®res sont allum√©es\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":1240,"wires":[["1858b90a9dc619e6"]]},{"id":"1858b90a9dc619e6","type":"link out","z":"d52fd5b6a729155c","name":"link out 651","mode":"link","links":["8edaeb40fc5e5069"],"x":375,"y":1240,"wires":[]},{"id":"c52e3b3716fa2793","type":"server-state-changed","z":"d52fd5b6a729155c","name":"module_lights","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_lights","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":730,"y":440,"wires":[["6f640486cab5736a"],[]]},{"id":"3af4c62b5c0b2c75","type":"subflow:f884e97a0daa4ce2","z":"d52fd5b6a729155c","name":"","x":160,"y":500,"wires":[["275178840749fbef"],[]]},{"id":"a55133cd4f28e3c3","type":"subflow:f884e97a0daa4ce2","z":"d52fd5b6a729155c","name":"","x":480,"y":1240,"wires":[["8ef8c70272f422f5"],[]]},{"id":"5dd2f802f677c7da","type":"comment","z":"d52fd5b6a729155c","name":"on/off module_light","info":"","x":130,"y":1180,"wires":[]},{"id":"bb5a612adb835ce3","type":"function","z":"d52fd5b6a729155c","name":"check ambiance","func":"let at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (\n    at_home &&\n    msg.attributes.options.includes(msg.new_state) &&\n    msg.linked_lights && Array.isArray(msg.linked_lights) &&\n    msg.linked_lights.length > 0 &&\n    typeof msg.ambiance_volume_level === \"number\" &&\n    typeof msg.linked_speaker === \"string\" &&\n    typeof msg.linked_area === \"string\"\n) {\n    let support_color = []\n    let not_support_color = []\n    for (let l of msg.linked_lights) {\n        let light = global.get(\"homeassistant\").homeAssistant.states[l]\n        if ([\"on\", \"off\"].includes(light.state)) {\n            if (light.attributes.supported_color_modes.find(c => [\"xy\", \"hs\", \"rgb\"].includes(c))) {\n                support_color.push(l)\n            } else {\n                not_support_color.push(l)\n            }\n        }\n    }\n    if (support_color.length > 0) {\n        msg = { ...msg, light_support_color: support_color, ambiance_config: home_configuration.ambiance_config }\n        let light_control = global.get(\"light_control\") ?? {}\n        for (let l of msg.linked_lights) {\n            if (light_control[l]) {\n                light_control[l].locked = msg.state !== \"Arret\"\n            }\n        }\n        global.set(\"light_control\", light_control)\n        delete msg.linked_lights\n        return [msg, { payload: { data: { entity_id: not_support_color }, service: \"turn_off\" } }]\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":820,"wires":[["fa1e848a111d1619"],["0b13f58e3e6998d7"]]},{"id":"11e915e666b244fc","type":"function","z":"d52fd5b6a729155c","name":"msg speaker","func":"if (msg.state && msg.ambiance_config.ambiances_type[msg.state]?.ambiance && msg.linked_speaker) {\n    let speaker = global.get(\"home_configuration\")[msg.linked_speaker]\n    if (speaker && msg.ambiance_config?.path?.start !== \"\" && msg.ambiance_config?.path?.end !== \"\") {\n        if (msg.state == \"Arret\") {\n            let sound = \"ambiance_stop.mp3\"\n            msg = {\n                linked_area: msg.linked_area,\n                volume_level: get_speaker_volume(),\n                sound: sound\n            }\n        } else {\n            msg = {\n                linked_area: msg.linked_area,\n                volume_level: msg.ambiance_volume_level ?? 0.5,\n                link: msg.ambiance_config.path.start + msg.ambiance_config.ambiances_type[msg.state].ambiance + msg.ambiance_config.path.end\n            }\n        }\n        return msg\n    }\n}\n\nfunction get_speaker_volume() {\n    let speaker_day_mode_start = global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_day_mode_start\"].state\n    let speaker_night_mode_start = global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_night_mode_start\"].state\n\n    let d = new Date()\n    let hours = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\n    let minutes = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n    let local_time = hours + \":\" + minutes + \":00\"\n\n    let entity_id = \"\"\n    if (speaker_day_mode_start < local_time && local_time < speaker_night_mode_start) {\n        entity_id = \"input_number.speaker_day_mode_volume\"\n    } else {\n        entity_id = \"input_number.speaker_night_mode_volume\"\n    }\n    return parseFloat(global.get(\"homeassistant\").homeAssistant.states[entity_id].state ?? 50) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":820,"wires":[["3070c3ecf0b9204a"]]},{"id":"3070c3ecf0b9204a","type":"subflow:3dd3ba0d3b3a0ffd","z":"d52fd5b6a729155c","name":"","x":780,"y":820,"wires":[]},{"id":"d7748a59b286ed90","type":"function","z":"d52fd5b6a729155c","name":"set ambiance","func":"if (msg.light_support_color.length > 0) {\n    let msgs = []\n    msgs.push({ reset: \"\" })\n    if (msg.state !== \"Arret\") {\n        delete msg.linked_lights\n        for (let l of msg.light_support_color) {\n            let ambiance_type = msg.ambiance_config.ambiances_type[msg.state]\n            let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360)\n            let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100)\n            let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100)\n            let delay = 1000\n            msgs.push({\n                light_support_color: msg.light_support_color,\n                expiration: new Date().getTime() + 1000 * 60 * 30,\n                linked_ambiance: msg.entity_id,\n                entity_id: l,\n                action_type: msg.state,\n                ambiance_config: msg.ambiance_config,\n                delay: delay,\n                service: \"turn_on\",\n                payload: {\n                    data: {\n                        entity_id: l,\n                        hs_color: [hs, saturation],\n                        brightness_pct: brightness,\n                        transition: Math.round(delay / 100) / 10\n                    }\n                }\n            })\n        }\n        return [msgs, null]\n    } else {\n        return [msgs, { light_support_color: msg.light_support_color, entity_id: msg.entity_id, state: \"Arret\" }]\n    }\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance)\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance)\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":820,"wires":[["d8629c020f6ef716"],["71f63dc8a92e16f8"]]},{"id":"0aa44a474c5d71d5","type":"delay","z":"d52fd5b6a729155c","name":"timer","pauseType":"delayv","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":150,"y":880,"wires":[["7b93522a20a401e0"]]},{"id":"e06a05184802881e","type":"api-call-service","z":"d52fd5b6a729155c","name":"control lights","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":610,"y":880,"wires":[[]]},{"id":"7b93522a20a401e0","type":"function","z":"d52fd5b6a729155c","name":"prepare light","func":"if (new Date().getTime() < msg.expiration) {\n\n    let ambiance_type = msg.ambiance_config.ambiances_type[msg.action_type]\n    let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360)\n    let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100)\n    let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100)\n    let delay = 1000 + Math.round(Math.random() * 14000)\n\n    msg.delay = delay\n    msg.service = \"turn_on\"\n    if (msg.action_type == \"Orage\" && delay < 1500) {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                effect: \"Strobe epilepsy!\"\n            }\n        }\n    } else {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                hs_color: [hs, saturation],\n                brightness_pct: brightness,\n                transition: Math.round(delay / 100) / 10\n            }\n        }\n    }\n    return [msg, null]\n} else {\n    return [null, { light_support_color: msg.light_support_color, entity_id: msg.linked_ambiance, state: \"Arret\", reset: \"\" }]\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance)\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance)\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":880,"wires":[["48ca76e1781074a9"],["48ca76e1781074a9","fe50aded4cd3beee"]]},{"id":"48ca76e1781074a9","type":"link out","z":"d52fd5b6a729155c","name":"link out 669","mode":"link","links":["31128b21a793b3d1","ef24d595efe42afa"],"x":405,"y":880,"wires":[]},{"id":"31128b21a793b3d1","type":"link in","z":"d52fd5b6a729155c","name":"link in 589","links":["48ca76e1781074a9","d8629c020f6ef716"],"x":55,"y":880,"wires":[["0aa44a474c5d71d5"]]},{"id":"79256e6da87834e0","type":"server-state-changed","z":"d52fd5b6a729155c","name":"module_lights","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_lights","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":1240,"wires":[["e45d9c29524ee4bf"],["e45d9c29524ee4bf","c648843db607c708"]]},{"id":"f562580590d04f2a","type":"server-events","z":"d52fd5b6a729155c","name":"restore_lights","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"restore_lights","eventData":"","waitForRunning":true,"outputProperties":[{"property":"transition","propertyType":"msg","value":"$outputData(\"eventData\").event.transition","valueType":"jsonata"}],"x":310,"y":500,"wires":[["c85e2d58bf904752"]]},{"id":"74405186bee91f47","type":"server-state-changed","z":"d52fd5b6a729155c","name":"at_home","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.at_home","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":100,"y":680,"wires":[[],["84e0522bcd0f3d65"]]},{"id":"863c645d90edbf6d","type":"subflow:f884e97a0daa4ce2","z":"d52fd5b6a729155c","name":"","x":160,"y":300,"wires":[["b00d72dd58983f20"],[]]},{"id":"015b56ca9e22908c","type":"link out","z":"d52fd5b6a729155c","name":"link out 18","mode":"link","links":["40b47cfc4f67db42"],"x":615,"y":500,"wires":[]},{"id":"40b47cfc4f67db42","type":"link in","z":"d52fd5b6a729155c","name":"link in 8","links":["015b56ca9e22908c"],"x":55,"y":560,"wires":[["a7704985ed58d110"]]},{"id":"ef24d595efe42afa","type":"link in","z":"d52fd5b6a729155c","name":"link in 590","links":["48ca76e1781074a9","d8629c020f6ef716","0b13f58e3e6998d7"],"x":445,"y":880,"wires":[["047c04e622ab6f58"]]},{"id":"d8629c020f6ef716","type":"link out","z":"d52fd5b6a729155c","name":"link out 57","mode":"link","links":["31128b21a793b3d1","ef24d595efe42afa"],"x":525,"y":820,"wires":[]},{"id":"047c04e622ab6f58","type":"switch","z":"d52fd5b6a729155c","name":"reset ?","property":"reset","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":495,"y":880,"wires":[["e06a05184802881e"]],"l":false},{"id":"95fb20f10f350956","type":"subflow:2f44a0de1e92d674","z":"d52fd5b6a729155c","name":"","x":330,"y":940,"wires":[]},{"id":"ccf5c8ab43584d5e","type":"function","z":"d52fd5b6a729155c","name":"unlock lights","func":"let state = global.get(\"homeassistant\").homeAssistant.states[msg.entity_id].state\n\n\nlet light_control = global.get(\"light_control\") ?? {}\nfor (let l of msg.light_support_color) {\n    light_control[l].locked = false\n}\n\nglobal.set(\"light_control\", light_control)\nmsg.transition = 5\nreturn msg\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":940,"wires":[["95fb20f10f350956","f8b89d141b6b6194"]]},{"id":"f8b89d141b6b6194","type":"link out","z":"d52fd5b6a729155c","name":"link out 58","mode":"link","links":["222c4f1e0871bee0"],"x":435,"y":940,"wires":[]},{"id":"0687e19832074c02","type":"link in","z":"d52fd5b6a729155c","name":"link in 25","links":["71f63dc8a92e16f8","fe50aded4cd3beee"],"x":55,"y":940,"wires":[["ccf5c8ab43584d5e"]]},{"id":"71f63dc8a92e16f8","type":"link out","z":"d52fd5b6a729155c","name":"link out 59","mode":"link","links":["0687e19832074c02"],"x":525,"y":820,"wires":[]},{"id":"fe50aded4cd3beee","type":"link out","z":"d52fd5b6a729155c","name":"link out 73","mode":"link","links":["0687e19832074c02"],"x":405,"y":880,"wires":[]},{"id":"a7704985ed58d110","type":"function","z":"d52fd5b6a729155c","name":"lights >","func":"let light_control = global.get(\"light_control\") ?? {}\n\nmsg.search = { \"is\": { linked_class: \"light\", state: [\"on\", \"off\"] } }\nmsg.output_name = \"lights\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":560,"wires":[["baf576db3bbb7153"]]},{"id":"0b13f58e3e6998d7","type":"link out","z":"d52fd5b6a729155c","name":"link out 8","mode":"link","links":["ef24d595efe42afa"],"x":295,"y":820,"wires":[]},{"id":"d77370156c6b0112","type":"api-call-service","z":"d52fd5b6a729155c","name":"control lights","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":550,"y":1100,"wires":[[]]},{"id":"8b6cd4c16e532bfe","type":"link out","z":"d52fd5b6a729155c","name":"link out 11","mode":"link","links":["222c4f1e0871bee0"],"x":395,"y":1040,"wires":[]},{"id":"db7766aa306c4476","type":"link in","z":"d52fd5b6a729155c","name":"ambiance","links":["6d013fc518336c00"],"x":55,"y":1040,"wires":[["d9259ef40d5bd4c3"]]},{"id":"c944816ab31ba9a5","type":"subflow:2f44a0de1e92d674","z":"d52fd5b6a729155c","name":"","x":630,"y":1040,"wires":[]},{"id":"d9259ef40d5bd4c3","type":"function","z":"d52fd5b6a729155c","name":"check ambiance","func":"let at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (\n    at_home &&\n    msg.attributes.options.includes(msg.state) &&\n    msg.linked_lights && Array.isArray(msg.linked_lights) &&\n    msg.linked_lights.length > 0 &&\n    typeof msg.ambiance_volume_level === \"number\" &&\n    typeof msg.linked_speaker === \"string\" &&\n    typeof msg.linked_area === \"string\"\n) {\n    let support_color = []\n    let not_support_color = []\n    for (let l of msg.linked_lights) {\n        let light = global.get(\"homeassistant\").homeAssistant.states[l]\n        if ([\"on\", \"off\"].includes(light.state)) {\n            if (light.attributes.supported_color_modes.find(c => [\"xy\", \"hs\", \"rgb\"].includes(c))) {\n                support_color.push(l)\n            } else {\n                not_support_color.push(l)\n            }\n        }\n    }\n    if (support_color.length > 0) {\n\n        let light_control = global.get(\"light_control\") ?? {}\n        for (let l of msg.linked_lights) {\n            if (light_control[l]) {\n                light_control[l].locked = msg.state !== \"Arret\"\n            }\n        }\n        global.set(\"light_control\", light_control)\n\n        return [\n            msg.state === \"Arret\" ?\n                { reset: \"stop\", transition: 5 } :\n                [{ reset: \"change\" }, { init: true, support_color: support_color, ambiance_type: home_configuration.ambiance_config.ambiances_type[msg.state] }],\n            [{ reset: \"\" }, msg.state != \"Arret\" ? { delay: 1000 * 60 * 30, entity_id: msg.entity_id, state: \"Arret\" } : null],\n            not_support_color.length > 0 ? { payload: { data: { entity_id: not_support_color }, service: \"turn_off\" } } : null\n        ]\n    }\n}","outputs":3,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":1040,"wires":[["bf28ba76e821fdc7","b5dd0a30e2a0ceb7"],["d008351103fe9375"],["52213a5995a4b4c0"]]},{"id":"f7a72e32b9d8bb50","type":"function","z":"d52fd5b6a729155c","name":"prepare light","func":"if (msg.init) {\n    delete msg.init\n    let msgs = []\n    for (let l of msg.support_color) {\n        let ambiance_type = msg.ambiance_type\n        let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360)\n        let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100)\n        let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100)\n        msgs.push({\n            ambiance_type: msg.ambiance_type,\n            service: \"turn_on\",\n            entity_id: l,\n            delay: 1000,\n            payload: {\n                data: {\n                    entity_id: l,\n                    hs_color: [hs, saturation],\n                    brightness_pct: brightness,\n                    transition: 1\n                }\n            }\n        })\n    }\n    return [msgs]\n} else {\n    let ambiance_type = msg.ambiance_type\n    let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360)\n    let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100)\n    let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100)\n    let delay = 1000 + Math.round(Math.random() * 14000)\n\n    msg.delay = delay\n    msg.service = \"turn_on\"\n\n    if (msg.action_type == \"Orage\" && delay < 1500) {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                effect: \"Strobe epilepsy!\"\n            }\n        }\n    } else {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                hs_color: [hs, saturation],\n                brightness_pct: brightness,\n                transition: Math.round(delay / 100) / 10\n            }\n        }\n    }\n    return msg\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance)\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":1100,"wires":[["a541624d543efe90"]]},{"id":"a38704ab4971549e","type":"delay","z":"d52fd5b6a729155c","name":"timer","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":150,"y":1100,"wires":[["f7a72e32b9d8bb50"]]},{"id":"d008351103fe9375","type":"delay","z":"d52fd5b6a729155c","name":"timer","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":490,"y":1040,"wires":[["c944816ab31ba9a5"]]},{"id":"4eae095e57e3326b","type":"switch","z":"d52fd5b6a729155c","name":"reset ?","property":"reset","propertyType":"msg","rules":[{"t":"eq","v":"stop","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":345,"y":1040,"wires":[["8b6cd4c16e532bfe"]],"l":false},{"id":"bf28ba76e821fdc7","type":"link out","z":"d52fd5b6a729155c","name":"link out 74","mode":"link","links":["adfef1778060430d"],"x":295,"y":1040,"wires":[]},{"id":"adfef1778060430d","type":"link in","z":"d52fd5b6a729155c","name":"link in 17","links":["bf28ba76e821fdc7","a541624d543efe90"],"x":55,"y":1100,"wires":[["a38704ab4971549e"]]},{"id":"a541624d543efe90","type":"link out","z":"d52fd5b6a729155c","name":"link out 78","mode":"link","links":["adfef1778060430d","1270d91445432c17"],"x":395,"y":1100,"wires":[]},{"id":"52213a5995a4b4c0","type":"link out","z":"d52fd5b6a729155c","name":"link out 79","mode":"link","links":["1270d91445432c17"],"x":295,"y":1040,"wires":[]},{"id":"1270d91445432c17","type":"link in","z":"d52fd5b6a729155c","name":"link in 26","links":["52213a5995a4b4c0","a541624d543efe90"],"x":445,"y":1100,"wires":[["d77370156c6b0112"]]},{"id":"8979eef57ce6a977","type":"catch","z":"6b59b3ce4612b9de","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["12af351d5c23a6c2"]]},{"id":"65bbd29c53424f44","type":"subflow:759003382b0f7bfd","z":"6b59b3ce4612b9de","name":"","x":460,"y":40,"wires":[["22318be840827f7b"]]},{"id":"12af351d5c23a6c2","type":"change","z":"6b59b3ce4612b9de","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Climate","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["65bbd29c53424f44"]]},{"id":"7f08a582a223691c","type":"link out","z":"6b59b3ce4612b9de","name":"link out 491","mode":"link","links":["e97deb8ede0b3b78"],"x":725,"y":180,"wires":[]},{"id":"2358a0da35fca4f2","type":"function","z":"6b59b3ce4612b9de","name":"windows >","func":"msg.search = { \"is\": { linked_class: \"window\", state: [\"on\", \"off\"] } }\n\nif (msg.linked_area) {\n    msg.search.is = { ...msg.search.is, linked_area: msg.linked_area }\n}\n\nmsg.output_name = \"windows\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":180,"wires":[["d93fc1a2580133bc"]]},{"id":"0036fa563d159202","type":"function","z":"6b59b3ce4612b9de","name":"notification","func":"let notification_id = \"module_temp_hum\"\n\nif (msg.payload == \"off\") {\n    return {\n        notification_id: notification_id,\n        alert_type: \"info\",\n        title: \"Module Alertes temp√©rature d√©sactiv√©\",\n        message: \"Module Alertes temp√©rature d√©sactiv√©, vous ne recevrez plus d'alerte de recommandations\",\n        send_mobile: true\n    }\n} else {\n    return { notification_id: notification_id, dismiss: true }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":640,"wires":[["0f4c525cf8c33c43"]]},{"id":"0f4c525cf8c33c43","type":"link out","z":"6b59b3ce4612b9de","name":"link out 517","mode":"link","links":["8edaeb40fc5e5069"],"x":415,"y":640,"wires":[]},{"id":"aa92a050e856fbfc","type":"api-current-state","z":"6b59b3ce4612b9de","name":"module_temp_hum on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temp_hum","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":465,"y":180,"wires":[["2358a0da35fca4f2"],[]],"l":false},{"id":"a994de5290def917","type":"server-state-changed","z":"6b59b3ce4612b9de","name":"module_temp_hum","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_temp_hum","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":640,"wires":[["0036fa563d159202"]]},{"id":"a56f66e34fba91bd","type":"comment","z":"6b59b3ce4612b9de","name":"zones recommendations","info":"","x":150,"y":120,"wires":[]},{"id":"cec6a7e6572d7bad","type":"comment","z":"6b59b3ce4612b9de","name":"on/off module_temp_hum","info":"","x":150,"y":580,"wires":[]},{"id":"f85d2dbad2735784","type":"inject","z":"6b59b3ce4612b9de","name":"15 min","props":[],"repeat":"","crontab":"*/15 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":180,"y":180,"wires":[["aa92a050e856fbfc"]]},{"id":"d93fc1a2580133bc","type":"subflow:87a3c75768fca823","z":"6b59b3ce4612b9de","name":"","x":675,"y":180,"wires":[["7f08a582a223691c"]],"l":false},{"id":"6145aea0d0920aa7","type":"link in","z":"6b59b3ce4612b9de","name":"zones recommendations","links":["43b78688a296e686"],"x":55,"y":180,"wires":[["aa92a050e856fbfc"]]},{"id":"1949f788cdc855b5","type":"server-state-changed","z":"6b59b3ce4612b9de","name":"at_home","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.at_home","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":180,"wires":[["5ce5c399ed76fe4d"],[]]},{"id":"5ce5c399ed76fe4d","type":"delay","z":"6b59b3ce4612b9de","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":415,"y":180,"wires":[["aa92a050e856fbfc"]],"l":false},{"id":"22318be840827f7b","type":"link out","z":"6b59b3ce4612b9de","name":"link out 632","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"7fbf3dd3e13141dd","type":"function","z":"6b59b3ce4612b9de","name":"notification","func":"let alert_speaker = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_speaker\"].state == \"on\"\nlet alert_light = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_light\"].state == \"on\"\nlet notification_id = \"temperature_alert_\" + msg.linked_area\n\nif (msg.count == 0) {\n    return { notification_id: notification_id, sound: \"ok.mp3\", dismiss: true }\n} else if (msg.count <= 3) {\n    let message = { notification_id: notification_id, alert_type: \"info\" }\n    switch (msg.alert) {\n        case \"outside_max_temp_close\":\n            message[\"title\"] = \"Temp√©rature haute\"\n            message[\"message\"] = \"Fermez\" + set_windows_text() + \"pour rester au frais\"\n            if (alert_light) { message[\"effects\"] = { count: 2, color: 15, saturation: 100, time: 1000 } }\n            if (alert_speaker) { message[\"speak\"] = message[\"message\"] }\n            return message\n        case \"outside_min_temp_close\":\n            message[\"title\"] = \"Temp√©rature basse\"\n            message[\"message\"] = \"Fermez\" + set_windows_text() + \"pour rester au chaud\"\n            if (alert_light) { message[\"effects\"] = { count: 2, color: 240, saturation: 100, time: 1000 } }\n            if (alert_speaker) { message[\"speak\"] = message[\"message\"] }\n            return message\n        case \"inside_max_temp_open\":\n            message[\"title\"] = \"Temp√©rature haute\"\n            message[\"message\"] = \"Ouvrez\" + set_windows_text() + \"pour baisser la temp√©rature\"\n            if (alert_light) { message[\"effects\"] = { count: 2, color: 15, saturation: 100, time: 1000 } }\n            if (alert_speaker) { message[\"speak\"] = message[\"message\"] }\n            return message\n        case \"inside_max_hum_open\":\n            message[\"title\"] = \"Humidit√© haute\"\n            message[\"message\"] = \"Ouvrez\" + set_windows_text() + \"pour r√©duire l'humidit√©\"\n            if (alert_light) { message[\"effects\"] = { count: 2, color: 240, saturation: 20, time: 1000 } }\n            if (alert_speaker) { message[\"speak\"] = message[\"message\"] }\n            return message\n    }\n}\n\nfunction set_windows_text() {\n    let alias = msg.windows_alias\n    if (alias.length == 1) {\n        return \" la \" + alias[0] + \" \"\n    } else {\n        let joined = alias.slice(0, -1).join(\", \") + \" et \" + alias[alias.length - 1]\n        return \" les \" + joined + \" \"\n    }\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":360,"wires":[["a0d49596c9f1a004"]]},{"id":"e97deb8ede0b3b78","type":"link in","z":"6b59b3ce4612b9de","name":"get comforts","links":["7f08a582a223691c"],"x":55,"y":240,"wires":[["17346ef244b80469"]]},{"id":"17346ef244b80469","type":"function","z":"6b59b3ce4612b9de","name":"prepare ext_comfort","func":"let rising = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].attributes.rising\nlet temp_hum = global.get(\"temp_hum\") ?? {}\n\nif (\n    temp_hum[\"exterior\"]?.[\"temperature\"]?.last_changed &&\n    temp_hum[\"exterior\"]?.[\"humidity\"]?.last_changed &&\n    temp_hum[\"exterior\"]?.[\"temperature\"]?.value &&\n    temp_hum[\"exterior\"]?.[\"humidity\"]?.value\n    && (new Date().getTime() - temp_hum[\"exterior\"][\"temperature\"].last_changed) / 1000 < 60 * 60 * 24\n    && (new Date().getTime() - temp_hum[\"exterior\"][\"humidity\"].last_changed) / 1000 < 60 * 60 * 24\n) {\n    let ext_temp = temp_hum[\"exterior\"][\"temperature\"].value\n    msg.payload = {\n        ext_temperature: ext_temp < 0 ? 0 : ext_temp > 50 ? 50 : ext_temp,\n        ext_humidity: temp_hum[\"exterior\"][\"humidity\"].value,\n        ext_metabolic: 1.1\n    }\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":240,"wires":[["db47ad2d55c2b4a6"]]},{"id":"db47ad2d55c2b4a6","type":"comfort","z":"6b59b3ce4612b9de","name":"ext comfort","tempField":"payload.ext_temperature","tempFieldType":"msg","mrtField":"payload.temperature","mrtFieldType":"operative","humidityField":"payload.ext_humidity","humidityFieldType":"msg","airspeedField":"0","airspeedFieldType":"num","metabolicRateField":"payload.ext_metabolic","metabolicRateFieldType":"msg","clothingLevelField":"0.5","clothingLevelFieldType":"num","comfortField":"ext_comfort","comfortFieldType":"msg","sensationField":"sensation","sensationFieldType":"msg","x":335,"y":240,"wires":[["b7fbaf4a4be91732"]],"l":false},{"id":"b7fbaf4a4be91732","type":"function","z":"6b59b3ce4612b9de","name":"prepare int_comfort","func":"let rising = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].attributes.rising\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nmsg.payload = []\n\nfor (let area of Object.keys(temp_hum).filter(area => area != \"exterior\")) {\n    if (\n        temp_hum[area]?.[\"temperature\"]?.last_changed &&\n        temp_hum[area]?.[\"humidity\"]?.last_changed &&\n        temp_hum[area]?.[\"temperature\"]?.value &&\n        temp_hum[area]?.[\"humidity\"]?.value\n        && (new Date().getTime() - temp_hum[area][\"temperature\"].last_changed) / 1000 < 60 * 60 * 24\n        && (new Date().getTime() - temp_hum[area][\"humidity\"].last_changed) / 1000 < 60 * 60 * 24\n    ) {\n        let area_temp = temp_hum[area][\"temperature\"].value\n        msg.payload.push({\n            linked_area: area,\n            area_temperature: area_temp < 0 ? 0 : area_temp > 50 ? 50 : area_temp,\n            area_humidity: temp_hum[area][\"humidity\"].value,\n            area_metabolic: 1.1\n        })\n    }\n}\n\nif (msg.payload.length != 0) {\n    temp_hum[\"exterior\"][\"comfort\"] = Math.round(msg.ext_comfort * 100) / 100\n    global.set(\"temp_hum\", temp_hum)\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":240,"wires":[["7e088442390efe73"]]},{"id":"7e088442390efe73","type":"split","z":"6b59b3ce4612b9de","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":595,"y":240,"wires":[["c5f7414b0d53ebb0"]],"l":false},{"id":"c5f7414b0d53ebb0","type":"comfort","z":"6b59b3ce4612b9de","name":"area comfort","tempField":"payload.area_temperature","tempFieldType":"msg","mrtField":"payload.temperature","mrtFieldType":"operative","humidityField":"payload.area_humidity","humidityFieldType":"msg","airspeedField":"0","airspeedFieldType":"num","metabolicRateField":"payload.area_metabolic","metabolicRateFieldType":"msg","clothingLevelField":"0.5","clothingLevelFieldType":"num","comfortField":"payload.area_comfort","comfortFieldType":"msg","sensationField":"payload.sensation","sensationFieldType":"msg","x":645,"y":240,"wires":[["9c8d9519f10e9e56"]],"l":false},{"id":"9c8d9519f10e9e56","type":"join","z":"6b59b3ce4612b9de","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":695,"y":240,"wires":[["61a3686d9ce23195"]],"l":false},{"id":"6999135a863c9524","type":"link in","z":"6b59b3ce4612b9de","name":"link in 563","links":["72df314942e3bc4e"],"x":55,"y":360,"wires":[["ed9b2e0e805507b5"]]},{"id":"ed9b2e0e805507b5","type":"function","z":"6b59b3ce4612b9de","name":"recommendations","func":"let at_home = global.get('homeassistant').homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nlet msgs = []\n\nlet windows = msg.windows.map(w => ({ ...w, linked_area: temp_hum[w.linked_area] ? w.linked_area : \"home\" }))\nlet humidity_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state)\nlet areas = [... new Set(windows.map(w => w.linked_area))]\n\nfor (let area of areas) {\n    if (!temp_hum[area][\"recommendation\"]) {\n        temp_hum[area][\"recommendation\"] = { count: 0 }\n    }\n\n    let windows_area_on = windows.filter(w => w.state == \"on\" && w.linked_area == area)\n    let windows_area_off = windows.filter(w => w.state == \"off\" && w.linked_area == area)\n\n    if (at_home && windows_area_on.length != 0 && temp_hum[area][\"temperature\"].high && temp_hum[\"exterior\"][\"comfort\"] > temp_hum[area][\"comfort\"] && temp_hum[area][\"temperature\"].tendency > 0) {\n        setRecommendations(area)\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area, alert: \"outside_max_temp_close\", windows_alias: get_windows_alias(windows_area_on) })\n    } else if (at_home && windows_area_on.length != 0 && temp_hum[area][\"temperature\"].low && temp_hum[\"exterior\"][\"comfort\"] < temp_hum[area][\"comfort\"] && temp_hum[area][\"temperature\"].tendency < 0) {\n        setRecommendations(area)\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area, alert: \"outside_min_temp_close\", windows_alias: get_windows_alias(windows_area_on) })\n    } else if (at_home && windows_area_on.length == 0 && temp_hum[area][\"temperature\"].high && temp_hum[\"exterior\"][\"comfort\"] < temp_hum[area][\"comfort\"]) {\n        setRecommendations(area)\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area, alert: \"inside_max_temp_open\", windows_alias: get_windows_alias(windows_area_off) })\n    } else if (at_home && windows_area_on.length == 0 && !temp_hum[area][\"temperature\"].high && !temp_hum[area][\"temperature\"].low && temp_hum[area][\"humidity\"].high\n        && dew_point_calc(temp_hum[\"exterior\"][\"temperature\"].value, temp_hum[\"exterior\"][\"humidity\"].value > humidity_max ? temp_hum[\"exterior\"][\"humidity\"].value : humidity_max) < dew_point_calc(temp_hum[area][\"temperature\"].value, temp_hum[area][\"humidity\"].value)\n    ) {\n        setRecommendations(area)\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area, alert: \"inside_max_hum_open\", windows_alias: get_windows_alias(windows_area_off) })\n    } else if (temp_hum[area][\"recommendation\"].count != 0) {\n        temp_hum[area][\"recommendation\"].count = 0\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area })\n    }\n    global.set(\"temp_hum\", temp_hum)\n}\nreturn [msgs]\n\nfunction get_windows_alias(windows) {\n    return windows.map(w => w.alias ?? w.linked_area)\n}\n\nfunction setRecommendations(area) {\n    temp_hum[area][\"recommendation\"].count++\n}\n\nfunction dew_point_calc(temp, hum) {\n    let gamma = (17.27 * temp) / (237.7 + temp) + Math.log(hum / 100)\n    return (237.7 * gamma) / (17.27 - gamma)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":360,"wires":[["7fbf3dd3e13141dd"]]},{"id":"a0d49596c9f1a004","type":"link out","z":"6b59b3ce4612b9de","name":"link out 641","mode":"link","links":["8edaeb40fc5e5069"],"x":475,"y":360,"wires":[]},{"id":"34b7d15954316953","type":"function","z":"6b59b3ce4612b9de","name":"set home comfort","func":"const average = array => array.reduce((a, b) => a + b) / array.length\n\nlet areas = Object.keys(msg.temp_hum).filter(a => a != \"exterior\" && a != \"home\")\nif (areas.length != 0) {\n    if (!msg.temp_hum[\"home\"]) { msg.temp_hum[\"home\"] = {} }\n    msg.temp_hum[\"home\"][\"comfort\"] = average(areas.map(area => msg.temp_hum[area][\"comfort\"]))\n    return { temp_hum: msg.temp_hum, windows: msg.windows }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":300,"wires":[["71506b4a212bf8b4"]]},{"id":"72df314942e3bc4e","type":"link out","z":"6b59b3ce4612b9de","name":"set home temp|hum","mode":"link","links":["6999135a863c9524","a539f95eb1a17875"],"x":735,"y":300,"wires":[]},{"id":"6fcff9473626d18e","type":"link out","z":"6b59b3ce4612b9de","name":"link out 643","mode":"link","links":["36f39c86b4eb66fa"],"x":915,"y":240,"wires":[]},{"id":"36f39c86b4eb66fa","type":"link in","z":"6b59b3ce4612b9de","name":"link in 564","links":["6fcff9473626d18e"],"x":55,"y":300,"wires":[["34b7d15954316953"]]},{"id":"61a3686d9ce23195","type":"function","z":"6b59b3ce4612b9de","name":"set comforts","func":"msg.temp_hum = global.get(\"temp_hum\") ?? {}\n\nfor (let comfort of msg.payload) {\n    if (msg.temp_hum[comfort.linked_area]) {\n        msg.temp_hum[comfort.linked_area][\"comfort\"] = Math.round(comfort.area_comfort * 100) / 100\n    }\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":240,"wires":[["6fcff9473626d18e"]]},{"id":"71506b4a212bf8b4","type":"function","z":"6b59b3ce4612b9de","name":"set home temperature","func":"let temperature_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state)\nlet temperature_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state)\nconst average = array => array.reduce((a, b) => a + b) / array.length\nlet linked_area = \"home\"\n\nlet areas = Object.keys(msg.temp_hum).filter(a => a != \"exterior\" && a != \"home\")\nif (areas.length != 0) {\n    let value = average(areas.map(a => msg.temp_hum[a][\"temperature\"].value))\n\n    if (!msg.temp_hum[linked_area]) { msg.temp_hum[linked_area] = {} }\n    if (!msg.temp_hum[linked_area][\"temperature\"]) { msg.temp_hum[linked_area][\"temperature\"] = { value: value, mean_hour: value, last_changed: new Date().getTime() } }\n\n    let timeElapsed = parseInt((new Date().getTime() - msg.temp_hum[linked_area][\"temperature\"].last_changed) / 1000)\n    let mean_10min = meanCalc(timeElapsed, 600, value, msg.temp_hum[linked_area][\"temperature\"].value)\n    let mean_hour = meanCalc(timeElapsed, 3600, mean_10min, msg.temp_hum[linked_area][\"temperature\"].mean_hour)\n    let mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000\n\n    msg.temp_hum[linked_area][\"temperature\"].high = temperature_max <= (Math.ceil(10 * mean_10min) / 10)\n    msg.temp_hum[linked_area][\"temperature\"].low = (Math.ceil(10 * mean_10min) / 10) <= temperature_min\n    msg.temp_hum[linked_area][\"temperature\"].last_changed = new Date().getTime()\n    msg.temp_hum[linked_area][\"temperature\"].tendency = mean_hour_tendency\n    msg.temp_hum[linked_area][\"temperature\"].mean_hour = mean_hour\n    msg.temp_hum[linked_area][\"temperature\"].value = mean_10min\n\n    return msg\n}\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":300,"wires":[["0e6f3a1122d6fbc0"]]},{"id":"0e6f3a1122d6fbc0","type":"function","z":"6b59b3ce4612b9de","name":"set home humidity","func":"let humidity_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state)\nlet humidity_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state)\nconst average = array => array.reduce((a, b) => a + b) / array.length\nlet linked_area = \"home\"\n\nlet areas = Object.keys(msg.temp_hum).filter(a => a != \"exterior\" && a != \"home\")\nif (areas.length != 0) {\n    let value = average(areas.map(a => msg.temp_hum[a][\"humidity\"].value))\n\n    if (!msg.temp_hum[linked_area]) { msg.temp_hum[linked_area] = {} }\n    if (!msg.temp_hum[linked_area][\"humidity\"]) { msg.temp_hum[linked_area][\"humidity\"] = { value: value, mean_hour: value, last_changed: new Date().getTime() } }\n\n    let timeElapsed = parseInt((new Date().getTime() - msg.temp_hum[linked_area][\"humidity\"].last_changed) / 1000)\n    let mean_10min = meanCalc(timeElapsed, 600, value, msg.temp_hum[linked_area][\"humidity\"].value)\n    let mean_hour = meanCalc(timeElapsed, 3600, mean_10min, msg.temp_hum[linked_area][\"humidity\"].mean_hour)\n    let mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000\n\n    msg.temp_hum[linked_area][\"humidity\"].high = humidity_max <= (Math.ceil(10 * mean_10min) / 10)\n    msg.temp_hum[linked_area][\"humidity\"].low = (Math.ceil(10 * mean_10min) / 10) <= humidity_min\n    msg.temp_hum[linked_area][\"humidity\"].last_changed = new Date().getTime()\n    msg.temp_hum[linked_area][\"humidity\"].tendency = mean_hour_tendency\n    msg.temp_hum[linked_area][\"humidity\"].mean_hour = mean_hour\n    msg.temp_hum[linked_area][\"humidity\"].value = mean_10min\n\n    global.set(\"temp_hum\", msg.temp_hum)\n    return msg\n}\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":300,"wires":[["72df314942e3bc4e"]]},{"id":"40cbaf9f0a0c51d1","type":"inject","z":"6b59b3ce4612b9de","name":"5 min","props":[],"repeat":"","crontab":"*/5 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":110,"y":500,"wires":[["637490fbf4ccf1a5"]]},{"id":"f87fdef38066fd9a","type":"function","z":"6b59b3ce4612b9de","name":"set rain_alarm","func":"let rain_alarm = global.get(\"rain_alarm\") ?? \"\"\nlet response = JSON.parse(msg.payload)\n\nif (response.status === \"success\" && (rain_alarm === \"\" || rain_alarm !== response.data.rain)) {\n    rain_alarm = response.data.rain\n    global.set(\"rain_alarm\", rain_alarm)\n}","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":500,"wires":[]},{"id":"637490fbf4ccf1a5","type":"function","z":"6b59b3ce4612b9de","name":"get home position","func":"let h_attr = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\nmsg.payload = `curl https://api.quart.studio/rainAlarm/${h_attr.latitude}/${h_attr.longitude}`\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":500,"wires":[["0e945b887584cbeb"]]},{"id":"0e945b887584cbeb","type":"exec","z":"6b59b3ce4612b9de","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":430,"y":500,"wires":[["f87fdef38066fd9a"],[],[]]},{"id":"7b90af1cd1737c7e","type":"comment","z":"6b59b3ce4612b9de","name":"rain alert","info":"","x":100,"y":440,"wires":[]},{"id":"5248751d5e1cfa53","type":"function","z":"b74c6c18ccf2525f","name":"set controls","func":"if (msg.payload === undefined || msg.payload === \"True\") {\n    let waits = global.get(\"waits\") ?? {}\n    let then_msgs = []\n    let wait_msgs = []\n\n    if (waits[msg.id]) {\n        delete waits[msg.id]\n        global.set(\"waits\", waits)\n    }\n\n    for (let t of Object.keys(msg.then ?? {})) {\n        let state = Array.isArray(msg.then[t]) && msg.then[t].length == 2 ? msg.then[t][0] : msg.then[t]\n        let delay = Array.isArray(msg.then[t]) && msg.then[t].length == 2 ? msg.then[t][1] * 1000 : 0\n        let match = t.match(/wait\\s+(\\{\\{\\s*.*?\\s*\\}\\})\\s+for\\s+(\\d+(?:\\.\\d+)?)/)\n        let id = `${msg.id_part}_${Object.keys(msg.then).indexOf(t)}`\n        if (match) {\n            waits[id] = {\n                template: match[1],\n                intime: msg.then[t].intime ?? {},\n                timeout: msg.then[t].timeout ?? {},\n                expiration: new Date().getTime() + parseFloat(match[2]) * 1000\n            }\n            global.set(\"waits\", waits)\n            wait_msgs.push({\n                wait_id: id,\n                template: match[1],\n                then: msg.then[t].intime ?? {},\n                timeout: msg.then[t].timeout ?? {},\n                delay: parseFloat(match[2]) * 1000\n            })\n        } else if (t.startsWith(\"once.\")) {\n            let onces = global.get(\"onces\") ?? []\n            if (!(onces.includes(id))) {\n                onces.push(id)\n                then_msgs.push({ entity_id: t.substring(5), state: state, delay: delay })\n                global.set(\"onces\", onces)\n            }\n        } else if (\n            t.startsWith(\"emulate.\")\n            || t === \"notification\"\n            || t === \"execute\"\n            || global.get(\"homeassistant\").homeAssistant.states?.[t]?.state != msg.then[t]\n        ) {\n            then_msgs.push({ entity_id: t, state: state, delay: delay })\n        }\n    }\n    return [wait_msgs, then_msgs]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":200,"wires":[["e4ba25357bac5965","215a67f2afbcd5d1"],["3812603bf7eec17e"]]},{"id":"420611d4ab2fb22d","type":"api-render-template","z":"b74c6c18ccf2525f","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":375,"y":200,"wires":[["15204d963ffde46b"]],"l":false},{"id":"215a67f2afbcd5d1","type":"delay","z":"b74c6c18ccf2525f","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":275,"y":200,"wires":[["3b7aa800040ba412"]],"l":false},{"id":"d8ee06b1f13f07fd","type":"link out","z":"b74c6c18ccf2525f","name":"link out 71","mode":"link","links":["c1e41f1b4eb08365"],"x":475,"y":200,"wires":[]},{"id":"c1e41f1b4eb08365","type":"link in","z":"b74c6c18ccf2525f","name":"devices control msg.then","links":["7603c876e842df51","8432ae2dda8596a2","a8e586470c4d5a43","d8ee06b1f13f07fd","4125a760160a803e"],"x":55,"y":200,"wires":[["5248751d5e1cfa53"]]},{"id":"3b7aa800040ba412","type":"function","z":"b74c6c18ccf2525f","name":"timeout","func":"let waits = global.get(\"waits\") ?? {}\n\nlet timeout = {}\nfor (let id of Object.keys(waits)) {\n    if (waits[id].expiration <= new Date().getTime()) {\n        if (id === msg.wait_id) {\n            timeout = msg.timeout\n        }\n        delete waits[id]\n    }\n}\nglobal.set(\"waits\", waits)\nif (Object.keys(timeout).length > 0) {\n    return { then: timeout }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":325,"y":200,"wires":[["d8ee06b1f13f07fd"]],"l":false},{"id":"f0e4e8e7d437de33","type":"subflow:2f44a0de1e92d674","z":"b74c6c18ccf2525f","name":"","x":790,"y":200,"wires":[]},{"id":"cdf07ce347cfcf41","type":"function","z":"b74c6c18ccf2525f","name":"notification ?","func":"if (msg.entity_id == \"notification\") {\n    msg = { ...msg.state }\n    return [msg, null]\n} else {\n    return [null, msg]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":200,"wires":[["0d9bc83ee952fc19"],["f0e4e8e7d437de33"]]},{"id":"82f9b197e7b82827","type":"link out","z":"b74c6c18ccf2525f","name":"link out 72","mode":"link","links":["8edaeb40fc5e5069"],"x":895,"y":200,"wires":[]},{"id":"79845bfa53ceef65","type":"delay","z":"b74c6c18ccf2525f","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":525,"y":200,"wires":[["cdf07ce347cfcf41"]],"l":false},{"id":"15204d963ffde46b","type":"function","z":"b74c6c18ccf2525f","name":"del wait","func":"if (msg.payload === \"True\") {\n    let waits = global.get(\"waits\") ?? {}\n    if (waits[msg.id]) {\n        delete waits[msg.id]\n        global.set(\"waits\", waits)\n        return msg\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":425,"y":200,"wires":[["d8ee06b1f13f07fd"]],"l":false},{"id":"2c9b3a973e35b19b","type":"comment","z":"b74c6c18ccf2525f","name":"low battery level","info":"","x":120,"y":280,"wires":[]},{"id":"21f7fca2dacb794d","type":"server-events","z":"b74c6c18ccf2525f","name":"battery","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"state_changed","eventData":"{\"new_state\":{\"attributes\":{\"device_class\":\"battery\"}},\"old_state\":{\"attributes\":{\"device_class\":\"battery\"}}}","waitForRunning":true,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":90,"y":340,"wires":[["51cf5e2fb3754c9d"]]},{"id":"038811cb5db7b07a","type":"server-state-changed","z":"b74c6c18ccf2525f","name":"low_battery_level","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.low_battery_level","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"low_battery_level","propertyType":"msg","value":"","valueType":"entityState"}],"x":460,"y":340,"wires":[["ee8d106e310c7600"]]},{"id":"ee8d106e310c7600","type":"ha-get-entities","z":"b74c6c18ccf2525f","name":"","server":"c87720f17866318d","version":1,"rules":[{"property":"attributes.device_class","logic":"is","value":"battery","valueType":"str"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"devices","outputResultsCount":1,"x":630,"y":340,"wires":[["61bed52c6b39e2f4"]]},{"id":"51cf5e2fb3754c9d","type":"api-current-state","z":"b74c6c18ccf2525f","name":"get low_battery_level","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.low_battery_level","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"low_battery_level","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":260,"y":340,"wires":[["ee8d106e310c7600"]]},{"id":"4554534001c77a38","type":"link out","z":"b74c6c18ccf2525f","name":"link out 75","mode":"link","links":["8edaeb40fc5e5069"],"x":935,"y":340,"wires":[]},{"id":"61bed52c6b39e2f4","type":"function","z":"b74c6c18ccf2525f","name":"check battery level","func":"let notifications = global.get(\"notifications\") ?? {}\nlet low_battery_level = msg.low_battery_level\nlet regex = /^\\d+(\\.\\d+)?$/\nlet devices = msg.devices\nlet msgs = []\n\nfor (let d of devices) {\n    let battery_level = (d.state === \"on\" ? 5 : parseInt(d.state))\n    let notification_id = \"battery_lvl_\" + d.entity_id.split(\".\")[1]\n    let battery_phone = d.entity_id.includes(\"_battery_level\")\n    if (!notifications[notification_id] && (d.state === \"on\" || (regex.test(d.state) && parseInt(d.state) <= low_battery_level))) {\n        msgs.push({\n            notification_id: notification_id,\n            data: { tag: notification_id },\n            title: \"Niveau de batterie \" + (battery_level <= 5 ? \"critique\" : \"faible\"),\n            message: \"Veuillez \" + (battery_phone ? \"recharger\" : \"remplacer\") + \" la batterie \" + d.attributes.friendly_name + \" (\" + battery_level + \"%)\",\n            speak: \"Veuillez \" + (battery_phone ? \"recharger\" : \"remplacer\") + \" la batterie \" + d.attributes.friendly_name,\n            alert_type: battery_level <= 5 ? \"error\" : \"warning\",\n            send_mobile: true\n        })\n    } else if (notifications[notification_id] && (d.state === \"off\" || (regex.test(d.state) && parseInt(d.state) >= (battery_phone ? 100 : low_battery_level + 10)))) {\n        msgs.push({\n            notification_id: notification_id,\n            speak: \"Batterie \" + d.attributes.friendly_name + (d.state === \"off\" ? \" √† √©t√© remplac√©e\" : \" √† \" + battery_level + \"%\"),\n            dismiss: true\n        })\n    }\n}\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":340,"wires":[["4554534001c77a38"]]},{"id":"690f0bad2f29d72b","type":"comment","z":"b74c6c18ccf2525f","name":"disable fonctionnalities on low battery","info":"","x":190,"y":420,"wires":[]},{"id":"f5615987a22a0394","type":"function","z":"b74c6c18ccf2525f","name":"check last_changed","func":"let notifications = global.get(\"notifications\") ?? {}\nlet illuminances = global.get(\"illuminances\") ?? {}\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nlet msgs = []\n\nfor (let area of Object.keys(illuminances)) {\n    if (notifications[\"disable_illuminance_\" + area] === undefined && (new Date().getTime() - illuminances[area].last_changed) / 1000 > 60 * 60 * 24) {\n        let message = \"Probl√®me capteur de luminosit√© de la zone [ \" + area + \" ] (absence de donn√©es depuis plus de 24h)\"\n        msgs.push({\n            notification_id: \"disable_illuminance_\" + area,\n            title: \"Compensation lumi√®re nuages d√©sactiv√©e\",\n            message: message,\n            speak: message,\n            alert_type: \"error\",\n            send_mobile: true\n        })\n    } else if (notifications[\"disable_illuminance_\" + area] !== undefined && (new Date().getTime() - illuminances[area].last_changed) / 1000 < 60 * 60 * 24) {\n        msgs.push({\n            notification_id: \"disable_illuminance_\" + area,\n            dismiss: true\n        })\n    }\n}\n\nfor (let area of Object.keys(temp_hum).filter(x => x !== \"home\")) {\n    if (notifications[\"disable_temperature_\" + area] === undefined && (new Date().getTime() - temp_hum[area][\"temperature\"].last_changed) / 1000 > 60 * 60 * 24) {\n        let message = \"Probl√®me capteur de temp√©rature \" + (temp_hum[area].alias ?? (\"de la zone [ \" + area + \" ]\")) + \" (absence de donn√©es depuis plus de 24h)\"\n        msgs.push({\n            notification_id: \"disable_temperature_\" + area,\n            title: \"Recommandation temp√©ratures et humidit√©s d√©sactiv√©e\",\n            message: message,\n            speak: message,\n            alert_type: \"error\",\n            send_mobile: true\n        })\n    } else if (notifications[\"disable_temperature_\" + area] !== undefined && (new Date().getTime() - temp_hum[area][\"temperature\"].last_changed) / 1000 < 60 * 60 * 24) {\n        msgs.push({\n            notification_id: \"disable_temperature_\" + area,\n            dismiss: true\n        })\n    }\n    if (notifications[\"disable_humidity_\" + area] === undefined && (new Date().getTime() - temp_hum[area][\"humidity\"].last_changed) / 1000 > 60 * 60 * 24) {\n        let message = \"Probl√®me capteur d'humidit√© \" + (temp_hum[area].alias ?? (\"de la zone [ \" + area + \" ]\")) + \" (absence de donn√©es depuis plus de 24h)\"\n        msgs.push({\n            notification_id: \"disable_humidity_\" + area,\n            title: \"Recommandation temp√©ratures et humidit√©s d√©sactiv√©e\",\n            message: message,\n            speak: message,\n            alert_type: \"error\",\n            send_mobile: true\n        })\n    } else if (notifications[\"disable_humidity_\" + area] !== undefined && (new Date().getTime() - temp_hum[area][\"humidity\"].last_changed) / 1000 < 60 * 60 * 24) {\n        msgs.push({\n            notification_id: \"disable_humidity_\" + area,\n            dismiss: true\n        })\n    }\n}\n\nreturn [msgs]","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":480,"wires":[["ae37041f32807f0f"]]},{"id":"ae37041f32807f0f","type":"link out","z":"b74c6c18ccf2525f","name":"link out 76","mode":"link","links":["8edaeb40fc5e5069"],"x":535,"y":480,"wires":[]},{"id":"a539f95eb1a17875","type":"link in","z":"b74c6c18ccf2525f","name":"link in 27","links":["72df314942e3bc4e"],"x":255,"y":480,"wires":[["f5615987a22a0394"]]},{"id":"9f6520bd8fb24f8a","type":"inject","z":"b74c6c18ccf2525f","name":"5 min","props":[],"repeat":"","crontab":"*/5 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":110,"y":480,"wires":[["b17665958fc680c4"]]},{"id":"b17665958fc680c4","type":"delay","z":"b74c6c18ccf2525f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":195,"y":480,"wires":[["f5615987a22a0394"]],"l":false},{"id":"f7ebf6af21f5eb06","type":"catch","z":"b74c6c18ccf2525f","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":60,"wires":[["829c65f0a2870fe3"]]},{"id":"3852f59cfa6da70f","type":"subflow:759003382b0f7bfd","z":"b74c6c18ccf2525f","name":"","x":460,"y":60,"wires":[["7cebe4bdcff72e77"]]},{"id":"829c65f0a2870fe3","type":"change","z":"b74c6c18ccf2525f","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Devices","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":60,"wires":[["3852f59cfa6da70f"]]},{"id":"151797bb9f93b502","type":"comment","z":"b74c6c18ccf2525f","name":"devices_controls","info":"","x":120,"y":140,"wires":[]},{"id":"7cebe4bdcff72e77","type":"link out","z":"b74c6c18ccf2525f","name":"link out 77","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":60,"wires":[]},{"id":"cde22598a9ecef7b","type":"link in","z":"b74c6c18ccf2525f","name":"link in 28","links":["c55ca644e31c56c3"],"x":235,"y":140,"wires":[["49979d93c4295cdc"]]},{"id":"49979d93c4295cdc","type":"function","z":"b74c6c18ccf2525f","name":"reinit onces global","func":"global.set(\"onces\", [])","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":140,"wires":[]},{"id":"83084ef01b0c2998","type":"catch","z":"2ee810558baaf606","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["e1fd7d6881cc1f53"]]},{"id":"6f7a33a2e2ee0306","type":"subflow:759003382b0f7bfd","z":"2ee810558baaf606","name":"","x":460,"y":40,"wires":[["3120eadee3d161e8"]]},{"id":"e1fd7d6881cc1f53","type":"change","z":"2ee810558baaf606","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Heater","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["6f7a33a2e2ee0306"]]},{"id":"236ba841642e04c3","type":"link out","z":"2ee810558baaf606","name":"link out 436","mode":"link","links":["8edaeb40fc5e5069"],"x":515,"y":680,"wires":[]},{"id":"681691b0075a6632","type":"function","z":"2ee810558baaf606","name":"clean target","func":"let match = msg.payload.match(/\\b(2[0-4]|1?\\d)(\\.\\d+)?\\b/)\nmsg.notification_id = \"heater_temp_lock\"\nmatch = match ? match[0] : \"Auto\"\n\nif (match === \"Auto\") {\n    return [\n        { notification_id: \"heater_temp_lock\", speak: \"Chauffage en mode auto\", dismiss: true },\n        { entity_id: \"input_text.heat_temp\", state: match }\n    ]\n} else {\n    return [\n        {\n            notification_id: \"heater_temp_lock\",\n            alert_type: \"success\",\n            title: \"Chauffage v√©rrouill√©\",\n            message: \"Chauffage verrouill√© √† \" + match.replace(\".\", \",\") + \"¬∞C\",\n            speak: \"Chauffage verrouill√© √† \" + match.replace(\".\", \",\") + \"¬∞\",\n            send_mobile: false\n        },\n        { entity_id: \"input_text.heat_temp\", state: match }\n    ]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":680,"wires":[["bdda6a1e8762c590"],["3cd00371e5c1130f"]]},{"id":"011b5288cac927f8","type":"function","z":"2ee810558baaf606","name":"heaters off","func":"return [msg.heaters.map(h => ({ entity_id: h.entity_id, state: \"off\" }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":180,"wires":[["defa6590a1ce55b8"]]},{"id":"defa6590a1ce55b8","type":"subflow:2f44a0de1e92d674","z":"2ee810558baaf606","name":"","x":790,"y":180,"wires":[]},{"id":"1785c6104a98ccb8","type":"function","z":"2ee810558baaf606","name":"get heat_temp","func":"let at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state === \"on\"\nlet min_distance = global.get(\"homeassistant\").homeAssistant.states[\"input_number.min_distance\"].state\nlet heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"].state\nlet zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\nlet home_configuration = global.get(\"home_configuration\") ?? {}\nlet heater_config = home_configuration.heater_config ?? {}\n\nif (at_home) {\n    let heat_temp_config = heater_config[\"in_home_zone\"]?.[\"temperature\"] ?? \"Auto\"\n    if (heat_temp != heat_temp_config) {\n        return [\n            { entity_id: \"input_text.heat_temp\", state: heat_temp_config },\n            { zone: \"in_home_zone\", heat_temp: heat_temp_config }\n        ]\n    }\n} else if (zone_home.radius < min_distance && min_distance <= (heater_config[\"in_big_zone\"]?.[\"radius\"] * 1000 ?? 2000)) {\n    let heat_temp_config = heater_config[\"in_middle_zone\"]?.[\"temperature\"] ?? 17\n    if (heat_temp != heat_temp_config) {\n        return [\n            { entity_id: \"input_text.heat_temp\", state: heat_temp_config },\n            { zone: \"in_middle_zone\", heat_temp: heat_temp_config }\n        ]\n    }\n} else if ((heater_config[\"in_big_zone\"]?.[\"radius\"] * 1000 ?? 100000) < min_distance) {\n    let heat_temp_config = heater_config[\"in_big_zone\"]?.[\"temperature\"] ?? 12\n    if (heat_temp != heat_temp_config) {\n        return [\n            { entity_id: \"input_text.heat_temp\", state: heat_temp_config },\n            { zone: \"in_big_zone\", heat_temp: heat_temp_config }\n        ]\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":620,"wires":[["016e66fb5635fe58"],["38b88579e1456ada"]]},{"id":"69bbe3e38acdf8ba","type":"function","z":"2ee810558baaf606","name":"notification","func":"msg.notification_id = \"module_heat\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Chauffage d√©sactiv√©\"\n    msg.message = \"Module Chauffage d√©sactiv√©, les chauffages sont allum√©s\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":820,"wires":[["4752c8fce2b90709"]]},{"id":"4752c8fce2b90709","type":"link out","z":"2ee810558baaf606","name":"link out 442","mode":"link","links":["8edaeb40fc5e5069"],"x":635,"y":820,"wires":[]},{"id":"92bdc8df0df86eb0","type":"function","z":"2ee810558baaf606","name":"msgs heaters on","func":"return [msg.heaters.map(h => ({ entity_id: h.entity_id, state: \"on\" }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":880,"wires":[["62eef09db2620d0e"]]},{"id":"62eef09db2620d0e","type":"subflow:2f44a0de1e92d674","z":"2ee810558baaf606","name":"","x":550,"y":880,"wires":[]},{"id":"c6d4bb922b20b4d3","type":"link in","z":"2ee810558baaf606","name":"alert temperature","links":["43b78688a296e686","1ce929ac616df668"],"x":55,"y":240,"wires":[["6ede9b82376ce6d1"]]},{"id":"9e8c208a0d7dbd09","type":"switch","z":"2ee810558baaf606","name":"module_heat off ?","property":"module_heat","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":820,"wires":[["87f38c4976922150"]]},{"id":"7948fc02c0d1009c","type":"link out","z":"2ee810558baaf606","name":"link out 447","mode":"link","links":["8edaeb40fc5e5069"],"x":615,"y":620,"wires":[]},{"id":"d31c215f914d2681","type":"function","z":"2ee810558baaf606","name":"notification","func":"let heat_temp = msg.heat_temp.toString().replace(\".\", \",\") + \"¬∞C\"\nlet zone = msg.zone\n\nlet notification = {\n    notification_id: \"heater_temp_lock\",\n    alert_type: \"success\",\n    send_mobile: true\n}\n\nif (zone === \"in_home_zone\") {\n    return {\n        notification_id: \"heater_temp_lock\",\n        dismiss: true\n    }\n} else if (zone === \"in_middle_zone\") {\n    return {\n        title: \"Chauffage mode √©co\",\n        message: \"Chauffage verrouill√© √† \" + heat_temp,\n        ...notification\n    }\n} else if (zone === \"in_big_zone\") {\n    return {\n        title: \"Chauffage mode super √©co\",\n        message: \"Chauffage verrouill√© √† \" + heat_temp,\n        ...notification\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":620,"wires":[["7948fc02c0d1009c"]]},{"id":"69be31bf58e915db","type":"function","z":"2ee810558baaf606","name":"heaters >","func":"msg.search = { \"is\": { linked_class: \"heater\", state: \"on\" } }\nmsg.output_name = \"heaters\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":180,"wires":[["f8d7deae694dbf9c"]]},{"id":"45a68ccf41a281ca","type":"function","z":"2ee810558baaf606","name":"heaters >","func":"msg.search = { \"is\": { linked_class: \"heater\" } }\nmsg.output_name = \"heaters\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":880,"wires":[["e847fb2ce50fd5cd"]]},{"id":"cef8e0ba93c7268e","type":"function","z":"2ee810558baaf606","name":"check auto heat","func":"let json_exterior_average_temp = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state)\nlet temp_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state)\nlet heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.heat\"].state === \"on\"\n\nlet under_temp_min = json_exterior_average_temp[0] < temp_min\nlet has_changed = under_temp_min != heat\n\nif (has_changed) {\n    return [{ entity_id: \"input_boolean.heat\", state: under_temp_min ? \"on\" : \"off\" }, under_temp_min ? msg : null]\n} else {\n    return [null, under_temp_min ? msg : null]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":300,"wires":[["e376ea9dd587c304","9e673a7f62c43ca7"],["749de854a27038b7"]]},{"id":"4132d557eff0bbb9","type":"function","z":"2ee810558baaf606","name":"set target","func":"let notifications = global.get(\"notifications\") ?? {}\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nlet linked_area = msg.linked_area\nlet entity_id = msg.entity_id\nlet windows = msg.windows\nlet state = msg.state\n\nif (temp_hum[msg.linked_area] === undefined) {\n    return [{ entity_id: entity_id, state: \"off\" }, { status: \"no_heater_in_area\", alias: msg.alias }]\n} else if (temp_hum[msg.linked_area] !== undefined) {\n    if ((new Date().getTime() - temp_hum[msg.linked_area]?.[\"temperature\"]?.last_changed) / 1000 > 20 * 60) {\n        return [{ entity_id: entity_id, state: \"off\" }, { status: \"outdated_temperature\", alias: msg.alias }]\n    } else if (windows.length > 0 && state === \"on\") {\n        return [{ entity_id: entity_id, state: \"off\" }, { status: \"window_open\", windows: msg.windows, alias: msg.alias }]\n    } else {\n        let heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"].state\n        if (heat_temp === \"Auto\") {\n            let scheduled = get_scheduled_temperature(msg.schedule, msg.current_time)\n            if (typeof scheduled.target === \"number\") {\n                return [{ entity_id: entity_id, state: (temp_hum[linked_area][\"temperature\"][\"value\"] < scheduled.target ? \"on\" : \"off\") }, null]\n            } else {\n                return [{ entity_id: entity_id, state: \"off\" }, { status: scheduled.status, alias: msg.alias, error: scheduled.error }]\n            }\n        } else if (!isNaN(parseFloat(heat_temp))) {\n            return [{ entity_id: entity_id, state: (temp_hum[linked_area][\"temperature\"][\"value\"] < parseFloat(heat_temp) ? \"on\" : \"off\") }, null]\n        }\n    }\n}\n\nfunction get_scheduled_temperature(schedule, current_time) {\n    let motion_heater = context.get(\"motion_heater\") ?? {}\n    let is_motion_class = msg.trigger_class == \"motion\"\n    let schedule_times = Object.keys(schedule)\n\n    if (schedule_times.length > 0) {\n        let schedule_time = schedule_times.find(s => s <= current_time)\n        let is_on_motion = schedule[schedule_time].includes(\"motion\")\n        let match = schedule[schedule_time].match(/-?\\d+(\\.\\d+)?/)\n        let target = match ? parseFloat(match[0]) : \"no_temp\"\n\n        if (target === \"no_temp\") {\n            return { target: \"error\", status: \"no_target\", error: schedule[schedule_time] }\n        } else {\n            if (is_motion_class && is_on_motion) {\n                motion_heater[msg.linked_area + \"_\" + schedule_time] = true\n                context.set(\"motion_heater\", motion_heater)\n            } else if (!is_on_motion) {\n                motion_heater = {}\n                context.set(\"motion_heater\", motion_heater)\n            }\n            return { target: target, status: \"\" }\n        }\n    } else {\n        return { target: \"error\", status: \"no_schedule\" }\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":420,"wires":[["eb98b17128b924d2"],["814894a852d89dbd"]]},{"id":"eb98b17128b924d2","type":"subflow:2f44a0de1e92d674","z":"2ee810558baaf606","name":"","x":310,"y":420,"wires":[]},{"id":"62e522511450c9f3","type":"function","z":"2ee810558baaf606","name":"msgs heaters","func":"return [\n    msg.heaters.map(heater => ({\n        trigger_class: msg.linked_class,\n        current_time: msg.current_time,\n        ...heater\n    }))\n]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":305,"y":360,"wires":[["2cd13c30b1899147"]],"l":false},{"id":"eb2c263a5025643f","type":"link out","z":"2ee810558baaf606","name":"link out 513","mode":"link","links":["8edaeb40fc5e5069"],"x":575,"y":420,"wires":[]},{"id":"3a2b27dcb68716f2","type":"function","z":"2ee810558baaf606","name":"notification","func":"let notifications = global.get(\"notifications\") ?? {}\nlet notification = {\n    notification_id: \"heater_\" + msg.linked_area,\n    title: msg.alias[0].toUpperCase() + msg.alias.substring(1) + \" d√©sactiv√©\",\n    alert_type: \"warning\",\n    send_mobile: true\n}\n\nif (msg.status === \"window_open\" && msg.windows.length > 0) {\n    let message = msg.title + \". \" + setMessage(msg.windows)\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"no_target\") {\n    let message = msg.title + \". La consigne sp√©cifi√©e pour cet horaire est incorrect: \" + msg.error\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"outdated_temperature\") {\n    let message = msg.title + \". Le capteur ne renvoi plus de temp√©rature depuis plus de 20 minutes\"\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"no_heater_in_area\") {\n    let message = msg.title + \". Cette zone ne contient pas de capteur de temp√©rature\"\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"no_schedule\") {\n    let message = msg.title + \". Pas d'horaire de fonctionnement sp√©cifi√© pour ce chauffage\"\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"heater_reactivated\" && notifications[msg.notification_id] !== undefined) {\n    return {\n        notification_id: \"heater_\" + msg.linked_area,\n        speak: msg.alias + \" r√©activ√©\",\n        dismiss: true\n    }\n}\n\nfunction setMessage(windows) {\n    let alias = []\n    for (let window of windows) {\n        alias.push(window.alias)\n    }\n    if (alias.length == 1) {\n        return \"La fen√™tre \" + alias[0] + \" est ouverte\"\n    } else {\n        let joinAlias = alias.join(\", \")\n        joinAlias = joinAlias.substring(0, joinAlias.lastIndexOf(\", \")) + \" et \" + joinAlias.substring(joinAlias.lastIndexOf(\", \") + 2)\n        return \"Les fen√™tres \" + joinAlias + \" sont ouvertes\"\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":420,"wires":[["eb2c263a5025643f"]]},{"id":"2cd13c30b1899147","type":"function","z":"2ee810558baaf606","name":"windows >","func":"msg.search = { \"is\": { linked_class: \"window\", linked_area: msg.linked_area, state: \"on\" } }\nmsg.output_name = \"windows\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":360,"wires":[["5aa167d935ec2872"]]},{"id":"f5b14f3f99205d5f","type":"link out","z":"2ee810558baaf606","name":"link out 515","mode":"link","links":["81b496792dc9586e"],"x":815,"y":300,"wires":[]},{"id":"81b496792dc9586e","type":"link in","z":"2ee810558baaf606","name":"link in 477","links":["f5b14f3f99205d5f"],"x":55,"y":360,"wires":[["2a0bc24fc56fb4c1"]]},{"id":"9e673a7f62c43ca7","type":"function","z":"2ee810558baaf606","name":"notification","func":"let notification_id = \"heater_auto\"\nlet alert_type = \"success\"\n\nif (msg.state === \"on\") {\n    return {\n        notification_id: notification_id,\n        alert_type: alert_type,\n        title: \"Chauffage automatique pr√™t\",\n        message: \"Chauffage automatique pr√™t, la temp√©rature est suffisamment basse\",\n        speak: msg.message,\n        send_mobile: true\n    }\n} else if (msg.state === \"off\") {\n    return {\n        notification_id: notification_id,\n        alert_type: alert_type,\n        title: \"Chauffage automatique d√©sactiv√©\",\n        message: \"Chauffage automatique d√©sactiv√©, la temp√©rature est suffisamment haute\",\n        speak: msg.message,\n        send_mobile: true\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":300,"wires":[["1553725d3c5db4a4"]]},{"id":"1553725d3c5db4a4","type":"link out","z":"2ee810558baaf606","name":"link out 516","mode":"link","links":["8edaeb40fc5e5069"],"x":455,"y":300,"wires":[]},{"id":"2a0bc24fc56fb4c1","type":"function","z":"2ee810558baaf606","name":"heaters >","func":"msg.search = { \"is\": { linked_class: \"heater\" } }\nmsg.output_name = \"heaters\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["8b11c085065e53d9"]]},{"id":"2c8db393bbc5beba","type":"api-current-state","z":"2ee810558baaf606","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":180,"wires":[["69be31bf58e915db"],[]]},{"id":"6ede9b82376ce6d1","type":"api-current-state","z":"2ee810558baaf606","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":650,"y":240,"wires":[["24995c9a33312214"],[]]},{"id":"48b76c7ba8f19ec4","type":"api-current-state","z":"2ee810558baaf606","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":430,"y":560,"wires":[["c59d669b7a19ac04"],[]]},{"id":"c59d669b7a19ac04","type":"api-current-state","z":"2ee810558baaf606","name":"heat_on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":600,"y":560,"wires":[["5d38c15735d833ea"],[]]},{"id":"a4f7991cfafcf728","type":"server-state-changed","z":"2ee810558baaf606","name":"heat_temp","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_text.heat_temp","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"Auto","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":100,"y":680,"wires":[["681691b0075a6632"],[]]},{"id":"3d6308d758830955","type":"server-state-changed","z":"2ee810558baaf606","name":"min_distance","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.min_distance","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":560,"wires":[["48b76c7ba8f19ec4"]]},{"id":"29856270a7d6ad55","type":"server-state-changed","z":"2ee810558baaf606","name":"heat","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":180,"wires":[[],["2c8db393bbc5beba"]]},{"id":"d4588522c5b19dfa","type":"server-state-changed","z":"2ee810558baaf606","name":"heat_temp","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.heat_temp","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"num","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"heat_temp","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":240,"wires":[["6ede9b82376ce6d1"]]},{"id":"0e59ab3ac96a551a","type":"server-state-changed","z":"2ee810558baaf606","name":"module_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":470,"y":240,"wires":[["6ede9b82376ce6d1"]]},{"id":"6ad9b38684ede135","type":"server-state-changed","z":"2ee810558baaf606","name":"module_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_heat","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":820,"wires":[["9e8c208a0d7dbd09","69bbe3e38acdf8ba"]]},{"id":"f8d7deae694dbf9c","type":"subflow:87a3c75768fca823","z":"2ee810558baaf606","name":"","x":515,"y":180,"wires":[["011b5288cac927f8"]],"l":false},{"id":"5aa167d935ec2872","type":"subflow:87a3c75768fca823","z":"2ee810558baaf606","name":"","x":515,"y":360,"wires":[["9c48f327104165dd"]],"l":false},{"id":"e847fb2ce50fd5cd","type":"subflow:87a3c75768fca823","z":"2ee810558baaf606","name":"","x":255,"y":880,"wires":[["92bdc8df0df86eb0"]],"l":false},{"id":"8b11c085065e53d9","type":"subflow:87a3c75768fca823","z":"2ee810558baaf606","name":"","x":255,"y":360,"wires":[["62e522511450c9f3"]],"l":false},{"id":"24995c9a33312214","type":"link out","z":"2ee810558baaf606","name":"link out 566","mode":"link","links":["dfb6d6c89304578f"],"x":775,"y":240,"wires":[]},{"id":"dfb6d6c89304578f","type":"link in","z":"2ee810558baaf606","name":"link in 516","links":["24995c9a33312214"],"x":55,"y":300,"wires":[["cef8e0ba93c7268e"]]},{"id":"9c48f327104165dd","type":"link out","z":"2ee810558baaf606","name":"link out 567","mode":"link","links":["a553d39fe268c690"],"x":565,"y":360,"wires":[]},{"id":"a553d39fe268c690","type":"link in","z":"2ee810558baaf606","name":"link in 517","links":["9c48f327104165dd"],"x":55,"y":420,"wires":[["4132d557eff0bbb9"]]},{"id":"87f38c4976922150","type":"link out","z":"2ee810558baaf606","name":"link out 569","mode":"link","links":["7b646dd7962f7aae"],"x":415,"y":820,"wires":[]},{"id":"7b646dd7962f7aae","type":"link in","z":"2ee810558baaf606","name":"link in 519","links":["87f38c4976922150"],"x":55,"y":880,"wires":[["45a68ccf41a281ca"]]},{"id":"3120eadee3d161e8","type":"link out","z":"2ee810558baaf606","name":"link out 633","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"2029acb2d9698e8a","type":"subflow:2f44a0de1e92d674","z":"2ee810558baaf606","name":"","x":570,"y":300,"wires":[]},{"id":"68215847e990edf2","type":"function","z":"2ee810558baaf606","name":"get time","func":"let d = new Date()\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n\nmsg.current_time = hour + \":\" + minute\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":300,"wires":[["f5b14f3f99205d5f"]]},{"id":"016e66fb5635fe58","type":"subflow:2f44a0de1e92d674","z":"2ee810558baaf606","name":"","x":350,"y":620,"wires":[]},{"id":"85d08b7af88dc477","type":"comment","z":"2ee810558baaf606","name":"module heat","info":"","x":110,"y":760,"wires":[]},{"id":"2b56b76d192ba1b1","type":"comment","z":"2ee810558baaf606","name":"distance set heat temp","info":"","x":140,"y":500,"wires":[]},{"id":"d6667c1320936ece","type":"comment","z":"2ee810558baaf606","name":"core","info":"","x":90,"y":120,"wires":[]},{"id":"3cd00371e5c1130f","type":"subflow:2f44a0de1e92d674","z":"2ee810558baaf606","name":"","x":410,"y":680,"wires":[]},{"id":"cf516dfdc0642e3c","type":"inject","z":"2ee810558baaf606","name":"@ 5min","props":[],"repeat":"","crontab":"*/5 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":180,"y":240,"wires":[["6ede9b82376ce6d1"]]},{"id":"f535d6f38af3c2d4","type":"server-state-changed","z":"2ee810558baaf606","name":"at_home","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_boolean.at_home"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":260,"y":560,"wires":[["48b76c7ba8f19ec4"]]},{"id":"5d38c15735d833ea","type":"link out","z":"2ee810558baaf606","name":"link out 7","mode":"link","links":["8ab873f9131d134f"],"x":695,"y":560,"wires":[]},{"id":"8ab873f9131d134f","type":"link in","z":"2ee810558baaf606","name":"link in 7","links":["5d38c15735d833ea"],"x":55,"y":620,"wires":[["1785c6104a98ccb8"]]},{"id":"6bf4ea96494c21de","type":"comment","z":"e997555db6460f97","name":"linked_class : water_heat","info":"","x":150,"y":120,"wires":[]},{"id":"510800acac086021","type":"link in","z":"e997555db6460f97","name":"link in 453","links":["bf1b75f730ec217a"],"x":55,"y":300,"wires":[["d2fd7b7c736996aa"]]},{"id":"dcb27e6ad4443cd1","type":"function","z":"e997555db6460f97","name":"prepare devices","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" }\nreturn [msg.water_heats.map(w => ({ entity_id: w.entity_id, state: inverse[w.state] }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":360,"wires":[["de204777c4b93603"]]},{"id":"de204777c4b93603","type":"subflow:2f44a0de1e92d674","z":"e997555db6460f97","name":"","x":750,"y":360,"wires":[]},{"id":"7bae96494d089e68","type":"function","z":"e997555db6460f97","name":"notification","func":"msg.notification_id = \"water_heat\"\n\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Chauffe-eau d√©sactiv√©\"\n    msg.message = \"Module Chauffe-eau d√©sactiv√©, le chauffe eau est allum√©\"\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":360,"wires":[["f6b90722ca4e4123"]]},{"id":"f6b90722ca4e4123","type":"link out","z":"e997555db6460f97","name":"link out 479","mode":"link","links":["8edaeb40fc5e5069"],"x":1035,"y":360,"wires":[]},{"id":"8fcfbd3b9b3ac348","type":"function","z":"e997555db6460f97","name":"prepare devices","func":"let water_heats = global.get(\"water_heats\") ?? {}\nlet devices = msg.water_heats\nlet msgs = []\n\nfor (let device of devices) {\n    water_heats[device.entity_id] = msg.state == \"on\" ? \"manual\" : \"\"\n    msgs.push({\n        entity_id: device.entity_id,\n        state: msg.state,\n        alias: device.alias\n    })\n}\n\nglobal.set(\"water_heats\", water_heats)\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":240,"wires":[["61bdf1ccd43bf50e","fd6ea165688dcd3e"]]},{"id":"61bdf1ccd43bf50e","type":"subflow:2f44a0de1e92d674","z":"e997555db6460f97","name":"","x":1130,"y":240,"wires":[]},{"id":"bd470e6395d2ed67","type":"subflow:2f44a0de1e92d674","z":"e997555db6460f97","name":"","x":1110,"y":180,"wires":[]},{"id":"34d8d62172cb3da7","type":"function","z":"e997555db6460f97","name":"prepare device","func":"let water_heats = global.get(\"water_heats\") ?? {}\n\nif (msg.state === \"on\") {\n    if (!msg.entity_histories.find(h => h.state == \"on\")) {\n        water_heats[msg.entity_id] = \"in_big_zone\"\n        return msg\n    }\n} else {\n    water_heats[msg.entity_id] = \"\"\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":180,"wires":[["be4e5e380ed2f920","bd470e6395d2ed67"]]},{"id":"be4e5e380ed2f920","type":"function","z":"e997555db6460f97","name":"notification","func":"msg.notification_id = \"water_heat\"\n\nif (msg.state == \"on\") {\n    let water_heat_duration = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state)\n    msg.title = \"Dans la grande zone: Chauffe-eau activ√©\"\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allum√© \" + water_heat_duration + \" min\"\n    msg.speak = msg.message\n    msg.alert_type = \"success\"\n    msg.send_mobile = true\n    return msg\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":180,"wires":[["661ecc9b363d33d6"]]},{"id":"661ecc9b363d33d6","type":"link out","z":"e997555db6460f97","name":"link out 482","mode":"link","links":["8edaeb40fc5e5069"],"x":1395,"y":180,"wires":[]},{"id":"6543fd754640a423","type":"delay","z":"e997555db6460f97","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":795,"y":180,"wires":[["34d8d62172cb3da7"]],"l":false},{"id":"d2fd7b7c736996aa","type":"function","z":"e997555db6460f97","name":"check","func":"let module_water_heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.module_water_heat\"].state == \"on\"\nlet in_big_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_big_zone\"].state == \"on\"\nlet water_heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.water_heat_temp\"].state == \"on\"\n\nif (module_water_heat && in_big_zone && !water_heat_temp) {\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":300,"wires":[["15ca8a7cd4722ef6"]]},{"id":"22fdcbfa6d27996e","type":"function","z":"e997555db6460f97","name":"prepare devices","func":"let waterHeatPct = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_pct\"].state) / 100\nlet water_heats = global.get(\"water_heats\") ?? {}\nlet devices = msg.water_heats\nlet msgs = []\n\nfor (let device of devices) {\n    if (!water_heats[device.entity_id] || water_heats[device.entity_id] != \"manual\" && water_heats[device.entity_id] != \"in_big_zone\") {\n        let timeRange = calcIsScheduled(msg.current_time, device)\n        if (typeof timeRange == \"object\") {\n            let times = calcRanges(timeRange[0], timeRange[1])\n            let result = typeof calcIsScheduled(msg.current_time, times) == \"object\" ? \"on\" : \"off\"\n            water_heats[device.entity_id] = result == \"on\" ? \"scheduled\" : \"\"\n            if (device.state != result) {\n                msgs.push({ entity_id: device.entity_id, state: result, alias: device.alias })\n            }\n        } else if (device.state != (timeRange ? \"on\" : \"off\")) {\n            water_heats[device.entity_id] = timeRange ? \"scheduled\" : \"\"\n            msgs.push({ entity_id: device.entity_id, state: timeRange ? \"on\" : \"off\", alias: device.alias })\n        }\n    }\n}\n\nglobal.set(\"water_heats\", water_heats)\nreturn [msgs]\n\nfunction calcRanges(on_time, off_time) {\n    let start = time_to_minutes(on_time)\n    let end = time_to_minutes(off_time)\n    end = start > end ? 1440 + end : end\n    let times = { on_time: [], off_time: [] }\n    for (let i = 0; i < (parseInt(end - start) / 60); i++) {\n        times.on_time.push(minutes_to_time(start + (i + 1) * 60 - waterHeatPct * 60))\n        times.off_time.push(minutes_to_time(start + (i + 1) * 60))\n    }\n    return times\n}\n\nfunction calcIsScheduled(current_time, device) {\n    let isTime = false\n    if (device.on_time.length == device.off_time.length) {\n        if (device.on_time.length == 0) {\n            return true\n        }\n        for (let i = 0; i < device.on_time.length; i++) {\n            isTime = isTime || (device.on_time[i] < device.off_time[i] && device.on_time[i] <= current_time && current_time < device.off_time[i])\n            isTime = isTime || (device.on_time[i] > device.off_time[i] && (device.on_time[i] <= current_time && current_time <= \"23:59\" || \"00:00\" <= current_time && current_time < device.off_time[i]))\n            if (isTime) {\n                return [device.on_time[i], device.off_time[i]]\n            }\n        }\n    }\n    return isTime\n}\n\nfunction time_to_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\")\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1])\n}\n\nfunction minutes_to_time(time) {\n    time = time >= 1440 ? time - 1440 : time\n    let hours = parseInt(time / 60)\n    hours = hours < 10 ? \"0\" + hours : hours == 0 ? \"00\" : hours\n    let minutes = time % 60\n    minutes = minutes < 10 ? \"0\" + minutes : minutes == 0 ? \"00\" : minutes\n    return hours + \":\" + minutes\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":300,"wires":[["f93d5793eb7018fb","a6ee4008561e57b9"]]},{"id":"a6ee4008561e57b9","type":"subflow:2f44a0de1e92d674","z":"e997555db6460f97","name":"","x":730,"y":300,"wires":[]},{"id":"f93d5793eb7018fb","type":"function","z":"e997555db6460f97","name":"notification","func":"msg.notification_id = \"water_heat_\" + msg.entity_id\n\nif (msg.state == \"on\") {\n    msg.title = \"Chauffe-eau activ√© par planification\"\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allum√©\"\n    msg.alert_type = \"success\"\n    msg.send_mobile = false\n    return msg\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":300,"wires":[["b870595011d959da"]]},{"id":"b870595011d959da","type":"link out","z":"e997555db6460f97","name":"link out 488","mode":"link","links":["8edaeb40fc5e5069"],"x":1015,"y":300,"wires":[]},{"id":"0cd4f535244142d6","type":"function","z":"e997555db6460f97","name":"set delay","func":"msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state) * 60 * 1000\nmsg.state = \"off\"\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":180,"wires":[["6543fd754640a423"]]},{"id":"fd6ea165688dcd3e","type":"function","z":"e997555db6460f97","name":"notification","func":"msg.notification_id = \"water_heat\"\n\nif (msg.state == \"on\") {\n    let water_heat_duration = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state)\n    msg.title = \"Chauffe-eau activ√© manuellement\"\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allum√© \" + water_heat_duration + \" min\"\n    msg.alert_type = \"success\"\n    msg.send_mobile = true\n    return msg\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1310,"y":240,"wires":[["d703caa1e057a125"]]},{"id":"d703caa1e057a125","type":"link out","z":"e997555db6460f97","name":"link out 500","mode":"link","links":["8edaeb40fc5e5069"],"x":1415,"y":240,"wires":[]},{"id":"4ecce05ec347da6c","type":"delay","z":"e997555db6460f97","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":240,"wires":[["d4b07b05272bf7d5","300fa7067e4de6a6"]],"l":false},{"id":"b5603e80189319d4","type":"function","z":"e997555db6460f97","name":"set delay","func":"msg.state = msg.payload\n\nif (msg.state == \"on\") {\n    msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state) * 60 * 1000\n    msg.state = \"off\"\n} else {\n    msg.reset = true\n}\n\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":240,"wires":[["4ecce05ec347da6c"]]},{"id":"0edb12e03405ffdd","type":"function","z":"e997555db6460f97","name":"water_heats >","func":"msg.search = { \"is\": { linked_class: \"water_heat\" } }\nmsg.output_name = \"water_heats\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":180,"wires":[["b8882bb337c69c31"]]},{"id":"300fa7067e4de6a6","type":"function","z":"e997555db6460f97","name":"water_heats >","func":"msg.search = { \"is\": { linked_class: \"water_heat\" } }\nmsg.output_name = \"water_heats\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":240,"wires":[["dde88f04cb6250f4"]]},{"id":"15ca8a7cd4722ef6","type":"function","z":"e997555db6460f97","name":"water_heats >","func":"msg.search = { \"is\": { linked_class: \"water_heat\" } }\nmsg.output_name = \"water_heats\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":300,"wires":[["bf218c8de2cdb732"]]},{"id":"32e839d44472fc28","type":"function","z":"e997555db6460f97","name":"water_heats >","func":"msg.search = { \"is\": { linked_class: \"water_heat\", state: msg.payload } }\nmsg.output_name = \"water_heats\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":360,"wires":[["9c0a50c314f20c7f"]]},{"id":"3eec34f822f9c8b9","type":"subflow:2f44a0de1e92d674","z":"e997555db6460f97","name":"","x":850,"y":420,"wires":[]},{"id":"7e4610e6e5657836","type":"function","z":"e997555db6460f97","name":"set water heat pct","func":"let json_exterior_average_temp = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state)\nlet water_heat_person_number = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_person_number\"].state)\nlet water_heat_adjustment = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_adjustment\"].state)\nlet temperatures = global.get(\"temperatures\") ?? {}\nlet msgs = []\n\nif (temperatures.exterior?.last_changed && ((new Date().getTime() - temperatures[\"exterior\"].last_changed) / 1000) < 40 * 60 && Array.isArray(json_exterior_average_temp)) {\n    let pct = (-0.6667 * json_exterior_average_temp[0] + 25) * (water_heat_person_number) + water_heat_adjustment\n    pct = pct > 100 ? 100 : pct < 5 ? 5 : pct\n    msgs.push({\n        entity_id: \"input_number.water_heat_pct\",\n        state: Math.round(pct)\n    })\n\n    let duration = (pct * 60 * 7 / 100) > 360 ? 360 : (pct * 60 * 7 / 100) < 0 ? 0 : Math.round(pct * 60 * 7 / 100)\n    msgs.push({\n        entity_id: \"input_number.water_heat_duration\",\n        state: duration\n    })\n\n    return [msgs]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":420,"wires":[["3eec34f822f9c8b9"]]},{"id":"e139ecff0c897571","type":"function","z":"e997555db6460f97","name":"devices","func":"return [msg.water_heats.map(d => ({ entity_id: d.entity_id, state: \"on\", alias: d.alias }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":180,"wires":[["70f86d0c2ea946e1","0cd4f535244142d6"]]},{"id":"d4b07b05272bf7d5","type":"api-call-service","z":"e997555db6460f97","name":"activate manual off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.water_heat_temp"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":240,"wires":[[]]},{"id":"063c18aa2bf5b6c6","type":"server-state-changed","z":"e997555db6460f97","name":"module_water_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_water_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":360,"wires":[["32e839d44472fc28","7bae96494d089e68"]]},{"id":"bf1aae532c3e4e39","type":"server-state-changed","z":"e997555db6460f97","name":"water heat person number","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.water_heat_person_number","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":370,"y":420,"wires":[["7e4610e6e5657836"]]},{"id":"4a181886c3689d09","type":"server-state-changed","z":"e997555db6460f97","name":"water heat adjustment","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.water_heat_adjustment","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":140,"y":420,"wires":[["7e4610e6e5657836"]]},{"id":"70f86d0c2ea946e1","type":"api-get-history","z":"e997555db6460f97","name":"","server":"c87720f17866318d","version":1,"startDate":"","endDate":"","entityId":"{{entity_id}}","entityIdType":"equals","useRelativeTime":true,"relativeTime":"1 day","flatten":true,"outputType":"array","outputLocationType":"msg","outputLocation":"entity_histories","x":595,"y":180,"wires":[["34d8d62172cb3da7"]],"l":false},{"id":"af69d25ee717e7d0","type":"trigger-state","z":"e997555db6460f97","name":"in_big_zone","server":"c87720f17866318d","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_big_zone","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"entity_id","targetValue":"input_boolean.module_water_heat","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"entity_id","targetValue":"input_boolean.in_big_zone","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":110,"y":180,"wires":[["0edb12e03405ffdd"],[]]},{"id":"272c21231f6f5271","type":"trigger-state","z":"e997555db6460f97","name":"activate manual","server":"c87720f17866318d","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.water_heat_temp","entityIdType":"exact","debugEnabled":false,"constraints":[],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":120,"y":240,"wires":[["a24f1c5572c59d9e","b5603e80189319d4"],[]]},{"id":"b8882bb337c69c31","type":"subflow:87a3c75768fca823","z":"e997555db6460f97","name":"","x":395,"y":180,"wires":[["e139ecff0c897571"]],"l":false},{"id":"dde88f04cb6250f4","type":"subflow:87a3c75768fca823","z":"e997555db6460f97","name":"","x":815,"y":240,"wires":[["8fcfbd3b9b3ac348"]],"l":false},{"id":"bf218c8de2cdb732","type":"subflow:87a3c75768fca823","z":"e997555db6460f97","name":"","x":415,"y":300,"wires":[["22fdcbfa6d27996e"]],"l":false},{"id":"9c0a50c314f20c7f","type":"subflow:87a3c75768fca823","z":"e997555db6460f97","name":"","x":435,"y":360,"wires":[["dcb27e6ad4443cd1"]],"l":false},{"id":"e61d0ee809e604e1","type":"link in","z":"e997555db6460f97","name":"link in 571","links":["c55ca644e31c56c3"],"x":515,"y":420,"wires":[["7e4610e6e5657836"]]},{"id":"26551699d1ad5441","type":"catch","z":"e997555db6460f97","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["d02ee6c37bbeb943"]]},{"id":"0a2f3233b1829090","type":"subflow:759003382b0f7bfd","z":"e997555db6460f97","name":"","x":460,"y":40,"wires":[["86aa32dc1153c87c"]]},{"id":"d02ee6c37bbeb943","type":"change","z":"e997555db6460f97","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"WaterHeat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["0a2f3233b1829090"]]},{"id":"86aa32dc1153c87c","type":"link out","z":"e997555db6460f97","name":"link out 652","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"8661863a5a0cb125","type":"comment","z":"7cd318f787c94137","name":"linked_class : ventilation","info":"","x":140,"y":120,"wires":[]},{"id":"1a95286515779ac3","type":"function","z":"7cd318f787c94137","name":"prepare devices","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" }\n\nreturn [\n    msg.ventilations.map(v => (\n        {\n            module_ventilation: msg.module_ventilation,\n            entity_id: v.entity_id,\n            state: inverse[v.state],\n            linked_area: v.linked_area\n        }\n    ))\n]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":300,"wires":[["44b8ef8adbb72c65","421c1e6769540f29"]]},{"id":"421c1e6769540f29","type":"function","z":"7cd318f787c94137","name":"notification","func":"let notification_id = \"vmc_\" + msg.linked_area\nlet msgs = []\n\nif (msg.module_ventilation == \"off\") {\n    msgs.push(\n        {\n            notification_id: notification_id,\n            alert_type: \"info\",\n            title: \"Module Ventilation\",\n            message: \"Module ventilation d√©sactiv√©, la ventilation est active et les alertes temp√©ratures sont d√©sactiv√©es\",\n            send_mobile: true\n        }\n    )\n} else {\n    msgs.push({ notification_id: notification_id, dismiss: true })\n}\n\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":300,"wires":[["c8e24a01855093fd"]]},{"id":"44b8ef8adbb72c65","type":"link out","z":"7cd318f787c94137","name":"link out 477","mode":"link","links":["6cf52e825cf6fd68"],"x":655,"y":300,"wires":[]},{"id":"c8e24a01855093fd","type":"link out","z":"7cd318f787c94137","name":"link out 478","mode":"link","links":["8edaeb40fc5e5069"],"x":875,"y":300,"wires":[]},{"id":"04f1846b82303207","type":"subflow:2f44a0de1e92d674","z":"7cd318f787c94137","name":"","x":1150,"y":180,"wires":[]},{"id":"afb59a3d8183bdb6","type":"link in","z":"7cd318f787c94137","name":"link in 455","links":["bf1b75f730ec217a"],"x":55,"y":180,"wires":[["742966586b80ec3c"]]},{"id":"6cf52e825cf6fd68","type":"link in","z":"7cd318f787c94137","name":"link in 456","links":["44b8ef8adbb72c65","649fc2e9466f077b"],"x":1025,"y":180,"wires":[["04f1846b82303207"]]},{"id":"8d1d62c1e57df35e","type":"function","z":"7cd318f787c94137","name":"prepare scheduled","func":"let ventilations = global.get(\"ventilations\") ?? {}\nlet devices = msg.ventilations\nlet msgs = []\n\nfor (let device of devices) {\n    let results = calcIsScheduled(msg.current_time, device)\n    if (device.linked_area in ventilations\n        && (results[1] === \"scheduled\" && ventilations[device.linked_area] !== \"scheduled\" || results[1] === \"\" && ventilations[device.linked_area] === \"scheduled\")\n        || !(device.linked_area in ventilations)) {\n        ventilations[device.linked_area] = results[1]\n        msgs.push({\n            entity_id: device.entity_id,\n            state: results[0],\n            linked_area: device.linked_area,\n            alias: device.alias\n        })\n    }\n}\nif (msgs.length !== 0) {\n    global.set(\"ventilations\", ventilations)\n    return [msgs]\n}\n\nfunction calcIsScheduled(current_time, device) {\n    if (device.on_time.length === device.off_time.length) {\n        let isTime = false\n        for (let i = 0; i < device.on_time.length; i++) {\n            isTime = isTime\n                || (device.on_time[i] < device.off_time[i] && device.on_time[i] <= current_time && current_time < device.off_time[i])\n                || (device.on_time[i] > device.off_time[i] && (\n                    device.on_time[i] <= current_time && current_time <= \"23:59\"\n                    || \"00:00\" <= current_time && current_time < device.off_time[i]))\n\n            if (isTime) {\n                return [\"on\", \"scheduled\"]\n            }\n        }\n    }\n    return [\"off\", \"\"]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":180,"wires":[["04f1846b82303207","7c4893aeaf324457"]]},{"id":"3c4fb4043f10b06b","type":"link out","z":"7cd318f787c94137","name":"link out 485","mode":"link","links":["8edaeb40fc5e5069"],"x":1275,"y":240,"wires":[]},{"id":"e2f463dfe22f4898","type":"function","z":"7cd318f787c94137","name":"notification","func":"let ventilations = global.get(\"ventilations\") ?? {}\nmsg.notification_id = \"vmc_\" + msg.linked_area\nmsg.override = true\n\nif (ventilations[msg.linked_area] == \"scheduled\") {\n    msg.alert_type = \"success\"\n    msg.title = \"Ventilation activ√©e par planification\"\n    msg.message = \"La ventilation \" + msg.alias + \" est active\"\n    msg.send_mobile = false\n    return msg\n} else if (ventilations[msg.linked_area] == \"max_humidity\") {\n    msg.alert_type = \"success\"\n    msg.title = \"Ventilation \" + msg.alias + \" activ√©e\"\n    msg.message = \"L'humidit√© est haute, la ventilation \" + msg.alias + \" est activ√©e\"\n    msg.speak = msg.message\n    msg.send_mobile = false\n    return msg\n} else if (ventilations[msg.linked_area] == \"humidity\") {\n    msg.alert_type = \"success\"\n    msg.title = \"Ventilation \" + msg.alias + \" activ√©e\"\n    msg.message = \"Circonstance favorable, la ventilation \" + msg.alias + \" est activ√©e\"\n    msg.send_mobile = false\n    return msg\n} else if (ventilations[msg.linked_area] == \"temperature_offline\") {\n    msg.alert_type = \"warning\"\n    msg.title = \"Ventilation \" + msg.alias + \" d√©sactiv√©e\"\n    msg.message = \"Le capteur de temp√©rature \" + msg.alias + \" ne renvoi plus de donn√©es depuis plus de 40 minutes\"\n    msg.send_mobile = false\n    return msg\n} else if (ventilations[msg.linked_area] == \"\") {\n    msg.dismiss = true\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1170,"y":240,"wires":[["3c4fb4043f10b06b"]]},{"id":"b6af9232e7096828","type":"function","z":"7cd318f787c94137","name":"prepare humidity","func":"let ventilations = global.get(\"ventilations\") ?? {}\nlet temp_hum = global.get(\"temp_hum\") ?? {}\n/*\nlet comforts = global.get(\"comforts\") ?? {}\nlet devices = msg.ventilations\nlet msgs = []\n\nfor (let device of devices) {\n    if (device.linked_area) {\n        let results = autoVentilation(device, comforts)\n        if (device.linked_area in ventilations\n            && results[1] !== ventilations[device.linked_area] && ventilations[device.linked_area] !== \"scheduled\"\n            || !(device.linked_area in ventilations)) {\n            ventilations[device.linked_area] = results[1]\n            msgs.push({\n                entity_id: device.entity_id,\n                state: results[0],\n                linked_area: device.linked_area,\n                alias: device.alias\n            })\n        }\n    }\n}\n\nif (msgs.length !== 0) {\n    global.set(\"ventilations\", ventilations)\n    return [msgs]\n}\n\nfunction autoVentilation(device, comforts) {\n    let intAreas = Object.keys(comforts).filter(area => comforts[area] != \"exterior\")\n    if (\"exterior\" in comforts && intAreas.length != 0) {\n        let mostUncomfortableArea = devices.length === 1 ?\n            intAreas.sort((a, b) => comforts[a] - comforts[b]).reverse()[0]\n            : device.linked_area in intAreas ? comforts[device.linked_area] : \"\"\n\n        if ((new Date().getTime() - humidities[\"exterior\"].lastChanged) / 1000 < 40 * 60\n            && (new Date().getTime() - humidities[mostUncomfortableArea].lastChanged) / 1000 < 40 * 60\n            && (new Date().getTime() - temperatures[mostUncomfortableArea].lastChanged) / 1000 < 40 * 60) {\n\n            if (\n                mostUncomfortableArea\n                && \"exterior\" in humidities\n                && mostUncomfortableArea in humidities\n                && mostUncomfortableArea in temperatures\n            ) {\n                if (\n                    mostUncomfortableArea in humidities\n                    && humidities[mostUncomfortableArea].high\n                    && humidities[mostUncomfortableArea].value > humidities[\"exterior\"].value\n                    && !humidities[\"exterior\"].high\n                ) {\n                    return [\"on\", \"max_humidity\"]\n                } else if (\n                    mostUncomfortableArea in temperatures\n                    && !temperatures[mostUncomfortableArea].low\n                    && comforts[\"exterior\"] < comforts[mostUncomfortableArea]) {\n                    return [\"on\", \"humidity\"]\n                }\n            }\n        } else {\n            return [\"off\", \"temperature_offline\"]\n        }\n    }\n\n    return [\"off\", \"\"]\n}\n*/","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":240,"wires":[["649fc2e9466f077b","e2f463dfe22f4898"]]},{"id":"323b7753d7a2dd41","type":"inject","z":"7cd318f787c94137","name":"10 min","props":[],"repeat":"","crontab":"*/10 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":120,"y":240,"wires":[["cad2b02d7de2a428"]]},{"id":"649fc2e9466f077b","type":"link out","z":"7cd318f787c94137","name":"link out 486","mode":"link","links":["6cf52e825cf6fd68"],"x":1015,"y":240,"wires":[]},{"id":"7c4893aeaf324457","type":"link out","z":"7cd318f787c94137","name":"link out 487","mode":"link","links":["d714a67d309c1fb1"],"x":975,"y":180,"wires":[]},{"id":"d714a67d309c1fb1","type":"link in","z":"7cd318f787c94137","name":"link in 457","links":["7c4893aeaf324457"],"x":1065,"y":240,"wires":[["e2f463dfe22f4898"]]},{"id":"51f4978d5088b637","type":"function","z":"7cd318f787c94137","name":"ventilations >","func":"msg.search = { \"is\": { linked_class: \"ventilation\" } }\nmsg.output_name = \"ventilations\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":180,"wires":[["56b9d33188f138a3"]]},{"id":"cd5afc9d0d970a27","type":"function","z":"7cd318f787c94137","name":"ventilations >","func":"msg.search = { \"is\": { linked_class: \"ventilation\" } }\nmsg.output_name = \"ventilations\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":240,"wires":[["e16d7b2ee80cac3b"]]},{"id":"0de33c24896e7d9f","type":"function","z":"7cd318f787c94137","name":"ventilations >","func":"msg.search = { \"is\": { linked_class: \"ventilation\" } }\nmsg.output_name = \"ventilations\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":300,"wires":[["7bebbc24a8a544d5"]]},{"id":"742966586b80ec3c","type":"api-current-state","z":"7cd318f787c94137","name":"module_ventilation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_ventilation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":410,"y":180,"wires":[["51f4978d5088b637"],[]]},{"id":"cad2b02d7de2a428","type":"api-current-state","z":"7cd318f787c94137","name":"module_ventilation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_ventilation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":450,"y":240,"wires":[["cd5afc9d0d970a27"],[]]},{"id":"465dd4b3682d204a","type":"server-state-changed","z":"7cd318f787c94137","name":"module_ventilation","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_ventilation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_ventilation","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":300,"wires":[["0de33c24896e7d9f"]]},{"id":"55ae03710ad392cb","type":"server-state-changed","z":"7cd318f787c94137","name":"sensibility","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.sensibility","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":260,"y":240,"wires":[["cad2b02d7de2a428"]]},{"id":"03bc8a58f1d6e5ed","type":"server-state-changed","z":"7cd318f787c94137","name":"module_ventilation","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_ventilation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_ventilation","propertyType":"msg","value":"","valueType":"entityState"}],"x":190,"y":180,"wires":[["742966586b80ec3c"]]},{"id":"56b9d33188f138a3","type":"subflow:87a3c75768fca823","z":"7cd318f787c94137","name":"","x":715,"y":180,"wires":[["8d1d62c1e57df35e"]],"l":false},{"id":"e16d7b2ee80cac3b","type":"subflow:87a3c75768fca823","z":"7cd318f787c94137","name":"","x":755,"y":240,"wires":[["b6af9232e7096828"]],"l":false},{"id":"7bebbc24a8a544d5","type":"subflow:87a3c75768fca823","z":"7cd318f787c94137","name":"","x":415,"y":300,"wires":[["1a95286515779ac3"]],"l":false},{"id":"4ef4a76b9d46bba3","type":"catch","z":"7cd318f787c94137","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["e94f79097d2bf40b"]]},{"id":"872369a9163bd555","type":"subflow:759003382b0f7bfd","z":"7cd318f787c94137","name":"","x":460,"y":40,"wires":[["882df0c40df764ed"]]},{"id":"e94f79097d2bf40b","type":"change","z":"7cd318f787c94137","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Ventilation","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["872369a9163bd555"]]},{"id":"882df0c40df764ed","type":"link out","z":"7cd318f787c94137","name":"link out 653","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"18d5a1e52b79ea1f","type":"catch","z":"1c19891b5d34ae49","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["595f84bf186b6a16"]]},{"id":"1598c968367aad89","type":"subflow:759003382b0f7bfd","z":"1c19891b5d34ae49","name":"","x":460,"y":40,"wires":[["cc07290ba37159f5"]]},{"id":"595f84bf186b6a16","type":"change","z":"1c19891b5d34ae49","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"AlarmClock","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["1598c968367aad89"]]},{"id":"cc07290ba37159f5","type":"link out","z":"1c19891b5d34ae49","name":"link out 635","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"abadd9f1db78956d","type":"ha-time","z":"1c19891b5d34ae49","name":"next_alarm_clock","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.next_alarm_clock","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":120,"y":180,"wires":[["9cfd290dc2ac71de"]]},{"id":"f8d65bfba1fde929","type":"function","z":"1c19891b5d34ae49","name":"get alarms","func":"let next_alarms = flow.get(\"next_alarms\") ?? {}\nlet msgs = []\n\nfor (let p of msg.persons) {\n    if (next_alarms[p.entity_id] === msg.state && Object.keys(p.alarm_clock_then).length > 0) {\n        delete next_alarms[p.entity_id]\n        if (p.state === \"home\") {\n            msgs.push({ then: p.alarm_clock_then })\n        }\n    }\n}\n\nflow.set(\"next_alarms\", next_alarms)\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":180,"wires":[["a8e586470c4d5a43"]]},{"id":"a8e586470c4d5a43","type":"link out","z":"1c19891b5d34ae49","name":"alarm started","mode":"link","links":["c1e41f1b4eb08365"],"x":815,"y":180,"wires":[]},{"id":"1b8b1ab1d5f32f39","type":"link in","z":"1c19891b5d34ae49","name":"alarm input","links":["96d13d515f9e5afa","102b87cea48bde20"],"x":55,"y":120,"wires":[["05e6a8a021622a15"]]},{"id":"2e032f1172bb51e1","type":"subflow:2f44a0de1e92d674","z":"1c19891b5d34ae49","name":"","x":950,"y":120,"wires":[]},{"id":"ff0424702cfcc4b4","type":"subflow:87a3c75768fca823","z":"1c19891b5d34ae49","name":"","x":675,"y":120,"wires":[["7ffa7120e713bebc"]],"l":false},{"id":"a7c350ea8d86f6cd","type":"function","z":"1c19891b5d34ae49","name":"persons >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":120,"wires":[["ff0424702cfcc4b4"]]},{"id":"54c38dfc6a4852f3","type":"function","z":"1c19891b5d34ae49","name":"persons >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":180,"wires":[["707aa75fb9452297"]]},{"id":"707aa75fb9452297","type":"subflow:87a3c75768fca823","z":"1c19891b5d34ae49","name":"","x":595,"y":180,"wires":[["f8d65bfba1fde929"]],"l":false},{"id":"9cfd290dc2ac71de","type":"api-current-state","z":"1c19891b5d34ae49","name":"module_alarm_clock ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_alarm_clock","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":320,"y":180,"wires":[["54c38dfc6a4852f3"],[]]},{"id":"05e6a8a021622a15","type":"api-current-state","z":"1c19891b5d34ae49","name":"module_alarm_clock ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_alarm_clock","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":200,"y":120,"wires":[["ade6eff6cb3524f9"],[]]},{"id":"8823fb0abbe9b3fa","type":"server-state-changed","z":"1c19891b5d34ae49","name":"module_alarm_clock ","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_alarm_clock","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":410,"y":120,"wires":[["a7c350ea8d86f6cd"],[]]},{"id":"7ffa7120e713bebc","type":"function","z":"1c19891b5d34ae49","name":"get alarms","func":"let regex = /^([01]\\d|2[0-3]):[0-5]\\d$/\nlet persons = msg.persons\nlet next_alarms = {}\n\nfor (let p of persons) {\n    let d = new Date()\n    if (typeof p[\"alarm_clock\"] === \"string\" && global.get(\"homeassistant\").homeAssistant?.states?.[p[\"alarm_clock\"]]?.state) {\n        let alarm = new Date(global.get(\"homeassistant\").homeAssistant.states[p[\"alarm_clock\"]].state)\n        if (alarm.getTime() > d.getTime()) {\n            next_alarms[p.entity_id] = clean_date(new Date(alarm.setHours(alarm.getHours() - d.getTimezoneOffset() / 60)))\n        }\n    } else if (typeof p[\"alarm_clock\"] === \"object\" && regex.test(p[\"alarm_clock\"][d.getDay() + 1])) {\n        let a_split = p[\"alarm_clock\"][d.getDay() + 1].split(\":\")\n        let alarm = d\n        alarm.setHours(parseInt(a_split[0]))\n        alarm.setMinutes(parseInt(a_split[1]))\n        alarm.setSeconds(0)\n        if (d.getTime() > d.getTime()) {\n            next_alarms[p.entity_id] = clean_date(new Date(alarm.setHours(alarm.getHours() - d.getTimezoneOffset() / 60)))\n        }\n    }\n}\n\nif (Object.keys(next_alarms).length > 0) {\n    flow.set(\"next_alarms\", next_alarms)\n    let next_alarm = next_alarms[Object.keys(next_alarms).sort((a, b) => new Date(next_alarms[a]).getTime() - new Date(next_alarms[b]).getTime())[0]]\n    msg = {\n        entity_id: \"input_datetime.next_alarm_clock\",\n        state: next_alarm\n    }\n    return msg\n}\n\nfunction clean_date(date) {\n    date = JSON.stringify(date)\n    let s_date = date.split(\"T\")\n    return JSON.parse(s_date[0] + \" \" + s_date[1].replace(\".000Z\", \"\"))\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":120,"wires":[["2e032f1172bb51e1"]]},{"id":"22f2d3131c207698","type":"catch","z":"1cd5c3048d47b41c","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["16e1dcee6e39d262"]]},{"id":"20f89c32e390a056","type":"subflow:759003382b0f7bfd","z":"1cd5c3048d47b41c","name":"","x":460,"y":40,"wires":[["80639b96a5ded4ef"]]},{"id":"16e1dcee6e39d262","type":"change","z":"1cd5c3048d47b41c","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Covers","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["20f89c32e390a056"]]},{"id":"3fdf647e807519fb","type":"comment","z":"1cd5c3048d47b41c","name":"cover management","info":"","x":130,"y":120,"wires":[]},{"id":"80639b96a5ded4ef","type":"link out","z":"1cd5c3048d47b41c","name":"link out 61","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"5f61eb4ee4f17edb","type":"link out","z":"1cd5c3048d47b41c","name":"link out 62","mode":"link","links":["ecb0738af713c352"],"x":1045,"y":180,"wires":[]},{"id":"5768825481ed7f96","type":"function","z":"1cd5c3048d47b41c","name":"notification","func":"msg.notification_id = \"module_cover\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Volets roulant d√©sactiv√©\"\n    msg.message = \"Module Volets roulant d√©sactiv√©, les volets roulants ne sont plus control√©es\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":760,"wires":[["b5799cb009771706"]]},{"id":"b5799cb009771706","type":"link out","z":"1cd5c3048d47b41c","name":"link out 63","mode":"link","links":["8edaeb40fc5e5069"],"x":615,"y":760,"wires":[]},{"id":"856f762825bbf3e1","type":"server-state-changed","z":"1cd5c3048d47b41c","name":"module_cover","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_cover","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":760,"wires":[["87b2b6c4542ea447","a7ea97033a782d57"],["1c50af2f0ee6387b"]]},{"id":"5d08de1933337f3c","type":"link out","z":"1cd5c3048d47b41c","name":"link out 64","mode":"link","links":["ecb0738af713c352"],"x":395,"y":760,"wires":[]},{"id":"d41a61c33e83caf9","type":"comment","z":"1cd5c3048d47b41c","name":"on/off module_cover","info":"","x":130,"y":700,"wires":[]},{"id":"87b2b6c4542ea447","type":"function","z":"1cd5c3048d47b41c","name":"set cover value","func":"let is_day_time = global.get('homeassistant').homeAssistant.states[\"input_boolean.is_day_time\"].state == \"on\"\nreturn { value: is_day_time ? 0 : 100 }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":760,"wires":[["5d08de1933337f3c"]]},{"id":"96642412f3189640","type":"link in","z":"1cd5c3048d47b41c","name":"link in 18","links":["3d5f1a6dc5d97e45"],"x":55,"y":420,"wires":[["550e62089b2fc05d"]]},{"id":"550e62089b2fc05d","type":"function","z":"1cd5c3048d47b41c","name":"cover calc","func":"let time_to_aeration = \"time_to_aeration\" in msg ? msg.time_to_aeration : 0\nlet time_to_close = \"time_to_close\" in msg ? msg.time_to_close : 0\nlet time_to_open = \"time_to_open\" in msg ? msg.time_to_open : 0\nlet old_state = msg.old_state\nlet new_state = msg.new_state\nlet msgs = []\n\nif (msg.linked_device) {\n    if (new_state == 100) {\n        msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n\n    } else if (new_state == 0) {\n        msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n    } else if (new_state == 1) {\n        if (old_state == 0) {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: time_to_aeration * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        } else {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n            msgs.push({ delay: (old_state / 100) * time_to_close * 1000 + time_to_aeration * 1000, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: (old_state / 100) * time_to_close * 1000 + time_to_aeration * 1000 + time_to_aeration * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        }\n    } else {\n        let delay = old_state == 0 ? time_to_aeration * 1000 : 0\n        if (old_state < new_state) {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: delay + ((new_state - old_state) / 100) * time_to_open * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        } else {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n            msgs.push({ delay: delay + ((old_state - new_state) / 100) * time_to_close * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        }\n    }\n    return [msgs]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":420,"wires":[["bc030fdd030c9981"]]},{"id":"3bb95425b4f18ba2","type":"function","z":"1cd5c3048d47b41c","name":"notification","func":"let num_covers = msg.num_covers\n\nmsg.notification_id = \"empty_home_cover_status\"\nmsg.alert_type = \"success\"\nmsg.title = (msg.value == 100 ? \"Ouverture\" : \"Fermeture\") + \" des volets\"\nmsg.send_mobile = true\nmsg.override = true\nlet endTxt = \" pendant votre absence\"\n\nif (msg.value == 100) {\n    msg.message = (num_covers == 1 ? \"Le volet s'est ouvert\" : \"Les volets se sont ouverts\") + endTxt\n    return msg\n} else if (msg.value == 0) {\n    msg.message = (num_covers == 1 ? \"Le volet s'est ferm√©\" : \"Les volets se sont ferm√©s\") + endTxt\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":300,"wires":[["6ebdb53b486b3e8f"]]},{"id":"6ebdb53b486b3e8f","type":"link out","z":"1cd5c3048d47b41c","name":"link out 65","mode":"link","links":["8edaeb40fc5e5069"],"x":835,"y":300,"wires":[]},{"id":"c6c9e31fd930f795","type":"function","z":"1cd5c3048d47b41c","name":"notification","func":"msg.notification_id = \"empty_home_cover_status\"\nmsg.dismiss = true\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":480,"wires":[["36554a24b2f2084b"]]},{"id":"36554a24b2f2084b","type":"link out","z":"1cd5c3048d47b41c","name":"link out 66","mode":"link","links":["8edaeb40fc5e5069"],"x":355,"y":480,"wires":[]},{"id":"4f536d716fddf3c5","type":"function","z":"1cd5c3048d47b41c","name":"set home notification","func":"msg.effects = { count: 5, color: 0, saturation: 100, time: 1000 }\nmsg.sound = msg.value === 100 ? \"sunrise.mp3\" : \"moonlight.mp3\"\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":300,"wires":[["203b0214e5936e7e"]]},{"id":"ba9ede263c10adcf","type":"link in","z":"1cd5c3048d47b41c","name":"link in 19","links":["1d3175e98a2c40b5"],"x":55,"y":300,"wires":[["5b13ad9b56548848"]]},{"id":"5b13ad9b56548848","type":"subflow:f884e97a0daa4ce2","z":"1cd5c3048d47b41c","name":"","x":160,"y":300,"wires":[["41e3388590abf861"],["46b4150fea2150b6"]]},{"id":"203b0214e5936e7e","type":"subflow:3dd3ba0d3b3a0ffd","z":"1cd5c3048d47b41c","name":"","x":580,"y":300,"wires":[]},{"id":"de7142bc47adf762","type":"link in","z":"1cd5c3048d47b41c","name":"link in 20","links":["43b78688a296e686"],"x":55,"y":360,"wires":[["9280abd496e9a636"]]},{"id":"9280abd496e9a636","type":"function","z":"1cd5c3048d47b41c","name":"cover >","func":"if (msg.entity_id) {\n    msg.search = { \"is\": { linked_window: msg.entity_id } }\n    msg.output_name = \"linkedCover\"\n    msg.output_empty_results = false\n    return msg\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["596962e770c149ea"]]},{"id":"d6625117e2ccb39a","type":"function","z":"1cd5c3048d47b41c","name":"cover calc","func":"let is_day_time = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.is_day_time\"].state == \"on\"\nreturn { entity_id: msg.linkedCover[0].entity_id, state: is_day_time ? 100 : (msg.new_state == \"on\" ? 100 : 0) }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":360,"wires":[["afeed9076ddf035a"]]},{"id":"3fabb5ba33cc9577","type":"api-call-service","z":"1cd5c3048d47b41c","name":"set cover","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"cover","service":"{{service}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":360,"y":420,"wires":[[]]},{"id":"cedb7507f96dac1f","type":"server-state-changed","z":"1cd5c3048d47b41c","name":"at_home","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.at_home","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":100,"y":480,"wires":[["c6c9e31fd930f795"],[]]},{"id":"596962e770c149ea","type":"subflow:87a3c75768fca823","z":"1cd5c3048d47b41c","name":"","x":255,"y":360,"wires":[["d6625117e2ccb39a"]],"l":false},{"id":"bc030fdd030c9981","type":"delay","z":"1cd5c3048d47b41c","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":255,"y":420,"wires":[["3fabb5ba33cc9577"]],"l":false},{"id":"1d3175e98a2c40b5","type":"link out","z":"1cd5c3048d47b41c","name":"link out 67","mode":"link","links":["ba9ede263c10adcf"],"x":595,"y":240,"wires":[]},{"id":"ecb0738af713c352","type":"link in","z":"1cd5c3048d47b41c","name":"link in 21","links":["5d08de1933337f3c","5f61eb4ee4f17edb"],"x":55,"y":240,"wires":[["4946a6a8fd04a89e"]]},{"id":"a4ef8b4c39f3ac7b","type":"link in","z":"1cd5c3048d47b41c","name":"cover open in template","links":["43b78688a296e686","1ce929ac616df668"],"x":55,"y":620,"wires":[["78725d12154dd9c5"]]},{"id":"afeed9076ddf035a","type":"subflow:2f44a0de1e92d674","z":"1cd5c3048d47b41c","name":"","x":510,"y":360,"wires":[]},{"id":"78725d12154dd9c5","type":"function","z":"1cd5c3048d47b41c","name":"shutters awaiting ?","func":"let sunAngleCoverOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_day_time\"].state)\nlet at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet sun_attributes = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes\nlet shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\n\nif (at_home && Object.keys(shutter_awaiting).length > 0 && sunAngleCoverOn < sun_attributes.elevation) {\n    if ((msg.state ?? \"\") === \"on\") {\n        let covers = []\n        for (let key of Object.keys(shutter_awaiting)) {\n            if (msg.linked_area === shutter_awaiting[key].linked_area) {\n                covers.push({ template: setTemplateVariables(shutter_awaiting[key].morning_open_if), key: key })\n            }\n        }\n        if (covers.length > 0) {\n            return { linked_area: msg.linked_area, state: \"on\", covers: covers }\n        }\n    }\n}\n\nfunction setTemplateVariables(condition) {\n    if (condition.includes(\"global.\")) {\n        let globals_to_inject = global.keys().filter(g => condition.includes(\"global.\" + g))\n        if (globals_to_inject.length != 0) {\n            let injection = '{% set global = {'\n            for (let g of globals_to_inject) {\n                injection += '\"' + g + '\":' + JSON.stringify(global.get(g) ?? {}) + ','\n            }\n            injection = injection.slice(0, -1)\n            injection += '} %}'\n            condition = injection + condition\n            return condition\n        }\n    } else {\n        return condition\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":620,"wires":[["ec95677f3670e7c8"]]},{"id":"ea76df9db6bc3a64","type":"delay","z":"1cd5c3048d47b41c","name":"","pauseType":"delayv","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":755,"y":120,"wires":[["1d795fb661d318f1"]],"l":false},{"id":"1d795fb661d318f1","type":"api-call-service","z":"1cd5c3048d47b41c","name":"set covers pct","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":120,"wires":[[]]},{"id":"08a621c04550c132","type":"function","z":"1cd5c3048d47b41c","name":"morning_open_if","func":"let shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\nlet covers = msg.covers\nlet msgs = []\n\nfor (let cover of covers) {\n    if (cover.result === \"True\") {\n        delete shutter_awaiting[cover.key]\n        msgs.push({ delay: 5000, payload: { data: { entity_id: cover.key, value: 100 } } })\n    }\n}\n\nflow.set(\"shutter_awaiting\", shutter_awaiting)\nif (msgs.length > 0) {\n    return [msgs, { value: 100 }]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":620,"wires":[["03f60316c69a7a6e"],["6314bf30a930663d"]]},{"id":"81ac8a362a00703d","type":"link out","z":"1cd5c3048d47b41c","name":"morning open if","mode":"link","links":["13643fd2010eb1b2"],"x":705,"y":620,"wires":[]},{"id":"13643fd2010eb1b2","type":"link in","z":"1cd5c3048d47b41c","name":"link in 22","links":["81ac8a362a00703d"],"x":255,"y":300,"wires":[["4f536d716fddf3c5"]]},{"id":"a658089b13d86646","type":"comment","z":"1cd5c3048d47b41c","name":"cover open in morning check conditions","info":"","x":190,"y":560,"wires":[]},{"id":"4946a6a8fd04a89e","type":"function","z":"1cd5c3048d47b41c","name":"prepare cover","func":"let windows = msg.linked_windows\nlet covers = []\n\nfor (let cover of msg.covers) {\n    covers.push({\n        ...cover,\n        windows_is_closed: (windows.find(a => a.entity_id == cover.linked_window)?.state ?? \"off\") == \"off\",\n        template: setTemplateVariables(cover.morning_open_if ?? \"True\")\n    })\n}\nreturn { value: msg.value, covers: covers }\n\nfunction setTemplateVariables(condition) {\n    if (condition.includes(\"global.\")) {\n        let globals_to_inject = global.keys().filter(g => condition.includes(\"global.\" + g))\n        if (globals_to_inject.length != 0) {\n            let injection = '{% set global = {'\n            for (let g of globals_to_inject) {\n                injection += '\"' + g + '\":' + JSON.stringify(global.get(g) ?? {}) + ','\n            }\n            injection = injection.slice(0, -1)\n            injection += '} %}'\n            condition = injection + condition\n            return condition\n        }\n    } else {\n        return condition\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":240,"wires":[["ed439f5fe1e6fff2"]]},{"id":"841c3388809eb663","type":"function","z":"1cd5c3048d47b41c","name":"set covers","func":"let at_home = global.get('homeassistant').homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\nlet motion_areas = global.get(\"motion_areas\") ?? {}\nlet value = msg.value\nlet entity_ids = []\n\nfor (let cover of msg.covers) {\n    if (at_home && value == 100) {\n        if ((motion_areas[cover.linked_area] === \"on\" || motion_areas[cover.linked_area] === \"last\") && cover.result === \"True\") {\n            entity_ids.push(cover.entity_id)\n        } else {\n            shutter_awaiting[cover.entity_id] = cover\n            flow.set(\"shutter_awaiting\", shutter_awaiting)\n        }\n    } else if (value == 100 || (value == 0 && cover.windows_is_closed)) {\n        entity_ids.push(cover.entity_id)\n    }\n}\n\nif (entity_ids.length > 0) {\n    return [{ delay: 20000, payload: { data: { entity_id: entity_ids, value: value } } }, { num_covers: entity_ids.length, value: value }]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":240,"wires":[["e829eeb8fe4643da"],["1d3175e98a2c40b5"]]},{"id":"555c7909697c1adc","type":"api-render-template","z":"1cd5c3048d47b41c","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"covers.result","resultsLocationType":"msg","templateLocation":"covers.template","templateLocationType":"msg","x":460,"y":120,"wires":[["3532743466fcf353"]]},{"id":"867eb6d1775a7951","type":"split","z":"1cd5c3048d47b41c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"covers","x":315,"y":120,"wires":[["f734260a00869aa7"]],"l":false},{"id":"2e98620c0197290b","type":"join","z":"1cd5c3048d47b41c","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":605,"y":120,"wires":[["b58f4d0905c0b802"]],"l":false},{"id":"f734260a00869aa7","type":"change","z":"1cd5c3048d47b41c","name":"","rules":[{"t":"set","p":"template","pt":"msg","to":"covers.template","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":365,"y":120,"wires":[["555c7909697c1adc"]],"l":false},{"id":"3532743466fcf353","type":"change","z":"1cd5c3048d47b41c","name":"","rules":[{"t":"delete","p":"covers.template","pt":"msg"},{"t":"delete","p":"template","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":555,"y":120,"wires":[["2e98620c0197290b"]],"l":false},{"id":"427b6037a8b13af1","type":"link in","z":"1cd5c3048d47b41c","name":"template","links":[],"x":255,"y":120,"wires":[["867eb6d1775a7951"]]},{"id":"b58f4d0905c0b802","type":"link out","z":"1cd5c3048d47b41c","name":"link out 68","mode":"return","links":[],"x":655,"y":120,"wires":[]},{"id":"ec95677f3670e7c8","type":"link call","z":"1cd5c3048d47b41c","name":"","links":["427b6037a8b13af1"],"linkType":"static","timeout":"30","x":360,"y":620,"wires":[["08a621c04550c132"]]},{"id":"ed439f5fe1e6fff2","type":"link call","z":"1cd5c3048d47b41c","name":"","links":["427b6037a8b13af1"],"linkType":"static","timeout":"30","x":340,"y":240,"wires":[["841c3388809eb663"]]},{"id":"82c88634e2ea6764","type":"function","z":"1cd5c3048d47b41c","name":"covers >","func":"msg.search = { \"is\": { linked_class: \"cover\" } }\nmsg.output_name = \"covers\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":180,"wires":[["b87f7555cf8d6950"]]},{"id":"b87f7555cf8d6950","type":"subflow:87a3c75768fca823","z":"1cd5c3048d47b41c","name":"","x":735,"y":180,"wires":[["100aaa4a2c25c2d3"]],"l":false},{"id":"03f60316c69a7a6e","type":"link out","z":"1cd5c3048d47b41c","name":"link out 69","mode":"link","links":["a00a2222dd23a652"],"x":655,"y":620,"wires":[]},{"id":"a00a2222dd23a652","type":"link in","z":"1cd5c3048d47b41c","name":"link in 23","links":["03f60316c69a7a6e","be53211e2c176c24"],"x":705,"y":120,"wires":[["ea76df9db6bc3a64"]]},{"id":"be53211e2c176c24","type":"link out","z":"1cd5c3048d47b41c","name":"link out 70","mode":"link","links":["a00a2222dd23a652"],"x":645,"y":240,"wires":[]},{"id":"e481083fe816273f","type":"server-state-changed","z":"1cd5c3048d47b41c","name":"is_day_time","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.is_day_time","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":180,"wires":[["d367fcf08f39475a"]]},{"id":"d367fcf08f39475a","type":"api-current-state","z":"1cd5c3048d47b41c","name":"module_cover on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":290,"y":180,"wires":[["7f9502a454699f4f"],[]]},{"id":"7f9502a454699f4f","type":"function","z":"1cd5c3048d47b41c","name":"set cover value","func":"return { value: msg.state === \"on\" ? 100 : 0 }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":180,"wires":[["82c88634e2ea6764"]]},{"id":"100aaa4a2c25c2d3","type":"function","z":"1cd5c3048d47b41c","name":"linked_windows >","func":"msg.search = { \"is\": { entity_id: msg.covers.filter(c => \"linked_window\" in c).map(c => c.linked_window), state: [\"on\", \"off\"] } }\nmsg.output_name = \"linked_windows\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":180,"wires":[["fbf74e9f11b81cdc"]]},{"id":"fbf74e9f11b81cdc","type":"subflow:87a3c75768fca823","z":"1cd5c3048d47b41c","name":"","x":995,"y":180,"wires":[["5f61eb4ee4f17edb"]],"l":false},{"id":"306f72b175f77d16","type":"catch","z":"c999983c9e171848","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["3c945cc4e0241daa"]]},{"id":"1582f1c3e2238f2b","type":"subflow:759003382b0f7bfd","z":"c999983c9e171848","name":"","x":460,"y":40,"wires":[["c532cf082b759e0f"]]},{"id":"3c945cc4e0241daa","type":"change","z":"c999983c9e171848","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Covers","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["1582f1c3e2238f2b"]]},{"id":"390ad9b4b3f493ea","type":"comment","z":"c999983c9e171848","name":"cover management","info":"","x":130,"y":120,"wires":[]},{"id":"c532cf082b759e0f","type":"link out","z":"c999983c9e171848","name":"link out 636","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"6db8fa2be9e8e5f0","type":"function","z":"c999983c9e171848","name":"set stores_status","func":"return { entity_id: \"input_boolean.stores_status\", state: msg.value == 100 ? \"on\" : \"off\" }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":180,"wires":[["4afdedae9204090c"]]},{"id":"4afdedae9204090c","type":"subflow:2f44a0de1e92d674","z":"c999983c9e171848","name":"","x":1050,"y":180,"wires":[]},{"id":"dbd9595b58224bf2","type":"server-state-changed","z":"c999983c9e171848","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":180,"wires":[["09c986f94bf89aa1"]]},{"id":"09c986f94bf89aa1","type":"api-current-state","z":"c999983c9e171848","name":"module_cover on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":180,"wires":[["b0753c2f1452e3ae"],[]]},{"id":"b0753c2f1452e3ae","type":"function","z":"c999983c9e171848","name":"set cover value","func":"let sun_angle_day_time = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_day_time\"].state)\nlet stores_status = global.get('homeassistant').homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\"\nlet sun = global.get('homeassistant').homeAssistant.states[\"sun.sun\"]\nlet elevation = sun.attributes.elevation\nlet rising = sun.attributes.rising\n\nif (rising && !stores_status && elevation > sun_angle_day_time) {\n    msg.value = 100\n    return msg\n} else if (!rising && stores_status && elevation < sun_angle_day_time) {\n    msg.value = 0\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":180,"wires":[["6db8fa2be9e8e5f0","34349b55c4c48809"]]},{"id":"f4b9f341141753e6","type":"function","z":"c999983c9e171848","name":"notification","func":"msg.notification_id = \"module_cover\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Volets roulant d√©sactiv√©\"\n    msg.message = \"Module Volets roulant d√©sactiv√©, les volets roulants ne sont plus control√©es\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":760,"wires":[["bfed323c053316c9"]]},{"id":"bfed323c053316c9","type":"link out","z":"c999983c9e171848","name":"link out 658","mode":"link","links":["8edaeb40fc5e5069"],"x":615,"y":760,"wires":[]},{"id":"deeecb0ec3106d68","type":"server-state-changed","z":"c999983c9e171848","name":"module_cover","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_cover","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":760,"wires":[["021455dfe4383f93","cd4bc74f56f8b1c1"],["150689f7e4403d97"]]},{"id":"9372d1fd4b1dea4c","type":"link out","z":"c999983c9e171848","name":"link out 659","mode":"link","links":["d6e091099e4d1bda"],"x":395,"y":760,"wires":[]},{"id":"9f5fa711c0388210","type":"comment","z":"c999983c9e171848","name":"on/off module_cover","info":"","x":130,"y":700,"wires":[]},{"id":"021455dfe4383f93","type":"function","z":"c999983c9e171848","name":"set cover value","func":"let stores_status = global.get('homeassistant').homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\"\nreturn { value: stores_status ? 0 : 100 }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":760,"wires":[["9372d1fd4b1dea4c"]]},{"id":"3ab36654e5f6e5a4","type":"link in","z":"c999983c9e171848","name":"link in 578","links":["3d5f1a6dc5d97e45"],"x":55,"y":420,"wires":[["fceb5104c834de05"]]},{"id":"fceb5104c834de05","type":"function","z":"c999983c9e171848","name":"cover calc","func":"let time_to_aeration = \"time_to_aeration\" in msg ? msg.time_to_aeration : 0\nlet time_to_close = \"time_to_close\" in msg ? msg.time_to_close : 0\nlet time_to_open = \"time_to_open\" in msg ? msg.time_to_open : 0\nlet old_state = msg.old_state\nlet new_state = msg.new_state\nlet msgs = []\n\nif (msg.linked_device) {\n    if (new_state == 100) {\n        msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n\n    } else if (new_state == 0) {\n        msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n    } else if (new_state == 1) {\n        if (old_state == 0) {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: time_to_aeration * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        } else {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n            msgs.push({ delay: (old_state / 100) * time_to_close * 1000 + time_to_aeration * 1000, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: (old_state / 100) * time_to_close * 1000 + time_to_aeration * 1000 + time_to_aeration * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        }\n    } else {\n        let delay = old_state == 0 ? time_to_aeration * 1000 : 0\n        if (old_state < new_state) {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: delay + ((new_state - old_state) / 100) * time_to_open * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        } else {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n            msgs.push({ delay: delay + ((old_state - new_state) / 100) * time_to_close * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        }\n    }\n    return [msgs]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":420,"wires":[["6f730c7abf19721e"]]},{"id":"dbbf9aed3285dd1e","type":"function","z":"c999983c9e171848","name":"notification","func":"let num_covers = msg.num_covers\n\nmsg.notification_id = \"empty_home_cover_status\"\nmsg.alert_type = \"success\"\nmsg.title = (msg.value == 100 ? \"Ouverture\" : \"Fermeture\") + \" des volets\"\nmsg.send_mobile = true\nmsg.override = true\nlet endTxt = \" pendant votre absence\"\n\nif (msg.value == 100) {\n    msg.message = (num_covers == 1 ? \"Le volet s'est ouvert\" : \"Les volets se sont ouverts\") + endTxt\n    return msg\n} else if (msg.value == 0) {\n    msg.message = (num_covers == 1 ? \"Le volet s'est ferm√©\" : \"Les volets se sont ferm√©s\") + endTxt\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":300,"wires":[["d39cb5bbe614d942"]]},{"id":"d39cb5bbe614d942","type":"link out","z":"c999983c9e171848","name":"link out 660","mode":"link","links":["8edaeb40fc5e5069"],"x":855,"y":300,"wires":[]},{"id":"baf48b59c58d6877","type":"function","z":"c999983c9e171848","name":"notification","func":"msg.notification_id = \"empty_home_cover_status\"\nmsg.dismiss = true\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":480,"wires":[["45ae6ac8e35162b4"]]},{"id":"45ae6ac8e35162b4","type":"link out","z":"c999983c9e171848","name":"link out 661","mode":"link","links":["8edaeb40fc5e5069"],"x":355,"y":480,"wires":[]},{"id":"86ebb3f022191c90","type":"function","z":"c999983c9e171848","name":"set home notification","func":"msg.effects = { count: 5, color: 0, saturation: 100, time: 1000 }\nmsg.sound = \"stores_windows.mp3\"\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":300,"wires":[["dcbfc87c55cf683f"]]},{"id":"5173f0ab57b0c5c7","type":"link in","z":"c999983c9e171848","name":"link in 579","links":["b18248552902ebd4"],"x":55,"y":300,"wires":[["b6ab292cd7a367a8"]]},{"id":"b6ab292cd7a367a8","type":"subflow:f884e97a0daa4ce2","z":"c999983c9e171848","name":"","x":170,"y":300,"wires":[["a4cddb356bda222f"],["3fd12f3709b0be01"]]},{"id":"dcbfc87c55cf683f","type":"subflow:3dd3ba0d3b3a0ffd","z":"c999983c9e171848","name":"","x":600,"y":300,"wires":[]},{"id":"ed6dbafa163a421c","type":"link in","z":"c999983c9e171848","name":"link in 580","links":["43b78688a296e686"],"x":55,"y":360,"wires":[["5fae455271848796"]]},{"id":"5fae455271848796","type":"function","z":"c999983c9e171848","name":"cover >","func":"if (msg.entity_id) {\n    msg.search = { \"is\": { linked_window: msg.entity_id } }\n    msg.output_name = \"linkedCover\"\n    msg.output_empty_results = false\n    return msg\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["7ca0b52d490d82fc"]]},{"id":"1019ae214766fd8a","type":"function","z":"c999983c9e171848","name":"cover calc","func":"let stores_status = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\"\nreturn { entity_id: msg.linkedCover[0].entity_id, state: stores_status ? 100 : (msg.new_state == \"on\" ? 100 : 0) }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":360,"wires":[["abe9f293e4d5e085"]]},{"id":"7bd7b0e3e9e58b15","type":"api-call-service","z":"c999983c9e171848","name":"set cover","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"cover","service":"{{service}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":360,"y":420,"wires":[[]]},{"id":"c4a4a0d579af2751","type":"server-state-changed","z":"c999983c9e171848","name":"at_home","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.at_home","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":100,"y":480,"wires":[["baf48b59c58d6877"],[]]},{"id":"7ca0b52d490d82fc","type":"subflow:87a3c75768fca823","z":"c999983c9e171848","name":"","x":255,"y":360,"wires":[["1019ae214766fd8a"]],"l":false},{"id":"6f730c7abf19721e","type":"delay","z":"c999983c9e171848","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":255,"y":420,"wires":[["7bd7b0e3e9e58b15"]],"l":false},{"id":"b18248552902ebd4","type":"link out","z":"c999983c9e171848","name":"link out 662","mode":"link","links":["5173f0ab57b0c5c7"],"x":855,"y":240,"wires":[]},{"id":"d6e091099e4d1bda","type":"link in","z":"c999983c9e171848","name":"link in 581","links":["9372d1fd4b1dea4c","421583ef43524407"],"x":55,"y":240,"wires":[["37fb3d6dc04bfc87"]]},{"id":"74fd5fab259ae129","type":"link in","z":"c999983c9e171848","name":"cover open in template","links":["43b78688a296e686","1ce929ac616df668"],"x":55,"y":620,"wires":[["39287148c3f0b254"]]},{"id":"abe9f293e4d5e085","type":"subflow:2f44a0de1e92d674","z":"c999983c9e171848","name":"","x":510,"y":360,"wires":[]},{"id":"37fb3d6dc04bfc87","type":"function","z":"c999983c9e171848","name":"linked_windows >","func":"msg.search = { \"is\": { entity_id: msg.covers.filter(c => \"linked_window\" in c).map(c => c.linked_window), state: [\"on\", \"off\"] } }\nmsg.output_name = \"linked_windows\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":240,"wires":[["632c46de4405b750"]]},{"id":"632c46de4405b750","type":"subflow:87a3c75768fca823","z":"c999983c9e171848","name":"","x":315,"y":240,"wires":[["0b4186d5be077a04"]],"l":false},{"id":"39287148c3f0b254","type":"function","z":"c999983c9e171848","name":"shutters awaiting ?","func":"let sunAngleCoverOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_day_time\"].state)\nlet at_home = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet sun_attributes = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes\nlet shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\n\nif (at_home && Object.keys(shutter_awaiting).length > 0 && sunAngleCoverOn < sun_attributes.elevation) {\n    if ((msg.state ?? \"\") === \"on\") {\n        let covers = []\n        for (let key of Object.keys(shutter_awaiting)) {\n            if (msg.linked_area === shutter_awaiting[key].linked_area) {\n                covers.push({ template: setTemplateVariables(shutter_awaiting[key].morning_open_if), key: key })\n            }\n        }\n        if (covers.length > 0) {\n            return { linked_area: msg.linked_area, state: \"on\", covers: covers }\n        }\n    }\n}\n\nfunction setTemplateVariables(condition) {\n    if (condition.includes(\"global.\")) {\n        let globals_to_inject = global.keys().filter(g => condition.includes(\"global.\" + g))\n        if (globals_to_inject.length != 0) {\n            let injection = '{% set global = {'\n            for (let g of globals_to_inject) {\n                injection += '\"' + g + '\":' + JSON.stringify(global.get(g) ?? {}) + ','\n            }\n            injection = injection.slice(0, -1)\n            injection += '} %}'\n            condition = injection + condition\n            return condition\n        }\n    } else {\n        return condition\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":620,"wires":[["7b5dd4382014088e"]]},{"id":"d4aec00a745bb2c1","type":"delay","z":"c999983c9e171848","name":"","pauseType":"delayv","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":755,"y":120,"wires":[["912368142ec790db"]],"l":false},{"id":"912368142ec790db","type":"api-call-service","z":"c999983c9e171848","name":"set covers pct","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":120,"wires":[[]]},{"id":"2423b3a6b156835d","type":"function","z":"c999983c9e171848","name":"morning_open_if","func":"let shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\nlet covers = msg.covers\nlet msgs = []\n\nfor (let cover of covers) {\n    if (cover.result === \"True\") {\n        delete shutter_awaiting[cover.key]\n        msgs.push({ delay: 5000, payload: { data: { entity_id: cover.key, value: 100 } } })\n    }\n}\n\nflow.set(\"shutter_awaiting\", shutter_awaiting)\nif (msgs.length > 0) {\n    return [msgs, {}]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":620,"wires":[["8cd00d4ba8a75616"],["a6c1cc0280459efb"]]},{"id":"90fc285811f53013","type":"link out","z":"c999983c9e171848","name":"morning open if","mode":"link","links":["6529c2374eacc338"],"x":705,"y":620,"wires":[]},{"id":"6529c2374eacc338","type":"link in","z":"c999983c9e171848","name":"link in 583","links":["90fc285811f53013"],"x":285,"y":300,"wires":[["86ebb3f022191c90"]]},{"id":"fdfab830ad8accac","type":"comment","z":"c999983c9e171848","name":"cover open in morning check conditions","info":"","x":190,"y":560,"wires":[]},{"id":"0b4186d5be077a04","type":"function","z":"c999983c9e171848","name":"prepare cover","func":"let windows = msg.linked_windows\nlet covers = []\n\nfor (let cover of msg.covers) {\n    covers.push({\n        ...cover,\n        windows_is_closed: (windows.find(a => a.entity_id == cover.linked_window)?.state ?? \"off\") == \"off\",\n        template: setTemplateVariables(cover.morning_open_if ?? \"True\")\n    })\n}\nreturn { value: msg.value, covers: covers }\n\nfunction setTemplateVariables(condition) {\n    if (condition.includes(\"global.\")) {\n        let globals_to_inject = global.keys().filter(g => condition.includes(\"global.\" + g))\n        if (globals_to_inject.length != 0) {\n            let injection = '{% set global = {'\n            for (let g of globals_to_inject) {\n                injection += '\"' + g + '\":' + JSON.stringify(global.get(g) ?? {}) + ','\n            }\n            injection = injection.slice(0, -1)\n            injection += '} %}'\n            condition = injection + condition\n            return condition\n        }\n    } else {\n        return condition\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":240,"wires":[["4f083c6f9241066d"]]},{"id":"bf4e3c8992d24f25","type":"function","z":"c999983c9e171848","name":"set covers","func":"let at_home = global.get('homeassistant').homeAssistant.states[\"input_boolean.at_home\"].state == \"on\"\nlet shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\nlet motion_areas = global.get(\"motion_areas\") ?? {}\nlet value = msg.value\nlet entity_ids = []\n\nfor (let cover of msg.covers) {\n    if (at_home && value == 100) {\n        if ((motion_areas[cover.linked_area] === \"on\" || motion_areas[cover.linked_area] === \"last\") && cover.result === \"True\") {\n            entity_ids.push(cover.entity_id)\n        } else {\n            shutter_awaiting[cover.entity_id] = cover\n            flow.set(\"shutter_awaiting\", shutter_awaiting)\n        }\n    } else if (value == 100 || (value == 0 && cover.windows_is_closed)) {\n        entity_ids.push(cover.entity_id)\n    }\n}\n\nif (entity_ids.length > 0) {\n    return [{ delay: 20000, payload: { data: { entity_id: entity_ids, value: value } } }, { num_covers: entity_ids.length, value: value }]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":240,"wires":[["a50ccce3494c2ce0"],["b18248552902ebd4"]]},{"id":"1276f8f2d35027f9","type":"api-render-template","z":"c999983c9e171848","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"covers.result","resultsLocationType":"msg","templateLocation":"covers.template","templateLocationType":"msg","x":460,"y":120,"wires":[["59359b2699342858"]]},{"id":"81ed760af999f4ac","type":"split","z":"c999983c9e171848","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"covers","x":315,"y":120,"wires":[["ee6d4007d34bbe3b"]],"l":false},{"id":"fc5a248b166dbbbd","type":"join","z":"c999983c9e171848","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":605,"y":120,"wires":[["263b47229f8ad763"]],"l":false},{"id":"ee6d4007d34bbe3b","type":"change","z":"c999983c9e171848","name":"","rules":[{"t":"set","p":"template","pt":"msg","to":"covers.template","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":365,"y":120,"wires":[["1276f8f2d35027f9"]],"l":false},{"id":"59359b2699342858","type":"change","z":"c999983c9e171848","name":"","rules":[{"t":"delete","p":"covers.template","pt":"msg"},{"t":"delete","p":"template","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":555,"y":120,"wires":[["fc5a248b166dbbbd"]],"l":false},{"id":"e32bec79dfe5d012","type":"link in","z":"c999983c9e171848","name":"template","links":[],"x":255,"y":120,"wires":[["81ed760af999f4ac"]]},{"id":"263b47229f8ad763","type":"link out","z":"c999983c9e171848","name":"link out 680","mode":"return","links":[],"x":655,"y":120,"wires":[]},{"id":"7b5dd4382014088e","type":"link call","z":"c999983c9e171848","name":"","links":["e32bec79dfe5d012"],"linkType":"static","timeout":"30","x":360,"y":620,"wires":[["2423b3a6b156835d"]]},{"id":"4f083c6f9241066d","type":"link call","z":"c999983c9e171848","name":"","links":["e32bec79dfe5d012"],"linkType":"static","timeout":"30","x":600,"y":240,"wires":[["bf4e3c8992d24f25"]]},{"id":"8cd00d4ba8a75616","type":"link out","z":"c999983c9e171848","name":"link out 681","mode":"link","links":["ea9bf5de499e1e82"],"x":655,"y":620,"wires":[]},{"id":"ea9bf5de499e1e82","type":"link in","z":"c999983c9e171848","name":"link in 598","links":["8cd00d4ba8a75616","a50ccce3494c2ce0"],"x":705,"y":120,"wires":[["d4aec00a745bb2c1"]]},{"id":"a50ccce3494c2ce0","type":"link out","z":"c999983c9e171848","name":"link out 682","mode":"link","links":["ea9bf5de499e1e82"],"x":855,"y":240,"wires":[]},{"id":"421583ef43524407","type":"link out","z":"c999983c9e171848","name":"link out 60","mode":"link","links":["d6e091099e4d1bda"],"x":745,"y":180,"wires":[]},{"id":"34349b55c4c48809","type":"function","z":"c999983c9e171848","name":"covers >","func":"msg.search = { \"is\": { linked_class: \"cover\" } }\nmsg.output_name = \"covers\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":180,"wires":[["bd573ac90fab3779"]]},{"id":"bd573ac90fab3779","type":"subflow:87a3c75768fca823","z":"c999983c9e171848","name":"","x":695,"y":180,"wires":[["421583ef43524407"]],"l":false},{"id":"dbd4086fcef298c0","type":"function","z":"7cd5e5aaa4574eb4","name":"receive activities states","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state)\nlet action = msg.payload.event.action\nlet persons = msg.persons\n\nfor (let p of persons) {\n    if (action.includes(p.name + \"_\")) {\n        let training = action.split(\"_\")[1]\n        if (activities[p.name]?.[training]?.[2]) {\n            if (activities[p.name][training][0] < activities[p.name][training][1]) {\n                activities[p.name][training][0]++\n            }\n            if (activities[p.name][training][0] == activities[p.name][training][1]) {\n                activities[p.name][training][2] = false\n            }\n\n        }\n    }\n}\n\nmsg.payload = { \"data\": { \"value\": JSON.stringify(activities) } }\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":300,"wires":[["9bdb3424498d6fa1"]]},{"id":"63f515f603df67e0","type":"json","z":"7cd5e5aaa4574eb4","name":"","property":"payload","action":"","pretty":false,"x":590,"y":360,"wires":[["692ee91e103e7833"]]},{"id":"ae17d59bbdcf75e2","type":"catch","z":"7cd5e5aaa4574eb4","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["c7ca60d607e18653"]]},{"id":"377b627e165f8522","type":"subflow:e4503a3be0539251","z":"7cd5e5aaa4574eb4","name":"","x":340,"y":240,"wires":[]},{"id":"f55ae27c65729d07","type":"subflow:759003382b0f7bfd","z":"7cd5e5aaa4574eb4","name":"","x":460,"y":40,"wires":[["ca53cd93cc90a3d7"]]},{"id":"c7ca60d607e18653","type":"change","z":"7cd5e5aaa4574eb4","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"sport","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["f55ae27c65729d07"]]},{"id":"20fbfa2af38d454b","type":"function","z":"7cd5e5aaa4574eb4","name":"notification","func":"msg.title = \"Module sant√©: Activ√©e\"\nmsg.message = msg.payload\nmsg.send_to = msg.persons.filter(p => p.sport).map(p => p.name)\nmsg.send_mobile = true\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":540,"wires":[["f0177332fc1c9e11"]]},{"id":"f0177332fc1c9e11","type":"subflow:e4503a3be0539251","z":"7cd5e5aaa4574eb4","name":"","x":880,"y":540,"wires":[]},{"id":"25b62e3b7d36280a","type":"function","z":"7cd5e5aaa4574eb4","name":"notification","func":"msg.notification_id = \"module_healthy\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module sant√© d√©sactiv√©\"\n    msg.message = \"Module sant√© d√©sactiv√©, vous ne recevrez plus de notifications d'activit√©s\"\n    msg.send_to = msg.persons.filter(p => p.sport).map(p => p.name)\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":480,"wires":[["a040176db3a7fb3c"]]},{"id":"a040176db3a7fb3c","type":"link out","z":"7cd5e5aaa4574eb4","name":"link out 416","mode":"link","links":["8edaeb40fc5e5069"],"x":855,"y":480,"wires":[]},{"id":"9bdb3424498d6fa1","type":"api-call-service","z":"7cd5e5aaa4574eb4","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":710,"y":300,"wires":[[]]},{"id":"d6c2b0e3549d044f","type":"api-call-service","z":"7cd5e5aaa4574eb4","name":"motiv","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_{{payload}}","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":270,"y":480,"wires":[[]]},{"id":"b5e740487b5ae76d","type":"server-events","z":"7cd5e5aaa4574eb4","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":300,"wires":[["a2d7c5b2073bb775"]]},{"id":"a7f770e6b141a864","type":"server-state-changed","z":"7cd5e5aaa4574eb4","name":"json activities","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.json_activities","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":360,"wires":[["351f82b7ac4ceaa5"]]},{"id":"967790438188c67b","type":"server-state-changed","z":"7cd5e5aaa4574eb4","name":"motiv","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":540,"wires":[["aa7ca07af0f4028b"],[]]},{"id":"a0a979b9b3602384","type":"server-state-changed","z":"7cd5e5aaa4574eb4","name":"module_healthy","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_healty","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":480,"wires":[["d6c2b0e3549d044f","65fa1d85aeeaac14"]]},{"id":"e3576d657d2e2676","type":"function","z":"7cd5e5aaa4574eb4","name":"prepare trainings","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state)\nlet random = Math.random() * 100\nlet twd = two_week_day()\nlet persons = msg.persons\nlet msgs = []\n\nfor (let person of persons) {\n\n    if (!activities[person.name]) {\n        activities[person.name] = {}\n        activities[person.name][\"days\"] = 0\n    }\n\n    let objective_calendar = person.sport.objective_calendar\n    let todays_objectives = Object.keys(objective_calendar).filter(a => objective_calendar[a][twd])\n\n    for (let o of Object.keys(objective_calendar)) {\n        if (activities[person.name][o] === undefined) {\n            activities[person.name][o] = [0, 0, false]\n        }\n    }\n\n    let objective_conditions = person.sport.objective_conditions ?? []\n    objective_conditions = validate_objective_conditions(objective_conditions, todays_objectives)\n    todays_objectives = calculate_objective_conditions(objective_conditions, person, todays_objectives)\n\n    let objective_limits = person.sport.objective_limits\n\n    for (let o of todays_objectives) {\n        let translations = \"objective_translations\" in person.sport && o in person.sport.objective_translations ? person.sport.objective_translations[o] : o\n        let todays_objective_limit = []\n\n        activities[person.name][o][1]++\n        activities[person.name][o][2] = true\n\n        if (Array.isArray(objective_limits[o])) {\n            todays_objective_limit = calculate_training(person, objective_limits[o])\n        } else if (typeof objective_limits[o] === \"object\") {\n            for (let keys of Object.keys(objective_limits[o])) {\n                let objectiveName = keys.charAt(0).toUpperCase() + keys.slice(1)\n                todays_objective_limit.push(objectiveName + \": \" + calculate_training(person, objective_limits[o][keys]))\n            }\n            todays_objective_limit = todays_objective_limit.join(\"\\n\")\n        }\n        msgs.push({ objective: { name: o, translations: translations, todays_objective_limit: todays_objective_limit, person: person.name } })\n    }\n    if (activities[person.name][\"days\"] < person.sport.days_to_ojective) {\n        activities[person.name][\"days\"]++\n    }\n}\nmsg = { \"payload\": { \"data\": { \"value\": JSON.stringify(activities) } } }\nreturn [msgs, msg]\n\nfunction validate_objective_conditions(objective_conditions, todays_objectives) {\n    let vp = []\n    for (let p of objective_conditions) {\n        let count = 0\n        for (let w of p.split(\" \")) {\n            if (todays_objectives.includes(w)) {\n                count++\n            }\n        }\n        if (count == 2) {\n            vp.push(p)\n        }\n    }\n    return vp\n}\n\nfunction calculate_objective_conditions(objective_conditions, person, todays_objectives) {\n    for (let p of objective_conditions) {\n        let p_split = p.trim().split(\" \")\n        if (p_split.length == 4 && p_split.includes(\"or\")) {\n            let percentage = p_split[0].replace(\"%\", \"\")\n            todays_objectives = todays_objectives.filter(t => t != (random < parseInt(percentage) ? p_split[3] : p_split[1]))\n        } else if (p_split.length == 3 && p_split.includes(\"to\")) {\n            let percentage = ((person.sport.days_to_ojective - activities[person.name][\"days\"]) / person.sport.days_to_ojective) * 100\n            todays_objectives = todays_objectives.filter(t => t != (random < parseInt(percentage) ? p_split[2] : p_split[0]))\n        }\n    }\n    return todays_objectives\n}\n\nfunction calculate_training(person, objective_limits) {\n    let objective = \"\"\n    if (isNaN(objective_limits[0]) && isNaN(objective_limits[1])) {\n        let min_g_split = objective_limits[0].trim().split(\" \")\n        let max_g_split = objective_limits[1].trim().split(\" \")\n        let percentage = activities[person.name][\"days\"] / person.sport.days_to_ojective\n        objective = parseInt((max_g_split[0] - min_g_split[0]) * percentage + parseInt(min_g_split[0])) + \" \" + max_g_split[1]\n    } else {\n        let min_g = objective_limits[0]\n        let max_g = objective_limits[1]\n        let percentage = activities[person.name][\"days\"] / person.sport.days_to_ojective\n        let serie_number = parseInt(5 + percentage * 3.99)\n        let repetition_number = parseInt(((max_g - min_g) * percentage + min_g) / serie_number)\n        let rest_number = parseInt(((max_g - min_g) * percentage + min_g) % serie_number)\n        objective = repetition_number + \" * \" + serie_number + (rest_number == 0 ? \"\" : \" + \" + rest_number % serie_number)\n    }\n    return objective\n}\n\nfunction two_week_day() {\n    let date = new Date()\n    let p_week = Math.floor((date.getTime() - new Date(date.getFullYear() + \"-01-01\").getTime()) / (1000 * 60 * 60 * 24 * 7)) % 2\n    return (p_week === 0 ? 0 : 7) + (date.getDay() === 0 ? 7 : date.getDay())\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":120,"wires":[["b319ffa018a776b1"],["b58f479881dce246"]]},{"id":"f950641d623ea180","type":"function","z":"7cd5e5aaa4574eb4","name":"send trainings","func":"let title = \"Sport: \" + (msg.objective.todays_objective_limit.length != 0 ? \"une s√©ance de \" + msg.objective.translations + \" est pr√©vue\" : msg.objective.translations)\nlet message = msg.objective.todays_objective_limit.length != 0 ? \"Votre objectif: \\n\" + msg.objective.todays_objective_limit : \"\"\n\nmsg = {\n    title: title,\n    message: message,\n    send_to: [msg.objective.person],\n    send_mobile: true,\n    data: {\n        actions: [{ \"action\": msg.objective.person + \"_\" + msg.objective.name, \"title\": \"Fait avec amour\" }]\n    }\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":240,"wires":[["377b627e165f8522","88443ef46f8cf99b"]]},{"id":"b58f479881dce246","type":"api-call-service","z":"7cd5e5aaa4574eb4","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":870,"y":120,"wires":[[]]},{"id":"a2d7c5b2073bb775","type":"function","z":"7cd5e5aaa4574eb4","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":300,"wires":[["11f49faf560ee920"]]},{"id":"11f49faf560ee920","type":"subflow:87a3c75768fca823","z":"7cd5e5aaa4574eb4","name":"","x":355,"y":300,"wires":[["dbd4086fcef298c0"]],"l":false},{"id":"351f82b7ac4ceaa5","type":"function","z":"7cd5e5aaa4574eb4","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":360,"wires":[["7904b0d184e4d56a"]]},{"id":"7904b0d184e4d56a","type":"subflow:87a3c75768fca823","z":"7cd5e5aaa4574eb4","name":"","x":355,"y":360,"wires":[["67b7e7dd397f868e"]],"l":false},{"id":"aa7ca07af0f4028b","type":"subflow:d42c5135b9bc5f3a","z":"7cd5e5aaa4574eb4","name":"","x":230,"y":540,"wires":[["c9d4f64a7fdc7d4d"]]},{"id":"97fd19c9723885e2","type":"server-state-changed","z":"7cd5e5aaa4574eb4","name":"motivation_reset","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation_reset","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":420,"wires":[["da9069712ace11a2","3edec4cc20d8a1e2"],[]]},{"id":"da9069712ace11a2","type":"api-call-service","z":"7cd5e5aaa4574eb4","name":"motivation_reset off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_reset"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":310,"y":420,"wires":[[]]},{"id":"ea6d4c718216b66d","type":"api-call-service","z":"7cd5e5aaa4574eb4","name":"json activities reset","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"{\"value\":\"{}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":420,"wires":[[]]},{"id":"79129cbe8bdcaf87","type":"server-state-changed","z":"7cd5e5aaa4574eb4","name":"motivation_resend","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation_resend","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"resend","propertyType":"msg","value":"true","valueType":"bool"}],"x":130,"y":180,"wires":[["b4f0d493a0bc3209","78fc362f15c68873"],[]]},{"id":"b4f0d493a0bc3209","type":"api-call-service","z":"7cd5e5aaa4574eb4","name":"motivation_resend off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_resend"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":180,"wires":[[]]},{"id":"18be117d99f9cac5","type":"function","z":"7cd5e5aaa4574eb4","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":180,"wires":[["fa0c0fcc8d76fcfe"]]},{"id":"fa0c0fcc8d76fcfe","type":"subflow:87a3c75768fca823","z":"7cd5e5aaa4574eb4","name":"","x":615,"y":180,"wires":[["39f32b99aa52d1c8"]],"l":false},{"id":"361809a5b5200466","type":"link out","z":"7cd5e5aaa4574eb4","name":"link out 575","mode":"link","links":["41fbfec4aaeeb2f6"],"x":975,"y":120,"wires":[]},{"id":"f16e94795b354ad5","type":"link out","z":"7cd5e5aaa4574eb4","name":"link out 576","mode":"link","links":["41fbfec4aaeeb2f6"],"x":995,"y":180,"wires":[]},{"id":"41fbfec4aaeeb2f6","type":"link in","z":"7cd5e5aaa4574eb4","name":"link in 525","links":["361809a5b5200466","f16e94795b354ad5"],"x":55,"y":240,"wires":[["f950641d623ea180","88443ef46f8cf99b"]]},{"id":"65fa1d85aeeaac14","type":"function","z":"7cd5e5aaa4574eb4","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":480,"wires":[["f6ab874f672d668b"]]},{"id":"f6ab874f672d668b","type":"subflow:87a3c75768fca823","z":"7cd5e5aaa4574eb4","name":"","x":495,"y":480,"wires":[["a631ba93705d1e90"]],"l":false},{"id":"c9d4f64a7fdc7d4d","type":"function","z":"7cd5e5aaa4574eb4","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":540,"wires":[["7aa7754b9f70d978"]]},{"id":"7aa7754b9f70d978","type":"subflow:87a3c75768fca823","z":"7cd5e5aaa4574eb4","name":"","x":475,"y":540,"wires":[["66f8242cd5e17bf3"]],"l":false},{"id":"ca53cd93cc90a3d7","type":"link out","z":"7cd5e5aaa4574eb4","name":"link out 637","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"626db9bda8ef4a69","type":"link in","z":"7cd5e5aaa4574eb4","name":"link in 584","links":["c55ca644e31c56c3","9f443d2836038c51"],"x":55,"y":120,"wires":[["e51af7635401c797"]]},{"id":"e51af7635401c797","type":"api-current-state","z":"7cd5e5aaa4574eb4","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":170,"y":120,"wires":[["5e73ab442401b42b"],[]]},{"id":"5e73ab442401b42b","type":"function","z":"7cd5e5aaa4574eb4","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\", state: \"home\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":120,"wires":[["79838165ebcccb0f"]]},{"id":"79838165ebcccb0f","type":"subflow:87a3c75768fca823","z":"7cd5e5aaa4574eb4","name":"","x":425,"y":120,"wires":[["aef967a933e12ad7"]],"l":false},{"id":"aef967a933e12ad7","type":"function","z":"7cd5e5aaa4574eb4","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":120,"wires":[["e3576d657d2e2676"]]},{"id":"39f32b99aa52d1c8","type":"function","z":"7cd5e5aaa4574eb4","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":180,"wires":[["d516b98795ae8b6b"]]},{"id":"67b7e7dd397f868e","type":"function","z":"7cd5e5aaa4574eb4","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":360,"wires":[["63f515f603df67e0"]]},{"id":"92cbda02a627e204","type":"function","z":"7cd5e5aaa4574eb4","name":"build html activities tab","func":"let activities = msg.payload\nlet persons = msg.persons\nlet html = \"\"\nlet msgs = []\n\nfor (let person of persons) {\n    html += buildHTML(person, activities)\n}\n\nlet gap = 0\nfor (let i = 0; i < 4; i++) {\n    msgs.push({ payload: { data: { entity_id: \"input_text.motivation_\" + (i + 1), value: html.substring(gap, (gap + 254)) } } })\n    gap += 254\n}\nreturn [msgs]\n\nfunction buildHTML(person, activities) {\n    let table = [\"\", \"\"]\n    let percent = [0, 0]\n    let sub_html = \"\"\n    for (let key of Object.keys(person.sport.objective_calendar)) {\n        if (activities[person.name][key]) {\n            table[0] += '<th style=\"width:20%\">' + (person.sport?.objective_translations?.[key] ?? key) + '</th>'\n            table[1] += '<td>' + (activities[person.name][key][0] === activities[person.name][key][1] ? '?' : activities[person.name][key][0] + \"/\" + activities[person.name][key][1]) + '</td>'\n            percent[0] += activities[person.name][key][0]\n            percent[1] += activities[person.name][key][1]\n        }\n    }\n    sub_html += '<center><b>' + 'Sport et sant√© : ' + person.name + \"<b></br>\"\n    sub_html += \"<b>Jour \" + activities[person.name][\"days\"] + \"/\" + person.sport.days_to_ojective + \" : \"\n    sub_html += (percent[1] == 0 ? 0 : parseInt(100 * percent[0] / percent[1])) + '% des objectifs atteints' + '</b></center><hr>'\n    sub_html += '<table style=\"width:100%;text-align:center\"><tr>' + table[0] + '</tr><tr>' + table[1] + '</tr></table>'\n    return sub_html\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":360,"wires":[["8464fb1207f18add"]]},{"id":"a631ba93705d1e90","type":"function","z":"7cd5e5aaa4574eb4","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":480,"wires":[["25b62e3b7d36280a"]]},{"id":"66f8242cd5e17bf3","type":"function","z":"7cd5e5aaa4574eb4","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":540,"wires":[["20fbfa2af38d454b"]]},{"id":"692ee91e103e7833","type":"switch","z":"7cd5e5aaa4574eb4","name":"empty","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":685,"y":360,"wires":[["f1ac6cfbcc15ceb8"],["92cbda02a627e204"]],"l":false},{"id":"9f443d2836038c51","type":"link out","z":"7cd5e5aaa4574eb4","name":"link out 664","mode":"link","links":["626db9bda8ef4a69"],"x":1115,"y":360,"wires":[]},{"id":"d516b98795ae8b6b","type":"function","z":"7cd5e5aaa4574eb4","name":"resend trainings","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state)\nlet twd = two_week_day()\nlet persons = msg.persons\nlet msgs = []\n\nfor (let person of persons) {\n    let person_activities_keys = Object.keys(activities[person.name]).filter(a => a != \"days\")\n    let activities_not_finished = []\n\n    for (let activity of person_activities_keys) {\n        if (activities[person.name][activity][0] != activities[person.name][activity][1]) {\n            activities_not_finished.push({ activity: activity, number: (activities[person.name][activity][1] - activities[person.name][activity][0]) })\n        }\n    }\n\n    let person_day = activities[person.name][\"days\"]\n    let objective_calendar = person.sport.objective_calendar\n    let objective_limits = person.sport.objective_limits\n\n    for (let i = 0; i < activities_not_finished.length; i++) {\n        for (let j = person_day; j > 0; j--) {\n            let day = adjusted_day(twd - (person_day - j))\n            if (\n                activities_not_finished[i][\"number\"] > 0\n                && activities_not_finished[i][\"activity\"] in objective_calendar\n                && objective_calendar[activities_not_finished[i][\"activity\"]][day]\n            ) {\n                activities_not_finished[i][\"number\"]--\n                let activity = activities_not_finished[i][\"activity\"]\n                let translation = \"objective_translations\" in person.sport && activity in person.sport.objective_translations ? person.sport.objective_translations[activity] : activity\n\n                if (Array.isArray(objective_limits[activity]) || objective_limits[activity] === undefined) {\n                    msgs.push(\n                        {\n                            objective: {\n                                name: activity,\n                                translations: translation,\n                                todays_objective_limit: translation + (Array.isArray(objective_limits[activity]) ? \": \" + calculate_training(person, objective_limits[activity], j) : \"\"),\n                                person: person.name\n                            }\n                        }\n                    )\n                } else if (typeof objective_limits[activity] === \"object\") {\n                    let objective_limit = []\n                    for (let keys of Object.keys(objective_limits[activity])) {\n                        let objectiveName = keys.charAt(0).toUpperCase() + keys.slice(1)\n                        objective_limit.push(objectiveName + \": \" + calculate_training(person, objective_limits[activity][keys], j))\n                    }\n                    objective_limit = objective_limit.join(\"\\n\")\n                    msgs.push(\n                        {\n                            objective: {\n                                name: activity,\n                                translations: translation,\n                                todays_objective_limit: objective_limit,\n                                person: person.name\n                            }\n                        }\n                    )\n                }\n            }\n        }\n    }\n}\nreturn [msgs]\n\nfunction adjusted_day(day) {\n    return day < 1 ? adjusted_day(day + 14) : day\n}\n\nfunction calculate_training(person, objective_limits, person_day) {\n    let objective = \"\"\n    if (isNaN(objective_limits[0]) && isNaN(objective_limits[1])) {\n        let min_g_split = objective_limits[0].trim().split(\" \")\n        let max_g_split = objective_limits[1].trim().split(\" \")\n        let percentage = person_day / person.sport.days_to_ojective\n        objective = parseInt((max_g_split[0] - min_g_split[0]) * percentage + parseInt(min_g_split[0])) + \" \" + max_g_split[1]\n    } else {\n        let min_g = objective_limits[0]\n        let max_g = objective_limits[1]\n        let percentage = person_day / person.sport.days_to_ojective\n        let serie_number = parseInt(5 + percentage * 3.99)\n        let repetition_number = parseInt(((max_g - min_g) * percentage + min_g) / serie_number)\n        let rest_number = parseInt(((max_g - min_g) * percentage + min_g) % serie_number)\n        objective = repetition_number + \" * \" + serie_number + (rest_number == 0 ? \"\" : \" + \" + rest_number % serie_number)\n    }\n    return objective\n}\n\nfunction two_week_day() {\n    let date = new Date()\n    let p_week = Math.floor((date.getTime() - new Date(date.getFullYear() + \"-01-01\").getTime()) / (1000 * 60 * 60 * 24 * 7)) % 2\n    return (p_week === 0 ? 0 : 7) + (date.getDay() === 0 ? 7 : date.getDay())\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":180,"wires":[["f16e94795b354ad5"]]},{"id":"8464fb1207f18add","type":"api-call-service","z":"7cd5e5aaa4574eb4","name":"health_stats_","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1010,"y":360,"wires":[[]]},{"id":"88443ef46f8cf99b","type":"debug","z":"7cd5e5aaa4574eb4","name":"debug 2","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":490,"y":240,"wires":[]},{"id":"bbe9e1520c12eade","type":"catch","z":"563661a0890d9e09","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["36238d2adfc8d60d"]]},{"id":"e7da24919b8a3a30","type":"subflow:759003382b0f7bfd","z":"563661a0890d9e09","name":"","x":460,"y":40,"wires":[["72df1d9f4529031d"]]},{"id":"36238d2adfc8d60d","type":"change","z":"563661a0890d9e09","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Updates","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["e7da24919b8a3a30"]]},{"id":"5b213af359d55f79","type":"function","z":"563661a0890d9e09","name":"get node-red addon","func":"let nodeRed = global.get('homeassistant').homeAssistant.states[\"update.node_red_update\"]\n\nif (nodeRed.attributes?.entity_picture) {\n    msg.addon = nodeRed.attributes.entity_picture.replace(\"/api/hassio/addons/\", \"\").replace(\"/icon\", \"\")\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":480,"wires":[["15d4689fd230ee6d","70bbcb56d0dbb3a3"]]},{"id":"05d6f72f49d9909c","type":"exec","z":"563661a0890d9e09","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":590,"y":300,"wires":[["52557276db1b44e2"],[],[]]},{"id":"52557276db1b44e2","type":"switch","z":"563661a0890d9e09","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":720,"y":300,"wires":[["53f381a3ab405514"]]},{"id":"53f381a3ab405514","type":"link out","z":"563661a0890d9e09","name":"link out 428","mode":"link","links":["599172233b02dd90"],"x":815,"y":300,"wires":[]},{"id":"171b1214258d1808","type":"template","z":"563661a0890d9e09","name":"git pull","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cd /\ncd homeassistant\ngit reset --hard HEAD\ngit pull -f https://github.com/lemuriens/combava.git","output":"str","x":470,"y":300,"wires":[["05d6f72f49d9909c"]]},{"id":"f1f60e1c80842745","type":"link out","z":"563661a0890d9e09","name":"link out 429","mode":"link","links":["8edaeb40fc5e5069"],"x":1015,"y":180,"wires":[]},{"id":"cd09a028bf34d0b4","type":"function","z":"563661a0890d9e09","name":"notification","func":"msg.notification_id = \"new_update_available\"\nmsg.title = \"Mise √† jour disponible üéâ\"\nmsg.alert_type = \"success\"\nmsg.message = \"Des nouveaut√©s sont disponibles pour votre maison connect√©e üè†\"\nmsg.data = { actions: [{ \"action\": \"do_update\", \"title\": \"Mettre √† jour\" }] }\nmsg.send_mobile = true\n\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":180,"wires":[["f1f60e1c80842745"]]},{"id":"847f49414f3f05e7","type":"comment","z":"563661a0890d9e09","name":"Github PULL","info":"","x":110,"y":120,"wires":[]},{"id":"4142e7007024c2e5","type":"link in","z":"563661a0890d9e09","name":"link in 436","links":["efb20dc6ef7f6d8a"],"x":55,"y":480,"wires":[["5b213af359d55f79"]]},{"id":"1cacb1b285efab5f","type":"function","z":"563661a0890d9e09","name":"notification","func":"msg.notification_id = \"new_update_available\"\nmsg.dismiss = true\n\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":240,"wires":[["05ae5808716abaef"]]},{"id":"05ae5808716abaef","type":"link out","z":"563661a0890d9e09","name":"link out 431","mode":"link","links":["8edaeb40fc5e5069"],"x":935,"y":240,"wires":[]},{"id":"2492fc7b57ed34b2","type":"link out","z":"563661a0890d9e09","name":"link out 432","mode":"link","links":["32eedbf890b23a0d"],"x":985,"y":240,"wires":[]},{"id":"32eedbf890b23a0d","type":"link in","z":"563661a0890d9e09","name":"link in 437","links":["2492fc7b57ed34b2"],"x":55,"y":300,"wires":[["802f917e13bba0c5"]]},{"id":"802f917e13bba0c5","type":"subflow:4b7531d5c394bfa5","z":"563661a0890d9e09","name":"","x":170,"y":300,"wires":[[],["a92fc0b341532535"]]},{"id":"8f956dd6f8b5cdf9","type":"function","z":"563661a0890d9e09","name":"notification","func":"msg.notification_id = \"module_update\"\n\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module mises √† jour automatique d√©sactiv√©\"\n    msg.message = \"Module mises √† jour automatique d√©sactiv√©, vous recevrez une notification lorsqu'une mise √† jour est disponible.\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":600,"wires":[["5e76dc7eb6b4da39"]]},{"id":"5e76dc7eb6b4da39","type":"link out","z":"563661a0890d9e09","name":"link out 519","mode":"link","links":["8edaeb40fc5e5069"],"x":395,"y":600,"wires":[]},{"id":"c6ea2ad903bd4e2b","type":"link out","z":"563661a0890d9e09","name":"link out 520","mode":"link","links":["be7b745a101d8a7b"],"x":595,"y":180,"wires":[]},{"id":"fa9a5ce8dd91c6a2","type":"link in","z":"563661a0890d9e09","name":"update available on","links":[],"x":55,"y":540,"wires":[["b85ecbb3ee30036b"]]},{"id":"3ec47b7fb12cde40","type":"link out","z":"563661a0890d9e09","name":"update available on","mode":"return","links":[],"x":515,"y":540,"wires":[]},{"id":"7f38351774f7bee5","type":"link call","z":"563661a0890d9e09","name":"","links":["fa9a5ce8dd91c6a2"],"linkType":"static","timeout":"30","x":730,"y":180,"wires":[["cd09a028bf34d0b4"]]},{"id":"d5db0859d21dbed0","type":"link call","z":"563661a0890d9e09","name":"","links":["fa9a5ce8dd91c6a2"],"linkType":"static","timeout":"30","x":470,"y":180,"wires":[["c6ea2ad903bd4e2b"]]},{"id":"be7b745a101d8a7b","type":"link in","z":"563661a0890d9e09","name":"link in 479","links":["c6ea2ad903bd4e2b"],"x":535,"y":240,"wires":[["aed46d5fbb783010"]]},{"id":"b8338ca265fd1a04","type":"switch","z":"563661a0890d9e09","name":"do_update","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"do_update","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":430,"y":240,"wires":[["aed46d5fbb783010"]]},{"id":"599172233b02dd90","type":"link in","z":"563661a0890d9e09","name":"link in 500","links":["53f381a3ab405514"],"x":55,"y":360,"wires":[["87d859b4b6ffe285"]]},{"id":"4b95116a444dad22","type":"link out","z":"563661a0890d9e09","name":"link out 554","mode":"link","links":["6b89006aa13715de"],"x":755,"y":360,"wires":[]},{"id":"354b1ef575e2b4a0","type":"exec","z":"563661a0890d9e09","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":350,"y":360,"wires":[["1b5d804f3e7b7341"],[],[]]},{"id":"87d859b4b6ffe285","type":"template","z":"563661a0890d9e09","name":"check update folder","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cd /\ncd /homeassistant/node-red\nls","output":"str","x":190,"y":360,"wires":[["354b1ef575e2b4a0"]]},{"id":"2340bb4cfe90c445","type":"function","z":"563661a0890d9e09","name":"update exist ?","func":"if (msg.payload.includes(\"flows.json\")) {\n    return [msg, null]\n} else {\n    return [null, msg]\n}\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":360,"wires":[["4b95116a444dad22"],["822d2ae2b6e7b4b2"]]},{"id":"1b5d804f3e7b7341","type":"switch","z":"563661a0890d9e09","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":480,"y":360,"wires":[["2340bb4cfe90c445"]]},{"id":"6b89006aa13715de","type":"link in","z":"563661a0890d9e09","name":"link in 501","links":["4b95116a444dad22"],"x":55,"y":420,"wires":[["4f485f81339bbc50"]]},{"id":"efb20dc6ef7f6d8a","type":"link out","z":"563661a0890d9e09","name":"link out 555","mode":"link","links":["4142e7007024c2e5"],"x":775,"y":420,"wires":[]},{"id":"a3c9880b15d86a1c","type":"template","z":"563661a0890d9e09","name":"replace flows.json","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"mv -f /homeassistant/node-red/flows.json /config","output":"str","x":390,"y":420,"wires":[["26c5080df28adfad"]]},{"id":"26c5080df28adfad","type":"exec","z":"563661a0890d9e09","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":550,"y":420,"wires":[["194f55682d307416"],[],[]]},{"id":"194f55682d307416","type":"switch","z":"563661a0890d9e09","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":680,"y":420,"wires":[["efb20dc6ef7f6d8a"]]},{"id":"21c6d2319f5514a1","type":"link in","z":"563661a0890d9e09","name":"link in 502","links":["822d2ae2b6e7b4b2"],"x":495,"y":480,"wires":[["70bbcb56d0dbb3a3"]]},{"id":"822d2ae2b6e7b4b2","type":"link out","z":"563661a0890d9e09","name":"link out 556","mode":"link","links":["21c6d2319f5514a1"],"x":755,"y":360,"wires":[]},{"id":"cd7313bb0186f3e1","type":"comment","z":"563661a0890d9e09","name":"Move flow.json when updated","info":"","x":160,"y":680,"wires":[]},{"id":"5eb4f588fe5ba204","type":"watch","z":"563661a0890d9e09","name":"watch","files":"/config/flows.json","recursive":"","x":90,"y":740,"wires":[["15ad9e419b85627c"]]},{"id":"550efd8b4bbd79bb","type":"template","z":"563661a0890d9e09","name":"move flows.json","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cp /config/flows.json /homeassistant/node-red/flows.json","output":"str","x":400,"y":740,"wires":[["5ee145da06aeb246"]]},{"id":"5ee145da06aeb246","type":"exec","z":"563661a0890d9e09","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":550,"y":740,"wires":[[],[],[]]},{"id":"15ad9e419b85627c","type":"subflow:4b7531d5c394bfa5","z":"563661a0890d9e09","name":"","x":230,"y":740,"wires":[["550efd8b4bbd79bb"],[]]},{"id":"4f485f81339bbc50","type":"function","z":"563661a0890d9e09","name":"get node-red addon","func":"let nodeRed = global.get('homeassistant').homeAssistant.states[\"update.node_red_update\"]\n\nif (nodeRed.attributes?.entity_picture) {\n    msg.addon = nodeRed.attributes.entity_picture.replace(\"/api/hassio/addons/\", \"\").replace(\"/icon\", \"\")\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":420,"wires":[["a3c9880b15d86a1c"]]},{"id":"282efb33f9d1d355","type":"api-call-service","z":"563661a0890d9e09","name":"update available on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":390,"y":540,"wires":[["3ec47b7fb12cde40"]]},{"id":"15d4689fd230ee6d","type":"api-call-service","z":"563661a0890d9e09","name":"restart node-red","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"hassio","service":"addon_restart","areaId":[],"deviceId":[],"entityId":[],"data":"{\"addon\":\"{{addon}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":480,"wires":[[]]},{"id":"aed46d5fbb783010","type":"api-call-service","z":"563661a0890d9e09","name":"update validated","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":660,"y":240,"wires":[["1cacb1b285efab5f","2492fc7b57ed34b2"]]},{"id":"b85ecbb3ee30036b","type":"api-call-service","z":"563661a0890d9e09","name":"update validated off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":190,"y":540,"wires":[["282efb33f9d1d355"]]},{"id":"70bbcb56d0dbb3a3","type":"api-call-service","z":"563661a0890d9e09","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"homeassistant","service":"restart","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":640,"y":480,"wires":[[]]},{"id":"432ec93113b96c84","type":"api-current-state","z":"563661a0890d9e09","name":"module_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":280,"y":180,"wires":[["d5db0859d21dbed0"],["f0e72aab323e485e"]]},{"id":"641f7a59ba8ac39e","type":"server-events","z":"563661a0890d9e09","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":270,"y":240,"wires":[["b8338ca265fd1a04"]]},{"id":"48e16d656852c4ef","type":"server-state-changed","z":"563661a0890d9e09","name":"github update","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.lemuriens_coconut_latest_commit","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":180,"wires":[["432ec93113b96c84"]]},{"id":"5b2096ba8609d07d","type":"server-state-changed","z":"563661a0890d9e09","name":"module_update","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_update","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":600,"wires":[["8f956dd6f8b5cdf9"]]},{"id":"a7017ab602aa227f","type":"server-state-changed","z":"563661a0890d9e09","name":"make update","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.update_from_lemuriens_coconut","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":240,"wires":[["217182b034268e80"],[]]},{"id":"c10cf3b99e7e5e3d","type":"comment","z":"563661a0890d9e09","name":"Auto update","info":"","x":110,"y":820,"wires":[]},{"id":"a93261ac91c066e4","type":"function","z":"563661a0890d9e09","name":"update >","func":"let entities = global.get(\"homeassistant\").homeAssistant.states\nmsg.search = { \"is\": { entity_id: Object.keys(entities).filter( key => entities[key].entity_id.includes(\"update.\")), state: \"on\" } }\nmsg.output_name = \"entities\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":880,"wires":[["66eb779be4210ae1"]]},{"id":"66eb779be4210ae1","type":"subflow:87a3c75768fca823","z":"563661a0890d9e09","name":"","x":695,"y":880,"wires":[["eeaa4f9a5fe0d9b3"]],"l":false},{"id":"35b0d2020b3b02b0","type":"api-call-service","z":"563661a0890d9e09","name":"install update","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"update","service":"install","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":170,"y":940,"wires":[[]]},{"id":"ca6617cce025209f","type":"api-current-state","z":"563661a0890d9e09","name":"module_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":440,"y":880,"wires":[["a93261ac91c066e4"],[]]},{"id":"ca5c13f457b008e4","type":"subflow:87a3c75768fca823","z":"563661a0890d9e09","name":"","x":115,"y":1000,"wires":[["101793b9bb9c4d38"]],"l":false},{"id":"1d6f35021637d2f0","type":"api-call-service","z":"563661a0890d9e09","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"homeassistant","service":"restart","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":580,"y":1000,"wires":[[]]},{"id":"72df1d9f4529031d","type":"link out","z":"563661a0890d9e09","name":"link out 638","mode":"link","links":["8edaeb40fc5e5069"],"x":595,"y":40,"wires":[]},{"id":"b616cdd42d8cd209","type":"inject","z":"563661a0890d9e09","name":"@2:00","props":[],"repeat":"","crontab":"*/20 2 * * 2","once":false,"onceDelay":0.1,"topic":"","x":120,"y":880,"wires":[["ae425372976e84a7"]]},{"id":"24aa42eb342f7fef","type":"function","z":"563661a0890d9e09","name":"first of month ?","func":"let d = new Date()\nif (d.getDate() == 1 && d.getHours() == 2) {\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":820,"wires":[[]]},{"id":"8654f98635bf0bae","type":"link out","z":"563661a0890d9e09","name":"link out 1","mode":"link","links":["15e961d398775aed"],"x":915,"y":880,"wires":[]},{"id":"15e961d398775aed","type":"link in","z":"563661a0890d9e09","name":"link in 1","links":["8654f98635bf0bae"],"x":55,"y":940,"wires":[["35b0d2020b3b02b0","9c6f287c2802a280"]]},{"id":"ae425372976e84a7","type":"subflow:27aabf8cb913bb7c","z":"563661a0890d9e09","name":"","x":270,"y":880,"wires":[["ca6617cce025209f"]]},{"id":"101793b9bb9c4d38","type":"subflow:27aabf8cb913bb7c","z":"563661a0890d9e09","name":"","x":230,"y":1000,"wires":[["c8fc268ed2df4843"]]},{"id":"a92fc0b341532535","type":"link call","z":"563661a0890d9e09","name":"","links":["a17349585adb4873"],"linkType":"static","timeout":"30","x":330,"y":300,"wires":[["171b1214258d1808"]]},{"id":"c8fc268ed2df4843","type":"link call","z":"563661a0890d9e09","name":"","links":["a17349585adb4873"],"linkType":"static","timeout":"30","x":390,"y":1000,"wires":[["1d6f35021637d2f0"]]},{"id":"9c6f287c2802a280","type":"trigger","z":"563661a0890d9e09","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"500","extend":true,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":340,"y":940,"wires":[["4c672582b7cf70d5"]]},{"id":"4c672582b7cf70d5","type":"link call","z":"563661a0890d9e09","name":"","links":["a17349585adb4873"],"linkType":"static","timeout":"30","x":510,"y":940,"wires":[[]]},{"id":"eeaa4f9a5fe0d9b3","type":"function","z":"563661a0890d9e09","name":"set update","func":"if (msg.entities.length != 0) {\n    //msg = { entity_id: msg.entities[0].entity_id }\n    return [msg.entities.map(e => ({ entity_id: e.entity_id })), null]\n} else {\n    msg.search = { \"is\": { release_summary: \"<ha-alert alert-type='error'>Restart of Home Assistant required</ha-alert>\" } }\n    msg.output_name = \"entities\"\n    msg.output_empty_results = false\n    return [null, msg]\n}\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":880,"wires":[["8654f98635bf0bae"],["4505a62d0d8e74dc"]]},{"id":"98152f2ec5547709","type":"link in","z":"563661a0890d9e09","name":"link in 2","links":["4505a62d0d8e74dc"],"x":55,"y":1000,"wires":[["ca5c13f457b008e4"]]},{"id":"4505a62d0d8e74dc","type":"link out","z":"563661a0890d9e09","name":"link out 17","mode":"link","links":["98152f2ec5547709"],"x":915,"y":880,"wires":[]},{"id":"45b4bc96124b6484","type":"inject","z":"563661a0890d9e09","name":"","props":[],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","x":120,"y":1140,"wires":[["b79ed7887c828cfe"]]},{"id":"b79ed7887c828cfe","type":"function","z":"563661a0890d9e09","name":"first of month ?","func":"let d = new Date()\n\nif (d.getDate() == 1) {\n    let year = d.getFullYear()\n    let month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1)\n    let day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate()\n    let hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\n    let minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n\n    msg.backup_name = \"AutoBackup \" + year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute\n    return msg\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":1140,"wires":[["6b7713341c017558"]]},{"id":"6539b78b983bc092","type":"comment","z":"563661a0890d9e09","name":"Every month backup","info":"","x":130,"y":1080,"wires":[]},{"id":"6b7713341c017558","type":"api-call-service","z":"563661a0890d9e09","name":"launch backup","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"hassio","service":"backup_full","areaId":[],"deviceId":[],"entityId":[],"data":"{\"name\": \"{{backup_name}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":460,"y":1140,"wires":[[]]}]