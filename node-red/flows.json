[{"id":"27148b7bb9f62ac7","type":"tab","label":"Core âœ…","disabled":false,"info":"","env":[]},{"id":"b0a488ea822145cf","type":"tab","label":"Inputs âœ…","disabled":false,"info":"","env":[]},{"id":"b0b353ce861d908b","type":"tab","label":"Presence âœ…","disabled":false,"info":"","env":[]},{"id":"ccf1abe540a3b5a9","type":"tab","label":"Light âœ…","disabled":false,"info":"","env":[]},{"id":"a1ed8ea56c7ba1f9","type":"tab","label":"Temperature âœ…","disabled":false,"info":"","env":[]},{"id":"6838183963219fc9","type":"tab","label":"Heater âœ…","disabled":false,"info":"","env":[]},{"id":"7cc0f49198f44c93","type":"tab","label":"Devices âœ…","disabled":false,"info":"","env":[]},{"id":"eaa696a731a52b23","type":"tab","label":"Alarm âœ…","disabled":false,"info":"","env":[]},{"id":"ab914a2a493ebbf5","type":"tab","label":"Cover âœ…","disabled":false,"info":"","env":[]},{"id":"a62a0ee8573c9b72","type":"tab","label":"Sport âœ…","disabled":false,"info":""},{"id":"22b4130fe1f6a28b","type":"tab","label":"Git âœ…","disabled":false,"info":"","env":[]},{"id":"45b866d1e8e0fc54","type":"subflow","name":"fiesta","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"98ecd81521e7a75e"}]}],"out":[{"x":1100,"y":120,"wires":[{"id":"c6fbfce2784fd3bc","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"d193bde43bd55f9f","type":"subflow","name":"send remote command","info":"","category":"","in":[{"x":60,"y":100,"wires":[{"id":"c5ccf59387c5ac3b"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"386f1888bc94b4c8","type":"subflow","name":"motivation","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"c4c0894d444403e2"}]}],"out":[{"x":420,"y":60,"wires":[{"id":"4c9393d44c603ea8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"5a05b9ac0289ff03","type":"subflow","name":"area light notif","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"7c64a1a9d3b6b65d"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"lightEffect.count (number)"},{"name":"2*","type":"str","value":"lightEffect.rgbs ([[0,1],[0,1]])"}],"meta":{},"color":"#DDAA99"},{"id":"e6ac576fb4598283","type":"subflow","name":"presence ?","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"659ed9ee25a47490"}]}],"out":[{"x":340,"y":40,"wires":[{"id":"659ed9ee25a47490","port":0}]},{"x":340,"y":120,"wires":[{"id":"659ed9ee25a47490","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ba09e97f2ed22f2b","type":"subflow","name":"mobile notification","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"ffcfbc338ee42cc0"}]}],"out":[],"env":[{"name":"1","type":"str","value":"title"},{"name":"2","type":"str","value":"message"},{"name":"3","type":"str","value":"data"}],"meta":{},"color":"#DDAA99"},{"id":"dbf17bea6affd2ec","type":"subflow","name":"home notification","category":"","in":[{"x":60,"y":60,"wires":[{"id":"5ab0339e525685e3"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"msg.speak || msg.sound || msg.link (string)"},{"name":"2","type":"str","value":"msg.linkedArea (string)"},{"name":"3","type":"str","value":"msg.volumeLevel (number)"},{"name":"4","type":"str","value":"lightEffect.count (number)"},{"name":"5","type":"str","value":"lightEffect.rgbs ([[0,1],[0,1]])"}],"meta":{},"color":"#DDAA99"},{"id":"723d4991c3c87385","type":"subflow","name":"change entity state","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"955123ec73074cbf"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"entity_id (string)"},{"name":"2*","type":"str","value":"state (string, number)"}],"meta":{},"color":"#DDAA99"},{"id":"ad3b29a5dd67898f","type":"subflow","name":"send bug to dashboard","info":"","category":"","in":[{"x":60,"y":40,"wires":[{"id":"fcdc38c73bb08769"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"6c4028aab794d52d","type":"subflow","name":"notification","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"78dcc1b1144ecd4f"}]}],"out":[{"x":680,"y":320,"wires":[{"id":"cc379f05a4f6474a","port":0},{"id":"77a3983c5e6305d8","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"10a4bbabe046de0e","type":"subflow","name":"Lights ðŸ”’","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"6a3d5dea1ffbb2d8"}]}],"out":[{"x":280,"y":80,"wires":[{"id":"6a3d5dea1ffbb2d8","port":0}]}],"env":[{"name":"1*","type":"str","value":"msg.lock_lights (array)"},{"name":"2*","type":"str","value":"msg.lock (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"9b9bfdbe9a43dabb","type":"subflow","name":"ambiance","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"d95af1f39bdc2e43"},{"id":"2771cf6f6d945a3d"}]}],"out":[{"x":1060,"y":120,"wires":[{"id":"4c624b837d8ef06c","port":0}]},{"x":620,"y":240,"wires":[{"id":"c83520ded53399c4","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"612068fa04cc8bbd","type":"subflow","name":"cube","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"188d4197be377390"},{"id":"4d0457a2e27a298e"},{"id":"561d43ede593e22a"},{"id":"cd7d9f68a272e2bd"},{"id":"e0a08631094f3a1a"},{"id":"d47393f14d9d896b"},{"id":"22db9e147fb3f0bc"}]}],"out":[{"x":1060,"y":120,"wires":[{"id":"473feda77b747512","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"050c60654a910e68","type":"subflow","name":"waits until","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"1dee8c383dad1dc9"}]}],"out":[{"x":1340,"y":60,"wires":[{"id":"cbbaf5fe1d43c359","port":0}]}],"env":[{"name":"1*","type":"str","value":"waits (array)"},{"name":"2*","type":"str","value":"states (array)"},{"name":"3*","type":"str","value":"timeoutSeconds (number) seconds"},{"name":"4","type":"str","value":"sendOnTimeout (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"7166242293a03ec9","type":"subflow","name":"ambiances","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"f51dc77777d8f60b"}]}],"out":[{"x":800,"y":60,"wires":[{"id":"907c1f317e2ca3ee","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"515fe2385f553c95","type":"subflow","name":"dev enable","info":"","category":"","in":[{"x":80,"y":80,"wires":[{"id":"68969b8280827750"}]}],"out":[{"x":320,"y":40,"wires":[{"id":"68969b8280827750","port":0}]},{"x":320,"y":120,"wires":[{"id":"68969b8280827750","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"94b2243985840d69","type":"subflow","name":"config loaded","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"febc11290421c3af"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"20c20fc427292f9a","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"3da7ebfd83a38899","type":"subflow","name":"get entities","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"466e65d315aca28f"}]}],"out":[{"x":300,"y":60,"wires":[{"id":"466e65d315aca28f","port":0}]}],"env":[{"name":"1*","type":"str","value":"msg.search = { \"is\": { linkedClass: \"\" }, \"not\": { linkedArea: \"\" }}"},{"name":"2*","type":"str","value":"msg.output_name (string)"},{"name":"3","type":"str","value":"msg.outputEmptyResults (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"a9fcbb2aa70ea1f8","type":"junction","z":"9b9bfdbe9a43dabb","x":360,"y":180,"wires":[["52d03fb81f2ee80c"]]},{"id":"0cdd3aae865a31cf","type":"junction","z":"9b9bfdbe9a43dabb","x":360,"y":180,"wires":[["9e5c408e79ac1df8"]]},{"id":"4a0d1a73e7adcc11","type":"junction","z":"050c60654a910e68","x":740,"y":60,"wires":[["a71b128c6a11f16e","4095fa2ccd977940"]]},{"id":"5ff166ae2792d64c","type":"junction","z":"050c60654a910e68","x":280,"y":60,"wires":[["87d844bd45fccde6","1ac121c8d607267c","1d64b1cbe71c8c65","9c265cc1eaad53bb","69317bea361bf45e","9d50472878b093d6","ab3f5f1f4b645507","9147624e46fd3b8b","e6e0a2f4b0faf93f","af650c007ffa4b39"]]},{"id":"e35423a2a82f9168","type":"junction","z":"ccf1abe540a3b5a9","x":200,"y":680,"wires":[["e904c7abdbd0b8c2"]]},{"id":"0ad2fc52e05f884f","type":"junction","z":"b0b353ce861d908b","x":340,"y":820,"wires":[["85e70ba4e021ee27"]]},{"id":"1734e70678e4e3fe","type":"junction","z":"050c60654a910e68","x":740,"y":600,"wires":[["a71b128c6a11f16e","263cb54347d897c3"]]},{"id":"ba726f260be33a59","type":"junction","z":"6838183963219fc9","x":420,"y":500,"wires":[["41f642fb8e8c5b67"]]},{"id":"3f3fa09655239c17","type":"junction","z":"7cc0f49198f44c93","x":220,"y":240,"wires":[["85453006e9fb8796"]]},{"id":"a7fa1e89e29b2bc7","type":"junction","z":"6838183963219fc9","x":400,"y":440,"wires":[["fa233988bc49c813"]]},{"id":"dc40d6ce64930b70","type":"junction","z":"22b4130fe1f6a28b","x":380,"y":180,"wires":[["19c209fee8b092e0"]]},{"id":"bcb6e13c9c4fbcd1","type":"junction","z":"22b4130fe1f6a28b","x":200,"y":240,"wires":[["73e582bba532abcd"]]},{"id":"c18b36325001bf4a","type":"junction","z":"b0a488ea822145cf","x":520,"y":1100,"wires":[["a54be99d7e32ea7c"]]},{"id":"c1b4a74898adacf9","type":"junction","z":"b0a488ea822145cf","x":360,"y":1280,"wires":[["1988e93c3898f2f1"]]},{"id":"e70a19df90211863","type":"junction","z":"b0a488ea822145cf","x":720,"y":2060,"wires":[["09937216bea66806"]]},{"id":"8356eb9f76953cee","type":"junction","z":"a62a0ee8573c9b72","x":680,"y":120,"wires":[["bb407002bae6b6ca"]]},{"id":"de709106b8d2cfce","type":"junction","z":"22b4130fe1f6a28b","x":960,"y":880,"wires":[["04a21079abd782c3"]]},{"id":"d38f23be4a30a1a5","type":"junction","z":"a62a0ee8573c9b72","x":220,"y":420,"wires":[["9a89420de8a81170"]]},{"id":"6acff092435169c4","type":"junction","z":"723d4991c3c87385","x":260,"y":60,"wires":[["dfbaefd1c674da97"]]},{"id":"a457c8d35dfc8615","type":"junction","z":"ccf1abe540a3b5a9","x":300,"y":560,"wires":[["5c0f984284cf4901"]]},{"id":"36b84b9dab98a0da","type":"junction","z":"ccf1abe540a3b5a9","x":200,"y":680,"wires":[["ba41fb78ceeafe6f"]]},{"id":"986aea1e2d4e40b4","type":"junction","z":"ab914a2a493ebbf5","x":720,"y":240,"wires":[["15085a2365082a87"]]},{"id":"550b06927527c0dd","type":"junction","z":"ab914a2a493ebbf5","x":260,"y":300,"wires":[["a861d8b07880a2e2"]]},{"id":"d045d0c546a546e9","type":"junction","z":"ab914a2a493ebbf5","x":260,"y":300,"wires":[["3580dd15a74a7655"]]},{"id":"77a3983c5e6305d8","type":"junction","z":"6c4028aab794d52d","x":460,"y":320,"wires":[[]]},{"id":"9f015d9ba8390d6a","type":"junction","z":"6c4028aab794d52d","x":380,"y":60,"wires":[["1fbb7266d0e73a79"]]},{"id":"e8a0ba8788bb4826","type":"junction","z":"dbf17bea6affd2ec","x":600,"y":60,"wires":[["12154ca5df7d4b6b"]]},{"id":"d6384158d1057d71","type":"junction","z":"ab914a2a493ebbf5","x":200,"y":680,"wires":[["b930ded2b8ae45b5"]]},{"id":"427fd541dd46ad75","type":"junction","z":"ab914a2a493ebbf5","x":200,"y":680,"wires":[["b930ded2b8ae45b5"]]},{"id":"0b411c88122945f7","type":"junction","z":"7cc0f49198f44c93","x":260,"y":880,"wires":[["15881f186e9438e4"]]},{"id":"8bd3df340156900b","type":"junction","z":"dbf17bea6affd2ec","x":260,"y":60,"wires":[["33ad227bfc1b9b09"]]},{"id":"5b871c278cf602d0","type":"junction","z":"6838183963219fc9","x":280,"y":240,"wires":[["9d1e5df180bb1596"]]},{"id":"4c20a88f1a58c0a4","type":"junction","z":"b0b353ce861d908b","x":380,"y":880,"wires":[["97c66cf174fed278"]]},{"id":"6fcc90afe37c1372","type":"junction","z":"b0b353ce861d908b","x":560,"y":440,"wires":[["8eda5f8be1dcd3c4"]]},{"id":"42ceba1752ad2698","type":"junction","z":"ccf1abe540a3b5a9","x":240,"y":240,"wires":[["49b3e170b0b637a8"]]},{"id":"c87720f17866318d","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":": ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"7a18c237972bcf43","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":180,"wires":[["8bbee7aff9df337b"],["3328bb299530086c"],["736a0410bcd8ae28"]]},{"id":"c5e5dade2d8140b4","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":180,"wires":[["5dd95791799ca37b"]]},{"id":"736a0410bcd8ae28","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":180,"wires":[["85745f1699b5c18e"]]},{"id":"8bbee7aff9df337b","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"3328bb299530086c","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"a83b97572d7d81f3","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":240,"wires":[["a0af6d11261c8245"],["0c7c59e3d8e89133"],["11ed8405127209f9"]]},{"id":"9c31e38fbb598b9a","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":240,"wires":[["22996ffd4a03399c"]]},{"id":"11ed8405127209f9","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":240,"wires":[["dc43b5238775a1c7"]]},{"id":"a0af6d11261c8245","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"0c7c59e3d8e89133","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"9abb48c1a30a264f","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":300,"wires":[["ae562aa50f38b5c1"],["ca0da4b4f2a9f926"],["37946ec5a90342b0"]]},{"id":"e352f2f493e78666","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":300,"wires":[["ad517bdb76093d29"]]},{"id":"37946ec5a90342b0","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":300,"wires":[["18d209c95e946af2"]]},{"id":"ae562aa50f38b5c1","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"ca0da4b4f2a9f926","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"79c26f95e1cffa41","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":160,"y":420,"wires":[["dcc43a0ba67ca8f2"]]},{"id":"36a443ae8864fe22","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":500,"y":120,"wires":[["492d3827b1f374f5","5dd95791799ca37b","22996ffd4a03399c","ad517bdb76093d29","eb7401127697b790"]]},{"id":"bec62ca95cc7c391","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":360,"wires":[["60038b3d5cff3f0a"],["c6e379682bf1b67c"],["69d2dddeafe9375e"]]},{"id":"e85165b20cb8f18a","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":460,"y":360,"wires":[["eb7401127697b790"]]},{"id":"69d2dddeafe9375e","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":360,"wires":[["06bc846f2668d898"]]},{"id":"60038b3d5cff3f0a","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"c6e379682bf1b67c","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"5dd95791799ca37b","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":180,"wires":[["51932102dd30e869"]]},{"id":"22996ffd4a03399c","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":240,"wires":[["7efe2fb84b3d3a4f"]]},{"id":"ad517bdb76093d29","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":300,"wires":[["a6fd8d7d346e0c34"]]},{"id":"eb7401127697b790","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["28f8e10fcd63a3c6"]]},{"id":"6dbf52fb74e0857d","type":"api-call-service","z":"45b866d1e8e0fc54","name":"stores off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.cover_chambre","input_boolean.cover_salon"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":360,"y":120,"wires":[[]]},{"id":"45f3c97a1fca2055","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":180,"wires":[[]]},{"id":"ebeb76171ceafd2c","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":240,"wires":[[]]},{"id":"03765334b3c696a4","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":300,"wires":[[]]},{"id":"dcc43a0ba67ca8f2","type":"api-call-service","z":"45b866d1e8e0fc54","name":"fiesta off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.fiesta"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":300,"y":420,"wires":[[]]},{"id":"c6fbfce2784fd3bc","type":"api-call-service","z":"45b866d1e8e0fc54","name":"stores on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.cover_chambre","input_boolean.cover_salon"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1000,"y":120,"wires":[[]]},{"id":"4b39d9ca89a69090","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":360,"wires":[[]]},{"id":"98ecd81521e7a75e","type":"api-call-service","z":"45b866d1e8e0fc54","name":"some autolights off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.light_ambilight","input_boolean.light_bandeau_cuisine","input_boolean.light_bureau","input_boolean.light_cuisine","input_boolean.light_deco"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":190,"y":60,"wires":[["908ae564e4806fdd"]]},{"id":"908ae564e4806fdd","type":"api-call-service","z":"45b866d1e8e0fc54","name":"some lights off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.light_salon","light.light_bandeau_cuisine"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":60,"wires":[["79c26f95e1cffa41","bee3e8cd6c6da8e3"]]},{"id":"51932102dd30e869","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":180,"wires":[["c5e5dade2d8140b4","7a18c237972bcf43"],[]]},{"id":"7efe2fb84b3d3a4f","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":240,"wires":[["9c31e38fbb598b9a","a83b97572d7d81f3"],[]]},{"id":"a6fd8d7d346e0c34","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":300,"wires":[["e352f2f493e78666","9abb48c1a30a264f"],[]]},{"id":"bee3e8cd6c6da8e3","type":"api-current-state","z":"45b866d1e8e0fc54","name":"stores status on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stores_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":190,"y":120,"wires":[["36a443ae8864fe22","6dbf52fb74e0857d"],["492d3827b1f374f5"]]},{"id":"c6a33b1ccb3eb6fc","type":"api-current-state","z":"45b866d1e8e0fc54","name":"stores status on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stores_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":830,"y":120,"wires":[["c6fbfce2784fd3bc"],[]]},{"id":"28f8e10fcd63a3c6","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":360,"wires":[["e85165b20cb8f18a","bec62ca95cc7c391"],[]]},{"id":"18d209c95e946af2","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_bureau","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1290,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"06bc846f2668d898","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_cuisine","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1290,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"85745f1699b5c18e","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_deco","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1280,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"dc43b5238775a1c7","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_ambilight","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1300,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"492d3827b1f374f5","type":"ha-wait-until","z":"45b866d1e8e0fc54","name":"wait fiesta off","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"input_boolean.fiesta","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"3","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":650,"y":120,"wires":[["c6a33b1ccb3eb6fc"],["c6a33b1ccb3eb6fc"]]},{"id":"c5ccf59387c5ac3b","type":"function","z":"d193bde43bd55f9f","name":"prepare remote","func":"let linkedDevice = msg.linkedDevice;\nlet entity_id = msg.entity_id;\nlet new_state = msg.new_state;\nlet old_state = msg.old_state;\nlet remote = msg.remote;\nlet msgs = [];\n\nif (\"increase\" in remote && \"decrease\" in remote) {\n    let diff = new_state - old_state;\n    setStateMsgs({ \"num_repeats\": Math.abs(diff), \"command\": (diff < 0 ? remote[\"decrease\"] : remote[\"increase\"]) });\n    return [msgs, null];\n} else if (new_state in remote) {\n    setStateMsgs(remote[new_state]);\n    return [msgs, \"off\" in remote ? null : { \"state\": \"off\" }];\n}\n\nfunction setStateMsgs(remote_state) {\n    if (\"command\" in remote_state && remote_state.command.startsWith(\"b64:\")){\n        let num_repeats = \"num_repeats\" in remote_state ? remote_state.num_repeats : 0;\n        let delay_secs = \"delay_secs\" in remote_state ? remote_state.delay_secs : 0\n        msgs.push({\n            payload: {\n                data: {\n                    entity_id: linkedDevice,\n                    command: remote_state.command,\n                    num_repeats: num_repeats,\n                    delay_secs: delay_secs\n                }\n            }\n        });\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":100,"wires":[["7668c6d3666d5662"],["242576b45e519b85"]]},{"id":"242576b45e519b85","type":"subflow:723d4991c3c87385","z":"d193bde43bd55f9f","name":"","x":390,"y":140,"wires":[]},{"id":"7668c6d3666d5662","type":"api-call-service","z":"d193bde43bd55f9f","name":"send command to remote","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"remote","service":"send_command","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":410,"y":60,"wires":[[]]},{"id":"4c9393d44c603ea8","type":"function","z":"386f1888bc94b4c8","name":"motivation","func":"switch (msg.payload) {\n  case 1:\n    msg.payload = \"Personne nâ€™est trop vieux pour se fixer un nouvel objectif ou rÃ©aliser de nouveaux rÃªves. â€“ Les Brown\";\n    break;\n  case 2:\n    msg.payload = \"La seule faÃ§on de faire du bon travail est dâ€™aimer ce que vous faites. Si vous nâ€™avez pas encore trouvÃ©, continuez Ã  chercher. - Steve Jobs\";\n    break;\n  case 3:\n    msg.payload = \"Pour rÃ©ussir, votre dÃ©sir de rÃ©ussite doit Ãªtre plus grand que votre peur de lâ€™Ã©chec. - Bill Cosby\";\n    break;\n  case 4:\n    msg.payload = \"Un Ã©norme succÃ¨s est la meilleure des vengeances. - Frank Sinatra\";\n    break;\n  case 5:\n    msg.payload = \"Je suis reconnaissant Ã  tous ceux qui mâ€™ont dit NON. Câ€™est Ã  grÃ¢ce Ã  eux que je suis moi-mÃªme. - Albert Einstein\";\n    break;\n  case 6:\n    msg.payload = \"La seule chose qui se dresse entre vous et votre rÃªve, câ€™est la volontÃ© dâ€™essayer et la conviction quâ€™il est rÃ©ellement possible. - Joel Brown\";\n    break;\n  case 7:\n    msg.payload = \"Un pessimiste voit la difficultÃ© dans chaque opportunitÃ©, un optimiste voit lâ€™opportunitÃ© dans chaque difficultÃ©. - Winston Churchill\";\n    break;\n  case 8:\n    msg.payload = \"Le succÃ¨s câ€™est dâ€™aller dâ€™Ã©chec en Ã©chec sans perdre son enthousiasme. - Winston Churchill\";\n    break;\n  case 9:\n    msg.payload = \"Le succÃ¨s nâ€™est pas la clÃ© du bonheur. Le bonheur est la clÃ© du succÃ¨s. Si vous aimez ce que vous faites, vous rÃ©ussirez. - Albert Schweitzer\";\n    break;\n  case 10:\n    msg.payload = \"Les gagnants trouvent des moyens, les perdants des excuses. -  F. D. Roosevelt\";\n    break;\n  case 11:\n    msg.payload = \"Celui qui attend que tout danger soir Ã©cartÃ© pour mettre les voiles ne prendra jamais la mer. - Thomas Fuller\";\n    break;\n  case 12:\n    msg.payload = \"Ce nâ€™est pas parce que les choses sont difficiles que nous nâ€™osons pas, câ€™est parce que nous nâ€™osons pas quâ€™elles sont difficiles. -  SÃ©nÃ¨que\";\n    break;\n  case 13:\n    msg.payload = \"Certains veulent que Ã§a arrive, dâ€™autres aimeraient que Ã§a arrive et dâ€™autres font que Ã§a arrive. - Michael Jordan\";\n    break;\n  case 14:\n    msg.payload = \"La plus grande erreur que puisse faire un homme est dâ€™avoir peur dâ€™en faire une. - Elbert Hubbard\";\n    break;\n  case 15:\n    msg.payload = \"Le gÃ©nie est fait dâ€™un pour cent dâ€™inspiration et de quatre-vingt-dix-neuf pour cent de transpiration. - Thomas Edison\";\n    break;\n  case 16:\n    msg.payload = \"Ce nâ€™est pas le vent qui dÃŒ cide de votre destination, câ€™est lâ€™orientation que vous donnez Ã  votre voile. Le vent est pareil pour tous. - Jim Rohn\";\n    break;\n  case 17:\n    msg.payload = \"Lâ€™humanitÃ© se divise en trois catÃ©gories : ceux qui ne peuvent pas bouger, ceux qui peuvent bouger, et ceux qui bougent. - Benjamin Franklin\";\n    break;\n  case 18:\n    msg.payload = \"Dans vingt ans vous serez plus dÃ©Ã§us par les choses que vous nâ€™avez pas faites que par celles que vous avez faites. Alors sortez des sentiers battus. Mettez les voiles. Explorez. RÃªvez. DÃ©couvrez. - Mark Twain\";\n    break;\n  case 19:\n    msg.payload = \"Il nâ€™y a pas de rÃ©ussites faciles ni dâ€™Ã©checs dÃ©finitifs. - Marcel Proust\";\n    break;\n  case 20:\n    msg.payload = \"Jâ€™ai dÃ©cidÃ© dâ€™Ãªtre heureux parce que câ€™est bon pour la santÃ©. - Voltaire\";\n    break;\n  case 21:\n    msg.payload = \"Celui qui veut atteindre un objectif lointain doit faire de petits pas. - Saul Bellow\";\n    break;\n  case 22:\n    msg.payload = \"La plupart des choses importantes dans le monde ont Ã©tÃ© accomplies par des personnes qui ont continuÃ© Ã  essayer quand il semblait y avoir aucun espoir. - Dale Carnegie\";\n    break;\n  case 23:\n    msg.payload = \"Pour rÃ©ussir, retenez bien ces trois maximes: voir câ€™est savoir, vouloir câ€™est pouvoir, oser câ€™est avoir. - Alfred de Musset\";\n    break;\n  case 24:\n    msg.payload = \"Les chanceux sont ceux qui arrivent Ã  tout ; Les malchanceux, ceux Ã  qui tout arrive. - EugÃ¨ne Labiche\";\n    break;\n  case 25:\n    msg.payload = \"Pour ce qui est de lâ€™avenir, il ne sâ€™agit pas de le prÃ©voir, mais de le rendre possible. - Antoine de Saint-ExupÃ©ry\";\n    break;\n  case 26:\n\tmsg.payload = \"Il faut viser la lune, parce quâ€™au moins, si vous Ã©chouez, vous finirez dans les Ã©toiles. - Oscar Wilde\";\n\tbreak;\n  case 27:\n\tmsg.payload = \"La meilleure faÃ§on de prÃ©dire lâ€™avenir est de le crÃ©er. - Peter Drucker\";\n\tbreak;\n  case 28:\n\tmsg.payload = \"Le dÃ©sir de bien faire est un puissant moteur. Celui de faire du bien est plus puissant encore. - Michael Aguilar\";\n\tbreak;\n  case 29:\n\tmsg.payload = \"Croyez en vos rÃªves et ils se rÃ©aliseront peut-Ãªtre. Croyez en vous et ils se rÃ©aliseront sÃ»rement. - Martin Luther King\";\n\tbreak;\n  case 30:\n\tmsg.payload = \"Vous ne trouverez jamais ce que vous ne cherchez pas. - Confucius\";\n\tbreak;\n  case 31:\n\tmsg.payload = \"Si vous pensez que vous ne valez pas grand-chose, vous ne trouverez personne pour augmenter votre prix. - Michael Aguilar\";\n\tbreak;\n  case 32:\n\tmsg.payload = \"La sagesse suprÃªme, câ€™est dâ€™avoir des rÃªves assez grands pour ne pas les perdre de vue pendant quâ€™on les poursuit. - Francis Scott Fitzgerald\";\n\tbreak;\n  case 33:\n\tmsg.payload = \"Si vous pouvez le rÃªver, vous pouvez le faire. - Walt Disney\";\n\tbreak;\n  case 34:\n\tmsg.payload = \"Notre vie vaut ce quâ€™elle nous a coÃ»tÃ© dâ€™efforts. - FranÃ§ois Mauriac\";\n\tbreak;\n  case 35:\n\tmsg.payload = \"Ce sont nos choix qui montrent qui nous sommes, bien  plus que nos capacitÃ©s. - Joanne K.Rowling\";\n\tbreak;\n  case 36:\n\tmsg.payload = \"On peut tout ce qui ne dÃ©pende que de notre volontÃ©. - Marcel Proust\";\n\tbreak;\n  case 37:\n\tmsg.payload = \"Le but de la vie, ce nâ€™est pas lâ€™espoir de devenir parfait, câ€™est la volontÃ© dâ€™Ãªtre toujours meilleur. - Ralph Waldo Emerson\";\n\tbreak;\n  case 38:\n\tmsg.payload = \"La persÃ©vÃ©rance, câ€™est ce qui rend lâ€™impossible possible, le possible probable et le probable rÃ©alisÃŒ . - LÃ©on Trotsky\";\n\tbreak;\n  case 39:\n\tmsg.payload = \"Il nâ€™y a quâ€™une faÃ§on dâ€™Ã©chouer, câ€™est dâ€™abandonner avant dâ€™avoir rÃ©ussi. - Georges ClÃ©menceau\";\n\tbreak;\n  case 40:\n\tmsg.payload = \"Rien de grand ne sâ€™est accompli sans passion. - Hegel\";\n\tbreak;\n  case 41:\n\tmsg.payload = \"Ne craignez pas la perfection, vous nâ€™y parviendrez jamais. - Salvador Dali\";\n\tbreak;\n  case 42:\n\tmsg.payload = \"Il vaut mieux exceller dans une seule discipline plutÃ´t que dâ€™Ãªtre mÃ©diocre dans plusieurs. - Proverbe latin\";\n\tbreak;\n  case 43:\n\tmsg.payload = \"En suivant le chemin qui sâ€™appelle plus tard, nous arrivons sur la place qui sâ€™appelle jamais. - SÃ©nÃ·  que\";\n\tbreak;\n  case 44:\n\tmsg.payload = \"La vie est comme une bicyclette, il faut avancer pour ne pas perdre lâ€™Ã©quilibre. - Albert Einstein\";\n\tbreak;\n  case 45:\n\tmsg.payload = \"Les portes de lâ€™avenir sont ouvertes Ã  ceux qui savent les pousser. - Coluche\";\n\tbreak;\n  case 46:\n\tmsg.payload = \"Le monde nâ€™a progressÃ© que grÃ¢ce aux choses impossibles qui ont Ã©tÃ© rÃ©alisÃ©es. - AndrÃ© Maurois\";\n\tbreak;\n  case 47:\n\tmsg.payload = \"Les obstacles sont ces choses effrayantes que vous apercevez lorsque vous dÃ©tournez les yeux de vos objectifs. - Henry Ford\";\n\tbreak;\n  case 48:\n\tmsg.payload = \"Pour pouvoir contempler un arc-en-ciel, il faut dâ€™abord endurer la pluie. - Proverbe chinois\";\n\tbreak;\n  case 49:\n\tmsg.payload = \"Commencez par changer en vous ce que vous voulez changer autour de vous. - Gandhi\";\n\tbreak;\n  case 50:\n\tmsg.payload = \"La folie, câ€™est de refaire la mÃªme chose et dâ€™en attendre un rÃ©sultat diffÃ©rent. - Albert Einstein\";\n\tbreak;\n  case 51:\n\tmsg.payload = \"Agissez toujours comme sâ€™il Ã©tait impossible dâ€™Ã©chouer. - Winston Churchill\";\n\tbreak;\n  case 52:\n\tmsg.payload = \"Il est difficile dâ€™Ã©chouer. Mais il est encore plus difficile de ne pas avoir essayÃ© de rÃ©ussir. - ThÃ©odore Roosevelt\";\n\tbreak;\n  case 53:\n\tmsg.payload = \"Se lamenter sur un malheur passÃ©, voilÃ  le plus sÃ»r moyen dâ€™en attirer un autre. - William Shakespeare\";\n\tbreak;\n  case 54:\n\tmsg.payload = \"Lâ€™Ã©chec nâ€™est quâ€™une opportunitÃ© pour recommencer la mÃªme chose plus intelligemment. - Henry Ford\";\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":60,"wires":[[]]},{"id":"c4c0894d444403e2","type":"random","z":"386f1888bc94b4c8","name":"random","low":"1","high":"54","inte":"true","property":"payload","x":160,"y":60,"wires":[["4c9393d44c603ea8"]]},{"id":"a538488abfbc0b01","type":"function","z":"5a05b9ac0289ff03","name":"area lights >","func":"msg.search = { \"is\": { linkedClass: \"light\", linkedArea: msg.linkedArea, state: [\"on\", \"off\"] } };\nmsg.output_name = \"lights\";\nmsg.outputEmptyResults = false;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":60,"wires":[["b9ccc3ac550bca5a"]]},{"id":"7c64a1a9d3b6b65d","type":"subflow:e6ac576fb4598283","z":"5a05b9ac0289ff03","name":"","x":170,"y":60,"wires":[["6a1d9afcde9acf83"],[]]},{"id":"6a1d9afcde9acf83","type":"function","z":"5a05b9ac0289ff03","name":"lightEffect ?","func":"let count_check = msg.lightEffect?.count;\nlet rgbs_check = msg.lightEffect?.rgbs;\n\nif (\n    typeof count_check === \"number\" && count_check > 0\n    && Array.isArray(rgbs_check) && rgbs_check.length == 2\n    && Array.isArray(rgbs_check[0]) && rgbs_check[0].length == 3\n    && Array.isArray(rgbs_check[1]) && rgbs_check[1].length == 3\n) {\n\n    let motion_areas = global.get(\"motion_areas\") || {};\n    let msgs = [];\n\n    Object.entries(motion_areas).forEach(([key, value]) => {\n        if (value != \"off\") {\n            msgs.push({ linkedArea: key, lightEffect: msg.lightEffect });\n        }\n    });\n\n    return [msgs];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":60,"wires":[["a538488abfbc0b01"]]},{"id":"b9ccc3ac550bca5a","type":"subflow:3da7ebfd83a38899","z":"5a05b9ac0289ff03","name":"","x":650,"y":60,"wires":[["881be9a5cfa86443"]]},{"id":"fef658347901a9a1","type":"api-call-service","z":"5a05b9ac0289ff03","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_{{service}}","areaId":[],"deviceId":[],"entityId":["{{light}}"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":990,"y":60,"wires":[[]]},{"id":"2125dfb6b2bda172","type":"delay","z":"5a05b9ac0289ff03","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":895,"y":60,"wires":[["fef658347901a9a1"]],"l":false},{"id":"881be9a5cfa86443","type":"function","z":"5a05b9ac0289ff03","name":"set lights","func":"let locked_lights = global.get(\"locked_lights\") ?? [];\nlet lights = msg.lights;\nlet msgs = [];\n\nfor (let light of lights) {\n    let supported_color_modes = light?.attributes?.supported_color_modes ?? [];\n    let color_modes = [\"hs\", \"rgb\", \"xy\", \"color_temp\"];\n    let support_color = (color_modes.find(a => supported_color_modes.includes(a)) ?? false);\n\n    if (support_color && (!(locked_lights.includes(light.entity_id)) || locked_lights.includes(light.entity_id) && light.state === \"on\")) {\n        let message = {};\n        \n        for (let i = 0, j = msg.lightEffect.count * 2 - 1; i < j; i++) {\n            message = {\n                light: light.entity_id,\n                service: \"on\",\n                payload: { data: { brightness: Math.max(...msg.lightEffect.rgbs[i % 2]), transition: 0.5 } },\n                delay: i * 1500\n            };\n\n            if (color_modes) {\n                message[\"payload\"][\"data\"][\"rgb_color\"] = msg.lightEffect.rgbs[i % 2];\n            }\n            msgs.push({ ...message });\n        }\n\n        message = {\n            light: light.entity_id,\n            service: light.state,\n            payload: { data: { transition: 0.5 } },\n            delay: (msg.lightEffect.count * 2 - 1) * 1500\n        };\n\n        if (light.state == \"on\") {\n            message[\"payload\"][\"data\"][\"brightness\"] = light.attributes.brightness;\n            if (light.attributes.color_mode == \"color_temp\") {\n                message[\"payload\"][\"data\"][\"color_temp\"] = light.attributes.color_temp;\n            } else {\n                message[\"payload\"][\"data\"][\"rgb_color\"] = light.attributes.rgb_color;\n            }\n        }\n        msgs.push({ ...message });\n    }\n}\n\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":60,"wires":[["2125dfb6b2bda172"]]},{"id":"659ed9ee25a47490","type":"api-current-state","z":"e6ac576fb4598283","name":"in_home_zone ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.in_home_zone","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":190,"y":80,"wires":[[],[]]},{"id":"bac0f6cb65e6ea92","type":"function","z":"ba09e97f2ed22f2b","name":"mobileNotifications ?","func":"let persons = msg.persons;\nlet msgs = [];\n\nif (msg.error === true) {\n    persons = msg.persons.filter(p => (p.notifyMobileAppOnErrors ?? false));\n} else if (Array.isArray(msg.sendTo)) {\n    persons = msg.persons.filter(p => msg.sendTo.includes(p.name));\n}\n\npersons = persons.filter(p => p.mobileAppName !== \"\");\nfor (let p of persons) {\n    let mess = {\n        service: p.mobileAppName,\n        payload: {\n            data: { message: msg.message ?? \"\" }\n        }\n    };\n    \n    if (msg.title) {\n        mess.payload.data.title = msg.title;\n    }\n\n    if (msg.data) {\n        mess.payload.data[\"data\"] = msg.data;\n    } else {\n        mess.payload.data[\"data\"] = { actions: [{ \"action\": msg.notification_id, \"title\": \"Effacer\" }] };\n    }\n    msgs.push(mess);\n}\n\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":60,"wires":[["138422f99c4bd921"]]},{"id":"138422f99c4bd921","type":"api-call-service","z":"ba09e97f2ed22f2b","name":"send to mobile","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"notify","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"all","x":700,"y":60,"wires":[[]]},{"id":"ffcfbc338ee42cc0","type":"function","z":"ba09e97f2ed22f2b","name":"persons >","func":"if (msg.sendMobile === true) {\n    msg.search = { \"is\": { linkedClass: \"person\" } };\n    msg.output_name = \"persons\";\n    msg.outputEmptyResults = false;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":60,"wires":[["6bca1e5efde2ee7a"]]},{"id":"6bca1e5efde2ee7a","type":"subflow:3da7ebfd83a38899","z":"ba09e97f2ed22f2b","name":"","x":310,"y":60,"wires":[["bac0f6cb65e6ea92"]]},{"id":"33ad227bfc1b9b09","type":"function","z":"dbf17bea6affd2ec","name":"speakers >","func":"let acceptedAudioType = [\"speak\", \"sound\", \"link\"];\n\nif (msg.audio_type === undefined) {\n    let audio_type = Object.keys(msg).find(a => acceptedAudioType.includes(a));\n    if (audio_type !== undefined) {\n\n        let speaker_msg = {\n            audio_type: audio_type,\n            [audio_type]: msg[audio_type],\n            search: { \"is\": { linkedClass: \"speaker\" } },\n            output_name: \"speakers\",\n            outputEmptyResults: false,\n            lightEffect: msg.lightEffect\n        };\n\n        if (typeof msg.volumeLevel == \"number\") {\n            speaker_msg[\"volumeLevel\"] = msg.volumeLevel;\n        }\n        return [speaker_msg, null];\n    }\n} else {\n    return [null, msg];\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":60,"wires":[["0fb94c5b2c85c7f4"],["e8a0ba8788bb4826"]]},{"id":"5ab0339e525685e3","type":"subflow:e6ac576fb4598283","z":"dbf17bea6affd2ec","name":"","x":170,"y":60,"wires":[["bca42d4e03bd9757","8bd3df340156900b"],[]]},{"id":"0fb94c5b2c85c7f4","type":"subflow:3da7ebfd83a38899","z":"dbf17bea6affd2ec","name":"","x":670,"y":60,"wires":[["2e20f8070115dc35"]]},{"id":"2e20f8070115dc35","type":"function","z":"dbf17bea6affd2ec","name":"speakers msgs","func":"let speaker_day_night_mode = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.speaker_day_night_mode\"].state == \"on\";\nlet linkedArea = msg.linkedArea ?? \"\";\nlet audio_type = msg.audio_type ?? \"\";\nlet speakers = msg.speakers;\nlet msgs = [];\n\nif (msg.volumeLevel === undefined) {\n    if (speaker_day_night_mode) {\n        msg.volumeLevel = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_day_mode_volume\"].state) / 100;\n    } else {\n        msg.volumeLevel = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_night_mode_volume\"].state) / 100;\n    }\n}\n\nif (speakers.length == 1) {\n    setSpeaker(speakers[0]);\n} else if (speakers.filter(s => s.linkedArea == linkedArea).length != 0) {\n    setSpeaker(speakers.filter(s => s.linkedArea == linkedArea));\n}\nreturn [msgs];\n\nfunction setSpeaker(speaker) {\n    msgs.push({\n        entity_id: speaker.entity_id,\n        volumeLevel: msg.volumeLevel,\n        defaultVolumeLevel: speaker.defaultVolumeLevel,\n        content: msg[audio_type],\n        audio_type: audio_type,\n        lightEffect: msg.lightEffect\n    });\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":60,"wires":[["12154ca5df7d4b6b"]]},{"id":"564ff39f4444893d","type":"function","z":"dbf17bea6affd2ec","name":"config speaker","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet tts_voice = home_configuration.tts_voice ?? \"\";\n\nif (msg.audio_type == \"speak\" && tts_voice) {\n    msg.payload = {\n        domain: \"tts\",\n        service: tts_voice,\n        data: {\n            entity_id: msg.entity_id,\n            message: msg.content\n        }\n    };\n    return msg;\n} else if (msg.audio_type == \"sound\") {\n    msg.payload = {\n        domain: \"media_player\",\n        service: \"play_media\",\n        data: {\n            entity_id: msg.entity_id,\n            media_content_id: \"media-source://media_source/media/\" + msg.content,\n            media_content_type: \"music\"\n        }\n    };\n    return msg;\n} else if (msg.audio_type == \"link\") {\n    msg.payload = {\n        domain: \"media_player\",\n        service: \"play_media\",\n        data: {\n            entity_id: msg.entity_id,\n            media_content_id: msg.content,\n            media_content_type: \"music\"\n        }\n    };\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":120,"wires":[["c97357ae5cca8f9a"]]},{"id":"c97357ae5cca8f9a","type":"api-call-service","z":"dbf17bea6affd2ec","name":"speaker","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":760,"y":120,"wires":[[]]},{"id":"12154ca5df7d4b6b","type":"link out","z":"dbf17bea6affd2ec","name":"link out 599","mode":"link","links":["7a0ddf55da5d7259"],"x":955,"y":60,"wires":[]},{"id":"7a0ddf55da5d7259","type":"link in","z":"dbf17bea6affd2ec","name":"link in 543","links":["12154ca5df7d4b6b"],"x":65,"y":120,"wires":[["b2384440c807211c"]]},{"id":"7e9a6b49ccc319ef","type":"function","z":"dbf17bea6affd2ec","name":"ready ?","func":"let speakers = global.get(\"speakers\") ?? {};\n\nif (speakers[msg.entity_id] === undefined) {\n    speakers[msg.entity_id] = {};\n    speakers[msg.entity_id].status = \"ready\";\n    speakers[msg.entity_id].queue = [];\n}\n\nif (speakers[msg.entity_id].status === \"ready\") {\n    speakers[msg.entity_id].status = \"not_ready\";\n    global.set(\"speakers\", speakers);\n    return msg;\n}\n\nif (speakers[msg.entity_id].status === \"not_ready\") {\n    if (msg.speaker?.attributes?.media_duration === undefined || msg.speaker.attributes.media_duration > 15) {\n        return msg;\n    } else {\n        speakers[msg.entity_id].queue.push({ ...msg });\n        global.set(\"speakers\", speakers);\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":120,"wires":[["498b5dda79f5641e"]]},{"id":"b2384440c807211c","type":"api-current-state","z":"dbf17bea6affd2ec","name":"get speaker","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{entity_id}}","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"speaker","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":120,"wires":[["7e9a6b49ccc319ef"]]},{"id":"bca42d4e03bd9757","type":"subflow:5a05b9ac0289ff03","z":"dbf17bea6affd2ec","name":"","env":[],"x":340,"y":60,"wires":[]},{"id":"498b5dda79f5641e","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set vol","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":450,"y":120,"wires":[["564ff39f4444893d"]]},{"id":"955123ec73074cbf","type":"function","z":"723d4991c3c87385","name":"call prepare","func":"if (msg.entity_id) {\n    let switchDomain = [\"input_boolean\", \"switch\", \"light\"];\n    let valueDomain = [\"input_number\", \"input_text\"];\n    let selectDomain = [\"input_select\", \"select\"];\n    msg.domain = msg.entity_id.split(\".\")[0];\n\n    if (switchDomain.includes(msg.domain) && [\"on\", \"off\"].includes(msg.state)) {\n        msg.service = \"turn_\" + msg.state;\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id\n            }\n        };\n        return [msg, null];\n    } else if (selectDomain.includes(msg.domain) && msg.state !== undefined) {\n        msg.service = \"select_option\";\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id, option: msg.state\n            }\n        };\n        return [msg, null];\n    } else if (valueDomain.includes(msg.domain) && (msg.domain == \"input_number\" && !isNaN(msg.state) || msg.domain == \"input_text\")) {\n        msg.service = \"set_value\";\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id, value: msg.state\n            }\n        };\n        return [msg, null];\n    } else if (msg.domain === \"input_datetime\") {\n        let type =\n            msg.state.search(/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}/) == 0 ? \"datetime\"\n                : msg.state.search(/[0-9]{4}-[0-9]{2}-[0-9]{2}/) == 0 ? \"date\"\n                    : msg.state.search(/[0-9]{2}:[0-9]{2}/) == 0 ? \"time\" : \"\";\n        if (type) {\n            msg.service = \"set_datetime\";\n            msg.payload = {\n                data: {\n                    entity_id: msg.entity_id, [type]: msg.state\n                }\n            };\n            return [msg, null];\n        }\n    } else if (msg.domain === \"action\") {\n        return [{ ...msg.state }, null];\n    } else if (msg.domain === \"emulate\") {\n        msg.payload = {\n            event: \"emulate\",\n            data: {\n                entity_id: msg.entity_id.replace(msg.domain + \".\", \"\"),\n                ...msg.state\n            }\n        };\n        return [null, msg];\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["c90e53f5c4e8e1e2"],["6acff092435169c4"]]},{"id":"c90e53f5c4e8e1e2","type":"api-call-service","z":"723d4991c3c87385","name":"call service","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":330,"y":60,"wires":[[]]},{"id":"dfbaefd1c674da97","type":"ha-fire-event","z":"723d4991c3c87385","name":"fire event","server":"c87720f17866318d","version":0,"event":"","data":"","dataType":"json","x":480,"y":60,"wires":[[]]},{"id":"bdd49c309e819698","type":"function","z":"ad3b29a5dd67898f","name":"send dashboard bug","func":"if (msg.error?.message !== undefined) {\n    let allowedError = msg.blockedErrors.find(e => msg.error.message.includes(e)) === undefined;\n    if (allowedError) {\n        let notifications = global.get(\"notifications\") ?? {};\n\n        msg.alertType = \"error\";\n        msg.title = \"Erreur dÃ©tÃ©ctÃ©e\";\n        msg.notification_id = (msg.flowTitle + \"_\" + msg.error.source.name).replaceAll(/[^A-Za-z0-9_]/g, \"\").replaceAll(/(_){2,}/g, \"_\").replaceAll(\" \", \"_\");\n        msg.message = \"Erreur : \" + msg.flowTitle + \" > \" + msg.error.source.name + \" > \" + msg.error.message;\n\n        if (notifications[msg.notification_id] !== undefined) {\n            msg.message += \", apparue \" + (notifications[msg.notification_id].count + 1) + \" fois.\";\n        } else {\n            msg.sendMobile = true;\n        }\n        msg.error = true;\n        return msg;\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":100,"wires":[["6280166330ae9f71"]]},{"id":"2a0d685e1c4f2f92","type":"subflow:6c4028aab794d52d","z":"ad3b29a5dd67898f","name":"","x":570,"y":100,"wires":[[]]},{"id":"6280166330ae9f71","type":"delay","z":"ad3b29a5dd67898f","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":400,"y":100,"wires":[["2a0d685e1c4f2f92"]]},{"id":"756ccf0426c7087d","type":"debug","z":"ad3b29a5dd67898f","name":"debug 1","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":510,"y":40,"wires":[]},{"id":"f8ffcffdadd50488","type":"subflow:94b2243985840d69","z":"ad3b29a5dd67898f","name":"","x":350,"y":40,"wires":[["756ccf0426c7087d","2271ac974449a6cd"]]},{"id":"9303e8f878770ce0","type":"subflow:515fe2385f553c95","z":"ad3b29a5dd67898f","name":"","x":870,"y":40,"wires":[["d32dfc19aca11d6c"],["308ca84962deb508"]]},{"id":"3d465666ee7193c6","type":"file","z":"ad3b29a5dd67898f","name":"save error","filename":"/homeassistant/node-red/errors.txt","filenameType":"str","appendNewline":true,"createDir":true,"overwriteFile":"false","encoding":"none","x":340,"y":160,"wires":[[]]},{"id":"d32dfc19aca11d6c","type":"link out","z":"ad3b29a5dd67898f","name":"link out 536","mode":"link","links":["7a46c28099b3899d"],"x":975,"y":40,"wires":[]},{"id":"7a46c28099b3899d","type":"link in","z":"ad3b29a5dd67898f","name":"link in 483","links":["d32dfc19aca11d6c"],"x":55,"y":100,"wires":[["bdd49c309e819698"]]},{"id":"308ca84962deb508","type":"link out","z":"ad3b29a5dd67898f","name":"link out 537","mode":"link","links":["044a910a51b45b80"],"x":975,"y":40,"wires":[]},{"id":"044a910a51b45b80","type":"link in","z":"ad3b29a5dd67898f","name":"link in 484","links":["308ca84962deb508"],"x":55,"y":160,"wires":[["02d291345d1acef9"]]},{"id":"02d291345d1acef9","type":"function","z":"ad3b29a5dd67898f","name":"allowedError ?","func":"if (msg.error?.source?.name !== undefined) {\n    let allowedError = msg.blockedErrors.filter(error => msg.error.message.includes(error)).length == 0;\n    if (allowedError) {\n        msg.payload = { ...msg };\n        return msg;\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":160,"wires":[["3d465666ee7193c6"]]},{"id":"2271ac974449a6cd","type":"function","z":"ad3b29a5dd67898f","name":"blockedErrors","func":"msg.blockedErrors = [\n    \"<class 'TimeoutError'>\",\n    \"The write socket is closed\",\n    \"client quota exceeded\"\n];\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":40,"wires":[["9303e8f878770ce0"]]},{"id":"fcdc38c73bb08769","type":"delay","z":"ad3b29a5dd67898f","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":180,"y":40,"wires":[["f8ffcffdadd50488"]]},{"id":"b4b8c8acb4afc630","type":"function","z":"6c4028aab794d52d","name":"create notification","func":"let notifications = global.get(\"notifications\") ?? {};\nif (notifications[msg.notification_id] === undefined || msg.override) {\n    let d = new Date();\n    let local_time = (d.getMonth() + 1) + \" \" + d.getDate() + \" \" + d.getHours() + \":\" + (d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes());\n\n    notifications[msg.notification_id] = {};\n    notifications[msg.notification_id].count = 1;\n    notifications[msg.notification_id].creationDate = msg.restore ? msg.creationDate : local_time;\n} else {\n    notifications[msg.notification_id].count++;\n}\n\nnotifications[msg.notification_id].title = msg.title ?? \"\";\nnotifications[msg.notification_id].message = msg.message ?? \"\";\nnotifications[msg.notification_id].alertType = msg.alertType ?? \"info\";\n\nif (notifications[msg.notification_id].count <= 10) {\n    global.set(\"notifications\", notifications);\n    msg.notification = notifications[msg.notification_id];\n    msg.payload = notifications;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":180,"wires":[["01115ff6eea2fb4d","db39b80e5ccab19b","329b6d774407f71d"]]},{"id":"3f253902f407ad63","type":"link out","z":"6c4028aab794d52d","name":"link out 195","mode":"link","links":["a4ea76d59161c4ed"],"x":395,"y":60,"wires":[]},{"id":"fbbcce304f59d362","type":"link in","z":"6c4028aab794d52d","name":"link in 211","links":["09dc06bf38132edc"],"x":115,"y":180,"wires":[["b4b8c8acb4afc630"]]},{"id":"ed73f233a30a209c","type":"link out","z":"6c4028aab794d52d","name":"link out 196","mode":"link","links":["3cec5815dff22f23"],"x":735,"y":60,"wires":[]},{"id":"2d47b21860760270","type":"subflow:dbf17bea6affd2ec","z":"6c4028aab794d52d","name":"","x":450,"y":240,"wires":[]},{"id":"01115ff6eea2fb4d","type":"link out","z":"6c4028aab794d52d","name":"link out 226","mode":"link","links":["3cec5815dff22f23"],"x":835,"y":180,"wires":[]},{"id":"ba2ec713942851f0","type":"subflow:ba09e97f2ed22f2b","z":"6c4028aab794d52d","name":"","x":250,"y":240,"wires":[]},{"id":"7e00d134f3038fd4","type":"function","z":"6c4028aab794d52d","name":"delete notification","func":"if (msg.notification?.event?.service === \"create\") {\n    return [msg, null];\n} else if (msg.notification?.event?.service === \"dismiss\") {\n    let notifications = global.get(\"notifications\") ?? {};\n    delete notifications[msg.notification.event.service_data.notification_id];\n    msg.payload = notifications;\n    return [null, msg];\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":320,"wires":[["77a3983c5e6305d8"],["cc379f05a4f6474a"]]},{"id":"fe7c59f6e9b79d49","type":"yaml","z":"6c4028aab794d52d","property":"payload","name":"","x":150,"y":440,"wires":[["c16c539fd3d8eb35"]]},{"id":"c16c539fd3d8eb35","type":"file","z":"6c4028aab794d52d","name":"","filename":"/config/notifications.yaml","filenameType":"str","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":330,"y":440,"wires":[["a641e18ab6fd2b7d"]]},{"id":"9c15ed8da7f1e70d","type":"link in","z":"6c4028aab794d52d","name":"write notifications","links":[],"x":55,"y":440,"wires":[["fe7c59f6e9b79d49"]]},{"id":"a641e18ab6fd2b7d","type":"link out","z":"6c4028aab794d52d","name":"link out 450","mode":"return","links":[],"x":475,"y":440,"wires":[]},{"id":"329b6d774407f71d","type":"link call","z":"6c4028aab794d52d","name":"","links":["9c15ed8da7f1e70d"],"linkType":"static","timeout":"30","x":710,"y":180,"wires":[[]]},{"id":"cc379f05a4f6474a","type":"link call","z":"6c4028aab794d52d","name":"","links":["9c15ed8da7f1e70d"],"linkType":"static","timeout":"30","x":550,"y":320,"wires":[[]]},{"id":"e5671fc4552229ec","type":"change","z":"6c4028aab794d52d","name":"notification_id","rules":[{"t":"set","p":"notification_id","pt":"msg","to":"payload.event.action","tot":"msg"},{"t":"set","p":"dismiss","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":380,"wires":[["acf3ac6effaf6cbb"]]},{"id":"99fea05535de10cd","type":"link out","z":"6c4028aab794d52d","name":"link out 550","mode":"link","links":["2676dfc312e38a90"],"x":615,"y":380,"wires":[]},{"id":"2676dfc312e38a90","type":"link in","z":"6c4028aab794d52d","name":"link in 496","links":["99fea05535de10cd"],"x":115,"y":60,"wires":[["78dcc1b1144ecd4f"]]},{"id":"acf3ac6effaf6cbb","type":"function","z":"6c4028aab794d52d","name":"notification_id exist ?","func":"let notifications = global.get(\"notifications\") ?? {};\n\nif (msg.notification_id in notifications) {\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":380,"wires":[["99fea05535de10cd"]]},{"id":"db39b80e5ccab19b","type":"api-call-service","z":"6c4028aab794d52d","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"persistent_notification","service":"create","areaId":[],"deviceId":[],"entityId":[],"data":"{\"title\":\"{{notification.title}}\",\"message\":\"{{notification.message}}\",\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":180,"wires":[[]]},{"id":"1fbb7266d0e73a79","type":"api-call-service","z":"6c4028aab794d52d","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"persistent_notification","service":"dismiss","areaId":[],"deviceId":[],"entityId":[],"data":"{\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":570,"y":60,"wires":[["ed73f233a30a209c"]]},{"id":"27be3bd3583772c1","type":"server-events","z":"6c4028aab794d52d","name":"persistent_notification","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"call_service","eventData":"{\"domain\":\"persistent_notification\"}","waitForRunning":true,"outputProperties":[{"property":"notification","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":140,"y":320,"wires":[["7e00d134f3038fd4"]]},{"id":"23ebc4c6c318a1d6","type":"server-events","z":"6c4028aab794d52d","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":380,"wires":[["e5671fc4552229ec"]]},{"id":"78dcc1b1144ecd4f","type":"function","z":"6c4028aab794d52d","name":"create update delete","func":"if (msg.notification_id ?? false) {\n    if (msg.dismiss ?? false) {\n        return [null, msg];\n    } else {\n        return [msg, null];\n    }\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":60,"wires":[["3f253902f407ad63"],["9f015d9ba8390d6a"]]},{"id":"3cec5815dff22f23","type":"link in","z":"6c4028aab794d52d","name":"link in 551","links":["01115ff6eea2fb4d","ed73f233a30a209c"],"x":115,"y":240,"wires":[["ba2ec713942851f0","2d47b21860760270"]]},{"id":"b8d927bc07163cd1","type":"function","z":"6c4028aab794d52d","name":"msg to json","func":"msg.template = JSON.stringify(msg).replaceAll(\"\\\\\\\"\",\"'\");\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":120,"wires":[["51c4b7debb5741ab"]]},{"id":"51c4b7debb5741ab","type":"api-render-template","z":"6c4028aab794d52d","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":380,"y":120,"wires":[["89c488895669a0cc"]]},{"id":"a4ea76d59161c4ed","type":"link in","z":"6c4028aab794d52d","name":"link in 552","links":["3f253902f407ad63"],"x":115,"y":120,"wires":[["b8d927bc07163cd1"]]},{"id":"09dc06bf38132edc","type":"link out","z":"6c4028aab794d52d","name":"link out 606","mode":"link","links":["fbbcce304f59d362"],"x":635,"y":120,"wires":[]},{"id":"89c488895669a0cc","type":"function","z":"6c4028aab794d52d","name":"json to msg","func":"msg = { ...JSON.parse(msg.payload) };\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":120,"wires":[["09dc06bf38132edc"]]},{"id":"6a3d5dea1ffbb2d8","type":"function","z":"10a4bbabe046de0e","name":"lock / unlock","func":"let locked_lights = global.get(\"locked_lights\") ?? [];\n\nif (msg.lock !== undefined && msg.lock_lights !== undefined) {\n    locked_lights = msg.lock ?\n        [... new Set([...locked_lights, ...msg.lock_lights])] :\n        locked_lights.filter(l => !msg.lock_lights.includes(l));\n\n    global.set(\"locked_lights\", locked_lights);\n    delete msg.lock_lights;\n    delete msg.lock;\n    return msg;\n} else if (typeof msg.entity_id === \"string\") {\n    if (!locked_lights.includes(msg.entity_id)) {\n        return msg;\n    }\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":80,"wires":[[]]},{"id":"3ff07ed925623c04","type":"function","z":"10a4bbabe046de0e","name":"exemple","func":"msg.lock_lights = msg.linkedLights;\nmsg.lock = msg.cube.flip90;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":80,"wires":[[]]},{"id":"d95af1f39bdc2e43","type":"function","z":"9b9bfdbe9a43dabb","name":"msg","func":"msg.lock = !msg.restore;\nmsg.lock_lights = msg.linkedLights;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":120,"wires":[["36801bdea0fbfedd"]]},{"id":"4f9438c9a5b4c1b4","type":"link out","z":"9b9bfdbe9a43dabb","name":"link out 326","mode":"link","links":["01a2c1e96153b1ea"],"x":995,"y":120,"wires":[]},{"id":"01a2c1e96153b1ea","type":"link in","z":"9b9bfdbe9a43dabb","name":"link in 339","links":["4f9438c9a5b4c1b4"],"x":135,"y":180,"wires":[["f088cfce1985c89d","6a1e98f0e17b03b9"]]},{"id":"ad661360b9c48435","type":"subflow:10a4bbabe046de0e","z":"9b9bfdbe9a43dabb","name":"","x":600,"y":120,"wires":[["a9afa54b296eb45f"]]},{"id":"f088cfce1985c89d","type":"function","z":"9b9bfdbe9a43dabb","name":"prepare lights","func":"if ((msg.lights?.length ?? 0) != 0 && msg.ambiance_config?.ambiances_type !== undefined) {\n    msg.reset = true;\n    if (msg.action_type != \"stop\") {\n        let msgs = [];\n        for (let light of msg.lights) {\n            if (light.attributes?.supported_color_modes?.includes(\"rgb\") !== undefined) {\n                let ambiance_type = msg.ambiance_config.ambiances_type[msg.action_type];\n                let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360);\n                let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100);\n                let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100);\n                let delay = 1000 + Math.round(Math.random() * 14000);\n                msgs.push({\n                    entity_id: light.entity_id,\n                    action_type: msg.action_type,\n                    ambiance_config: msg.ambiance_config,\n                    delay: delay,\n                    payload: {\n                        data: {\n                            entity_id: light.entity_id,\n                            hs_color: [hs, saturation],\n                            brightness_pct: brightness,\n                            transition: Math.round(delay / 100) / 10\n                        }\n                    }\n                });\n            }\n        }\n        return [msgs, msg];\n    } else {\n        return [null, msg];\n    }\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance);\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance);\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":180,"wires":[["badb8d2fb8ab5aa3","a9fcbb2aa70ea1f8"],["0cdd3aae865a31cf"]]},{"id":"a9afa54b296eb45f","type":"switch","z":"9b9bfdbe9a43dabb","name":"restore","property":"restore","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":740,"y":120,"wires":[["4c624b837d8ef06c"]]},{"id":"9e5c408e79ac1df8","type":"delay","z":"9b9bfdbe9a43dabb","name":"timer","pauseType":"delayv","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":670,"y":180,"wires":[["99fa979c22389f12"]]},{"id":"99fa979c22389f12","type":"function","z":"9b9bfdbe9a43dabb","name":"prepare light","func":"if (msg.action_type != \"stop\") {\n    let ambiance_type = msg.ambiance_config.ambiances_type[msg.action_type];\n    let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360);\n    let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100);\n    let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100);\n    let delay = 1000 + Math.round(Math.random() * 14000);\n\n    msg.delay = delay;\n    if (msg.action_type == \"thunderstorm\" && delay < 1500) {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                effect: \"Strobe epilepsy!\"\n            }\n        };        \n    } else {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                hs_color: [hs, saturation],\n                brightness_pct: brightness,\n                transition: Math.round(delay / 100) / 10\n            }\n        };\n    }\n\n    return msg;\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance);\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance);\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":180,"wires":[["df2086a6c727f6f7"]]},{"id":"df2086a6c727f6f7","type":"link out","z":"9b9bfdbe9a43dabb","name":"link out 327","mode":"link","links":["9fedc4504beff3ff"],"x":915,"y":180,"wires":[]},{"id":"9fedc4504beff3ff","type":"link in","z":"9b9bfdbe9a43dabb","name":"link in 340","links":["df2086a6c727f6f7"],"x":425,"y":180,"wires":[["52d03fb81f2ee80c","9e5c408e79ac1df8"]]},{"id":"badb8d2fb8ab5aa3","type":"delay","z":"9b9bfdbe9a43dabb","name":"","pauseType":"delay","timeout":"0.5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":180,"wires":[["9e5c408e79ac1df8"]],"l":false},{"id":"05537233af43e407","type":"delay","z":"9b9bfdbe9a43dabb","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":435,"y":240,"wires":[["c83520ded53399c4"]],"l":false},{"id":"6a1e98f0e17b03b9","type":"switch","z":"9b9bfdbe9a43dabb","name":"stop","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"stop","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":230,"y":240,"wires":[["aba5e92a0de87c53"],["05537233af43e407"]]},{"id":"aba5e92a0de87c53","type":"change","z":"9b9bfdbe9a43dabb","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":240,"wires":[["05537233af43e407"]]},{"id":"c83520ded53399c4","type":"change","z":"9b9bfdbe9a43dabb","name":"option","rules":[{"t":"set","p":"option","pt":"msg","to":"home_configuration.ambiance_config.ambiances_type.stop.name","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":240,"wires":[[]]},{"id":"36801bdea0fbfedd","type":"function","z":"9b9bfdbe9a43dabb","name":"lights >","func":"msg.search = { \"is\": { entity_id: msg.linkedLights, state: [\"on\",\"off\"] } };\nmsg.output_name = \"lights\";\nmsg.outputEmptyResults = false;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":120,"wires":[["f2af6447dc9ffbee"]]},{"id":"5ce464135f7acf6e","type":"subflow:dbf17bea6affd2ec","z":"9b9bfdbe9a43dabb","name":"","x":370,"y":60,"wires":[]},{"id":"2771cf6f6d945a3d","type":"function","z":"9b9bfdbe9a43dabb","name":"msg speaker","func":"if (msg.action_type && msg.linkedSpeaker) {\n    let speaker = global.get(\"home_configuration\")[msg.linkedSpeaker] ?? {};\n\n    if ( msg.ambiance_config?.path?.start !== \"\" && msg.ambiance_config?.path?.end !== \"\"\n    ) {\n        if (msg.action_type == \"stop\") {\n            let sound = \"ambiance_stop.mp3\";\n            msg = {\n                linkedArea: msg.linkedArea,\n                volumeLevel: speaker.defaultVolumeLevel ?? 0.5,\n                sound: sound\n            }\n        } else {\n            msg = {\n                linkedArea: msg.linkedArea,\n                volumeLevel: msg.ambianceVolumeLevel ?? 0.5,\n                link: msg.ambiance_config.path.start + msg.action_type + msg.ambiance_config.path.end\n            }\n        }\n        return msg;\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":60,"wires":[["5ce464135f7acf6e"]]},{"id":"52d03fb81f2ee80c","type":"api-call-service","z":"9b9bfdbe9a43dabb","name":"control lights","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":530,"y":180,"wires":[[]]},{"id":"f2af6447dc9ffbee","type":"subflow:3da7ebfd83a38899","z":"9b9bfdbe9a43dabb","name":"","x":450,"y":120,"wires":[["ad661360b9c48435","4f9438c9a5b4c1b4"]]},{"id":"4c624b837d8ef06c","type":"function","z":"9b9bfdbe9a43dabb","name":"restore lights","func":"let motion_areas = global.get(\"motion_areas\") ?? {};\nreturn [[...new Set(msg.lights.map(a => a.linkedArea))].map(a => ({ linkedArea: a, state: motion_areas[a] }))];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":120,"wires":[[]]},{"id":"4d0457a2e27a298e","type":"switch","z":"612068fa04cc8bbd","name":"flip90","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"flip90","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":60,"wires":[["1d0a618a86abc4be","20712a615a75c746"]]},{"id":"1d0a618a86abc4be","type":"function","z":"612068fa04cc8bbd","name":"lock lights","func":"msg.lock_lights = msg.linkedLights;\nmsg.lock = true;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":60,"wires":[["93cc5a471dff46cf"]]},{"id":"93cc5a471dff46cf","type":"subflow:10a4bbabe046de0e","z":"612068fa04cc8bbd","name":"","x":1040,"y":60,"wires":[[]]},{"id":"4fa4465bfee4db09","type":"function","z":"612068fa04cc8bbd","name":"prepare lights msgs","func":"let noSupportedRgbLights = [];\nlet supportedRgbLights = [];\nlet lights = msg.lights;\nlet msgs = [];\n\nfor (let light of lights) {\n    if (light.color === \"on\" || light.color === \"both\") {\n        supportedRgbLights.push(light.entity_id);\n    }\n    if (light.color === \"off\") {\n        noSupportedRgbLights.push(light.entity_id);\n    }\n}\n\nif (noSupportedRgbLights.length != 0) {\n    msgs.push({\n        payload: { \"data\": { \"entity_id\": noSupportedRgbLights, \"brightness_pct\": !msg.cube.free_fall && msg.cube.shake_air ? msg.lightPower : 0, \"color_temp\": msg.colorTemp } }\n    });\n}\n\nif (supportedRgbLights.length != 0) {\n    if (msg.cube.move) {\n        msgs.push({\n            payload: { \"data\": { \"entity_id\": supportedRgbLights, \"brightness_pct\": !msg.cube.free_fall ? msg.lightPower : 0, \"hs_color\": [msg.lightColor, 100] } }\n        });\n    } else {\n        msgs.push({\n            payload: { \"data\": { \"entity_id\": supportedRgbLights, \"brightness_pct\": !msg.cube.free_fall ? msg.lightPower : 0, \"color_temp\": msg.colorTemp } }\n        });\n    }\n}\n\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":180,"wires":[["7d1baedd2aaa770c"]]},{"id":"e24925e9228a946c","type":"link in","z":"612068fa04cc8bbd","name":"link in 342","links":["20712a615a75c746"],"x":155,"y":180,"wires":[["ec9b3b144854bc6a"]]},{"id":"20712a615a75c746","type":"link out","z":"612068fa04cc8bbd","name":"link out 329","mode":"link","links":["e24925e9228a946c"],"x":795,"y":60,"wires":[]},{"id":"188d4197be377390","type":"switch","z":"612068fa04cc8bbd","name":"tap_twice","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"tap_twice","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":200,"y":120,"wires":[["4083f149db8cfa38"]]},{"id":"473feda77b747512","type":"function","z":"612068fa04cc8bbd","name":"restore lights","func":"let motion_areas = global.get(\"motion_areas\") ?? {};\nreturn [[...new Set(msg.lights.map(a => a.linkedArea))].map(a => ({ linkedArea: a, state: motion_areas[a] }))];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":120,"wires":[[]]},{"id":"4083f149db8cfa38","type":"function","z":"612068fa04cc8bbd","name":"unlock lights","func":"msg.lock_lights = msg.linkedLights;\nmsg.lock = false;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":120,"wires":[["8fa0b486a664301b"]]},{"id":"8fa0b486a664301b","type":"subflow:10a4bbabe046de0e","z":"612068fa04cc8bbd","name":"","x":500,"y":120,"wires":[["59637b2fa5678ea2"]]},{"id":"59637b2fa5678ea2","type":"function","z":"612068fa04cc8bbd","name":"lights >","func":"msg.search = { \"is\": { entity_id: msg.linkedLights, state: [\"on\",\"off\"] } };\nmsg.output_name = \"lights\";\nmsg.outputEmptyResults = true;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":120,"wires":[["51ad175438deaf3c"]]},{"id":"ec9b3b144854bc6a","type":"function","z":"612068fa04cc8bbd","name":"lights >","func":"msg.search = { \"is\": { entity_id: msg.linkedLights, state: [\"on\", \"off\"] } };\nmsg.output_name = \"lights\";\nmsg.outputEmptyResults = true;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":180,"wires":[["8e817289e621c662"]]},{"id":"22db9e147fb3f0bc","type":"subflow:dbf17bea6affd2ec","z":"612068fa04cc8bbd","name":"","x":230,"y":240,"wires":[]},{"id":"d47393f14d9d896b","type":"switch","z":"612068fa04cc8bbd","name":"free_fall","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"free_fall","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":700,"y":60,"wires":[["1d0a618a86abc4be","20712a615a75c746"]]},{"id":"e0a08631094f3a1a","type":"switch","z":"612068fa04cc8bbd","name":"shake_air","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"shake_air","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":560,"y":60,"wires":[["1d0a618a86abc4be","20712a615a75c746"]]},{"id":"cd7d9f68a272e2bd","type":"switch","z":"612068fa04cc8bbd","name":"rotate","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"rotate","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":430,"y":60,"wires":[["1d0a618a86abc4be","20712a615a75c746"]]},{"id":"561d43ede593e22a","type":"switch","z":"612068fa04cc8bbd","name":"move","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"move","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":190,"y":60,"wires":[["20712a615a75c746"]]},{"id":"7d1baedd2aaa770c","type":"api-call-service","z":"612068fa04cc8bbd","name":"control lights","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":770,"y":180,"wires":[[]]},{"id":"51ad175438deaf3c","type":"subflow:3da7ebfd83a38899","z":"612068fa04cc8bbd","name":"","x":790,"y":120,"wires":[["473feda77b747512"]]},{"id":"8e817289e621c662","type":"subflow:3da7ebfd83a38899","z":"612068fa04cc8bbd","name":"","x":410,"y":180,"wires":[["4fa4465bfee4db09"]]},{"id":"1dee8c383dad1dc9","type":"function","z":"050c60654a910e68","name":"prepare waits","func":"let msgs = [];\n\nif (msg.waits.length != 0 && msg.states.length == msg.waits.length) {\n    for (let i = 0; i < msg.waits.length; i++) {\n        msgs.push({ ...msg, wait_entity_id: msg.waits[i], wait_state: msg.states[i], count: i });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[["5ff166ae2792d64c"]]},{"id":"a71b128c6a11f16e","type":"change","z":"050c60654a910e68","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":600,"wires":[["b08aef3e9a7c901b"]]},{"id":"87d844bd45fccde6","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":60,"wires":[["d3ca50e2799953d7"]]},{"id":"af650c007ffa4b39","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":120,"wires":[["300dfabdcd908fd9"]]},{"id":"1ac121c8d607267c","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":180,"wires":[["e58d38a7afe6e5e5"]]},{"id":"1d64b1cbe71c8c65","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":240,"wires":[["9bdf1086b4bdec91"]]},{"id":"9c265cc1eaad53bb","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"4","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":300,"wires":[["2c104887531dbd31"]]},{"id":"69317bea361bf45e","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":360,"wires":[["eaeda3c13f3fda3b"]]},{"id":"9d50472878b093d6","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"6","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":420,"wires":[["d616641422d1e85a"]]},{"id":"ab3f5f1f4b645507","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"7","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":480,"wires":[["09152de118411910"]]},{"id":"9147624e46fd3b8b","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"8","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":540,"wires":[["af75c05a4a5d4955"]]},{"id":"e6e0a2f4b0faf93f","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"9","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":600,"wires":[["e3b0c1e807acb20b"]]},{"id":"b08aef3e9a7c901b","type":"link out","z":"050c60654a910e68","name":"link out 353","mode":"link","links":["dd24f19d09420eb6"],"x":915,"y":600,"wires":[]},{"id":"dd24f19d09420eb6","type":"link in","z":"050c60654a910e68","name":"link in 368","links":["b08aef3e9a7c901b"],"x":465,"y":60,"wires":[["d3ca50e2799953d7","300dfabdcd908fd9","e58d38a7afe6e5e5","9bdf1086b4bdec91","2c104887531dbd31","eaeda3c13f3fda3b","d616641422d1e85a","09152de118411910","af75c05a4a5d4955","e3b0c1e807acb20b"]]},{"id":"4095fa2ccd977940","type":"change","z":"050c60654a910e68","name":"","rules":[{"t":"delete","p":"wait_entity_id","pt":"msg"},{"t":"delete","p":"wait_state","pt":"msg"},{"t":"delete","p":"timeoutSeconds","pt":"msg"},{"t":"delete","p":"waits","pt":"msg"},{"t":"delete","p":"states","pt":"msg"},{"t":"delete","p":"count","pt":"msg"},{"t":"delete","p":"sendOnTimeout","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":60,"wires":[["cbbaf5fe1d43c359"]]},{"id":"cbbaf5fe1d43c359","type":"delay","z":"050c60654a910e68","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":1230,"y":60,"wires":[[]]},{"id":"263cb54347d897c3","type":"switch","z":"050c60654a910e68","name":"sendOnTimeout ?","property":"sendOnTimeout","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":870,"y":60,"wires":[["4095fa2ccd977940"]]},{"id":"d3ca50e2799953d7","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":60,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"300dfabdcd908fd9","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":120,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"e58d38a7afe6e5e5","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":180,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"9bdf1086b4bdec91","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":240,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"2c104887531dbd31","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":300,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"eaeda3c13f3fda3b","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":360,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"d616641422d1e85a","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":420,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"09152de118411910","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":480,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"af75c05a4a5d4955","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":540,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"e3b0c1e807acb20b","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":600,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"7a326f951564d5db","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":60,"wires":[["cc4e9a25b741e5b5"],["983c576accbdd1a8"]]},{"id":"f51dc77777d8f60b","type":"function","z":"7166242293a03ec9","name":"count","func":"let ambiances = global.get(\"ambiances\") ?? {};\nlet linkedAmbiance = msg.linkedAmbiance;\n\nmsg.count = Object.keys(ambiances).indexOf(msg.linkedAmbiance);\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["4f25dbc1a164f41f"]]},{"id":"7f0acd26f3c01f74","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":120,"wires":[["df96ad23721c9b37"],["c4ce766bfba99f60"]]},{"id":"939c33b32ba14e28","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":180,"wires":[["a3910fff73ce4d4b"],["02bd6203821573d6"]]},{"id":"bd39a0530a2296c9","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":240,"wires":[["3f899843af04db15"],["494b9ad847029c04"]]},{"id":"47f76380129d7466","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":300,"wires":[["c1144f4ae8809948"],["a0dc0c93931f1e10"]]},{"id":"544c5beb752c4b83","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":360,"wires":[["13014577787c3ec1"],["9c17c037cc291546"]]},{"id":"cc4e9a25b741e5b5","type":"link out","z":"7166242293a03ec9","name":"link out 376","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":60,"wires":[]},{"id":"907c1f317e2ca3ee","type":"link in","z":"7166242293a03ec9","name":"link in 384","links":["cc4e9a25b741e5b5","df96ad23721c9b37","a3910fff73ce4d4b","3f899843af04db15","c1144f4ae8809948","13014577787c3ec1"],"x":735,"y":60,"wires":[[]]},{"id":"983c576accbdd1a8","type":"link out","z":"7166242293a03ec9","name":"link out 377","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":60,"wires":[]},{"id":"c728ac07d0d13bab","type":"link in","z":"7166242293a03ec9","name":"link in 385","links":["983c576accbdd1a8","c4ce766bfba99f60","02bd6203821573d6","494b9ad847029c04","a0dc0c93931f1e10","9c17c037cc291546"],"x":735,"y":120,"wires":[["b7354c936912ab1e"]]},{"id":"df96ad23721c9b37","type":"link out","z":"7166242293a03ec9","name":"link out 378","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":120,"wires":[]},{"id":"c4ce766bfba99f60","type":"link out","z":"7166242293a03ec9","name":"link out 379","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":120,"wires":[]},{"id":"a3910fff73ce4d4b","type":"link out","z":"7166242293a03ec9","name":"link out 380","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":180,"wires":[]},{"id":"02bd6203821573d6","type":"link out","z":"7166242293a03ec9","name":"link out 381","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":180,"wires":[]},{"id":"3f899843af04db15","type":"link out","z":"7166242293a03ec9","name":"link out 382","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":240,"wires":[]},{"id":"494b9ad847029c04","type":"link out","z":"7166242293a03ec9","name":"link out 383","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":240,"wires":[]},{"id":"c1144f4ae8809948","type":"link out","z":"7166242293a03ec9","name":"link out 384","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":300,"wires":[]},{"id":"a0dc0c93931f1e10","type":"link out","z":"7166242293a03ec9","name":"link out 385","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":300,"wires":[]},{"id":"13014577787c3ec1","type":"link out","z":"7166242293a03ec9","name":"link out 386","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":360,"wires":[]},{"id":"9c17c037cc291546","type":"link out","z":"7166242293a03ec9","name":"link out 387","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":360,"wires":[]},{"id":"ae7861968403f307","type":"switch","z":"7166242293a03ec9","name":"count 1","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":120,"wires":[["7f0acd26f3c01f74"]]},{"id":"e113ddcda7707d78","type":"switch","z":"7166242293a03ec9","name":"count 2","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":180,"wires":[["939c33b32ba14e28"]]},{"id":"cface082c3f3571c","type":"switch","z":"7166242293a03ec9","name":"count 3","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":240,"wires":[["bd39a0530a2296c9"]]},{"id":"f83935731bab2f93","type":"switch","z":"7166242293a03ec9","name":"count 4","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"4","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":300,"wires":[["47f76380129d7466"]]},{"id":"7b8515b9f1fccf72","type":"switch","z":"7166242293a03ec9","name":"count 5","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":360,"wires":[["544c5beb752c4b83"]]},{"id":"4f25dbc1a164f41f","type":"link out","z":"7166242293a03ec9","name":"link out 388","mode":"link","links":["346607f7f851b121","87ebde6adf601137","3a0148158457edf5","4cd60f8b7145da89","4272daeffcf81037","fe1c9b9ece62fe4b"],"x":265,"y":60,"wires":[]},{"id":"346607f7f851b121","type":"link in","z":"7166242293a03ec9","name":"link in 386","links":["4f25dbc1a164f41f"],"x":335,"y":60,"wires":[["56f6adecc2b7c507"]]},{"id":"87ebde6adf601137","type":"link in","z":"7166242293a03ec9","name":"link in 387","links":["4f25dbc1a164f41f"],"x":335,"y":120,"wires":[["ae7861968403f307"]]},{"id":"3a0148158457edf5","type":"link in","z":"7166242293a03ec9","name":"link in 388","links":["4f25dbc1a164f41f"],"x":335,"y":180,"wires":[["e113ddcda7707d78"]]},{"id":"4cd60f8b7145da89","type":"link in","z":"7166242293a03ec9","name":"link in 389","links":["4f25dbc1a164f41f"],"x":335,"y":240,"wires":[["cface082c3f3571c"]]},{"id":"4272daeffcf81037","type":"link in","z":"7166242293a03ec9","name":"link in 390","links":["4f25dbc1a164f41f"],"x":335,"y":300,"wires":[["f83935731bab2f93"]]},{"id":"fe1c9b9ece62fe4b","type":"link in","z":"7166242293a03ec9","name":"link in 391","links":["4f25dbc1a164f41f"],"x":335,"y":360,"wires":[["7b8515b9f1fccf72"]]},{"id":"56f6adecc2b7c507","type":"switch","z":"7166242293a03ec9","name":"count 0","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":60,"wires":[["7a326f951564d5db"]]},{"id":"b7354c936912ab1e","type":"api-call-service","z":"7166242293a03ec9","name":"select ambiance","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"input_select.{{linkedAmbiance}}\",\"option\":\"{{option}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":860,"y":120,"wires":[[]]},{"id":"68969b8280827750","type":"function","z":"515fe2385f553c95","name":"mode dev ?","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\n\nif (home_configuration.mode === \"dev\") {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":80,"wires":[[],[]]},{"id":"febc11290421c3af","type":"api-current-state","z":"94b2243985840d69","name":"services_loaded","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"services_loaded","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.services_loaded","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":180,"y":80,"wires":[["20c20fc427292f9a"],[]]},{"id":"20c20fc427292f9a","type":"function","z":"94b2243985840d69","name":"homeassistant is running ?","func":"let homeassistant = global.get(\"homeassistant\")?.homeAssistant ?? {};\n\nif ((homeassistant.isRunning ?? false) && (homeassistant.isConnected ?? false)) {\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":80,"wires":[[]]},{"id":"466e65d315aca28f","type":"function","z":"3da7ebfd83a38899","name":"search entities","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet entities = global.get(\"homeassistant\").homeAssistant.states;\nlet found = [];\n\nfor (let entity_id of Object.keys(entities)) {\n    let entity = entities[entity_id];\n    if (entity_id in home_configuration) {\n        entity = { ...entity, ...home_configuration[entity_id] };\n    }\n    let entity_search = { ...entity, ...entity.attributes };\n    if (search(entity_search)) {\n        entity.state = isNaN(entity.state) ? entity.state : parseFloat(entity.state);\n        found.push(entity);\n    }\n}\n\nlet outputEmptyResults = msg.outputEmptyResults == undefined || msg.outputEmptyResults == true || msg.outputEmptyResults == false && found.length != 0;\nif (outputEmptyResults) {\n    msg[msg.output_name] = found;\n    delete msg.outputEmptyResults;\n    delete msg.output_name;\n    delete msg.search;\n    return msg;\n}\n\nfunction search(entity) {\n    if (\"is\" in msg.search) {\n        for (let search_key of Object.keys(msg.search[\"is\"])) {\n            if (Array.isArray(msg.search[\"is\"][search_key])) {\n                if (!(search_key in entity && msg.search[\"is\"][search_key].includes(entity[search_key]))) {\n                    return false;\n                }\n            } else {\n                if (!(search_key in entity && entity[search_key] == msg.search[\"is\"][search_key])) {\n                    return false;\n                }\n            }\n        }\n    }\n    if (\"not\" in msg.search) {\n        for (let search_key of Object.keys(msg.search[\"not\"])) {\n            if (Array.isArray(msg.search[\"not\"][search_key])) {\n                if (search_key in entity && msg.search[\"not\"][search_key].includes(entity[search_key])) {\n                    return false;\n                }\n            } else {\n                if (search_key in entity && entity[search_key] == msg.search[\"not\"][search_key]) {\n                    return false;\n                }\n            }\n        }\n    }\n    return true;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[[]]},{"id":"9d3ad0a23db6a2ce","type":"subflow:6c4028aab794d52d","z":"27148b7bb9f62ac7","name":"","x":170,"y":380,"wires":[["a938cb7f0804c121"]]},{"id":"e53334a6f05a9609","type":"link in","z":"27148b7bb9f62ac7","name":"notification","links":["ad446eefb7df13b9","db2a87c1d25e790a","9efffdb0ef885bb8","4c7682a3d69b57a1","47e4fe779b75e0dc","3b3dd6b16a5c5a1d","625506e86313414c","b968a370a50879c2","af0c165af5996110","9a6820da31f5f8c4","5c035d30aa0eeaa4","8d3c03ad03424be9","6a698c348a5afd7f","63efd697ac220b54","76cea9e99f705380","ce168531822379e5","088f2437bb522d14","0419929f6aea7cca","840e0643e8c84153","27ce4ecdecc58ff1","a9f60d370046baba","fe7db153e4105d50","8ff031019adb02ce","4eab8cffd742e405","4d571b7c3108dd2f","f9f8f8a690320c67","c16037c98c55d61e","a0ac3a9fefa0251d","ce952f95d7407e06","767e3a7194faa0f4","0ca7c3aa0cc7fd65"],"x":55,"y":380,"wires":[["9d3ad0a23db6a2ce"]]},{"id":"a938cb7f0804c121","type":"function","z":"27148b7bb9f62ac7","name":"recap","func":"let notifications = global.get(\"notifications\") ?? {};\nlet notificationsKeys = Object.keys(notifications);\nlet msgs = [];\nlet txt = \"\";\n\nlet d = new Date();\nlet currentMonth = d.getMonth() + 1;\nlet currentDay = d.getDate();\n\nlet home_invitation = getState(\"input_boolean.home_invitation\") == \"on\";\nif (home_invitation) {\n    txt += \"<center><h2>Mode invitation actif \" + (notificationsKeys.length == 0 ? \"âœ…\" : \":\") + \"</h2>\";\n} else {\n    txt += \"<center><h2>Notifications \" + (notificationsKeys.length == 0 ? \"âœ…\" : \":\") + \"</h2>\";\n}\n\nlet first = true;\nlet alertPriority = { \"error\": 1, \"warning\": 2, \"success\": 3, \"info\": 4 };\nnotificationsKeys.sort(function (a, b) { return alertPriority[notifications[a].alertType] - alertPriority[notifications[b].alertType] });\nfor (let key of notificationsKeys) {\n    if (notifications[key].alertType) {\n        txt += (!first ? '<br>' : '') + '<ha-alert alert-type=\"' + notifications[key].alertType + '\" >' + dateToDisplay(notifications[key].creationDate) + notifications[key].message + \"</ha-alert>\";\n    } else {\n        txt += notifications[key].title;\n    }\n    first = false;\n}\ntxt += \"</center>\";\n\nlet gap = 0;\nfor (let i = 0; i < 6; i++) {\n    msgs.push({\n        payload: {\n            data: {\n                entity_id: \"input_text.recap_\" + (i + 1),\n                value: txt.substring(gap, (gap + 254))\n            }\n        }\n    });\n    gap += 254;\n}\nreturn [msgs];\n\nfunction getState(entity_id) {\n    if (entity_id in global.get(\"homeassistant\").homeAssistant.states) {\n        return global.get(\"homeassistant\").homeAssistant.states[entity_id].state;\n    } else {\n        return \"\";\n    }\n}\n\nfunction dateToDisplay(notifCreationDate) {\n    let monthTradFr = {\n        1: \"Janvier\",\n        2: \"FÃ©vrier\",\n        3: \"Mars\",\n        4: \"Avril\",\n        5: \"Mai\",\n        6: \"Juin\",\n        7: \"Juillet\",\n        8: \"AoÃ»t\",\n        9: \"Septembre\",\n        10: \"Octobre\",\n        11: \"Novembre\",\n        12: \"DÃ©cembre\"\n    };\n\n    let notifCreationDateSplit = notifCreationDate.split(\" \");\n    let notifMonth = parseInt(notifCreationDateSplit[0]);\n    let notifDay = parseInt(notifCreationDateSplit[1]);\n    let notifHour = notifCreationDateSplit[2];\n\n    if (currentDay == notifDay && currentMonth == notifMonth) {\n        return notifHour + \" : \";\n    } else if (currentDay - notifDay == 1 && currentMonth == notifMonth) {\n        return \"Hier Ã  \" + notifHour + \" : \";\n    } else if (currentDay - notifDay == 2 && currentMonth == notifMonth) {\n        return \"Avant-hier Ã  \" + notifHour + \" : \";\n    } else {\n        return \"Le \" + notifDay + \" \" + monthTradFr[notifMonth] + \" Ã  \" + notifHour + \" : \";\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":380,"wires":[["b2117e5ba2e72803"]]},{"id":"db30a1d2a0b1285b","type":"catch","z":"27148b7bb9f62ac7","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["167b698e879b353d"]]},{"id":"e3ba334aa41a02a2","type":"subflow:ad3b29a5dd67898f","z":"27148b7bb9f62ac7","name":"","x":460,"y":40,"wires":[]},{"id":"167b698e879b353d","type":"change","z":"27148b7bb9f62ac7","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Core","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["e3ba334aa41a02a2"]]},{"id":"127167b2550a2c1c","type":"comment","z":"27148b7bb9f62ac7","name":"Notifications ++","info":"Object.entries(windows).forEach(([key, value]) => {\n    \n});\n________________________________________________________________________________\nconst array1 = [true, false, true, true];\nconst initialValue = true;\nconst sumWithInitial = array1.reduce(\n  (accumulator, currentValue) => accumulator && currentValue,\n  initialValue\n);\n________________________________________________________________________________\nlight.attributes.supported_color_modes ?? []).some(mode => mode == \"hs\")\n________________________________________________________________________________","x":120,"y":320,"wires":[]},{"id":"48bffb9a97588b9d","type":"function","z":"27148b7bb9f62ac7","name":"prepare options","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet ambiances = msg.ambiances;\nlet options = [];\nlet msgs = [];\n\nlet ambiancesTypeKeys = Object.keys(home_configuration.ambiance_config.ambiances_type);\nfor (let key of ambiancesTypeKeys) {\n    options.push(home_configuration.ambiance_config.ambiances_type[key].name);\n}\n\nfor (let ambiance of ambiances) {\n    msgs.push({ payload: { data: { entity_id: ambiance.entity_id, options: options } } });\n}\nreturn [msgs];\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":980,"wires":[["f2abe23402efadfd"]]},{"id":"ba01e397c4ca1e22","type":"link in","z":"27148b7bb9f62ac7","name":"ambiances restore","links":["5a948d8bd3b54aed","673a65ab8604e879"],"x":55,"y":980,"wires":[["9cdcdc57bc2d3d28"]]},{"id":"dd906c00889a2c63","type":"comment","z":"27148b7bb9f62ac7","name":"Elevation","info":"","x":800,"y":120,"wires":[]},{"id":"3fc94c7a8b2de5ee","type":"comment","z":"27148b7bb9f62ac7","name":"Global context management","info":"","x":160,"y":720,"wires":[]},{"id":"584269b4c105222c","type":"link in","z":"27148b7bb9f62ac7","name":"notifications restore","links":["5a948d8bd3b54aed","673a65ab8604e879"],"x":55,"y":1100,"wires":[["49f2b6bf5afc8498"]]},{"id":"aad51a0c3f56d775","type":"function","z":"27148b7bb9f62ac7","name":"restore notifications","func":"let notifications = msg.payload ?? {};\nlet notificationsKeys = Object.keys(notifications);\nlet msgs = [];\n\nfor (let key of notificationsKeys) {\n    msgs.push({\n        notification_id: key,\n        count: notifications[key].count,\n        alertType: \"alertType\" in notifications[key] ? notifications[key].alertType : \"info\",\n        title: \"title\" in notifications[key] ? notifications[key].title : \"\",\n        message: \"message\" in notifications[key] ? notifications[key].message : \"\",\n        zone: \"zone\" in notifications[key] ? notifications[key].zone : [\"inside\", \"outside\"],\n        creationDate: \"creationDate\" in notifications[key] ? notifications[key].creationDate : \"???\",\n        restore: true\n    });\n}\n\nif (msgs.length !== 0) {\n    return [msgs];\n} else {\n    global.set(\"notifications\", {});\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":1100,"wires":[["63efd697ac220b54"]]},{"id":"63efd697ac220b54","type":"link out","z":"27148b7bb9f62ac7","name":"link out 448","mode":"link","links":["e53334a6f05a9609"],"x":655,"y":1100,"wires":[]},{"id":"49f2b6bf5afc8498","type":"file in","z":"27148b7bb9f62ac7","name":"get yaml notifications","filename":"/config/notifications.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":200,"y":1100,"wires":[["8913f23a70c4a6cc"]]},{"id":"8913f23a70c4a6cc","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":370,"y":1100,"wires":[["aad51a0c3f56d775"]]},{"id":"5a948d8bd3b54aed","type":"link out","z":"27148b7bb9f62ac7","name":"ha reload","mode":"link","links":["584269b4c105222c","84edd99e67b149d7","ba01e397c4ca1e22","0bd80225f89703f5","33602f065ff47513","04a97112197d0e34"],"x":985,"y":780,"wires":[]},{"id":"9cdcdc57bc2d3d28","type":"function","z":"27148b7bb9f62ac7","name":"ambiance_select >","func":"msg.search = { \"is\": { linkedClass: \"ambiance_select\" } };\nmsg.output_name = \"ambiances\";\nmsg.outputEmptyResults = true;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":980,"wires":[["a01ca528d07a64a4"]]},{"id":"84edd99e67b149d7","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["5a948d8bd3b54aed","673a65ab8604e879"],"x":55,"y":1040,"wires":[["b53b2b58f8931a70"]]},{"id":"b53b2b58f8931a70","type":"function","z":"27148b7bb9f62ac7","name":"persons >","func":"msg.search = { \"is\": { linkedClass: \"person\" } };\nmsg.output_name = \"persons\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":1040,"wires":[["35fe36ee2e26e261"]]},{"id":"0b9c1b04fb16415e","type":"function","z":"27148b7bb9f62ac7","name":"linked devices >","func":"msg.search = { \"is\": { linkedPerson: msg.persons.map(p => p.entity_id) }, \"not\": { state: [\"none\", \"unavailable\", \"unknown\", \"\"] } };\nmsg.output_name = \"persons_devices\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":1040,"wires":[["8e391b3e5fb36db6"]]},{"id":"8cebe9b921fa05e3","type":"function","z":"27148b7bb9f62ac7","name":"set devices","func":"let msgs = [];\n\nfor (let device of msg.persons_devices) {\n    if (device.linkedClass != \"phone_state\") {\n        device.new_state = device.state;\n        delete device.state;\n        msgs.push({ target: \"target_\" + device.linkedClass, ...device });\n    }\n}\n\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":1040,"wires":[["d3bf6d20bb25269a"]]},{"id":"d3bf6d20bb25269a","type":"link call","z":"27148b7bb9f62ac7","name":"target","links":[],"linkType":"dynamic","timeout":"30","x":875,"y":1040,"wires":[[]],"l":false},{"id":"db36ccd58e5e8fe5","type":"comment","z":"27148b7bb9f62ac7","name":"Purge history > 7 days","info":"","x":840,"y":320,"wires":[]},{"id":"0bd80225f89703f5","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["5a948d8bd3b54aed","673a65ab8604e879"],"x":55,"y":1160,"wires":[["4054e84cdc0c98b7"]]},{"id":"4054e84cdc0c98b7","type":"function","z":"27148b7bb9f62ac7","name":"jsons setup","func":"let json_entities = [\"json_exterior_average_temp\", \"json_activities\"];\nlet msgs = [];\n\nfor (let json_entity of json_entities) {\n    let entity_id = \"input_text.\" + json_entity;\n    let state = global.get(\"homeassistant\").homeAssistant.states[entity_id].state;\n    if (state == \"unknown\" || state == \"\") {\n        msgs.push({\n            entity_id: entity_id,\n            state: \"{}\"\n        });\n    }\n}\n\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":1160,"wires":[["83418366d18d13c0"]]},{"id":"83418366d18d13c0","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":350,"y":1160,"wires":[]},{"id":"26bcf1d6a09e471e","type":"comment","z":"27148b7bb9f62ac7","name":"Silent speaker","info":"","x":110,"y":460,"wires":[]},{"id":"b75d924f0f74062b","type":"function","z":"27148b7bb9f62ac7","name":"prepare silent speaker","func":"msg.entity_id = \"input_boolean.speaker_day_night_mode\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":585,"y":580,"wires":[["d124e466c357cf58"]],"l":false},{"id":"d124e466c357cf58","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":770,"y":580,"wires":[]},{"id":"b9a6aaa07ad593b3","type":"comment","z":"27148b7bb9f62ac7","name":"Exterior average temperature","info":"","x":1200,"y":120,"wires":[]},{"id":"e84323b7060d35b5","type":"function","z":"27148b7bb9f62ac7","name":"average calc","func":"let average = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state);\nlet temperatures = global.get(\"temperatures\") ?? {};\nmsg.entity_id = \"input_text.json_exterior_average_temp\";\n\nif (typeof temperatures?.exterior?.value == \"number\" && ((new Date().getTime() - temperatures[\"exterior\"].lastChanged) / 1000) < 40 * 60) {\n    if (!Array.isArray(average)) {\n        average = [temperatures[\"exterior\"].value, 1];\n    } else if (Array.isArray(average)) {\n        if (average[1] < 10) {\n            average[0] = calculateAverage(average);\n            average[1]++;\n        } else {\n            average[0] = calculateAverage(average);\n        }\n    }\n    msg.state = JSON.stringify(average);\n    return msg;\n}\n\nfunction calculateAverage(average) {\n    return Math.round(((average[0] * average[1] + temperatures[\"exterior\"].value) / (average[1] + 1)) * 100) / 100;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1270,"y":180,"wires":[["1ad4b607c1170bc5"]]},{"id":"1ad4b607c1170bc5","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":1450,"y":180,"wires":[]},{"id":"d9f90fff51629bfc","type":"function","z":"27148b7bb9f62ac7","name":"update silent speaker","func":"let speaker_day_mode_start = global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_day_mode_start\"].state;\nlet speaker_night_mode_start = global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_night_mode_start\"].state;\n\nlet d = new Date();\nlet hours = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minutes = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\nlet local_time = hours + \":\" + minutes + \":00\";\n\nmsg.entity_id = \"input_boolean.speaker_day_night_mode\";\nmsg.state = speaker_day_mode_start < local_time && local_time < speaker_night_mode_start ? \"on\" : \"off\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":520,"wires":[["b143da5222c5f445"]]},{"id":"b143da5222c5f445","type":"link out","z":"27148b7bb9f62ac7","name":"link out 543","mode":"link","links":["3ef30ee4463971f3"],"x":755,"y":520,"wires":[]},{"id":"3ef30ee4463971f3","type":"link in","z":"27148b7bb9f62ac7","name":"link in 489","links":["b143da5222c5f445"],"x":635,"y":580,"wires":[["d124e466c357cf58"]]},{"id":"b2117e5ba2e72803","type":"api-call-service","z":"27148b7bb9f62ac7","name":"recap","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":570,"y":380,"wires":[[]]},{"id":"f2abe23402efadfd","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set ambiance options","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"options\":\"{{options}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":640,"y":980,"wires":[[]]},{"id":"7cbc86e2587fe991","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set elevation","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.elevation"],"data":"{\"value\":\"{{data.new_state.attributes.elevation}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":930,"y":180,"wires":[[]]},{"id":"856c82e57e2036eb","type":"api-call-service","z":"27148b7bb9f62ac7","name":"purge history > 7 days","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"recorder","service":"purge","areaId":[],"deviceId":[],"entityId":[],"data":"{\"keep_days\":\"7\",\"repack\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":900,"y":380,"wires":[[]]},{"id":"cd472edfb4e940af","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"zone.home","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"zone.home","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"","ifStateType":"num","ifStateOperator":"gt","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":380,"wires":[["a938cb7f0804c121"]]},{"id":"0ed667140490b99e","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":790,"y":180,"wires":[["7cbc86e2587fe991"]]},{"id":"4f4a945985181968","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"speaker_day_mode_start","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_datetime.speaker_day_mode_start","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":150,"y":520,"wires":[["d9f90fff51629bfc"]]},{"id":"0e4bb86829bf1666","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"speaker_night_mode_start","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_datetime.speaker_night_mode_start","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":390,"y":520,"wires":[["d9f90fff51629bfc"]]},{"id":"39e1b99a8ff7858d","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":1130,"y":180,"wires":[["e84323b7060d35b5"]]},{"id":"9dcc1ae8cc20b65a","type":"ha-time","z":"27148b7bb9f62ac7","name":"speaker_day_mode_start","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.speaker_day_mode_start","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"on","valueType":"str"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":150,"y":580,"wires":[["b75d924f0f74062b","d661cc3406383257"]]},{"id":"da07923216b0a4c5","type":"ha-time","z":"27148b7bb9f62ac7","name":"speaker_night_mode_start","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.speaker_night_mode_start","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"off","valueType":"str"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":390,"y":580,"wires":[["b75d924f0f74062b","d661cc3406383257"]]},{"id":"a8bf2680873bf129","type":"watch","z":"27148b7bb9f62ac7","name":"home_configuration changes","files":"/homeassistant/home_configuration.yaml","recursive":"","x":160,"y":840,"wires":[["fb8bc03d1f05f7a1"]]},{"id":"909b7c2eda8b46d9","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":155,"y":900,"wires":[["8f8def9b0e53de3c"]],"l":false},{"id":"b4dad54ec45dcd75","type":"file in","z":"27148b7bb9f62ac7","name":"read file","filename":"/homeassistant/home_configuration.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":105,"y":900,"wires":[["909b7c2eda8b46d9"]],"l":false},{"id":"8f8def9b0e53de3c","type":"function","z":"27148b7bb9f62ac7","name":"set global home_configuration","func":"let home_configuration = msg.payload ?? {};\nglobal.set(\"home_configuration\", home_configuration);\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":900,"wires":[["498d5d5a6cdccc72"]]},{"id":"a01ca528d07a64a4","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":315,"y":980,"wires":[["48bffb9a97588b9d"]],"l":false},{"id":"35fe36ee2e26e261","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":255,"y":1040,"wires":[["0b9c1b04fb16415e"]],"l":false},{"id":"8e391b3e5fb36db6","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":495,"y":1040,"wires":[["5b9bce573b1cd4a6"]],"l":false},{"id":"fe1ddbe2d3a7b4af","type":"link in","z":"27148b7bb9f62ac7","name":"set global home_configuration","links":[],"x":55,"y":900,"wires":[["b4dad54ec45dcd75"]]},{"id":"af4a425cffa21767","type":"function","z":"27148b7bb9f62ac7","name":"sun calc","func":"let sun_attributes = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes;\nlet sun_light_time_setting = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_setting\"].state;\nlet sun_light_time_dusk = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dusk\"].state;\nlet sun_light_time_midnight = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_midnight\"].state;\nlet sun_light_time_dawn = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn\"].state;\nlet sun_light_time_dawn_angle = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn_angle\"].state;\nlet sun_light_time_rising = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_rising\"].state;\nlet msgs = [];\n\nif (sun_light_time_setting == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_setting\", state: clean_date(sun_attributes.next_setting) });\n}\n\nif (sun_light_time_dusk == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dusk\", state: clean_date(sun_attributes.next_dusk) });\n}\n\nif (sun_light_time_dawn == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dawn\", state: clean_date(sun_attributes.next_dawn) });\n}\n\nif (sun_light_time_dawn_angle == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dawn_angle\", state: clean_date(sun_attributes.next_dawn) });\n}\n\nif (sun_light_time_rising == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_rising\", state: clean_date(sun_attributes.next_rising) });\n}\nreturn [msgs];\n\nfunction clean_date(time_txt) {\n    time_txt = time_txt.split(\"T\")[1].split(\".\")[0];\n    time_txt = time_txt.split(\":\");\n    return time_txt[0] + \":\" + time_txt[1];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":1220,"wires":[["6aa9011345610c94"]]},{"id":"6aa9011345610c94","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":330,"y":1220,"wires":[]},{"id":"33602f065ff47513","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["5a948d8bd3b54aed","673a65ab8604e879"],"x":55,"y":1220,"wires":[["af4a425cffa21767"]]},{"id":"1f5ff33419362cef","type":"inject","z":"27148b7bb9f62ac7","name":"@ 4:00","props":[],"repeat":"","crontab":"00 04 * * *","once":false,"onceDelay":0.1,"topic":"","x":400,"y":180,"wires":[["dd3edb6388f2cf92"]]},{"id":"dd3edb6388f2cf92","type":"link out","z":"27148b7bb9f62ac7","name":"every day 4:00","mode":"link","links":["b75ebf218737acef","093c626512b920e3","1fc976a80798860e"],"x":495,"y":180,"wires":[]},{"id":"b75ebf218737acef","type":"link in","z":"27148b7bb9f62ac7","name":"link in 530","links":["dd3edb6388f2cf92"],"x":755,"y":380,"wires":[["856c82e57e2036eb"]]},{"id":"36fb0d7dc676d3f9","type":"inject","z":"27148b7bb9f62ac7","name":"1 min","props":[{"p":"linkedClass","v":"time","vt":"str"}],"repeat":"","crontab":"*/1 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":110,"y":240,"wires":[["d621148fcbed70b5"]]},{"id":"6045f389946b0212","type":"link out","z":"27148b7bb9f62ac7","name":"every 1 min date","mode":"link","links":[],"x":635,"y":240,"wires":[]},{"id":"6ac4487e7df2d787","type":"link out","z":"27148b7bb9f62ac7","name":"every 1 min hour","mode":"link","links":["9258d34035c742aa","f4d57076103097ca","faa3a5726b7782f9","b90a16d2d2491c28"],"x":635,"y":240,"wires":[]},{"id":"d621148fcbed70b5","type":"subflow:94b2243985840d69","z":"27148b7bb9f62ac7","name":"","x":250,"y":240,"wires":[["f2224ce3aee6d9a1","b7688c47df6ff820"]]},{"id":"f2224ce3aee6d9a1","type":"function","z":"27148b7bb9f62ac7","name":"get date","func":"let d = new Date();\nlet year = d.getFullYear();\nlet month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1);\nlet day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n\nmsg.currentTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":240,"wires":[["6045f389946b0212"]]},{"id":"b7688c47df6ff820","type":"function","z":"27148b7bb9f62ac7","name":"get time","func":"let d = new Date();\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n\nmsg.currentTime = hour + \":\" + minute;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":240,"wires":[["6ac4487e7df2d787"]]},{"id":"539ca7ad9e3005c6","type":"inject","z":"27148b7bb9f62ac7","name":"@ 00:00","props":[],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","x":120,"y":180,"wires":[["f9f8f8a690320c67"]]},{"id":"f9f8f8a690320c67","type":"link out","z":"27148b7bb9f62ac7","name":"every day 00:00","mode":"link","links":["e53334a6f05a9609","7863c0c46cc71eac","fd04105f47ce87fa"],"x":215,"y":180,"wires":[]},{"id":"944639f843fd44ab","type":"comment","z":"27148b7bb9f62ac7","name":"Time Triggers","info":"","x":110,"y":120,"wires":[]},{"id":"d661cc3406383257","type":"link out","z":"27148b7bb9f62ac7","name":"link out 585","mode":"link","links":["f43a379928cdb87c"],"x":535,"y":580,"wires":[]},{"id":"f43a379928cdb87c","type":"link in","z":"27148b7bb9f62ac7","name":"link in 533","links":["d661cc3406383257"],"x":55,"y":640,"wires":[["054a45a62348feee"]]},{"id":"2eae8cb516ed8234","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":275,"y":640,"wires":[["d948331e1e1a1ea0"]],"l":false},{"id":"054a45a62348feee","type":"function","z":"27148b7bb9f62ac7","name":"speakers >","func":"msg.search = { \"is\": { linkedClass: \"speaker\" } };\nmsg.output_name = \"speakers\";\nmsg.outputEmptyResults = false;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":640,"wires":[["2eae8cb516ed8234"]]},{"id":"d948331e1e1a1ea0","type":"function","z":"27148b7bb9f62ac7","name":"prepare volume_level","func":"let speakers = msg.speakers;\nlet msgs = [];\n\nlet volume_level = \"\";\nif (msg.state == \"on\") {\n    volume_level = global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_day_mode_volume\"].state;\n} else {\n    volume_level = global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_night_mode_volume\"].state;\n}\n\nfor (var speaker of speakers) {\n    msgs.push({\n        \"payload\": {\n            \"data\":\n            {\n                \"entity_id\": speaker.entity_id,\n                \"volume_level\": (parseFloat(volume_level) / 100)\n            }\n        }\n    });\n}\n\nreturn [msgs];","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":640,"wires":[["dead0a185e6fd7a3"]]},{"id":"dead0a185e6fd7a3","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set volume_level","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"volume_level\":1}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":630,"y":640,"wires":[[]]},{"id":"2a983faf13adcb08","type":"server-events","z":"27148b7bb9f62ac7","name":"home assistant","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"home_assistant_client","eventData":"","waitForRunning":false,"outputProperties":[],"event_type":"","x":120,"y":780,"wires":[["c1300c5daedc2c05"]]},{"id":"c1300c5daedc2c05","type":"function","z":"27148b7bb9f62ac7","name":"services_loaded ?","func":"if (msg.payload == \"services_loaded\") {\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":780,"wires":[["4e8a3d91084a0847"]]},{"id":"5aa726b34e4a32c8","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"services_loaded","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_select.services_loaded","entityIdType":"exact","outputInitially":true,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"x":500,"y":780,"wires":[["9330d7a46b8da67b"]]},{"id":"9330d7a46b8da67b","type":"function","z":"27148b7bb9f62ac7","name":"services_loaded ?","func":"if (msg.state != \"services_loaded\") {\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":780,"wires":[["4e8a3d91084a0847"]]},{"id":"4e8a3d91084a0847","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set services_loaded","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":["input_select.services_loaded"],"data":"{\"options\":[\"services_loaded\"]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":825,"y":780,"wires":[["ad40d75b818090e5"]],"l":false},{"id":"ad40d75b818090e5","type":"function","z":"27148b7bb9f62ac7","name":"empty","func":"return {};","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":875,"y":780,"wires":[["3bc3a5a58e60b298"]],"l":false},{"id":"1770d849291ce33f","type":"link call","z":"27148b7bb9f62ac7","name":"","links":["39372af8f404c7d2"],"linkType":"static","timeout":"30","x":750,"y":840,"wires":[[]]},{"id":"a0c3e496d0b8d746","type":"comment","z":"27148b7bb9f62ac7","name":"Store global","info":"","x":1150,"y":320,"wires":[]},{"id":"465743c3abd5e93b","type":"inject","z":"27148b7bb9f62ac7","name":"20 min","props":[],"repeat":"","crontab":"*/20 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":1160,"y":380,"wires":[["18310823b818091c"]]},{"id":"d98be4ab452f9366","type":"comment","z":"27148b7bb9f62ac7","name":"Store / Restore global","info":"","x":1180,"y":460,"wires":[]},{"id":"39372af8f404c7d2","type":"link in","z":"27148b7bb9f62ac7","name":"store global","links":[],"x":1095,"y":520,"wires":[["2db885dcad63985b"]]},{"id":"be23d2c94351bfc5","type":"link out","z":"27148b7bb9f62ac7","name":"store global","mode":"return","links":[],"x":1575,"y":520,"wires":[]},{"id":"2db885dcad63985b","type":"function","z":"27148b7bb9f62ac7","name":"get global","func":"let notAcceptedGlobals = [\"homeassistant\", \"home_configuration\", \"notifications\"];\nlet acceptedGlobals = global.keys().filter(g => !(notAcceptedGlobals.includes(g)));\nlet globalStored = {};\n\nfor (let key of acceptedGlobals) {\n    getGlobal(key);\n}\nmsg.payload = globalStored;\nreturn msg;\n\nfunction getGlobal(key) {\n    globalStored[key] = global.get(key);\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1200,"y":520,"wires":[["b7b998be4656b030"]]},{"id":"702cfec1517daf84","type":"file","z":"27148b7bb9f62ac7","name":"write global","filename":"/config/global.yaml","filenameType":"str","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":1470,"y":520,"wires":[["be23d2c94351bfc5"]]},{"id":"04a97112197d0e34","type":"link in","z":"27148b7bb9f62ac7","name":"restore global","links":["5a948d8bd3b54aed"],"x":1095,"y":580,"wires":[["d8e2d3430d662e1a"]]},{"id":"32ffa9bfbbe77266","type":"function","z":"27148b7bb9f62ac7","name":"set global","func":"let globalStored = msg.payload;\n\nfor (let key of Object.keys(globalStored)) {\n    setGlobal(key);\n}\n\nfunction setGlobal(key) {\n    global.set(key, globalStored[key]);\n}","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1480,"y":580,"wires":[]},{"id":"b7b998be4656b030","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":1330,"y":520,"wires":[["702cfec1517daf84"]]},{"id":"7171cc4482e3f8e3","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":1350,"y":580,"wires":[["32ffa9bfbbe77266"]]},{"id":"d8e2d3430d662e1a","type":"file in","z":"27148b7bb9f62ac7","name":"read global","filename":"/config/global.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":1210,"y":580,"wires":[["7171cc4482e3f8e3"]]},{"id":"498d5d5a6cdccc72","type":"link out","z":"27148b7bb9f62ac7","name":"set global home_configuration","mode":"return","links":[],"x":495,"y":900,"wires":[]},{"id":"3bc3a5a58e60b298","type":"link call","z":"27148b7bb9f62ac7","name":"","links":["fe1ddbe2d3a7b4af"],"linkType":"static","timeout":"30","x":935,"y":780,"wires":[["5a948d8bd3b54aed"]],"l":false},{"id":"e618a3671a21523f","type":"link call","z":"27148b7bb9f62ac7","name":"","links":["fe1ddbe2d3a7b4af"],"linkType":"static","timeout":"30","x":475,"y":840,"wires":[["9ee803725022399b"]],"l":false},{"id":"fb8bc03d1f05f7a1","type":"file","z":"27148b7bb9f62ac7","name":"delete global","filename":"/config/global.yaml","filenameType":"str","appendNewline":true,"createDir":true,"overwriteFile":"delete","encoding":"none","x":370,"y":840,"wires":[["e618a3671a21523f"]]},{"id":"9ee803725022399b","type":"function","z":"27148b7bb9f62ac7","name":"set globals","func":"let notAcceptedGlobals = [\"homeassistant\", \"home_configuration\"];\nlet acceptedGlobals = global.keys().filter(g => !(notAcceptedGlobals.includes(g)));\n\nfor (let key of acceptedGlobals) {\n    setGlobal(key);\n}\n\nreturn msg;\n\nfunction setGlobal(name) {\n    global.set(name, undefined);\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":840,"wires":[["673a65ab8604e879","1770d849291ce33f"]]},{"id":"673a65ab8604e879","type":"link out","z":"27148b7bb9f62ac7","name":"ha reload","mode":"link","links":["584269b4c105222c","84edd99e67b149d7","ba01e397c4ca1e22","0bd80225f89703f5","33602f065ff47513","eec7f9eb929d0c53","68e929b9da9d1087"],"x":855,"y":840,"wires":[]},{"id":"18310823b818091c","type":"link call","z":"27148b7bb9f62ac7","name":"","links":["39372af8f404c7d2"],"linkType":"static","timeout":"30","x":1310,"y":380,"wires":[[]]},{"id":"d5127e4d8cdbc647","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":275,"y":1340,"wires":[["2b04a4f19304e695"]],"l":false},{"id":"2b04a4f19304e695","type":"function","z":"27148b7bb9f62ac7","name":"reset motion","func":"let areas = [...new Set(msg.motions.map(a => a.linkedArea))];\nlet ha_motions = msg.motions;\nlet motion_areas = {};\nlet motions = {};\n\nfor (let m of ha_motions) {\n    let state = [\"on\", \"off\"].includes(m.state) ? (m.invertedMotion ? { \"on\": \"off\", \"off\": \"on\" }[m.state] : m.state) : \"off\";\n    motions[m.entity_id] = { linkedArea: m.linkedArea, state: state };\n}\n\nfor (let a of areas) {\n    motion_areas[a] = ha_motions.filter(m => m.linkedArea === a)\n        .map(m => (m.invertedMotion ? { \"on\": \"off\", \"off\": \"on\" }[m.state] : m.state))\n        .reduce((a, b) => a === \"on\" || b === \"on\", false);\n    motion_areas[a] = motion_areas[a] ? \"on\" : \"off\";\n}\n\nglobal.set(\"motion_areas\", motion_areas);\nglobal.set(\"motions\", motions);\n\nreturn msg;","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":1340,"wires":[]},{"id":"eec7f9eb929d0c53","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["673a65ab8604e879"],"x":55,"y":1340,"wires":[["f3326575b5b09d6d"]]},{"id":"f3326575b5b09d6d","type":"function","z":"27148b7bb9f62ac7","name":"get motions","func":"msg = {\n    search: { \"is\": { linkedClass: \"motion\" } },\n    output_name: \"motions\",\n    outputEmptyResults: false\n};\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":1340,"wires":[["d5127e4d8cdbc647"]]},{"id":"68e929b9da9d1087","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["673a65ab8604e879"],"x":55,"y":1280,"wires":[["fac9fa218ad276dc"]]},{"id":"733c6885165ac499","type":"function","z":"27148b7bb9f62ac7","name":"set default cube","func":"let ha_cubes = msg.cubes;\nlet cubes = {};\n\nfor (let c of ha_cubes) {\n    if (cubes[c.linkedArea] === undefined) {\n        cubes[c.linkedArea] = { move: false, flip90: false, flip180: false, shake_air: false, free_fall: false, lightPower: 50, lightColor: 1 };\n    }\n}\n\nglobal.set(\"locked_lights\",[]);\nglobal.set(\"cubes\", cubes);","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":1280,"wires":[]},{"id":"fac9fa218ad276dc","type":"function","z":"27148b7bb9f62ac7","name":"cubes >","func":"msg.search = { \"is\": { linkedClass: \"cube\" } };\nmsg.output_name = \"cubes\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":1280,"wires":[["150b74163e43252f"]]},{"id":"150b74163e43252f","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":255,"y":1280,"wires":[["733c6885165ac499"]],"l":false},{"id":"5b9bce573b1cd4a6","type":"function","z":"27148b7bb9f62ac7","name":"set position","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet persons = global.get(\"persons\") ?? {};\nlet msgs = [];\n\nfor (let p of msg.persons) {\n    if (persons[p.entity_id] === undefined) {\n        persons[p.entity_id] = {};\n    }\n    persons[p.entity_id][\"home_distance\"] = p.state == \"home\" ? 0 : (home_configuration[\"zone.home\"][\"input_boolean.in_home_zone\"] + 1);\n}\n\nglobal.set(\"persons\", persons);\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":1040,"wires":[["8cebe9b921fa05e3"]]},{"id":"9a2954c4d8c5353d","type":"catch","z":"b0a488ea822145cf","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["8021f0f27fb5cd7f"]]},{"id":"8dd11e268884ab9a","type":"subflow:ad3b29a5dd67898f","z":"b0a488ea822145cf","name":"","x":460,"y":40,"wires":[]},{"id":"8021f0f27fb5cd7f","type":"change","z":"b0a488ea822145cf","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Inputs","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8dd11e268884ab9a"]]},{"id":"e3da1f773a813694","type":"server-events","z":"b0a488ea822145cf","name":"state_changed","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"state_changed","eventData":"","waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":120,"y":180,"wires":[["0b7500ea5c30d381","68d0f3dde93b0c04"]]},{"id":"f4f272db588afc8c","type":"function","z":"b0a488ea822145cf","name":"merge home configuration","func":"let notAcceptedStates = [\"none\", \"unavailable\", \"unknown\", \"\"];\nlet new_state = msg.event.new_state.state;\nlet old_state = msg.event.old_state.state;\n\nnew_state = notAcceptedStates.includes(new_state.toLowerCase()) ? undefined : new_state;\nold_state = notAcceptedStates.includes(old_state.toLowerCase()) ? undefined : old_state;\n\nmsg = {\n    ...msg.entities[0],\n    new_state: format_state(new_state),\n    old_state: format_state(old_state),\n    attributes: msg.event.new_state.attributes\n};\n\nreturn msg;\n\nfunction format_state(state) {\n    return typeof state === \"undefined\" ? null : isNaN(state) ? state : parseFloat(state);\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":180,"wires":[["35834f876d14830a"]]},{"id":"83149648f50a5823","type":"switch","z":"b0a488ea822145cf","name":"int_temperature","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"int_temperature","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":360,"y":380,"wires":[["24ab4985eeb3bce0"]]},{"id":"35834f876d14830a","type":"link out","z":"b0a488ea822145cf","name":"link out 557","mode":"link","links":["7ee1ad2e97694b04","550775e4dede6915","3bfee2fb76d9aa7c","93a4cd9dcd47133c","ee03bb71d931132b","172727433576b0a4","848b54066f08d3c9","335f89b173aca00d","19cd9a8c1409d3ce","48cb735ff4e524b7","2b26dd0bb627eadf","9887e88aa919963c","55d7bf3721ad771b","af404009f4055a73","162a7c1d9e51be9d","235e6643ff9fc367"],"x":1325,"y":180,"wires":[]},{"id":"9c7df55791fc9d6a","type":"switch","z":"b0a488ea822145cf","name":"ext_temperature","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"ext_temperature","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":180,"y":380,"wires":[["24ab4985eeb3bce0"]]},{"id":"7ee1ad2e97694b04","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":380,"wires":[["9c7df55791fc9d6a","83149648f50a5823"]]},{"id":"9d7f2e1f5cd7ca2b","type":"switch","z":"b0a488ea822145cf","name":"ext_humidity","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"ext_humidity","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":500,"wires":[["2764ae2e723dd42e"]]},{"id":"550775e4dede6915","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":500,"wires":[["9d7f2e1f5cd7ca2b","8d0dcd85aaaa60e9"]]},{"id":"8d0dcd85aaaa60e9","type":"switch","z":"b0a488ea822145cf","name":"int_humidity","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"int_humidity","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":330,"y":500,"wires":[["2764ae2e723dd42e"]]},{"id":"1efa7c0f6d0198aa","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":1250,"y":380,"wires":[]},{"id":"24ab4985eeb3bce0","type":"function","z":"b0a488ea822145cf","name":"set global","func":"let temperatureMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state);\nlet temperatureMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet temperatures = global.get(\"temperatures\") || {};\n\nlet linkedClass = msg.linkedClass;\nlet linkedArea = msg.linkedArea;\nlet value = msg.new_state;\nlet alias = msg.alias;\n\nif (temperatures[linkedArea] === undefined || isNaN(temperatures[linkedArea]?.value)) {\n    temperatures[linkedArea] = {};\n    temperatures[linkedArea].value = value;\n    temperatures[linkedArea].mean_hour = value;\n    temperatures[linkedArea].lastChanged = new Date().getTime();\n}\n\nlet timeElapsed = parseInt((new Date().getTime() - temperatures[linkedArea].lastChanged) / 1000);\nlet mean_10min = meanCalc(timeElapsed, 600, value, temperatures[linkedArea].value);\nlet mean_hour = meanCalc(timeElapsed, 3600, mean_10min, temperatures[linkedArea].mean_hour);\nlet mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000;\n\ntemperatures[linkedArea].high = temperatureMax <= (Math.ceil(10 * mean_10min) / 10);\ntemperatures[linkedArea].low = (Math.ceil(10 * mean_10min) / 10) <= temperatureMin;\ntemperatures[linkedArea].lastChanged = new Date().getTime();\ntemperatures[linkedArea].tendency = mean_hour_tendency;\ntemperatures[linkedArea].mean_hour = mean_hour;\ntemperatures[linkedArea].value = mean_10min;\n\nglobal.set(\"temperatures\", temperatures);\nmsg = { entity_id: msg.linkedEntity, state: mean_10min };\nreturn msg;\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed;\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":380,"wires":[["1efa7c0f6d0198aa"]]},{"id":"2764ae2e723dd42e","type":"function","z":"b0a488ea822145cf","name":"set global","func":"let humidityMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state);\nlet humidityMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state);\nlet humidities = global.get(\"humidities\") ?? {};\n\nlet linkedClass = msg.linkedClass;\nlet linkedArea = msg.linkedArea;\nlet value = msg.new_state;\nlet alias = msg.alias;\n\nif (humidities[linkedArea] === undefined || isNaN(humidities[linkedArea]?.value)) {\n    humidities[linkedArea] = {};\n    humidities[linkedArea].value = value;\n    humidities[linkedArea].mean_hour = value;\n    humidities[linkedArea].lastChanged = new Date().getTime();\n}\n\nlet timeElapsed = parseInt((new Date().getTime() - humidities[linkedArea].lastChanged) / 1000);\nlet mean_10min = meanCalc(timeElapsed, 600, value, humidities[linkedArea].value);\nlet mean_hour = meanCalc(timeElapsed, 3600, mean_10min, humidities[linkedArea].mean_hour);\nlet mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000;\n\nhumidities[linkedArea].high = humidityMax <= (Math.ceil(10 * mean_10min) / 10);\nhumidities[linkedArea].low = (Math.ceil(10 * mean_10min) / 10) <= humidityMin;\nhumidities[linkedArea].lastChanged = new Date().getTime();\nhumidities[linkedArea].tendency = mean_hour_tendency;\nhumidities[linkedArea].mean_hour = mean_hour;\nhumidities[linkedArea].value = mean_10min;\n\nglobal.set(\"humidities\", humidities);\nmsg = { entity_id: msg.linkedEntity, state: mean_10min };\nreturn msg;\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed;\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":500,"wires":[["6cf5484ebaf1776b"]]},{"id":"6cf5484ebaf1776b","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":1250,"y":500,"wires":[]},{"id":"0646f3d0a39edf83","type":"link out","z":"b0a488ea822145cf","name":"detect cover","mode":"link","links":["ff8917fbe0e53ade"],"x":1325,"y":620,"wires":[]},{"id":"3bfee2fb76d9aa7c","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":620,"wires":[["11e02d5d042c4dcd"]]},{"id":"11e02d5d042c4dcd","type":"switch","z":"b0a488ea822145cf","name":"cover","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"cover","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":620,"wires":[["0646f3d0a39edf83"]]},{"id":"da6208c061cdc94f","type":"function","z":"b0a488ea822145cf","name":"set","func":"let acceptedStates = [\"on\", \"off\"];\n\nif (acceptedStates.includes(msg.old_state) && acceptedStates.includes(msg.new_state) && msg.old_state != msg.new_state) {\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":740,"wires":[["0dac8a656e626a27"]]},{"id":"93a4cd9dcd47133c","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":740,"wires":[["05e6efa3f0799cad"]]},{"id":"05e6efa3f0799cad","type":"switch","z":"b0a488ea822145cf","name":"window","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"window","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":740,"wires":[["da6208c061cdc94f"]]},{"id":"0dac8a656e626a27","type":"link out","z":"b0a488ea822145cf","name":"detect windows","mode":"link","links":["f4d57076103097ca","071b9264580b2b11","820d17520ea5b902"],"x":1325,"y":740,"wires":[]},{"id":"d6b63ae28e7cc0de","type":"function","z":"b0a488ea822145cf","name":"light","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet motion_areas = global.get(\"motion_areas\") ?? {};\nlet locked_lights = global.get(\"locked_lights\") ?? [];\n\nif (in_home_zone && !(locked_lights.includes(msg.entity_id))) {\n    let state = motion_areas[msg.linkedArea] !== undefined ? motion_areas[msg.linkedArea] : \"off\";\n    msg = {\n        entity_id: msg.entity_id,\n        linkedArea: msg.linkedArea,\n        linkedClass: msg.linkedClass,\n        state: state\n    };\n    return [msg, null];\n} else {\n    msg = { entity_id: msg.entity_id, state: \"off\" };\n    return [null, msg];\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":1100,"wires":[["c18b36325001bf4a"],["c9402e052dee3456"]]},{"id":"3b9268f592e1ea89","type":"function","z":"b0a488ea822145cf","name":"set","func":"if (msg.old_state === null && msg.new_state != null) {\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":1100,"wires":[["d6b63ae28e7cc0de"]]},{"id":"a54be99d7e32ea7c","type":"link out","z":"b0a488ea822145cf","name":"detect light","mode":"link","links":["13a390949bac6841"],"x":1325,"y":1100,"wires":[]},{"id":"c9402e052dee3456","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":610,"y":1100,"wires":[]},{"id":"28f47d3814ea186d","type":"delay","z":"b0a488ea822145cf","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":235,"y":1100,"wires":[["3b9268f592e1ea89"]],"l":false},{"id":"ee03bb71d931132b","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1100,"wires":[["90d791834e5c48a6"]]},{"id":"90d791834e5c48a6","type":"switch","z":"b0a488ea822145cf","name":"light","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"light","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":1100,"wires":[["28f47d3814ea186d"]]},{"id":"1988e93c3898f2f1","type":"link out","z":"b0a488ea822145cf","name":"cube","mode":"link","links":["17df8120f9c53aca"],"x":1325,"y":1280,"wires":[]},{"id":"2320d6c30e5b13d2","type":"function","z":"b0a488ea822145cf","name":"set cubes","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet lightColorOptions = [0, 30, 60, 90, 120, 150, 180, 210, 240, 260, 300, 330];\nlet cubes = global.get(\"cubes\") ?? {};\nlet msgs = [];\n\nif (cubes[msg.linkedArea] === undefined) {\n    cubes[msg.linkedArea] = { move: true, flip90: false, flip180: false, shake_air: false, free_fall: false, lightPower: 50, lightColor: 1 };\n}\n\nif (msg.action_type == \"flip180\" && msg.linkedSelectAmbiance !== undefined) {\n    msgs.push({\n        type: \"ambiance\",\n        entity_id: msg.linkedSelectAmbiance,\n        action_type: \"select_option\",\n        payload: { data: { option: randomAmbiance(home_configuration.ambiance_config.ambiances_type) } }\n    });\n    return saveAndReturn();\n} else if (msg.action_type == \"flip90\") {\n    if (!cubes[msg.linkedArea].flip180) {\n        if (!cubes[msg.linkedArea].flip90) {\n            cubes[msg.linkedArea].flip90 = true;\n            msg.lightColor = lightColorOptions[cubes[msg.linkedArea].lightColor];\n            msg.sound = \"light_auto_off.mp3\";\n        } else {\n            cubes[msg.linkedArea].lightColor = cubes[msg.linkedArea].lightColor + 1 > 11 ? 0 : cubes[msg.linkedArea].lightColor + 1;\n            msg.lightColor = lightColorOptions[cubes[msg.linkedArea].lightColor];\n            cubes[msg.linkedArea].move = true;\n        }\n        cubes[msg.linkedArea].lightPower = lightPower();\n        cubes[msg.linkedArea].free_fall = false;\n        msg.lightPower = cubes[msg.linkedArea].lightPower;\n        msg.colorTemp = 300;\n        msg.cube = cubes[msg.linkedArea];\n        msgs.push({ ...msg, type: \"cube\" });\n        return saveAndReturn();\n    }\n} else if (msg.action_type == \"tap_twice\") {\n    if (cubes[msg.linkedArea].flip90) {\n        cubes[msg.linkedArea].flip90 = false;\n        cubes[msg.linkedArea].free_fall = false;\n        msg.sound = \"light_auto_on.mp3\";\n        msg.cube = cubes[msg.linkedArea];\n        msgs.push({ ...msg, type: \"cube\" });\n    } else if (cubes[msg.linkedArea].flip180 && \"linkedSelectAmbiance\" in msg) {\n        cubes[msg.linkedArea].flip180 = false;\n        cubes[msg.linkedArea].free_fall = false;\n        msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: \"select_first\" });\n    }\n    return saveAndReturn();\n} else if (msg.action_type == \"shake_air\" && !cubes[msg.linkedArea].free_fall) {\n    if (!cubes[msg.linkedArea].flip90) {\n        cubes[msg.linkedArea].flip90 = true;\n        msg.sound = \"light_auto_off.mp3\";\n    } else {\n        msg.sound = \"fall.mp3\";\n    }\n    cubes[msg.linkedArea].shake_air = !cubes[msg.linkedArea].shake_air;\n    msg.lightPower = cubes[msg.linkedArea].lightPower;\n    msg.lightColor = lightColorOptions[cubes[msg.linkedArea].lightColor];\n    msg.colorTemp = 300;\n    msg.cube = cubes[msg.linkedArea];\n    msgs.push({ ...msg, type: \"cube\" });\n    return saveAndReturn();\n} else if (msg.action_type == \"rotate\" && cubes[msg.linkedArea].flip90 && !cubes[msg.linkedArea].free_fall ) {\n    if (!cubes[msg.linkedArea].flip180) {\n        cubes[msg.linkedArea].lightPower = lightPower();\n        msg.lightPower = cubes[msg.linkedArea].lightPower;\n        msg.lightColor = lightColorOptions[cubes[msg.linkedArea].lightColor];\n        msg.cube = cubes[msg.linkedArea];\n        msgs.push({ ...msg, type: \"cube\" });\n    } else if (\"linkedSelectAmbiance\" in msg) {\n        let action_type = msg.action_value < 0 ? \"select_previous\" : \"select_next\";\n        msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: action_type });\n    }\n    return saveAndReturn();\n} else if (msg.action_type == \"free_fall\") {\n    if (!cubes[msg.linkedArea].flip90) {\n        cubes[msg.linkedArea].flip90 = true;\n        msg.sound = \"light_auto_off.mp3\";\n    } else {\n        msg.sound = \"fall.mp3\";\n    }\n    cubes[msg.linkedArea].free_fall = !cubes[msg.linkedArea].free_fall;\n    msg.lightColor = lightColorOptions[cubes[msg.linkedArea].lightColor];\n    msg.lightPower = cubes[msg.linkedArea].lightPower;\n    msg.colorTemp = 300;\n    msg.cube = cubes[msg.linkedArea];\n    msgs.push({ ...msg, type: \"cube\" });\n    return saveAndReturn();\n} else if (msg.action_type == \"move\" && !cubes[msg.linkedArea].free_fall) {\n    if (cubes[msg.linkedArea].flip90) {\n        cubes[msg.linkedArea].move = !cubes[msg.linkedArea].move;\n        msg.lightColor = lightColorOptions[cubes[msg.linkedArea].lightColor];\n        msg.colorTemp = 300;\n        msg.cube = cubes[msg.linkedArea];\n        msgs.push({ ...msg, type: \"cube\" });\n        return saveAndReturn();\n    }\n}\n\nfunction lightPower() {\n    let action_value = msg.action_value * msg.rotate_ratio;\n    if (cubes[msg.linkedArea].lightPower + action_value >= 1 && cubes[msg.linkedArea].lightPower + action_value <= 100) {\n        return cubes[msg.linkedArea].lightPower + action_value;\n    } else if (cubes[msg.linkedArea].lightPower + action_value < 1) {\n        return 1;\n    } else if (cubes[msg.linkedArea].lightPower + action_value > 100) {\n        return 100;\n    }\n}\n\nfunction randomAmbiance(ambiances_type) {\n    let ambiancesTypeKeys = Object.keys(ambiances_type);\n    let ambiancesType = [];\n    for (let key of ambiancesTypeKeys) {\n        ambiancesType.push(ambiances_type[key].name);\n    }\n    return ambiancesType[1 + Math.floor(Math.random() * 7)];\n}\n\nfunction saveAndReturn() {\n    global.set(\"cubes\", cubes);\n    return [msgs];\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":1280,"wires":[["31c2f0756e93226a"]]},{"id":"31c2f0756e93226a","type":"switch","z":"b0a488ea822145cf","name":"type","property":"type","propertyType":"msg","rules":[{"t":"eq","v":"cube","vt":"str"},{"t":"eq","v":"ambiance","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":1280,"wires":[["c1b4a74898adacf9"],["77de73dcc59dc611"]]},{"id":"0217a8f2e64aa4e3","type":"function","z":"b0a488ea822145cf","name":"set","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet action_value = msg.payload?.event?.action_value ?? 0;\nlet action_type = msg.payload.event.action_type;\n\nif (in_home_zone) {\n    let actions = {\n        tap_twice: \"tap_twice\",\n        shake_air: \"shake_air\",\n        move: \"move\",\n        free_fall: \"free_fall\",\n        rotate: \"rotate\",\n        flip180: \"flip180\",\n        flip90: \"flip90\"\n    };\n\n    if (actions[action_type] !== undefined) {\n        msg = {\n            action_type: action_type,\n            action_value: action_value,\n            rotate_ratio: 1,\n            ...msg.entities[0]\n        };\n        return msg;\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":1220,"wires":[["953bda94beb9e83c"]]},{"id":"77de73dcc59dc611","type":"api-call-service","z":"b0a488ea822145cf","name":"select ambiance","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"{{action_type}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":440,"y":1280,"wires":[[]]},{"id":"efb358c26bdb79cf","type":"server-events","z":"b0a488ea822145cf","name":"cube bluetooth","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"xiaomi_aqara.cube_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"x":120,"y":1220,"wires":[["ae713fccd5a5bd24"]]},{"id":"d38d167147229091","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":355,"y":1220,"wires":[["0217a8f2e64aa4e3"]],"l":false},{"id":"ae713fccd5a5bd24","type":"function","z":"b0a488ea822145cf","name":"cube >","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\n\nif (msg.payload.entity_id in home_configuration){\n    msg.search = { \"is\": { entity_id: msg.payload.entity_id } };\n    msg.output_name = \"entities\";\n    msg.outputEmptyResults = false;\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":1220,"wires":[["d38d167147229091"]]},{"id":"25e352984b33cace","type":"switch","z":"b0a488ea822145cf","name":"cube","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"cube","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":1220,"wires":[["7a9965c4d48673b7"]]},{"id":"172727433576b0a4","type":"link in","z":"b0a488ea822145cf","name":"link in 514","links":["35834f876d14830a","0cf11232ebd2a229"],"x":555,"y":1220,"wires":[["25e352984b33cace"]]},{"id":"9560131ccbbc20d7","type":"link out","z":"b0a488ea822145cf","name":"ambiance","mode":"link","links":["57970c88e211ce04"],"x":1325,"y":1520,"wires":[]},{"id":"da2c67c6936e602f","type":"function","z":"b0a488ea822145cf","name":"set ambiance","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet ambiances = global.get(\"ambiances\") ?? {};\n\nif (ambiances[msg.linkedAmbiance] === undefined) {\n        ambiances[msg.linkedAmbiance] = {};\n        ambiances[msg.linkedAmbiance].current = \"stop\";\n}\n\nlet new_action_type = msg.action_type == \"stop\" ? \"stop\" : selectAmbiance(msg.action_type);\nif (ambiances[msg.linkedAmbiance].current != new_action_type) {\n        msg = { ...msg, ...home_configuration[msg.linkedAmbiance] };\n        msg.ambiance_config = home_configuration.ambiance_config;\n        msg.restore = new_action_type == \"stop\";\n        msg.action_type = new_action_type;\n        ambiances[msg.linkedAmbiance].current = new_action_type;\n        global.set(\"ambiances\", ambiances);\n        return msg;\n}\n\nfunction selectAmbiance(action_type) {\n        let ambiancesTypeKeys = Object.keys(home_configuration.ambiance_config.ambiances_type);\n        let ambiancesType = [];\n        for (let key of ambiancesTypeKeys) {\n                if (home_configuration.ambiance_config.ambiances_type[key].name == action_type) {\n                        return key;\n                }\n                ambiancesType.push(key);\n        }\n        if (action_type == \"random\") {\n                return ambiancesType[1 + Math.floor(Math.random() * 7)];\n        }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":1520,"wires":[["9560131ccbbc20d7","c213381e51734770"]]},{"id":"87db1d61519614c5","type":"function","z":"b0a488ea822145cf","name":"set cube","func":"let globalCubes = global.get(\"cubes\") ?? {};\nlet cubes = msg.cubes;\n\nif (cubes.length != 0) {\n    for (let cube of cubes) {\n        if (!(cube.linkedArea in cubes)) {\n            globalCubes[cube.linkedArea] = {};\n            globalCubes[cube.linkedArea].move = true;\n            globalCubes[cube.linkedArea].flip90 = false;\n            globalCubes[cube.linkedArea].flip180 = false;\n            globalCubes[cube.linkedArea].shake_air = false;\n            globalCubes[cube.linkedArea].free_fall = false;\n            globalCubes[cube.linkedArea].lightPower = 3;\n            globalCubes[cube.linkedArea].lightColor = 0;\n        }\n        globalCubes[cube.linkedArea].flip180 = msg.action_type != \"stop\";\n        globalCubes[cube.linkedArea].flip90 = false;\n        globalCubes[cube.linkedArea].free_fall = false;\n    }\n    global.set(\"cubes\", globalCubes);\n}","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":1520,"wires":[]},{"id":"b541021a9e9daaa1","type":"function","z":"b0a488ea822145cf","name":"set","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\n\nif (in_home_zone && msg.old_state != msg.new_state) {\n    msg.action_type = msg.new_state;\n    return [msg, null];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":1520,"wires":[["da2c67c6936e602f"]]},{"id":"c213381e51734770","type":"function","z":"b0a488ea822145cf","name":"cube >","func":"msg.search = { \"is\": { linkedClass: \"cube\", linkedAmbiance: msg.linkedAmbiance } };\nmsg.output_name = \"cubes\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":1520,"wires":[["25188f615ad9509c"]]},{"id":"29553ac9da1f61c0","type":"switch","z":"b0a488ea822145cf","name":"ambiance_select","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"ambiance_select","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":190,"y":1520,"wires":[["b541021a9e9daaa1"]]},{"id":"848b54066f08d3c9","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1520,"wires":[["29553ac9da1f61c0"]]},{"id":"7a9965c4d48673b7","type":"switch","z":"b0a488ea822145cf","name":"zigbee","property":"linkedType","propertyType":"msg","rules":[{"t":"eq","v":"zigbee","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":770,"y":1220,"wires":[["dfe0821b605be8ee"]]},{"id":"dfe0821b605be8ee","type":"function","z":"b0a488ea822145cf","name":"set","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\n\nif (in_home_zone && msg.new_state) {\n    let actions = {\n        tap: \"tap_twice\",\n        shake: \"shake_air\",\n        slide: \"move\",\n        fall: \"free_fall\",\n        rotate_right: \"rotate\",\n        rotate_left: \"rotate\",\n        flip180: \"flip180\",\n        flip90: \"flip90\"\n    };\n\n    let action_angle = 0;\n    if (!isNaN(msg.new_state)) {\n        action_angle = msg.new_state;\n        msg.new_state = action_angle < 0 ? \"rotate_left\" : \"rotate_right\";\n    }\n\n    if (msg.new_state in actions) {\n        msg.entity_id = msg.entity_id;\n        msg.action_type = actions[msg.new_state];\n        msg.action_value = action_angle;\n        msg.rotate_ratio = 0.285;\n        return msg;\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":1220,"wires":[["953bda94beb9e83c"]]},{"id":"a242ca4c4a9390af","type":"function","z":"b0a488ea822145cf","name":"get localTime","func":"if (msg.new_state === null) {\n    let date = new Date();\n    msg.localTime = cleanDate(new Date(date.setHours(date.getHours() - 24)));\n    return msg;\n} else {\n    let localTime = msg.attributes[\"Local Time\"].split(\"+\");\n    msg.localTime = cleanDate(new Date(localTime[0] + \"+00:00 \" + localTime[1].split(\" \")[1]));\n    return msg;\n}\n\nfunction cleanDate(dateString) {\n    dateString = dateString.toISOString().replace(\"T\", \" \").split(\".\")[0];\n    return dateString.substring(0, dateString.lastIndexOf(\":\"));\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":1760,"wires":[["e00fdc26c9fdc8f9"]]},{"id":"c2410a88b6c1c1be","type":"function","z":"b0a488ea822145cf","name":"set distance","func":"if (msg.new_state === null || msg.new_state === \"home\") {\n    msg.payload = 0;\n    return msg;\n} else if (typeof msg.attributes?.latitude === \"number\" && typeof msg.attributes?.longitude === \"number\") {\n    let zoneHomePosition = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes;\n    let lat1 = zoneHomePosition.latitude;\n    let lon1 = zoneHomePosition.longitude;\n    let lat2 = msg.attributes.latitude;\n    let lon2 = msg.attributes.longitude;\n\n    msg.payload = calculateDistance(lat1, lon1, lat2, lon2);\n    return msg;\n} else {\n    let in_big_zone = global.get(\"home_configuration\")[\"zone.home\"]?.[\"input_boolean.in_big_zone\"];\n    if (typeof in_big_zone === \"number\") {\n        msg.payload = in_big_zone;\n        return msg;\n    }\n}\n\nfunction calculateDistance(lat1, lon1, lat2, lon2) {\n    let R = 6371e3;\n    lat1 = lat1 * (Math.PI / 180);\n    lon1 = lon1 * (Math.PI / 180);\n    lat2 = lat2 * (Math.PI / 180);\n    lon2 = lon2 * (Math.PI / 180);\n    let dlat = lat2 - lat1;\n    let dlon = lon2 - lon1;\n    let a = Math.pow(Math.sin(dlat / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(dlon / 2), 2);\n    let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n    let d = R * c;\n    return Math.round(d);\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":1640,"wires":[["ddec361b1dcc534b"]]},{"id":"ddec361b1dcc534b","type":"function","z":"b0a488ea822145cf","name":"set position","func":"let persons = global.get(\"persons\") ?? {};\nlet person = msg.entity_id;\n\nif (persons[person] === undefined) {\n    persons[person] = {};\n}\n\nif (persons[person].home_distance != msg.payload) {\n    persons[person].home_distance = msg.payload;\n    global.set(\"persons\", persons);\n    return msg;\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":1640,"wires":[["550ba74f65825b54"]]},{"id":"550ba74f65825b54","type":"link out","z":"b0a488ea822145cf","name":"detect persons position","mode":"link","links":["837f5e57291454a2"],"x":1325,"y":1640,"wires":[]},{"id":"082be752577fcad0","type":"function","z":"b0a488ea822145cf","name":"set phone_bluetooth","func":"let persons = global.get(\"persons\") ?? {};\n\nif (msg.attributes?.connected_paired_devices !== undefined) {\n    let pairedDevices = msg.attributes.connected_paired_devices;\n    let bluetooth = {};\n\n    if (persons[msg.linkedPerson] === undefined) {\n        persons[msg.linkedPerson] = {};\n    }\n\n    for (let pairedDevice of pairedDevices) {\n        let splitDevice = pairedDevice.split(\" (\");\n        bluetooth[splitDevice[0]] = splitDevice[1].replaceAll(\")\", \"\");\n    }\n\n    persons[msg.linkedPerson].bluetooth = bluetooth;\n    global.set(\"persons\", persons);\n    return msg;\n}\n","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1240,"y":1940,"wires":[]},{"id":"e00fdc26c9fdc8f9","type":"function","z":"b0a488ea822145cf","name":"set alarm","func":"let person = global.get(\"home_configuration\")[msg.linkedPerson] ?? {};\nlet persons = global.get(\"persons\") ?? {};\n\nif (person.alarm_clock === msg.entity_id) {\n    if (persons[msg.linkedPerson] === undefined){\n        persons[msg.linkedPerson] = {};\n    }\n    persons[msg.linkedPerson].alarm = msg.localTime;\n    global.set(\"persons\", persons);\n    return msg;\n}","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":1760,"wires":[]},{"id":"3d4e8ffbc3908b71","type":"function","z":"b0a488ea822145cf","name":"set","func":"let persons = msg.persons;\n\nfor (let person of persons) {\n    if (person.alarm_clock !== undefined && Object.keys(person.alarm_clock).length === 7) {\n        let date = new Date();\n        let timeZoneOffset = -date.getTimezoneOffset() / 60;\n        let timeZoneDate = new Date(date.setHours(date.getHours() + timeZoneOffset));\n        if (timeZoneDate.getDay() in person.alarm_clock) {\n            msg.localTime = timeZoneDate.toISOString().split(\"T\")[0] + \" \" + person.alarm_clock[timeZoneDate.getDay()];\n            msg.linkedPerson = person.entity_id;\n            return msg;\n        }\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":1820,"wires":[["c6559f5c6f1cd469"]]},{"id":"ddb05597bb261331","type":"function","z":"b0a488ea822145cf","name":"persons >","func":"msg.search = { \"is\": { linkedClass: \"person\" } };\nmsg.output_name = \"persons\";\nmsg.outputEmptyResults = false;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":1820,"wires":[["bb2aace77e1c2ba4"]]},{"id":"c6559f5c6f1cd469","type":"function","z":"b0a488ea822145cf","name":"set alarm","func":"let persons = global.get(\"persons\") ?? {};\n\nif (persons[msg.linkedPerson] === undefined) {\n    persons[msg.linkedPerson] = {};\n}\npersons[msg.linkedPerson].alarm = msg.localTime;\nglobal.set(\"persons\", persons);\nreturn msg;","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":1820,"wires":[]},{"id":"25188f615ad9509c","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":715,"y":1520,"wires":[["87db1d61519614c5"]],"l":false},{"id":"335f89b173aca00d","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1640,"wires":[["eca8c0360552140b"]]},{"id":"eca8c0360552140b","type":"switch","z":"b0a488ea822145cf","name":"person position","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"person","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":180,"y":1640,"wires":[["c2410a88b6c1c1be"]]},{"id":"19cd9a8c1409d3ce","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":155,"y":1760,"wires":[["d399d5e266fa5c55"]]},{"id":"d399d5e266fa5c55","type":"switch","z":"b0a488ea822145cf","name":"phone_alarm","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"phone_alarm","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":270,"y":1760,"wires":[["a242ca4c4a9390af"]]},{"id":"bb2aace77e1c2ba4","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":255,"y":1820,"wires":[["3d4e8ffbc3908b71"]],"l":false},{"id":"48cb735ff4e524b7","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":155,"y":1940,"wires":[["e480083b0a2e3b9c"]]},{"id":"e480083b0a2e3b9c","type":"switch","z":"b0a488ea822145cf","name":"phone_bluetooth","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"phone_bluetooth","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":1940,"wires":[["082be752577fcad0"]]},{"id":"625143d7bd1c5349","type":"function","z":"b0a488ea822145cf","name":"area mean","func":"let areas = {};\nlet msgs = [];\n\nfor (let entity of msg.entities) {\n    if (!isNaN(entity.state)) {\n        if (!(entity.linkedArea in areas)) {\n            areas[entity.linkedArea] = { linkedEntity: entity.linkedEntity, states: [] };\n            areas[entity.linkedArea][\"states\"].push(entity.state);\n        } else {\n            areas[entity.linkedArea][\"states\"].push(entity.state);\n        }\n    }\n}\n\nfor (let keys of Object.keys(areas)) {\n    msgs.push({\n        linkedArea: keys,\n        linkedEntity: areas[keys][\"linkedEntity\"],\n        state: areas[keys][\"states\"].reduce((ps, a) => ps + a, 0) / areas[keys][\"states\"].length\n    });\n}\n\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":2060,"wires":[["566194fc20b61a47"]]},{"id":"61c0d8738882ce35","type":"link out","z":"b0a488ea822145cf","name":"securityIntrusion","mode":"link","links":["0e4549bc46893207","514ddcb3e84c5765","667c5ae4e1bcd5dc"],"x":1325,"y":2180,"wires":[]},{"id":"75b04fc1276a4aaf","type":"subflow:d193bde43bd55f9f","z":"b0a488ea822145cf","name":"","x":1240,"y":2300,"wires":[]},{"id":"1abcc2cc00495b3f","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":810,"y":2060,"wires":[]},{"id":"af01780a5f7c39bd","type":"function","z":"b0a488ea822145cf","name":"set","func":"let acceptedStates = [\"on\", \"off\"];\n\nif (\n    (msg.securityIntrusion ?? false)\n    && msg.new_state === \"on\"\n    && acceptedStates.includes(msg.old_state)\n    && msg.old_state !== msg.new_state\n) {\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":2180,"wires":[["61c0d8738882ce35"]]},{"id":"09937216bea66806","type":"link out","z":"b0a488ea822145cf","name":"illuminance","mode":"link","links":["42bcf58ce90dbbb4"],"x":1325,"y":2060,"wires":[]},{"id":"b90a16d2d2491c28","type":"link in","z":"b0a488ea822145cf","name":"","links":["6ac4487e7df2d787"],"x":55,"y":2060,"wires":[["098b94853134acdc"]]},{"id":"2b26dd0bb627eadf","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":2180,"wires":[["99b97679308cb2f6"]]},{"id":"99b97679308cb2f6","type":"switch","z":"b0a488ea822145cf","name":"securityIntrusion","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"motion","vt":"str"},{"t":"eq","v":"window","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":180,"y":2180,"wires":[["af01780a5f7c39bd"],["af01780a5f7c39bd"]]},{"id":"9887e88aa919963c","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":2300,"wires":[["9cfeb3b918c756fb"]]},{"id":"9cfeb3b918c756fb","type":"switch","z":"b0a488ea822145cf","name":"remote","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"remote","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":2300,"wires":[["75b04fc1276a4aaf"]]},{"id":"0b7500ea5c30d381","type":"link out","z":"b0a488ea822145cf","name":"link out 560","mode":"link","links":["787f22bbb5e68f17"],"x":235,"y":180,"wires":[]},{"id":"ff416891929159b6","type":"link in","z":"b0a488ea822145cf","name":"target_phone_alarm","links":[],"x":55,"y":1760,"wires":[["585fb257a6175683","a242ca4c4a9390af"]]},{"id":"cce3e239031b7743","type":"link in","z":"b0a488ea822145cf","name":"target_phone_bluetooth","links":[],"x":55,"y":1940,"wires":[["fa497e7d79c453f7","082be752577fcad0"]]},{"id":"585fb257a6175683","type":"link out","z":"b0a488ea822145cf","name":"link out 562","mode":"return","links":[],"x":105,"y":1760,"wires":[]},{"id":"fa497e7d79c453f7","type":"link out","z":"b0a488ea822145cf","name":"link out 563","mode":"return","links":[],"x":105,"y":1940,"wires":[]},{"id":"55d7bf3721ad771b","type":"link in","z":"b0a488ea822145cf","name":"link in 522","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1400,"wires":[["63235491072c87b8"]]},{"id":"63235491072c87b8","type":"switch","z":"b0a488ea822145cf","name":"knob","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"knob","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":1400,"wires":[["0ed249de6653762a"]]},{"id":"8d5f228667170105","type":"link in","z":"b0a488ea822145cf","name":"link in 523","links":["953bda94beb9e83c"],"x":55,"y":1280,"wires":[["2320d6c30e5b13d2"]]},{"id":"953bda94beb9e83c","type":"link out","z":"b0a488ea822145cf","name":"link out 573","mode":"link","links":["8d5f228667170105"],"x":1325,"y":1220,"wires":[]},{"id":"02dc4707c52aba01","type":"function","z":"b0a488ea822145cf","name":"set","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet home_configuration = global.get(\"home_configuration\") ?? {};\nlet new_state = msg.new_state;\nlet knobKey = msg.linkedKnob;\n\nif (new_state !== null && in_home_zone && home_configuration[knobKey] !== undefined) {\n    let knob = home_configuration[knobKey];\n    let msgs = [];\n\n    let lights = [];\n    for (let l of knob.linkedLights) {\n        lights.push(global.get(\"homeassistant\").homeAssistant.states[l]);\n    }\n\n    if (new_state.includes(\"toggle\")) {\n        msg = { service: \"toggle\", payload: { data: { \"entity_id\": knob.linkedLights, color_temp: 300 } } };\n        return msg;\n    } else if (new_state.length == 2) {\n        let typeIndex = typeof new_state[0] === \"string\" ? 0 : 1;\n        let stepIndex = typeof new_state[0] === \"number\" ? 0 : 1;\n        let type = new_state[typeIndex].includes(\"brightness\") ? \"brightness\" : \"color_temp\";\n        let step = new_state[typeIndex].includes(\"_up\") ? new_state[stepIndex] : -new_state[stepIndex];\n        step = \"reverse\" in knob && knob.reverse ? -step : step;\n\n        for (let light of lights) {\n            let min_max = [];\n            let value = 0;\n\n            if (type == \"brightness\" && typeof light.attributes.brightness == \"number\") {\n                min_max = [0, 255];\n                value = light.attributes.brightness;\n                value = (value + step < min_max[0] ? min_max[0] : (value + step >= min_max[1] ? min_max[1] : value + step));\n                msgs.push({ light: light, service: \"turn_on\", payload: { data: { \"entity_id\": light.entity_id, [type]: value } } });\n            } else if (type == \"color_temp\" && typeof light.attributes.color_temp == \"number\") {\n                min_max = [light.attributes.min_mireds, light.attributes.max_mireds];\n                value = light.attributes.color_temp;\n                value = (value + step < min_max[0] ? min_max[0] : (value + step >= min_max[1] ? min_max[1] : value + step));\n                msgs.push({ light: light, service: \"turn_on\", payload: { data: { \"entity_id\": light.entity_id, [type]: value } } });\n            }\n        }\n        return [msgs];\n    }\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":1400,"wires":[["2d46cd74bd85a18b"]]},{"id":"0ed249de6653762a","type":"switch","z":"b0a488ea822145cf","name":"filter","property":"new_state","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":270,"y":1400,"wires":[["e158baf2faa84e9d"]]},{"id":"e158baf2faa84e9d","type":"join","z":"b0a488ea822145cf","name":"join","mode":"custom","build":"array","property":"new_state","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"0.1","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":390,"y":1400,"wires":[["02dc4707c52aba01"]]},{"id":"1218e3ec64eb94c5","type":"server-events","z":"b0a488ea822145cf","name":"","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"emulate","eventData":"","waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"x":120,"y":240,"wires":[["1b4ce3b5d6a85c4a"]]},{"id":"ca23d8dc73b439db","type":"function","z":"b0a488ea822145cf","name":"merge home configuration","func":"msg = {\n    ...msg.entities[0],\n    ...msg.event\n};\n\ndelete msg.state;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":240,"wires":[["0cf11232ebd2a229"]]},{"id":"0cf11232ebd2a229","type":"link out","z":"b0a488ea822145cf","name":"link out 581","mode":"link","links":["7ee1ad2e97694b04","550775e4dede6915","3bfee2fb76d9aa7c","93a4cd9dcd47133c","ee03bb71d931132b","172727433576b0a4","848b54066f08d3c9","335f89b173aca00d","19cd9a8c1409d3ce","48cb735ff4e524b7","2b26dd0bb627eadf","9887e88aa919963c","55d7bf3721ad771b","af404009f4055a73","162a7c1d9e51be9d","235e6643ff9fc367"],"x":1325,"y":240,"wires":[]},{"id":"68d0f3dde93b0c04","type":"function","z":"b0a488ea822145cf","name":"get linked home configuration","func":"let new_state_exist = msg.event?.new_state?.state !== undefined;\nlet old_state_exist = msg.event?.old_state?.state !== undefined;\nlet home_configuration = global.get(\"home_configuration\") ?? {};\n\nif (home_configuration[msg.event.entity_id] !== undefined && new_state_exist && old_state_exist) {\n    msg.search = { \"is\": { entity_id: msg.event.entity_id } };\n    msg.output_name = \"entities\";\n    msg.outputEmptyResults = false;\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":180,"wires":[["6366e1743deffe6c"]]},{"id":"6366e1743deffe6c","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":555,"y":180,"wires":[["f4f272db588afc8c"]],"l":false},{"id":"1b4ce3b5d6a85c4a","type":"function","z":"b0a488ea822145cf","name":"get linked home configuration","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\n\nif (home_configuration[msg.event.entity_id] !== undefined) {\n    msg.search = { \"is\": { entity_id: msg.event.entity_id } };\n    msg.output_name = \"entities\";\n    msg.outputEmptyResults = false;\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":240,"wires":[["e69933ba68f3f0f0"]]},{"id":"e69933ba68f3f0f0","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":495,"y":240,"wires":[["ca23d8dc73b439db"]],"l":false},{"id":"1599e4c62adba050","type":"comment","z":"b0a488ea822145cf","name":"linkedClass ext_temperature / int_temperature","info":"","x":210,"y":320,"wires":[]},{"id":"d53fe9b29d5f509b","type":"comment","z":"b0a488ea822145cf","name":"linkedClass ext_humidity / int_humidity","info":"","x":190,"y":440,"wires":[]},{"id":"621b77d8aa86c81e","type":"comment","z":"b0a488ea822145cf","name":"inputs","info":"","x":90,"y":120,"wires":[]},{"id":"5ec93dbddb2e7056","type":"comment","z":"b0a488ea822145cf","name":"linkedClass cover","info":"","x":120,"y":560,"wires":[]},{"id":"7985ae54827f461d","type":"comment","z":"b0a488ea822145cf","name":"linkedClass window","info":"","x":130,"y":680,"wires":[]},{"id":"b50a16da905ce77f","type":"comment","z":"b0a488ea822145cf","name":"linkedClass motion","info":"","x":130,"y":800,"wires":[]},{"id":"8dc6b4683c3b9923","type":"comment","z":"b0a488ea822145cf","name":"linkedClass light","info":"","x":120,"y":1040,"wires":[]},{"id":"bdeca604e5bd6405","type":"comment","z":"b0a488ea822145cf","name":"linkedClass xiaomi cube","info":"","x":140,"y":1160,"wires":[]},{"id":"18d5d22f76506ee5","type":"comment","z":"b0a488ea822145cf","name":"linkedClass ambiance_select","info":"","x":160,"y":1460,"wires":[]},{"id":"4ebeab2264125d40","type":"comment","z":"b0a488ea822145cf","name":"linkedClass knob","info":"","x":120,"y":1340,"wires":[]},{"id":"ed2f4e57d3244cbf","type":"comment","z":"b0a488ea822145cf","name":"linkedClass person","info":"","x":130,"y":1580,"wires":[]},{"id":"7932b23dc9612a70","type":"comment","z":"b0a488ea822145cf","name":"linkedClass phone_alarm","info":"","x":150,"y":1700,"wires":[]},{"id":"a28c7112991d6260","type":"comment","z":"b0a488ea822145cf","name":"linkedClass phone_bluetooth","info":"","x":160,"y":1880,"wires":[]},{"id":"7863c0c46cc71eac","type":"link in","z":"b0a488ea822145cf","name":"","links":["f9f8f8a690320c67"],"x":55,"y":1820,"wires":[["ddb05597bb261331"]]},{"id":"750b60fe3f0abf20","type":"comment","z":"b0a488ea822145cf","name":"linkedClass illuminance","info":"","x":140,"y":2000,"wires":[]},{"id":"260c7f73d002d3a7","type":"comment","z":"b0a488ea822145cf","name":"linkedClass securityIntrusion","info":"","x":160,"y":2120,"wires":[]},{"id":"fef5a36e958c1671","type":"comment","z":"b0a488ea822145cf","name":"linkedClass remote","info":"","x":130,"y":2240,"wires":[]},{"id":"098b94853134acdc","type":"function","z":"b0a488ea822145cf","name":"illuminances >","func":"msg.search = { \"is\": { linkedClass: \"illuminance\" }, \"not\": { state: [\"unknown\", \"unvailable\"] } };\nmsg.output_name = \"entities\";\nmsg.outputEmptyResults = false;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":2060,"wires":[["d4a129f8504181ad"]]},{"id":"d4a129f8504181ad","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":295,"y":2060,"wires":[["625143d7bd1c5349"]],"l":false},{"id":"566194fc20b61a47","type":"function","z":"b0a488ea822145cf","name":"set global illuminance","func":"let illuminances = global.get(\"illuminances\") ?? {};\nlet linkedArea = msg.linkedArea;\nlet send = \"\";\n\nif (illuminances[linkedArea] === undefined) {\n    illuminances[linkedArea] = {};\n    illuminances[linkedArea].dataMeanValue = [msg.state, 10];\n}\n\nlet dataMeanValue = illuminances[linkedArea].dataMeanValue;\nlet avgValue = Math.round((dataMeanValue[0] * dataMeanValue[1] + msg.state) / (dataMeanValue[1] + 1));\n\nif (linkedArea == \"exterior\") {\n    let light_when_cloudy = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_when_cloudy\"].state == \"on\";\n    let cloudy_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.cloudy_light\"].state);\n\n    if (light_when_cloudy && avgValue < cloudy_light && illuminances[linkedArea].value > cloudy_light) {\n        send = \"on\";\n    } else if (light_when_cloudy && avgValue > cloudy_light && illuminances[linkedArea].value < cloudy_light) {\n        send = \"off\";\n    }\n}\n\nilluminances[linkedArea].dataMeanValue[0] = avgValue;\nilluminances[linkedArea].value = avgValue;\nglobal.set(\"illuminances\", illuminances);\n\nmsg = {\n    entity_id: msg.linkedEntity,\n    state: avgValue\n};\n\nreturn [msg, send ? msg : null];","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":2060,"wires":[["1abcc2cc00495b3f"],["e70a19df90211863"]]},{"id":"a67c25e788b32a0b","type":"comment","z":"b0a488ea822145cf","name":"linkedClass speaker","info":"","x":130,"y":920,"wires":[]},{"id":"af404009f4055a73","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":980,"wires":[["5ef26e29ff391592"]]},{"id":"5ef26e29ff391592","type":"switch","z":"b0a488ea822145cf","name":"speaker","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"speaker","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":980,"wires":[["396f8ebcbba75aa5"]]},{"id":"396f8ebcbba75aa5","type":"function","z":"b0a488ea822145cf","name":"set","func":"let speakers = global.get(\"speakers\") ?? {};\n\nif (speakers[msg.entity_id] === undefined) {\n    speakers[msg.entity_id] = {};\n    speakers[msg.entity_id].status = \"ready\";\n    speakers[msg.entity_id].queue = [];\n}\n\nif (msg.old_state == \"playing\" && msg.new_state == \"idle\") {\n    speakers[msg.entity_id].status = \"ready\";\n    global.set(\"speakers\", speakers);\n    if (speakers[msg.entity_id].queue.length > 0) {\n        msg = speakers[msg.entity_id].queue.shift();\n        return msg;\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":980,"wires":[["df1cb1ae34192790"]]},{"id":"df1cb1ae34192790","type":"subflow:dbf17bea6affd2ec","z":"b0a488ea822145cf","name":"","x":1250,"y":980,"wires":[]},{"id":"787f22bbb5e68f17","type":"link in","z":"b0a488ea822145cf","name":"link in 547","links":["0b7500ea5c30d381"],"x":55,"y":2420,"wires":[["27c53efb62c51ceb"]]},{"id":"27c53efb62c51ceb","type":"subflow:94b2243985840d69","z":"b0a488ea822145cf","name":"","x":170,"y":2420,"wires":[["38f3f3c3f7dd6c12"]]},{"id":"38f3f3c3f7dd6c12","type":"function","z":"b0a488ea822145cf","name":"trigger","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\n\nif (\n    home_configuration.devices_control !== undefined\n    && JSON.stringify(home_configuration.devices_control).includes(msg.event.entity_id)\n    && msg.event?.old_state?.state !== undefined \n    && msg.event?.new_state?.state !== undefined \n    && msg.event.old_state.state != msg.event.new_state.state\n    ) {\n    msg.trigger = msg.event.entity_id;\n    delete msg.event;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":2420,"wires":[["5dcebeddf5b32d66"]]},{"id":"a09d12c110a553ed","type":"comment","z":"b0a488ea822145cf","name":"linkedClass devices control","info":"","x":150,"y":2360,"wires":[]},{"id":"5dcebeddf5b32d66","type":"link out","z":"b0a488ea822145cf","name":"devices_control","mode":"link","links":["5e7b56ef5370dbf1"],"x":1325,"y":2420,"wires":[]},{"id":"162a7c1d9e51be9d","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":860,"wires":[["dc5f540c40b46476"]]},{"id":"dc5f540c40b46476","type":"function","z":"b0a488ea822145cf","name":"set","func":"if (msg.linkedClass === \"motion\") {\n    let acceptedStates = [\"on\", \"off\"];\n    if (acceptedStates.includes(msg.old_state) && acceptedStates.includes(msg.new_state) && msg.old_state != msg.new_state) {\n        let state = msg.invertedMotion ? { \"on\": \"off\", \"off\": \"on\" }[msg.new_state] : msg.new_state;\n        msg = {\n            state: state,\n            delay: state === \"off\" ? msg.addNoMotionDelay * 1000 : 0,\n            invertedMotion: msg.invertedMotion,\n            linkedArea: msg.linkedArea,\n            lastMotion: msg.lastMotion,\n            entity_id: msg.entity_id\n        };\n        return msg;\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":860,"wires":[["3bc3104f3995aef4"]]},{"id":"3bc3104f3995aef4","type":"delay","z":"b0a488ea822145cf","name":"delay","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":235,"y":860,"wires":[["1752674f85b640c6"]],"l":false},{"id":"1752674f85b640c6","type":"function","z":"b0a488ea822145cf","name":"set motions","func":"let motion_areas = global.get(\"motion_areas\") ?? {};\nlet motions = global.get(\"motions\") ?? {};\nlet msgs = [];\n\nif (msg.state === \"on\") {\n    set_motion();\n    motion_areas[msg.linkedArea] = \"on\";\n    msgs.push({ linkedArea: msg.linkedArea, state: msg.state });\n    let last_motion_area = Object.keys(motion_areas).filter(m => motion_areas[m] === \"last\");\n    if (last_motion_area.length === 1 && last_motion_area[0] !== msg.linkedArea) {\n        motion_areas[last_motion_area[0]] = \"off\";\n        msgs.push({ linkedArea: last_motion_area[0], state: \"off\" });\n    }\n    global.set(\"motion_areas\", motion_areas);\n    return [msgs];\n} else {\n    set_motion();\n    let state = global.get(\"homeassistant\").homeAssistant.states[msg.entity_id].state;\n    state = msg.invertedMotion ? { \"on\": \"off\", \"off\": \"on\" }[state] : state;\n    if (state === \"off\") {\n        let area_state = Object.keys(motions).filter(m => motions[m].linkedArea === msg.linkedArea)\n            .map(m => motions[m].state).reduce((a, b) => a || b === \"on\", false);\n        if (!area_state) {\n            let last_area_on = Object.keys(motion_areas).filter(m => motion_areas[m] === \"on\");\n            if (msg.lastMotion && last_area_on.length === 1 && last_area_on[0] === msg.linkedArea) {\n                motion_areas[msg.linkedArea] = \"last\";\n                msgs.push({ linkedArea: msg.linkedArea, state: \"last\" });\n            } else {\n                motion_areas[msg.linkedArea] = \"off\";\n                msgs.push({ linkedArea: msg.linkedArea, state: \"off\" });\n            }\n            global.set(\"motion_areas\", motion_areas);\n            return [msgs];\n        }\n    }\n}\n\nfunction set_motion() {\n    motions[msg.entity_id] = { linkedArea: msg.linkedArea, state: msg.state };\n    global.set(\"motions\", motions);\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":860,"wires":[["92343d20b8540180","0eed48e118a49119"]]},{"id":"92343d20b8540180","type":"link out","z":"b0a488ea822145cf","name":"detect motion","mode":"link","links":["13a390949bac6841","aa5fac95f2793daf","f4d57076103097ca"],"x":1325,"y":860,"wires":[]},{"id":"6b4ddd3bd81ee546","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":590,"y":860,"wires":[]},{"id":"0eed48e118a49119","type":"function","z":"b0a488ea822145cf","name":"function 1","func":"msg = { entity_id: \"input_text.motions\", state: msg.linkedArea + \"_\" + msg.state };\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":455,"y":860,"wires":[["6b4ddd3bd81ee546"]],"l":false},{"id":"2d46cd74bd85a18b","type":"api-call-service","z":"b0a488ea822145cf","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1270,"y":1400,"wires":[[]]},{"id":"aef1a6b2007498d6","type":"comment","z":"b0a488ea822145cf","name":"calendar","info":"","x":100,"y":2480,"wires":[]},{"id":"235e6643ff9fc367","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":2540,"wires":[["b5f3ccef4ad662c9"]]},{"id":"b5f3ccef4ad662c9","type":"switch","z":"b0a488ea822145cf","name":"calendar","property":"linkedClass","propertyType":"msg","rules":[{"t":"eq","v":"calendar","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":2540,"wires":[["9cf514dd34319d19"]]},{"id":"9cf514dd34319d19","type":"function","z":"b0a488ea822145cf","name":"send to","func":"if (msg.state == \"on\") {\n    let date = msg.attributes.start_time.split(\" \")[1].substring(0, 5);\n    msg.message = \"ðŸ“… Ã‰vÃ©nement > \" + msg.attributes.message + \" (\" + date + \")\";\n    msg.sendTo = msg.sendTo ?? [];\n    msg.sendMobile = true;\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":2540,"wires":[["b90ed62f72230b1c"]]},{"id":"b90ed62f72230b1c","type":"subflow:ba09e97f2ed22f2b","z":"b0a488ea822145cf","name":"","x":1270,"y":2540,"wires":[]},{"id":"7d355bae08e9bcc8","type":"catch","z":"b0b353ce861d908b","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["041f4aa52ca65740"]]},{"id":"837f5e57291454a2","type":"link in","z":"b0b353ce861d908b","name":"set nearest","links":["550ba74f65825b54"],"x":55,"y":180,"wires":[["922083f63b657fbb"]]},{"id":"fcec0f9c2adc1980","type":"subflow:ad3b29a5dd67898f","z":"b0b353ce861d908b","name":"","x":460,"y":40,"wires":[]},{"id":"041f4aa52ca65740","type":"change","z":"b0b353ce861d908b","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Presence","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["fcec0f9c2adc1980"]]},{"id":"afda0ab80075878c","type":"function","z":"b0b353ce861d908b","name":"set zones","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\n\nif (home_configuration[\"zone.home\"] !== undefined) {\n    let zone_home = home_configuration[\"zone.home\"];\n    let msgs = [];\n    for (let key of Object.keys(zone_home)) {\n        msgs.push({ service: \"turn_on\", entity_id: key });\n    }\n    return [msgs];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":180,"wires":[["c0a033baef2e6d6d"]]},{"id":"da541aea7280faf7","type":"link in","z":"b0b353ce861d908b","name":"link in 370","links":["ce952f95d7407e06"],"x":415,"y":180,"wires":[["afda0ab80075878c"]]},{"id":"3dff4d53cd1e7309","type":"comment","z":"b0b353ce861d908b","name":"Zones detect","info":"","x":110,"y":960,"wires":[]},{"id":"992e0b9bf2f9a7b5","type":"function","z":"b0b353ce861d908b","name":"notification","func":"if (msg.payload > 0 && (msg.zone[0].googleKeepList ?? false)) {\n    msg.title = \"Voici votre liste de courses\";\n    msg.data = { clickAction: msg.zone[0].googleKeepList };\n    msg.sendMobile = true;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":1020,"wires":[["9cbf7198f4d10a5b"]]},{"id":"9cbf7198f4d10a5b","type":"subflow:ba09e97f2ed22f2b","z":"b0b353ce861d908b","name":"","x":690,"y":1020,"wires":[]},{"id":"65a5d5e9d9d9d752","type":"comment","z":"b0b353ce861d908b","name":"Security Intrusion","info":"","x":120,"y":700,"wires":[]},{"id":"e5f67442c9d87639","type":"delay","z":"b0b353ce861d908b","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":320,"y":760,"wires":[["7e4840b6876573aa"]]},{"id":"7e4840b6876573aa","type":"function","z":"b0b353ce861d908b","name":"notification","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\n\nif (!in_home_zone) {\n    msg.alertType = \"error\";\n    msg.title = \"Mode surveillance ðŸ’¢\";\n    if (msg.linkedClass === \"window\") {\n        msg.message = \"Mouvement dÃ©tÃ©ctÃ© > DÃ©tection fenÃªtre \" + msg.alias + \" ðŸ’¢\";\n    } else if (msg.linkedClass === \"motion\") {\n        msg.message = \"Mouvement dÃ©tÃ©ctÃ© > DÃ©tection \" + msg.alias + \" ðŸ’¢\";\n    }\n    msg.notification_id = \"security_intrusion_\" + msg.entity_id.split(\".\")[1];\n    msg.data = { tag: msg.notification_id };\n    msg.sendMobile = true;\n\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":760,"wires":[["ad446eefb7df13b9"]]},{"id":"85e70ba4e021ee27","type":"function","z":"b0b353ce861d908b","name":"notification","func":"if (msg.payload == \"off\") {\n    msg.notification_id = \"security_guard\";\n    msg.alertType = \"success\";\n    msg.title = \"Mode surveillance activÃ©\";\n    msg.message = \"La maison est en mode surveillance ðŸ›¡ï¸\";\n    msg.sendMobile = false;\n    msg.data = {};\n} else {\n    msg.notification_id = \"security_guard\";\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":820,"wires":[["db2a87c1d25e790a"]]},{"id":"ad446eefb7df13b9","type":"link out","z":"b0b353ce861d908b","name":"link out 203","mode":"link","links":["e53334a6f05a9609"],"x":575,"y":760,"wires":[]},{"id":"db2a87c1d25e790a","type":"link out","z":"b0b353ce861d908b","name":"link out 205","mode":"link","links":["e53334a6f05a9609"],"x":695,"y":820,"wires":[]},{"id":"50bcb623608b5268","type":"subflow:e6ac576fb4598283","z":"b0b353ce861d908b","name":"","x":250,"y":820,"wires":[[],["0ad2fc52e05f884f"]]},{"id":"514ddcb3e84c5765","type":"link in","z":"b0b353ce861d908b","name":"security","links":["61c0d8738882ce35"],"x":55,"y":760,"wires":[["b173e67b4c8d152f"]]},{"id":"5fd3a1a12dce60d2","type":"comment","z":"b0b353ce861d908b","name":"Presence","info":"","x":100,"y":120,"wires":[]},{"id":"466d5fb08ce003ad","type":"comment","z":"b0b353ce861d908b","name":"Invitation","info":"","x":100,"y":260,"wires":[]},{"id":"8e288e86f9bafd46","type":"function","z":"b0b353ce861d908b","name":"get zones","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\n\nif(home_configuration[\"zone.home\"] !== undefined){\n    let zone_home = home_configuration[\"zone.home\"];\n    let persons = global.get(\"persons\") ?? {};\n    let msgs = [];\n\n    let distance = Object.keys(persons).map( p => persons[p].home_distance);\n    if (distance.length != 0) {\n        distance.sort(function (a, b) { return a - b });\n        for (let key of Object.keys(zone_home)) {\n            if (distance[0] <= zone_home[key]) {\n                msgs.push({ service: \"turn_on\", entity_id: key });\n            } else {\n                msgs.push({ service: \"turn_off\", entity_id: key });\n            }\n        }\n        return [msgs];\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":180,"wires":[["c0a033baef2e6d6d"]]},{"id":"c0a033baef2e6d6d","type":"api-call-service","z":"b0b353ce861d908b","name":"set zones","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":660,"y":180,"wires":[[]]},{"id":"3acb1879e67b356b","type":"api-call-service","z":"b0b353ce861d908b","name":"home_invitation off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.invitation"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":430,"y":620,"wires":[[]]},{"id":"922083f63b657fbb","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":180,"wires":[[],["8e288e86f9bafd46"]]},{"id":"b173e67b4c8d152f","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":760,"wires":[[],["e5f67442c9d87639"]]},{"id":"0a2bed08ec229abc","type":"server-state-changed","z":"b0b353ce861d908b","name":"zone.home","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"zone.home","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"0","ifStateType":"num","ifStateOperator":"gt","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[],"x":100,"y":620,"wires":[["7489e531b19a01ad"],[]]},{"id":"9747baf2bc79243c","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.invitation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":820,"wires":[[],["50bcb623608b5268"]]},{"id":"2479895c05c38144","type":"server-state-changed","z":"b0b353ce861d908b","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":420,"y":820,"wires":[["85e70ba4e021ee27"]]},{"id":"a3db5013eb53fb66","type":"server-state-changed","z":"b0b353ce861d908b","name":"detect zones","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"^zone.","entityIdType":"regex","outputInitially":true,"stateType":"num","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":110,"y":1020,"wires":[["ef679f91ec2db01c"]]},{"id":"6345d65a7a4d447c","type":"subflow:3da7ebfd83a38899","z":"b0b353ce861d908b","name":"","x":335,"y":1020,"wires":[["de52da87de22ae5c"]],"l":false},{"id":"ef679f91ec2db01c","type":"function","z":"b0b353ce861d908b","name":"zone > ","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\n\nif (home_configuration[msg.data.entity_id] !== undefined) {\n    msg.topic = msg.data.entity_id;\n    msg.search = { \"is\": { entity_id: msg.data.entity_id } };\n    msg.output_name = \"zone\";\n    msg.outputEmptyResults = false;\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":1020,"wires":[["6345d65a7a4d447c"]]},{"id":"de52da87de22ae5c","type":"delay","z":"b0b353ce861d908b","name":"","pauseType":"queue","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"30","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":395,"y":1020,"wires":[["992e0b9bf2f9a7b5"]],"l":false},{"id":"22370702a1d3d968","type":"server-state-changed","z":"b0b353ce861d908b","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":880,"wires":[["b38222c2e7e9b656"],[]]},{"id":"b38222c2e7e9b656","type":"function","z":"b0b353ce861d908b","name":"notification","func":"let security_intrusions = Object.keys(global.get(\"notifications\") ?? {}).filter(s => s.includes(\"security_intrusion_\"));\nlet app_notif = [];\nlet ha_notif = [];\n\nfor (let s of security_intrusions) {\n    ha_notif.push({\n        notification_id: s,\n        dismiss: true\n    });\n\n    app_notif.push({\n        message: \"clear_notification\",\n        data: { tag: s },\n        sendMobile: true\n    });\n}\n\nreturn [ha_notif, app_notif];","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":880,"wires":[["c16037c98c55d61e"],["4c20a88f1a58c0a4"]]},{"id":"c16037c98c55d61e","type":"link out","z":"b0b353ce861d908b","name":"link out 610","mode":"link","links":["e53334a6f05a9609"],"x":395,"y":880,"wires":[]},{"id":"97c66cf174fed278","type":"subflow:ba09e97f2ed22f2b","z":"b0b353ce861d908b","name":"","x":530,"y":880,"wires":[]},{"id":"d49f950ca93844de","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.invitation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"invitation","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":320,"wires":[["7388f7ee6aa30430"]]},{"id":"7388f7ee6aa30430","type":"function","z":"b0b353ce861d908b","name":"notification","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\";\nlet invitation = msg.invitation === \"on\";\n\nmsg.notification_id = \"invitation\";\nif (invitation) {\n    msg.data = { tag: msg.notification_id };\n    msg.title = \"Mode invitÃ©\";\n    msg.alertType = \"success\";\n    msg.sendMobile = true;\n    if (in_home_zone) {\n        msg.message = \"Mode invitÃ© activÃ©\";\n    } else {\n        msg.message = \"En attente de l'invitÃ©\";\n    }\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":320,"wires":[["a0ac3a9fefa0251d"]]},{"id":"a0ac3a9fefa0251d","type":"link out","z":"b0b353ce861d908b","name":"link out 612","mode":"link","links":["e53334a6f05a9609"],"x":355,"y":320,"wires":[]},{"id":"0e4549bc46893207","type":"link in","z":"b0b353ce861d908b","name":"security","links":["61c0d8738882ce35"],"x":55,"y":380,"wires":[["37d33b58d06361df"]]},{"id":"37d33b58d06361df","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":380,"wires":[["8271b43a2d6028b4"],[]]},{"id":"c3e71b07ae0c0386","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.data = { tag: msg.notification_id };\nmsg.title = \"Mode invitÃ©\";\nmsg.alertType = \"success\";\nmsg.message = \"L'invitÃ© est entrÃ©\";\nmsg.sendMobile = true;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":380,"wires":[["ce952f95d7407e06"]]},{"id":"ce952f95d7407e06","type":"link out","z":"b0b353ce861d908b","name":"link out 614","mode":"link","links":["e53334a6f05a9609","da541aea7280faf7"],"x":795,"y":380,"wires":[]},{"id":"9555284c1bcf376e","type":"switch","z":"b0b353ce861d908b","name":"invitation_off","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"invitation_off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":270,"y":560,"wires":[["1b446d1ec86b4d80"]]},{"id":"767e3a7194faa0f4","type":"link out","z":"b0b353ce861d908b","name":"link out 615","mode":"link","links":["e53334a6f05a9609"],"x":735,"y":560,"wires":[]},{"id":"5b9956dc44836bf1","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.dismiss = true;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":560,"wires":[["767e3a7194faa0f4"]]},{"id":"1b446d1ec86b4d80","type":"api-call-service","z":"b0b353ce861d908b","name":"home_invitation off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.invitation"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":450,"y":560,"wires":[["5b9956dc44836bf1"]]},{"id":"e4b0881802f48fff","type":"server-events","z":"b0b353ce861d908b","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":560,"wires":[["9555284c1bcf376e"]]},{"id":"667c5ae4e1bcd5dc","type":"link in","z":"b0b353ce861d908b","name":"security","links":["61c0d8738882ce35"],"x":55,"y":440,"wires":[["beac9e4b4e2e3e77"]]},{"id":"beac9e4b4e2e3e77","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":440,"wires":[["e6a75b627c5ac3eb"],[]]},{"id":"615b1661227a0fe0","type":"subflow:e6ac576fb4598283","z":"b0b353ce861d908b","name":"","x":530,"y":380,"wires":[[],["c3e71b07ae0c0386"]]},{"id":"515d7b2c62392bee","type":"subflow:e6ac576fb4598283","z":"b0b353ce861d908b","name":"","x":470,"y":440,"wires":[[],["6fcc90afe37c1372"]]},{"id":"5a9e9841a07b2e62","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.data = { tag: msg.notification_id };\nmsg.title = \"Mode invitÃ©\";\nmsg.alertType = \"success\";\nmsg.message = \"L'invitÃ© est parti\";\nmsg.data = { actions: [{ \"action\": \"invitation_off\", \"title\": \"DÃ©sactiver mode invitÃ©\" }] };\nmsg.sendMobile = true;\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":500,"wires":[["0ca7c3aa0cc7fd65"]]},{"id":"0ca7c3aa0cc7fd65","type":"link out","z":"b0b353ce861d908b","name":"link out 616","mode":"link","links":["e53334a6f05a9609"],"x":415,"y":500,"wires":[]},{"id":"8f230902d31509a3","type":"link out","z":"b0b353ce861d908b","name":"link out 617","mode":"link","links":["4296f37988bc48d3"],"x":975,"y":440,"wires":[]},{"id":"4296f37988bc48d3","type":"link in","z":"b0b353ce861d908b","name":"link in 555","links":["8f230902d31509a3"],"x":55,"y":500,"wires":[["593cbad2c1f2ea10"]]},{"id":"593cbad2c1f2ea10","type":"function","z":"b0b353ce861d908b","name":"no motion","func":"let motion = global.get(\"homeassistant\").homeAssistant.states[\"input_text.motions\"].state;\nlet linkedArea = msg.linkedArea;\n\nif (linkedArea + \"_off\" === motion || linkedArea + \"_last\" === motion) {\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":500,"wires":[["5a9e9841a07b2e62"]]},{"id":"8271b43a2d6028b4","type":"switch","z":"b0b353ce861d908b","name":"new state","property":"new_state","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":320,"y":380,"wires":[["615b1661227a0fe0","bfe5ebe87a33ff1b"]]},{"id":"e6a75b627c5ac3eb","type":"switch","z":"b0b353ce861d908b","name":"new state","property":"new_state","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":320,"y":440,"wires":[["515d7b2c62392bee"]]},{"id":"7489e531b19a01ad","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":620,"wires":[["3acb1879e67b356b"],[]]},{"id":"8eda5f8be1dcd3c4","type":"ha-wait-until","z":"b0b353ce861d908b","name":"unchanged for 10 min","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"10","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":840,"y":440,"wires":[[],["8f230902d31509a3"]]},{"id":"d6115cc7ce410924","type":"change","z":"b0b353ce861d908b","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":670,"y":440,"wires":[["8eda5f8be1dcd3c4"]]},{"id":"bfe5ebe87a33ff1b","type":"link out","z":"b0b353ce861d908b","name":"link out 618","mode":"link","links":["5906faeba06a5d11"],"x":415,"y":380,"wires":[]},{"id":"5906faeba06a5d11","type":"link in","z":"b0b353ce861d908b","name":"link in 556","links":["bfe5ebe87a33ff1b"],"x":575,"y":440,"wires":[["d6115cc7ce410924"]]},{"id":"13a390949bac6841","type":"link in","z":"ccf1abe540a3b5a9","name":"light on/off/last","links":["a0ec305d313aa8f9","b8e8a6779e6eae20","a54be99d7e32ea7c","4eacb8b3183c1c16","92343d20b8540180"],"x":55,"y":180,"wires":[["40a3a62c1d267568"]]},{"id":"0fcb5d94030ab313","type":"catch","z":"ccf1abe540a3b5a9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["d52e65e568a3244a"]]},{"id":"308dcdc841f55ee0","type":"subflow:ad3b29a5dd67898f","z":"ccf1abe540a3b5a9","name":"","x":460,"y":40,"wires":[]},{"id":"d52e65e568a3244a","type":"change","z":"ccf1abe540a3b5a9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Lights","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["308dcdc841f55ee0"]]},{"id":"57970c88e211ce04","type":"link in","z":"ccf1abe540a3b5a9","name":"ambiance","links":["9560131ccbbc20d7"],"x":55,"y":1020,"wires":[["fd4956c89d222e5a"]]},{"id":"b8e8a6779e6eae20","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 372","mode":"link","links":["13a390949bac6841"],"x":835,"y":1020,"wires":[]},{"id":"ddf840aed2822269","type":"subflow:612068fa04cc8bbd","z":"ccf1abe540a3b5a9","name":"","x":750,"y":1020,"wires":[["b8e8a6779e6eae20"]]},{"id":"17df8120f9c53aca","type":"link in","z":"ccf1abe540a3b5a9","name":"cube","links":["1988e93c3898f2f1"],"x":495,"y":1020,"wires":[["a7bc7a0c91bb60df"]]},{"id":"3d427e9849b65be2","type":"function","z":"ccf1abe540a3b5a9","name":"restore lights from motions","func":"let motion_areas = global.get(\"motion_areas\") ?? {};\nlet areas = [... new Set(msg.lights.map(a => a.linkedArea).filter(a => motion_areas[a] !== undefined))];\nreturn [areas.map(a => ({ linkedArea: a, state: motion_areas[a] }))];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":780,"y":740,"wires":[["a0ec305d313aa8f9"]]},{"id":"a0ec305d313aa8f9","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 373","mode":"link","links":["13a390949bac6841"],"x":935,"y":740,"wires":[]},{"id":"830aa417e845e28d","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":370,"y":740,"wires":[["e6fdc8b9ecf9094b"],[]]},{"id":"42bcf58ce90dbbb4","type":"link in","z":"ccf1abe540a3b5a9","name":"light restore","links":["946e692a37fbda1a","09937216bea66806","b624e6e0f61ddfc0","1df54c7b282de651","8f97d023011710df"],"x":55,"y":740,"wires":[["587a2f970b774dec"]]},{"id":"96fcc71316f08920","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 374","mode":"link","links":["437b422bf3232407"],"x":745,"y":380,"wires":[]},{"id":"3def32a14603ce09","type":"subflow:7166242293a03ec9","z":"ccf1abe540a3b5a9","name":"","x":330,"y":1020,"wires":[["4eacb8b3183c1c16"]]},{"id":"e904c7abdbd0b8c2","type":"function","z":"ccf1abe540a3b5a9","name":"notification","func":"msg.notification_id = \"module_light\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module LumiÃ¨res dÃ©sactivÃ©\";\n    msg.message = \"Module LumiÃ¨res dÃ©sactivÃ©, les lumiÃ¨res sont allumÃ©es\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":680,"wires":[["4c7682a3d69b57a1"]]},{"id":"4c7682a3d69b57a1","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 411","mode":"link","links":["e53334a6f05a9609"],"x":875,"y":680,"wires":[]},{"id":"946e692a37fbda1a","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 413","mode":"link","links":["42bcf58ce90dbbb4"],"x":1095,"y":680,"wires":[]},{"id":"39c5c048d2a868a7","type":"function","z":"ccf1abe540a3b5a9","name":"lights on","func":"let lights = msg.lights.filter(l => l.entity_id.includes(\"light.\"));\nreturn [lights.map(l => ({ payload: { data: { entity_id: l.entity_id, brightness_pct: 100, color_temp: 300 } } }))];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":680,"wires":[["5687a334154dd78b"]]},{"id":"81bc2142a3005244","type":"function","z":"ccf1abe540a3b5a9","name":"area lights >","func":"msg.search = { \"is\": { linkedClass: \"light\", linkedArea: msg.linkedArea, state: [\"on\",\"off\"] } };\nmsg.output_name = \"lights\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":180,"wires":[["65d668d29a2fb0bf"]]},{"id":"6fa27568c479e069","type":"function","z":"ccf1abe540a3b5a9","name":"area covers >","func":"msg.search = { \"is\": { linkedClass: \"cover\", linkedArea: msg.linkedArea, state: 0 } };\nmsg.output_name = \"covers\";\nmsg.outputEmptyResults = true;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":180,"wires":[["f08d550a9e4bf036"]]},{"id":"e6fdc8b9ecf9094b","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"msg.search = { \"is\": { linkedClass: \"light\", state: [\"on\", \"off\"] } };\nmsg.output_name = \"lights\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":740,"wires":[["7a8c249645ba0cef"]]},{"id":"793fa08398a6eb1b","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"msg.search = { \"is\": { linkedClass: \"light\", state: [\"on\", \"off\"] } };\nmsg.output_name = \"lights\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":680,"wires":[["25f588146ef6cf2b"]]},{"id":"fd4956c89d222e5a","type":"subflow:94b2243985840d69","z":"ccf1abe540a3b5a9","name":"","x":170,"y":1020,"wires":[["3def32a14603ce09"]]},{"id":"a7bc7a0c91bb60df","type":"subflow:94b2243985840d69","z":"ccf1abe540a3b5a9","name":"","x":610,"y":1020,"wires":[["ddf840aed2822269"]]},{"id":"5687a334154dd78b","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":610,"y":680,"wires":[[]]},{"id":"a40553b9e1b431c2","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":350,"y":180,"wires":[["81bc2142a3005244"],[]]},{"id":"587a2f970b774dec","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":190,"y":740,"wires":[["830aa417e845e28d"],[]]},{"id":"ad9a09b8e7b92562","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":470,"y":880,"wires":[["15d73482cc33f748"],[]]},{"id":"751c99b6607ee7b1","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":880,"wires":[[],["0d420d11e004d498"]]},{"id":"1e13104782559c9c","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"lights triggers","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_boolean.light_when_cloudy","input_number.cloudy_light","input_boolean.color_reverse","input_number.color_segment","input_number.color_rotate"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":620,"wires":[["ab854ba17157eeda"]]},{"id":"c984c4aec56dc82b","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"module_lights","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_lights","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":680,"wires":[["e35423a2a82f9168","36b84b9dab98a0da"],["e35423a2a82f9168","793fa08398a6eb1b"]]},{"id":"2e22c3522e999a5b","type":"ha-time","z":"ccf1abe540a3b5a9","name":"sun_light_time_midnight","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.sun_light_time_midnight","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":310,"y":620,"wires":[["ab854ba17157eeda"]]},{"id":"65d668d29a2fb0bf","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":635,"y":180,"wires":[["6fa27568c479e069"]],"l":false},{"id":"f08d550a9e4bf036","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":915,"y":180,"wires":[["19e2561c9f80ace9"]],"l":false},{"id":"7a8c249645ba0cef","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":615,"y":740,"wires":[["3d427e9849b65be2"]],"l":false},{"id":"25f588146ef6cf2b","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":355,"y":680,"wires":[["39c5c048d2a868a7"]],"l":false},{"id":"4eacb8b3183c1c16","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 565","mode":"link","links":["13a390949bac6841"],"x":435,"y":1020,"wires":[]},{"id":"5c1578eb5358a261","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":90,"y":560,"wires":[["a7cf4e223ec602b3"]]},{"id":"a1c3d80b2bb65e82","type":"subflow:723d4991c3c87385","z":"ccf1abe540a3b5a9","name":"","x":390,"y":560,"wires":[]},{"id":"a7cf4e223ec602b3","type":"function","z":"ccf1abe540a3b5a9","name":"sun calc","func":"let sun_light_angle_setting_rising = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_setting_rising\"].state);\nlet sun_light_angle_dusk_dawn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_dusk_dawn\"].state);\n\nlet old_elevation = msg.data.old_state.attributes.elevation;\nlet new_elevation = msg.data.new_state.attributes.elevation;\nlet rising = msg.data.new_state.attributes.rising;\nlet msgs = [];\n\nlet d = new Date();\nlet local_time = d.getHours() + \":\" + d.getMinutes();\n\nif (rising) {\n    if (old_elevation < sun_light_angle_setting_rising && sun_light_angle_setting_rising < new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_rising\", state: local_time }, msg];\n    } else if (old_elevation < sun_light_angle_dusk_dawn && sun_light_angle_dusk_dawn < new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_dawn_angle\", state: local_time }, null];\n    }\n} else {\n    if (old_elevation > sun_light_angle_setting_rising && sun_light_angle_setting_rising > new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_setting\", state: local_time }, msg];\n    } else if (old_elevation > sun_light_angle_dusk_dawn && sun_light_angle_dusk_dawn > new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_dusk\", state: local_time }, null];\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":560,"wires":[["a1c3d80b2bb65e82"],["a457c8d35dfc8615"]]},{"id":"fb08910e6e53b945","type":"ha-time","z":"ccf1abe540a3b5a9","name":"sun_light_time_dawn","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.sun_light_time_dawn","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":540,"y":620,"wires":[["ab854ba17157eeda"]]},{"id":"40a3a62c1d267568","type":"subflow:94b2243985840d69","z":"ccf1abe540a3b5a9","name":"","x":170,"y":180,"wires":[["a40553b9e1b431c2"]]},{"id":"b624e6e0f61ddfc0","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 582","mode":"link","links":["42bcf58ce90dbbb4"],"x":675,"y":560,"wires":[]},{"id":"5c0f984284cf4901","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":570,"y":560,"wires":[["b624e6e0f61ddfc0"],[]]},{"id":"ba41fb78ceeafe6f","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":990,"y":680,"wires":[["946e692a37fbda1a"],[]]},{"id":"ab854ba17157eeda","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":730,"y":620,"wires":[["1df54c7b282de651"],[]]},{"id":"1df54c7b282de651","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 583","mode":"link","links":["42bcf58ce90dbbb4"],"x":835,"y":620,"wires":[]},{"id":"437b422bf3232407","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 529","links":["96fcc71316f08920"],"x":685,"y":180,"wires":[["6fa27568c479e069"]]},{"id":"6130bcdd2fdecd93","type":"inject","z":"ccf1abe540a3b5a9","name":"2 min","props":[],"repeat":"","crontab":"*/2 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":80,"y":380,"wires":[[]]},{"id":"8c97642014596c3f","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":270,"y":380,"wires":[["028c04198da61872"],[]]},{"id":"028c04198da61872","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":450,"y":380,"wires":[["194c392731396fca"],[]]},{"id":"e23e00bff771d076","type":"comment","z":"ccf1abe540a3b5a9","name":"light core","info":"","x":100,"y":120,"wires":[]},{"id":"012447fa27d53e03","type":"comment","z":"ccf1abe540a3b5a9","name":"light triggers","info":"","x":110,"y":500,"wires":[]},{"id":"e799aa7cd0ac8a40","type":"comment","z":"ccf1abe540a3b5a9","name":"light update","info":"","x":110,"y":320,"wires":[]},{"id":"6dc2aba21231d6d8","type":"comment","z":"ccf1abe540a3b5a9","name":"manual light control","info":"","x":130,"y":960,"wires":[]},{"id":"b782b22904fcacb4","type":"function","z":"ccf1abe540a3b5a9","name":"light calc","func":"let sun_light_angle_setting_rising = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_setting_rising\"].state);\nlet sun_light_angle_dusk_dawn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_dusk_dawn\"].state);\nlet sun_light_time_setting = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_setting\"].state);\nlet sun_light_time_rising = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_rising\"].state);\nlet sun_angle_cover_on = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_on\"].state);\nlet sun_angle_cover_off = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_off\"].state);\nlet in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet sun = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes;\nlet currentTime = in_minutes(new Date().toString().slice(16, 21));\nlet locked_lights = global.get(\"locked_lights\") ?? [];\nlet min_cloudyLight = 100;\nlet commun_brightness = {};\nlet msgs = [[], [], []];\n\nif (sun.elevation < sun_light_angle_setting_rising) {\n    commun_brightness[\"night_brightnessPct\"] = night_brightnessPctCalc();\n}\n\nlet cloudy_brightnessPct = cloudy_brightnessPctCalc();\nif (cloudy_brightnessPct > 0) {\n    commun_brightness[\"cloudy_brightnessPct\"] = cloudy_brightnessPct;\n}\n\nfor (let light of msg.lights) {\n    if (!locked_lights.includes(light.entity_id)) {\n        let state = (msg.state == \"last\" ? light.lastLight ? \"on\" : \"off\" : msg.state) == \"on\";\n        let light_state = light.state == \"on\";\n        let message = {};\n        if (state || state != light_state) {\n            let light_brightness = {};\n            if (light.dayLight) {\n                light_brightness[\"daylight_brightnessPct\"] = daylight_brightnessPctCalc(light);\n            } else if (msg.covers.length != 0 && sun.elevation > sun_angle_cover_on && sun.elevation > sun_angle_cover_off) {\n                light_brightness[\"cover_brightnessPct\"] = light.brightRange[1];\n            }\n            let brightnesss = { ...commun_brightness, ...light_brightness };\n            let brightnessKeys = Object.keys(brightnesss);\n\n            if (brightnessKeys.includes(\"night_brightnessPct\")) {\n                let brightnessPctList = [brightnesss[\"night_brightnessPct\"](light)];\n                if (brightnessKeys.includes(\"daylight_brightnessPct\")) {\n                    brightnessPctList.push(brightnesss[\"daylight_brightnessPct\"]);\n                } else if (brightnessKeys.includes(\"cloudy_brightnessPct\")) {\n                    brightnessPctList.push(brightnesss[\"cloudy_brightnessPct\"]);\n                }\n                let brightnessPct = brightnessPctList.reduce((ps, a) => ps + a, 0);\n                brightnessPct = brightnessPct > light.brightRange[1] ? light.brightRange[1] : brightnessPct;\n                message = { brightnessPct: brightnessPct, currentTimeStatus: msg.currentTimeStatus, ...light };\n                msgs[state && in_home_zone ? 0 : 1].push(message);\n            } else {\n                if (brightnessKeys.includes(\"daylight_brightnessPct\")) {\n                    message = { brightnessPct: brightnesss[\"daylight_brightnessPct\"], currentTimeStatus: 0, ...light };\n                    msgs[state && in_home_zone ? 0 : 1].push(message);\n                } else if (brightnessKeys.includes(\"cover_brightnessPct\")) {\n                    message = { brightnessPct: brightnesss[\"cover_brightnessPct\"], currentTimeStatus: 0, ...light };\n                    msgs[state && in_home_zone ? 0 : 1].push(message);\n                } else if (brightnessKeys.includes(\"cloudy_brightnessPct\")) {\n                    let brightnessPct = brightnesss[\"cloudy_brightnessPct\"] * light.brightRange[1] / 100;\n                    message = { brightnessPct: brightnessPct, currentTimeStatus: 0, ...light };\n                    msgs[state && in_home_zone ? 0 : 1].push(message);\n                } else if (light.state == \"on\") {\n                    message = { currentTimeStatus: 0, ...light };\n                    msgs[1].push(message);\n                }\n            }\n        }\n    }\n}\n\nreturn msgs;\n\nfunction night_brightnessPctCalc() {\n    let sun_light_time_dusk = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dusk\"].state);\n    let sun_light_time_midnight = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_midnight\"].state);\n    let sun_light_time_dawn = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn\"].state);\n    let sun_light_time_dawn_angle = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn_angle\"].state);\n\n    // Pivot\n    sun_light_time_rising = sun_light_time_rising + 1440 - sun_light_time_setting;\n    sun_light_time_dawn_angle = sun_light_time_dawn_angle + 1440 - sun_light_time_setting;\n    sun_light_time_dawn = sun_light_time_dawn + 1440 - sun_light_time_setting;\n    sun_light_time_midnight = sun_light_time_dusk < sun_light_time_midnight ? sun_light_time_midnight - sun_light_time_setting : sun_light_time_midnight + 1440 - sun_light_time_setting;\n    sun_light_time_dusk = sun_light_time_dusk - sun_light_time_setting;\n    currentTime = sun_light_time_setting <= currentTime ? currentTime - sun_light_time_setting : 1440 - sun_light_time_setting + currentTime;\n    sun_light_time_setting = 0;\n\n    // Choix de l'heure de l'aube la plus petite \n    sun_light_time_dawn = sun_light_time_dawn < sun_light_time_dawn_angle ? sun_light_time_dawn : sun_light_time_dawn_angle;\n\n    if (sun_light_time_setting <= currentTime && currentTime < sun_light_time_dusk) {\n        msg.currentTimeStatus = pctCalc(sun_light_time_setting, sun_light_time_midnight, currentTime, false);\n        return function (light) { return brightnessPctCalc(pctCalc(sun_light_time_setting, sun_light_time_dusk, currentTime, false), light) };\n    } else if (sun_light_time_dusk <= currentTime && currentTime < sun_light_time_midnight - 60) {\n        msg.currentTimeStatus = pctCalc(sun_light_time_setting, sun_light_time_midnight, currentTime, false);\n        return function (light) { return light.brightRange[1] };\n    } else if (sun_light_time_midnight - 60 <= currentTime && currentTime < sun_light_time_midnight) {\n        msg.currentTimeStatus = pctCalc(sun_light_time_setting, sun_light_time_midnight, currentTime, false);\n        return function (light) { return brightnessPctCalc(pctCalc(sun_light_time_midnight - 60, sun_light_time_midnight, currentTime, true), light) };\n    } else if (sun_light_time_midnight <= currentTime && currentTime < sun_light_time_dawn - 60) {\n        msg.currentTimeStatus = 100;\n        return function (light) { return light.nightLight ? light.brightRange[0] : 0 };\n    } else if (sun_light_time_dawn - 60 <= currentTime && currentTime < sun_light_time_dawn) {\n        msg.currentTimeStatus = pctCalc(sun_light_time_dawn - 60, sun_light_time_rising, currentTime, true);\n        return function (light) { return brightnessPctCalc(pctCalc(sun_light_time_dawn - 60, sun_light_time_dawn, currentTime, true), light) };\n    } else if (sun_light_time_dawn <= currentTime && currentTime < (sun_light_time_dawn + sun_light_time_rising) / 2) {\n        msg.currentTimeStatus = pctCalc(sun_light_time_dawn - 60, sun_light_time_rising, currentTime, true);\n        return function (light) { return light.brightRange[1] };\n    } else if ((sun_light_time_dawn + sun_light_time_rising) / 2 <= currentTime && currentTime < sun_light_time_rising) {\n        msg.currentTimeStatus = pctCalc(sun_light_time_dawn - 60, sun_light_time_rising, currentTime, true);\n        return function (light) { return brightnessPctCalc(pctCalc((sun_light_time_dawn + sun_light_time_rising) / 2, sun_light_time_rising, currentTime, true), light) };\n    } else {\n        msg.currentTimeStatus = 0;\n        return function (light) { return light.brightRange[0] };\n    }\n}\n\nfunction cloudy_brightnessPctCalc() {\n    let light_when_cloudy = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_when_cloudy\"].state == \"on\";\n    if (light_when_cloudy) {\n        let cloudy_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.cloudy_light\"].state);\n        let illuminances = global.get(\"illuminances\") ?? {};\n        if (\"exterior\" in illuminances && \"value\" in illuminances[\"exterior\"] && illuminances[\"exterior\"][\"value\"] < cloudy_light && sun.elevation > sun_light_angle_setting_rising) {\n            return pctCalc(min_cloudyLight, cloudy_light, illuminances[\"exterior\"][\"value\"], true);\n        } else if (\"exterior\" in illuminances && \"value\" in illuminances[\"exterior\"] && illuminances[\"exterior\"][\"value\"] < cloudy_light && sun.elevation > sun_light_angle_dusk_dawn) {\n            return pctCalc(min_cloudyLight, cloudy_light, illuminances[\"exterior\"][\"value\"], true) * pctCalc(sun_light_angle_dusk_dawn, sun_light_angle_setting_rising, sun.elevation, false) / 100;\n        } else {\n            return 0;\n        }\n    }\n}\n\nfunction daylight_brightnessPctCalc(light) {\n    if (sun.elevation > sun_light_angle_setting_rising) {\n        return light.brightRange[1];\n    } else if (sun.elevation > sun_light_angle_dusk_dawn) {\n        return light.brightRange[1] * pctCalc(sun_light_angle_dusk_dawn, sun_light_angle_setting_rising, sun.elevation, false) / 100;\n    } else {\n        return 0;\n    }\n}\n\nfunction brightnessPctCalc(brightnessPct, light) {\n    brightnessPct = Math.cos((9 * brightnessPct / 10 - 90) * Math.PI / 180);\n    return light.brightRange[0] + (light.brightRange[1] - light.brightRange[0]) * brightnessPct;\n}\n\nfunction pctCalc(min, max, nb, reverse) {\n    return nb < min ? (reverse ? 100 : 0) : nb > max ? (reverse ? 0 : 100) : reverse ? (max - nb) / Math.abs(min - max) * 100 : (nb - min) / Math.abs(min - max) * 100;\n}\n\nfunction in_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\");\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1]);\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":240,"wires":[["4564f1b3da2f689c","964ca054765f4969"],["42ceba1752ad2698","964ca054765f4969"]]},{"id":"4564f1b3da2f689c","type":"function","z":"ccf1abe540a3b5a9","name":"temp color calc","func":"if (msg.color == \"on\") {\n    let color_rotate = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_rotate\"].state);\n    let color_segment = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_segment\"].state);\n    let color_reverse = global.get('homeassistant').homeAssistant.states[\"input_boolean.color_reverse\"].state == \"on\";\n    let color = (((360 * (color_segment * msg.currentTimeStatus / (360 * 100)) + color_rotate) % 360));\n    color = color_reverse ? 360 - color : color;\n    let hs_color = [color, msg.hsSaturation];\n\n    msg.payload = {\n        data: {\n            entity_id: msg.entity_id,\n            hs_color: hs_color,\n            brightness_pct: msg.brightnessPct,\n            transition: msg.transitionRange[0]\n        }\n    };\n} else {\n    let color_temp = msg.currentTimeStatus * (msg.colorTempRange[1] - msg.colorTempRange[0]) / 100 + msg.colorTempRange[0];\n    msg.payload = {\n        data: {\n            entity_id: msg.entity_id,\n            color_temp: color_temp,\n            brightness_pct: msg.brightnessPct,\n            transition: msg.transitionRange[0]\n        }\n    };\n}\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":240,"wires":[["506b653bb588369b"]]},{"id":"506b653bb588369b","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":500,"y":240,"wires":[[]]},{"id":"49b3e170b0b637a8","type":"function","z":"ccf1abe540a3b5a9","name":"temp color calc","func":"if (msg.color != \"off\" && (msg.attributes?.flowing ?? false)) {\n    let color_rotate = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_rotate\"].state);\n    let color_segment = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_segment\"].state);\n    let color_reverse = global.get('homeassistant').homeAssistant.states[\"input_boolean.color_reverse\"].state == \"on\";\n    let color = (((360 * (color_segment * msg.currentTimeStatus / (360 * 100)) + color_rotate) % 360));\n    color = color_reverse ? 360 - color : color;\n    msg.domain = \"yeelight\";\n    msg.service = \"start_flow\";\n    msg.payload = {\n        data: {\n            entity_id: msg.entity_id,\n            action: \"off\",\n            count: 1,\n            transitions: [\n                {\n                    \"HSVTransition\": [\n                        color,\n                        msg.hsSaturation,\n                        msg.transitionRange[1] * 1000,\n                        msg.brightRange[0]\n                    ]\n                }\n            ]\n        }\n    };\n    return msg;\n} else {\n    msg.domain = \"light\";\n    msg.service = \"turn_off\";\n    msg.payload = {\n        data: {\n            entity_id: msg.entity_id,\n            transition: msg.transitionRange[1]\n        }\n    };\n    return msg;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":240,"wires":[["480f0155fc59ad2e"]]},{"id":"480f0155fc59ad2e","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":860,"y":240,"wires":[[]]},{"id":"19e2561c9f80ace9","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 584","mode":"link","links":["362f908d4e6e1ff5"],"x":965,"y":180,"wires":[]},{"id":"362f908d4e6e1ff5","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 532","links":["19e2561c9f80ace9"],"x":55,"y":240,"wires":[["b782b22904fcacb4"]]},{"id":"194c392731396fca","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"let motion_areas = global.get(\"motion_areas\") ?? {};\nlet active_areas = Object.keys(motion_areas).filter(a => (motion_areas[a] == \"on\" || motion_areas[a] == \"last\"));\nlet msgs = active_areas.map(a => ({\n    linkedArea: a,\n    search: {\n        \"is\": {\n            linkedClass: \"light\",\n            linkedArea: a, \n            state: \"on\"\n        }\n    },\n    output_name: \"lights\",\n    outputEmptyResults: false,\n    state: motion_areas[a]\n}\n));\n\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":380,"wires":[["e9d3c04e7d855f89"]]},{"id":"e9d3c04e7d855f89","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":695,"y":380,"wires":[["96fcc71316f08920"]],"l":false},{"id":"15d73482cc33f748","type":"function","z":"ccf1abe540a3b5a9","name":"desactivate cubes / empty locked_lights","func":"let cubes = global.get(\"cubes\") ?? {};\n\nfor (let key of Object.keys(cubes)) {\n    cubes[key].flip90 = false;\n    cubes[key].free_fall = false;\n    cubes[key].shake_air = false;\n}\n\nglobal.set(\"cubes\", cubes);\nglobal.set(\"locked_lights\", []);\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":595,"y":880,"wires":[["e9e28d9783ef5d3c"]],"l":false},{"id":"fb41d8a3f6c9865c","type":"function","z":"ccf1abe540a3b5a9","name":"set lights","func":"msg.lights = msg.lights.map(l => l.entity_id);\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":880,"wires":[["f75ff98c33f51cb6"]]},{"id":"e9e28d9783ef5d3c","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"msg.search = { \"is\": { linkedClass: \"light\", state: [\"on\", \"off\"] } };\nmsg.output_name = \"lights\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":880,"wires":[["3ef0e008de820adc"]]},{"id":"3ef0e008de820adc","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":795,"y":880,"wires":[["fb41d8a3f6c9865c"]],"l":false},{"id":"c5361089295203a3","type":"comment","z":"ccf1abe540a3b5a9","name":"turn lights off when not home","info":"","x":160,"y":820,"wires":[]},{"id":"0d420d11e004d498","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":290,"y":880,"wires":[[],["ad9a09b8e7b92562"]]},{"id":"f75ff98c33f51cb6","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["{{lights}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1050,"y":880,"wires":[[]]},{"id":"89137c141a217444","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"all lights","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"^light.","entityIdType":"regex","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":80,"y":440,"wires":[[]]},{"id":"b1b5075f6cb863dc","type":"subflow:10a4bbabe046de0e","z":"ccf1abe540a3b5a9","name":"","x":560,"y":440,"wires":[[]]},{"id":"bca36aea5c1f2c33","type":"function","z":"ccf1abe540a3b5a9","name":"lock calc","func":"let locked_lights = global.get(\"locked_lights\") ?? [];\nlet motion_areas = global.get(\"motion_areas\") ?? {};\nlet xy_grey = [0.323, 0.329];\n\nif (motion_areas[msg.light[0].linkedArea] !== undefined) {\n    let new_xy_color = msg.data.new_state.attributes.xy_color ?? [0, 0];\n    let old_xy_color = msg.data.old_state.attributes.xy_color ?? new_xy_color;\n\n    if (locked_lights.includes(msg.data.entity_id) && new_xy_color[0] === xy_grey[0] && new_xy_color[1] === xy_grey[1]) {\n        return { lock_lights: [msg.data.entity_id], lock: false };\n    } else if (!(locked_lights.includes(msg.data.entity_id)) && old_xy_color[0] !== xy_grey[0] && old_xy_color[1] !== xy_grey[1]) {\n\n        let new_state = msg.data.new_state.state;\n        if ((motion_areas[msg.light[0].linkedArea] !== \"off\" ? \"on\" : \"off\") !== new_state) {\n            return { lock_lights: [msg.data.entity_id], lock: true };\n        }\n\n        if (msg.data.new_state.state === \"on\") {\n            let old_brightness = msg.data.old_state.attributes.brightness;\n            let new_brightness = msg.data.new_state.attributes.brightness;\n            if (Math.abs(old_brightness - new_brightness) / 255 > 4) {\n                return { lock_lights: [msg.data.entity_id], lock: true };\n            }\n\n            let x = Math.abs(old_xy_color[0] - new_xy_color[0]);\n            let y = Math.abs(old_xy_color[1] - new_xy_color[1]);\n            if (Math.hypot(x, y) * 100 / Math.sqrt(2) > 4) {\n                return { lock_lights: [msg.data.entity_id], lock: true };\n            }\n        }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":440,"wires":[["b1b5075f6cb863dc","02d747e6e36ae018"]]},{"id":"3083806c4ac17170","type":"function","z":"ccf1abe540a3b5a9","name":"light >","func":"msg.search = { \"is\": { entity_id: msg.data.entity_id } };\nmsg.output_name = \"light\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":440,"wires":[["57726d3a7e5d3943"]]},{"id":"57726d3a7e5d3943","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":315,"y":440,"wires":[["bca36aea5c1f2c33"]],"l":false},{"id":"02d747e6e36ae018","type":"switch","z":"ccf1abe540a3b5a9","name":"lock ?","property":"lock","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":690,"y":440,"wires":[["8f97d023011710df"]]},{"id":"8f97d023011710df","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 619","mode":"link","links":["42bcf58ce90dbbb4"],"x":775,"y":440,"wires":[]},{"id":"964ca054765f4969","type":"debug","z":"ccf1abe540a3b5a9","name":"debug 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":320,"y":300,"wires":[]},{"id":"64e37aeabacaf05d","type":"catch","z":"a1ed8ea56c7ba1f9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["c26fcca6989cf4f3"]]},{"id":"482a9536d24b4218","type":"subflow:ad3b29a5dd67898f","z":"a1ed8ea56c7ba1f9","name":"","x":460,"y":40,"wires":[]},{"id":"c26fcca6989cf4f3","type":"change","z":"a1ed8ea56c7ba1f9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Temperature","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["482a9536d24b4218"]]},{"id":"84e57cca5619edcb","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 491","mode":"link","links":["bee46b9a48eee793"],"x":765,"y":180,"wires":[]},{"id":"355950fd1e7c52a2","type":"function","z":"a1ed8ea56c7ba1f9","name":"windows >","func":"msg.search = { \"is\": { linkedClass: \"window\", state: [\"on\", \"off\"] } };\n\nif (msg.linkedArea !== undefined) {\n    msg.search.is = { ...msg.search.is, linkedArea: msg.linkedArea };\n}\n\nmsg.output_name = \"windows\";\nmsg.outputEmptyResults = true;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":180,"wires":[["b344dca91a2e3cd1"]]},{"id":"790b8d8b50e2da22","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"let alert_speaker = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_speaker\"].state == \"on\";\nlet alert_light = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_light\"].state == \"on\";\nlet notification_id = \"temperature_alert_\" + msg.linkedArea;\n\nif (msg.count == 0) {\n    msg = { notification_id: notification_id };\n    //setMessage({ count: 1, rgbs: [[150, 255, 150], [15, 25, 15]] }, \"sound\", \"correct.mp3\");\n    msg.sound = \"correct.mp3\";\n    msg.dismiss = true;\n    return msg;\n} else if (msg.count < 3) {\n    let count = 2;\n    msg = { ...msg, notification_id: notification_id, alertType: \"info\" };\n    switch (msg.alert) {\n        case \"outside_max_temp_close\":\n            msg = { ...msg, title: \"TempÃ©rature haute\", message: \"Fermez\" + setWindowsText() + \"pour rester au frais\" };\n            setMessage({ count: count, rgbs: [[255, 80, 0], [25, 8, 0]] }, \"speak\", msg.message);\n            return msg;\n        case \"outside_min_temp_close\":\n            msg = { ...msg, title: \"TempÃ©rature basse\", message: \"Fermez\" + setWindowsText() + \"pour rester au chaud\" };\n            setMessage({ count: count, rgbs: [[0, 80, 255], [0, 8, 25]] }, \"speak\", msg.message);\n            return msg;\n        case \"inside_max_temp_open\":\n            msg = { ...msg, title: \"TempÃ©rature haute\", message: \"Ouvrez\" + setWindowsText() + \"pour baisser la tempÃ©rature\" };\n            setMessage({ count: count, rgbs: [[0, 80, 255], [0, 8, 25]] }, \"speak\", msg.message);\n            return msg;\n        case \"inside_max_hum_open\":\n            msg = { ...msg, title: \"HumiditÃ© haute\", message: \"Ouvrez\" + setWindowsText() + \"pour rÃ©duire l'humiditÃ©\" };\n            setMessage({ count: count, rgbs: [[0, 200, 255], [0, 20, 25]] }, \"speak\", msg.message);\n            return msg;\n    }\n}\n\nfunction setMessage(light, audioType, speaker) {\n    if (alert_light) {\n        msg.lightEffect = light;\n    }\n    if (alert_speaker) {\n        msg[audioType] = speaker;\n    }\n}\n\nfunction setWindowsText() {\n    let alias = msg.windowsAlias;\n    if (alias.length == 1) {\n        return \" la fenÃªtre \" + alias[0] + \" \";\n    } else {\n        let joined = alias.slice(0, -1).join(\", \") + \" et \" + alias[alias.length - 1];\n        return \" les fenÃªtres \" + joined + \" \";\n    }\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":360,"wires":[["a9f60d370046baba"]]},{"id":"0c1bc4bca64606a1","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"msg.notification_id = \"module_temp_hum\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Alertes tempÃ©rature dÃ©sactivÃ©\";\n    msg.message = \"Module Alertes tempÃ©rature dÃ©sactivÃ©, vous ne recevrez plus d'alerte de recommandations\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":500,"wires":[["4eab8cffd742e405"]]},{"id":"4eab8cffd742e405","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 517","mode":"link","links":["e53334a6f05a9609"],"x":415,"y":500,"wires":[]},{"id":"bee46b9a48eee793","type":"link in","z":"a1ed8ea56c7ba1f9","name":"get comforts","links":["84e57cca5619edcb"],"x":55,"y":240,"wires":[["53a0bce48cbb421f"]]},{"id":"53a0bce48cbb421f","type":"function","z":"a1ed8ea56c7ba1f9","name":"prepare ext_comfort","func":"let rising = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].attributes.rising;\nlet temperatures = global.get(\"temperatures\") ?? {};\nlet humidities = global.get(\"humidities\") ?? {};\n\n\nif (temperatures.exterior !== undefined && humidities.exterior !== undefined\n    && (new Date().getTime() - temperatures[\"exterior\"].lastChanged) / 1000 < 120 * 60\n    && (new Date().getTime() - humidities[\"exterior\"].lastChanged) / 1000 < 120 * 60\n) {\n    msg.payload = {\n        ext_temperature: temperatures[\"exterior\"].value > 0 ? temperatures[\"exterior\"].value : 0,\n        ext_humidity: humidities[\"exterior\"].value,\n        ext_metabolic: 1.1//rising ? 1.25 : 1.1\n    };\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":240,"wires":[["bfe72a18cd8bdf00"]]},{"id":"bfe72a18cd8bdf00","type":"comfort","z":"a1ed8ea56c7ba1f9","name":"ext comfort","tempField":"payload.ext_temperature","tempFieldType":"msg","mrtField":"payload.temperature","mrtFieldType":"operative","humidityField":"payload.ext_humidity","humidityFieldType":"msg","airspeedField":"0","airspeedFieldType":"num","metabolicRateField":"payload.ext_metabolic","metabolicRateFieldType":"msg","clothingLevelField":"0.5","clothingLevelFieldType":"num","comfortField":"ext_comfort","comfortFieldType":"msg","sensationField":"sensation","sensationFieldType":"msg","x":335,"y":240,"wires":[["c27ba7b953d09386"]],"l":false},{"id":"c27ba7b953d09386","type":"function","z":"a1ed8ea56c7ba1f9","name":"prepare int_comfort","func":"let rising = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].attributes.rising;\nlet temperatures = global.get(\"temperatures\") ?? {};\nlet humidities = global.get(\"humidities\") ?? {};\nlet comforts = global.get(\"comforts\") ?? {};\nmsg.payload = [];\n\ncomforts[\"exterior\"] = Math.round(msg.ext_comfort * 100) / 100;\nglobal.set(\"comforts\", comforts);\n\nfor (let area of Object.keys(temperatures).filter( area => area != \"exterior\")) {\n    if (area in humidities) {\n        msg.payload.push({\n            linkedArea: area,\n            area_temperature: temperatures[area].value,\n            area_humidity: humidities[area].value,\n            area_metabolic: 1.1\n        });\n    }\n}\n\nif (msg.payload.length != 0) {\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":240,"wires":[["05598db807e36deb"]]},{"id":"05598db807e36deb","type":"split","z":"a1ed8ea56c7ba1f9","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":595,"y":240,"wires":[["39c192ebb0aaeb57"]],"l":false},{"id":"39c192ebb0aaeb57","type":"comfort","z":"a1ed8ea56c7ba1f9","name":"area comfort","tempField":"payload.area_temperature","tempFieldType":"msg","mrtField":"payload.temperature","mrtFieldType":"operative","humidityField":"payload.area_humidity","humidityFieldType":"msg","airspeedField":"0","airspeedFieldType":"num","metabolicRateField":"payload.area_metabolic","metabolicRateFieldType":"msg","clothingLevelField":"0.5","clothingLevelFieldType":"num","comfortField":"payload.area_comfort","comfortFieldType":"msg","sensationField":"payload.sensation","sensationFieldType":"msg","x":645,"y":240,"wires":[["a608f3c2b85dae1f"]],"l":false},{"id":"a608f3c2b85dae1f","type":"join","z":"a1ed8ea56c7ba1f9","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":695,"y":240,"wires":[["979a0a76a33f1a28"]],"l":false},{"id":"c998dc8531f83616","type":"api-current-state","z":"a1ed8ea56c7ba1f9","name":"module_temp_hum on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temp_hum","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":495,"y":180,"wires":[["355950fd1e7c52a2"],[]],"l":false},{"id":"a6ba23620056cd74","type":"server-state-changed","z":"a1ed8ea56c7ba1f9","name":"module_temp_hum","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_temp_hum","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":500,"wires":[["0c1bc4bca64606a1"]]},{"id":"00bc0f6c0d6f1f45","type":"comment","z":"a1ed8ea56c7ba1f9","name":"zones recommendations","info":"","x":150,"y":120,"wires":[]},{"id":"38c22b5e03af8fd9","type":"comment","z":"a1ed8ea56c7ba1f9","name":"on/off module_temp_hum","info":"","x":150,"y":440,"wires":[]},{"id":"34ceebd8badac0b8","type":"inject","z":"a1ed8ea56c7ba1f9","name":"5 min","props":[],"repeat":"","crontab":"*/5 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":170,"y":180,"wires":[["c998dc8531f83616"]]},{"id":"b344dca91a2e3cd1","type":"subflow:3da7ebfd83a38899","z":"a1ed8ea56c7ba1f9","name":"","x":715,"y":180,"wires":[["84e57cca5619edcb"]],"l":false},{"id":"820d17520ea5b902","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 544","links":["0dac8a656e626a27"],"x":55,"y":180,"wires":[["c998dc8531f83616"]]},{"id":"72826488954c041f","type":"function","z":"a1ed8ea56c7ba1f9","name":"set comforts","func":"msg.comforts = global.get(\"comforts\") ?? {};\n\nfor (let comfort of msg.payload) {\n    msg.comforts[comfort.linkedArea] = Math.round(comfort.area_comfort * 100) / 100;\n}\n\nglobal.set(\"comforts\", msg.comforts);\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":300,"wires":[["a464f957805cd601"]]},{"id":"5c874c0bc4e6e3ea","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 545","links":["b0f8c3e79d616f81"],"x":55,"y":360,"wires":[["f00997582707e175"]]},{"id":"f00997582707e175","type":"function","z":"a1ed8ea56c7ba1f9","name":"prepare recommendations","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet recommendations = global.get(\"recommendations\") ?? {};\nlet temperatures = global.get(\"temperatures\") ?? {};\nlet humidities = global.get(\"humidities\") ?? {};\nlet comforts = global.get(\"comforts\") ?? {};\nlet windows = msg.windows;\n\nif (temperatures[\"exterior\"] !== undefined && humidities[\"exterior\"] !== undefined && comforts[\"exterior\"] !== undefined) {\n    let humidityMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state);\n    let areas = [... new Set(windows.map(w => w.linkedArea))];\n    let msgs = [];\n\n    windows = windows.map(w => ({ ...w, linkedArea: temperatures[w.linkedArea] !== undefined && humidities[w.linkedArea] !== undefined && comforts[w.linkedArea] !== undefined ? w.linkedArea : \"home\" }));\n\n    for (let area of areas) {\n        area = temperatures[area] !== undefined && humidities[area] !== undefined && comforts[area] !== undefined ? area : \"home\";\n\n        if (\n            temperatures[area] !== undefined && humidities[area] !== undefined && comforts[area] !== undefined\n            && (new Date().getTime() - temperatures[area].lastChanged) / 1000 < 40 * 60\n            && (new Date().getTime() - humidities[area].lastChanged) / 1000 < 40 * 60\n        ) {\n\n            if (recommendations[area] === undefined) {\n                recommendations[area] = { count: 0 };\n            }\n\n            let windowsAreaOn = windows.filter(w => w.state == \"on\" && w.linkedArea == area);\n            let windowsAreaOff = windows.filter(w => w.state == \"off\" && w.linkedArea == area);\n\n            if (in_home_zone && windowsAreaOn.length != 0 && temperatures[area].high && comforts[\"exterior\"] > comforts[area] && temperatures[area].tendency > 0) {\n                setRecommendations(area);\n                msgs.push({ count: recommendations[area].count, linkedArea: area, alert: \"outside_max_temp_close\", windowsAlias: getWindowsAlias(windowsAreaOn) });\n            } else if (in_home_zone && windowsAreaOn.length != 0 && temperatures[area].low && comforts[\"exterior\"] < comforts[area] && temperatures[area].tendency < 0) {\n                setRecommendations(area);\n                msgs.push({ count: recommendations[area].count, linkedArea: area, alert: \"outside_min_temp_close\", windowsAlias: getWindowsAlias(windowsAreaOn) });\n            } else if (in_home_zone && windowsAreaOn.length == 0 && temperatures[area].high && comforts[\"exterior\"] < comforts[area]) {\n                setRecommendations(area);\n                msgs.push({ count: recommendations[area].count, linkedArea: area, alert: \"inside_max_temp_open\", windowsAlias: getWindowsAlias(windowsAreaOff) });\n            } else if (\n                in_home_zone && windowsAreaOn.length == 0 && !temperatures[area].high && !temperatures[area].low && humidities[area].high\n                && dewPointCalc(temperatures[\"exterior\"].value, humidities[\"exterior\"].value > humidityMax ? humidities[\"exterior\"].value : humidityMax) < dewPointCalc(temperatures[area].value, humidities[area].value)\n            ) {\n                setRecommendations(area);\n                msgs.push({ count: recommendations[area].count, linkedArea: area, alert: \"inside_max_hum_open\", windowsAlias: getWindowsAlias(windowsAreaOff) });\n            } else if (recommendations[area].count != 0) {\n                recommendations[area].count = 0;\n                msgs.push({ count: recommendations[area].count, linkedArea: area });\n            }\n            global.set(\"recommendations\", recommendations);\n        }\n    }\n    return [msgs];\n}\n\nfunction getWindowsAlias(windows) {\n    return windows.map(w => w.alias);\n}\n\nfunction setRecommendations(area) {\n    recommendations[area].count++;\n}\n\nfunction dewPointCalc(temp, hum) {\n    let gamma = (17.27 * temp) / (237.7 + temp) + Math.log(hum / 100);\n    return (237.7 * gamma) / (17.27 - gamma);\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":360,"wires":[["790b8d8b50e2da22"]]},{"id":"a9f60d370046baba","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 511","mode":"link","links":["e53334a6f05a9609"],"x":515,"y":360,"wires":[]},{"id":"a464f957805cd601","type":"function","z":"a1ed8ea56c7ba1f9","name":"set home comfort","func":"const average = array => array.reduce((a, b) => a + b) / array.length;\nmsg.comforts = global.get(\"comforts\") ?? {};\n\nlet comfort_keys = Object.keys(msg.comforts).filter(a => a != \"exterior\" && a != \"home\");\nif (comfort_keys.length != 0) {\n    msg.comforts[\"home\"] = average(comfort_keys.map(a => msg.comforts[a]));\n    global.set(\"comforts\", msg.comforts);\n    return { windows: msg.windows };\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":300,"wires":[["cf25ce7b82f5a452"]]},{"id":"b0f8c3e79d616f81","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 603","mode":"link","links":["5c874c0bc4e6e3ea"],"x":895,"y":300,"wires":[]},{"id":"cf25ce7b82f5a452","type":"function","z":"a1ed8ea56c7ba1f9","name":"set home temperature","func":"let temperatureMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state);\nlet temperatureMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet temperatures = global.get(\"temperatures\") ?? {};\nconst average = array => array.reduce((a, b) => a + b) / array.length;\n\nlet temperature_keys = Object.keys(temperatures).filter(a => a != \"exterior\" && a != \"home\");\nif (temperature_keys.length != 0){\n    let value = average(temperature_keys.map(a => temperatures[a].value));\n\n    if (temperatures[\"home\"] === undefined || isNaN(temperatures[\"home\"]?.value)) {\n        temperatures[\"home\"] = {};\n        temperatures[\"home\"].value = value;\n        temperatures[\"home\"].mean_hour = value;\n        temperatures[\"home\"].lastChanged = new Date().getTime();\n    }\n\n    let timeElapsed = parseInt((new Date().getTime() - temperatures[\"home\"].lastChanged) / 1000);\n    let mean_10min = meanCalc(timeElapsed, 600, value, temperatures[\"home\"].value);\n    let mean_hour = meanCalc(timeElapsed, 3600, mean_10min, temperatures[\"home\"].mean_hour);\n    let mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000;\n\n    temperatures[\"home\"].high = temperatureMax <= (Math.ceil(10 * mean_10min) / 10);\n    temperatures[\"home\"].low = (Math.ceil(10 * mean_10min) / 10) <= temperatureMin;\n    temperatures[\"home\"].lastChanged = new Date().getTime();\n    temperatures[\"home\"].tendency = mean_hour_tendency;\n    temperatures[\"home\"].mean_hour = mean_hour;\n    temperatures[\"home\"].value = mean_10min;\n\n    global.set(\"temperatures\", temperatures);\n    return msg; \n}\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed;\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":300,"wires":[["6cf15610c483edfc"]]},{"id":"6cf15610c483edfc","type":"function","z":"a1ed8ea56c7ba1f9","name":"set home humidity","func":"let humidityMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state);\nlet humidityMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state);\nlet humidities = global.get(\"humidities\") ?? {};\nconst average = array => array.reduce((a, b) => a + b) / array.length;\n\nlet temperature_keys = Object.keys(humidities).filter(a => a != \"exterior\" && a != \"home\");\nif (temperature_keys.length != 0) {\n    let value = average(temperature_keys.map(a => humidities[a].value));\n\n    if (humidities[\"home\"] === undefined || isNaN(humidities[\"home\"]?.value)) {\n        humidities[\"home\"] = {};\n        humidities[\"home\"].value = value;\n        humidities[\"home\"].mean_hour = value;\n        humidities[\"home\"].lastChanged = new Date().getTime();\n    }\n\n    let timeElapsed = parseInt((new Date().getTime() - humidities[\"home\"].lastChanged) / 1000);\n    let mean_10min = meanCalc(timeElapsed, 600, value, humidities[\"home\"].value);\n    let mean_hour = meanCalc(timeElapsed, 3600, mean_10min, humidities[\"home\"].mean_hour);\n    let mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000;\n\n    humidities[\"home\"].high = humidityMax <= (Math.ceil(10 * mean_10min) / 10);\n    humidities[\"home\"].low = (Math.ceil(10 * mean_10min) / 10) <= humidityMin;\n    humidities[\"home\"].lastChanged = new Date().getTime();\n    humidities[\"home\"].tendency = mean_hour_tendency;\n    humidities[\"home\"].mean_hour = mean_hour;\n    humidities[\"home\"].value = mean_10min;\n\n    global.set(\"humidities\", humidities);\n    return msg;\n}\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed;\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":300,"wires":[["b0f8c3e79d616f81"]]},{"id":"979a0a76a33f1a28","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 604","mode":"link","links":["66bbc999b1335673"],"x":745,"y":240,"wires":[]},{"id":"66bbc999b1335673","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 546","links":["979a0a76a33f1a28"],"x":55,"y":300,"wires":[["72826488954c041f"]]},{"id":"df0b9ae52c4e45aa","type":"server-state-changed","z":"a1ed8ea56c7ba1f9","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":180,"wires":[["a4b674cad7c26f95"],[]]},{"id":"a4b674cad7c26f95","type":"delay","z":"a1ed8ea56c7ba1f9","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":435,"y":180,"wires":[["c998dc8531f83616"]],"l":false},{"id":"97bc352aaa75228c","type":"catch","z":"6838183963219fc9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["f4d1fbfec928418b"]]},{"id":"8507f5b36fb47028","type":"subflow:ad3b29a5dd67898f","z":"6838183963219fc9","name":"","x":460,"y":40,"wires":[]},{"id":"f4d1fbfec928418b","type":"change","z":"6838183963219fc9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Heaters","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8507f5b36fb47028"]]},{"id":"5c035d30aa0eeaa4","type":"link out","z":"6838183963219fc9","name":"link out 436","mode":"link","links":["e53334a6f05a9609"],"x":695,"y":560,"wires":[]},{"id":"a3c5af234ae25394","type":"function","z":"6838183963219fc9","name":"notification","func":"msg.notification_id = \"heater_temp_lock\";\nlet heat_temp = msg.heat_temp;\n\nif (heat_temp == \"Auto\") {\n    let temperatures = global.get(\"temperatures\") ?? {};\n    if (temperatures[\"home\"] !== undefined && temperatures[\"home\"] <= heat_temp) {\n        msg.speak = \"Chauffage en mode auto\";\n    }\n    msg.dismiss = true;\n    return msg;\n} else {\n    msg.alertType = \"success\";\n    msg.title = \"Chauffage vÃ©rrouillÃ©\";\n    msg.message = \"Chauffage verrouillÃ© Ã  \" + heat_temp.replace(\".\", \",\") + \"Â°C\";\n    msg.speak = \"Chauffage verrouillÃ© Ã  \" + heat_temp.replace(\".\", \",\") + \"Â°\";\n    msg.sendMobile = false;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":560,"wires":[["5c035d30aa0eeaa4"]]},{"id":"d41bfc19bf37e870","type":"function","z":"6838183963219fc9","name":"clean target","func":"let heat_temp = msg.heat_temp.replace(/[^\\d|,.]/g, \"\").replace(\",\", \".\");\n\nif(heat_temp === \"\"){\n    msg.heat_temp = \"Auto\";\n    return msg;\n} else {\n    msg.heat_temp = parseFloat(heat_temp);\n    msg.heat_temp = heat_temp > 22 ? 22 : heat_temp;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":560,"wires":[["5112f376ade581d9"]]},{"id":"96ac39e8656feb5c","type":"function","z":"6838183963219fc9","name":"msgs convectors off","func":"let msgs = msg.convectors.map(c => ({ entity_id: c.entity_id, state: \"off\" }))\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":120,"wires":[["771bec09a66019dd"]]},{"id":"771bec09a66019dd","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":890,"y":120,"wires":[]},{"id":"8f3b675395255275","type":"function","z":"6838183963219fc9","name":"get heat_temp","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes;\n\nif (zone_home[msg.entity_id] !== undefined && home_configuration.convector_config?.[msg.entity_id] !== undefined) {\n    msg.value = home_configuration.convector_config[msg.entity_id];\n    if (msg.entity_id == Object.keys(zone_home)[0]) {\n        return [msg, null];\n    } else {\n        msg.txtZone = msg.entity_id == Object.keys(zone_home)[1] ? \"Dans la zone moyenne\" : \"Dans la grande zone\";\n        return [null, msg];\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":500,"wires":[["08a77a7ed58eedc7"],["08a77a7ed58eedc7","ba726f260be33a59"]]},{"id":"fa233988bc49c813","type":"delay","z":"6838183963219fc9","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":575,"y":440,"wires":[["eafe972177b0c41f"]],"l":false},{"id":"08dcf323de916215","type":"function","z":"6838183963219fc9","name":"notification","func":"msg.notification_id = \"module_heat\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Chauffage dÃ©sactivÃ©\";\n    msg.message = \"Module Chauffage dÃ©sactivÃ©, les chauffages sont allumÃ©s\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":680,"wires":[["8d3c03ad03424be9"]]},{"id":"8d3c03ad03424be9","type":"link out","z":"6838183963219fc9","name":"link out 442","mode":"link","links":["e53334a6f05a9609"],"x":635,"y":680,"wires":[]},{"id":"4d094f27aedbb9d4","type":"function","z":"6838183963219fc9","name":"msgs convectors on","func":"return [msg.convectors.map(c => ({ entity_id: c.entity_id, state: \"on\" }))];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":740,"wires":[["47ba0eb8d0c9e430"]]},{"id":"47ba0eb8d0c9e430","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":630,"y":740,"wires":[]},{"id":"f4d57076103097ca","type":"link in","z":"6838183963219fc9","name":"alert temperature","links":["0dac8a656e626a27","6ac4487e7df2d787","92343d20b8540180"],"x":55,"y":180,"wires":[["74906d8bb03396e9"]]},{"id":"06d37632c6428263","type":"switch","z":"6838183963219fc9","name":"module_heat off ?","property":"module_heat","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":680,"wires":[["c6550e5457450613"]]},{"id":"6a698c348a5afd7f","type":"link out","z":"6838183963219fc9","name":"link out 447","mode":"link","links":["e53334a6f05a9609"],"x":775,"y":500,"wires":[]},{"id":"41f642fb8e8c5b67","type":"function","z":"6838183963219fc9","name":"notification","func":"let heat_temp = msg.value.toString();\n\nmsg.notification_id = \"heater_temp_lock\";\nif (heat_temp == \"Auto\") {\n    msg.dismiss = true;\n} else {\n    msg.alertType = \"success\";\n    msg.title = \"Chauffage en mode Ã©co\";\n    msg.message = msg.txtZone + \", Chauffage verrouillÃ© Ã  \" + heat_temp.replace(\".\", \",\") + \"Â°C\";\n    msg.sendMobile = true;\n}\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":500,"wires":[["6a698c348a5afd7f"]]},{"id":"fead020c09a0aa6e","type":"function","z":"6838183963219fc9","name":"convectors >","func":"msg.search = { \"is\": { linkedClass: \"convector\" }, \"is_not\": { state: \"off\" } };\nmsg.output_name = \"convectors\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":120,"wires":[["b7a1bbe3c12c11dd"]]},{"id":"de632e789d59102b","type":"function","z":"6838183963219fc9","name":"convectors >","func":"msg.search = { \"is\": { linkedClass: \"convector\" } };\nmsg.output_name = \"convectors\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":740,"wires":[["6eb6857eacfa7ad2"]]},{"id":"289b1cdf5cf523a1","type":"function","z":"6838183963219fc9","name":"check auto heat","func":"let json_exterior_average_temp = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state);\nlet tempMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.heat\"].state == \"on\";\n\nlet isUnderTempMin = json_exterior_average_temp[0] < tempMin;\nlet heatState = isUnderTempMin && !heat ? \"on\" : !isUnderTempMin && heat ? \"off\" : \"\";\n\nif (heatState) {\n    return [{ ...msg, entity_id: \"input_boolean.heat\", state: heatState }, null];\n} else {\n    return [null, msg];\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":240,"wires":[["ce15b84a3b2a877d"],["5b871c278cf602d0"]]},{"id":"eb2186cf04837282","type":"function","z":"6838183963219fc9","name":"set target","func":"let notifications = global.get(\"notifications\") ?? {};\nlet temperatures = global.get(\"temperatures\") ?? {};\nlet offsetTemp = 0;\n\nif (temperatures[msg.linkedArea] !== undefined) {\n    let convectorState = global.get(\"homeassistant\").homeAssistant.states[msg.entity_id].state == \"on\";\n    if (msg.windows.length > 0 && convectorState) {\n        msg.notification = \"window_open\";\n        msg.state = \"off\";\n        return msg;\n    } else if ((new Date().getTime() - temperatures[msg.linkedArea].lastChanged) / 1000 < 20 * 60) {\n        let heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"]?.state ?? \"no_temp\";\n        let targetTemp = heat_temp == \"Auto\" ? getTargetTemp(msg.schedule || [], msg.currentTime) : heat_temp;\n        if (targetTemp !== \"no_temp\") {\n            if (temperatures[msg.linkedArea].value < (parseFloat(targetTemp) + offsetTemp)) {\n                msg.state = \"on\";\n            } else {\n                msg.state = \"off\";\n            }\n            if ((\"heater_\" + msg.linkedArea) in notifications) {\n                msg.notification = \"heater_reactivated\";\n            }\n            return msg;\n        } else {\n            msg.notification = \"heater_no_target\";\n            msg.state = \"off\";\n            return msg;\n        }\n    } else {\n        msg.notification = \"temperature_offline\";\n        msg.state = \"off\";\n        return msg;\n    }\n}\n\nfunction getTargetTemp(schedule, currentTime) {\n    let mvt = msg.originalLinkedClass == \"motion\";\n    let motionHeater = context.get(\"motionHeater\") || {};\n    let scheduleHour = \"\";\n    let target = \"no_temp\";\n    let wait = false;\n    for (let s of schedule) {\n        if (currentTime < Object.keys(s)[0]) {\n            break;\n        }\n        scheduleHour = Object.keys(s)[0];\n        wait = s[Object.keys(s)[0]][1];\n        if (!s[Object.keys(s)[0]][1] || mvt || motionHeater[msg.linkedArea + \"_\" + scheduleHour]) {\n            target = s[Object.keys(s)[0]][0];\n        }\n    }\n    if (mvt && wait) {\n        motionHeater[msg.linkedArea + \"_\" + scheduleHour] = true;\n        context.set(\"motionHeater\", motionHeater);\n    } else if (!wait) {\n        motionHeater = {};\n        context.set(\"motionHeater\", motionHeater);\n    }\n    return target;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["f4789a90a8eeb4d0","0eb5d66f836a244e"]]},{"id":"f4789a90a8eeb4d0","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":330,"y":360,"wires":[]},{"id":"0a45d820a250a03a","type":"function","z":"6838183963219fc9","name":"msgs convectors","func":"let msgs = msg.convectors.map(c => ({\n    originalLinkedClass: (\"linkedClass\" in msg ? msg.linkedClass : \"\"),\n    currentTime: msg.currentTime,\n    ...c\n}));\n\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":465,"y":300,"wires":[["f8dac6913df2943a"]],"l":false},{"id":"fe7db153e4105d50","type":"link out","z":"6838183963219fc9","name":"link out 513","mode":"link","links":["e53334a6f05a9609"],"x":675,"y":360,"wires":[]},{"id":"8a955201a68a4d84","type":"function","z":"6838183963219fc9","name":"notification","func":"msg.notification_id = \"heater_\" + msg.linkedArea;\n\nif (msg.notification == \"window_open\" && (msg.originalLinkedClass == \"window\" ?? false)) {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \" dÃ©sactivÃ©\";\n    msg.message = msg.title + \". \" + setMessage(msg.windows);\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.notification == \"heater_no_target\") {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \" dÃ©sactivÃ©\";\n    msg.message = msg.title + \". Pas de consigne recue\";\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.notification == \"temperature_offline\") {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \" dÃ©sactivÃ©\";\n    msg.message = msg.title + \". Le capteur ne renvoi plus de tempÃ©rature depuis plus de 20 minutes\";\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.notification == \"heater_reactivated\") {\n    msg.speak = msg.alias + \" rÃ©activÃ©\";\n    msg.sendMobile = true;\n    msg.dismiss = true;\n    return msg;\n}\n\nfunction setMessage(windows) {\n    let alias = [];\n    for (let window of windows) {\n        alias.push(window.alias);\n    }\n    if (alias.length == 1) {\n        return \"La fenÃªtre \" + alias[0] + \" est ouverte\";\n    } else {\n        let joinAlias = alias.join(\", \");\n        joinAlias = joinAlias.substring(0, joinAlias.lastIndexOf(\", \")) + \" et \" + joinAlias.substring(joinAlias.lastIndexOf(\", \") + 2);\n        return \"Les fenÃªtres \" + joinAlias + \" sont ouvertes\";\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":360,"wires":[["fe7db153e4105d50"]]},{"id":"0eb5d66f836a244e","type":"switch","z":"6838183963219fc9","name":"notification ?","property":"notification","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":455,"y":360,"wires":[["8a955201a68a4d84"]],"l":false},{"id":"f8dac6913df2943a","type":"function","z":"6838183963219fc9","name":"windows >","func":"msg.search = { \"is\": { linkedClass: \"window\", linkedArea: msg.linkedArea, state: \"on\" } };\nmsg.output_name = \"windows\";\nmsg.outputEmptyResults = true;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":300,"wires":[["9e6d0371dcff2efc"]]},{"id":"9d1e5df180bb1596","type":"link out","z":"6838183963219fc9","name":"link out 515","mode":"link","links":["9bdea07f699ed568"],"x":415,"y":240,"wires":[]},{"id":"9bdea07f699ed568","type":"link in","z":"6838183963219fc9","name":"link in 477","links":["9d1e5df180bb1596"],"x":55,"y":300,"wires":[["127dd27364ca7d75"]]},{"id":"a58c778bb22dbbf1","type":"function","z":"6838183963219fc9","name":"notification","func":"msg.notification_id = \"heater_auto\";\nmsg.alertType = \"success\";\n\nif (msg.state === \"on\") {\n    msg.title = \"Chauffage automatique prÃªt\";\n    msg.message = \"Chauffage automatique prÃªt, la tempÃ©rature est suffisamment basse\";\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.state === \"off\") {\n    msg.title = \"Chauffage automatique dÃ©sactivÃ©\";\n    msg.message = \"Chauffage automatique dÃ©sactivÃ©, la tempÃ©rature est suffisamment haute\";\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":240,"wires":[["8ff031019adb02ce"]]},{"id":"8ff031019adb02ce","type":"link out","z":"6838183963219fc9","name":"link out 516","mode":"link","links":["e53334a6f05a9609"],"x":635,"y":240,"wires":[]},{"id":"a92333cdb1a89159","type":"function","z":"6838183963219fc9","name":"convectors >","func":"msg.search = { \"is\": { linkedClass: \"convector\" } };\nmsg.output_name = \"convectors\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":300,"wires":[["68c24beaa2304246"]]},{"id":"e98fd77afdd9134f","type":"function","z":"6838183963219fc9","name":"get time","func":"let d = new Date();\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n\nmsg.currentTime = hour + \":\" + minute;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":180,"wires":[["74906d8bb03396e9"]]},{"id":"5112f376ade581d9","type":"api-call-service","z":"6838183963219fc9","name":"set heat_temp","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{heat_temp}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":420,"y":560,"wires":[["a3c5af234ae25394"]]},{"id":"505a65afa55c41df","type":"api-call-service","z":"6838183963219fc9","name":"set heat_temp","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{heat_temp}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":620,"wires":[[]]},{"id":"08a77a7ed58eedc7","type":"api-call-service","z":"6838183963219fc9","name":"set heat_temp","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{value}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":500,"y":500,"wires":[[]]},{"id":"ce15b84a3b2a877d","type":"api-call-service","z":"6838183963219fc9","name":"heat","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_{{state}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":330,"y":240,"wires":[["9d1e5df180bb1596","a58c778bb22dbbf1"]]},{"id":"5e73472c6012f08e","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":120,"wires":[["fead020c09a0aa6e"],[]]},{"id":"74906d8bb03396e9","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":630,"y":180,"wires":[["88a9a026a74344fe"],[]]},{"id":"eafe972177b0c41f","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":710,"y":440,"wires":[["bb680b876373bffd"],[]]},{"id":"8388fb50772457ce","type":"api-current-state","z":"6838183963219fc9","name":"heat_on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":160,"y":500,"wires":[["8f3b675395255275"],[]]},{"id":"127dd27364ca7d75","type":"api-current-state","z":"6838183963219fc9","name":"heat_on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":160,"y":300,"wires":[["a92333cdb1a89159"],[]]},{"id":"5cde44458366c210","type":"server-events","z":"6838183963219fc9","name":"receive heat_temp","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"ifttt_webhook_received","eventData":"{\"entity_id\":\"heat_temp\"}","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"$outputData(\"eventData\").event_type.value","valueType":"jsonata"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":130,"y":620,"wires":[["2e633c004d07e29c"]]},{"id":"93d7011fbd70b7f1","type":"server-state-changed","z":"6838183963219fc9","name":"heat_temp","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.heat_temp","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"num","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"heat_temp","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":560,"wires":[["d41bfc19bf37e870"]]},{"id":"ba9acd878ee52157","type":"server-state-changed","z":"6838183963219fc9","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":440,"wires":[["eafe972177b0c41f"]]},{"id":"a3982a46058980e4","type":"server-state-changed","z":"6838183963219fc9","name":"heat","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":120,"wires":[[],["5e73472c6012f08e"]]},{"id":"82bb928be71cd17a","type":"server-state-changed","z":"6838183963219fc9","name":"in_middle_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_middle_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":440,"wires":[[],["a7fa1e89e29b2bc7"]]},{"id":"502fe40a2d496315","type":"server-state-changed","z":"6838183963219fc9","name":"in_big_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_big_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":470,"y":440,"wires":[[],["fa233988bc49c813"]]},{"id":"d91dea48227af123","type":"server-state-changed","z":"6838183963219fc9","name":"heat_temp","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.heat_temp","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"num","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"heat_temp","propertyType":"msg","value":"","valueType":"entityState"}],"x":160,"y":180,"wires":[["e98fd77afdd9134f"]]},{"id":"716e7791eeb9e4cc","type":"server-state-changed","z":"6838183963219fc9","name":"module_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":310,"y":180,"wires":[["e98fd77afdd9134f"]]},{"id":"63ecd474b475f903","type":"server-state-changed","z":"6838183963219fc9","name":"module_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_heat","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":680,"wires":[["06d37632c6428263","08dcf323de916215"]]},{"id":"b7a1bbe3c12c11dd","type":"subflow:3da7ebfd83a38899","z":"6838183963219fc9","name":"","x":535,"y":120,"wires":[["96ac39e8656feb5c"]],"l":false},{"id":"9e6d0371dcff2efc","type":"subflow:3da7ebfd83a38899","z":"6838183963219fc9","name":"","x":675,"y":300,"wires":[["29a6606aa98249a0"]],"l":false},{"id":"6eb6857eacfa7ad2","type":"subflow:3da7ebfd83a38899","z":"6838183963219fc9","name":"","x":275,"y":740,"wires":[["4d094f27aedbb9d4"]],"l":false},{"id":"68c24beaa2304246","type":"subflow:3da7ebfd83a38899","z":"6838183963219fc9","name":"","x":415,"y":300,"wires":[["0a45d820a250a03a"]],"l":false},{"id":"88a9a026a74344fe","type":"link out","z":"6838183963219fc9","name":"link out 566","mode":"link","links":["2529ee7d4b3a6ce6"],"x":755,"y":180,"wires":[]},{"id":"2529ee7d4b3a6ce6","type":"link in","z":"6838183963219fc9","name":"link in 516","links":["88a9a026a74344fe"],"x":55,"y":240,"wires":[["289b1cdf5cf523a1"]]},{"id":"29a6606aa98249a0","type":"link out","z":"6838183963219fc9","name":"link out 567","mode":"link","links":["bf2c70a02f300fcf"],"x":725,"y":300,"wires":[]},{"id":"bf2c70a02f300fcf","type":"link in","z":"6838183963219fc9","name":"link in 517","links":["29a6606aa98249a0"],"x":55,"y":360,"wires":[["eb2186cf04837282"]]},{"id":"bb680b876373bffd","type":"link out","z":"6838183963219fc9","name":"link out 568","mode":"link","links":["140f3a798842bdd2"],"x":835,"y":440,"wires":[]},{"id":"140f3a798842bdd2","type":"link in","z":"6838183963219fc9","name":"link in 518","links":["bb680b876373bffd"],"x":55,"y":500,"wires":[["8388fb50772457ce"]]},{"id":"c6550e5457450613","type":"link out","z":"6838183963219fc9","name":"link out 569","mode":"link","links":["3f48018dcc4fbd3c"],"x":415,"y":680,"wires":[]},{"id":"3f48018dcc4fbd3c","type":"link in","z":"6838183963219fc9","name":"link in 519","links":["c6550e5457450613"],"x":55,"y":740,"wires":[["de632e789d59102b"]]},{"id":"2e633c004d07e29c","type":"function","z":"6838183963219fc9","name":"clean target","func":"let heat_temp = msg.heat_temp.replace(/[^\\d|,.]/g, \"\").replace(\",\", \".\");\n\nif(heat_temp === \"\"){\n    msg.heat_temp = \"Auto\";\n    return msg;\n} else {\n    msg.heat_temp = parseFloat(heat_temp);\n    msg.heat_temp = heat_temp > 22 ? 22 : heat_temp;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":620,"wires":[["505a65afa55c41df"]]},{"id":"77e530deb7bf581d","type":"catch","z":"7cc0f49198f44c93","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["5a7b5ddea88e190c"]]},{"id":"3c7ed0693727de58","type":"subflow:ad3b29a5dd67898f","z":"7cc0f49198f44c93","name":"","x":460,"y":40,"wires":[]},{"id":"5a7b5ddea88e190c","type":"change","z":"7cc0f49198f44c93","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Devices","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["3c7ed0693727de58"]]},{"id":"b6536d45be534fe7","type":"comment","z":"7cc0f49198f44c93","name":"linkedClass : ventilation","info":"","x":140,"y":500,"wires":[]},{"id":"4d4b6a5f9d5a991b","type":"comment","z":"7cc0f49198f44c93","name":"linkedClass : water_heat","info":"","x":150,"y":120,"wires":[]},{"id":"6a77bcc53698bdf2","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" };\n\nreturn [\n    msg.ventilations.map(v => (\n        {\n            module_ventilation: msg.module_ventilation,\n            entity_id: v.entity_id,\n            state: inverse[v.state],\n            linkedArea: v.linkedArea\n        }\n    ))\n];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":680,"wires":[["f817476f6c09cf33","43a514d60ce67875"]]},{"id":"43a514d60ce67875","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"let notification_id = \"vmc_\" + msg.linkedArea;\nlet msgs = [];\n\nif (msg.module_ventilation == \"off\") {\n    msgs.push(\n        {\n            notification_id: notification_id,\n            alertType: \"info\",\n            title: \"Module Ventilation\",\n            message: \"Module ventilation dÃ©sactivÃ©, la ventilation est active et les alertes tempÃ©ratures sont dÃ©sactivÃ©es\",\n            sendMobile: true\n        }\n    );\n} else {\n    msgs.push({ notification_id: notification_id, dismiss: true });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":680,"wires":[["76cea9e99f705380"]]},{"id":"bacdad7c8a83142f","type":"function","z":"7cc0f49198f44c93","name":"resend low battery notify","func":"let notifications = global.get(\"notifications\") ?? {};\nlet lowBatteryCount = 0;\n\nfor (let notificationsKey of Object.keys(notifications)) {\n    if (notificationsKey.indexOf(\"battery_lvl\") != -1) {\n        lowBatteryCount++;\n    }\n}\n\nif (lowBatteryCount != 0) {\n    if (lowBatteryCount == 1) {\n        msg.speak = \"Vous avez un capteur avec un niveau de batterie faible.\";\n    } else {\n        msg.speak = \"Vous avez plusieurs capteurs avec des niveaux de batterie faible.\";\n    }\n    msg.speak += \" Pour en savoir plus, regardez vos notifications.\";\n    return msg;\n\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":1020,"wires":[["56d769fc796ea088"]]},{"id":"34c3b26f84cb0b80","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":280,"y":1020,"wires":[["bacdad7c8a83142f"]]},{"id":"9efffdb0ef885bb8","type":"link out","z":"7cc0f49198f44c93","name":"link out 207","mode":"link","links":["e53334a6f05a9609"],"x":895,"y":1080,"wires":[]},{"id":"56d769fc796ea088","type":"subflow:dbf17bea6affd2ec","z":"7cc0f49198f44c93","name":"","x":690,"y":1020,"wires":[]},{"id":"5a1bf07e167f1a1d","type":"comment","z":"7cc0f49198f44c93","name":"alert : low battery","info":"","x":120,"y":960,"wires":[]},{"id":"f817476f6c09cf33","type":"link out","z":"7cc0f49198f44c93","name":"link out 477","mode":"link","links":["7516e795e9c61133"],"x":655,"y":680,"wires":[]},{"id":"76cea9e99f705380","type":"link out","z":"7cc0f49198f44c93","name":"link out 478","mode":"link","links":["e53334a6f05a9609"],"x":875,"y":680,"wires":[]},{"id":"9258d34035c742aa","type":"link in","z":"7cc0f49198f44c93","name":"link in 453","links":["6ac4487e7df2d787"],"x":55,"y":300,"wires":[["dc64f91e4d65bcf5"]]},{"id":"c6459e3b13061ab7","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" };\nreturn [msg.water_heats.map(w => ({ entity_id: w.entity_id, state: inverse[w.state] }))];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":360,"wires":[["73f34f0150aff765"]]},{"id":"73f34f0150aff765","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":750,"y":360,"wires":[]},{"id":"e8fb8feec7a4dfa5","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"water_heat\";\n\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Chauffe-eau dÃ©sactivÃ©\";\n    msg.message = \"Module Chauffe-eau dÃ©sactivÃ©, le chauffe eau est allumÃ©\";\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":360,"wires":[["ce168531822379e5"]]},{"id":"ce168531822379e5","type":"link out","z":"7cc0f49198f44c93","name":"link out 479","mode":"link","links":["e53334a6f05a9609"],"x":1035,"y":360,"wires":[]},{"id":"bb6101f7fb19d8f8","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let water_heats = global.get(\"water_heats\") ?? {};\nlet devices = msg.water_heats;\nlet msgs = [];\n\nfor (let device of devices) {\n    water_heats[device.entity_id] = msg.state == \"on\" ? \"manual\" : \"\";\n    msgs.push({\n        entity_id: device.entity_id,\n        state: msg.state,\n        alias: device.alias\n    });\n}\n\nglobal.set(\"water_heats\", water_heats);\nreturn [msgs];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":240,"wires":[["86f841263b9d8ac6","34949d27140eb419"]]},{"id":"86f841263b9d8ac6","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":1130,"y":240,"wires":[]},{"id":"428ab7267bbfef8b","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":1110,"y":180,"wires":[]},{"id":"40c697883e6c606b","type":"function","z":"7cc0f49198f44c93","name":"prepare device","func":"let water_heats = global.get(\"water_heats\") ?? {};\n\nif (msg.state === \"on\") {\n    if (msg.entity_histories.find(h => h.state == \"on\") === undefined) {\n        water_heats[msg.entity_id] = \"in_big_zone\";\n        return msg;\n    }\n} else {\n    water_heats[msg.entity_id] = \"\";\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":180,"wires":[["abba11061d28fac4","428ab7267bbfef8b"]]},{"id":"abba11061d28fac4","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"water_heat\";\n\nif (msg.state == \"on\") {\n    let water_heat_duration = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state);\n    msg.title = \"Dans la grande zone: Chauffe-eau activÃ©\";\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allumÃ© \" + water_heat_duration + \" min\";\n    msg.speak = msg.message;\n    msg.alertType = \"success\";\n    msg.sendMobile = true;\n    return msg;\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":180,"wires":[["088f2437bb522d14"]]},{"id":"088f2437bb522d14","type":"link out","z":"7cc0f49198f44c93","name":"link out 482","mode":"link","links":["e53334a6f05a9609"],"x":1395,"y":180,"wires":[]},{"id":"ebc5272f39f732f1","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":795,"y":180,"wires":[["40c697883e6c606b"]],"l":false},{"id":"dc64f91e4d65bcf5","type":"function","z":"7cc0f49198f44c93","name":"check","func":"let module_water_heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.module_water_heat\"].state == \"on\";\nlet in_big_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_big_zone\"].state == \"on\";\nlet water_heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.water_heat_temp\"].state == \"on\";\n\nif (module_water_heat && in_big_zone && !water_heat_temp) {\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":300,"wires":[["c9e944ee95454391"]]},{"id":"539dc2c4d06a7fb3","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let waterHeatPct = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_pct\"].state) / 100;\nlet water_heats = global.get(\"water_heats\") ?? {};\nlet devices = msg.water_heats;\nlet msgs = [];\n\nfor (let device of devices) {\n    if (water_heats[device.entity_id] === undefined || water_heats[device.entity_id] != \"manual\" && water_heats[device.entity_id] != \"in_big_zone\") {\n        let timeRange = calcIsScheduled(msg.currentTime, device);\n        if (typeof timeRange == \"object\") {\n            let times = calcRanges(timeRange[0], timeRange[1]);\n            let result = typeof calcIsScheduled(msg.currentTime, times) == \"object\" ? \"on\" : \"off\";\n            water_heats[device.entity_id] = result == \"on\" ? \"scheduled\" : \"\";\n            if (device.state != result) {\n                msgs.push({ entity_id: device.entity_id, state: result, alias: device.alias });\n            }\n        } else if (device.state != (timeRange ? \"on\" : \"off\")) {\n            water_heats[device.entity_id] = timeRange ? \"scheduled\" : \"\";\n            msgs.push({ entity_id: device.entity_id, state: timeRange ? \"on\" : \"off\", alias: device.alias });\n        }\n    }\n}\n\nglobal.set(\"water_heats\", water_heats);\nreturn [msgs];\n\nfunction calcRanges(onTime, offTime) {\n    let start = time_to_minutes(onTime);\n    let end = time_to_minutes(offTime);\n    end = start > end ? 1440 + end : end;\n    let times = { onTime: [], offTime: [] };\n    for (let i = 0; i < (parseInt(end - start) / 60); i++) {\n        times.onTime.push(minutes_to_time(start + (i + 1) * 60 - waterHeatPct * 60));\n        times.offTime.push(minutes_to_time(start + (i + 1) * 60));\n    }\n    return times;\n}\n\nfunction calcIsScheduled(currentTime, device) {\n    let isTime = false;\n    if (device.onTime.length == device.offTime.length) {\n        if (device.onTime.length == 0) {\n            return true;\n        }\n        for (let i = 0; i < device.onTime.length; i++) {\n            isTime = isTime || (device.onTime[i] < device.offTime[i] && device.onTime[i] <= currentTime && currentTime < device.offTime[i]);\n            isTime = isTime || (device.onTime[i] > device.offTime[i] && (device.onTime[i] <= currentTime && currentTime <= \"23:59\" || \"00:00\" <= currentTime && currentTime < device.offTime[i]));\n            if (isTime) {\n                return [device.onTime[i], device.offTime[i]];\n            }\n        }\n    }\n    return isTime;\n}\n\nfunction time_to_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\");\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1]);\n}\n\nfunction minutes_to_time(time) {\n    time = time >= 1440 ? time - 1440 : time;\n    let hours = parseInt(time / 60);\n    hours = hours < 10 ? \"0\" + hours : hours == 0 ? \"00\" : hours;\n    let minutes = time % 60;\n    minutes = minutes < 10 ? \"0\" + minutes : minutes == 0 ? \"00\" : minutes;\n    return hours + \":\" + minutes;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":300,"wires":[["c4b276bd7cbbc844","370eb10450012677"]]},{"id":"370eb10450012677","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":730,"y":300,"wires":[]},{"id":"3e25f16111347f71","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":1150,"y":560,"wires":[]},{"id":"faa3a5726b7782f9","type":"link in","z":"7cc0f49198f44c93","name":"link in 455","links":["6ac4487e7df2d787"],"x":55,"y":560,"wires":[["c45a2415bdcf7e98"]]},{"id":"7516e795e9c61133","type":"link in","z":"7cc0f49198f44c93","name":"link in 456","links":["f817476f6c09cf33","84cf327ba8dbb95c"],"x":1025,"y":560,"wires":[["3e25f16111347f71"]]},{"id":"756f4d593faf47cd","type":"function","z":"7cc0f49198f44c93","name":"prepare scheduled","func":"let ventilations = global.get(\"ventilations\") ?? {};\nlet devices = msg.ventilations;\nlet msgs = [];\n\nfor (let device of devices) {\n    let results = calcIsScheduled(msg.currentTime, device);\n    if (device.linkedArea in ventilations\n        && (results[1] === \"scheduled\" && ventilations[device.linkedArea] !== \"scheduled\" || results[1] === \"\" && ventilations[device.linkedArea] === \"scheduled\")\n        || !(device.linkedArea in ventilations)) {\n        ventilations[device.linkedArea] = results[1];\n        msgs.push({\n            entity_id: device.entity_id,\n            state: results[0],\n            linkedArea: device.linkedArea,\n            alias: device.alias\n        });\n    }\n}\nif (msgs.length !== 0) {\n    global.set(\"ventilations\", ventilations);\n    return [msgs];\n}\n\nfunction calcIsScheduled(currentTime, device) {\n    if (device.onTime.length === device.offTime.length) {\n        let isTime = false;\n        for (let i = 0; i < device.onTime.length; i++) {\n            isTime = isTime\n                || (device.onTime[i] < device.offTime[i] && device.onTime[i] <= currentTime && currentTime < device.offTime[i])\n                || (device.onTime[i] > device.offTime[i] && (\n                    device.onTime[i] <= currentTime && currentTime <= \"23:59\"\n                    || \"00:00\" <= currentTime && currentTime < device.offTime[i]))\n                ;\n            if (isTime) {\n                return [\"on\", \"scheduled\"];\n            }\n        }\n    }\n    return [\"off\", \"\"];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":560,"wires":[["3e25f16111347f71","aeb2eff70381a653"]]},{"id":"0419929f6aea7cca","type":"link out","z":"7cc0f49198f44c93","name":"link out 485","mode":"link","links":["e53334a6f05a9609"],"x":1275,"y":620,"wires":[]},{"id":"bdb378dcde27f270","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"let ventilations = global.get(\"ventilations\") ?? {};\nmsg.notification_id = \"vmc_\" + msg.linkedArea;\nmsg.override = true;\n\nif (ventilations[msg.linkedArea] == \"scheduled\") {\n    msg.alertType = \"success\";\n    msg.title = \"Ventilation activÃ©e par planification\";\n    msg.message = \"La ventilation \" + msg.alias + \" est active\";\n    msg.sendMobile = false;\n    return msg;\n} else if (ventilations[msg.linkedArea] == \"max_humidity\") {\n    msg.alertType = \"success\";\n    msg.title = \"Ventilation \" + msg.alias + \" activÃ©e\";\n    msg.message = \"L'humiditÃ© est haute, la ventilation \" + msg.alias + \" est activÃ©e\";\n    msg.speak = msg.message;\n    msg.sendMobile = false;\n    return msg;\n} else if (ventilations[msg.linkedArea] == \"humidity\") {\n    msg.alertType = \"success\";\n    msg.title = \"Ventilation \" + msg.alias + \" activÃ©e\";\n    msg.message = \"Circonstance favorable, la ventilation \" + msg.alias + \" est activÃ©e\";\n    msg.sendMobile = false;\n    return msg;\n} else if (ventilations[msg.linkedArea] == \"temperature_offline\") {\n    msg.alertType = \"warning\";\n    msg.title = \"Ventilation \" + msg.alias + \" dÃ©sactivÃ©e\";\n    msg.message = \"Le capteur de tempÃ©rature \" + msg.alias + \" ne renvoi plus de donnÃ©es depuis plus de 40 minutes\";\n    msg.sendMobile = false;\n    return msg;\n} else if (ventilations[msg.linkedArea] == \"\") {\n    msg.dismiss = true;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1170,"y":620,"wires":[["0419929f6aea7cca"]]},{"id":"a45e1f6435f091f6","type":"function","z":"7cc0f49198f44c93","name":"prepare humidity","func":"let ventilations = global.get(\"ventilations\") ?? {};\nlet temperatures = global.get(\"temperatures\") ?? {};\nlet humidities = global.get(\"humidities\") ?? {};\nlet comforts = global.get(\"comforts\") ?? {};\nlet devices = msg.ventilations;\nlet msgs = [];\n\nfor (let device of devices) {\n    if (device.linkedArea !== undefined) {\n        let results = autoVentilation(device, comforts);\n        if (device.linkedArea in ventilations\n            && results[1] !== ventilations[device.linkedArea] && ventilations[device.linkedArea] !== \"scheduled\"\n            || !(device.linkedArea in ventilations)) {\n            ventilations[device.linkedArea] = results[1];\n            msgs.push({\n                entity_id: device.entity_id,\n                state: results[0],\n                linkedArea: device.linkedArea,\n                alias: device.alias\n            });\n        }\n    }\n}\n\nif (msgs.length !== 0) {\n    global.set(\"ventilations\", ventilations);\n    return [msgs];\n}\n\nfunction autoVentilation(device, comforts) {\n    let intAreas = Object.keys(comforts).filter(area => comforts[area] != \"exterior\");\n    if (\"exterior\" in comforts && intAreas.length != 0) {\n        let mostUncomfortableArea = devices.length === 1 ?\n            intAreas.sort((a, b) => comforts[a] - comforts[b]).reverse()[0]\n            : device.linkedArea in intAreas ? comforts[device.linkedArea] : \"\";\n\n        if ((new Date().getTime() - humidities[\"exterior\"].lastChanged) / 1000 < 40 * 60\n            && (new Date().getTime() - humidities[mostUncomfortableArea].lastChanged) / 1000 < 40 * 60\n            && (new Date().getTime() - temperatures[mostUncomfortableArea].lastChanged) / 1000 < 40 * 60) {\n\n            if (\n                mostUncomfortableArea\n                && \"exterior\" in humidities\n                && mostUncomfortableArea in humidities\n                && mostUncomfortableArea in temperatures\n            ) {\n                if (\n                    mostUncomfortableArea in humidities\n                    && humidities[mostUncomfortableArea].high\n                    && humidities[mostUncomfortableArea].value > humidities[\"exterior\"].value\n                    && !humidities[\"exterior\"].high\n                ) {\n                    return [\"on\", \"max_humidity\"];\n                } else if (\n                    mostUncomfortableArea in temperatures\n                    && !temperatures[mostUncomfortableArea].low\n                    && comforts[\"exterior\"] < comforts[mostUncomfortableArea]) {\n                    return [\"on\", \"humidity\"];\n                }\n            }\n        } else {\n            return [\"off\", \"temperature_offline\"];\n        }\n    }\n\n    return [\"off\", \"\"];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":620,"wires":[["84cf327ba8dbb95c","bdb378dcde27f270"]]},{"id":"1a65d03fb472b147","type":"inject","z":"7cc0f49198f44c93","name":"10 min","props":[],"repeat":"","crontab":"*/10 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":120,"y":620,"wires":[["0b2998b8acb6ae64"]]},{"id":"84cf327ba8dbb95c","type":"link out","z":"7cc0f49198f44c93","name":"link out 486","mode":"link","links":["7516e795e9c61133"],"x":1015,"y":620,"wires":[]},{"id":"aeb2eff70381a653","type":"link out","z":"7cc0f49198f44c93","name":"link out 487","mode":"link","links":["0c807b7e0bfb7460"],"x":975,"y":560,"wires":[]},{"id":"0c807b7e0bfb7460","type":"link in","z":"7cc0f49198f44c93","name":"link in 457","links":["aeb2eff70381a653"],"x":1065,"y":620,"wires":[["bdb378dcde27f270"]]},{"id":"c4b276bd7cbbc844","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"water_heat_\" + msg.entity_id;\n\nif (msg.state == \"on\") {\n    msg.title = \"Chauffe-eau activÃ© par planification\";\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allumÃ©\";\n    msg.alertType = \"success\";\n    msg.sendMobile = false;\n    return msg;\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":300,"wires":[["840e0643e8c84153"]]},{"id":"840e0643e8c84153","type":"link out","z":"7cc0f49198f44c93","name":"link out 488","mode":"link","links":["e53334a6f05a9609"],"x":1015,"y":300,"wires":[]},{"id":"1bec02e18f41cee3","type":"function","z":"7cc0f49198f44c93","name":"set delay","func":"msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state) * 60 * 1000;\nmsg.state = \"off\";\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":180,"wires":[["ebc5272f39f732f1"]]},{"id":"34949d27140eb419","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"water_heat\";\n\nif (msg.state == \"on\") {\n    let water_heat_duration = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state);\n    msg.title = \"Chauffe-eau activÃ© manuellement\";\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allumÃ© \" + water_heat_duration + \" min\";\n    msg.alertType = \"success\";\n    msg.sendMobile = true;\n    return msg;\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1310,"y":240,"wires":[["27ce4ecdecc58ff1"]]},{"id":"27ce4ecdecc58ff1","type":"link out","z":"7cc0f49198f44c93","name":"link out 500","mode":"link","links":["e53334a6f05a9609"],"x":1415,"y":240,"wires":[]},{"id":"355dfe3a24581e4d","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":240,"wires":[["79773f6b837c02f1","85453006e9fb8796"]],"l":false},{"id":"8ea5d0179ce614e9","type":"function","z":"7cc0f49198f44c93","name":"set delay","func":"msg.state = msg.payload;\n\nif (msg.state == \"on\") {\n    msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state) * 60 * 1000;\n    msg.state = \"off\";\n} else {\n    msg.reset = true;\n}\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":240,"wires":[["355dfe3a24581e4d"]]},{"id":"55eac8dff698a429","type":"function","z":"7cc0f49198f44c93","name":"water_heats >","func":"msg.search = { \"is\": { linkedClass: \"water_heat\" } };\nmsg.output_name = \"water_heats\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":180,"wires":[["e6299150d0259d89"]]},{"id":"85453006e9fb8796","type":"function","z":"7cc0f49198f44c93","name":"water_heats >","func":"msg.search = { \"is\": { linkedClass: \"water_heat\" } };\nmsg.output_name = \"water_heats\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":240,"wires":[["757e30e8e072935b"]]},{"id":"c9e944ee95454391","type":"function","z":"7cc0f49198f44c93","name":"water_heats >","func":"msg.search = { \"is\": { linkedClass: \"water_heat\" } };\nmsg.output_name = \"water_heats\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":300,"wires":[["254727fe68e5a556"]]},{"id":"0853fac1572e1008","type":"function","z":"7cc0f49198f44c93","name":"water_heats >","func":"msg.search = { \"is\": { linkedClass: \"water_heat\", state: msg.payload } };\nmsg.output_name = \"water_heats\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":360,"wires":[["79ccb5d164804c7e"]]},{"id":"47908483fafc8782","type":"function","z":"7cc0f49198f44c93","name":"ventilations >","func":"msg.search = { \"is\": { linkedClass: \"ventilation\" } };\nmsg.output_name = \"ventilations\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":560,"wires":[["00a344464754b574"]]},{"id":"b2317293f5dbab97","type":"function","z":"7cc0f49198f44c93","name":"ventilations >","func":"msg.search = { \"is\": { linkedClass: \"ventilation\" } };\nmsg.output_name = \"ventilations\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":620,"wires":[["126dfe7c926a0a06"]]},{"id":"ec47075613cfdd43","type":"function","z":"7cc0f49198f44c93","name":"ventilations >","func":"msg.search = { \"is\": { linkedClass: \"ventilation\" } };\nmsg.output_name = \"ventilations\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":680,"wires":[["28db9ccc6af241a1"]]},{"id":"bafa5d55d2c3d20b","type":"function","z":"7cc0f49198f44c93","name":"set","func":"let old_state = msg.data.event.old_state.state;\nlet new_state = msg.data.event.new_state.state;\n\nif (old_state && new_state && old_state != new_state) {\n    msg.entity_id = msg.data.event.entity_id;\n    msg.new_state = isNaN(new_state) ? new_state : parseInt(new_state);\n    msg.friendly_name = msg.data.event.new_state.attributes.friendly_name;\n\n    delete msg.data;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":1080,"wires":[["f156cfb1302b4c43"]]},{"id":"f156cfb1302b4c43","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"let low_batteries = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.low_batteries\"].state);\nlet notifications = global.get(\"notifications\") ?? {};\n\nif (isNaN(msg.new_state)) {\n    msg.state = onOff(msg.new_state);\n} else {\n    msg.state = msg.new_state;\n}\n\nmsg.notification_id = \"battery_lvl\" + msg.entity_id.substring(msg.entity_id.lastIndexOf(\"_\"));\nif (msg.state < low_batteries) {\n    if (notifications[msg.notification_id] === undefined) {\n        if (msg.state == 0) {\n            msg.title = \"Alerte batterie vide\";\n            msg.alertType = \"error\";\n            msg.message = \"Batterie \" + msg.friendly_name + \" Ã  0%\";\n            msg.speak = \"La batterie \" + msg.friendly_name + \" est Ã  0%\";\n        } else {\n            msg.title = \"Alerte batterie faible\";\n            msg.alertType = \"warning\";\n            msg.message = \"Batterie \" + msg.friendly_name + \" en dessous de \" + low_batteries + \"%\";\n            msg.speak = \"La batterie \" + msg.friendly_name + \" est en dessous de \" + low_batteries + \"%\";\n        }\n        msg.sendMobile = true;\n        return msg;\n    }\n} else if (notifications[msg.notification_id] !== undefined && msg.state == 100) {\n    msg.speak = \"La batterie \" + msg.friendly_name + (isNaN(msg.new_state) ? \" Ã  Ã©tÃ© remplacÃ©e\" : \" est Ã  \" + msg.state + \"%\");\n    msg.dismiss = true;\n    return msg;\n}\n\nfunction onOff(new_state) {\n    return new_state == \"off\" ? 100 : new_state == \"on\" ? low_batteries - 1 : 0;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":1080,"wires":[["9efffdb0ef885bb8"]]},{"id":"d7e76ca94f363631","type":"function","z":"7cc0f49198f44c93","name":"set","func":"msg.entity_id = msg.payload.entity_id;\nmsg.new_state = isNaN(msg.payload.state) ? msg.payload.state : parseInt(msg.payload.state);\nmsg.friendly_name = msg.payload.attributes.friendly_name;\n\ndelete msg.data;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":1080,"wires":[["f156cfb1302b4c43"]]},{"id":"e674a33ab19f7c47","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":850,"y":420,"wires":[]},{"id":"2ef5ba58f0befc5d","type":"function","z":"7cc0f49198f44c93","name":"set water heat pct","func":"let json_exterior_average_temp = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state);\nlet water_heat_person_number = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_person_number\"].state);\nlet water_heat_adjustment = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_adjustment\"].state);\nlet temperatures = global.get(\"temperatures\") ?? {};\nlet msgs = [];\n\nif (temperatures.exterior?.lastChanged !== undefined && ((new Date().getTime() - temperatures[\"exterior\"].lastChanged) / 1000) < 40 * 60 && Array.isArray(json_exterior_average_temp)) {\n    let pct = (-0.6667 * json_exterior_average_temp[0] + 25) * (water_heat_person_number) + water_heat_adjustment;\n    pct = pct > 100 ? 100 : pct < 5 ? 5 : pct;\n    msgs.push({\n        entity_id: \"input_number.water_heat_pct\",\n        state: Math.round(pct)\n    });\n\n    let duration = (pct * 60 * 7 / 100) > 360 ? 360 : (pct * 60 * 7 / 100) < 0 ? 0 : Math.round(pct * 60 * 7 / 100);\n    msgs.push({\n        entity_id: \"input_number.water_heat_duration\",\n        state: duration\n    });\n\n    return [msgs];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":420,"wires":[["e674a33ab19f7c47"]]},{"id":"7527a6b217b28d20","type":"function","z":"7cc0f49198f44c93","name":"devices","func":"return [msg.water_heats.map(d => ({ entity_id: d.entity_id, state: \"on\", alias: d.alias }))];","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":180,"wires":[["daf177b16fa93fd7","1bec02e18f41cee3"]]},{"id":"79773f6b837c02f1","type":"api-call-service","z":"7cc0f49198f44c93","name":"activate manual off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.water_heat_temp"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":240,"wires":[[]]},{"id":"c45a2415bdcf7e98","type":"api-current-state","z":"7cc0f49198f44c93","name":"module_ventilation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_ventilation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":410,"y":560,"wires":[["47908483fafc8782"],[]]},{"id":"0b2998b8acb6ae64","type":"api-current-state","z":"7cc0f49198f44c93","name":"module_ventilation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_ventilation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":450,"y":620,"wires":[["b2317293f5dbab97"],[]]},{"id":"60962951fc197bb6","type":"server-events","z":"7cc0f49198f44c93","name":"battery","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"state_changed","eventData":"{\"new_state\":{\"attributes\":{\"device_class\":\"battery\"}},\"old_state\":{\"attributes\":{\"device_class\":\"battery\"}}}","waitForRunning":true,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":90,"y":1080,"wires":[["bafa5d55d2c3d20b"]]},{"id":"e142d4fca5be15b6","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_ventilation","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_ventilation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_ventilation","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":680,"wires":[["ec47075613cfdd43"]]},{"id":"21e9ce7eda339017","type":"server-state-changed","z":"7cc0f49198f44c93","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":1020,"wires":[["34c3b26f84cb0b80"],[]]},{"id":"86e655c54b6befaf","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_water_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_water_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":360,"wires":[["0853fac1572e1008","e8fb8feec7a4dfa5"]]},{"id":"b06c1a575e85eacb","type":"server-state-changed","z":"7cc0f49198f44c93","name":"sensibility","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.sensibility","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":260,"y":620,"wires":[["0b2998b8acb6ae64"]]},{"id":"07fb6e19c1eb63d6","type":"server-state-changed","z":"7cc0f49198f44c93","name":"low_batteries","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.low_batteries","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":350,"y":1080,"wires":[["1bc0595b549eb74c"]]},{"id":"9c66394db68ae239","type":"server-state-changed","z":"7cc0f49198f44c93","name":"water heat person number","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.water_heat_person_number","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":370,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"bc41ec7b4d0f345b","type":"server-state-changed","z":"7cc0f49198f44c93","name":"water heat adjustment","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.water_heat_adjustment","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":140,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"2af569a4077b0eac","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_ventilation","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_ventilation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_ventilation","propertyType":"msg","value":"","valueType":"entityState"}],"x":190,"y":560,"wires":[["c45a2415bdcf7e98"]]},{"id":"1bc0595b549eb74c","type":"ha-get-entities","z":"7cc0f49198f44c93","name":"","server":"c87720f17866318d","version":1,"rules":[{"property":"entity_id","logic":"is","value":"^sensor.battery_|^sensor.ble_battery_|^sensor.*_bat_level$|^binary_sensor.*battery_low$","valueType":"re"},{"property":"attributes.device_class","logic":"is","value":"battery","valueType":"str"},{"property":"state","logic":"is_not","value":"None","valueType":"str"}],"outputType":"split","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":510,"y":1080,"wires":[["d7e76ca94f363631"]]},{"id":"daf177b16fa93fd7","type":"api-get-history","z":"7cc0f49198f44c93","name":"","server":"c87720f17866318d","version":1,"startDate":"","endDate":"","entityId":"{{entity_id}}","entityIdType":"equals","useRelativeTime":true,"relativeTime":"1 day","flatten":true,"outputType":"array","outputLocationType":"msg","outputLocation":"entity_histories","x":595,"y":180,"wires":[["40c697883e6c606b"]],"l":false},{"id":"1f43db11c8e7d8fb","type":"trigger-state","z":"7cc0f49198f44c93","name":"in_big_zone","server":"c87720f17866318d","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_big_zone","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"entity_id","targetValue":"input_boolean.module_water_heat","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"entity_id","targetValue":"input_boolean.in_big_zone","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":110,"y":180,"wires":[["55eac8dff698a429"],[]]},{"id":"37315bdc76a2adb8","type":"trigger-state","z":"7cc0f49198f44c93","name":"activate manual","server":"c87720f17866318d","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.water_heat_temp","entityIdType":"exact","debugEnabled":false,"constraints":[],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":120,"y":240,"wires":[["3f3fa09655239c17","8ea5d0179ce614e9"],[]]},{"id":"e6299150d0259d89","type":"subflow:3da7ebfd83a38899","z":"7cc0f49198f44c93","name":"","x":395,"y":180,"wires":[["7527a6b217b28d20"]],"l":false},{"id":"757e30e8e072935b","type":"subflow:3da7ebfd83a38899","z":"7cc0f49198f44c93","name":"","x":815,"y":240,"wires":[["bb6101f7fb19d8f8"]],"l":false},{"id":"254727fe68e5a556","type":"subflow:3da7ebfd83a38899","z":"7cc0f49198f44c93","name":"","x":415,"y":300,"wires":[["539dc2c4d06a7fb3"]],"l":false},{"id":"79ccb5d164804c7e","type":"subflow:3da7ebfd83a38899","z":"7cc0f49198f44c93","name":"","x":435,"y":360,"wires":[["c6459e3b13061ab7"]],"l":false},{"id":"00a344464754b574","type":"subflow:3da7ebfd83a38899","z":"7cc0f49198f44c93","name":"","x":715,"y":560,"wires":[["756f4d593faf47cd"]],"l":false},{"id":"126dfe7c926a0a06","type":"subflow:3da7ebfd83a38899","z":"7cc0f49198f44c93","name":"","x":755,"y":620,"wires":[["a45e1f6435f091f6"]],"l":false},{"id":"28db9ccc6af241a1","type":"subflow:3da7ebfd83a38899","z":"7cc0f49198f44c93","name":"","x":415,"y":680,"wires":[["6a77bcc53698bdf2"]],"l":false},{"id":"1fc976a80798860e","type":"link in","z":"7cc0f49198f44c93","name":"","links":["dd3edb6388f2cf92"],"x":515,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"137dcd3e8c0c9d79","type":"comment","z":"7cc0f49198f44c93","name":"devices_control","info":"","x":120,"y":760,"wires":[]},{"id":"169268a458111c77","type":"api-render-template","z":"7cc0f49198f44c93","name":"validate conditions","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":390,"y":820,"wires":[["028ab0c4b195f835"]]},{"id":"028ab0c4b195f835","type":"function","z":"7cc0f49198f44c93","name":"prepare actions","func":"if (msg.payload == \"True\") {\n    let msgs = [];\n    if (/*\"wait_key\" in msg && msg.wait_key !== \"\"*/msg.wait_key) {\n        let waits = global.get(\"waits\") ?? {};\n        delete waits[msg.wait_key];\n        global.set(\"waits\", waits);\n    }\n    for (let a of msg.action) {\n        a[1] = typeof a[1] === \"boolean\" ? a[1] ? \"on\" : \"off\" : a[1];\n        if (typeof a[0] == \"string\" && a[0].search(/wait [0-9]/g) != -1 && typeof a[1] == \"string\" && typeof a[2] == \"object\") {\n            let waits = global.get(\"waits\") || {};\n            waits[a[1]] = { action: a[2] };\n            global.set(\"waits\", waits);\n            msgs.push({ waitsId: a[1], delay: parseFloat(a[0].split(\" \")[1]) * 1000 });\n        } else if (a[0] in global.get(\"homeassistant\").homeAssistant.states\n            && global.get(\"homeassistant\").homeAssistant.states[a[0]].state != a[1]\n            || a[0].startsWith(\"emulate.\") || a[0] === \"action\" || a[0] === \"notification\"\n        ) {\n            msgs.push({\n                entity_id: a[0],\n                state: a[1],\n                delay: a.length == 3 ? a[2] * 1000 : 0\n            });\n        }\n    }\n    return [msgs];\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":820,"wires":[["fce81959add86ef3"]]},{"id":"fce81959add86ef3","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":840,"y":820,"wires":[["3e2ea21da5807437"]]},{"id":"15881f186e9438e4","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":510,"y":880,"wires":[]},{"id":"5e7b56ef5370dbf1","type":"link in","z":"7cc0f49198f44c93","name":"devices_control","links":["5dcebeddf5b32d66"],"x":55,"y":820,"wires":[["5b4e36e3691abbc7"]]},{"id":"c326128c3e4ac32f","type":"link out","z":"7cc0f49198f44c93","name":"link out 605","mode":"link","links":["07a6702638929794"],"x":1055,"y":820,"wires":[]},{"id":"07a6702638929794","type":"link in","z":"7cc0f49198f44c93","name":"link in 548","links":["c326128c3e4ac32f"],"x":55,"y":880,"wires":[["2d4ecdc96ca5e39c"]]},{"id":"2d4ecdc96ca5e39c","type":"function","z":"7cc0f49198f44c93","name":"notification ?","func":"if (msg.entity_id == \"notification\") {\n    msg = { ...msg.state };\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":880,"wires":[["5306f3d605b2fc0b"],["0b411c88122945f7"]]},{"id":"5306f3d605b2fc0b","type":"subflow:6c4028aab794d52d","z":"7cc0f49198f44c93","name":"","x":330,"y":880,"wires":[[]]},{"id":"3e2ea21da5807437","type":"function","z":"7cc0f49198f44c93","name":"wait ?","func":"if (\"waitsId\" in msg) {\n    let waits = global.get(\"waits\") ?? {};\n    if (msg.waitsId in waits) {\n        delete waits[msg.waitsId];\n        global.set(\"waits\", waits);\n    }\n} else {\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":820,"wires":[["c326128c3e4ac32f"]]},{"id":"5b4e36e3691abbc7","type":"function","z":"7cc0f49198f44c93","name":"prepare conditions","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet waits = global.get(\"waits\") ?? {};\nlet msgs = [];\n\nif (home_configuration.devices_control !== undefined) {\n    if (Object.keys(waits).filter(w => w.includes(msg.trigger)).length != 0) {\n        for (let key of Object.keys(waits).filter(w => w.includes(msg.trigger))) {\n            let template = setTemplateVariables(key);\n            msgs.push({ \"wait_key\": key, \"template\": template, \"action\": waits[key].action });\n        }\n    } else if (home_configuration.devices_control[msg.trigger] !== undefined) {\n        let conditions = home_configuration.devices_control[msg.trigger];\n        for (let c of conditions) {\n            let template = setTemplateVariables(c[\"if\"]);\n            msgs.push({ \"template\": template, \"action\": c[\"then\"] });\n        }\n    }\n    return [msgs];\n}\n\nfunction setTemplateVariables(condition) {\n    if (condition.includes(\"global.\")) {\n        let globals_to_inject = global.keys().filter(g => condition.includes(\"global.\" + g));\n        if (globals_to_inject.length != 0) {\n            let injection = '{% set global = {';\n            for (let g of globals_to_inject) {\n                injection += '\"' + g + '\":' + JSON.stringify(global.get(g) || {}) + ',';\n            }\n            injection = injection.slice(0, -1);\n            injection += '} %}';\n            condition = injection + condition;\n        }\n    }\n    return condition;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":820,"wires":[["169268a458111c77"]]},{"id":"d1e03e00d32b7dbf","type":"link in","z":"7cc0f49198f44c93","name":"devices control msg.action","links":["24afdd681a58dab6"],"x":515,"y":820,"wires":[["3f961a69f1caa0ff"]]},{"id":"3f961a69f1caa0ff","type":"change","z":"7cc0f49198f44c93","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"True","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":565,"y":820,"wires":[["028ab0c4b195f835"]],"l":false},{"id":"00ede13124c44890","type":"catch","z":"eaa696a731a52b23","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["b175ee858ab93e92"]]},{"id":"38beb2359e67bda8","type":"subflow:ad3b29a5dd67898f","z":"eaa696a731a52b23","name":"","x":460,"y":40,"wires":[]},{"id":"b175ee858ab93e92","type":"change","z":"eaa696a731a52b23","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"AlarmClock","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["38beb2359e67bda8"]]},{"id":"fd04105f47ce87fa","type":"link in","z":"eaa696a731a52b23","name":"","links":["f9f8f8a690320c67","ab42a79912cbe143"],"x":55,"y":120,"wires":[["29e66f44c6fca0e6"]]},{"id":"29e66f44c6fca0e6","type":"function","z":"eaa696a731a52b23","name":"get alarms","func":"let persons = global.get(\"persons\") ?? {};\nlet alarms = Object.keys(persons).filter(p => persons[p].alarm !== undefined && new Date(persons[p].alarm).getTime() > new Date().getTime()).map(p => persons[p].alarm);\nif (alarms.length > 0) {\n    msg = { \"entity_id\": \"input_datetime.next_alarm_clock\", state: alarms.sort((a, b) => new Date(a).getTime() - new Date(b).getTime())[0] };\n    return msg;\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":120,"wires":[["d4b60e15b7d04c4f"]]},{"id":"d4b60e15b7d04c4f","type":"subflow:723d4991c3c87385","z":"eaa696a731a52b23","name":"","x":350,"y":120,"wires":[]},{"id":"8cb96fcff4774765","type":"ha-time","z":"eaa696a731a52b23","name":"next_alarm_clock","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.next_alarm_clock","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":false,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":540,"y":120,"wires":[["ab42a79912cbe143","25fbb6acb3523c8d"]]},{"id":"ab42a79912cbe143","type":"link out","z":"eaa696a731a52b23","name":"link out 607","mode":"link","links":["fd04105f47ce87fa"],"x":655,"y":120,"wires":[]},{"id":"43405373bd265eac","type":"subflow:e6ac576fb4598283","z":"eaa696a731a52b23","name":"","x":170,"y":180,"wires":[["91790e0a7835b312"],[]]},{"id":"91790e0a7835b312","type":"api-current-state","z":"eaa696a731a52b23","name":"module_alarm_clock ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_alarm_clock","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":360,"y":180,"wires":[["dafc5b58901d4bc8"],[]]},{"id":"caa02938648e86bf","type":"function","z":"eaa696a731a52b23","name":"get alarms","func":"let home_configuration = global.get(\"home_configuration\") ?? {};\nlet persons = global.get(\"persons\") ?? {};\nlet msgs = [];\n\nlet persons_alarm = Object.keys(persons).filter(p => persons[p].alarm === msg.currentTime);\nfor (let p of persons_alarm) {\n    if (\n        persons[p].home_distance === 0\n        && home_configuration[p]?.alarm_clock_actions !== undefined\n        && Array.isArray(home_configuration[p]?.alarm_clock_actions)\n    ) {\n        msgs.push({ action: home_configuration[p].alarm_clock_actions })\n    }\n    return [msgs];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":240,"wires":[["24afdd681a58dab6"]]},{"id":"24afdd681a58dab6","type":"link out","z":"eaa696a731a52b23","name":"alarm started","mode":"link","links":["d1e03e00d32b7dbf"],"x":415,"y":240,"wires":[]},{"id":"dafc5b58901d4bc8","type":"link out","z":"eaa696a731a52b23","name":"link out 608","mode":"link","links":["e76c94408e06e67e"],"x":495,"y":180,"wires":[]},{"id":"e76c94408e06e67e","type":"link in","z":"eaa696a731a52b23","name":"link in 553","links":["dafc5b58901d4bc8"],"x":55,"y":240,"wires":[["7348273c65a22666"]]},{"id":"7348273c65a22666","type":"function","z":"eaa696a731a52b23","name":"get date","func":"let d = new Date();\nlet year = d.getFullYear();\nlet month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1);\nlet day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n\nmsg.currentTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":240,"wires":[["caa02938648e86bf"]]},{"id":"25fbb6acb3523c8d","type":"link out","z":"eaa696a731a52b23","name":"link out 609","mode":"link","links":["23d7ba339668d8cf"],"x":655,"y":120,"wires":[]},{"id":"23d7ba339668d8cf","type":"link in","z":"eaa696a731a52b23","name":"link in 554","links":["25fbb6acb3523c8d"],"x":55,"y":180,"wires":[["43405373bd265eac"]]},{"id":"66b809d75014e699","type":"catch","z":"ab914a2a493ebbf5","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["103b5b2b1d5427e7"]]},{"id":"f63c64627a69e81d","type":"subflow:ad3b29a5dd67898f","z":"ab914a2a493ebbf5","name":"","x":460,"y":40,"wires":[]},{"id":"103b5b2b1d5427e7","type":"change","z":"ab914a2a493ebbf5","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Covers","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["f63c64627a69e81d"]]},{"id":"ff8917fbe0e53ade","type":"link in","z":"ab914a2a493ebbf5","name":"link in 420","links":["0646f3d0a39edf83"],"x":55,"y":420,"wires":[["edcc162b29c8a8af"]]},{"id":"edcc162b29c8a8af","type":"function","z":"ab914a2a493ebbf5","name":"cover calc","func":"let timeToAeration = \"timeToAeration\" in msg ? msg.timeToAeration : 0;\nlet timeToClose = \"timeToClose\" in msg ? msg.timeToClose : 0;\nlet timeToOpen = \"timeToOpen\" in msg ? msg.timeToOpen : 0;\nlet old_state = msg.old_state;\nlet new_state = msg.new_state;\nlet msgs = [];\n\nif (msg.linkedDevice) {\n    if (new_state == 100) {\n        msgs.push({ delay: 0, entity_id: msg.linkedDevice, service: \"open_cover\" });\n\n    } else if (new_state == 0) {\n        msgs.push({ delay: 0, entity_id: msg.linkedDevice, service: \"close_cover\" });\n    } else if (new_state == 1) {\n        if (old_state == 0) {\n            msgs.push({ delay: 0, entity_id: msg.linkedDevice, service: \"open_cover\" });\n            msgs.push({ delay: timeToAeration * 1000, entity_id: msg.linkedDevice, service: \"stop_cover\" });\n        } else {\n            msgs.push({ delay: 0, entity_id: msg.linkedDevice, service: \"close_cover\" });\n            msgs.push({ delay: (old_state / 100) * timeToClose * 1000 + timeToAeration * 1000, entity_id: msg.linkedDevice, service: \"open_cover\" });\n            msgs.push({ delay: (old_state / 100) * timeToClose * 1000 + timeToAeration * 1000 + timeToAeration * 1000, entity_id: msg.linkedDevice, service: \"stop_cover\" });\n        }\n    } else {\n        let delay = old_state == 0 ? timeToAeration * 1000 : 0;\n        if (old_state < new_state) {\n            msgs.push({ delay: 0, entity_id: msg.linkedDevice, service: \"open_cover\" });\n            msgs.push({ delay: delay + ((new_state - old_state) / 100) * timeToOpen * 1000, entity_id: msg.linkedDevice, service: \"stop_cover\" });\n        } else {\n            msgs.push({ delay: 0, entity_id: msg.linkedDevice, service: \"close_cover\" });\n            msgs.push({ delay: delay + ((old_state - new_state) / 100) * timeToClose * 1000, entity_id: msg.linkedDevice, service: \"stop_cover\" });\n        }\n    }\n    return [msgs];\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":420,"wires":[["e378032aeda55c23"]]},{"id":"b930ded2b8ae45b5","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"msg.notification_id = \"module_cover\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Volets roulant dÃ©sactivÃ©\";\n    msg.message = \"Module Volets roulant dÃ©sactivÃ©, les volets roulants ne sont plus controlÃ©es\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":680,"wires":[["47e4fe779b75e0dc"]]},{"id":"47e4fe779b75e0dc","type":"link out","z":"ab914a2a493ebbf5","name":"link out 415","mode":"link","links":["e53334a6f05a9609"],"x":615,"y":680,"wires":[]},{"id":"a861d8b07880a2e2","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"let num_covers = msg.num_covers;\n\nmsg.notification_id = \"empty_home_cover_status\";\nmsg.data = { tag: msg.notification_id };\nmsg.alertType = \"success\";\nmsg.title = (msg.value == 100 ? \"Ouverture\" : \"Fermeture\") + \" des volets\";\nmsg.sendMobile = true;\nmsg.override = true;\nlet endTxt = \" pendant votre absence\";\n\nif (msg.value == 100) {\n    msg.message = (num_covers == 1 ? \"Le volet s'est ouvert\" : \"Les volets se sont ouverts\") + endTxt;\n    return msg;\n} else if (msg.value == 0) {\n    msg.message = (num_covers == 1 ? \"Le volet s'est fermÃ©\" : \"Les volets se sont fermÃ©s\") + endTxt;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":300,"wires":[["625506e86313414c"]]},{"id":"625506e86313414c","type":"link out","z":"ab914a2a493ebbf5","name":"link out 421","mode":"link","links":["e53334a6f05a9609"],"x":955,"y":300,"wires":[]},{"id":"249f4fb1ec363df2","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"msg.notification_id = \"empty_home_cover_status\";\nmsg.dismiss = true;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":540,"wires":[["b968a370a50879c2"]]},{"id":"b968a370a50879c2","type":"link out","z":"ab914a2a493ebbf5","name":"link out 422","mode":"link","links":["e53334a6f05a9609"],"x":395,"y":540,"wires":[]},{"id":"3580dd15a74a7655","type":"function","z":"ab914a2a493ebbf5","name":"set home notification","func":"msg.lightEffect = { \"count\": 4, \"rgbs\": [[255,255,255], [20,20,20]] };\nmsg.sound = \"stores_windows.mp3\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":300,"wires":[["c7102552715b9515"]]},{"id":"42c3215cdd62d3ab","type":"link in","z":"ab914a2a493ebbf5","name":"link in 480","links":["76f701270e0b0d5b"],"x":55,"y":300,"wires":[["25bd49ccf484f3f6"]]},{"id":"25bd49ccf484f3f6","type":"subflow:e6ac576fb4598283","z":"ab914a2a493ebbf5","name":"","x":170,"y":300,"wires":[["d045d0c546a546e9"],["550b06927527c0dd"]]},{"id":"c7102552715b9515","type":"subflow:dbf17bea6affd2ec","z":"ab914a2a493ebbf5","name":"","x":670,"y":300,"wires":[]},{"id":"071b9264580b2b11","type":"link in","z":"ab914a2a493ebbf5","name":"link in 503","links":["0dac8a656e626a27"],"x":55,"y":360,"wires":[["8ee4a09b1ed11805"]]},{"id":"8ee4a09b1ed11805","type":"function","z":"ab914a2a493ebbf5","name":"cover >","func":"msg.search = { \"is\": { linkedWindow: msg.entity_id } };\nmsg.output_name = \"linkedCover\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["eb872512b9d61e39"]]},{"id":"82818f8ef88ff2f3","type":"function","z":"ab914a2a493ebbf5","name":"cover calc","func":"let stores_status = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\";\nreturn { entity_id: msg.linkedCover[0].entity_id, state: stores_status ? 100 : (msg.new_state == \"on\" ? 100 : 0) };","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":360,"wires":[["340e0167ee9237fd"]]},{"id":"87de18b281714248","type":"function","z":"ab914a2a493ebbf5","name":"set covers","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet shutter_awaiting_opening = global.get(\"shutter_awaiting_opening\") ?? {};\nlet windows = msg.linkedWindows;\nlet covers = msg.covers;\nlet value = msg.value;\nlet msgs_covers = [];\n\nfor (let cover of covers) {\n    if (value == 100 && typeof cover.morning_open_if === \"string\" && in_home_zone) {\n        shutter_awaiting_opening[cover.entity_id] = cover;\n        global.set(\"shutter_awaiting_opening\", shutter_awaiting_opening);\n    } else if (value == 100 || (value == 0 && windows.find(a => a.entity_id == cover.linkedWindow).state == \"off\")) {\n        msgs_covers.push(cover.entity_id);\n    }\n}\n\nif(msgs_covers.length > 0){\n    return [\n        { delay: 20000, payload: { data: { entity_id: msgs_covers, value: value } } },\n        { num_covers: msgs_covers.length, value : value}\n    ];\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":240,"wires":[["986aea1e2d4e40b4"],["76f701270e0b0d5b"]]},{"id":"cfff980d5a10bb6e","type":"api-call-service","z":"ab914a2a493ebbf5","name":"set cover","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"cover","service":"{{service}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":360,"y":420,"wires":[[]]},{"id":"0a74c79fa2b26337","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"module_cover","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_cover","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":680,"wires":[["cbea2b38a8abd371","d6384158d1057d71"],["427fd541dd46ad75"]]},{"id":"f32dd6019bb04292","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":540,"wires":[["249f4fb1ec363df2"],[]]},{"id":"eb872512b9d61e39","type":"subflow:3da7ebfd83a38899","z":"ab914a2a493ebbf5","name":"","x":255,"y":360,"wires":[["82818f8ef88ff2f3"]],"l":false},{"id":"e378032aeda55c23","type":"delay","z":"ab914a2a493ebbf5","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":255,"y":420,"wires":[["cfff980d5a10bb6e"]],"l":false},{"id":"76f701270e0b0d5b","type":"link out","z":"ab914a2a493ebbf5","name":"link out 577","mode":"link","links":["42c3215cdd62d3ab"],"x":735,"y":240,"wires":[]},{"id":"a84e0fb704e674af","type":"function","z":"ab914a2a493ebbf5","name":"covers >","func":"msg.search = { \"is\": { linkedClass: \"cover\" } };\nmsg.output_name = \"covers\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":240,"wires":[["034c7553d6ba5596"]]},{"id":"2143636706e300db","type":"function","z":"ab914a2a493ebbf5","name":"set stores_status","func":"return { entity_id: \"input_boolean.stores_status\", state: msg.value == 100 ? \"on\" : \"off\" };","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":180,"wires":[["7f82b15d9bfe38b2"]]},{"id":"7f82b15d9bfe38b2","type":"subflow:723d4991c3c87385","z":"ab914a2a493ebbf5","name":"","x":890,"y":180,"wires":[]},{"id":"0de5ed4271bb5d0d","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":180,"wires":[["ac41bcb9258bb0ae"]]},{"id":"034c7553d6ba5596","type":"subflow:3da7ebfd83a38899","z":"ab914a2a493ebbf5","name":"","x":255,"y":240,"wires":[["44bf6fae821381ba"]],"l":false},{"id":"ac41bcb9258bb0ae","type":"api-current-state","z":"ab914a2a493ebbf5","name":"module_cover on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":180,"wires":[["047a0ab623bd2bb5"],[]]},{"id":"e16a6c17fcea7d8d","type":"link out","z":"ab914a2a493ebbf5","name":"link out 578","mode":"link","links":["b87f8f6549c1045f"],"x":395,"y":680,"wires":[]},{"id":"b87f8f6549c1045f","type":"link in","z":"ab914a2a493ebbf5","name":"link in 526","links":["e16a6c17fcea7d8d","b33b7ed16b6c0484"],"x":55,"y":240,"wires":[["a84e0fb704e674af"]]},{"id":"aa5fac95f2793daf","type":"link in","z":"ab914a2a493ebbf5","name":"link in 527","links":["92343d20b8540180"],"x":55,"y":480,"wires":[["0b847f55c81470fa"]]},{"id":"0b847f55c81470fa","type":"function","z":"ab914a2a493ebbf5","name":"prepare template","func":"let shutter_a = global.get(\"shutter_awaiting_opening\") ?? {};\nlet msgs = [];\n\nfor (let key of Object.keys(shutter_a)) {\n    if (msg.state === \"on\" && msg.linkedArea === shutter_a[key].linkedArea) {\n        msgs.push({ template: setTemplateVariables(shutter_a[key].morning_open_if), key: key })\n    }\n}\nreturn [msgs];\n\nfunction setTemplateVariables(condition) {\n    if (condition.includes(\"global.\")) {\n        let globals_to_inject = global.keys().filter(g => condition.includes(\"global.\" + g));\n        if (globals_to_inject.length != 0) {\n            let injection = '{% set global = {';\n            for (let g of globals_to_inject) {\n                injection += '\"' + g + '\":' + JSON.stringify(global.get(g) || {}) + ',';\n            }\n            injection = injection.slice(0, -1);\n            injection += '} %}';\n            condition = injection + condition;\n            return condition;\n        }\n    } else {\n        return condition;\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":480,"wires":[["9cf622107ac6cc24"]]},{"id":"340e0167ee9237fd","type":"subflow:723d4991c3c87385","z":"ab914a2a493ebbf5","name":"","x":530,"y":360,"wires":[]},{"id":"982b299103aa1fa4","type":"comment","z":"ab914a2a493ebbf5","name":"on/off module_cover","info":"","x":130,"y":620,"wires":[]},{"id":"072afd17d7adfc2a","type":"comment","z":"ab914a2a493ebbf5","name":"cover management","info":"","x":130,"y":120,"wires":[]},{"id":"44bf6fae821381ba","type":"function","z":"ab914a2a493ebbf5","name":"linkedWindows >","func":"msg.search = { \"is\": { entity_id: msg.covers.filter(c => \"linkedWindow\" in c).map(c => c.linkedWindow), state: [\"on\", \"off\"] } };\nmsg.output_name = \"linkedWindows\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":240,"wires":[["da186d257048c864"]]},{"id":"da186d257048c864","type":"subflow:3da7ebfd83a38899","z":"ab914a2a493ebbf5","name":"","x":515,"y":240,"wires":[["87de18b281714248"]],"l":false},{"id":"bafb9ffdf3fe64cb","type":"link out","z":"ab914a2a493ebbf5","name":"link out 590","mode":"link","links":["e598eca6f6ec62d8","718d7de30fef2108"],"x":935,"y":480,"wires":[]},{"id":"047a0ab623bd2bb5","type":"function","z":"ab914a2a493ebbf5","name":"set cover value","func":"let sunAngleCoverOff = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_off\"].state);\nlet sunAngleCoverOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_on\"].state);\nlet stores_status = global.get('homeassistant').homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\";\nlet sun = global.get('homeassistant').homeAssistant.states[\"sun.sun\"];\nlet elevation = sun.attributes.elevation;\nlet rising = sun.attributes.rising;\n\nif (rising && !stores_status && elevation > sunAngleCoverOn) {\n    msg.value = 100;\n    return msg;\n} else if (!rising && stores_status && elevation < sunAngleCoverOff) {\n    msg.value = 0;\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":180,"wires":[["2143636706e300db","b33b7ed16b6c0484"]]},{"id":"cbea2b38a8abd371","type":"function","z":"ab914a2a493ebbf5","name":"set cover value","func":"let stores_status = global.get('homeassistant').homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\";\nreturn { value: stores_status ? 0 : 100 };","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":680,"wires":[["e16a6c17fcea7d8d"]]},{"id":"b33b7ed16b6c0484","type":"link out","z":"ab914a2a493ebbf5","name":"link out 596","mode":"link","links":["b87f8f6549c1045f"],"x":555,"y":180,"wires":[]},{"id":"15085a2365082a87","type":"delay","z":"ab914a2a493ebbf5","name":"","pauseType":"delayv","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":835,"y":240,"wires":[["2ab2ba04b14a404d"]],"l":false},{"id":"2ab2ba04b14a404d","type":"api-call-service","z":"ab914a2a493ebbf5","name":"set covers pct","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":960,"y":240,"wires":[[]]},{"id":"e598eca6f6ec62d8","type":"link in","z":"ab914a2a493ebbf5","name":"set covers pct","links":["bafb9ffdf3fe64cb"],"x":785,"y":240,"wires":[["15085a2365082a87"]]},{"id":"718d7de30fef2108","type":"link in","z":"ab914a2a493ebbf5","name":"sound and light effect","links":["bafb9ffdf3fe64cb"],"x":275,"y":300,"wires":[["0749297f2538e4e9"]]},{"id":"9cf622107ac6cc24","type":"api-render-template","z":"ab914a2a493ebbf5","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":640,"y":480,"wires":[["391610f3824a3dfe"]]},{"id":"391610f3824a3dfe","type":"function","z":"ab914a2a493ebbf5","name":"morning_open_if","func":"let shutter_a = global.get(\"shutter_awaiting_opening\") ?? {};\nlet msgs_covers = [];\n\nif (msg.payload == \"True\") {\n    delete shutter_a[msg.key];\n    global.set(\"shutter_awaiting_opening\", shutter_a);\n    return { delay: 5000, payload: { data: { entity_id: msg.key, value: 100 } } };\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":480,"wires":[["bafb9ffdf3fe64cb"]]},{"id":"0749297f2538e4e9","type":"delay","z":"ab914a2a493ebbf5","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":325,"y":300,"wires":[["3580dd15a74a7655"]],"l":false},{"id":"acf3fa754a61e5fd","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":true,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":150,"y":480,"wires":[["894b6fe54a35c8c3"]]},{"id":"894b6fe54a35c8c3","type":"function","z":"ab914a2a493ebbf5","name":"get elevation","func":"let sunAngleCoverOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_on\"].state);\nlet old_elevation = msg.data.old_state.attributes.elevation;\nlet new_elevation = msg.data.new_state.attributes.elevation;\n\nif (old_elevation < sunAngleCoverOn && sunAngleCoverOn < new_elevation) {\n    let shutter_awaiting_opening = global.get(\"shutter_awaiting_opening\") ?? {};\n    let motion_areas = global.get(\"motion_areas\") ?? {};\n    for (let key of Object.keys(shutter_awaiting_opening)) {\n        msg.linkedArea = shutter_awaiting_opening[key]?.linkedArea;\n        if (motion_areas[msg.linkedArea] === \"on\") {\n            msg.state = \"on\";\n            return msg;\n        }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":480,"wires":[["0b847f55c81470fa"]]},{"id":"b020e66ae86cfbd0","type":"function","z":"a62a0ee8573c9b72","name":"receive activities states","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\nlet action = msg.payload.event.action;\nlet persons = msg.persons;\n\nfor (let p of persons) {\n    if (action.includes(p.name + \"_\")) {\n        let training = action.split(\"_\")[1];\n        if (activities[p.name]?.[training]?.[2] !== undefined) {\n            if (activities[p.name][training][0] < activities[p.name][training][1]) {\n                activities[p.name][training][0]++;\n            }\n            if (activities[p.name][training][0] == activities[p.name][training][1]) {\n                activities[p.name][training][2] = false;\n            }\n\n        }\n    }\n}\n\nmsg.payload = { \"data\": { \"value\": JSON.stringify(activities) } };\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":300,"wires":[["e10a6ab642e72857"]]},{"id":"0429572f34c1181a","type":"function","z":"a62a0ee8573c9b72","name":"build html activities tab","func":"let activities = msg.payload;\nlet persons = msg.persons;\nlet html = \"\";\nlet msgs = [];\n\nfor (let person of persons) {\n    if ((person.sport?.active ?? false) && person.sport?.objective_limits !== undefined && activities[person.name] !== undefined) {\n        html += buildHTML(person, activities);\n    }\n}\n\nlet gap = 0;\nfor (let i = 0; i < 4; i++) {\n    msgs.push({ payload: { data: { entity_id: \"input_text.health_stats_\" + (i + 1), value: html.substring(gap, (gap + 254)) } } });\n    gap += 254;\n}\nreturn [msgs];\n\nfunction buildHTML(person, activities) {\n    let table = [\"\", \"\"];\n    let percent = [0, 0];\n    let sub_html = \"\";\n    for (let key of Object.keys(person.sport.objective_limits)) {\n        if (key in activities[person.name]) {\n            table[0] += '<th style=\"width:20%\">' + (person.sport?.objective_translations?.[key] ?? key) + '</th>';\n            table[1] += '<td>' + (activities[person.name][key][0] === activities[person.name][key][1] ? 'âœ…' : activities[person.name][key][0] + \"/\" + activities[person.name][key][1]) + '</td>';\n            percent[0] += activities[person.name][key][0];\n            percent[1] += activities[person.name][key][1];\n        }\n    }\n    sub_html += '<center><b>' + 'Objectifs santÃ© ' + person.name + \" - \" + \"Jour \" + activities[person.name][\"days\"] + \"/\" + person.sport.days_to_ojective + \" : \";\n    sub_html += (percent[1] == 0 ? 0 : parseInt(100 * percent[0] / percent[1])) + '% atteints cette semaine' + '</b></center><hr>';\n    sub_html += '<table style=\"width:100%;text-align:center\"><tr>' + table[0] + '</tr><tr>' + table[1] + '</tr></table>';\n    return sub_html;\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":360,"wires":[["fc225d0ed2994071"],[]]},{"id":"4b68efecf1da94d1","type":"json","z":"a62a0ee8573c9b72","name":"","property":"payload","action":"","pretty":false,"x":450,"y":360,"wires":[["0429572f34c1181a"]]},{"id":"b1fa06090656fd52","type":"catch","z":"a62a0ee8573c9b72","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["74f70af5292cd7f0"]]},{"id":"b5f1fd6eac80b150","type":"subflow:ba09e97f2ed22f2b","z":"a62a0ee8573c9b72","name":"","x":370,"y":240,"wires":[]},{"id":"2b8a6446b97c275d","type":"subflow:ad3b29a5dd67898f","z":"a62a0ee8573c9b72","name":"","x":460,"y":40,"wires":[]},{"id":"74f70af5292cd7f0","type":"change","z":"a62a0ee8573c9b72","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"sport","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["2b8a6446b97c275d"]]},{"id":"c437e0a422479e97","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.title = \"Option SantÃ©: ActivÃ©e\";\nmsg.message = msg.payload;\nmsg.sendTo = msg.persons.filter(p => p.sport.active).map(p => p.name);\nmsg.sendMobile = true;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":560,"wires":[["0ece54a40b22328b"]]},{"id":"0ece54a40b22328b","type":"subflow:ba09e97f2ed22f2b","z":"a62a0ee8573c9b72","name":"","x":770,"y":560,"wires":[]},{"id":"8f546715d338a376","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.notification_id = \"module_healthy\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Sport et santÃ© dÃ©sactivÃ©\";\n    msg.message = \"Module Sport et santÃ© dÃ©sactivÃ©, vous ne recevrez plus de notifications d'activitÃ©s\";\n    msg.sendTo = msg.persons.filter(p => p.sport.active).map(p => p.name);\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":480,"wires":[["3b3dd6b16a5c5a1d"]]},{"id":"3b3dd6b16a5c5a1d","type":"link out","z":"a62a0ee8573c9b72","name":"link out 416","mode":"link","links":["e53334a6f05a9609"],"x":715,"y":480,"wires":[]},{"id":"fc225d0ed2994071","type":"api-call-service","z":"a62a0ee8573c9b72","name":"health_stats_","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":810,"y":360,"wires":[[]]},{"id":"e10a6ab642e72857","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":710,"y":300,"wires":[[]]},{"id":"ea3fb831dea35c4d","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motiv","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_{{payload}}","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":270,"y":480,"wires":[[]]},{"id":"4020e05dc1d0c23a","type":"server-events","z":"a62a0ee8573c9b72","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":300,"wires":[["a9d7993927bc5de0"]]},{"id":"508f7fb084e67cee","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.json_activities","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":360,"wires":[["0408ccba95850002"]]},{"id":"8640a3a14306a54b","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motiv","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":560,"wires":[["750cd436f7187d1f"],[]]},{"id":"e7e6f923a633831a","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"module_healthy","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_healty","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":480,"wires":[["ea3fb831dea35c4d","28460c8a51f888b3"]]},{"id":"d30ddd8ce8b5dbc5","type":"function","z":"a62a0ee8573c9b72","name":"prepare trainings","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\nlet random = Math.random() * 100;\nlet twd = two_week_day();\nlet persons = msg.persons;\nlet msgs = [];\n\nfor (let person of persons) {\n    if (\n        (person.sport?.active ?? false)\n        && person.sport.days_to_ojective !== undefined\n        && person.sport.objective_calendar !== undefined\n    ) {\n\n        if (activities[person.name] === undefined) {\n            activities[person.name] = {};\n            activities[person.name][\"days\"] = 0;\n        }\n\n        let objective_calendar = person.sport.objective_calendar;\n        let todays_objectives = Object.keys(objective_calendar).filter(a => objective_calendar[a][twd]);\n\n        for (let o of Object.keys(objective_calendar)) {\n            if (twd == 1 || !(o in activities[person.name])) {\n                activities[person.name][o] = [0, 0, false];\n            }\n        }\n\n        let objective_conditions = person.sport.objective_conditions ?? [];\n        objective_conditions = validate_objective_conditions(objective_conditions, todays_objectives);\n        todays_objectives = calculate_objective_conditions(objective_conditions, person, todays_objectives);\n\n        let objective_limits = person.sport.objective_limits;\n\n        for (let o of todays_objectives) {\n            let translations = \"objective_translations\" in person.sport && o in person.sport.objective_translations ? person.sport.objective_translations[o] : o;\n            let todays_objective_limit = [];\n\n            activities[person.name][o][1]++;\n            activities[person.name][o][2] = true;\n\n            if (Array.isArray(objective_limits[o])) {\n                todays_objective_limit = calculate_training(person, objective_limits[o]);\n            } else if (typeof objective_limits[o] === \"object\") {\n                for (let keys of Object.keys(objective_limits[o])) {\n                    let objectiveName = keys.charAt(0).toUpperCase() + keys.slice(1);\n                    todays_objective_limit.push(objectiveName + \": \" + calculate_training(person, objective_limits[o][keys]));\n                }\n                todays_objective_limit = todays_objective_limit.join(\"\\n\");\n            }\n            msgs.push({ objective: { name: o, translations: translations, todays_objective_limit: todays_objective_limit, person: person.name } });\n        }\n        if (activities[person.name][\"days\"] < person.sport.days_to_ojective) {\n            activities[person.name][\"days\"]++;\n        }\n    }\n}\nmsg = { \"payload\": { \"data\": { \"value\": JSON.stringify(activities) } } };\nreturn [msgs, msg];\n\nfunction validate_objective_conditions(objective_conditions, todays_objectives) {\n    let vp = [];\n    for (let p of objective_conditions) {\n        let count = 0;\n        for (let w of p.split(\" \")) {\n            if (todays_objectives.includes(w)) {\n                count++;\n            }\n        }\n        if (count == 2) {\n            vp.push(p);\n        }\n    }\n    return vp;\n}\n\nfunction calculate_objective_conditions(objective_conditions, person, todays_objectives) {\n    for (let p of objective_conditions) {\n        let p_split = p.trim().split(\" \");\n        if (p_split.length == 4 && p_split.includes(\"or\")) {\n            let percentage = p_split[0].replace(\"%\", \"\");\n            todays_objectives = todays_objectives.filter(t => t != (random < parseInt(percentage) ? p_split[3] : p_split[1]));\n        } else if (p_split.length == 3 && p_split.includes(\"to\")) {\n            let percentage = ((person.sport.days_to_ojective - activities[person.name][\"days\"]) / person.sport.days_to_ojective) * 100;\n            todays_objectives = todays_objectives.filter(t => t != (random < parseInt(percentage) ? p_split[2] : p_split[0]));\n        }\n    }\n    return todays_objectives;\n}\n\nfunction calculate_training(person, objective_limits) {\n    let objective = \"\";\n    if (isNaN(objective_limits[0]) && isNaN(objective_limits[1])) {\n        let min_g_split = objective_limits[0].trim().split(\" \");\n        let max_g_split = objective_limits[1].trim().split(\" \");\n        let percentage = activities[person.name][\"days\"] / person.sport.days_to_ojective;\n        objective = parseInt((max_g_split[0] - min_g_split[0]) * percentage + parseInt(min_g_split[0])) + \" \" + max_g_split[1];\n    } else {\n        let min_g = objective_limits[0];\n        let max_g = objective_limits[1];\n        let percentage = activities[person.name][\"days\"] / person.sport.days_to_ojective;\n        let serie_number = parseInt(5 + percentage * 3.99);\n        let repetition_number = parseInt(((max_g - min_g) * percentage + min_g) / serie_number);\n        let rest_number = parseInt(((max_g - min_g) * percentage + min_g) % serie_number);\n        objective = repetition_number + \" * \" + serie_number + (rest_number == 0 ? \"\" : \" + \" + rest_number % serie_number);\n    }\n    return objective;\n}\n\nfunction two_week_day() {\n    let date = new Date();\n    return Math.floor((date.getTime() - new Date(date.getFullYear() + \"-01-01\").getTime()) / (3600000 * 24)) % 14 + 1;\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":120,"wires":[["8356eb9f76953cee"],["4b48cea1d75de3f5"]]},{"id":"9dad3b76bc669d82","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linkedClass: \"person\" } };\nmsg.output_name = \"persons\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":120,"wires":[["8b9dcaebbeab8dbe"]]},{"id":"8b9dcaebbeab8dbe","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":435,"y":120,"wires":[["d30ddd8ce8b5dbc5"]],"l":false},{"id":"ee180b383f6fc021","type":"function","z":"a62a0ee8573c9b72","name":"send trainings","func":"let title = \"Sport: \" + (msg.objective.todays_objective_limit.length != 0 ? \"une sÃ©ance de \" + msg.objective.translations + \" est prÃ©vue\" : msg.objective.translations);\nlet message = msg.objective.todays_objective_limit.length != 0 ? \"Votre objectif: \\n\" + msg.objective.todays_objective_limit : \"\";\n\nmsg = {\n    title: title,\n    message: message,\n    sendTo: [msg.objective.person],\n    sendMobile: true,\n    data: {\n        actions: [{ \"action\": msg.objective.person + \"_\" + msg.objective.name, \"title\": \"Fait avec amour\" }],\n        timeout: 60 * 60 * 20\n    }\n};\n\nreturn msg;\n\n//,{ \"action\": msg.objective.person + \"_\", \"title\": \"pas fait\" }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":240,"wires":[["b5f1fd6eac80b150"]]},{"id":"4b48cea1d75de3f5","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":750,"y":120,"wires":[[]]},{"id":"a9d7993927bc5de0","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linkedClass: \"person\" } };\nmsg.output_name = \"persons\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":300,"wires":[["5bcdeaff2377f30c"]]},{"id":"5bcdeaff2377f30c","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":355,"y":300,"wires":[["b020e66ae86cfbd0"]],"l":false},{"id":"0408ccba95850002","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linkedClass: \"person\" } };\nmsg.output_name = \"persons\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":360,"wires":[["024a365e9fc9cb4f"]]},{"id":"024a365e9fc9cb4f","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":355,"y":360,"wires":[["4b68efecf1da94d1"]],"l":false},{"id":"5fa2746a231a3329","type":"api-current-state","z":"a62a0ee8573c9b72","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":180,"y":120,"wires":[["9dad3b76bc669d82"],[]]},{"id":"750cd436f7187d1f","type":"subflow:386f1888bc94b4c8","z":"a62a0ee8573c9b72","name":"","x":230,"y":560,"wires":[["c68f722f20b3c9e7"]]},{"id":"0927b670d75da52a","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motivation_reset","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation_reset","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":420,"wires":[["e34b2780cf7d6f2d","d38f23be4a30a1a5"],[]]},{"id":"e34b2780cf7d6f2d","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motivation_reset off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_reset"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":310,"y":420,"wires":[[]]},{"id":"9a89420de8a81170","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities reset","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"{\"value\":\"{}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":420,"wires":[[]]},{"id":"49e5d163f4be72be","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motivation_resend","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation_resend","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"resend","propertyType":"msg","value":"true","valueType":"bool"}],"x":130,"y":180,"wires":[["667a5bf7be337413"],[]]},{"id":"667a5bf7be337413","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motivation_resend off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_resend"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":180,"wires":[["2b3d45b8808003b1"]]},{"id":"2b3d45b8808003b1","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linkedClass: \"person\" } };\nmsg.output_name = \"persons\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":180,"wires":[["898149bca31f71c4"]]},{"id":"898149bca31f71c4","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":615,"y":180,"wires":[["d09a37be779f5695"]],"l":false},{"id":"d09a37be779f5695","type":"function","z":"a62a0ee8573c9b72","name":"resend trainings","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\nlet twd = two_week_day();\nlet persons = msg.persons;\nlet msgs = [];\n\nfor (let person of persons) {\n    if (\n        (person.sport?.active ?? false)\n        && activities[person.name] !== undefined\n        && person.sport.days_to_ojective !== undefined\n        && person.sport.objective_calendar !== undefined\n        && person.sport.objective_limits !== undefined\n    ) {\n        let person_activities_keys = Object.keys(activities[person.name]).filter(a => a != \"days\");\n        let activities_not_finished = [];\n\n        for (let activity of person_activities_keys) {\n            if (activities[person.name][activity][0] != activities[person.name][activity][1]) {\n                activities_not_finished.push({ activity: activity, number: (activities[person.name][activity][1] - activities[person.name][activity][0]) });\n            }\n        }\n\n        let person_day = activities[person.name][\"days\"] - 1 < 0 ? 0 : activities[person.name][\"days\"] - 1;\n        let objective_calendar = person.sport.objective_calendar;\n        let objective_limits = person.sport.objective_limits;\n\n        for (var i = 0; i < activities_not_finished.length; i++) {\n            for (var j = 0; j < twd; j++) {\n                if (\n                    activities_not_finished[i][\"number\"] > 0\n                    && activities_not_finished[i][\"activity\"] in objective_calendar\n                    && objective_calendar[activities_not_finished[i][\"activity\"]][twd - j]\n                ) {\n                    activities_not_finished[i][\"number\"]--;\n                    let activity = activities_not_finished[i][\"activity\"];\n                    let translation = \"objective_translations\" in person.sport && activity in person.sport.objective_translations ? person.sport.objective_translations[activity] : activity;\n\n                    if (Array.isArray(objective_limits[activity])) {\n                        msgs.push(\n                            {\n                                objective: {\n                                    name: activity,\n                                    translations: translation,\n                                    todays_objective_limit: translation + \": \" + calculate_training(person, objective_limits[activity], person_day - j),\n                                    person: person.name\n                                }\n                            }\n                        );\n                    } else if (typeof objective_limits[activity] === \"object\") {\n                        let objective_limit = [];\n                        for (let keys of Object.keys(objective_limits[activity])) {\n                            let objectiveName = keys.charAt(0).toUpperCase() + keys.slice(1);\n                            objective_limit.push(objectiveName + \": \" + calculate_training(person, objective_limits[activity][keys], person_day - j));\n                        }\n                        objective_limit = objective_limit.join(\"\\n\");\n                        msgs.push(\n                            {\n                                objective: {\n                                    name: activity,\n                                    translations: translation,\n                                    todays_objective_limit: objective_limit,\n                                    person: person.name\n                                }\n                            }\n                        );\n                    }\n                }\n            }\n        }\n    }\n}\nreturn [msgs];\n\nfunction calculate_training(person, objective_limits, person_day) {\n    let objective = \"\";\n    if (isNaN(objective_limits[0]) && isNaN(objective_limits[1])) {\n        let min_g_split = objective_limits[0].trim().split(\" \");\n        let max_g_split = objective_limits[1].trim().split(\" \");\n        let percentage = person_day / person.sport.days_to_ojective;\n        objective = parseInt((max_g_split[0] - min_g_split[0]) * percentage + parseInt(min_g_split[0])) + \" \" + max_g_split[1];\n    } else {\n        let min_g = objective_limits[0];\n        let max_g = objective_limits[1];\n        let percentage = person_day / person.sport.days_to_ojective;\n        let serie_number = parseInt(5 + percentage * 3.99);\n        let repetition_number = parseInt(((max_g - min_g) * percentage + min_g) / serie_number);\n        let rest_number = parseInt(((max_g - min_g) * percentage + min_g) % serie_number);\n        objective = repetition_number + \" * \" + serie_number + (rest_number == 0 ? \"\" : \" + \" + rest_number % serie_number);\n    }\n    return objective;\n}\n\nfunction two_week_day() {\n    let date = new Date();\n    return Math.floor((date.getTime() - new Date(date.getFullYear() + \"-01-01\").getTime()) / (3600000 * 24)) % 14 + 1;\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":180,"wires":[["a14109dee33a3446"]]},{"id":"bb407002bae6b6ca","type":"link out","z":"a62a0ee8573c9b72","name":"link out 575","mode":"link","links":["0903a19a38bc4d0b"],"x":855,"y":120,"wires":[]},{"id":"a14109dee33a3446","type":"link out","z":"a62a0ee8573c9b72","name":"link out 576","mode":"link","links":["0903a19a38bc4d0b"],"x":855,"y":180,"wires":[]},{"id":"0903a19a38bc4d0b","type":"link in","z":"a62a0ee8573c9b72","name":"link in 525","links":["bb407002bae6b6ca","a14109dee33a3446"],"x":55,"y":240,"wires":[["ee180b383f6fc021"]]},{"id":"093c626512b920e3","type":"link in","z":"a62a0ee8573c9b72","name":"link in 531","links":["dd3edb6388f2cf92"],"x":55,"y":120,"wires":[["5fa2746a231a3329"]]},{"id":"28460c8a51f888b3","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linkedClass: \"person\" } };\nmsg.output_name = \"persons\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":480,"wires":[["c403906919704162"]]},{"id":"c403906919704162","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":495,"y":480,"wires":[["8f546715d338a376"]],"l":false},{"id":"c68f722f20b3c9e7","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linkedClass: \"person\" } };\nmsg.output_name = \"persons\";\nmsg.outputEmptyResults = false;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":560,"wires":[["5d14dd3a4924e657"]]},{"id":"5d14dd3a4924e657","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":475,"y":560,"wires":[["c437e0a422479e97"]],"l":false},{"id":"0b58061cac0414bc","type":"catch","z":"22b4130fe1f6a28b","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["5628c3b6e6e05cc2"]]},{"id":"8308b45e584b06f6","type":"subflow:ad3b29a5dd67898f","z":"22b4130fe1f6a28b","name":"","x":460,"y":40,"wires":[]},{"id":"5628c3b6e6e05cc2","type":"change","z":"22b4130fe1f6a28b","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Github","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8308b45e584b06f6"]]},{"id":"8b90ccdbc66dac03","type":"function","z":"22b4130fe1f6a28b","name":"get node-red addon","func":"let nodeRed = global.get('homeassistant').homeAssistant.states[\"update.node_red_update\"];\n\nif (nodeRed.attributes?.entity_picture) {\n    msg.addon = nodeRed.attributes.entity_picture.replace(\"/api/hassio/addons/\", \"\").replace(\"/icon\", \"\");\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":480,"wires":[["4392c27b07392a2e","a0f5e36615e385c8"]]},{"id":"19c67d2aca8dacf4","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":590,"y":300,"wires":[["a84852adfbcf0f82"],[],[]]},{"id":"a84852adfbcf0f82","type":"switch","z":"22b4130fe1f6a28b","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":720,"y":300,"wires":[["6b594e58c4deee27"]]},{"id":"6b594e58c4deee27","type":"link out","z":"22b4130fe1f6a28b","name":"link out 428","mode":"link","links":["1a58fc318d2a551d"],"x":815,"y":300,"wires":[]},{"id":"c1d14ac0a4c78950","type":"template","z":"22b4130fe1f6a28b","name":"git pull","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cd /\ncd homeassistant\ngit reset --hard HEAD\ngit pull -f https://github.com/lemuriens/combava.git","output":"str","x":470,"y":300,"wires":[["19c67d2aca8dacf4"]]},{"id":"af0c165af5996110","type":"link out","z":"22b4130fe1f6a28b","name":"link out 429","mode":"link","links":["e53334a6f05a9609"],"x":1015,"y":180,"wires":[]},{"id":"298b1c45c4d0b500","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"new_update_available\";\nmsg.title = \"Mise Ã  jour disponible ðŸŽ‰\";\nmsg.alertType = \"success\";\nmsg.message = \"Des nouveautÃ©s sont disponibles pour votre maison connectÃ©e ðŸŽ‰\";\nmsg.data = { actions: [{ \"action\": \"do_update\", \"title\": \"Mettre Ã  jour\" }] };\nmsg.sendMobile = true;\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":180,"wires":[["af0c165af5996110"]]},{"id":"aab0f034678b38fc","type":"comment","z":"22b4130fe1f6a28b","name":"Github PULL","info":"","x":110,"y":120,"wires":[]},{"id":"110190f367ccfb85","type":"link in","z":"22b4130fe1f6a28b","name":"link in 436","links":["e0c8cc5539007c7d"],"x":55,"y":480,"wires":[["8b90ccdbc66dac03"]]},{"id":"3f58fc642c3feedb","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"new_update_available\";\nmsg.dismiss = true;\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":240,"wires":[["9a6820da31f5f8c4"]]},{"id":"9a6820da31f5f8c4","type":"link out","z":"22b4130fe1f6a28b","name":"link out 431","mode":"link","links":["e53334a6f05a9609"],"x":935,"y":240,"wires":[]},{"id":"2b3edb3f3845716f","type":"link out","z":"22b4130fe1f6a28b","name":"link out 432","mode":"link","links":["d6e719e8cc85424f"],"x":985,"y":240,"wires":[]},{"id":"d6e719e8cc85424f","type":"link in","z":"22b4130fe1f6a28b","name":"link in 437","links":["2b3edb3f3845716f"],"x":55,"y":300,"wires":[["9d4c4b04edf80d7d"]]},{"id":"88ce8957d8839f95","type":"subflow:515fe2385f553c95","z":"22b4130fe1f6a28b","name":"","x":330,"y":300,"wires":[[],["c1d14ac0a4c78950"]]},{"id":"d83697681a841be5","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"module_update\";\n\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module mises Ã  jour automatique dÃ©sactivÃ©\";\n    msg.message = \"Module mises Ã  jour automatique dÃ©sactivÃ©, vous recevrez une notification lorsqu'une mise Ã  jour est disponible.\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":600,"wires":[["4d571b7c3108dd2f"]]},{"id":"4d571b7c3108dd2f","type":"link out","z":"22b4130fe1f6a28b","name":"link out 519","mode":"link","links":["e53334a6f05a9609"],"x":395,"y":600,"wires":[]},{"id":"4cc115cfe408499c","type":"link out","z":"22b4130fe1f6a28b","name":"link out 520","mode":"link","links":["f653e56d38a91ee4"],"x":595,"y":180,"wires":[]},{"id":"b130a4ed6345f4d5","type":"link in","z":"22b4130fe1f6a28b","name":"update available on","links":[],"x":55,"y":540,"wires":[["e34e640e14f1f461"]]},{"id":"cf2657d204eb2c9f","type":"link out","z":"22b4130fe1f6a28b","name":"update available on","mode":"return","links":[],"x":515,"y":540,"wires":[]},{"id":"19c209fee8b092e0","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["b130a4ed6345f4d5"],"linkType":"static","timeout":"30","x":730,"y":180,"wires":[["298b1c45c4d0b500"]]},{"id":"1b50b093ec877908","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["b130a4ed6345f4d5"],"linkType":"static","timeout":"30","x":470,"y":180,"wires":[["4cc115cfe408499c"]]},{"id":"f653e56d38a91ee4","type":"link in","z":"22b4130fe1f6a28b","name":"link in 479","links":["4cc115cfe408499c"],"x":535,"y":240,"wires":[["73e582bba532abcd"]]},{"id":"1f7e465a76157a74","type":"switch","z":"22b4130fe1f6a28b","name":"do_update","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"do_update","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":430,"y":240,"wires":[["73e582bba532abcd"]]},{"id":"b34dbefb140bec6d","type":"inject","z":"22b4130fe1f6a28b","name":"","props":[{"p":"currentTime","v":"","vt":"date"}],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","x":120,"y":1020,"wires":[["b9105ce2a97f6bc2"]]},{"id":"a26113ff363a254e","type":"function","z":"22b4130fe1f6a28b","name":"first of month ?","func":"let d = new Date();\n\nif (d.getDate() == 1) {\n    let year = d.getFullYear();\n    let month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1);\n    let day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n    let hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\n    let minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n\n    msg.backup_name = \"AutoBackup \" + year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute;\n    return msg;\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":1020,"wires":[["430dd7d2e9b8d646"]]},{"id":"b9105ce2a97f6bc2","type":"subflow:515fe2385f553c95","z":"22b4130fe1f6a28b","name":"","x":270,"y":1020,"wires":[[],["a26113ff363a254e"]]},{"id":"63706c58ab1c4858","type":"comment","z":"22b4130fe1f6a28b","name":"Every month backup","info":"","x":130,"y":960,"wires":[]},{"id":"1a58fc318d2a551d","type":"link in","z":"22b4130fe1f6a28b","name":"link in 500","links":["6b594e58c4deee27"],"x":55,"y":360,"wires":[["83a24499de6edc53"]]},{"id":"b3d42b3a9f249920","type":"link out","z":"22b4130fe1f6a28b","name":"link out 554","mode":"link","links":["69034fa0ae21d5d1"],"x":755,"y":360,"wires":[]},{"id":"0d8ee2b7521ee713","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":350,"y":360,"wires":[["d198505431c980d7"],[],[]]},{"id":"83a24499de6edc53","type":"template","z":"22b4130fe1f6a28b","name":"check update folder","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cd /\ncd /homeassistant/node-red\nls","output":"str","x":190,"y":360,"wires":[["0d8ee2b7521ee713"]]},{"id":"704f7ca1331ab597","type":"function","z":"22b4130fe1f6a28b","name":"update exist ?","func":"if (msg.payload.includes(\"flows.json\")) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":360,"wires":[["b3d42b3a9f249920"],["f749f8e851513de0"]]},{"id":"d198505431c980d7","type":"switch","z":"22b4130fe1f6a28b","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":480,"y":360,"wires":[["704f7ca1331ab597"]]},{"id":"69034fa0ae21d5d1","type":"link in","z":"22b4130fe1f6a28b","name":"link in 501","links":["b3d42b3a9f249920"],"x":55,"y":420,"wires":[["d57ca309aac1ee9e"]]},{"id":"e0c8cc5539007c7d","type":"link out","z":"22b4130fe1f6a28b","name":"link out 555","mode":"link","links":["110190f367ccfb85"],"x":775,"y":420,"wires":[]},{"id":"e6a391cf060c277e","type":"template","z":"22b4130fe1f6a28b","name":"replace flows.json","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"mv -f /homeassistant/node-red/flows.json /config","output":"str","x":390,"y":420,"wires":[["ce832bbaa561ea36"]]},{"id":"ce832bbaa561ea36","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":550,"y":420,"wires":[["b109e4562df83a83"],[],[]]},{"id":"b109e4562df83a83","type":"switch","z":"22b4130fe1f6a28b","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":680,"y":420,"wires":[["e0c8cc5539007c7d"]]},{"id":"4a451e77abd1b596","type":"link in","z":"22b4130fe1f6a28b","name":"link in 502","links":["f749f8e851513de0"],"x":495,"y":480,"wires":[["a0f5e36615e385c8"]]},{"id":"f749f8e851513de0","type":"link out","z":"22b4130fe1f6a28b","name":"link out 556","mode":"link","links":["4a451e77abd1b596"],"x":755,"y":360,"wires":[]},{"id":"e7b4857a10952d79","type":"comment","z":"22b4130fe1f6a28b","name":"Move flow.json when updated","info":"","x":160,"y":680,"wires":[]},{"id":"3ae5c3a13f5faa40","type":"watch","z":"22b4130fe1f6a28b","name":"watch","files":"/config/flows.json","recursive":"","x":90,"y":740,"wires":[["4eb7ed3ed304827e"]]},{"id":"031b2ea614cb2c86","type":"template","z":"22b4130fe1f6a28b","name":"move flows.json","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cp /config/flows.json /homeassistant/node-red/flows.json","output":"str","x":400,"y":740,"wires":[["afd44074e6c431e0"]]},{"id":"afd44074e6c431e0","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":550,"y":740,"wires":[[],[],[]]},{"id":"4eb7ed3ed304827e","type":"subflow:515fe2385f553c95","z":"22b4130fe1f6a28b","name":"","x":230,"y":740,"wires":[["031b2ea614cb2c86"],[]]},{"id":"d57ca309aac1ee9e","type":"function","z":"22b4130fe1f6a28b","name":"get node-red addon","func":"let nodeRed = global.get('homeassistant').homeAssistant.states[\"update.node_red_update\"];\n\nif (nodeRed.attributes?.entity_picture) {\n    msg.addon = nodeRed.attributes.entity_picture.replace(\"/api/hassio/addons/\", \"\").replace(\"/icon\", \"\");\n    return msg;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":420,"wires":[["e6a391cf060c277e"]]},{"id":"df4af56f9ed72f66","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update available on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":390,"y":540,"wires":[["cf2657d204eb2c9f"]]},{"id":"4392c27b07392a2e","type":"api-call-service","z":"22b4130fe1f6a28b","name":"restart node-red","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"hassio","service":"addon_restart","areaId":[],"deviceId":[],"entityId":[],"data":"{\"addon\":\"{{addon}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":480,"wires":[[]]},{"id":"73e582bba532abcd","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update validated","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":660,"y":240,"wires":[["3f58fc642c3feedb","2b3edb3f3845716f"]]},{"id":"e34e640e14f1f461","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update validated off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":190,"y":540,"wires":[["df4af56f9ed72f66"]]},{"id":"a0f5e36615e385c8","type":"api-call-service","z":"22b4130fe1f6a28b","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"homeassistant","service":"restart","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":640,"y":480,"wires":[[]]},{"id":"430dd7d2e9b8d646","type":"api-call-service","z":"22b4130fe1f6a28b","name":"launch backup","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"hassio","service":"backup_full","areaId":[],"deviceId":[],"entityId":[],"data":"{\"name\": \"{{backup_name}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":620,"y":1020,"wires":[[]]},{"id":"6bca473d1c40e349","type":"api-current-state","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":280,"y":180,"wires":[["1b50b093ec877908"],["dc40d6ce64930b70"]]},{"id":"7c15527fc574823e","type":"server-events","z":"22b4130fe1f6a28b","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":270,"y":240,"wires":[["1f7e465a76157a74"]]},{"id":"3a335bfb2e72f42a","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"github update","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.lemuriens_coconut_latest_commit","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":180,"wires":[["6bca473d1c40e349"]]},{"id":"72a35a1065bd206c","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_update","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":600,"wires":[["d83697681a841be5"]]},{"id":"6b895c552ae1c9ed","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"make update","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.update_from_lemuriens_coconut","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":240,"wires":[["bcb6e13c9c4fbcd1"],[]]},{"id":"7019fa2e19c3b733","type":"comment","z":"22b4130fe1f6a28b","name":"Auto update","info":"","x":110,"y":820,"wires":[]},{"id":"68da9f17106d4fef","type":"inject","z":"22b4130fe1f6a28b","name":"2:00 (10 min) 3:00","props":[],"repeat":"","crontab":"*/10 2 * * *","once":false,"onceDelay":0.1,"topic":"","x":150,"y":880,"wires":[["e3f6652ef7cd2a19"]]},{"id":"b434c2983041d3e6","type":"function","z":"22b4130fe1f6a28b","name":"update >","func":"msg.search = { \"is\": { state: \"on\", in_progress: false, skipped_version: null } };\nmsg.output_name = \"entities\";\nmsg.outputEmptyResults = false;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":880,"wires":[["484f714d351fd5c8"]]},{"id":"484f714d351fd5c8","type":"subflow:3da7ebfd83a38899","z":"22b4130fe1f6a28b","name":"","x":595,"y":880,"wires":[["eb748c191e521571"]],"l":false},{"id":"865416a5e6388c78","type":"function","z":"22b4130fe1f6a28b","name":"set update","func":"if (msg.entities.length != 0) {\n    msg = { entity_id: msg.entities[0].entity_id };\n    return [msg, null];\n} else {\n    msg.search = {\n        \"is\":\n        {\n            state: \"off\", in_progress: false,\n            skipped_version: null,\n            release_summary: \"<ha-alert alert-type='error'>Restart of Home Assistant required</ha-alert>\"\n        }\n    };\n    msg.output_name = \"entities\";\n    msg.outputEmptyResults = false;\n    return [null, msg];\n}\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":880,"wires":[["e38e53bbeddd11dc"],["de709106b8d2cfce"]]},{"id":"e38e53bbeddd11dc","type":"api-call-service","z":"22b4130fe1f6a28b","name":"install update","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"update","service":"install","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1030,"y":880,"wires":[[]]},{"id":"e3f6652ef7cd2a19","type":"api-current-state","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":340,"y":880,"wires":[["b434c2983041d3e6"],[]]},{"id":"04a21079abd782c3","type":"subflow:3da7ebfd83a38899","z":"22b4130fe1f6a28b","name":"","x":1135,"y":880,"wires":[["6b39adf0f119c05c"]],"l":false},{"id":"6b39adf0f119c05c","type":"api-call-service","z":"22b4130fe1f6a28b","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"homeassistant","service":"restart","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1280,"y":880,"wires":[[]]},{"id":"9d4c4b04edf80d7d","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["39372af8f404c7d2"],"linkType":"static","timeout":"30","x":170,"y":300,"wires":[["88ce8957d8839f95"]]},{"id":"eb748c191e521571","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["39372af8f404c7d2"],"linkType":"static","timeout":"30","x":710,"y":880,"wires":[["865416a5e6388c78"]]}]