[{"id":"27148b7bb9f62ac7","type":"tab","label":"Core ‚úÖ","disabled":false,"info":"","env":[]},{"id":"b0a488ea822145cf","type":"tab","label":"Inputs ‚úÖ","disabled":false,"info":"","env":[]},{"id":"37a14665cffc94c1","type":"tab","label":"Presence ‚úÖ","disabled":false,"info":"","env":[]},{"id":"ccf1abe540a3b5a9","type":"tab","label":"Light ‚úÖ","disabled":false,"info":"","env":[]},{"id":"a1ed8ea56c7ba1f9","type":"tab","label":"Climate ‚úÖ","disabled":false,"info":"","env":[]},{"id":"ba6d40c8a95e6048","type":"tab","label":"Devices ‚úÖ","disabled":false,"info":"","env":[]},{"id":"6838183963219fc9","type":"tab","label":"Heater ‚úÖ","disabled":false,"info":"","env":[]},{"id":"4a22965fdf64b558","type":"tab","label":"Hot Water ü§ß","disabled":true,"info":"","env":[]},{"id":"bc6acc159ab232c6","type":"tab","label":"Ventilation ü§ß","disabled":true,"info":"","env":[]},{"id":"eaa696a731a52b23","type":"tab","label":"Alarm ‚úÖ","disabled":false,"info":"","env":[]},{"id":"ab914a2a493ebbf5","type":"tab","label":"Cover ‚úÖ","disabled":false,"info":"","env":[]},{"id":"a62a0ee8573c9b72","type":"tab","label":"Sport ‚úÖ","disabled":false,"info":""},{"id":"22b4130fe1f6a28b","type":"tab","label":"Updates ‚úÖ","disabled":false,"info":"","env":[]},{"id":"d193bde43bd55f9f","type":"subflow","name":"send remote command","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"c5ccf59387c5ac3b"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"386f1888bc94b4c8","type":"subflow","name":"motivation","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"c4c0894d444403e2"}]}],"out":[{"x":420,"y":60,"wires":[{"id":"4c9393d44c603ea8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"5a05b9ac0289ff03","type":"subflow","name":"area light notif","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"c449dcd2f1efdb91"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"linked_lights = [obj,obj]"},{"name":"2*","type":"str","value":"effects = { count: 0, color: 0-360, saturation: 0-100, time: ms }"}],"meta":{},"color":"#DDAA99"},{"id":"e6ac576fb4598283","type":"subflow","name":"presence ?","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"659ed9ee25a47490"}]}],"out":[{"x":340,"y":40,"wires":[{"id":"659ed9ee25a47490","port":0}]},{"x":340,"y":120,"wires":[{"id":"659ed9ee25a47490","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ba09e97f2ed22f2b","type":"subflow","name":"notif üì±","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"ffcfbc338ee42cc0"}]}],"out":[],"env":[{"name":"1","type":"str","value":"title"},{"name":"2","type":"str","value":"message"},{"name":"3","type":"str","value":"data"},{"name":"4","type":"str","value":"send_mobile"},{"name":"5","type":"str","value":"clear_on_phone"}],"meta":{},"color":"#DDAA99"},{"id":"dbf17bea6affd2ec","type":"subflow","name":"notif üè†","category":"","in":[{"x":60,"y":60,"wires":[{"id":"5ab0339e525685e3"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"speak = \"XX\" || sound = \"XX\" || link = \"XX\""},{"name":"2","type":"str","value":"linked_area = \"XX\""},{"name":"3","type":"str","value":"volume_level = 0-1"},{"name":"4","type":"str","value":"effects = { count: 0, color: 0 - 360, time: ms }"}],"meta":{},"color":"#DDAA99"},{"id":"723d4991c3c87385","type":"subflow","name":"call service","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"955123ec73074cbf"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"entity_id (string)"},{"name":"2*","type":"str","value":"state (string, number)"}],"meta":{},"color":"#DDAA99"},{"id":"ad3b29a5dd67898f","type":"subflow","name":"send bug to dashboard","info":"","category":"","in":[{"x":60,"y":40,"wires":[{"id":"fcdc38c73bb08769"}]}],"out":[{"x":520,"y":100,"wires":[{"id":"6280166330ae9f71","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"6c4028aab794d52d","type":"subflow","name":"notification","info":"","category":"","in":[{"x":40,"y":60,"wires":[{"id":"f466fcd4c433d4e3"}]}],"out":[{"x":680,"y":380,"wires":[{"id":"77a3983c5e6305d8","port":0},{"id":"cc379f05a4f6474a","port":0}]}],"env":[{"name":"1*","type":"str","value":"notification_id (string)"},{"name":"2","type":"str","value":"title (string)"},{"name":"3","type":"str","value":"message (string)"},{"name":"4","type":"str","value":"alert_type (string)"},{"name":"5","type":"str","value":"send_mobile (boolean)"},{"name":"6","type":"str","value":"clear_on_phone (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"515fe2385f553c95","type":"subflow","name":"dev enable","info":"","category":"","in":[{"x":80,"y":80,"wires":[{"id":"68969b8280827750"}]}],"out":[{"x":320,"y":40,"wires":[{"id":"68969b8280827750","port":0}]},{"x":320,"y":120,"wires":[{"id":"68969b8280827750","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"94b2243985840d69","type":"subflow","name":"config loaded","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"febc11290421c3af"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"20c20fc427292f9a","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"3da7ebfd83a38899","type":"subflow","name":"get entities","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"466e65d315aca28f"}]}],"out":[{"x":300,"y":60,"wires":[{"id":"466e65d315aca28f","port":0}]}],"env":[{"name":"1*","type":"str","value":"msg.search = { \"is\": { linked_class: \"\" }, \"not\": { linked_area: \"\" }}"},{"name":"2*","type":"str","value":"msg.output_name (string)"},{"name":"3","type":"str","value":"msg.output_empty_results (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"dc40d6ce64930b70","type":"junction","z":"22b4130fe1f6a28b","x":380,"y":180,"wires":[["19c209fee8b092e0"]]},{"id":"bcb6e13c9c4fbcd1","type":"junction","z":"22b4130fe1f6a28b","x":200,"y":240,"wires":[["73e582bba532abcd"]]},{"id":"c18b36325001bf4a","type":"junction","z":"b0a488ea822145cf","x":580,"y":980,"wires":[["a54be99d7e32ea7c"]]},{"id":"e70a19df90211863","type":"junction","z":"b0a488ea822145cf","x":680,"y":1820,"wires":[["09937216bea66806"]]},{"id":"8356eb9f76953cee","type":"junction","z":"a62a0ee8573c9b72","x":800,"y":120,"wires":[["bb407002bae6b6ca"]]},{"id":"de709106b8d2cfce","type":"junction","z":"22b4130fe1f6a28b","x":260,"y":940,"wires":[["04a21079abd782c3"]]},{"id":"d38f23be4a30a1a5","type":"junction","z":"a62a0ee8573c9b72","x":220,"y":420,"wires":[["9a89420de8a81170"]]},{"id":"6acff092435169c4","type":"junction","z":"723d4991c3c87385","x":260,"y":60,"wires":[["dfbaefd1c674da97"]]},{"id":"a457c8d35dfc8615","type":"junction","z":"ccf1abe540a3b5a9","x":460,"y":440,"wires":[["b624e6e0f61ddfc0"]]},{"id":"77a3983c5e6305d8","type":"junction","z":"6c4028aab794d52d","x":460,"y":380,"wires":[[]]},{"id":"5b871c278cf602d0","type":"junction","z":"6838183963219fc9","x":280,"y":300,"wires":[["e98fd77afdd9134f"]]},{"id":"3f3fa09655239c17","type":"junction","z":"4a22965fdf64b558","x":220,"y":240,"wires":[["85453006e9fb8796"]]},{"id":"9f98ec66303a47f0","type":"junction","z":"ab914a2a493ebbf5","x":200,"y":760,"wires":[["eff62c7c6f3e9b57"]]},{"id":"32ac3965c280620d","type":"junction","z":"ab914a2a493ebbf5","x":200,"y":760,"wires":[["eff62c7c6f3e9b57"]]},{"id":"b7254c5cdf10e155","type":"junction","z":"ab914a2a493ebbf5","x":260,"y":300,"wires":[["c838dde3b4d97086"]]},{"id":"29b05ce92e274023","type":"junction","z":"ab914a2a493ebbf5","x":260,"y":300,"wires":[["28562681c5f0cf42"]]},{"id":"404f3882f4ffcce7","type":"junction","z":"a62a0ee8573c9b72","x":720,"y":360,"wires":[["c188d79531761c3c"]]},{"id":"d35d94441c13c6dc","type":"junction","z":"b0a488ea822145cf","x":400,"y":1100,"wires":[["21590737a96aa2f3"]]},{"id":"14758b74ee13a9ea","type":"junction","z":"b0a488ea822145cf","x":740,"y":1100,"wires":[["9449d331aa43d268"]]},{"id":"587f7fe3de1203b2","type":"junction","z":"b0a488ea822145cf","x":1100,"y":1160,"wires":[["20befc698c560a64"]]},{"id":"394cf63f5b976696","type":"junction","z":"ccf1abe540a3b5a9","x":270,"y":780,"wires":[["b4048a698ac0d24f","6f4615f52cc54556"]]},{"id":"0341de3f831e32be","type":"junction","z":"27148b7bb9f62ac7","x":980,"y":960,"wires":[["7468b2358756c25c"]]},{"id":"3092248b88bfbde5","type":"junction","z":"ccf1abe540a3b5a9","x":140,"y":900,"wires":[["86c4e98b8f788cbf"]]},{"id":"ece3d6c1b9192908","type":"junction","z":"b0a488ea822145cf","x":380,"y":2420,"wires":[["b90ed62f72230b1c"]]},{"id":"93a1508434b13074","type":"junction","z":"5a05b9ac0289ff03","x":620,"y":60,"wires":[["449ca05bf192210e"]]},{"id":"c2f812d9f6cd1957","type":"junction","z":"ccf1abe540a3b5a9","x":200,"y":1040,"wires":[["e07dfbb649df45af"]]},{"id":"5f8b5f746a80ca8c","type":"junction","z":"ccf1abe540a3b5a9","x":260,"y":500,"wires":[["587a2f970b774dec"]]},{"id":"dbe29802804cc6ab","type":"junction","z":"6838183963219fc9","x":280,"y":300,"wires":[["7e1da589e09923e8"]]},{"id":"bb48fff78bfac166","type":"junction","z":"37a14665cffc94c1","x":340,"y":580,"wires":[["016f3ff0be777998"]]},{"id":"c90b6bf0196b9043","type":"junction","z":"6838183963219fc9","x":280,"y":620,"wires":[["41f642fb8e8c5b67"]]},{"id":"c46314750c9075fb","type":"junction","z":"6838183963219fc9","x":340,"y":680,"wires":[["5c035d30aa0eeaa4"]]},{"id":"7c46b5660c01712e","type":"junction","z":"37a14665cffc94c1","x":440,"y":760,"wires":[["d7dbe243d1afa5ca"]]},{"id":"f621e9781f3b4957","type":"junction","z":"6838183963219fc9","x":240,"y":420,"wires":[["8a955201a68a4d84"]]},{"id":"17512c25a893783c","type":"junction","z":"37a14665cffc94c1","x":840,"y":580,"wires":[["4978fc1834ea0fd3"]]},{"id":"9ee9a07ceec67343","type":"junction","z":"37a14665cffc94c1","x":440,"y":320,"wires":[["8ec249191d96f387","60d635f1979bc939"]]},{"id":"f48d59c829ba1bfc","type":"junction","z":"37a14665cffc94c1","x":640,"y":700,"wires":[["1bcbd7b988d4ece3"]]},{"id":"a59613d3b7a13d66","type":"junction","z":"ba6d40c8a95e6048","x":660,"y":260,"wires":[["8633757000801880"]]},{"id":"cbe20c8080b9105c","type":"junction","z":"eaa696a731a52b23","x":320,"y":120,"wires":[["2efc0195703e6e74"]]},{"id":"c87720f17866318d","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":": ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"c5ccf59387c5ac3b","type":"function","z":"d193bde43bd55f9f","name":"prepare remote","func":"let linked_device = msg.linked_device\nlet entity_id = msg.entity_id\nlet new_state = msg.new_state\nlet old_state = msg.old_state\nlet remote = msg.remote\nlet msgs = []\n\nif (remote[\"increase\"] !== undefined && remote[\"decrease\"] !== undefined) {\n    let diff = new_state - old_state\n    set_msgs({ \"num_repeats\": Math.abs(diff), \"command\": (diff < 0 ? remote[\"decrease\"] : remote[\"increase\"]) })\n    return [msgs]\n} else if (remote[new_state] !== undefined) {\n    set_msgs(remote[new_state])\n    return [msgs]\n}\n\nfunction set_msgs(remote) {\n    if (remote.commands !== undefined && Array.isArray(remote.commands)) {\n        let count = 0\n        for (let c of remote.commands) {\n            msgs.push({\n                payload: { data: { entity_id: linked_device, command: c, num_repeats: remote.num_repeats ?? 1, delay_secs: remote.delay_secs ?? 0 } },\n                delay: (remote.delay_between_commands ?? 0) * count * 1000\n            })\n            count++\n        }\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[["ae0bd8894433c5a0"]]},{"id":"7668c6d3666d5662","type":"api-call-service","z":"d193bde43bd55f9f","name":"send command to remote","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"remote","service":"send_command","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":530,"y":60,"wires":[[]]},{"id":"ae0bd8894433c5a0","type":"delay","z":"d193bde43bd55f9f","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":true,"outputs":1,"x":340,"y":60,"wires":[["7668c6d3666d5662"]]},{"id":"4c9393d44c603ea8","type":"function","z":"386f1888bc94b4c8","name":"motivation","func":"switch (msg.payload) {\n  case 1:\n    msg.payload = \"Personne n‚Äôest trop vieux pour se fixer un nouvel objectif ou r√©aliser de nouveaux r√™ves. ‚Äì Les Brown\"\n    break\n  case 2:\n    msg.payload = \"La seule fa√ßon de faire du bon travail est d‚Äôaimer ce que vous faites. Si vous n‚Äôavez pas encore trouv√©, continuez √† chercher. - Steve Jobs\"\n    break\n  case 3:\n    msg.payload = \"Pour r√©ussir, votre d√©sir de r√©ussite doit √™tre plus grand que votre peur de l‚Äô√©chec. - Bill Cosby\"\n    break\n  case 4:\n    msg.payload = \"Un √©norme succ√®s est la meilleure des vengeances. - Frank Sinatra\"\n    break\n  case 5:\n    msg.payload = \"Je suis reconnaissant √† tous ceux qui m‚Äôont dit NON. C‚Äôest √† gr√¢ce √† eux que je suis moi-m√™me. - Albert Einstein\"\n    break\n  case 6:\n    msg.payload = \"La seule chose qui se dresse entre vous et votre r√™ve, c‚Äôest la volont√© d‚Äôessayer et la conviction qu‚Äôil est r√©ellement possible. - Joel Brown\"\n    break\n  case 7:\n    msg.payload = \"Un pessimiste voit la difficult√© dans chaque opportunit√©, un optimiste voit l‚Äôopportunit√© dans chaque difficult√©. - Winston Churchill\"\n    break\n  case 8:\n    msg.payload = \"Le succ√®s c‚Äôest d‚Äôaller d‚Äô√©chec en √©chec sans perdre son enthousiasme. - Winston Churchill\"\n    break\n  case 9:\n    msg.payload = \"Le succ√®s n‚Äôest pas la cl√© du bonheur. Le bonheur est la cl√© du succ√®s. Si vous aimez ce que vous faites, vous r√©ussirez. - Albert Schweitzer\"\n    break\n  case 10:\n    msg.payload = \"Les gagnants trouvent des moyens, les perdants des excuses. -  F. D. Roosevelt\"\n    break\n  case 11:\n    msg.payload = \"Celui qui attend que tout danger soir √©cart√© pour mettre les voiles ne prendra jamais la mer. - Thomas Fuller\"\n    break\n  case 12:\n    msg.payload = \"Ce n‚Äôest pas parce que les choses sont difficiles que nous n‚Äôosons pas, c‚Äôest parce que nous n‚Äôosons pas qu‚Äôelles sont difficiles. -  S√©n√®que\"\n    break\n  case 13:\n    msg.payload = \"Certains veulent que √ßa arrive, d‚Äôautres aimeraient que √ßa arrive et d‚Äôautres font que √ßa arrive. - Michael Jordan\"\n    break\n  case 14:\n    msg.payload = \"La plus grande erreur que puisse faire un homme est d‚Äôavoir peur d‚Äôen faire une. - Elbert Hubbard\"\n    break\n  case 15:\n    msg.payload = \"Le g√©nie est fait d‚Äôun pour cent d‚Äôinspiration et de quatre-vingt-dix-neuf pour cent de transpiration. - Thomas Edison\"\n    break\n  case 16:\n    msg.payload = \"Ce n‚Äôest pas le vent qui d√å cide de votre destination, c‚Äôest l‚Äôorientation que vous donnez √† votre voile. Le vent est pareil pour tous. - Jim Rohn\"\n    break\n  case 17:\n    msg.payload = \"L‚Äôhumanit√© se divise en trois cat√©gories : ceux qui ne peuvent pas bouger, ceux qui peuvent bouger, et ceux qui bougent. - Benjamin Franklin\"\n    break\n  case 18:\n    msg.payload = \"Dans vingt ans vous serez plus d√©√ßus par les choses que vous n‚Äôavez pas faites que par celles que vous avez faites. Alors sortez des sentiers battus. Mettez les voiles. Explorez. R√™vez. D√©couvrez. - Mark Twain\"\n    break\n  case 19:\n    msg.payload = \"Il n‚Äôy a pas de r√©ussites faciles ni d‚Äô√©checs d√©finitifs. - Marcel Proust\"\n    break\n  case 20:\n    msg.payload = \"J‚Äôai d√©cid√© d‚Äô√™tre heureux parce que c‚Äôest bon pour la sant√©. - Voltaire\"\n    break\n  case 21:\n    msg.payload = \"Celui qui veut atteindre un objectif lointain doit faire de petits pas. - Saul Bellow\"\n    break\n  case 22:\n    msg.payload = \"La plupart des choses importantes dans le monde ont √©t√© accomplies par des personnes qui ont continu√© √† essayer quand il semblait y avoir aucun espoir. - Dale Carnegie\"\n    break\n  case 23:\n    msg.payload = \"Pour r√©ussir, retenez bien ces trois maximes: voir c‚Äôest savoir, vouloir c‚Äôest pouvoir, oser c‚Äôest avoir. - Alfred de Musset\"\n    break\n  case 24:\n    msg.payload = \"Les chanceux sont ceux qui arrivent √† tout  Les malchanceux, ceux √† qui tout arrive. - Eug√®ne Labiche\"\n    break\n  case 25:\n    msg.payload = \"Pour ce qui est de l‚Äôavenir, il ne s‚Äôagit pas de le pr√©voir, mais de le rendre possible. - Antoine de Saint-Exup√©ry\"\n    break\n  case 26:\n\tmsg.payload = \"Il faut viser la lune, parce qu‚Äôau moins, si vous √©chouez, vous finirez dans les √©toiles. - Oscar Wilde\"\n\tbreak\n  case 27:\n\tmsg.payload = \"La meilleure fa√ßon de pr√©dire l‚Äôavenir est de le cr√©er. - Peter Drucker\"\n\tbreak\n  case 28:\n\tmsg.payload = \"Le d√©sir de bien faire est un puissant moteur. Celui de faire du bien est plus puissant encore. - Michael Aguilar\"\n\tbreak\n  case 29:\n\tmsg.payload = \"Croyez en vos r√™ves et ils se r√©aliseront peut-√™tre. Croyez en vous et ils se r√©aliseront s√ªrement. - Martin Luther King\"\n\tbreak\n  case 30:\n\tmsg.payload = \"Vous ne trouverez jamais ce que vous ne cherchez pas. - Confucius\"\n\tbreak\n  case 31:\n\tmsg.payload = \"Si vous pensez que vous ne valez pas grand-chose, vous ne trouverez personne pour augmenter votre prix. - Michael Aguilar\"\n\tbreak\n  case 32:\n\tmsg.payload = \"La sagesse supr√™me, c‚Äôest d‚Äôavoir des r√™ves assez grands pour ne pas les perdre de vue pendant qu‚Äôon les poursuit. - Francis Scott Fitzgerald\"\n\tbreak\n  case 33:\n\tmsg.payload = \"Si vous pouvez le r√™ver, vous pouvez le faire. - Walt Disney\"\n\tbreak\n  case 34:\n\tmsg.payload = \"Notre vie vaut ce qu‚Äôelle nous a co√ªt√© d‚Äôefforts. - Fran√ßois Mauriac\"\n\tbreak\n  case 35:\n\tmsg.payload = \"Ce sont nos choix qui montrent qui nous sommes, bien  plus que nos capacit√©s. - Joanne K.Rowling\"\n\tbreak\n  case 36:\n\tmsg.payload = \"On peut tout ce qui ne d√©pende que de notre volont√©. - Marcel Proust\"\n\tbreak\n  case 37:\n\tmsg.payload = \"Le but de la vie, ce n‚Äôest pas l‚Äôespoir de devenir parfait, c‚Äôest la volont√© d‚Äô√™tre toujours meilleur. - Ralph Waldo Emerson\"\n\tbreak\n  case 38:\n\tmsg.payload = \"La pers√©v√©rance, c‚Äôest ce qui rend l‚Äôimpossible possible, le possible probable et le probable r√©alis√å . - L√©on Trotsky\"\n\tbreak\n  case 39:\n\tmsg.payload = \"Il n‚Äôy a qu‚Äôune fa√ßon d‚Äô√©chouer, c‚Äôest d‚Äôabandonner avant d‚Äôavoir r√©ussi. - Georges Cl√©menceau\"\n\tbreak\n  case 40:\n\tmsg.payload = \"Rien de grand ne s‚Äôest accompli sans passion. - Hegel\"\n\tbreak\n  case 41:\n\tmsg.payload = \"Ne craignez pas la perfection, vous n‚Äôy parviendrez jamais. - Salvador Dali\"\n\tbreak\n  case 42:\n\tmsg.payload = \"Il vaut mieux exceller dans une seule discipline plut√¥t que d‚Äô√™tre m√©diocre dans plusieurs. - Proverbe latin\"\n\tbreak\n  case 43:\n\tmsg.payload = \"En suivant le chemin qui s‚Äôappelle plus tard, nous arrivons sur la place qui s‚Äôappelle jamais. - S√©n√∑  que\"\n\tbreak\n  case 44:\n\tmsg.payload = \"La vie est comme une bicyclette, il faut avancer pour ne pas perdre l‚Äô√©quilibre. - Albert Einstein\"\n\tbreak\n  case 45:\n\tmsg.payload = \"Les portes de l‚Äôavenir sont ouvertes √† ceux qui savent les pousser. - Coluche\"\n\tbreak\n  case 46:\n\tmsg.payload = \"Le monde n‚Äôa progress√© que gr√¢ce aux choses impossibles qui ont √©t√© r√©alis√©es. - Andr√© Maurois\"\n\tbreak\n  case 47:\n\tmsg.payload = \"Les obstacles sont ces choses effrayantes que vous apercevez lorsque vous d√©tournez les yeux de vos objectifs. - Henry Ford\"\n\tbreak\n  case 48:\n\tmsg.payload = \"Pour pouvoir contempler un arc-en-ciel, il faut d‚Äôabord endurer la pluie. - Proverbe chinois\"\n\tbreak\n  case 49:\n\tmsg.payload = \"Commencez par changer en vous ce que vous voulez changer autour de vous. - Gandhi\"\n\tbreak\n  case 50:\n\tmsg.payload = \"La folie, c‚Äôest de refaire la m√™me chose et d‚Äôen attendre un r√©sultat diff√©rent. - Albert Einstein\"\n\tbreak\n  case 51:\n\tmsg.payload = \"Agissez toujours comme s‚Äôil √©tait impossible d‚Äô√©chouer. - Winston Churchill\"\n\tbreak\n  case 52:\n\tmsg.payload = \"Il est difficile d‚Äô√©chouer. Mais il est encore plus difficile de ne pas avoir essay√© de r√©ussir. - Th√©odore Roosevelt\"\n\tbreak\n  case 53:\n\tmsg.payload = \"Se lamenter sur un malheur pass√©, voil√† le plus s√ªr moyen d‚Äôen attirer un autre. - William Shakespeare\"\n\tbreak\n  case 54:\n\tmsg.payload = \"L‚Äô√©chec n‚Äôest qu‚Äôune opportunit√© pour recommencer la m√™me chose plus intelligemment. - Henry Ford\"\n}\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":60,"wires":[[]]},{"id":"c4c0894d444403e2","type":"random","z":"386f1888bc94b4c8","name":"random","low":"1","high":"54","inte":"true","property":"payload","x":160,"y":60,"wires":[["4c9393d44c603ea8"]]},{"id":"dc47f457b832a414","type":"api-call-service","z":"5a05b9ac0289ff03","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":60,"wires":[[]]},{"id":"f64c03332cd1b220","type":"delay","z":"5a05b9ac0289ff03","name":"delay","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":430,"y":60,"wires":[["efc090cb760c2a79"]]},{"id":"d48745c8f9fd365f","type":"function","z":"5a05b9ac0289ff03","name":"lights","func":"let light_control = global.get(\"light_control\") ?? {}\nlet brightness_pct = [100, 1]\nlet effects = msg.effects\neffects.time = effects.time / 2\nlet msgs = []\n\n\n// NE PAS FAIRE DE NOTIF QUAND LA LAMPE EST ETEINTE ET BLOQUEE\n\nmsgs.push({ reset: \"reset\" })\nfor (let light of msg.linked_lights) {\n    let is_locked = (light_control.locked ?? []).includes(light.entity_id)\n    if (!is_locked || is_locked && light.state === \"on\") {\n        if (light.attributes.flowing !== undefined) {\n            let delay = 0\n            if (light.state === \"off\" || light.attributes.flowing === true) {\n                msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: light.entity_id, transition: effects.time } } })\n                delay = effects.time\n            }\n            if ((light.attributes.supported_color_modes ?? []).find(s => [\"hs\", \"rgb\", \"xy\"].includes(s)) && effects.saturation !== 0) {\n                msgs.push({\n                    delay: delay,\n                    domain: \"yeelight\", service: \"start_flow\", payload: {\n                        data: {\n                            entity_id: light.entity_id, count: effects.count, action: \"recover\",\n                            transitions: [\n                                { \"HSVTransition\": [effects.color, effects.saturation, effects.time, brightness_pct[0]] },\n                                { \"HSVTransition\": [effects.color, effects.saturation, effects.time, brightness_pct[1]] }\n                            ]\n                        }\n                    }\n                })\n            } else if ((light.attributes.supported_color_modes ?? []).find(s => [\"color_temp\"].includes(s))) {\n                msgs.push({\n                    delay: delay,\n                    domain: \"yeelight\", service: \"start_flow\", payload: {\n                        data: {\n                            entity_id: light.entity_id, count: effects.count, action: \"recover\",\n                            transitions: [\n                                { \"TemperatureTransition\": [light.attributes.max_color_temp_kelvin, effects.time, brightness_pct[0]] },\n                                { \"TemperatureTransition\": [light.attributes.min_color_temp_kelvin, effects.time, brightness_pct[1]] }\n                            ]\n                        }\n                    }\n                })\n            }\n        } else {\n            for (let i = 0; i < effects.count * 2; i++) {\n                let support = (light.attributes.supported_color_modes ?? []).find(s => [\"hs\", \"rgb\", \"xy\"].includes(s))\n                let parameters = { [support && effects.saturation !== 0 ? \"hs_color\" : \"color_temp_kelvin\"]: support && effects.saturation !== 0 ? [effects.color, effects.saturation] : i % 2 === 0 ? light.attributes.max_color_temp_kelvin : light.attributes.min_color_temp_kelvin }\n                msgs.push({\n                    delay: effects.time * i,\n                    domain: \"light\",\n                    service: \"turn_on\",\n                    payload: { data: { entity_id: light.entity_id, brightness_pct: brightness_pct[i % 2], transition: effects.time, ...parameters } }\n                })\n            }\n        }\n    }\n}\n\nif (msgs.length > 1) {\n    msgs.push({ flow: \"stop\", delay: effects.count * effects.time * 2, payload: { data: { transition: 0.5 } } })\n    return [msgs]\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":60,"wires":[["f64c03332cd1b220"]]},{"id":"efc090cb760c2a79","type":"switch","z":"5a05b9ac0289ff03","name":"stop ?","property":"flow","propertyType":"msg","rules":[{"t":"eq","v":"stop","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":550,"y":60,"wires":[["93a1508434b13074"],["dc47f457b832a414"]]},{"id":"c449dcd2f1efdb91","type":"function","z":"5a05b9ac0289ff03","name":"check lights","func":"if (\n    Array.isArray(msg.linked_lights) && msg.linked_lights.length > 0 &&\n    msg.effects !== undefined &&\n    typeof msg.effects.count === \"number\" &&\n    typeof msg.effects.color === \"number\" &&\n    typeof msg.effects.saturation === \"number\" &&\n    typeof msg.effects.time === \"number\"\n) {\n    return msg\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["d48745c8f9fd365f"]]},{"id":"449ca05bf192210e","type":"ha-fire-event","z":"5a05b9ac0289ff03","name":"restore lights","server":"c87720f17866318d","version":0,"event":"restore_lights","data":"","dataType":"json","x":850,"y":60,"wires":[[]]},{"id":"659ed9ee25a47490","type":"api-current-state","z":"e6ac576fb4598283","name":"in_home_zone ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.in_home_zone","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":190,"y":80,"wires":[[],[]]},{"id":"bac0f6cb65e6ea92","type":"function","z":"ba09e97f2ed22f2b","name":"prepare notification","func":"let persons = msg.persons\nlet msgs = []\n\nif (msg.error === true) {\n    persons = msg.persons.filter(p => (p.notify_mobile_app_on_errors ?? false))\n} else if (Array.isArray(msg.send_to)) {\n    persons = msg.persons.filter(p => msg.send_to.includes(p.name))\n}\n\nfor (let p of persons.filter(p => p.mobile_app_name !== \"\")) {\n    let notification = { service: p.mobile_app_name, payload: { data: { message: msg.clear_on_phone ? \"clear_notification\" : (msg.message ?? \"\"), data: {} } } }\n\n    if (msg.title) {\n        notification.payload.data.title = msg.title\n    }\n\n    if (msg.data) {\n        notification.payload.data[\"data\"] = msg.data\n    }\n\n    notification.payload.data[\"data\"][\"tag\"] = msg.notification_id\n    msgs.push(notification)\n}\n\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":60,"wires":[["138422f99c4bd921"]]},{"id":"138422f99c4bd921","type":"api-call-service","z":"ba09e97f2ed22f2b","name":"send to mobile","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"notify","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"all","x":680,"y":60,"wires":[[]]},{"id":"ffcfbc338ee42cc0","type":"function","z":"ba09e97f2ed22f2b","name":"persons >","func":"if (msg.send_mobile === true || msg.clear_on_phone === true) {\n    msg.search = { \"is\": { linked_class: \"person\" } }\n    msg.output_name = \"persons\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":60,"wires":[["6bca1e5efde2ee7a"]]},{"id":"6bca1e5efde2ee7a","type":"subflow:3da7ebfd83a38899","z":"ba09e97f2ed22f2b","name":"","x":310,"y":60,"wires":[["bac0f6cb65e6ea92"]]},{"id":"5ab0339e525685e3","type":"subflow:e6ac576fb4598283","z":"dbf17bea6affd2ec","name":"","x":170,"y":60,"wires":[["5be370feaae51ba7"],[]]},{"id":"0fb94c5b2c85c7f4","type":"subflow:3da7ebfd83a38899","z":"dbf17bea6affd2ec","name":"","x":575,"y":60,"wires":[["072f7cf683485542"]],"l":false},{"id":"5be370feaae51ba7","type":"link out","z":"dbf17bea6affd2ec","name":"link out 668","mode":"link","links":["be7d156105fc2231"],"x":275,"y":60,"wires":[]},{"id":"e3dab73f82f487d8","type":"link in","z":"dbf17bea6affd2ec","name":"link in 587","links":["a67d1eafb1e6aaf1"],"x":355,"y":180,"wires":[["7deadf5de02b4b83"]]},{"id":"be7d156105fc2231","type":"link in","z":"dbf17bea6affd2ec","name":"link in 588","links":["5be370feaae51ba7"],"x":355,"y":60,"wires":[["33ad227bfc1b9b09"]]},{"id":"d771e29983f3d0e9","type":"change","z":"dbf17bea6affd2ec","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":575,"y":120,"wires":[["33cd06687cd8fc3f"]],"l":false},{"id":"33cd06687cd8fc3f","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set volume","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volume_level}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":120,"wires":[[]]},{"id":"fe03888699a0d410","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set speaker","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":470,"y":120,"wires":[["d771e29983f3d0e9"]]},{"id":"fca2282e9dccd3df","type":"link in","z":"dbf17bea6affd2ec","name":"link in 5","links":["a67d1eafb1e6aaf1"],"x":355,"y":120,"wires":[["fe03888699a0d410"]]},{"id":"a67d1eafb1e6aaf1","type":"link out","z":"dbf17bea6affd2ec","name":"link out 4","mode":"link","links":["fca2282e9dccd3df","e3dab73f82f487d8"],"x":805,"y":60,"wires":[]},{"id":"982fd01f2a2a4111","type":"delay","z":"dbf17bea6affd2ec","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":true,"outputs":1,"x":755,"y":60,"wires":[["a67d1eafb1e6aaf1"]],"l":false},{"id":"072f7cf683485542","type":"function","z":"dbf17bea6affd2ec","name":"msgs","func":"let speaker_day_night_mode = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.speaker_day_night_mode\"].state == \"on\"\nlet linked_area = msg.linked_area\nlet audio_type = msg.audio_type\nlet speakers = msg.speakers\nlet msgs = []\n\nif (speakers.length == 1) {\n    set_msgs(speakers[0].entity_id, audio_type, msg[audio_type])\n} else {\n    for (let speaker of speakers.filter(s => s.linked_area == (linked_area ?? s.linked_area))) {\n        set_msgs(speaker.entity_id, audio_type, msg[audio_type])\n    }\n}\nreturn [msgs]\n\nfunction set_msgs(entity_id, audio_type, content) {\n\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    let tts_voice = home_configuration.tts_voice ?? \"\"\n    let message = {\n        entity_id: entity_id,\n        volume_level: msg.volume_level,\n        rate: (audio_type === \"speak\" ? 125 * content.length : 10 * 1000),\n        effects: msg.effects\n    }  \n\n    if (audio_type === \"speak\" && tts_voice !== \"\") {\n        msgs.push({\n            ...message,\n            domain: \"tts\",\n            service: tts_voice,\n            payload: {\n                data: {\n                    entity_id: entity_id,\n                    message: content\n                }\n            }\n        })\n    } else if (audio_type === \"sound\") {\n        msgs.push({\n            ...message,\n            domain: \"media_player\",\n            service: \"play_media\",\n            payload: {\n                data: {\n                    entity_id: entity_id,\n                    media_content_id: \"media-source://media_source/media/\" + content,\n                    media_content_type: \"music\"\n                }\n            }\n        })\n    } else if (audio_type === \"link\") {\n        msgs.push({\n            ...message,\n            domain: \"media_player\",\n            service: \"play_media\",\n            payload: {\n                data: {\n                    entity_id: entity_id,\n                    media_content_id: content,\n                    media_content_type: \"music\"\n                }\n            }\n        })\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":60,"wires":[["982fd01f2a2a4111"]]},{"id":"ec894b6ff224bdd4","type":"subflow:3da7ebfd83a38899","z":"dbf17bea6affd2ec","name":"","x":695,"y":180,"wires":[["01ace5bfc1f890dc"]],"l":false},{"id":"01ace5bfc1f890dc","type":"subflow:5a05b9ac0289ff03","z":"dbf17bea6affd2ec","name":"","x":820,"y":180,"wires":[]},{"id":"7deadf5de02b4b83","type":"function","z":"dbf17bea6affd2ec","name":"get lights from active motions >","func":"let motion_areas = global.get(\"motion_areas\") ?? {}\nlet active_areas = Object.keys(motion_areas).filter(a => (motion_areas[a] == \"on\" || motion_areas[a] == \"last\"))\n\nreturn {\n    search: { \"is\": { linked_class: \"light\", linked_area: active_areas, state: [\"on\", \"off\"] } },\n    output_name: \"linked_lights\",\n    output_empty_results: false,\n    effects: msg.effects\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":180,"wires":[["ec894b6ff224bdd4"]]},{"id":"33ad227bfc1b9b09","type":"function","z":"dbf17bea6affd2ec","name":"speakers >","func":"let audio_type = Object.keys(msg).find(a => [\"speak\", \"sound\", \"link\"].includes(a))\nif (audio_type) {\n    let functions = global.get(\"functions\") ?? {}\n    return {\n        audio_type: audio_type,\n        [audio_type]: msg[audio_type],\n        volume_level: msg.volume_level ?? functions[\"get_volume_level\"](),\n        effects: msg.effects,\n        search: { \"is\": { linked_class: \"speaker\" }, \"not\": { state: \"unavailable\" } },\n        output_name: \"speakers\",\n        output_empty_results: false\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":60,"wires":[["0fb94c5b2c85c7f4"]]},{"id":"955123ec73074cbf","type":"function","z":"723d4991c3c87385","name":"call prepare","func":"if (msg.entity_id) {\n    let switch_domain = [\"input_boolean\", \"switch\", \"light\"]\n    let value_domain = [\"input_number\", \"input_text\"]\n    let select_domain = [\"input_select\", \"select\"]\n    msg.domain = msg.entity_id.split(\".\")[0]\n\n    if (switch_domain.includes(msg.domain) && [\"on\", \"off\", \"toggle\"].includes(msg.state)) {\n        msg.service = msg.state === \"toggle\" ? msg.state : \"turn_\" + msg.state\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id\n            }\n        }\n        return [msg, null]\n    } else if (select_domain.includes(msg.domain) && msg.state) {\n        msg.service = \"select_option\"\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id, option: msg.state\n            }\n        }\n        return [msg, null]\n    } else if (value_domain.includes(msg.domain) && (msg.domain == \"input_number\" && !isNaN(msg.state) || msg.domain == \"input_text\")) {\n        msg.service = \"set_value\"\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id, value: msg.state\n            }\n        }\n        return [msg, null]\n    } else if (msg.domain === \"input_datetime\" && msg.state) {\n        let type =\n            msg.state.search(/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}/) == 0 ? \"datetime\"\n                : msg.state.search(/[0-9]{4}-[0-9]{2}-[0-9]{2}/) == 0 ? \"date\"\n                    : msg.state.search(/[0-9]{2}:[0-9]{2}/) == 0 ? \"time\" : \"\"\n        if (type) {\n            msg.service = \"set_datetime\"\n            msg.payload = {\n                data: {\n                    entity_id: msg.entity_id, [type]: msg.state\n                }\n            }\n            return [msg, null]\n        }\n    } else if (msg.domain === \"action\") {\n        return [{ ...msg.state }, null]\n    } else if (msg.domain === \"emulate\") {\n        msg.payload = {\n            event: \"emulate\",\n            data: {\n                entity_id: msg.entity_id.replace(msg.domain + \".\", \"\"),\n                ...msg.state\n            }\n        }\n        return [null, msg]\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["c90e53f5c4e8e1e2"],["6acff092435169c4"]]},{"id":"c90e53f5c4e8e1e2","type":"api-call-service","z":"723d4991c3c87385","name":"call service","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":330,"y":60,"wires":[[]]},{"id":"dfbaefd1c674da97","type":"ha-fire-event","z":"723d4991c3c87385","name":"fire event","server":"c87720f17866318d","version":0,"event":"","data":"","dataType":"json","x":480,"y":60,"wires":[[]]},{"id":"bdd49c309e819698","type":"function","z":"ad3b29a5dd67898f","name":"send dashboard bug","func":"if (msg.error?.message) {\n    let notAllowedError = msg.blockedErrors.find(e => (msg.error.message.includes(e)))\n    if (!notAllowedError) {\n        let notifications = global.get(\"notifications\") ?? {}\n\n        msg.notification_id = \"error_\" + msg.flowTitle + \"_\" + (msg.error?.source.id ?? new Date().getTime())\n        msg.title = \"Erreur d√©t√©ct√©e\"\n        msg.message = \"Erreur : \" + msg.flowTitle + \" > \" + msg.error?.source?.name + \" > \" + msg.error?.message\n        msg.alert_type = \"error\"\n\n        if (notifications[msg.notification_id]) {\n            msg.message += \", apparue \" + (notifications[msg.notification_id].count + 1) + \" fois.\"\n        } else {\n            msg.send_mobile = true\n        }\n        msg.error = true\n        return msg\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":100,"wires":[["6280166330ae9f71"]]},{"id":"6280166330ae9f71","type":"delay","z":"ad3b29a5dd67898f","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":400,"y":100,"wires":[[]]},{"id":"756ccf0426c7087d","type":"debug","z":"ad3b29a5dd67898f","name":"debug 1","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":510,"y":40,"wires":[]},{"id":"f8ffcffdadd50488","type":"subflow:94b2243985840d69","z":"ad3b29a5dd67898f","name":"","x":350,"y":40,"wires":[["756ccf0426c7087d","2271ac974449a6cd"]]},{"id":"9303e8f878770ce0","type":"subflow:515fe2385f553c95","z":"ad3b29a5dd67898f","name":"","x":870,"y":40,"wires":[["d32dfc19aca11d6c"],["308ca84962deb508"]]},{"id":"3d465666ee7193c6","type":"file","z":"ad3b29a5dd67898f","name":"save error","filename":"/homeassistant/node-red/errors.txt","filenameType":"str","appendNewline":true,"createDir":true,"overwriteFile":"false","encoding":"none","x":480,"y":160,"wires":[[]]},{"id":"d32dfc19aca11d6c","type":"link out","z":"ad3b29a5dd67898f","name":"link out 536","mode":"link","links":["7a46c28099b3899d"],"x":975,"y":40,"wires":[]},{"id":"7a46c28099b3899d","type":"link in","z":"ad3b29a5dd67898f","name":"link in 483","links":["d32dfc19aca11d6c"],"x":55,"y":100,"wires":[["bdd49c309e819698"]]},{"id":"308ca84962deb508","type":"link out","z":"ad3b29a5dd67898f","name":"link out 537","mode":"link","links":["044a910a51b45b80"],"x":975,"y":40,"wires":[]},{"id":"044a910a51b45b80","type":"link in","z":"ad3b29a5dd67898f","name":"link in 484","links":["308ca84962deb508"],"x":55,"y":160,"wires":[["d7452f75b2eada8e"]]},{"id":"02d291345d1acef9","type":"function","z":"ad3b29a5dd67898f","name":"allowedError ?","func":"if (msg.error?.source?.name) {\n    let allowedError = msg.blockedErrors.filter(error => msg.error.message.includes(error)).length == 0\n    if (allowedError) {\n        msg.payload = { time: msg.current_time, ...msg }\n        return msg\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":160,"wires":[["3d465666ee7193c6"]]},{"id":"2271ac974449a6cd","type":"function","z":"ad3b29a5dd67898f","name":"blockedErrors","func":"msg.blockedErrors = [\n    \"The write socket is closed\",\n    \"Connection closed\"\n]\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":40,"wires":[["9303e8f878770ce0"]]},{"id":"fcdc38c73bb08769","type":"delay","z":"ad3b29a5dd67898f","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":180,"y":40,"wires":[["f8ffcffdadd50488"]]},{"id":"d7452f75b2eada8e","type":"function","z":"ad3b29a5dd67898f","name":"get date","func":"let d = new Date()\nlet year = d.getFullYear()\nlet month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1)\nlet day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate()\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n\nmsg.current_time = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":160,"wires":[["02d291345d1acef9"]]},{"id":"b4b8c8acb4afc630","type":"function","z":"6c4028aab794d52d","name":"create notification","func":"let notifications = global.get(\"notifications\") ?? {}\n\nif (!notifications[msg.notification_id] || msg.override) {\n    let d = new Date()\n    let local_time = (d.getMonth() + 1) + \" \" + d.getDate() + \" \" + d.getHours() + \":\" + (d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes())\n    notifications[msg.notification_id] = {}\n    notifications[msg.notification_id].count = 1\n    notifications[msg.notification_id].creation_date = msg.restore ? msg.creation_date : local_time\n} else {\n    notifications[msg.notification_id].count++\n}\n\nnotifications[msg.notification_id].title = msg.title ?? \"\"\nnotifications[msg.notification_id].message = msg.message ?? \"\"\nnotifications[msg.notification_id].alert_type = msg.alert_type ?? \"info\"\n\nif (typeof msg.send_mobile === \"string\"){\n    msg.send_mobile = msg.send_mobile.toLowerCase() === \"true\"\n}\n\nif (typeof msg.clear_on_phone === \"string\") {\n    msg.clear_on_phone = msg.clear_on_phone.toLowerCase() === \"true\"\n}\n\nglobal.set(\"notifications\", notifications)\nmsg.notifications = notifications\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":180,"wires":[["db39b80e5ccab19b","329b6d774407f71d"]]},{"id":"ed73f233a30a209c","type":"link out","z":"6c4028aab794d52d","name":"link out 196","mode":"link","links":["3cec5815dff22f23"],"x":455,"y":240,"wires":[]},{"id":"2d47b21860760270","type":"subflow:dbf17bea6affd2ec","z":"6c4028aab794d52d","name":"","x":360,"y":300,"wires":[]},{"id":"01115ff6eea2fb4d","type":"link out","z":"6c4028aab794d52d","name":"link out 226","mode":"link","links":["3cec5815dff22f23"],"x":835,"y":180,"wires":[]},{"id":"ba2ec713942851f0","type":"subflow:ba09e97f2ed22f2b","z":"6c4028aab794d52d","name":"","x":220,"y":300,"wires":[]},{"id":"7e00d134f3038fd4","type":"function","z":"6c4028aab794d52d","name":"process notification","func":"switch (msg.notification?.event?.service ?? \"\") {\n    case \"create\":\n        return [msg, null]\n    case \"dismiss\":\n        msg.notifications = global.get(\"notifications\") ?? {}\n        delete msg.notifications[msg.notification.event.service_data.notification_id]\n        global.set(\"notifications\", msg.notifications)\n        return [null, msg]\n    case \"dismiss_all\":\n        msg.notifications = {}\n        global.set(\"notifications\", msg.notifications)\n        return [null, msg]\n    default:\n        return [null, null]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":380,"wires":[["77a3983c5e6305d8"],["cc379f05a4f6474a"]]},{"id":"fe7c59f6e9b79d49","type":"yaml","z":"6c4028aab794d52d","property":"notifications","name":"","x":150,"y":500,"wires":[["88c0104d004472ea"]]},{"id":"c16c539fd3d8eb35","type":"file","z":"6c4028aab794d52d","name":"","filename":"/config/notifications.yaml","filenameType":"str","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":390,"y":500,"wires":[["3aefd2ebadc028c0"]]},{"id":"9c15ed8da7f1e70d","type":"link in","z":"6c4028aab794d52d","name":"write notifications","links":[],"x":55,"y":500,"wires":[["fe7c59f6e9b79d49"]]},{"id":"a641e18ab6fd2b7d","type":"link out","z":"6c4028aab794d52d","name":"link out 450","mode":"return","links":[],"x":585,"y":500,"wires":[]},{"id":"329b6d774407f71d","type":"link call","z":"6c4028aab794d52d","name":"","links":["9c15ed8da7f1e70d"],"linkType":"static","timeout":"30","x":710,"y":180,"wires":[["01115ff6eea2fb4d"]]},{"id":"cc379f05a4f6474a","type":"link call","z":"6c4028aab794d52d","name":"","links":["9c15ed8da7f1e70d"],"linkType":"static","timeout":"30","x":550,"y":380,"wires":[[]]},{"id":"2676dfc312e38a90","type":"link in","z":"6c4028aab794d52d","name":"link in 496","links":["de8ee9854a765866"],"x":335,"y":60,"wires":[["382c2cbb71cccf31"]]},{"id":"db39b80e5ccab19b","type":"api-call-service","z":"6c4028aab794d52d","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"persistent_notification","service":"create","areaId":[],"deviceId":[],"entityId":[],"data":"{\"title\":\"{{title}}\",\"message\":\"{{message}}\",\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":180,"wires":[[]]},{"id":"1fbb7266d0e73a79","type":"api-call-service","z":"6c4028aab794d52d","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"persistent_notification","service":"dismiss","areaId":[],"deviceId":[],"entityId":[],"data":"{\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":290,"y":240,"wires":[["ed73f233a30a209c"]]},{"id":"27be3bd3583772c1","type":"server-events","z":"6c4028aab794d52d","name":"persistent_notification","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"call_service","eventData":"{\"domain\":\"persistent_notification\"}","waitForRunning":true,"outputProperties":[{"property":"notification","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":140,"y":380,"wires":[["7e00d134f3038fd4"]]},{"id":"23ebc4c6c318a1d6","type":"server-events","z":"6c4028aab794d52d","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":390,"y":440,"wires":[["b87109c787f6a302"]]},{"id":"3cec5815dff22f23","type":"link in","z":"6c4028aab794d52d","name":"link in 551","links":["01115ff6eea2fb4d","ed73f233a30a209c"],"x":125,"y":300,"wires":[["2d47b21860760270","ba2ec713942851f0"]]},{"id":"b8d927bc07163cd1","type":"function","z":"6c4028aab794d52d","name":"msg to json","func":"msg.template = JSON.stringify(msg).replaceAll(\"\\\\\\\"\",\"'\")\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":120,"wires":[["51c4b7debb5741ab"]]},{"id":"51c4b7debb5741ab","type":"api-render-template","z":"6c4028aab794d52d","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":380,"y":120,"wires":[["89c488895669a0cc"]]},{"id":"89c488895669a0cc","type":"function","z":"6c4028aab794d52d","name":"json to msg","func":"msg = { ...JSON.parse(msg.payload) }\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":120,"wires":[["35fc8c75eea3ff9f"]]},{"id":"88c0104d004472ea","type":"change","z":"6c4028aab794d52d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"notifications","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":235,"y":500,"wires":[["c16c539fd3d8eb35"]],"l":false},{"id":"382c2cbb71cccf31","type":"switch","z":"6c4028aab794d52d","name":"notification_id ?","property":"notification_id","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":460,"y":60,"wires":[["03e590978d267476"]]},{"id":"03e590978d267476","type":"switch","z":"6c4028aab794d52d","name":"dismiss ?","property":"dismiss","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":620,"y":60,"wires":[["9c555f4d7d64e89d"],["74d033513cfa7c10"]]},{"id":"9c555f4d7d64e89d","type":"link out","z":"6c4028aab794d52d","name":"link out 624","mode":"link","links":["524c45819197cdee"],"x":715,"y":60,"wires":[]},{"id":"524c45819197cdee","type":"link in","z":"6c4028aab794d52d","name":"link in 560","links":["9c555f4d7d64e89d"],"x":125,"y":240,"wires":[["1fbb7266d0e73a79"]]},{"id":"74d033513cfa7c10","type":"link out","z":"6c4028aab794d52d","name":"link out 625","mode":"link","links":["d4f4c24099be178d"],"x":715,"y":60,"wires":[]},{"id":"d4f4c24099be178d","type":"link in","z":"6c4028aab794d52d","name":"link in 561","links":["74d033513cfa7c10"],"x":125,"y":120,"wires":[["b8d927bc07163cd1"]]},{"id":"35fc8c75eea3ff9f","type":"link out","z":"6c4028aab794d52d","name":"link out 626","mode":"link","links":["b968538bbd759e3a"],"x":635,"y":120,"wires":[]},{"id":"b968538bbd759e3a","type":"link in","z":"6c4028aab794d52d","name":"link in 562","links":["35fc8c75eea3ff9f"],"x":125,"y":180,"wires":[["b4b8c8acb4afc630"]]},{"id":"3aefd2ebadc028c0","type":"change","z":"6c4028aab794d52d","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"delete","p":"notifications","pt":"msg"},{"t":"delete","p":"filename","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":535,"y":500,"wires":[["a641e18ab6fd2b7d"]],"l":false},{"id":"b87109c787f6a302","type":"function","z":"6c4028aab794d52d","name":"delete notification","func":"let notifications = global.get(\"notifications\") ?? {}\nlet notification_id = msg.payload?.event?.tag ?? \"\"\n\nif (notifications[notification_id] && notifications[notification_id].alert_type !== \"error\") {\n    return { notification_id: notification_id, dismiss: true }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":440,"wires":[["de8ee9854a765866"]]},{"id":"de8ee9854a765866","type":"link out","z":"6c4028aab794d52d","name":"link out 639","mode":"link","links":["2676dfc312e38a90"],"x":695,"y":440,"wires":[]},{"id":"95515f74e40cc29d","type":"server-events","z":"6c4028aab794d52d","name":"mobile_app_notification_cleared","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_cleared","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"notification_id","propertyType":"msg","value":"$outputData(\"eventData\").event.tag","valueType":"jsonata"}],"x":170,"y":440,"wires":[["b87109c787f6a302"]]},{"id":"f466fcd4c433d4e3","type":"change","z":"6c4028aab794d52d","name":"","rules":[{"t":"delete","p":"payload.data","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":190,"y":60,"wires":[["382c2cbb71cccf31"]]},{"id":"68969b8280827750","type":"function","z":"515fe2385f553c95","name":"mode dev ?","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (home_configuration.mode === \"dev\") {\n    return [msg, null]\n} else {\n    return [null, msg]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":80,"wires":[[],[]]},{"id":"febc11290421c3af","type":"api-current-state","z":"94b2243985840d69","name":"services_loaded","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"services_loaded","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.services_loaded","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":180,"y":80,"wires":[["20c20fc427292f9a"],[]]},{"id":"20c20fc427292f9a","type":"function","z":"94b2243985840d69","name":"homeassistant is running ?","func":"let homeassistant = global.get(\"homeassistant\")?.homeAssistant ?? {}\n\nif ((homeassistant.isRunning ?? false) && (homeassistant.isConnected ?? false)) {\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":80,"wires":[[]]},{"id":"466e65d315aca28f","type":"function","z":"3da7ebfd83a38899","name":"search entities","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet entities = global.get(\"homeassistant\").homeAssistant.states\nlet found = []\n\nfor (let entity_id of Object.keys(entities)) {\n    let entity = entities[entity_id]\n    if (home_configuration[entity_id]) {\n        entity = { ...entity, ...home_configuration[entity_id] }\n    }\n    let entity_search = { ...entity, ...entity.attributes }\n    if (search(entity_search)) {\n        entity.state = isNaN(entity.state) ? entity.state : parseFloat(entity.state)\n        found.push(entity)\n    }\n}\n\nlet output_empty_results = (msg.output_empty_results ?? false) || found.length > 0\nif (output_empty_results) {\n    msg[msg.output_name] = found\n    delete msg.output_empty_results\n    delete msg.output_name\n    delete msg.search\n    return msg\n}\n\nfunction search(entity) {\n    if (msg.search[\"is\"]) {\n        for (let search_key of Object.keys(msg.search[\"is\"])) {\n            if (Array.isArray(msg.search[\"is\"][search_key])) {\n                if (!(msg.search[\"is\"][search_key].includes(entity[search_key]))) {\n                    return false\n                }\n            } else if (msg.search[\"is\"][search_key] === undefined || !(entity[search_key] == msg.search[\"is\"][search_key])) {\n                return false\n            }\n        }\n    }\n    if (msg.search[\"not\"]) {\n        for (let search_key of Object.keys(msg.search[\"not\"])) {\n            if (Array.isArray(msg.search[\"not\"][search_key])) {\n                if (msg.search[\"not\"][search_key].includes(entity[search_key])) {\n                    return false\n                }\n            } else if (msg.search[\"not\"][search_key] === undefined || entity[search_key] == msg.search[\"not\"][search_key]) {\n                return false\n            }\n        }\n    }\n    return true\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[[]]},{"id":"9d3ad0a23db6a2ce","type":"subflow:6c4028aab794d52d","z":"27148b7bb9f62ac7","name":"","x":170,"y":180,"wires":[["a938cb7f0804c121"]]},{"id":"e53334a6f05a9609","type":"link in","z":"27148b7bb9f62ac7","name":"notification","links":["3b3dd6b16a5c5a1d","af0c165af5996110","9a6820da31f5f8c4","5c035d30aa0eeaa4","8d3c03ad03424be9","6a698c348a5afd7f","63efd697ac220b54","76cea9e99f705380","ce168531822379e5","088f2437bb522d14","0419929f6aea7cca","840e0643e8c84153","27ce4ecdecc58ff1","fe7db153e4105d50","8ff031019adb02ce","4eab8cffd742e405","4d571b7c3108dd2f","f9f8f8a690320c67","3ae0ae0231621daa","afccfcc67ca22c62","2b5cdcce3c6af32e","0254d9333c76d32a","b925a40aca67e6ca","ee6612b6dae35793","537da3c87d62c330","c31a6f8463401855","6b33d1d98f2bb2df","14641d23f914ef77","0d99cef6bb8581ba","612853ee2a628cda","f9dca7092c092ecf","45cea250ce764020","b33d9764ba16108b","19b6e42a74f1681a","6f353d1a4b15fe21","40e112a841309a8c","787aaaf006230051","5eae2e36c9800be4","d7dbe243d1afa5ca","c0162d93859e418d","8ed021ef5338a438","5a7d35891b109375","3d7c97bdf077e68d","825cf31751b11239","959c627d953cb72a","8633757000801880"],"x":55,"y":180,"wires":[["9d3ad0a23db6a2ce"]]},{"id":"db30a1d2a0b1285b","type":"catch","z":"27148b7bb9f62ac7","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["167b698e879b353d"]]},{"id":"e3ba334aa41a02a2","type":"subflow:ad3b29a5dd67898f","z":"27148b7bb9f62ac7","name":"","x":460,"y":40,"wires":[["3ae0ae0231621daa"]]},{"id":"167b698e879b353d","type":"change","z":"27148b7bb9f62ac7","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Core","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["e3ba334aa41a02a2"]]},{"id":"127167b2550a2c1c","type":"comment","z":"27148b7bb9f62ac7","name":"Notifications ++","info":"Object.entries(windows).forEach(([key, value]) => {\n    \n})\n________________________________________________________________________________\nconst array1 = [true, false, true, true]\nconst initialValue = true\nconst sumWithInitial = array1.reduce(\n  (accumulator, currentValue) => accumulator && currentValue,\n  initialValue\n)\n________________________________________________________________________________\nlight.attributes.supported_color_modes ?? []).some(mode => mode == \"hs\")\n________________________________________________________________________________","x":120,"y":120,"wires":[]},{"id":"48bffb9a97588b9d","type":"function","z":"27148b7bb9f62ac7","name":"prepare options","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet ambiances = msg.ambiances\nlet options = []\nlet msgs = []\n\nlet ambiancesTypeKeys = Object.keys(home_configuration.ambiance_config.ambiances_type)\nfor (let key of ambiancesTypeKeys) {\n    options.push(key)\n}\n\nfor (let ambiance of ambiances) {\n    msgs.push({ payload: { data: { entity_id: ambiance.entity_id, options: options } } })\n}\nreturn [msgs]\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":640,"wires":[["f2abe23402efadfd"]]},{"id":"ba01e397c4ca1e22","type":"link in","z":"27148b7bb9f62ac7","name":"ambiances restore","links":["673a65ab8604e879"],"x":935,"y":640,"wires":[["9cdcdc57bc2d3d28"]]},{"id":"dd906c00889a2c63","type":"comment","z":"27148b7bb9f62ac7","name":"Elevation","info":"","x":1200,"y":380,"wires":[]},{"id":"3fc94c7a8b2de5ee","type":"comment","z":"27148b7bb9f62ac7","name":"Global context management","info":"","x":160,"y":520,"wires":[]},{"id":"584269b4c105222c","type":"link in","z":"27148b7bb9f62ac7","name":"notifications restore","links":["673a65ab8604e879"],"x":55,"y":780,"wires":[["49f2b6bf5afc8498"]]},{"id":"aad51a0c3f56d775","type":"function","z":"27148b7bb9f62ac7","name":"restore notifications","func":"let notifications = msg.payload ?? {}\nlet notificationsKeys = Object.keys(notifications)\nlet msgs = []\n\nfor (let key of notificationsKeys) {\n    msgs.push({\n        notification_id: key,\n        count: notifications[key].count,\n        alert_type: notifications[key]?.alert_type ?? \"info\",\n        title: notifications[key]?.title ?? \"\",\n        message: notifications[key]?.message ?? \"\",\n        creation_date: notifications[key]?.creation_date ?? \"???\",\n        restore: true\n    })\n}\n\nif (msgs.length !== 0) {\n    return [msgs]\n} else {\n    global.set(\"notifications\", {})\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":780,"wires":[["63efd697ac220b54"]]},{"id":"63efd697ac220b54","type":"link out","z":"27148b7bb9f62ac7","name":"link out 448","mode":"link","links":["e53334a6f05a9609"],"x":495,"y":780,"wires":[]},{"id":"49f2b6bf5afc8498","type":"file in","z":"27148b7bb9f62ac7","name":"get yaml notifications","filename":"/config/notifications.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":115,"y":780,"wires":[["8913f23a70c4a6cc"]],"l":false},{"id":"8913f23a70c4a6cc","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":210,"y":780,"wires":[["aad51a0c3f56d775"]]},{"id":"5a948d8bd3b54aed","type":"link out","z":"27148b7bb9f62ac7","name":"ha reloaded","mode":"link","links":["fe5df31cc9854e11"],"x":635,"y":580,"wires":[]},{"id":"9cdcdc57bc2d3d28","type":"function","z":"27148b7bb9f62ac7","name":"ambiance >","func":"msg.search = { \"is\": { linked_class: \"ambiance\" } }\nmsg.output_name = \"ambiances\"\nmsg.output_empty_results = true\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":640,"wires":[["a01ca528d07a64a4"]]},{"id":"0bd80225f89703f5","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["673a65ab8604e879"],"x":935,"y":700,"wires":[["4054e84cdc0c98b7","af4a425cffa21767"]]},{"id":"4054e84cdc0c98b7","type":"function","z":"27148b7bb9f62ac7","name":"jsons setup","func":"let json_entities = [\"json_exterior_average_temp\", \"json_activities\"]\nlet msgs = []\n\nfor (let json_entity of json_entities) {\n    let entity_id = \"input_text.\" + json_entity\n    let state = global.get(\"homeassistant\").homeAssistant.states[entity_id].state\n    if (state == \"unknown\" || state == \"\") {\n        msgs.push({\n            entity_id: entity_id,\n            state: \"{}\"\n        })\n    }\n}\n\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":700,"wires":[["83418366d18d13c0"]]},{"id":"83418366d18d13c0","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":1350,"y":700,"wires":[]},{"id":"26bcf1d6a09e471e","type":"comment","z":"27148b7bb9f62ac7","name":"Silent speaker","info":"","x":110,"y":260,"wires":[]},{"id":"b9a6aaa07ad593b3","type":"comment","z":"27148b7bb9f62ac7","name":"Exterior average temperature","info":"","x":1040,"y":120,"wires":[]},{"id":"e84323b7060d35b5","type":"function","z":"27148b7bb9f62ac7","name":"average calc","func":"let average = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state)\nlet temp_hum = global.get(\"temp_hum\") ?? {}\n\nif (\n    temp_hum[\"exterior\"]?.[\"temperature\"]?.value &&\n    temp_hum[\"exterior\"]?.[\"temperature\"]?.last_changed &&\n    ((new Date().getTime() - temp_hum[\"exterior\"]?.[\"temperature\"]?.last_changed) / 1000) < 60 * 60\n) {\n    if (!Array.isArray(average)) {\n        average = [temp_hum[\"exterior\"][\"temperature\"].value, 1]\n    } else if (Array.isArray(average)) {\n        if (average[1] < 10) {\n            average[0] = calculateAverage(average)\n            average[1]++\n        } else {\n            average[0] = calculateAverage(average)\n        }\n    }\n    msg.call_service = { entity_id: \"input_text.json_exterior_average_temp\", state: JSON.stringify(average) }\n    return msg\n}\n\nfunction calculateAverage(average) {\n    return Math.round(((average[0] * average[1] + temp_hum[\"exterior\"][\"temperature\"].value) / (average[1] + 1)) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1110,"y":180,"wires":[["1ad4b607c1170bc5"]]},{"id":"1ad4b607c1170bc5","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":1270,"y":180,"wires":[]},{"id":"f2abe23402efadfd","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set ambiance options","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"options\":\"{{options}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1480,"y":640,"wires":[[]]},{"id":"7cbc86e2587fe991","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set elevation","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.elevation"],"data":"{\"value\":\"{{data.new_state.attributes.elevation}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1330,"y":440,"wires":[[]]},{"id":"856c82e57e2036eb","type":"api-call-service","z":"27148b7bb9f62ac7","name":"purge history > 7 days","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"recorder","service":"purge","areaId":[],"deviceId":[],"entityId":[],"data":"{\"keep_days\":\"7\",\"repack\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1300,"y":320,"wires":[[]]},{"id":"cd472edfb4e940af","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"zone.home","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"zone.home","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"","ifStateType":"num","ifStateOperator":"gt","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":180,"wires":[["a938cb7f0804c121"]]},{"id":"0ed667140490b99e","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1190,"y":440,"wires":[["7cbc86e2587fe991"]]},{"id":"4f4a945985181968","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"speaker_day_night_volume","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_number.speaker_day_mode_volume","input_number.speaker_night_mode_volume"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":160,"y":380,"wires":[["292c825d3b1d166e"]]},{"id":"39e1b99a8ff7858d","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":970,"y":180,"wires":[["e84323b7060d35b5"]]},{"id":"9dcc1ae8cc20b65a","type":"ha-time","z":"27148b7bb9f62ac7","name":"speaker_day_mode_start","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.speaker_day_mode_start","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"on","valueType":"str"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":150,"y":320,"wires":[["d661cc3406383257"]]},{"id":"da07923216b0a4c5","type":"ha-time","z":"27148b7bb9f62ac7","name":"speaker_night_mode_start","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.speaker_night_mode_start","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"off","valueType":"str"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":390,"y":320,"wires":[["d661cc3406383257"]]},{"id":"a8bf2680873bf129","type":"watch","z":"27148b7bb9f62ac7","name":"home_configuration changes","files":"/homeassistant/home_configuration.yaml","recursive":"","x":55,"y":640,"wires":[["3bc3a5a58e60b298"]],"l":false},{"id":"909b7c2eda8b46d9","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":415,"y":520,"wires":[["8f8def9b0e53de3c"]],"l":false},{"id":"b4dad54ec45dcd75","type":"file in","z":"27148b7bb9f62ac7","name":"read file","filename":"/homeassistant/home_configuration.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":365,"y":520,"wires":[["909b7c2eda8b46d9"]],"l":false},{"id":"8f8def9b0e53de3c","type":"function","z":"27148b7bb9f62ac7","name":"set global home_configuration","func":"let home_configuration = msg.payload ?? {}\nglobal.set(\"home_configuration\", home_configuration)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":520,"wires":[["498d5d5a6cdccc72"]]},{"id":"a01ca528d07a64a4","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":1155,"y":640,"wires":[["48bffb9a97588b9d"]],"l":false},{"id":"fe1ddbe2d3a7b4af","type":"link in","z":"27148b7bb9f62ac7","name":"set home_configuration","links":[],"x":315,"y":520,"wires":[["b4dad54ec45dcd75"]]},{"id":"af4a425cffa21767","type":"function","z":"27148b7bb9f62ac7","name":"sun calc","func":"let sun_attributes = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes\nlet sun_light_time_setting = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_setting\"].state\nlet sun_light_time_dusk = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dusk\"].state\nlet sun_light_time_midnight = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_midnight\"].state\nlet sun_light_time_dawn = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn\"].state\nlet sun_light_time_dawn_angle = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn_angle\"].state\nlet sun_light_time_rising = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_rising\"].state\nlet msgs = []\n\nif (sun_light_time_setting == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_setting\", state: clean_date(sun_attributes.next_setting) })\n}\n\nif (sun_light_time_dusk == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dusk\", state: clean_date(sun_attributes.next_dusk) })\n}\n\nif (sun_light_time_dawn == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dawn\", state: clean_date(sun_attributes.next_dawn) })\n}\n\nif (sun_light_time_dawn_angle == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_dawn_angle\", state: clean_date(sun_attributes.next_dawn) })\n}\n\nif (sun_light_time_rising == \"00:00:00\") {\n    msgs.push({ entity_id: \"input_datetime.sun_light_time_rising\", state: clean_date(sun_attributes.next_rising) })\n}\nreturn [msgs]\n\nfunction clean_date(time_txt) {\n    time_txt = time_txt.split(\"T\")[1].split(\".\")[0]\n    time_txt = time_txt.split(\":\")\n    return time_txt[0] + \":\" + time_txt[1]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1200,"y":700,"wires":[["83418366d18d13c0"]]},{"id":"36fb0d7dc676d3f9","type":"inject","z":"27148b7bb9f62ac7","name":"1 min","props":[{"p":"linked_class","v":"time","vt":"str"}],"repeat":"","crontab":"*/1 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":990,"y":500,"wires":[["d621148fcbed70b5"]]},{"id":"6ac4487e7df2d787","type":"link out","z":"27148b7bb9f62ac7","name":"every 1 min hour","mode":"link","links":["9258d34035c742aa","faa3a5726b7782f9"],"x":1375,"y":500,"wires":[]},{"id":"d621148fcbed70b5","type":"subflow:94b2243985840d69","z":"27148b7bb9f62ac7","name":"","x":1130,"y":500,"wires":[["b7688c47df6ff820"]]},{"id":"b7688c47df6ff820","type":"function","z":"27148b7bb9f62ac7","name":"get time","func":"let d = new Date()\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n\nmsg.current_time = hour + \":\" + minute\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":500,"wires":[["6ac4487e7df2d787"]]},{"id":"539ca7ad9e3005c6","type":"inject","z":"27148b7bb9f62ac7","name":"@ 00:00","props":[],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","x":1000,"y":320,"wires":[["f9f8f8a690320c67"]]},{"id":"f9f8f8a690320c67","type":"link out","z":"27148b7bb9f62ac7","name":"@ 00:00","mode":"link","links":["e53334a6f05a9609","5a9c7e7ff308b6a6","693e35cd8fbdc9c5"],"x":1095,"y":320,"wires":[]},{"id":"944639f843fd44ab","type":"comment","z":"27148b7bb9f62ac7","name":"Time Triggers","info":"","x":990,"y":260,"wires":[]},{"id":"d661cc3406383257","type":"link out","z":"27148b7bb9f62ac7","name":"link out 585","mode":"link","links":["b273581a17bb234c"],"x":535,"y":320,"wires":[]},{"id":"f43a379928cdb87c","type":"link in","z":"27148b7bb9f62ac7","name":"link in 533","links":["e6a5d9c5bd5ca872"],"x":55,"y":440,"wires":[["054a45a62348feee"]]},{"id":"2eae8cb516ed8234","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":275,"y":440,"wires":[["5f4db6b30339ef01"]],"l":false},{"id":"054a45a62348feee","type":"function","z":"27148b7bb9f62ac7","name":"speakers >","func":"msg.search = { \"is\": { linked_class: \"speaker\" }, \"not\": { state: \"unavailable\" } }\nmsg.output_name = \"speakers\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":440,"wires":[["2eae8cb516ed8234"]]},{"id":"2a983faf13adcb08","type":"server-events","z":"27148b7bb9f62ac7","name":"home assistant","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"home_assistant_client","eventData":"","waitForRunning":false,"outputProperties":[],"event_type":"","x":120,"y":580,"wires":[["c1300c5daedc2c05"]]},{"id":"c1300c5daedc2c05","type":"function","z":"27148b7bb9f62ac7","name":"services_loaded ?","func":"if (msg.payload == \"services_loaded\") {\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":235,"y":580,"wires":[["4e8a3d91084a0847"]],"l":false},{"id":"5aa726b34e4a32c8","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"services_loaded","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_select.services_loaded","entityIdType":"exact","outputInitially":true,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"x":360,"y":580,"wires":[["9330d7a46b8da67b"]]},{"id":"9330d7a46b8da67b","type":"function","z":"27148b7bb9f62ac7","name":"services_loaded ?","func":"if (msg.state != \"services_loaded\") {\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":475,"y":580,"wires":[["4e8a3d91084a0847"]],"l":false},{"id":"4e8a3d91084a0847","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set services_loaded","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":["input_select.services_loaded"],"data":"{\"options\":[\"services_loaded\"]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":535,"y":580,"wires":[["ad40d75b818090e5"]],"l":false},{"id":"ad40d75b818090e5","type":"function","z":"27148b7bb9f62ac7","name":"empty","func":"return {}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":585,"y":580,"wires":[["5a948d8bd3b54aed"]],"l":false},{"id":"d98be4ab452f9366","type":"comment","z":"27148b7bb9f62ac7","name":"Store / Restore global","info":"","x":1020,"y":780,"wires":[]},{"id":"39372af8f404c7d2","type":"link in","z":"27148b7bb9f62ac7","name":"store global","links":[],"x":935,"y":840,"wires":[["2db885dcad63985b"]]},{"id":"be23d2c94351bfc5","type":"link out","z":"27148b7bb9f62ac7","name":"store global","mode":"return","links":[],"x":1435,"y":840,"wires":[]},{"id":"2db885dcad63985b","type":"function","z":"27148b7bb9f62ac7","name":"get global","func":"let acceptedGlobals = [\"light_control\"]\n\nlet globalStored = {}\nfor (let key of acceptedGlobals) {\n    getGlobal(key)\n}\nmsg.payload = globalStored\nreturn msg\n\nfunction getGlobal(key) {\n    globalStored[key] = global.get(key)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":840,"wires":[["b7b998be4656b030"]]},{"id":"702cfec1517daf84","type":"file","z":"27148b7bb9f62ac7","name":"write global file","filename":"/config/global.yaml","filenameType":"str","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":1320,"y":840,"wires":[["be23d2c94351bfc5"]]},{"id":"04a97112197d0e34","type":"link in","z":"27148b7bb9f62ac7","name":"restore global","links":[],"x":935,"y":900,"wires":[["d8e2d3430d662e1a"]]},{"id":"32ffa9bfbbe77266","type":"function","z":"27148b7bb9f62ac7","name":"set global","func":"let globalStored = msg.payload\n\nfor (let key of Object.keys(globalStored)) {\n    setGlobal(key)\n}\n\nfunction setGlobal(key) {\n    global.set(key, globalStored[key])\n}\n\nmsg.payload = {}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1340,"y":900,"wires":[["b180c06b093bd937"]]},{"id":"b7b998be4656b030","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":1170,"y":840,"wires":[["702cfec1517daf84"]]},{"id":"7171cc4482e3f8e3","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":1210,"y":900,"wires":[["32ffa9bfbbe77266"]]},{"id":"d8e2d3430d662e1a","type":"file in","z":"27148b7bb9f62ac7","name":"read global file","filename":"/config/global.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":1060,"y":900,"wires":[["7171cc4482e3f8e3"]]},{"id":"498d5d5a6cdccc72","type":"link out","z":"27148b7bb9f62ac7","name":"set global home_configuration","mode":"return","links":[],"x":755,"y":520,"wires":[]},{"id":"3bc3a5a58e60b298","type":"link call","z":"27148b7bb9f62ac7","name":"","links":["fe1ddbe2d3a7b4af"],"linkType":"static","timeout":"30","x":250,"y":640,"wires":[["42c6f3e251025e88"]]},{"id":"673a65ab8604e879","type":"link out","z":"27148b7bb9f62ac7","name":"home_config reloaded","mode":"link","links":["0659bd5876526cef","0bd80225f89703f5","584269b4c105222c","689d1543a0aee09c","b90a16d2d2491c28","ba01e397c4ca1e22","eec7f9eb929d0c53","44fa70f8a6e9ee7f","bd30c0f99d8b1339"],"x":735,"y":640,"wires":[]},{"id":"b180c06b093bd937","type":"link out","z":"27148b7bb9f62ac7","name":"link out 621","mode":"return","links":[],"x":1435,"y":900,"wires":[]},{"id":"bdf643ee2ef6b7f8","type":"file","z":"27148b7bb9f62ac7","name":"erase global file","filename":"/config/global.yaml","filenameType":"str","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1300,"y":960,"wires":[["d38ab85c71302031"]]},{"id":"db36ccd58e5e8fe5","type":"comment","z":"27148b7bb9f62ac7","name":"Purge history > 7 days","info":"","x":1240,"y":260,"wires":[]},{"id":"7468b2358756c25c","type":"function","z":"27148b7bb9f62ac7","name":"empty globals","func":"let notAcceptedGlobals = [\"homeassistant\"]\nlet acceptedGlobals = global.keys().filter(g => !(notAcceptedGlobals.includes(g)))\n\nfor (let key of acceptedGlobals) {\n    setGlobal(key)\n}\nmsg.payload = {}\nreturn msg\n\nfunction setGlobal(name) {\n    global.set(name, undefined)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1120,"y":960,"wires":[["bdf643ee2ef6b7f8"]]},{"id":"3ae0ae0231621daa","type":"link out","z":"27148b7bb9f62ac7","name":"link out 628","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"6263efa138d605d9","type":"comment","z":"27148b7bb9f62ac7","name":"HA startup / reloading","info":"","x":1020,"y":580,"wires":[]},{"id":"0659bd5876526cef","type":"link in","z":"27148b7bb9f62ac7","name":"ambiances restore","links":["673a65ab8604e879"],"x":55,"y":900,"wires":[["e5931fd5d1b6ca02"]]},{"id":"e5931fd5d1b6ca02","type":"function","z":"27148b7bb9f62ac7","name":"get temperature devices >","func":"return { search: { \"is\": { linked_class: \"temperature\" } }, output_name: \"temperatures\", output_empty_results: false }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":900,"wires":[["a48e03ac14e761ba"]],"l":false},{"id":"a48e03ac14e761ba","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":155,"y":900,"wires":[["bcc07d6319720020"]],"l":false},{"id":"bcc07d6319720020","type":"function","z":"27148b7bb9f62ac7","name":"set temperatures","func":"let msgs = []\n\nfor (let temperature of msg.temperatures) {\n    msgs.push({ ...temperature, new_state: temperature.state })\n}\n\nreturn [msgs];","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":900,"wires":[["30c50903518c6ad6"]]},{"id":"30c50903518c6ad6","type":"link out","z":"27148b7bb9f62ac7","name":"link out 644","mode":"link","links":["ea91ddb293af9f71"],"x":415,"y":900,"wires":[]},{"id":"689d1543a0aee09c","type":"link in","z":"27148b7bb9f62ac7","name":"ambiances restore","links":["673a65ab8604e879"],"x":55,"y":960,"wires":[["eaae9a2826651a17"]]},{"id":"eaae9a2826651a17","type":"function","z":"27148b7bb9f62ac7","name":"get temperature devices >","func":"return { search: { \"is\": { linked_class: \"humidity\" } }, output_name: \"humidities\", output_empty_results: false }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":960,"wires":[["922c7bedcaa4c0c1"]],"l":false},{"id":"922c7bedcaa4c0c1","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":155,"y":960,"wires":[["e91ca429e83b68f4"]],"l":false},{"id":"e91ca429e83b68f4","type":"function","z":"27148b7bb9f62ac7","name":"set humidities","func":"let msgs = []\n\nfor (let humidity of msg.humidities) {\n    msgs.push({ ...humidity, new_state: humidity.state })\n}\n\nreturn [msgs];","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":960,"wires":[["b2915f476ac505ea"]]},{"id":"b2915f476ac505ea","type":"link out","z":"27148b7bb9f62ac7","name":"link out 645","mode":"link","links":["234ee90c5f77c82d"],"x":395,"y":960,"wires":[]},{"id":"625143d7bd1c5349","type":"function","z":"27148b7bb9f62ac7","name":"set illuminances","func":"let regex = /^\\d+(\\.\\d+)?$/\nlet areas = {}\nlet msgs = []\n\nfor (let entity of msg.entities) {\n    if (regex.test(entity.state)) {\n        if (!(entity.linked_area in areas)) {\n            areas[entity.linked_area] = { linked_entity: entity.linked_entity, states: [] }\n            areas[entity.linked_area][\"states\"].push(entity.state)\n        } else {\n            areas[entity.linked_area][\"states\"].push(entity.state)\n        }\n    }\n}\n\nfor (let keys of Object.keys(areas)) {\n    msgs.push({\n        linked_area: keys,\n        linked_entity: areas[keys][\"linked_entity\"],\n        state: areas[keys][\"states\"].reduce((ps, a) => ps + a, 0) / areas[keys][\"states\"].length\n    })\n}\n\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":1020,"wires":[["498a8cd2533e8dc2"]]},{"id":"b90a16d2d2491c28","type":"link in","z":"27148b7bb9f62ac7","name":"","links":["673a65ab8604e879"],"x":55,"y":1020,"wires":[["098b94853134acdc"]]},{"id":"098b94853134acdc","type":"function","z":"27148b7bb9f62ac7","name":"illuminances >","func":"msg.search = { \"is\": { linked_class: \"illuminance\" }, \"not\": { state: [\"unknown\", \"unvailable\"] } }\nmsg.output_name = \"entities\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":1020,"wires":[["d4a129f8504181ad"]],"l":false},{"id":"d4a129f8504181ad","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":155,"y":1020,"wires":[["625143d7bd1c5349"]],"l":false},{"id":"498a8cd2533e8dc2","type":"link out","z":"27148b7bb9f62ac7","name":"link out 646","mode":"link","links":["e6b62a2a7c263a5c"],"x":395,"y":1020,"wires":[]},{"id":"21a1f657810aba41","type":"inject","z":"27148b7bb9f62ac7","name":"@ 4:00","props":[],"repeat":"","crontab":"00 04 * * *","once":false,"onceDelay":0.1,"topic":"","x":1000,"y":380,"wires":[["1d97dd5683519b2b"]]},{"id":"1d97dd5683519b2b","type":"link out","z":"27148b7bb9f62ac7","name":"@ 4:00","mode":"link","links":["b6c5db515d78d2b6","61d1172bbcfedfe7","fd1fb5e279e78938"],"x":1095,"y":380,"wires":[]},{"id":"b6c5db515d78d2b6","type":"link in","z":"27148b7bb9f62ac7","name":"link in 569","links":["1d97dd5683519b2b"],"x":1155,"y":320,"wires":[["856c82e57e2036eb"]]},{"id":"f5c8ab48043055e2","type":"inject","z":"27148b7bb9f62ac7","name":"1 min","props":[{"p":"linked_class","v":"time","vt":"str"}],"repeat":"","crontab":"*/1 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":990,"y":440,"wires":[["d2b2ad544804ea48"]]},{"id":"d2b2ad544804ea48","type":"link out","z":"27148b7bb9f62ac7","name":"every 1 min","mode":"link","links":["1ffec2a6d7c88635"],"x":1075,"y":440,"wires":[]},{"id":"9b1acccc63940f12","type":"comment","z":"27148b7bb9f62ac7","name":"Global context management","info":"","x":160,"y":720,"wires":[]},{"id":"44fa70f8a6e9ee7f","type":"link in","z":"27148b7bb9f62ac7","name":"ambiances restore","links":["673a65ab8604e879"],"x":55,"y":840,"wires":[["9bac672d23ed969a"]]},{"id":"9bac672d23ed969a","type":"function","z":"27148b7bb9f62ac7","name":"get persons >","func":"return { search: { \"is\": { linked_class: \"person\" } }, output_name: \"persons\", output_empty_results: true }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":840,"wires":[["27144fcd3d6f6519"]],"l":false},{"id":"27144fcd3d6f6519","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":155,"y":840,"wires":[["e640455f8c30530d"]],"l":false},{"id":"bd30c0f99d8b1339","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["673a65ab8604e879"],"x":55,"y":1080,"wires":[["30a7e0f8c804142b"]]},{"id":"30a7e0f8c804142b","type":"function","z":"27148b7bb9f62ac7","name":"lights >","func":"msg.search = { \"is\": { linked_class: \"light_control\" } }\nmsg.output_name = \"light_controls\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":1080,"wires":[["8fa2c71c07ef99cd"]],"l":false},{"id":"8fa2c71c07ef99cd","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":155,"y":1080,"wires":[["80637300fbe0daae"]],"l":false},{"id":"80637300fbe0daae","type":"function","z":"27148b7bb9f62ac7","name":"set light control","func":"let light_control = global.get(\"light_control\") ?? {}\n\nclean_unknown_controller()\nfor (let lc of msg.light_controls) {\n    if (!light_control[\"locked\"]) {\n        light_control[\"locked\"] = []\n    }\n    if (!light_control[\"controller\"]) {\n        light_control[\"controller\"] = {}\n    }\n    if (!light_control[\"controller\"][lc.entity_id]) {\n        light_control[\"controller\"][lc.entity_id] = {\n            action: \"auto\",\n            color_temp_step: 3,\n            brightness_step: 3,\n            hs_color_step: [0, 100]\n        }\n    }\n}\n\nglobal.set(\"light_control\", light_control)\n\nfunction clean_unknown_controller() {\n    for (let key of Object.keys(light_control[\"controller\"] ?? {})) {\n        if (!msg.light_controls.find(lc => lc.entity_id === key)) {\n            delete light_control[\"controller\"][key]\n        }\n    }\n}","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":1080,"wires":[]},{"id":"fe5df31cc9854e11","type":"link in","z":"27148b7bb9f62ac7","name":"link in 586","links":["5a948d8bd3b54aed","d2ad8fee4ac5d1fb"],"x":105,"y":640,"wires":[["3bc3a5a58e60b298"]]},{"id":"d2ad8fee4ac5d1fb","type":"link out","z":"27148b7bb9f62ac7","name":"link out 674","mode":"link","links":["fe5df31cc9854e11","c655288765abd1cb"],"x":1235,"y":1020,"wires":[]},{"id":"e881e34c38a2aaa8","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"reset_global_node_red","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.reset_global_node_red","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":935,"y":960,"wires":[["bfb77e3c2b89b0cb","0341de3f831e32be"],[]],"l":false},{"id":"bfb77e3c2b89b0cb","type":"api-call-service","z":"27148b7bb9f62ac7","name":"reset_global_node_red off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.reset_global_node_red"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":995,"y":960,"wires":[[]],"l":false},{"id":"657b147e332b38e2","type":"file","z":"27148b7bb9f62ac7","name":"","filename":"/config/notifications.yaml","filenameType":"str","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1090,"y":1020,"wires":[["d2ad8fee4ac5d1fb"]]},{"id":"d38ab85c71302031","type":"link out","z":"27148b7bb9f62ac7","name":"link out 3","mode":"link","links":["85f8e62cdb55c3b1"],"x":1415,"y":960,"wires":[]},{"id":"85f8e62cdb55c3b1","type":"link in","z":"27148b7bb9f62ac7","name":"link in 3","links":["d38ab85c71302031"],"x":935,"y":1020,"wires":[["657b147e332b38e2"]]},{"id":"c655288765abd1cb","type":"link in","z":"27148b7bb9f62ac7","name":"link in 4","links":["d2ad8fee4ac5d1fb"],"x":415,"y":180,"wires":[["a938cb7f0804c121"]]},{"id":"cffe0e2536d5c760","type":"function","z":"27148b7bb9f62ac7","name":"set distances","func":"let distances = {}\nlet persons = msg.persons\nlet wifis = msg.wifis\n\nfor (let p of persons) {\n    let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\n    if (typeof p.attributes.latitude === \"number\" && typeof p.attributes.longitude === \"number\") {\n        let lat1 = zone_home.latitude\n        let lon1 = zone_home.longitude\n        let lat2 = p.attributes.latitude\n        let lon2 = p.attributes.longitude\n        distances[p.entity_id] = calculateDistance(lat1, lon1, lat2, lon2)\n    } else {\n        let wifi = wifis.filter(w => w.linked_person === p.entity_id)\n        if (wifi.length > 0) {\n            let home_wifis = wifi[0].home_wifis\n            let state = wifi[0].state\n            if (home_wifis.includes(state)) {\n                distances[p.entity_id] = 0\n            } else {\n                distances[p.entity_id] = (zone_home.radius + 1)\n            }\n        }\n    }\n}\nglobal.set(\"distances\", distances)\n\nfunction calculateDistance(lat1, lon1, lat2, lon2) {\n    let R = 6371e3\n    lat1 = lat1 * (Math.PI / 180)\n    lon1 = lon1 * (Math.PI / 180)\n    lat2 = lat2 * (Math.PI / 180)\n    lon2 = lon2 * (Math.PI / 180)\n    let dlat = lat2 - lat1\n    let dlon = lon2 - lon1\n    let a = Math.pow(Math.sin(dlat / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(dlon / 2), 2)\n    let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))\n    let d = R * c\n    return Math.round(d)\n}","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":840,"wires":[]},{"id":"e640455f8c30530d","type":"function","z":"27148b7bb9f62ac7","name":"get persons >","func":"return { ...msg, search: { \"is\": { linked_class: \"wifi\" } }, output_name: \"wifis\", output_empty_results: true }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":215,"y":840,"wires":[["aeba7c422358748e"]],"l":false},{"id":"aeba7c422358748e","type":"subflow:3da7ebfd83a38899","z":"27148b7bb9f62ac7","name":"","x":265,"y":840,"wires":[["cffe0e2536d5c760"]],"l":false},{"id":"5f4db6b30339ef01","type":"function","z":"27148b7bb9f62ac7","name":"msgs","func":"return { payload: { data: { entity_id: msg.speakers.map(s => s.entity_id), volume_level: msg.volume_level } } }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":440,"wires":[["617a047ddfae7a15"]]},{"id":"a938cb7f0804c121","type":"function","z":"27148b7bb9f62ac7","name":"recap","func":"let notifications = global.get(\"notifications\") ?? {}\nlet notifications_keys = Object.keys(notifications)\nlet msgs = []\nlet txt = \"\"\n\nlet d = new Date()\nlet current_month = d.getMonth() + 1\nlet current_day = d.getDate()\n\nlet home_invitation = get_state(\"input_boolean.home_invitation\") == \"on\"\nif (home_invitation) {\n    txt += \"<center><h2>Mode invitation actif \" + (notifications_keys.length == 0 ? \"‚úÖ\" : \":\") + \"</h2>\"\n} else {\n    txt += \"<center><h2>Notifications \" + (notifications_keys.length == 0 ? \"‚úÖ\" : \":\") + \"</h2>\"\n}\n\nlet first = true\nlet alert_priority = { \"error\": 1, \"warning\": 2, \"success\": 3, \"info\": 4 }\nnotifications_keys.sort(function (a, b) { return alert_priority[notifications[a].alert_type] - alert_priority[notifications[b].alert_type] })\nfor (let key of notifications_keys) {\n    if (notifications[key].alert_type) {\n        txt += (!first ? '<br>' : '') + '<ha-alert alert-type=\"' + notifications[key].alert_type + '\" >' + date_to_display(notifications[key].creation_date) + notifications[key].message + \"</ha-alert>\"\n    } else {\n        txt += notifications[key].title\n    }\n    first = false\n}\ntxt += \"</center>\"\n\nlet gap = 0\nfor (let i = 0; i < 10; i++) {\n    msgs.push({\n        payload: {\n            data: {\n                entity_id: \"input_text.notification_\" + (i + 1),\n                value: txt.substring(gap, (gap + 254))\n            }\n        }\n    })\n    gap += 254\n}\nreturn [msgs]\n\nfunction get_state(entity_id) {\n    if (entity_id in global.get(\"homeassistant\").homeAssistant.states) {\n        return global.get(\"homeassistant\").homeAssistant.states[entity_id].state\n    } else {\n        return \"\"\n    }\n}\n\nfunction date_to_display(notif_creation_date) {\n    let month_trad_fr = {\n        1: \"Janvier\",\n        2: \"F√©vrier\",\n        3: \"Mars\",\n        4: \"Avril\",\n        5: \"Mai\",\n        6: \"Juin\",\n        7: \"Juillet\",\n        8: \"Ao√ªt\",\n        9: \"Septembre\",\n        10: \"Octobre\",\n        11: \"Novembre\",\n        12: \"D√©cembre\"\n    }\n\n    let notifCreationDateSplit = notif_creation_date.split(\" \")\n    let notifMonth = parseInt(notifCreationDateSplit[0])\n    let notifDay = parseInt(notifCreationDateSplit[1])\n    let notifHour = notifCreationDateSplit[2]\n\n    if (current_day == notifDay && current_month == notifMonth) {\n        return notifHour + \" : \"\n    } else if (current_day - notifDay == 1 && current_month == notifMonth) {\n        return \"Hier √† \" + notifHour + \" : \"\n    } else if (current_day - notifDay == 2 && current_month == notifMonth) {\n        return \"Avant-hier √† \" + notifHour + \" : \"\n    } else {\n        return \"Le \" + notifDay + \" \" + month_trad_fr[notifMonth] + \" √† \" + notifHour + \" : \"\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":180,"wires":[["b2117e5ba2e72803"]]},{"id":"b2117e5ba2e72803","type":"api-call-service","z":"27148b7bb9f62ac7","name":"recap","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":630,"y":180,"wires":[[]]},{"id":"292c825d3b1d166e","type":"function","z":"27148b7bb9f62ac7","name":"default volume level","func":"let functions = global.get(\"functions\") ?? {}\nmsg.volume_level = functions[\"get_volume_level\"]()\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":380,"wires":[["e6a5d9c5bd5ca872"]]},{"id":"e6a5d9c5bd5ca872","type":"link out","z":"27148b7bb9f62ac7","name":"link out 9","mode":"link","links":["f43a379928cdb87c"],"x":595,"y":380,"wires":[]},{"id":"b273581a17bb234c","type":"link in","z":"27148b7bb9f62ac7","name":"link in 9","links":["d661cc3406383257"],"x":315,"y":380,"wires":[["292c825d3b1d166e"]]},{"id":"617a047ddfae7a15","type":"api-call-service","z":"27148b7bb9f62ac7","name":"volume set","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":440,"wires":[[]]},{"id":"85b15961ad5d5814","type":"function","z":"27148b7bb9f62ac7","name":"functions","func":"let functions = {}\n\nfunctions[\"hm_txt_to_min_int\"] = function hm_txt_to_min_int(txt) {\n    txt = txt.split(\":\").map(s => parseInt(s))\n    return txt[0] * 60 + txt[1]\n}\n\nfunctions[\"get_current_minutes\"] = function get_current_minutes() {\n    let date = new Date()\n    return date.getHours() * 60 + date.getMinutes()\n}\n\nfunctions[\"get_volume_level\"] = function get_volume_level() {\n    let sdm = functions[\"hm_txt_to_min_int\"](global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_day_mode_start\"].state)\n    let snm = functions[\"hm_txt_to_min_int\"](global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_night_mode_start\"].state)\n    let sdv = parseFloat(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_day_mode_volume\"].state)\n    let snv = parseFloat(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_night_mode_volume\"].state)\n    let current_minutes = functions[\"get_current_minutes\"]()\n    return (sdm <= current_minutes && current_minutes < snm ? sdv : snv) / 100\n}\n\nfunctions[\"get_persons_sport\"] = function get_persons_sport(persons) {\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    return persons.filter(p =>\n        home_configuration[p.sport] &&\n        home_configuration[p.sport].days_to_ojective &&\n        home_configuration[p.sport].objective_limits &&\n        home_configuration[p.sport].objective_calendar)\n        .map(p => ({ ...p, sport: home_configuration[p.sport] }))\n}\n\nfunctions[\"is_in_home_zone\"] = function is_in_home_zone() {\n    let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\n    let distances = global.get(\"distances\") ?? {}\n    let min_distance = Math.min(...Object.keys(distances).map(a => distances[a]))\n    return min_distance <= zone_home.radius\n}\n\nglobal.set(\"functions\", functions)\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":640,"wires":[["673a65ab8604e879"]]},{"id":"42c6f3e251025e88","type":"link call","z":"27148b7bb9f62ac7","name":"","links":["04a97112197d0e34"],"linkType":"static","timeout":"30","x":480,"y":640,"wires":[["85b15961ad5d5814"]]},{"id":"9a2954c4d8c5353d","type":"catch","z":"b0a488ea822145cf","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["8021f0f27fb5cd7f"]]},{"id":"8dd11e268884ab9a","type":"subflow:ad3b29a5dd67898f","z":"b0a488ea822145cf","name":"","x":460,"y":40,"wires":[["afccfcc67ca22c62"]]},{"id":"8021f0f27fb5cd7f","type":"change","z":"b0a488ea822145cf","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Inputs","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8dd11e268884ab9a"]]},{"id":"e3da1f773a813694","type":"server-events","z":"b0a488ea822145cf","name":"state_changed","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"state_changed","eventData":"","waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":120,"y":180,"wires":[["0b7500ea5c30d381","68d0f3dde93b0c04"]]},{"id":"f4f272db588afc8c","type":"function","z":"b0a488ea822145cf","name":"merge home configuration","func":"let notAcceptedStates = [\"none\", \"unavailable\", \"unknown\", \"\"]\nlet new_state = msg.event?.new_state?.state\nlet old_state = msg.event?.old_state?.state\n\nnew_state = notAcceptedStates.includes(new_state.toLowerCase()) ? undefined : new_state\nold_state = notAcceptedStates.includes(old_state.toLowerCase()) ? undefined : old_state\n\nmsg = {\n    ...msg.entities[0],\n    new_state: format_state(new_state),\n    old_state: format_state(old_state),\n    attributes: msg.event?.new_state?.attributes\n}\n\nreturn msg\n\nfunction format_state(state) {\n    return typeof state === \"undefined\" ? null : isNaN(state) ? state : parseFloat(state)\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":180,"wires":[["35834f876d14830a"]]},{"id":"35834f876d14830a","type":"link out","z":"b0a488ea822145cf","name":"link out 557","mode":"link","links":["3bfee2fb76d9aa7c","93a4cd9dcd47133c","ee03bb71d931132b","172727433576b0a4","848b54066f08d3c9","335f89b173aca00d","19cd9a8c1409d3ce","2b26dd0bb627eadf","9887e88aa919963c","162a7c1d9e51be9d","235e6643ff9fc367","c2f7e9c0a2bd6765","c7ac29241a013736","4fdf4eec8a131dc2","bb5c2975d68741f9","c7e9f5694d2e4512","5d13f593ea5ab652"],"x":1325,"y":180,"wires":[]},{"id":"1efa7c0f6d0198aa","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":1270,"y":380,"wires":[]},{"id":"6cf5484ebaf1776b","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":1270,"y":500,"wires":[]},{"id":"0646f3d0a39edf83","type":"link out","z":"b0a488ea822145cf","name":"detect cover","mode":"link","links":["54097f118e4479e1"],"x":1325,"y":620,"wires":[]},{"id":"3bfee2fb76d9aa7c","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":620,"wires":[["11e02d5d042c4dcd"]]},{"id":"11e02d5d042c4dcd","type":"switch","z":"b0a488ea822145cf","name":"cover","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"cover","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":620,"wires":[["0646f3d0a39edf83"]]},{"id":"da6208c061cdc94f","type":"function","z":"b0a488ea822145cf","name":"set","func":"let acceptedStates = [\"on\", \"off\"]\n\nif (acceptedStates.includes(msg.old_state) && acceptedStates.includes(msg.new_state) && msg.old_state != msg.new_state) {\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":740,"wires":[["0dac8a656e626a27"]]},{"id":"93a4cd9dcd47133c","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":740,"wires":[["05e6efa3f0799cad"]]},{"id":"05e6efa3f0799cad","type":"switch","z":"b0a488ea822145cf","name":"window","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"window","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":740,"wires":[["da6208c061cdc94f"]]},{"id":"0dac8a656e626a27","type":"link out","z":"b0a488ea822145cf","name":"detect windows","mode":"link","links":["f4d57076103097ca","820d17520ea5b902","30dd2decd1225b89","b4a9828334ecb95c"],"x":1325,"y":740,"wires":[]},{"id":"d6b63ae28e7cc0de","type":"function","z":"b0a488ea822145cf","name":"initialize light","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet light_control = global.get(\"light_control\") ?? {}\nlet motion_areas = global.get(\"motion_areas\") ?? {}\n\nif (msg.old_state === null && [\"on\", \"off\"].includes(msg.new_state)) {\n    if (in_home_zone && Array.isArray(light_control[\"locked\"]) && (!(light_control[\"locked\"].includes(msg.entity_id)))) {\n        let state = motion_areas[msg.linked_area] ?? \"off\"\n        msg = { linked_area: msg.linked_area, state: state }\n        return [msg, null]\n    } else {\n        msg = { entity_id: msg.entity_id, state: \"off\" }\n        return [null, msg]\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":980,"wires":[["c18b36325001bf4a"],["c9402e052dee3456"]]},{"id":"a54be99d7e32ea7c","type":"link out","z":"b0a488ea822145cf","name":"detect light","mode":"link","links":["13a390949bac6841"],"x":1325,"y":980,"wires":[]},{"id":"c9402e052dee3456","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":650,"y":980,"wires":[]},{"id":"ee03bb71d931132b","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":980,"wires":[["90d791834e5c48a6"]]},{"id":"90d791834e5c48a6","type":"switch","z":"b0a488ea822145cf","name":"light","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"light","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":980,"wires":[["422f29ee726f03ce"]]},{"id":"efb358c26bdb79cf","type":"server-events","z":"b0a488ea822145cf","name":"cube bluetooth","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"xiaomi_aqara.cube_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"x":120,"y":1160,"wires":[["25fa42326af36855"]]},{"id":"25e352984b33cace","type":"switch","z":"b0a488ea822145cf","name":"cube","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"cube","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":450,"y":1160,"wires":[["7a9965c4d48673b7"]]},{"id":"172727433576b0a4","type":"link in","z":"b0a488ea822145cf","name":"link in 514","links":["35834f876d14830a","0cf11232ebd2a229"],"x":355,"y":1160,"wires":[["25e352984b33cace"]]},{"id":"9560131ccbbc20d7","type":"link out","z":"b0a488ea822145cf","name":"ambiance","mode":"link","links":["57970c88e211ce04"],"x":1325,"y":1340,"wires":[]},{"id":"29553ac9da1f61c0","type":"switch","z":"b0a488ea822145cf","name":"ambiance","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"ambiance","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":1340,"wires":[["9560131ccbbc20d7"]]},{"id":"848b54066f08d3c9","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1340,"wires":[["29553ac9da1f61c0"]]},{"id":"7a9965c4d48673b7","type":"switch","z":"b0a488ea822145cf","name":"zigbee","property":"linked_type","propertyType":"msg","rules":[{"t":"eq","v":"zigbee","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":570,"y":1160,"wires":[["dfe0821b605be8ee"]]},{"id":"dfe0821b605be8ee","type":"function","z":"b0a488ea822145cf","name":"cube >","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\n\nif (in_home_zone) {\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    if (msg.entity_id in home_configuration) {\n        msg.search = { \"is\": { entity_id: msg.entity_id } }\n        msg.output_name = \"entities\"\n        msg.output_empty_results = false\n        return msg\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":1160,"wires":[["b1e9e1d83b415194"]]},{"id":"550ba74f65825b54","type":"link out","z":"b0a488ea822145cf","name":"detect persons position","mode":"link","links":["7da2c8f60353d65e"],"x":1325,"y":1460,"wires":[]},{"id":"335f89b173aca00d","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1460,"wires":[["eca8c0360552140b"]]},{"id":"eca8c0360552140b","type":"switch","z":"b0a488ea822145cf","name":"person","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"person","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":1460,"wires":[["4a7e3c543181506d"]]},{"id":"61c0d8738882ce35","type":"link out","z":"b0a488ea822145cf","name":"security intrusion","mode":"link","links":["9167a2922e77622b","e7dde5b3b80ffc59","f93c04cbad0bf8ca","274ee0b1b3961d93"],"x":1325,"y":2060,"wires":[]},{"id":"75b04fc1276a4aaf","type":"subflow:d193bde43bd55f9f","z":"b0a488ea822145cf","name":"","x":1240,"y":2180,"wires":[]},{"id":"1abcc2cc00495b3f","type":"subflow:723d4991c3c87385","z":"b0a488ea822145cf","name":"","x":750,"y":1820,"wires":[]},{"id":"af01780a5f7c39bd","type":"function","z":"b0a488ea822145cf","name":"set","func":"let acceptedStates = [\"on\", \"off\"]\n\nif (\n    msg.security_intrusion    \n    && acceptedStates.includes(msg.new_state)\n    && acceptedStates.includes(msg.old_state)\n    && msg.old_state !== msg.new_state\n) {\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":2060,"wires":[["61c0d8738882ce35"]]},{"id":"09937216bea66806","type":"link out","z":"b0a488ea822145cf","name":"illuminance","mode":"link","links":["42bcf58ce90dbbb4"],"x":1325,"y":1820,"wires":[]},{"id":"2b26dd0bb627eadf","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":2060,"wires":[["99b97679308cb2f6"]]},{"id":"99b97679308cb2f6","type":"switch","z":"b0a488ea822145cf","name":"security_intrusion","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"motion","vt":"str"},{"t":"eq","v":"window","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":190,"y":2060,"wires":[["af01780a5f7c39bd"],["af01780a5f7c39bd"]]},{"id":"9887e88aa919963c","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":2180,"wires":[["9cfeb3b918c756fb"]]},{"id":"9cfeb3b918c756fb","type":"switch","z":"b0a488ea822145cf","name":"remote","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"remote","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":2180,"wires":[["75b04fc1276a4aaf"]]},{"id":"0b7500ea5c30d381","type":"link out","z":"b0a488ea822145cf","name":"link out 560","mode":"link","links":["787f22bbb5e68f17"],"x":235,"y":180,"wires":[]},{"id":"1218e3ec64eb94c5","type":"server-events","z":"b0a488ea822145cf","name":"","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"emulate","eventData":"","waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"x":120,"y":240,"wires":[["1b4ce3b5d6a85c4a"]]},{"id":"ca23d8dc73b439db","type":"function","z":"b0a488ea822145cf","name":"merge home configuration","func":"msg = {\n    ...msg.entities[0],\n    ...msg.event\n}\n\ndelete msg.state\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":240,"wires":[["0cf11232ebd2a229"]]},{"id":"0cf11232ebd2a229","type":"link out","z":"b0a488ea822145cf","name":"link out 581","mode":"link","links":["3bfee2fb76d9aa7c","93a4cd9dcd47133c","ee03bb71d931132b","172727433576b0a4","848b54066f08d3c9","335f89b173aca00d","19cd9a8c1409d3ce","2b26dd0bb627eadf","9887e88aa919963c","162a7c1d9e51be9d","235e6643ff9fc367","c2f7e9c0a2bd6765","c7ac29241a013736","4fdf4eec8a131dc2","bb5c2975d68741f9","c7e9f5694d2e4512","5d13f593ea5ab652"],"x":1325,"y":240,"wires":[]},{"id":"68d0f3dde93b0c04","type":"function","z":"b0a488ea822145cf","name":"get linked home configuration","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet new_state_exist = msg.event.new_state?.state !== undefined\nlet old_state_exist = msg.event.old_state?.state !== undefined\n\nif (home_configuration[msg.event.entity_id] && new_state_exist && old_state_exist) {\n    msg.search = { \"is\": { entity_id: msg.event.entity_id } }\n    msg.output_name = \"entities\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":295,"y":180,"wires":[["6366e1743deffe6c"]],"l":false},{"id":"6366e1743deffe6c","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":355,"y":180,"wires":[["f4f272db588afc8c"]],"l":false},{"id":"1b4ce3b5d6a85c4a","type":"function","z":"b0a488ea822145cf","name":"get linked home configuration","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (home_configuration[msg.event.entity_id]) {\n    msg.search = { \"is\": { entity_id: msg.event.entity_id } }\n    msg.output_name = \"entities\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":235,"y":240,"wires":[["e69933ba68f3f0f0"]],"l":false},{"id":"e69933ba68f3f0f0","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":295,"y":240,"wires":[["ca23d8dc73b439db"]],"l":false},{"id":"1599e4c62adba050","type":"comment","z":"b0a488ea822145cf","name":"ext_temperature / int_temperature","info":"","x":170,"y":320,"wires":[]},{"id":"621b77d8aa86c81e","type":"comment","z":"b0a488ea822145cf","name":"inputs","info":"","x":90,"y":120,"wires":[]},{"id":"5ec93dbddb2e7056","type":"comment","z":"b0a488ea822145cf","name":"cover","info":"","x":80,"y":560,"wires":[]},{"id":"7985ae54827f461d","type":"comment","z":"b0a488ea822145cf","name":"window","info":"","x":90,"y":680,"wires":[]},{"id":"b50a16da905ce77f","type":"comment","z":"b0a488ea822145cf","name":"motion","info":"","x":90,"y":800,"wires":[]},{"id":"8dc6b4683c3b9923","type":"comment","z":"b0a488ea822145cf","name":"light","info":"","x":90,"y":920,"wires":[]},{"id":"18d5d22f76506ee5","type":"comment","z":"b0a488ea822145cf","name":"ambiance_select","info":"","x":120,"y":1280,"wires":[]},{"id":"ed2f4e57d3244cbf","type":"comment","z":"b0a488ea822145cf","name":"person","info":"","x":90,"y":1400,"wires":[]},{"id":"750b60fe3f0abf20","type":"comment","z":"b0a488ea822145cf","name":"illuminance","info":"","x":100,"y":1760,"wires":[]},{"id":"260c7f73d002d3a7","type":"comment","z":"b0a488ea822145cf","name":"motion / window : security_intrusion","info":"","x":180,"y":2000,"wires":[]},{"id":"fef5a36e958c1671","type":"comment","z":"b0a488ea822145cf","name":"remote","info":"","x":90,"y":2120,"wires":[]},{"id":"566194fc20b61a47","type":"function","z":"b0a488ea822145cf","name":"set global illuminance","func":"let illuminances = global.get(\"illuminances\") ?? {}\nlet low_light_compensation_changed = false\nlet linked_area = msg.linked_area\nlet smooth_intensity = 10\n\nif (!illuminances[linked_area]) {\n    illuminances[linked_area] = {}\n}\n\nlet value = illuminances[linked_area].value ?? msg.state\nlet mean_value = Math.round((value * smooth_intensity + msg.state) / (smooth_intensity + 1))\n\nif (linked_area == \"exterior\") {\n    let low_light_compensation = global.get('homeassistant').homeAssistant.states[\"input_boolean.low_light_compensation\"].state == \"on\"\n    let low_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.low_light_compensation\"].state)\n    let low_light_compensation_on = low_light_compensation && mean_value < low_light && illuminances[linked_area].value > low_light\n    let low_light_compensation_off = low_light_compensation && mean_value > low_light && illuminances[linked_area].value < low_light\n    low_light_compensation_changed = low_light_compensation_on || low_light_compensation_off\n}\n\nilluminances[linked_area].value = mean_value\nilluminances[linked_area].last_changed = new Date().getTime()\nglobal.set(\"illuminances\", illuminances)\n\nmsg = { entity_id: msg.linked_entity, state: mean_value }\nreturn [msg, low_light_compensation_changed ? msg : null]","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":1820,"wires":[["1abcc2cc00495b3f"],["e70a19df90211863"]]},{"id":"787f22bbb5e68f17","type":"link in","z":"b0a488ea822145cf","name":"link in 547","links":["0b7500ea5c30d381","bd7327a592af6bb2"],"x":55,"y":2300,"wires":[["27c53efb62c51ceb"]]},{"id":"27c53efb62c51ceb","type":"subflow:94b2243985840d69","z":"b0a488ea822145cf","name":"","x":170,"y":2300,"wires":[["85772ad627bc24ea"]]},{"id":"a09d12c110a553ed","type":"comment","z":"b0a488ea822145cf","name":"devices control","info":"","x":120,"y":2240,"wires":[]},{"id":"5dcebeddf5b32d66","type":"link out","z":"b0a488ea822145cf","name":"devices_control","mode":"link","links":["549b31dea7b04ede"],"x":1325,"y":2300,"wires":[]},{"id":"162a7c1d9e51be9d","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":375,"y":860,"wires":[["deae08494ca1fb51"]]},{"id":"92343d20b8540180","type":"link out","z":"b0a488ea822145cf","name":"detect motion","mode":"link","links":["13a390949bac6841","f4d57076103097ca","b4a9828334ecb95c","b8a0fcb9b7fad5b2","f93c04cbad0bf8ca"],"x":1325,"y":860,"wires":[]},{"id":"aef1a6b2007498d6","type":"comment","z":"b0a488ea822145cf","name":"calendar","info":"","x":100,"y":2360,"wires":[]},{"id":"235e6643ff9fc367","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":2420,"wires":[["b5f3ccef4ad662c9"]]},{"id":"b5f3ccef4ad662c9","type":"switch","z":"b0a488ea822145cf","name":"calendar","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"calendar","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":2420,"wires":[["9cf514dd34319d19"]]},{"id":"9cf514dd34319d19","type":"function","z":"b0a488ea822145cf","name":"send to","func":"if (msg.state == \"on\") {\n    let date = msg.attributes.start_time.split(\" \")[1].substring(0, 5)\n    msg.message = \"üìÖ \" + (msg.alias ?? \"\") + \" > \" + msg.attributes.message + \" (\" + date + \")\"\n    msg.send_to = msg.send_to ?? []\n    msg.send_mobile = true\n    return [msg, is_devices_control(msg.attributes.description)]\n}\n\nfunction is_devices_control(description) {\n    let regex = /devices_control:\"([^\"]*)\"/\n    if (regex.test(description)) {\n        return {\n            event: {\n                entity_id: description.match(regex)[1],\n                new_state: { state: msg.new_state },\n                old_state: { state: msg.old_state }\n            }\n        }\n    }\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":2420,"wires":[["ece3d6c1b9192908"],["bd7327a592af6bb2"]]},{"id":"b90ed62f72230b1c","type":"subflow:ba09e97f2ed22f2b","z":"b0a488ea822145cf","name":"","x":1280,"y":2420,"wires":[]},{"id":"4e10803fb2f557fd","type":"comment","z":"b0a488ea822145cf","name":"light_control","info":"","x":110,"y":1040,"wires":[]},{"id":"c60396b3e499709a","type":"switch","z":"b0a488ea822145cf","name":"light_control","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"light_control","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":1100,"wires":[["9a196cb3e194a8ab"]]},{"id":"c2f7e9c0a2bd6765","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1100,"wires":[["c60396b3e499709a"]]},{"id":"3b7de15728946212","type":"link out","z":"b0a488ea822145cf","name":"link out 622","mode":"link","links":["42bcf58ce90dbbb4"],"x":755,"y":1100,"wires":[]},{"id":"afccfcc67ca22c62","type":"link out","z":"b0a488ea822145cf","name":"link out 629","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"5adb550d03cec5e4","type":"switch","z":"b0a488ea822145cf","name":"temperature","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"temperature","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":380,"wires":[["3798cb343a274dc6"]]},{"id":"c7ac29241a013736","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":380,"wires":[["5adb550d03cec5e4"]]},{"id":"9e9c2f8c8eac3f9d","type":"switch","z":"b0a488ea822145cf","name":"humidity","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"humidity","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":160,"y":500,"wires":[["23d07eecba5873ae"]]},{"id":"4fdf4eec8a131dc2","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":500,"wires":[["9e9c2f8c8eac3f9d"]]},{"id":"5d79149953d36ac8","type":"function","z":"b0a488ea822145cf","name":"set global","func":"let temperature_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state)\nlet temperature_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state)\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nlet linked_area = msg.linked_area\nlet value = msg.new_state\n\nif (!temp_hum[linked_area]) { temp_hum[linked_area] = {} }\nif (!temp_hum[linked_area][\"temperature\"] || isNaN(temp_hum[linked_area][\"temperature\"].value) || isNaN(temp_hum[linked_area][\"temperature\"].mean_hour)) {\n    temp_hum[linked_area][\"temperature\"] = { value: value, mean_hour: value, last_changed: new Date().getTime() }\n}\n\nlet timeElapsed = parseInt((new Date().getTime() - temp_hum[linked_area][\"temperature\"].last_changed) / 1000)\nlet mean_10min = meanCalc(timeElapsed, 600, value, temp_hum[linked_area][\"temperature\"].value)\nlet mean_hour = meanCalc(timeElapsed, 3600, mean_10min, temp_hum[linked_area][\"temperature\"].mean_hour)\nlet mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000\n\ntemp_hum[linked_area][\"temperature\"].high = temperature_max <= (Math.ceil(10 * mean_10min) / 10)\ntemp_hum[linked_area][\"temperature\"].low = (Math.ceil(10 * mean_10min) / 10) <= temperature_min\ntemp_hum[linked_area][\"temperature\"].last_changed = new Date().getTime()\ntemp_hum[linked_area][\"temperature\"].tendency = mean_hour_tendency\ntemp_hum[linked_area][\"temperature\"].mean_hour = mean_hour\ntemp_hum[linked_area][\"temperature\"].value = mean_10min\ntemp_hum[linked_area].alias = msg.alias ?? msg.linked_area\n\nglobal.set(\"temp_hum\", temp_hum)\nmsg = { entity_id: msg.linked_entity, state: mean_10min }\nreturn msg\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":380,"wires":[["1efa7c0f6d0198aa"]]},{"id":"1980150051f652af","type":"function","z":"b0a488ea822145cf","name":"set global","func":"let humidity_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state)\nlet humidity_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state)\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nlet linked_area = msg.linked_area\nlet value = msg.new_state\n\nif (!temp_hum[linked_area]) { temp_hum[linked_area] = {} }\nif (!temp_hum[linked_area][\"humidity\"] || isNaN(temp_hum[linked_area][\"humidity\"].value) || isNaN(temp_hum[linked_area][\"humidity\"].mean_hour)) {\n    temp_hum[linked_area][\"humidity\"] = { value: value, mean_hour: value, last_changed: new Date().getTime() }\n}\n\nlet timeElapsed = parseInt((new Date().getTime() - temp_hum[linked_area][\"humidity\"].last_changed) / 1000)\nlet mean_10min = meanCalc(timeElapsed, 600, value, temp_hum[linked_area][\"humidity\"].value)\nlet mean_hour = meanCalc(timeElapsed, 3600, mean_10min, temp_hum[linked_area][\"humidity\"].mean_hour)\nlet mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000\n\ntemp_hum[linked_area][\"humidity\"].high = humidity_max <= (Math.ceil(10 * mean_10min) / 10)\ntemp_hum[linked_area][\"humidity\"].low = (Math.ceil(10 * mean_10min) / 10) <= humidity_min\ntemp_hum[linked_area][\"humidity\"].last_changed = new Date().getTime()\ntemp_hum[linked_area][\"humidity\"].tendency = mean_hour_tendency\ntemp_hum[linked_area][\"humidity\"].mean_hour = mean_hour\ntemp_hum[linked_area][\"humidity\"].value = mean_10min\ntemp_hum[linked_area].alias = msg.alias\n\nglobal.set(\"temp_hum\", temp_hum)\nmsg = { entity_id: msg.linked_entity, state: mean_10min }\nreturn msg\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":500,"wires":[["6cf5484ebaf1776b"]]},{"id":"bf1ce289202dfbe9","type":"comment","z":"b0a488ea822145cf","name":"ext_humidity / int_humidity","info":"","x":150,"y":440,"wires":[]},{"id":"23d07eecba5873ae","type":"switch","z":"b0a488ea822145cf","name":"number ?","property":"new_state","propertyType":"msg","rules":[{"t":"istype","v":"number","vt":"number"}],"checkall":"true","repair":false,"outputs":1,"x":360,"y":500,"wires":[["1980150051f652af"]]},{"id":"3798cb343a274dc6","type":"switch","z":"b0a488ea822145cf","name":"number ?","property":"new_state","propertyType":"msg","rules":[{"t":"istype","v":"number","vt":"number"}],"checkall":"true","repair":false,"outputs":1,"x":380,"y":380,"wires":[["5d79149953d36ac8"]]},{"id":"bb5c2975d68741f9","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1820,"wires":[["ac8cb7423ab96d04"]]},{"id":"ac8cb7423ab96d04","type":"switch","z":"b0a488ea822145cf","name":"illuminance","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"illuminance","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":1820,"wires":[["69278b3d6a3c1012"]]},{"id":"ea91ddb293af9f71","type":"link in","z":"b0a488ea822145cf","name":"link in 565","links":["30c50903518c6ad6"],"x":275,"y":380,"wires":[["3798cb343a274dc6"]]},{"id":"234ee90c5f77c82d","type":"link in","z":"b0a488ea822145cf","name":"link in 566","links":["b2915f476ac505ea"],"x":255,"y":500,"wires":[["23d07eecba5873ae"]]},{"id":"e6b62a2a7c263a5c","type":"link in","z":"b0a488ea822145cf","name":"link in 567","links":["498a8cd2533e8dc2"],"x":275,"y":1820,"wires":[["69278b3d6a3c1012"]]},{"id":"25fa42326af36855","type":"function","z":"b0a488ea822145cf","name":"cube >","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\n\nif (in_home_zone) {\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    if (msg.payload.entity_id in home_configuration) {\n        msg.search = { \"is\": { entity_id: msg.payload.entity_id } }\n        msg.output_name = \"entities\"\n        msg.output_empty_results = false\n        msg = { ...msg, ...msg.payload.event }\n        return msg\n    }\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":1160,"wires":[["b1e9e1d83b415194"]]},{"id":"b1e9e1d83b415194","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":775,"y":1160,"wires":[["a0a80c06c470d351"]],"l":false},{"id":"a0a80c06c470d351","type":"function","z":"b0a488ea822145cf","name":"set cube","func":"return { ...msg, ...msg.entities[0] }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":1160,"wires":[["48e5e839efb80607"]]},{"id":"20befc698c560a64","type":"link out","z":"b0a488ea822145cf","name":"link out 665","mode":"link","links":["7d14141bb9531d26"],"x":1325,"y":1160,"wires":[]},{"id":"7d14141bb9531d26","type":"link in","z":"b0a488ea822145cf","name":"link in 585","links":["20befc698c560a64"],"x":465,"y":1100,"wires":[["21590737a96aa2f3"]]},{"id":"48e5e839efb80607","type":"function","z":"b0a488ea822145cf","name":"get action","func":"let light_control = global.get(\"light_control\") ?? {}\nlet msgs_actions = []\nlet msgs_lights = []\n\nif (light_control[\"controller\"]?.[msg.entity_id] && msg.listen !== undefined && Array.isArray(msg.listen)) {\n    for (let l of msg.listen) {\n        let s = l[\"if\"] ? l[\"if\"].replaceAll(\" \", \"\").split(\"=\") : []\n        if (s.length > 0) {\n            if (msg[s[0]] === s[1] && l[\"then\"] && l[\"for\"]) {\n                msgs_lights.push(set_msg(l[\"then\"], l[\"for\"]))\n            } else if (typeof msg[s[0]] === \"number\" && l[\"then\"] && l[\"for\"]) {\n                let val = msg[s[0]] > 0 ? \"pos_val\" : \"neg_val\"\n                if (l[\"if\"].replaceAll(\" \", \"\") === (s[0] + \"=\" + val)) {\n                    msgs_lights.push(set_msg(s[1] === msg[s[0]] > 0 ? l[\"then\"] : l[\"then\"], l[\"for\"]))\n                }\n            } else if (msg[s[0]] === s[1] && l[\"then\"]) {\n                msgs_actions.push({ then: l[\"then\"] })\n            }\n        }\n    }\n    return [msgs_lights, msgs_actions]\n}\n\nfunction set_msg(action, linked_lights) {\n    return {\n        search: { \"is\": { linked_class: \"light\", entity_id: linked_lights } },\n        output_name: \"lights\",\n        output_empty_results: false,\n        action: action,\n        controller: msg.entity_id,\n        linked_area: msg.linked_area\n    }\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1020,"y":1160,"wires":[["587f7fe3de1203b2"],["0bd215ba7b8e1569"]]},{"id":"9a196cb3e194a8ab","type":"function","z":"b0a488ea822145cf","name":"get action","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet light_control = global.get(\"light_control\") ?? {}\nlet msgs_actions = []\nlet msgs_lights = []\n\nif (in_home_zone && light_control[\"controller\"]?.[msg.entity_id] && msg.listen !== undefined && Array.isArray(msg.listen)) {\n    for (let l of msg.listen) {\n        let s = l[\"if\"] ? l[\"if\"].replaceAll(\" \", \"\").split(\"=\") : []\n        if (s.length > 0 && msg[s[0]] === s[1] && l[\"then\"] && l[\"for\"]) {\n            msgs_lights.push({\n                search: { \"is\": { linked_class: \"light\", entity_id: l[\"for\"] } },\n                output_name: \"lights\",\n                output_empty_results: false,\n                action: l[\"then\"],\n                controller: msg.entity_id,\n                transition: l[\"transition\"] ?? 1\n            })\n        } else if (s.length > 0 && msg[s[0]] === s[1] && l[\"then\"]) {\n            msgs_actions.push({ then: l[\"then\"] })\n        }\n    }\n    return [msgs_lights, msgs_actions]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":1100,"wires":[["d35d94441c13c6dc"],["52fc40d8d193d75b"]]},{"id":"21590737a96aa2f3","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":525,"y":1100,"wires":[["c2a8af57fc4d7710"]],"l":false},{"id":"c2a8af57fc4d7710","type":"function","z":"b0a488ea822145cf","name":"set light_control","func":"let light_control = global.get(\"light_control\") ?? {}\nlet transition = msg.transition\nlet controller = msg.controller\n\nif (light_control[\"controller\"][controller]) {\n    let lights = msg.lights.map(l => l.entity_id)\n    let action = msg.action\n    let msgs = []\n\n    if (action.includes(\"auto_\")) {\n        action = [\"on\", \"off\"].includes(light_control[\"controller\"][controller].action) ? \"auto\" : action.replace(\"auto_\", \"\")\n    }\n\n    if (action === \"auto\") {\n        // reset\n        light_control[\"controller\"][controller].action = \"auto\"\n        unlock_lights()\n    } else {\n        // toggle / turn_on / turn_off\n        if ([\"toggle\", \"turn_on\", \"turn_off\"].includes(action)) {\n            let c_state = light_control[\"controller\"][controller].action\n            c_state = c_state === \"auto\" && action === \"toggle\" ?\n                lights.filter(l => l.state == \"on\").length >= lights.filter(l => l.state == \"off\").length ? \"on\" : \"off\" :\n                action === \"toggle\" ? { \"on\": \"off\", \"off\": \"on\" }[c_state] : (action === \"turn_on\" ? \"on\" : \"off\")\n            c_state = action === \"toggle\" ? (msg.lights.filter(l => l.state === \"on\").length >= msg.lights.filter(l => l.state === \"off\").length ? \"off\" : \"on\") : action === \"turn_on\" ? \"on\" : \"off\"\n            light_control[\"controller\"][controller].action = c_state\n            msgs.push({ domain: \"light\", service: c_state !== \"toggle\" ? (\"turn_\" + c_state) : c_state, payload: { data: { entity_id: lights, transition: transition } } })\n            lock_lights()\n        }\n        // brightness_step_up / brightness_step_down / brightness_step_loop\n        else if (action.includes(\"brightness_step_\")) {\n            let x = light_control[\"controller\"][controller].brightness_step\n            x = action.includes(\"_down\") ? (x - 1 < 1 ? 1 : x - 1) : (x + 1 > 5 ? (action.includes(\"_loop\") ? 1 : 5) : x + 1)\n            light_control[\"controller\"][controller].brightness_step = x\n            light_control[\"controller\"][controller].action = \"on\"\n            msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: lights, brightness_pct: formula([1, 100], x), transition: transition } } })\n            lock_lights()\n        }\n        // color_temp_step_up / color_temp_step_down / color_temp_step_loop\n        else if (action.includes(\"color_temp_step_\")) {\n            let x = light_control[\"controller\"][controller].color_temp_step\n            x = action.includes(\"_down\") ? (x - 1 < 1 ? 1 : x - 1) : (x + 1 > 5 ? (action.includes(\"_loop\") ? 1 : 5) : x + 1)\n            light_control[\"controller\"][controller].color_temp_step = x\n            light_control[\"controller\"][controller].action = \"on\"\n            msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: lights, color_temp_kelvin: formula([2250, 6500], x), transition: transition } } })\n            lock_lights()\n        }\n        // color_step_up / color_step_down / color_step_loop\n        else if (action.includes(\"color_step_\") && light_control[\"controller\"][controller].hs_color_step) {\n            let x = light_control[\"controller\"][controller].hs_color_step\n            x[0] = action.includes(\"_down\") ? (x[0] - 30 < 0 ? 330 : x[0] - 30) : (x[0] + 30 > 360 ? 30 : x[0] + 30)\n            light_control[\"controller\"][controller].hs_color_step = x\n            light_control[\"controller\"][controller].action = \"on\"\n            let light_f = msg.lights.filter(l => l.attributes.supported_color_modes.find(c => [\"xy\", \"hs\", \"rgb\"].includes(c))).map(l => l.entity_id)\n            msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: light_f, hs_color: x, transition: transition } } })\n            lock_lights()\n        }\n        // saturation_step_up / saturation_step_down\n        else if (action.includes(\"saturation_step_\") && light_control[\"controller\"][controller].hs_color_step) {\n            let x = light_control[\"controller\"][controller].hs_color_step\n            x[1] = action.includes(\"_down\") ? (x[1] - 25 < 0 ? (action.includes(\"_loop\") ? 100 : 0) : x[1] - 25) : (x[1] + 25 > 100 ? (action.includes(\"_loop\") ? 0 : 100) : x[1] + 25)\n            light_control[\"controller\"][controller].hs_color_step = x\n            light_control[\"controller\"][controller].action = \"on\"\n            let light_f = msg.lights.filter(l => l.attributes.supported_color_modes.find(c => [\"xy\", \"hs\", \"rgb\"].includes(c))).map(l => l.entity_id)\n            msgs.push({ domain: \"light\", service: \"turn_on\", payload: { data: { entity_id: light_f, hs_color: x, transition: transition } } })\n            lock_lights()\n        }\n    }\n    global.set(\"light_control\", light_control)\n\n    if (action === \"auto\") {\n        return [null, {}]\n    } else if (msgs.length > 0) {\n        return [msgs, null]\n    }\n}\n\nfunction formula(range, number) {\n    let step = (range[1] - range[0]) / 4\n    return range[0] + step * (number - 1)\n}\n\nfunction lock_lights() {\n    let lights = msg.lights.map(l => l.entity_id)\n    light_control[\"locked\"] = [...new Set(light_control[\"locked\"].concat(lights))]\n}\n\nfunction unlock_lights() {\n    let lights = msg.lights.map(l => l.entity_id)\n    light_control[\"locked\"] = light_control[\"locked\"].filter(l => (!lights.includes(l)))\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":1100,"wires":[["14758b74ee13a9ea"],["3b7de15728946212"]]},{"id":"52fc40d8d193d75b","type":"link out","z":"b0a488ea822145cf","name":"link out 666","mode":"link","links":["f5d01cdf10d12c3a"],"x":415,"y":1100,"wires":[]},{"id":"0bd215ba7b8e1569","type":"link out","z":"b0a488ea822145cf","name":"link out 667","mode":"link","links":["f5d01cdf10d12c3a"],"x":1115,"y":1160,"wires":[]},{"id":"ce1aa5c4ed4e04c9","type":"comment","z":"b0a488ea822145cf","name":"wifi","info":"","x":90,"y":1520,"wires":[]},{"id":"c7e9f5694d2e4512","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1580,"wires":[["47eb132467d62c4d"]]},{"id":"47eb132467d62c4d","type":"switch","z":"b0a488ea822145cf","name":"wifi","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"wifi","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":1580,"wires":[["e537ee8c44aa8b0d"]]},{"id":"e006bba39fce3f3a","type":"link out","z":"b0a488ea822145cf","name":"link out 676","mode":"link","links":["7da2c8f60353d65e"],"x":1325,"y":1580,"wires":[]},{"id":"e537ee8c44aa8b0d","type":"function","z":"b0a488ea822145cf","name":"set wifi","func":"let linked_person = msg.linked_person ?? \"\"\nlet home_wifis = msg.home_wifis ?? []\nlet state = msg.state\n\nif (linked_person !== \"\") {\n    if (home_wifis.includes(state)) {\n        return { entity_id: msg.linked_person, payload: 0 }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":1580,"wires":[["f678d3495c0c1c8b"]]},{"id":"19cd9a8c1409d3ce","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1700,"wires":[["d399d5e266fa5c55"]]},{"id":"d399d5e266fa5c55","type":"switch","z":"b0a488ea822145cf","name":"next_alarm","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"next_alarm","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":1700,"wires":[["10fb88bc37292594"]]},{"id":"7932b23dc9612a70","type":"comment","z":"b0a488ea822145cf","name":"next_alarm","info":"","x":100,"y":1640,"wires":[]},{"id":"4a2b42ec1876278b","type":"link out","z":"b0a488ea822145cf","name":"link out 649","mode":"link","links":["693e35cd8fbdc9c5"],"x":1325,"y":1700,"wires":[]},{"id":"10fb88bc37292594","type":"delay","z":"b0a488ea822145cf","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1265,"y":1700,"wires":[["4a2b42ec1876278b"]],"l":false},{"id":"69278b3d6a3c1012","type":"switch","z":"b0a488ea822145cf","name":"number ?","property":"state","propertyType":"msg","rules":[{"t":"istype","v":"number","vt":"number"}],"checkall":"true","repair":false,"outputs":1,"x":380,"y":1820,"wires":[["566194fc20b61a47"]]},{"id":"bd7327a592af6bb2","type":"link out","z":"b0a488ea822145cf","name":"link out 2","mode":"link","links":["787f22bbb5e68f17"],"x":395,"y":2420,"wires":[]},{"id":"d30d20c20c316f5e","type":"link out","z":"b0a488ea822145cf","name":"security panel","mode":"link","links":["eb70da8382aa8954"],"x":1325,"y":1940,"wires":[]},{"id":"5d13f593ea5ab652","type":"link in","z":"b0a488ea822145cf","name":"","links":["35834f876d14830a","0cf11232ebd2a229"],"x":55,"y":1940,"wires":[["6744e0826aa58bed"]]},{"id":"6744e0826aa58bed","type":"switch","z":"b0a488ea822145cf","name":"security_panel","property":"linked_class","propertyType":"msg","rules":[{"t":"eq","v":"security_panel","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":180,"y":1940,"wires":[["65cfbb4ca7add26d"]]},{"id":"22be91556c4eb2b2","type":"comment","z":"b0a488ea822145cf","name":"security_panel","info":"","x":110,"y":1880,"wires":[]},{"id":"65cfbb4ca7add26d","type":"function","z":"b0a488ea822145cf","name":"set","func":"if (msg.new_state && Array.isArray(msg.code)) {\n    return {\n        arming_time: msg.arming_time ?? 30,\n        code: msg.code,\n        states: msg.new_state\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":1940,"wires":[["d30d20c20c316f5e"]]},{"id":"7f9fddd04b1feee7","type":"function","z":"b0a488ea822145cf","name":"set distances","func":"let distances = global.get(\"distances\") ?? {}\nlet person = msg.entity_id\n\nif (distances[person] !== undefined && msg.payload === \"unknown\") {\n    delete distances[person]\n    global.set(\"distances\", distances)\n} else if (distances[person] !== msg.payload) {\n    distances[person] = msg.payload\n    global.set(\"distances\", distances)\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":1460,"wires":[["550ba74f65825b54"]]},{"id":"4a7e3c543181506d","type":"function","z":"b0a488ea822145cf","name":"calculate distance","func":"let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\nif (msg.new_state === \"home\") {\n    msg.payload = 0\n} else if (typeof msg.attributes.latitude === \"number\" && typeof msg.attributes.longitude === \"number\") {\n    let lat1 = zone_home.latitude\n    let lon1 = zone_home.longitude\n    let lat2 = msg.attributes.latitude\n    let lon2 = msg.attributes.longitude\n    msg.payload = calculateDistance(lat1, lon1, lat2, lon2)\n} else if (msg.new_state === \"not_home\") {\n    msg.payload = (zone_home.radius + 1)\n} else if (msg.state === \"unknown\") {\n    msg.payload = \"unknown\"\n}\nreturn msg\n\nfunction calculateDistance(lat1, lon1, lat2, lon2) {\n    let R = 6371e3\n    lat1 = lat1 * (Math.PI / 180)\n    lon1 = lon1 * (Math.PI / 180)\n    lat2 = lat2 * (Math.PI / 180)\n    lon2 = lon2 * (Math.PI / 180)\n    let dlat = lat2 - lat1\n    let dlon = lon2 - lon1\n    let a = Math.pow(Math.sin(dlat / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(dlon / 2), 2)\n    let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))\n    let d = R * c\n    return Math.round(d)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":1460,"wires":[["7f9fddd04b1feee7"]]},{"id":"f678d3495c0c1c8b","type":"function","z":"b0a488ea822145cf","name":"set distances","func":"let distances = global.get(\"distances\") ?? {}\nlet person = msg.entity_id\n\nif (distances[person] !== msg.payload) {\n    distances[person] = msg.payload\n    global.set(\"distances\", distances)\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":1580,"wires":[["e006bba39fce3f3a"]]},{"id":"deae08494ca1fb51","type":"function","z":"b0a488ea822145cf","name":"set motions","func":"if (msg.linked_class === \"motion\" && msg.linked_area) {\n    let acceptedStates = [\"on\", \"off\"]\n    let new_state = state_converter(msg.new_state)\n    let old_state = state_converter(msg.old_state)\n\n    if (acceptedStates.includes(old_state) && acceptedStates.includes(new_state) && old_state != new_state) {\n        let motion_state = msg.inverted_motion ? { \"on\": \"off\", \"off\": \"on\" }[new_state] : new_state\n        let motion_areas = global.get(\"motion_areas\") ?? {}\n        let motions = flow.get(\"motions\") ?? {}\n        let msgs = []\n\n        set_motion(motions, motion_state)\n        if (motion_state === \"on\") {\n            motion_areas[msg.linked_area] = \"on\"\n            msgs.push({ linked_area: msg.linked_area, state: motion_state, linked_class: msg.linked_class, alias: msg.alias })\n            let last_motion_area = Object.keys(motion_areas).filter(m => motion_areas[m] === \"last\")\n\n            if (last_motion_area.length === 1 && last_motion_area[0] !== msg.linked_area) {\n                motion_areas[last_motion_area[0]] = \"off\"\n                msgs.push({ linked_area: last_motion_area[0], state: \"off\", linked_class: msg.linked_class, alias: msg.alias })\n            }\n\n            global.set(\"motion_areas\", motion_areas)\n            return [msgs]\n\n        } else if (motion_state === \"off\") {            \n            let area_state = Object.keys(motions).filter(m => motions[m].linked_area === msg.linked_area)\n                .map(m => motions[m].state).reduce((a, b) => a || b === \"on\", false)\n            if (!area_state) {\n                let last_area_on = Object.keys(motion_areas).filter(m => motion_areas[m] === \"on\")\n\n                if (last_area_on.length === 1 && last_area_on[0] === msg.linked_area) {\n                    motion_areas[msg.linked_area] = \"last\"\n                    msgs.push({ linked_area: msg.linked_area, state: \"last\", linked_class: msg.linked_class, alias: msg.alias })\n                } else {\n                    motion_areas[msg.linked_area] = \"off\"\n                    msgs.push({ linked_area: msg.linked_area, state: \"off\", linked_class: msg.linked_class, alias: msg.alias })\n                }\n\n                global.set(\"motion_areas\", motion_areas)\n                return [msgs]\n\n            }\n        }\n    }\n}\n\nfunction state_converter(state) {\n    let convert = {\n        \"has one\": \"on\",\n        \"no one\": \"off\",\n        \"on\": \"on\",\n        \"off\": \"off\"\n    }\n    return convert[state]\n}\n\nfunction set_motion(motions, state) {\n    motions[msg.entity_id] = { linked_area: msg.linked_area, state: state }\n    flow.set(\"motions\", motions)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":860,"wires":[["92343d20b8540180"]]},{"id":"d5127e4d8cdbc647","type":"subflow:3da7ebfd83a38899","z":"b0a488ea822145cf","name":"","x":155,"y":860,"wires":[["2b04a4f19304e695"]],"l":false},{"id":"2b04a4f19304e695","type":"function","z":"b0a488ea822145cf","name":"reset motion","func":"let areas = [...new Set(msg.motions.map(a => a.linked_area))]\nlet ha_motions = msg.motions\nlet motion_areas = {}\nlet motions = {}\n\nfor (let m of ha_motions) {\n    let state = [\"on\", \"off\"].includes(m.state) ? (m.inverted_motion ? { \"on\": \"off\", \"off\": \"on\" }[m.state] : m.state) : \"off\"\n    motions[m.entity_id] = { linked_area: m.linked_area, state: state }\n}\n\nfor (let a of areas) {\n    motion_areas[a] = ha_motions.filter(m => m.linked_area === a)\n        .map(m => (m.inverted_motion ? { \"on\": \"off\", \"off\": \"on\" }[m.state] : m.state))\n        .reduce((a, b) => a === \"on\" || b === \"on\", false)\n    motion_areas[a] = motion_areas[a] ? \"on\" : \"off\"\n}\n\nglobal.set(\"motion_areas\", motion_areas)\nflow.set(\"motions\", motions)\n\nreturn msg","outputs":0,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":860,"wires":[]},{"id":"eec7f9eb929d0c53","type":"link in","z":"b0a488ea822145cf","name":"persons restore","links":["673a65ab8604e879"],"x":55,"y":860,"wires":[["f3326575b5b09d6d"]]},{"id":"f3326575b5b09d6d","type":"function","z":"b0a488ea822145cf","name":"motions >","func":"msg = {\n    search: { \"is\": { linked_class: \"motion\" } },\n    output_name: \"motions\",\n    output_empty_results: false\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":860,"wires":[["d5127e4d8cdbc647"]],"l":false},{"id":"9449d331aa43d268","type":"api-call-service","z":"b0a488ea822145cf","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1290,"y":1100,"wires":[[]]},{"id":"85772ad627bc24ea","type":"function","z":"b0a488ea822145cf","name":"set","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet devices_controls = home_configuration.devices_controls ?? {}\nlet entity_id = msg.event?.new_state?.entity_id\nlet state = msg.event?.new_state?.state\n\nif (typeof devices_controls === \"object\" && entity_id && state && devices_controls[entity_id]) {\n    return { control_device: devices_controls[entity_id], entity_id: entity_id, state: state, id: Object.keys(devices_controls).indexOf(entity_id) }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":2300,"wires":[["5dcebeddf5b32d66"]]},{"id":"422f29ee726f03ce","type":"api-current-state","z":"b0a488ea822145cf","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":310,"y":980,"wires":[["d6b63ae28e7cc0de"],[]]},{"id":"58b8139a5867cb5e","type":"server-events","z":"b0a488ea822145cf","name":"listen google assistant","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"google_assistant_command","eventData":"","waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"x":140,"y":1220,"wires":[["bd7ab411a8904ea9"]]},{"id":"cad6cdcc9bdc86ef","type":"function","z":"b0a488ea822145cf","name":"lock/unlock light","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet controlled_lights = home_configuration[\"google_assistant_lights_control\"] ?? []\nlet light_control = global.get(\"light_control\") ?? {}\nlet params = msg.event?.execution[0]?.params ?? {}\nlet event_lights = msg.event?.entity_id ?? []\n\nlet auto = false\nif (params) {\n    for (let l of event_lights) {\n        if (controlled_lights.includes(l)) {\n            if (params.brightness === 42) {\n                unlock_light(l)\n                auto = true\n            } else {\n                lock_light(l)\n            }\n        }\n    }\n}\n\nglobal.set(\"light_control\", light_control)\nreturn auto ? {} : null\n\nfunction lock_light(light) {\n    if (!(light_control[\"locked\"].includes(light))) {\n        light_control[\"locked\"].push(light)\n    }\n}\n\nfunction unlock_light(light) {\n    if (light_control[\"locked\"].includes(light)) {\n        light_control[\"locked\"] = light_control[\"locked\"].filter(l => l !== light)\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":1220,"wires":[["be9f8b854ee6a2a6"]]},{"id":"be9f8b854ee6a2a6","type":"link out","z":"b0a488ea822145cf","name":"link out 11","mode":"link","links":["42bcf58ce90dbbb4"],"x":1325,"y":1220,"wires":[]},{"id":"bd7ab411a8904ea9","type":"subflow:e6ac576fb4598283","z":"b0a488ea822145cf","name":"","x":330,"y":1220,"wires":[["cad6cdcc9bdc86ef"],[]]},{"id":"db7b44b22cfa2756","type":"catch","z":"37a14665cffc94c1","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["3d7cf23d290e327c"]]},{"id":"737d0883f5f2221e","type":"subflow:ad3b29a5dd67898f","z":"37a14665cffc94c1","name":"","x":460,"y":40,"wires":[["787aaaf006230051"]]},{"id":"3d7cf23d290e327c","type":"change","z":"37a14665cffc94c1","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Presence","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["737d0883f5f2221e"]]},{"id":"bb8dc2d2062d1568","type":"comment","z":"37a14665cffc94c1","name":"Zones detect","info":"","x":110,"y":1100,"wires":[]},{"id":"520ca2ed81231521","type":"function","z":"37a14665cffc94c1","name":"notification","func":"if (msg.payload > 0 && (msg.zone[0].google_keep_list ?? false)) {\n    return {\n        title: \"Voici votre liste de courses\",\n        data: { clickAction: msg.zone[0].google_keep_list },\n        send_mobile: true\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":1160,"wires":[["7348b2174728424a"]]},{"id":"7348b2174728424a","type":"subflow:ba09e97f2ed22f2b","z":"37a14665cffc94c1","name":"","x":640,"y":1160,"wires":[]},{"id":"9167a2922e77622b","type":"link in","z":"37a14665cffc94c1","name":"security","links":["61c0d8738882ce35"],"x":55,"y":640,"wires":[["52298d5ac66e1a71"]]},{"id":"0e40f01bc0b5092c","type":"comment","z":"37a14665cffc94c1","name":"Presence","info":"","x":100,"y":120,"wires":[]},{"id":"7d939e8a2c828e55","type":"comment","z":"37a14665cffc94c1","name":"Invitation","info":"","x":100,"y":260,"wires":[]},{"id":"4046698483d897c4","type":"server-state-changed","z":"37a14665cffc94c1","name":"min_distance","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_number.min_distance","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"0","ifStateType":"num","ifStateOperator":"gte","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"min_distance","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":440,"wires":[["8fd56d1af4604d7c"],[]]},{"id":"67103c040ae2342c","type":"server-state-changed","z":"37a14665cffc94c1","name":"detect zones","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"^zone.","entityIdType":"regex","outputInitially":true,"stateType":"num","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":110,"y":1160,"wires":[["f4cf26b557376fcd"]]},{"id":"5866108da2b5a1cd","type":"subflow:3da7ebfd83a38899","z":"37a14665cffc94c1","name":"","x":335,"y":1160,"wires":[["05f39d148f56b5bd"]],"l":false},{"id":"f4cf26b557376fcd","type":"function","z":"37a14665cffc94c1","name":"zone > ","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (home_configuration[msg.data.entity_id]) {\n    msg.topic = msg.data.entity_id\n    msg.search = { \"is\": { entity_id: msg.data.entity_id } }\n    msg.output_name = \"zone\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":1160,"wires":[["5866108da2b5a1cd"]]},{"id":"05f39d148f56b5bd","type":"delay","z":"37a14665cffc94c1","name":"","pauseType":"queue","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":385,"y":1160,"wires":[["520ca2ed81231521"]],"l":false},{"id":"72648161fc232069","type":"server-state-changed","z":"37a14665cffc94c1","name":"invitation / in_home_zone","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_boolean.invitation","input_boolean.in_home_zone"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":150,"y":320,"wires":[["6cbb8dae36b367cc"]]},{"id":"e7dde5b3b80ffc59","type":"link in","z":"37a14665cffc94c1","name":"security","links":["61c0d8738882ce35"],"x":55,"y":380,"wires":[["a0f5d82b326c9bcc"]]},{"id":"9e637246c723d00e","type":"switch","z":"37a14665cffc94c1","name":"invitation_off","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"invitation_off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":595,"y":440,"wires":[["9713d3d7fd31b627"]],"l":false},{"id":"6f353d1a4b15fe21","type":"link out","z":"37a14665cffc94c1","name":"link out 15","mode":"link","links":["e53334a6f05a9609"],"x":1015,"y":440,"wires":[]},{"id":"30db20f1f5067f4a","type":"function","z":"37a14665cffc94c1","name":"notification","func":"return { notification_id: \"invitation\", dismiss: true } ","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":440,"wires":[["6f353d1a4b15fe21"]]},{"id":"9713d3d7fd31b627","type":"api-call-service","z":"37a14665cffc94c1","name":"home_invitation off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.invitation"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":440,"wires":[["30db20f1f5067f4a"]]},{"id":"40831e3e531ca313","type":"server-events","z":"37a14665cffc94c1","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":490,"y":440,"wires":[["9e637246c723d00e"]]},{"id":"f93c04cbad0bf8ca","type":"link in","z":"37a14665cffc94c1","name":"security","links":["61c0d8738882ce35","92343d20b8540180"],"x":475,"y":380,"wires":[["2972aab5c4042d22"]]},{"id":"7f2daf532e6af454","type":"function","z":"37a14665cffc94c1","name":"notification","func":"flow.set(\"wait_no_motion\", false)\n\nreturn {\n    notification_id: \"invitation\",\n    title: \"Mode invit√©\",\n    alert_type: \"success\",\n    message: \"L'invit√© est parti\",\n    data: { actions: [{ \"action\": \"invitation_off\", \"title\": \"D√©sactiver mode invit√©\" }] },\n    send_mobile: true\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":380,"wires":[["40e112a841309a8c"]]},{"id":"40e112a841309a8c","type":"link out","z":"37a14665cffc94c1","name":"link out 16","mode":"link","links":["e53334a6f05a9609"],"x":955,"y":380,"wires":[]},{"id":"787aaaf006230051","type":"link out","z":"37a14665cffc94c1","name":"link out 20","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"eb70da8382aa8954","type":"link in","z":"37a14665cffc94c1","name":"control panel","links":["d30d20c20c316f5e"],"x":55,"y":580,"wires":[["f46381ee5e49c774"]]},{"id":"016f3ff0be777998","type":"join","z":"37a14665cffc94c1","name":"","mode":"custom","build":"array","property":"states","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"10","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":635,"y":580,"wires":[["85ddebd0abcbb86b"]],"l":false},{"id":"43e072c42e1ab089","type":"trigger","z":"37a14665cffc94c1","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":true,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":400,"y":580,"wires":[["cf8dcc501374f796"]]},{"id":"cf8dcc501374f796","type":"function","z":"37a14665cffc94c1","name":"complete","func":"return { complete: \"\" }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":580,"wires":[["016f3ff0be777998"]]},{"id":"5e9bd8aacd7f1450","type":"comment","z":"37a14665cffc94c1","name":"Security","info":"","x":100,"y":520,"wires":[]},{"id":"85ddebd0abcbb86b","type":"function","z":"37a14665cffc94c1","name":"validate code ","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet security_alarm = global.get('homeassistant').homeAssistant.states[\"input_text.security_alarm\"].state\n\nif (msg.code.length === msg.states.length) {\n    let is_valid = msg.code.join(\"\") === msg.states.join(\"\")\n    if (is_valid) {\n        if (in_home_zone && security_alarm !== \"arming\") {\n            return [null, { entity_id: \"input_text.security_alarm\", state: \"arming\" }]\n        } else {\n            return [null, { entity_id: \"input_text.security_alarm\", state: \"disarmed\" }]\n        }\n    } else {\n        let home_configuration = global.get(\"home_configuration\") ?? {}\n        let linked_lights = home_configuration?.security?.linked_lights ?? []\n        let security_alarm = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.security_alarm\"].state == \"on\"\n        let lights = []\n        if (security_alarm) {\n            set_lights_effect(300, 0, 1000, linked_lights, lights)\n        } else {\n            set_lights_effect(5, 15, 1000, linked_lights, lights)\n        }\n        return [lights, null]\n    }\n}\n\nfunction set_lights_effect(count, color, time, linked_lights, lights) {\n    if (linked_lights.length > 0) {\n        lights.push({ effects: { count: count, color: color, saturation: 100, time: time }, linked_lights: linked_lights })\n    }\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":580,"wires":[["65cd78fa3e9430d0"],["17512c25a893783c"]]},{"id":"c359aa69820f12fc","type":"server-state-changed","z":"37a14665cffc94c1","name":"security_alarm","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.security_alarm","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"security_alarm","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":820,"wires":[["8f2749c3412a9d9d"]]},{"id":"74e7be80a125945f","type":"function","z":"37a14665cffc94c1","name":"notification","func":"let security_alarm = msg.security_alarm\nlet msgs = []\n\nif ([\"wait_to_go\", \"armed\", \"wait_to_enter\"].includes(security_alarm)) {\n    msgs.push({ notification_id: \"security_intrusion\", alert_type: \"success\", message: \"Surveillance active üõ°Ô∏è\", send_mobile: false, data: {} })\n} else {\n    let security_intrusions = Object.keys(global.get(\"notifications\") ?? {}).filter(s => s.includes(\"security_intrusion_\"))\n    for (let s of security_intrusions) {\n        msgs.push({ notification_id: s, clear_on_phone: true, dismiss: true })\n    }\n    msgs.push({ notification_id: \"security_intrusion\", dismiss: true })\n}\n\nreturn [msgs]","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":820,"wires":[["5eae2e36c9800be4"]]},{"id":"5eae2e36c9800be4","type":"link out","z":"37a14665cffc94c1","name":"link out 22","mode":"link","links":["e53334a6f05a9609"],"x":635,"y":820,"wires":[]},{"id":"8ed021ef5338a438","type":"link out","z":"37a14665cffc94c1","name":"link out 25","mode":"link","links":["e53334a6f05a9609"],"x":715,"y":640,"wires":[]},{"id":"70266206d7e19058","type":"function","z":"37a14665cffc94c1","name":"security_alarm","func":"let security_alarm = global.get('homeassistant').homeAssistant.states[\"input_text.security_alarm\"].state\n\nif ([\"armed\"].includes(security_alarm) && msg.state === \"on\") {\n    let home_configuration = global.get(\"home_configuration\") ?? {}\n    let linked_lights = home_configuration?.security?.linked_lights ?? []\n\n    return [\n        {\n            notification_id: \"security_intrusion_\" + msg.linked_area + \"_\" + msg.linked_class,\n            title: \"‚ö†Ô∏è Intrusion ‚ö†Ô∏è\",\n            message: \"‚ö†Ô∏è D√©tection \" + (msg.linked_class === \"window\" ? \"ouverture \" : \"\") + msg.alias + \" ‚ö†Ô∏è\",\n            alert_type: \"error\",\n            send_mobile: true\n        },\n        { entity_id: \"input_boolean.security_alarm\", state: \"on\" },\n        { linked_lights: linked_lights, effects: { count: 300, color: 0, saturation: 100, time: 1000 } }\n    ]\n}","outputs":3,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":640,"wires":[["8ed021ef5338a438"],["64fb8b5cfdd30c01"],["6ebb87b93e0aaa3f"]]},{"id":"8fd56d1af4604d7c","type":"function","z":"37a14665cffc94c1","name":"person in home zone ?","func":"let invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\nlet zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\n\nif (invitation && msg.min_distance <= zone_home.radius) {\n    return msg\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":440,"wires":[["9713d3d7fd31b627"]]},{"id":"b8a0fcb9b7fad5b2","type":"link in","z":"37a14665cffc94c1","name":"security_alarm intrusion","links":["92343d20b8540180"],"x":55,"y":640,"wires":[["8ccef4f8fc1a3471"]]},{"id":"8ccef4f8fc1a3471","type":"api-current-state","z":"37a14665cffc94c1","name":"security_alarm ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.security_alarm","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":180,"y":640,"wires":[["52298d5ac66e1a71"],[]]},{"id":"8ec249191d96f387","type":"subflow:723d4991c3c87385","z":"37a14665cffc94c1","name":"","x":610,"y":320,"wires":[]},{"id":"52298d5ac66e1a71","type":"api-current-state","z":"37a14665cffc94c1","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":390,"y":640,"wires":[["70266206d7e19058"],[]]},{"id":"f46381ee5e49c774","type":"api-current-state","z":"37a14665cffc94c1","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":210,"y":580,"wires":[["43e072c42e1ab089","bb48fff78bfac166"],[]]},{"id":"8f2749c3412a9d9d","type":"api-current-state","z":"37a14665cffc94c1","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":330,"y":820,"wires":[["74e7be80a125945f"],[]]},{"id":"7d83a5dfec69027e","type":"server-state-changed","z":"37a14665cffc94c1","name":"module_security_intrusion","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_security_intrusion","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":150,"y":760,"wires":[["1825bb4669a5f764"]]},{"id":"d7dbe243d1afa5ca","type":"link out","z":"37a14665cffc94c1","name":"link out 26","mode":"link","links":["e53334a6f05a9609"],"x":615,"y":760,"wires":[]},{"id":"7f54f5a63fcf134a","type":"subflow:723d4991c3c87385","z":"37a14665cffc94c1","name":"","x":510,"y":760,"wires":[]},{"id":"7da2c8f60353d65e","type":"link in","z":"37a14665cffc94c1","name":"set nearest","links":["550ba74f65825b54","e006bba39fce3f3a","60d635f1979bc939"],"x":55,"y":180,"wires":[["92878b76fb92f23a"]]},{"id":"32558857ddd5adf5","type":"subflow:723d4991c3c87385","z":"37a14665cffc94c1","name":"","x":690,"y":180,"wires":[]},{"id":"c0162d93859e418d","type":"link out","z":"37a14665cffc94c1","name":"link out 10","mode":"link","links":["e53334a6f05a9609"],"x":455,"y":320,"wires":[]},{"id":"b3ce1f5cbb9dec97","type":"server-state-changed","z":"37a14665cffc94c1","name":"security_alarm","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.security_alarm","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"security_alarm","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":700,"wires":[["42edaa9e4acdb5f2"]]},{"id":"012b785158725afb","type":"subflow:723d4991c3c87385","z":"37a14665cffc94c1","name":"","x":770,"y":700,"wires":[]},{"id":"fbf4a55dacfc1757","type":"delay","z":"37a14665cffc94c1","name":"delay","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":655,"y":700,"wires":[["012b785158725afb"]],"l":false},{"id":"dad52d94e713ebe7","type":"function","z":"37a14665cffc94c1","name":"core","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet linked_lights = home_configuration?.security?.linked_lights ?? []\nlet arming_time = home_configuration?.security?.arming_time ?? 0\nlet functions = global.get(\"functions\") ?? {}\nlet person_in_home_zone = functions[\"is_in_home_zone\"]()\nlet security_alarm = msg.security_alarm\nlet home_notifs = []\nlet entities = []\nlet lights = []\n\nentities.push({ reset: \"reset\" })\nif (security_alarm === \"arming\") {\n    home_notifs.push({ speak: \"La maison va entr√©e en mode surveillance dans 30 secondes, aurevoir.\", volume_level: 0.58 })\n    lights.push({ linked_lights: linked_lights, effects: { count: 30, color: 240, saturation: 100, time: 1000 } })\n    entities.push({ entity_id: \"input_text.security_alarm\", state: person_in_home_zone ? \"wait_to_go\" : \"armed\", delay: arming_time * 1000 })\n    entities.push({ entity_id: \"input_boolean.invitation\", state: \"off\", delay: msg.arming_time * 1000 })\n} else if (security_alarm === \"armed\") {\n    entities.push({ entity_id: \"input_boolean.in_home_zone\", state: \"off\" })\n    entities.push({ entity_id: \"input_boolean.invitation\", state: \"off\" })\n} else if (security_alarm === \"disarmed\") {\n    home_notifs.push({ speak: \"Mode surveillance d√©sactiv√©. Bienvenue √† la maison.\", volume_level: 0.58 })\n    lights.push({ linked_lights: linked_lights, effects: { count: 5, color: 120, saturation: 100, time: 1000 } })\n    entities.push({ entity_id: \"input_boolean.in_home_zone\", state: \"on\" })\n    entities.push({ entity_id: \"input_boolean.security_alarm\", state: \"off\" })\n    entities.push({ entity_id: \"input_text.security_alarm\", state: \"disarmed\" })\n    if (!person_in_home_zone) {\n        entities.push({ entity_id: \"input_boolean.invitation\", state: \"on\" })\n    } else {\n        entities.push({ entity_id: \"input_boolean.invitation\", state: \"off\" })\n    }\n}\nreturn [entities, lights, home_notifs]","outputs":3,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":700,"wires":[["fbf4a55dacfc1757"],["e330c9d9b9909a11"],["f48d59c829ba1bfc"]]},{"id":"af45dbf01d2099c2","type":"subflow:5a05b9ac0289ff03","z":"37a14665cffc94c1","name":"","x":280,"y":880,"wires":[]},{"id":"e2280bdf634757c9","type":"function","z":"37a14665cffc94c1","name":"lights >","func":"msg.search = { \"is\": { entity_id: msg.linked_lights, state: [\"on\", \"off\"] } }\nmsg.output_name = \"linked_lights\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":105,"y":880,"wires":[["87dbb3f6ed7baf26"]],"l":false},{"id":"87dbb3f6ed7baf26","type":"subflow:3da7ebfd83a38899","z":"37a14665cffc94c1","name":"","x":155,"y":880,"wires":[["af45dbf01d2099c2"]],"l":false},{"id":"42edaa9e4acdb5f2","type":"api-current-state","z":"37a14665cffc94c1","name":"module_security_intrusion","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_security_intrusion","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":475,"y":700,"wires":[["dad52d94e713ebe7"],[]],"l":false},{"id":"4978fc1834ea0fd3","type":"subflow:723d4991c3c87385","z":"37a14665cffc94c1","name":"","x":950,"y":580,"wires":[]},{"id":"2972aab5c4042d22","type":"function","z":"37a14665cffc94c1","name":"invitate left home ?","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\nlet wait_no_motion = flow.get(\"wait_no_motion\") ?? false\nlet functions = global.get(\"functions\") ?? {}\nlet person_in_home_zone = functions[\"is_in_home_zone\"]()\n\nif (invitation && in_home_zone && !person_in_home_zone) {\n    if (msg.security_intrusion && msg.state === \"on\") {\n        flow.set(\"wait_no_motion\", true)\n        return msg\n    } else if (msg.state === \"on\" && wait_no_motion) {\n        flow.set(\"wait_no_motion\", false)\n        return { reset: \"reset\" }\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":380,"wires":[["690754069653b117"]]},{"id":"690754069653b117","type":"delay","z":"37a14665cffc94c1","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":735,"y":380,"wires":[["7f2daf532e6af454"]],"l":false},{"id":"a0f5d82b326c9bcc","type":"function","z":"37a14665cffc94c1","name":"invitate in home ?","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\nlet functions = global.get(\"functions\") ?? {}\nlet person_in_home_zone = functions[\"is_in_home_zone\"]()\n\nif (invitation && !person_in_home_zone && !in_home_zone && msg.state === \"on\") {\n    return { entity_id: \"input_boolean.in_home_zone\", state: \"on\" }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":380,"wires":[["af86234db114faae"]]},{"id":"af86234db114faae","type":"subflow:723d4991c3c87385","z":"37a14665cffc94c1","name":"","x":370,"y":380,"wires":[]},{"id":"aefb65f11baa698a","type":"function","z":"37a14665cffc94c1","name":"min_distance & security_alarm","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\nlet security_alarm = global.get(\"homeassistant\").homeAssistant.states[\"input_text.security_alarm\"].state\nlet alarm = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.security_alarm\"].state === \"on\"\nlet zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\nlet is_security_panel = msg.security_panels.length > 0\nlet distances = global.get(\"distances\") ?? {}\nlet min_distance = Math.min(...Object.keys(distances).map(a => distances[a]))\nlet msgs = []\n\nif (min_distance !== Infinity) {\n    msgs.push({ entity_id: \"input_number.min_distance\", state: min_distance })\n    if (!invitation && alarm && [\"armed\", \"wait_to_enter\"].includes(security_alarm) && min_distance <= zone_home.radius) {\n        msgs.push({ entity_id: \"input_text.security_alarm\", state: \"disarmed\" })\n    } else if (invitation && in_home_zone) {\n        msgs.push({ entity_id: \"input_text.security_alarm\", state: \"disarmed\" })\n    } else if (!invitation && [\"disarmed\", \"wait_to_go\"].includes(security_alarm) && zone_home.radius < min_distance) {\n        msgs.push({ entity_id: \"input_text.security_alarm\", state: \"armed\" })\n    } else if (!invitation && security_alarm === \"armed\" && min_distance <= zone_home.radius) {\n        msgs.push({ entity_id: \"input_text.security_alarm\", state: is_security_panel ? \"wait_to_enter\" : \"disarmed\" })\n    }\n}\n\nreturn [msgs]","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":180,"wires":[["32558857ddd5adf5"]]},{"id":"0b9dcc222de5d0eb","type":"link in","z":"37a14665cffc94c1","name":"link in 6","links":["e330c9d9b9909a11","65cd78fa3e9430d0","6ebb87b93e0aaa3f"],"x":55,"y":880,"wires":[["e2280bdf634757c9"]]},{"id":"e330c9d9b9909a11","type":"link out","z":"37a14665cffc94c1","name":"link out 13","mode":"link","links":["0b9dcc222de5d0eb"],"x":1015,"y":700,"wires":[]},{"id":"65cd78fa3e9430d0","type":"link out","z":"37a14665cffc94c1","name":"link out 14","mode":"link","links":["0b9dcc222de5d0eb"],"x":855,"y":580,"wires":[]},{"id":"1825bb4669a5f764","type":"function","z":"37a14665cffc94c1","name":"notification","func":"let msgs = []\n\nif (msg.payload == \"off\") {\n    msgs.push({ entity_id: \"input_text.security_alarm\", state: \"disarmed\" })\n    msgs.push({ entity_id: \"input_boolean.security_alarm\", state: \"off\" })\n    return [null, msgs]\n} else {\n    return [{ notification_id: \"module_security_intrusion\", dismiss: true }, null]\n}\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":760,"wires":[["7c46b5660c01712e"],["7f54f5a63fcf134a"]]},{"id":"64fb8b5cfdd30c01","type":"subflow:723d4991c3c87385","z":"37a14665cffc94c1","name":"","x":810,"y":640,"wires":[]},{"id":"6ebb87b93e0aaa3f","type":"link out","z":"37a14665cffc94c1","name":"link out 5","mode":"link","links":["0b9dcc222de5d0eb"],"x":715,"y":640,"wires":[]},{"id":"6cbb8dae36b367cc","type":"function","z":"37a14665cffc94c1","name":"notification","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state === \"on\"\nlet notifications = global.get(\"notifications\") ?? {}\nlet distances = global.get(\"distances\") ?? {}\nlet functions = global.get(\"functions\") ?? {}\nlet person_in_home_zone = functions[\"is_in_home_zone\"]()\n\nif (Object.keys(distances).length > 0) {\n    if (invitation && !person_in_home_zone && in_home_zone) {\n        return [{\n            notification_id: \"invitation\",\n            title: \"Mode invit√©\",\n            alert_type: \"success\",\n            message: \"L'invit√© est entr√©\",\n            send_mobile: true\n        }, null]\n    } else if (invitation) {\n        return [{\n            notification_id: \"invitation\",\n            title: \"Mode invit√©\",\n            alert_type: \"success\",\n            message: \"Mode invit√© activ√©\",\n            send_mobile: true\n        }, null]\n    } else if (notifications[\"invitation\"] !== undefined) {\n        return [{\n            notification_id: \"invitation\",\n            clear_on_phone: true,\n            dismiss: true\n        }, null]\n    }\n} else {\n    return [{\n        notification_id: \"invitation_disabled\",\n        title: \"Mode invit√© non activable\",\n        message: \"Le mode invit√© n√©cessite au moins un appareil param√©tr√© en WIFI et/ou GPS\",\n        alert_type: \"warning\",\n        send_mobile: true\n    }, {\n        entity_id: \"input_boolean.invitation\",\n        state: \"off\"\n    }]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":320,"wires":[["c0162d93859e418d"],["9ee9a07ceec67343"]]},{"id":"60d635f1979bc939","type":"link out","z":"37a14665cffc94c1","name":"link out 6","mode":"link","links":["7da2c8f60353d65e"],"x":505,"y":320,"wires":[]},{"id":"4abfa2a12b9dbd6c","type":"server-state-changed","z":"37a14665cffc94c1","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"in_home_zone","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":1020,"wires":[["3e7a6d2445ebd3b6"]]},{"id":"3e7a6d2445ebd3b6","type":"function","z":"37a14665cffc94c1","name":"still_open >","func":"msg.search = { \"is\": { linked_class: [\"window\", \"motion\"], state: \"on\", security_intrusion: true } }\nmsg.output_name = \"still_open\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":1020,"wires":[["c04412147ed895c6"]]},{"id":"c04412147ed895c6","type":"subflow:3da7ebfd83a38899","z":"37a14665cffc94c1","name":"","x":395,"y":1020,"wires":[["54f9331a060bb87e"]],"l":false},{"id":"54f9331a060bb87e","type":"function","z":"37a14665cffc94c1","name":"notification","func":"let notifications = global.get(\"notifications\") ?? {}\nlet in_home_zone = msg.in_home_zone === \"on\"\nlet notification_id = \"still_open\"\nlet still_open = msg.still_open\n\nif (!in_home_zone && still_open.length > 0) {\n    return {\n        notification_id: notification_id,\n        title: \"Rappel de vuln√©rabilit√© üõ°Ô∏è\",\n        message: set_still_open_text(still_open),\n        alert_type: \"warning\",\n        send_mobile: true\n\n    }\n} else if (in_home_zone && notifications[notification_id] !== undefined) {\n    return {\n        notification_id: notification_id,\n        clear_on_phone: true,\n        dismiss: true\n    }\n}\n\nfunction set_still_open_text(still_open) {\n    let alias = still_open.map(a => a.alias)\n    if (alias.length === 1) {\n        return capitalize_first_letter(\"La \" + alias[0] + \" est ouverte\")\n    } else {\n        let joined = alias.slice(0, -1).join(\", \") + \" et \" + alias[alias.length - 1]\n        return capitalize_first_letter(\"Les \" + joined + \" sont ouvertes\")\n    }\n}\n\nfunction capitalize_first_letter(val) {\n    return String(val).charAt(0).toUpperCase() + String(val).slice(1);\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":1020,"wires":[["5a7d35891b109375"]]},{"id":"5a7d35891b109375","type":"link out","z":"37a14665cffc94c1","name":"link out 8","mode":"link","links":["e53334a6f05a9609"],"x":615,"y":1020,"wires":[]},{"id":"b46bb033cb488af6","type":"comment","z":"37a14665cffc94c1","name":"Home breach","info":"","x":110,"y":960,"wires":[]},{"id":"274ee0b1b3961d93","type":"link in","z":"37a14665cffc94c1","name":"security","links":["61c0d8738882ce35"],"x":235,"y":700,"wires":[["4ca2b0e55ddfbc50"]]},{"id":"4ca2b0e55ddfbc50","type":"function","z":"37a14665cffc94c1","name":"wait_to_enter ?","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet security_alarm = global.get(\"homeassistant\").homeAssistant.states[\"input_text.security_alarm\"].state\n\nif (msg.new_state === \"on\" && security_alarm === \"wait_to_enter\" && !in_home_zone) {\n    return { security_alarm: \"disarmed\" }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":700,"wires":[["42edaa9e4acdb5f2"]]},{"id":"249d40b54972a86b","type":"subflow:3da7ebfd83a38899","z":"37a14665cffc94c1","name":"","x":295,"y":180,"wires":[["aefb65f11baa698a"]],"l":false},{"id":"92878b76fb92f23a","type":"function","z":"37a14665cffc94c1","name":"security_panel >","func":"msg.search = { \"is\": { linked_class: \"security_panel\" } }\nmsg.output_name = \"security_panels\"\nmsg.output_empty_results = true\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":180,"wires":[["249d40b54972a86b"]]},{"id":"1bcbd7b988d4ece3","type":"subflow:dbf17bea6affd2ec","z":"37a14665cffc94c1","name":"","x":920,"y":700,"wires":[]},{"id":"13a390949bac6841","type":"link in","z":"ccf1abe540a3b5a9","name":"light on/off/last","links":["a0ec305d313aa8f9","a54be99d7e32ea7c","92343d20b8540180"],"x":55,"y":180,"wires":[["81bc2142a3005244"]]},{"id":"0fcb5d94030ab313","type":"catch","z":"ccf1abe540a3b5a9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["d52e65e568a3244a"]]},{"id":"308dcdc841f55ee0","type":"subflow:ad3b29a5dd67898f","z":"ccf1abe540a3b5a9","name":"","x":460,"y":40,"wires":[["2b5cdcce3c6af32e"]]},{"id":"d52e65e568a3244a","type":"change","z":"ccf1abe540a3b5a9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Lights","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["308dcdc841f55ee0"]]},{"id":"57970c88e211ce04","type":"link in","z":"ccf1abe540a3b5a9","name":"ambiance","links":["9560131ccbbc20d7"],"x":55,"y":780,"wires":[["fd50909671a8105f"]]},{"id":"3d427e9849b65be2","type":"function","z":"ccf1abe540a3b5a9","name":"restore lights","func":"let motion_areas = global.get(\"motion_areas\") ?? {}\nlet areas = [... new Set(msg.lights.map(a => a.linked_area).filter(a => motion_areas[a]))]\nif (msg.transition !== undefined) {\n    return [areas.map(a => ({ linked_area: a, state: motion_areas[a], transition: msg.transition }))]\n} else {\n    return [areas.map(a => ({ linked_area: a, state: motion_areas[a] }))]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":500,"wires":[["a0ec305d313aa8f9"]]},{"id":"a0ec305d313aa8f9","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 373","mode":"link","links":["13a390949bac6841"],"x":995,"y":500,"wires":[]},{"id":"42bcf58ce90dbbb4","type":"link in","z":"ccf1abe540a3b5a9","name":"light restore","links":["09937216bea66806","3b7de15728946212","b624e6e0f61ddfc0","f3871ab18c4e3b58","be9f8b854ee6a2a6"],"x":55,"y":500,"wires":[["5353dac022935688"]]},{"id":"96fcc71316f08920","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 374","mode":"link","links":["437b422bf3232407"],"x":665,"y":300,"wires":[]},{"id":"39c5c048d2a868a7","type":"function","z":"ccf1abe540a3b5a9","name":"lights on","func":"let lights = msg.lights.filter(l => l.entity_id.includes(\"light.\"))\nreturn [lights.map(l => ({ payload: { data: { entity_id: l.entity_id, brightness_pct: 100, color_color_temp_kelvin: 4500 } } }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":1040,"wires":[["5687a334154dd78b"]]},{"id":"81bc2142a3005244","type":"function","z":"ccf1abe540a3b5a9","name":"area lights >","func":"let module_lights = global.get('homeassistant').homeAssistant.states[\"input_boolean.module_lights\"].state == \"on\"\n\nif (module_lights) {\n    msg.search = { \"is\": { linked_class: \"light\", linked_area: msg.linked_area, state: [\"on\", \"off\"] } }\n    msg.output_name = \"lights\"\n    msg.output_empty_results = false\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":180,"wires":[["65d668d29a2fb0bf"]]},{"id":"6fa27568c479e069","type":"function","z":"ccf1abe540a3b5a9","name":"area covers >","func":"msg.search = { \"is\": { linked_class: \"cover\", linked_area: msg.linked_area, state: 0 } }\nmsg.output_name = \"covers\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":180,"wires":[["f08d550a9e4bf036"]]},{"id":"e6fdc8b9ecf9094b","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"msg.search = { \"is\": { linked_class: \"light\", state: [\"on\", \"off\"] } }\nmsg.output_name = \"lights\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":500,"wires":[["7a8c249645ba0cef"]]},{"id":"793fa08398a6eb1b","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"msg.search = { \"is\": { linked_class: \"light\", state: [\"on\", \"off\"] } }\nmsg.output_name = \"lights\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":1040,"wires":[["25f588146ef6cf2b"]]},{"id":"5687a334154dd78b","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":990,"y":1040,"wires":[[]]},{"id":"587a2f970b774dec","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":510,"y":500,"wires":[["e6fdc8b9ecf9094b"],[]]},{"id":"ad9a09b8e7b92562","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":470,"y":640,"wires":[["e9e28d9783ef5d3c"],[]]},{"id":"1e13104782559c9c","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"lights triggers","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_boolean.color_reverse","input_number.color_segment","input_number.color_rotate","input_number.low_light_compensation","input_boolean.low_light_compensation"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":570,"y":440,"wires":[["b624e6e0f61ddfc0"]]},{"id":"65d668d29a2fb0bf","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":275,"y":180,"wires":[["6fa27568c479e069"]],"l":false},{"id":"f08d550a9e4bf036","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":555,"y":180,"wires":[["bef99f6cd77106ea"]],"l":false},{"id":"7a8c249645ba0cef","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":775,"y":500,"wires":[["3d427e9849b65be2"]],"l":false},{"id":"25f588146ef6cf2b","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":735,"y":1040,"wires":[["39c5c048d2a868a7"]],"l":false},{"id":"5c1578eb5358a261","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":250,"y":440,"wires":[["a7cf4e223ec602b3"]]},{"id":"a1c3d80b2bb65e82","type":"subflow:723d4991c3c87385","z":"ccf1abe540a3b5a9","name":"","x":475,"y":440,"wires":[],"l":false},{"id":"a7cf4e223ec602b3","type":"function","z":"ccf1abe540a3b5a9","name":"sun calc","func":"let sun_light_angle_setting_rising = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_setting_rising\"].state)\nlet sun_light_angle_dusk_dawn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_dusk_dawn\"].state)\n\nlet old_elevation = msg.data.old_state.attributes.elevation\nlet new_elevation = msg.data.new_state.attributes.elevation\nlet rising = msg.data.new_state.attributes.rising\n\nlet d = new Date()\nlet local_time = d.getHours() + \":\" + d.getMinutes()\n\nif (rising) {\n    if (old_elevation < sun_light_angle_setting_rising && sun_light_angle_setting_rising < new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_rising\", state: local_time }, msg]\n    } else if (old_elevation < sun_light_angle_dusk_dawn && sun_light_angle_dusk_dawn < new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_dawn_angle\", state: local_time }, msg]\n    }\n} else {\n    if (old_elevation > sun_light_angle_setting_rising && sun_light_angle_setting_rising > new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_setting\", state: local_time }, msg]\n    } else if (old_elevation > sun_light_angle_dusk_dawn && sun_light_angle_dusk_dawn > new_elevation) {\n        return [{ entity_id: \"input_datetime.sun_light_time_dusk\", state: local_time }, msg]\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":440,"wires":[["a1c3d80b2bb65e82"],["a457c8d35dfc8615"]]},{"id":"b624e6e0f61ddfc0","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 582","mode":"link","links":["42bcf58ce90dbbb4"],"x":835,"y":440,"wires":[]},{"id":"437b422bf3232407","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 529","links":["96fcc71316f08920"],"x":325,"y":180,"wires":[["6fa27568c479e069"]]},{"id":"8c97642014596c3f","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":350,"y":300,"wires":[["194c392731396fca"],[]]},{"id":"e23e00bff771d076","type":"comment","z":"ccf1abe540a3b5a9","name":"light core","info":"","x":100,"y":120,"wires":[]},{"id":"012447fa27d53e03","type":"comment","z":"ccf1abe540a3b5a9","name":"light triggers","info":"","x":110,"y":380,"wires":[]},{"id":"e799aa7cd0ac8a40","type":"comment","z":"ccf1abe540a3b5a9","name":"light update","info":"","x":110,"y":240,"wires":[]},{"id":"6dc2aba21231d6d8","type":"comment","z":"ccf1abe540a3b5a9","name":"ambiance control","info":"","x":120,"y":720,"wires":[]},{"id":"194c392731396fca","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"let motion_areas = global.get(\"motion_areas\") ?? {}\nlet active_areas = Object.keys(motion_areas).filter(a => (motion_areas[a] == \"on\" || motion_areas[a] == \"last\"))\nlet msgs = active_areas.map(a => ({\n    linked_area: a,\n    search: {\n        \"is\": {\n            linked_class: \"light\",\n            linked_area: a,\n            state: \"on\"\n        }\n    },\n    output_name: \"lights\",\n    output_empty_results: false,\n    state: motion_areas[a]\n}\n))\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":300,"wires":[["e9d3c04e7d855f89"]]},{"id":"e9d3c04e7d855f89","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":615,"y":300,"wires":[["96fcc71316f08920"]],"l":false},{"id":"fb41d8a3f6c9865c","type":"function","z":"ccf1abe540a3b5a9","name":"set lights","func":"let light_control = global.get(\"light_control\") ?? {}\nlight_control.locked = []\nglobal.set(\"light_control\", light_control)\n\nmsg.lights = msg.lights.map(l => l.entity_id)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":640,"wires":[["f75ff98c33f51cb6"]]},{"id":"e9e28d9783ef5d3c","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"msg.search = { \"is\": { linked_class: \"light\", state: [\"on\", \"off\"] } }\nmsg.output_name = \"lights\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":640,"wires":[["3ef0e008de820adc"]]},{"id":"3ef0e008de820adc","type":"subflow:3da7ebfd83a38899","z":"ccf1abe540a3b5a9","name":"","x":735,"y":640,"wires":[["fb41d8a3f6c9865c"]],"l":false},{"id":"c5361089295203a3","type":"comment","z":"ccf1abe540a3b5a9","name":"turn lights off when not home","info":"","x":160,"y":580,"wires":[]},{"id":"0d420d11e004d498","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":290,"y":640,"wires":[[],["ad9a09b8e7b92562"]]},{"id":"f75ff98c33f51cb6","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["{{lights}}"],"data":"{\"transition\":0}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":990,"y":640,"wires":[[]]},{"id":"bef99f6cd77106ea","type":"function","z":"ccf1abe540a3b5a9","name":"light calc","func":"// @ts-nocheck\nlet sun_light_angle_setting_rising = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_setting_rising\"].state)\nlet sun_light_angle_dusk_dawn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_light_angle_dusk_dawn\"].state)\nlet sun_light_time_setting = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_setting\"].state)\nlet sun_light_time_rising = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_rising\"].state)\nlet sun_angle_cover_on = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_on\"].state)\nlet sun_angle_cover_off = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_off\"].state)\nlet in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet sun = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes\nlet light_control = global.get(\"light_control\") ?? {}\nlet min_low_light_brightness = 100\nlet commun_brightness = {}\nlet msgs = []\n\nlet low_light_brightness_pct = low_light_brightness_pct_calc()\nlet night_brightness_pct = night_brightness_pct_calc()\nlet light_time = night_brightness_pct[0]\nlet light_color = get_color(light_time)\n\nif (sun.elevation < sun_light_angle_setting_rising) {\n    commun_brightness[\"night_brightness_pct\"] = night_brightness_pct[1]\n}\n\nif (low_light_brightness_pct > 0) {\n    commun_brightness[\"low_light_brightness_pct\"] = low_light_brightness_pct\n}\n\nfor (let light of msg.lights) {\n    if (light.auto && (!(light_control.locked.includes(light.entity_id)))) {\n        let state = (msg.state == \"last\" ? light.auto.last_light ? \"on\" : \"off\" : msg.state) == \"on\"\n        state = state && in_home_zone\n        if (state || state != (light.state == \"on\")) {\n            let light_brightness = {}\n            if (light.auto.day_light) {\n                light_brightness[\"day_brightness_pct\"] = day_brightness_pct_calc(light)\n            } else if (msg.covers.length != 0 && sun.elevation > sun_angle_cover_on && sun.elevation > sun_angle_cover_off) {\n                light_brightness[\"cover_brightness_pct\"] = light.parameters.bright_range[1]\n            }\n            let brightnesss = { ...commun_brightness, ...light_brightness }\n            let brightnessKeys = Object.keys(brightnesss)\n            if (brightnessKeys.includes(\"night_brightness_pct\")) {\n                let brightness_pct_list = [brightnesss[\"night_brightness_pct\"](light)]\n                if (brightnessKeys.includes(\"day_brightness_pct\")) {\n                    brightness_pct_list.push(brightnesss[\"day_brightness_pct\"])\n                } else if (brightnessKeys.includes(\"low_light_brightness_pct\")) {\n                    brightness_pct_list.push(brightnesss[\"low_light_brightness_pct\"])\n                }\n                let brightness_pct = brightness_pct_list.reduce((ps, a) => ps + a, 0)\n                brightness_pct = brightness_pct > light.parameters.bright_range[1] ? light.parameters.bright_range[1] : brightness_pct\n                light_action(state, brightness_pct, light)\n            } else {\n                if (brightnessKeys.includes(\"day_brightness_pct\")) {\n                    light_action(state, brightnesss[\"day_brightness_pct\"], light)\n                } else if (brightnessKeys.includes(\"cover_brightness_pct\")) {\n                    light_action(state, brightnesss[\"cover_brightness_pct\"], light)\n                } else if (brightnessKeys.includes(\"low_light_brightness_pct\")) {\n                    let brightness_pct = brightnesss[\"low_light_brightness_pct\"] * light.parameters.bright_range[1] / 100\n                    light_action(state, brightness_pct, light)\n                } else if (light.state == \"on\") {\n                    light_action(false, 0, light)\n                }\n            }\n        }\n    }\n}\nreturn [msgs]\n\nfunction night_brightness_pct_calc() {\n    let sun_light_time_dusk = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dusk\"].state)\n    let sun_light_time_midnight = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_midnight\"].state)\n    let sun_light_time_dawn = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn\"].state)\n    let sun_light_time_dawn_angle = in_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_light_time_dawn_angle\"].state)\n    let current_time = in_minutes(new Date().toString().slice(16, 21))\n\n    // Pivot\n    sun_light_time_rising = sun_light_time_rising + 1440 - sun_light_time_setting\n    sun_light_time_dawn_angle = sun_light_time_dawn_angle + 1440 - sun_light_time_setting\n    sun_light_time_dawn = sun_light_time_dawn + 1440 - sun_light_time_setting\n    sun_light_time_midnight = sun_light_time_dusk < sun_light_time_midnight ? sun_light_time_midnight - sun_light_time_setting : sun_light_time_midnight + 1440 - sun_light_time_setting\n    sun_light_time_dusk = sun_light_time_dusk - sun_light_time_setting\n    current_time = sun_light_time_setting <= current_time ? current_time - sun_light_time_setting : 1440 - sun_light_time_setting + current_time\n    sun_light_time_setting = 0\n\n    // Choix de l'heure de l'aube la plus petite \n    sun_light_time_dawn = sun_light_time_dawn < sun_light_time_dawn_angle ? sun_light_time_dawn : sun_light_time_dawn_angle\n\n    if (sun_light_time_setting <= current_time && current_time < sun_light_time_dusk) {\n        return [pct_calc(sun_light_time_setting, sun_light_time_midnight, current_time, false),\n        function (light) { return brightness_formula_calc(pct_calc(sun_light_time_setting, sun_light_time_dusk, current_time, false), light) }]\n    } else if (sun_light_time_dusk <= current_time && current_time < sun_light_time_midnight - 60) {\n        return [pct_calc(sun_light_time_setting, sun_light_time_midnight, current_time, false),\n        function (light) { return light.parameters.bright_range[1] }]\n    } else if (sun_light_time_midnight - 60 <= current_time && current_time < sun_light_time_midnight) {\n        return [pct_calc(sun_light_time_setting, sun_light_time_midnight, current_time, false),\n        function (light) { return brightness_formula_calc(pct_calc(sun_light_time_midnight - 60, sun_light_time_midnight, current_time, true), light) }]\n    } else if (sun_light_time_midnight <= current_time && current_time < sun_light_time_dawn - 60) {\n        return [100, function (light) { return light.auto.night_light ? light.parameters.bright_range[0] : 0 }]\n    } else if (sun_light_time_dawn - 60 <= current_time && current_time < sun_light_time_dawn) {\n        return [pct_calc(sun_light_time_dawn - 60, sun_light_time_rising, current_time, true),\n        function (light) { return brightness_formula_calc(pct_calc(sun_light_time_dawn - 60, sun_light_time_dawn, current_time, true), light) }]\n    } else if (sun_light_time_dawn <= current_time && current_time < (sun_light_time_dawn + sun_light_time_rising) / 2) {\n        return [pct_calc(sun_light_time_dawn - 60, sun_light_time_rising, current_time, true),\n        function (light) { return light.parameters.bright_range[1] }]\n    } else if ((sun_light_time_dawn + sun_light_time_rising) / 2 <= current_time && current_time < sun_light_time_rising) {\n        return [pct_calc(sun_light_time_dawn - 60, sun_light_time_rising, current_time, true),\n        function (light) { return brightness_formula_calc(pct_calc((sun_light_time_dawn + sun_light_time_rising) / 2, sun_light_time_rising, current_time, true), light) }]\n    } else {\n        return [0, function (light) { return light.parameters.bright_range[0] }]\n    }\n}\n\nfunction low_light_brightness_pct_calc() {\n    let low_light_compensation = global.get('homeassistant').homeAssistant.states[\"input_boolean.low_light_compensation\"].state == \"on\"\n    if (low_light_compensation) {\n        let low_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.low_light_compensation\"].state)\n        let illuminances = global.get(\"illuminances\") ?? {}\n        let up_to_date = illuminances[\"exterior\"]?.last_changed && (new Date().getTime() - illuminances[\"exterior\"].last_changed) / 1000 < 60 * 60 * 24\n        if (up_to_date && illuminances[\"exterior\"]?.[\"value\"] && illuminances[\"exterior\"][\"value\"] < low_light && sun.elevation > sun_light_angle_setting_rising) {\n            return pct_calc(min_low_light_brightness, low_light, illuminances[\"exterior\"][\"value\"], true)\n        } else if (up_to_date && illuminances[\"exterior\"]?.[\"value\"] && illuminances[\"exterior\"][\"value\"] < low_light && sun.elevation > sun_light_angle_dusk_dawn) {\n            return pct_calc(min_low_light_brightness, low_light, illuminances[\"exterior\"][\"value\"], true) * pct_calc(sun_light_angle_dusk_dawn, sun_light_angle_setting_rising, sun.elevation, false) / 100\n        }\n    }\n    return 0\n}\n\nfunction day_brightness_pct_calc(light) {\n    if (sun.elevation > sun_light_angle_setting_rising) {\n        return light.parameters.bright_range[1]\n    } else if (sun.elevation > sun_light_angle_dusk_dawn) {\n        return light.parameters.bright_range[1] * pct_calc(sun_light_angle_dusk_dawn, sun_light_angle_setting_rising, sun.elevation, false) / 100\n    } else {\n        return 0\n    }\n}\n\nfunction brightness_formula_calc(brightness_pct, light) {\n    brightness_pct = Math.cos((9 * brightness_pct / 10 - 90) * Math.PI / 180)\n    return light.parameters.bright_range[0] + (light.parameters.bright_range[1] - light.parameters.bright_range[0]) * brightness_pct\n}\n\nfunction pct_calc(min, max, nb, reverse) {\n    return nb < min ? (reverse ? 100 : 0) : nb > max ? (reverse ? 0 : 100) : reverse ? (max - nb) / Math.abs(min - max) * 100 : (nb - min) / Math.abs(min - max) * 100\n}\n\nfunction in_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\")\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1])\n}\n\nfunction light_action(state, brightness_pct, light) {\n    let lp = light.parameters\n    let transition = msg.transition !== undefined ? msg.transition : lp.transition_range[state ? 0 : 1]\n    if ((light.attributes.supported_color_modes ?? []).find(s => [\"hs\", \"rgb\", \"xy\", \"color_temp\"].includes(s))) {\n        if (state) {\n            let type = lp.color == \"on\" ? \"hs_color\" : \"color_temp_kelvin\"\n            let value = lp.color == \"on\" ? [light_color, lp.hs_saturation] : (lp.kelvin_range[1] - lp.kelvin_range[0]) * (100 - light_time) / 100 + lp.kelvin_range[0]\n            msgs.push({\n                domain: \"light\", service: \"turn_on\",\n                payload: { data: { entity_id: light.entity_id, transition: transition, brightness_pct: brightness_pct, [type]: value } }\n            })\n        } else {\n            if (light.attributes.flowing !== undefined) {\n                let transitions = []\n                if (lp.color !== \"off\") {\n                    transitions.push({ \"HSVTransition\": [light_color, lp.hs_saturation, transition * 1000, lp.bright_range[0]] })\n                } else {\n                    let color_temp_kelvin = light_time * (light.parameters.kelvin_range[1] - light.parameters.kelvin_range[0]) / 100 + light.parameters.kelvin_range[0]\n                    transitions.push({ \"TemperatureTransition\": [color_temp_kelvin, transition * 1000, lp.bright_range[0]] })\n                }\n                msgs.push({ domain: \"yeelight\", service: \"start_flow\", payload: { data: { entity_id: light.entity_id, action: \"off\", count: 1, transitions: transitions } } })\n            } else {\n                msgs.push({ domain: \"light\", service: \"turn_off\", payload: { data: { entity_id: light.entity_id, transition: transition } } })\n            }\n        }\n    }\n}\n\nfunction get_color(light_time) {\n    let color_rotate = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_rotate\"].state)\n    let color_segment = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_segment\"].state)\n    let color_reverse = global.get('homeassistant').homeAssistant.states[\"input_boolean.color_reverse\"].state == \"on\"\n    let color = (((360 * (color_segment * light_time / (360 * 100)) + color_rotate) % 360))\n    return color_reverse ? 360 - color : color\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":180,"wires":[["1be9b580422afca7"]]},{"id":"1be9b580422afca7","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":810,"y":180,"wires":[[]]},{"id":"2b5cdcce3c6af32e","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 631","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"1ffec2a6d7c88635","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 572","links":["d2b2ad544804ea48"],"x":55,"y":300,"wires":[["028c04198da61872"]]},{"id":"67be2e4d7c556304","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"midnight time","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_datetime.sun_light_time_midnight","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":440,"wires":[["b624e6e0f61ddfc0"]]},{"id":"2f939a38c9e3e4d9","type":"function","z":"ccf1abe540a3b5a9","name":"notification","func":"msg.notification_id = \"module_light\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Lumi√®res d√©sactiv√©\"\n    msg.message = \"Module Lumi√®res d√©sactiv√©, les lumi√®res sont allum√©es\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":1040,"wires":[["0d99cef6bb8581ba"]]},{"id":"0d99cef6bb8581ba","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 651","mode":"link","links":["e53334a6f05a9609"],"x":375,"y":1040,"wires":[]},{"id":"5ce7216bda04a4b2","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"module_lights","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_lights","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":730,"y":440,"wires":[["b624e6e0f61ddfc0"],[]]},{"id":"5353dac022935688","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":170,"y":500,"wires":[["5f8b5f746a80ca8c"],[]]},{"id":"e07dfbb649df45af","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":490,"y":1040,"wires":[["793fa08398a6eb1b"],[]]},{"id":"d13abe7992400a34","type":"comment","z":"ccf1abe540a3b5a9","name":"on/off module_light","info":"","x":130,"y":980,"wires":[]},{"id":"fd50909671a8105f","type":"function","z":"ccf1abe540a3b5a9","name":"check ambiance","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet home_configuration = global.get(\"home_configuration\") ?? {}\n\nif (\n    in_home_zone &&\n    msg.attributes.options.includes(msg.new_state) &&\n    msg.linked_lights && Array.isArray(msg.linked_lights) &&\n    msg.linked_lights.length > 0 &&\n    typeof msg.ambiance_volume_level === \"number\" &&\n    typeof msg.linked_speaker === \"string\" &&\n    typeof msg.linked_area === \"string\"\n) {\n    msg.light_support_color = msg.linked_lights.filter(l =>\n        [\"on\", \"off\"].includes(global.get(\"homeassistant\").homeAssistant.states[l].state) &&\n        global.get(\"homeassistant\").homeAssistant.states[l].attributes.supported_color_modes.find(c => [\"xy\", \"hs\", \"rgb\"].includes(c))\n    )\n    if (msg.light_support_color.length > 0) {\n        msg = { ...msg, ambiance_config: home_configuration.ambiance_config }\n        delete msg.linked_lights\n        return [msg, set_light_controller(msg.state)]\n    }\n}\n\nfunction set_light_controller(state) {\n    let light_control = global.get(\"light_control\") ?? {}\n    if (state === \"Arret\") {\n        let restore_msgs = []\n        if (light_control[\"ambiance\"]?.[msg.entity_id] && Array.isArray(light_control[\"ambiance\"][msg.entity_id]) && light_control[\"ambiance\"][msg.entity_id].length > 0) {\n            let was_unlocked = []\n            for (let l of light_control[\"ambiance\"][msg.entity_id]) {\n                if (l.locked === false) { was_unlocked.push(l.entity_id) }\n                let restore_msg = { service: (\"turn_\" + l.state), payload: { data: { entity_id: l.entity_id, transition: 5 } } }\n                if (l.state == \"on\") {\n                    restore_msg[\"payload\"][\"data\"][\"hs_color\"] = l.attributes.hs_color\n                    restore_msg[\"payload\"][\"data\"][\"brightness\"] = l.attributes.brightness\n                }\n                restore_msgs.push(restore_msg)\n            }\n            light_control[\"locked\"] = light_control[\"locked\"].filter(l => (!(was_unlocked.includes(l))))\n            delete light_control[\"ambiance\"][msg.entity_id]\n        } else {\n            light_control[\"locked\"] = light_control[\"locked\"].filter(l => (!msg.light_support_color.includes(l)))\n        }\n        global.set(\"light_control\", light_control)\n        return restore_msgs\n    } else {\n        if (!light_control[\"ambiance\"]) { light_control[\"ambiance\"] = {} }\n        if (!light_control[\"ambiance\"][msg.entity_id]) { light_control[\"ambiance\"][msg.entity_id] = [] }\n        for (let l of msg.light_support_color) {\n            light_control[\"ambiance\"][msg.entity_id].push({ locked: light_control[\"locked\"].includes(l), ...global.get(\"homeassistant\").homeAssistant.states[l] })\n        }\n        light_control[\"locked\"] = [...new Set(light_control[\"locked\"].concat(msg.light_support_color))]\n    }\n    global.set(\"light_control\", light_control)\n    return null\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":780,"wires":[["394cf63f5b976696"],["bfb95540a0b493bf"]]},{"id":"b4048a698ac0d24f","type":"function","z":"ccf1abe540a3b5a9","name":"msg speaker","func":"if (msg.state && msg.ambiance_config.ambiances_type[msg.state]?.ambiance && msg.linked_speaker) {\n    let speaker = global.get(\"home_configuration\")[msg.linked_speaker]\n    if (speaker && msg.ambiance_config?.path?.start !== \"\" && msg.ambiance_config?.path?.end !== \"\") {\n        if (msg.state == \"Arret\") {\n            let sound = \"ambiance_stop.mp3\"\n            msg = {\n                linked_area: msg.linked_area,\n                volume_level: get_speaker_volume(),\n                sound: sound\n            }\n        } else {\n            msg = {\n                linked_area: msg.linked_area,\n                volume_level: msg.ambiance_volume_level ?? 0.5,\n                link: msg.ambiance_config.path.start + msg.ambiance_config.ambiances_type[msg.state].ambiance + msg.ambiance_config.path.end\n            }\n        }\n        return msg\n    }\n}\n\nfunction get_speaker_volume() {\n    let speaker_day_mode_start = global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_day_mode_start\"].state\n    let speaker_night_mode_start = global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_night_mode_start\"].state\n\n    let d = new Date()\n    let hours = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\n    let minutes = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n    let local_time = hours + \":\" + minutes + \":00\"\n\n    let entity_id = \"\"\n    if (speaker_day_mode_start < local_time && local_time < speaker_night_mode_start) {\n        entity_id = \"input_number.speaker_day_mode_volume\"\n    } else {\n        entity_id = \"input_number.speaker_night_mode_volume\"\n    }\n    return parseFloat(global.get(\"homeassistant\").homeAssistant.states[entity_id].state ?? 50) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":780,"wires":[["018316def2019101"]]},{"id":"018316def2019101","type":"subflow:dbf17bea6affd2ec","z":"ccf1abe540a3b5a9","name":"","x":760,"y":780,"wires":[]},{"id":"6f4615f52cc54556","type":"function","z":"ccf1abe540a3b5a9","name":"set ambiance","func":"if (msg.light_support_color.length > 0) {\n    if (msg.state === \"Arret\") {\n        return [null, msg]\n    } else {\n        delete msg.linked_lights\n        let msgs = []\n        for (let l of msg.light_support_color) {\n            let ambiance_type = msg.ambiance_config.ambiances_type[msg.state]\n            let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360)\n            let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100)\n            let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100)\n            let delay = 1000 + Math.round(Math.random() * 14000)\n            msgs.push({\n                linked_ambiance: msg.entity_id,\n                entity_id: l,\n                action_type: msg.state,\n                ambiance_config: msg.ambiance_config,\n                delay: delay,\n                service: \"turn_on\",\n                payload: {\n                    data: {\n                        entity_id: l,\n                        hs_color: [hs, saturation],\n                        brightness_pct: brightness,\n                        transition: Math.round(delay / 100) / 10\n                    }\n                }\n            })\n        }\n        return [msgs, msg]\n    }\n}\nreturn msg;\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance)\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance)\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":780,"wires":[["1fa76c5c0104520b"],["86d3308c7c59b1e8"]]},{"id":"2c2f0ef30f1fb7f2","type":"delay","z":"ccf1abe540a3b5a9","name":"timer","pauseType":"delayv","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":150,"y":840,"wires":[["487aebad4edbc789"]]},{"id":"1c6cbe56187b2032","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control lights","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":550,"y":840,"wires":[[]]},{"id":"487aebad4edbc789","type":"function","z":"ccf1abe540a3b5a9","name":"prepare light","func":"let light_control = global.get(\"light_control\") ?? {}\n\nif (light_control[\"ambiance\"]?.[msg.linked_ambiance]) {\n\n    let ambiance_type = msg.ambiance_config.ambiances_type[msg.action_type]\n    let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360)\n    let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100)\n    let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100)\n    let delay = 1000 + Math.round(Math.random() * 14000)\n\n    msg.delay = delay\n    msg.service = \"turn_on\"\n    if (msg.action_type == \"Orage\" && delay < 1500) {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                effect: \"Strobe epilepsy!\"\n            }\n        }\n    } else {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                hs_color: [hs, saturation],\n                brightness_pct: brightness,\n                transition: Math.round(delay / 100) / 10\n            }\n        }\n    }\n    return msg\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance)\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random()\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":840,"wires":[["1c4d8cf14db15194"]]},{"id":"3c3342a655c6af22","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"Arret","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"{{entity_id}}","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":105,"y":900,"wires":[["3092248b88bfbde5"],["94e393421263e4a6"]],"l":false},{"id":"1c4d8cf14db15194","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 669","mode":"link","links":["f7831e5e4f771d4a","0526c65f35b54162"],"x":395,"y":840,"wires":[]},{"id":"f7831e5e4f771d4a","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 589","links":["1c4d8cf14db15194","1fa76c5c0104520b"],"x":55,"y":840,"wires":[["2c2f0ef30f1fb7f2"]]},{"id":"0526c65f35b54162","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 590","links":["1fa76c5c0104520b","1c4d8cf14db15194","bfb95540a0b493bf"],"x":445,"y":840,"wires":[["1c6cbe56187b2032"]]},{"id":"1fa76c5c0104520b","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 670","mode":"link","links":["0526c65f35b54162","f7831e5e4f771d4a"],"x":505,"y":780,"wires":[]},{"id":"86d3308c7c59b1e8","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 671","mode":"link","links":["1ff2b88346ca3cbf"],"x":505,"y":780,"wires":[]},{"id":"1ff2b88346ca3cbf","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 593","links":["86d3308c7c59b1e8"],"x":55,"y":900,"wires":[["3c3342a655c6af22"]]},{"id":"bfb95540a0b493bf","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 673","mode":"link","links":["0526c65f35b54162"],"x":285,"y":780,"wires":[]},{"id":"f3871ab18c4e3b58","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 675","mode":"link","links":["42bcf58ce90dbbb4"],"x":515,"y":900,"wires":[]},{"id":"86c4e98b8f788cbf","type":"delay","z":"ccf1abe540a3b5a9","name":"","pauseType":"delay","timeout":"30","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":285,"y":900,"wires":[["935286b7a539a70b"]],"l":false},{"id":"935286b7a539a70b","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"ambiance stop","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":["input_select.ambiance_salon"],"data":"{\"option\":\"Arret\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":400,"y":900,"wires":[[]]},{"id":"94e393421263e4a6","type":"change","z":"ccf1abe540a3b5a9","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":190,"y":900,"wires":[["f3871ab18c4e3b58","86c4e98b8f788cbf"]]},{"id":"2e14bb7d3f271ede","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"module_lights","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_lights","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":1040,"wires":[["2f939a38c9e3e4d9"],["2f939a38c9e3e4d9","c2f812d9f6cd1957"]]},{"id":"4c42733221186c7f","type":"server-events","z":"ccf1abe540a3b5a9","name":"restore_lights","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"restore_lights","eventData":"","waitForRunning":true,"outputProperties":[{"property":"transition","propertyType":"msg","value":"$outputData(\"eventData\").event.transition","valueType":"jsonata"}],"x":330,"y":500,"wires":[["587a2f970b774dec"]]},{"id":"b1aab9ac43a488af","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":640,"wires":[[],["0d420d11e004d498"]]},{"id":"028c04198da61872","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":170,"y":300,"wires":[["8c97642014596c3f"],[]]},{"id":"64e37aeabacaf05d","type":"catch","z":"a1ed8ea56c7ba1f9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["c26fcca6989cf4f3"]]},{"id":"482a9536d24b4218","type":"subflow:ad3b29a5dd67898f","z":"a1ed8ea56c7ba1f9","name":"","x":460,"y":40,"wires":[["0254d9333c76d32a"]]},{"id":"c26fcca6989cf4f3","type":"change","z":"a1ed8ea56c7ba1f9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Climate","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["482a9536d24b4218"]]},{"id":"84e57cca5619edcb","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 491","mode":"link","links":["a0e3fb53a99dac3d"],"x":765,"y":180,"wires":[]},{"id":"355950fd1e7c52a2","type":"function","z":"a1ed8ea56c7ba1f9","name":"windows >","func":"msg.search = { \"is\": { linked_class: \"window\", state: [\"on\", \"off\"] } }\n\nif (msg.linked_area) {\n    msg.search.is = { ...msg.search.is, linked_area: msg.linked_area }\n}\n\nmsg.output_name = \"windows\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":180,"wires":[["b344dca91a2e3cd1"]]},{"id":"0c1bc4bca64606a1","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"let notification_id = \"module_temp_hum\"\n\nif (msg.payload == \"off\") {\n    return {\n        notification_id: notification_id,\n        alert_type: \"info\",\n        title: \"Module Alertes temp√©rature d√©sactiv√©\",\n        message: \"Module Alertes temp√©rature d√©sactiv√©, vous ne recevrez plus d'alerte de recommandations\",\n        send_mobile: true\n    }\n} else {\n    return { notification_id: notification_id, dismiss: true }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":500,"wires":[["4eab8cffd742e405"]]},{"id":"4eab8cffd742e405","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 517","mode":"link","links":["e53334a6f05a9609"],"x":415,"y":500,"wires":[]},{"id":"c998dc8531f83616","type":"api-current-state","z":"a1ed8ea56c7ba1f9","name":"module_temp_hum on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temp_hum","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":495,"y":180,"wires":[["355950fd1e7c52a2"],[]],"l":false},{"id":"a6ba23620056cd74","type":"server-state-changed","z":"a1ed8ea56c7ba1f9","name":"module_temp_hum","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_temp_hum","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":500,"wires":[["0c1bc4bca64606a1"]]},{"id":"00bc0f6c0d6f1f45","type":"comment","z":"a1ed8ea56c7ba1f9","name":"zones recommendations","info":"","x":150,"y":120,"wires":[]},{"id":"38c22b5e03af8fd9","type":"comment","z":"a1ed8ea56c7ba1f9","name":"on/off module_temp_hum","info":"","x":150,"y":440,"wires":[]},{"id":"34ceebd8badac0b8","type":"inject","z":"a1ed8ea56c7ba1f9","name":"5 min","props":[],"repeat":"","crontab":"*/5 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":170,"y":180,"wires":[["c998dc8531f83616"]]},{"id":"b344dca91a2e3cd1","type":"subflow:3da7ebfd83a38899","z":"a1ed8ea56c7ba1f9","name":"","x":715,"y":180,"wires":[["84e57cca5619edcb"]],"l":false},{"id":"820d17520ea5b902","type":"link in","z":"a1ed8ea56c7ba1f9","name":"zones recommendations","links":["0dac8a656e626a27"],"x":55,"y":180,"wires":[["c998dc8531f83616"]]},{"id":"df0b9ae52c4e45aa","type":"server-state-changed","z":"a1ed8ea56c7ba1f9","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":180,"wires":[["a4b674cad7c26f95"],[]]},{"id":"a4b674cad7c26f95","type":"delay","z":"a1ed8ea56c7ba1f9","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":435,"y":180,"wires":[["c998dc8531f83616"]],"l":false},{"id":"0254d9333c76d32a","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 632","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"61710fce0498e0de","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"let alert_speaker = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_speaker\"].state == \"on\"\nlet alert_light = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_light\"].state == \"on\"\nlet notification_id = \"temperature_alert_\" + msg.linked_area\n\nif (msg.count == 0) {\n    return { notification_id: notification_id, sound: \"correct.mp3\", dismiss: true }\n} else if (msg.count <= 3) {\n    let message = { notification_id: notification_id, alert_type: \"info\" }\n    switch (msg.alert) {\n        case \"outside_max_temp_close\":\n            message[\"title\"] = \"Temp√©rature haute\"\n            message[\"message\"] = \"Fermez\" + set_windows_text() + \"pour rester au frais\"\n            if (alert_light) { message[\"effects\"] = { count: 5, color: 15, saturation: 100, time: 1000 } }\n            if (alert_speaker) { message[\"speak\"] = message[\"message\"] }\n            return message\n        case \"outside_min_temp_close\":\n            message[\"title\"] = \"Temp√©rature basse\"\n            message[\"message\"] = \"Fermez\" + set_windows_text() + \"pour rester au chaud\"\n            if (alert_light) { message[\"effects\"] = { count: 5, color: 240, saturation: 100, time: 1000 } }\n            if (alert_speaker) { message[\"speak\"] = message[\"message\"] }\n            return message\n        case \"inside_max_temp_open\":\n            message[\"title\"] = \"Temp√©rature haute\"\n            message[\"message\"] = \"Ouvrez\" + set_windows_text() + \"pour baisser la temp√©rature\"\n            if (alert_light) { message[\"effects\"] = { count: 5, color: 15, saturation: 100, time: 1000 } }\n            if (alert_speaker) { message[\"speak\"] = message[\"message\"] }\n            return message\n        case \"inside_max_hum_open\":\n            message[\"title\"] = \"Humidit√© haute\"\n            message[\"message\"] = \"Ouvrez\" + set_windows_text() + \"pour r√©duire l'humidit√©\"\n            if (alert_light) { message[\"effects\"] = { count: 5, color: 240, saturation: 20, time: 1000 } }\n            if (alert_speaker) { message[\"speak\"] = message[\"message\"] }\n            return message\n    }\n}\n\nfunction set_windows_text() {\n    let alias = msg.windows_alias\n    if (alias.length == 1) {\n        return \" la fen√™tre \" + alias[0] + \" \"\n    } else {\n        let joined = alias.slice(0, -1).join(\", \") + \" et \" + alias[alias.length - 1]\n        return \" les fen√™tres \" + joined + \" \"\n    }\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":360,"wires":[["14641d23f914ef77"]]},{"id":"a0e3fb53a99dac3d","type":"link in","z":"a1ed8ea56c7ba1f9","name":"get comforts","links":["84e57cca5619edcb"],"x":55,"y":240,"wires":[["d5fe453b97c8a2aa"]]},{"id":"d5fe453b97c8a2aa","type":"function","z":"a1ed8ea56c7ba1f9","name":"prepare ext_comfort","func":"let rising = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].attributes.rising\nlet temp_hum = global.get(\"temp_hum\") ?? {}\n\nif (\n    temp_hum[\"exterior\"]?.[\"temperature\"]?.last_changed &&\n    temp_hum[\"exterior\"]?.[\"humidity\"]?.last_changed &&\n    temp_hum[\"exterior\"]?.[\"temperature\"]?.value &&\n    temp_hum[\"exterior\"]?.[\"humidity\"]?.value\n    && (new Date().getTime() - temp_hum[\"exterior\"][\"temperature\"].last_changed) / 1000 < 60 * 60 * 24\n    && (new Date().getTime() - temp_hum[\"exterior\"][\"humidity\"].last_changed) / 1000 < 60 * 60 * 24\n) {\n    let ext_temp = temp_hum[\"exterior\"][\"temperature\"].value\n    msg.payload = {\n        ext_temperature: ext_temp < 0 ? 0 : ext_temp > 50 ? 50 : ext_temp,\n        ext_humidity: temp_hum[\"exterior\"][\"humidity\"].value,\n        ext_metabolic: 1.1\n    }\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":240,"wires":[["d95b08d98db0f789"]]},{"id":"d95b08d98db0f789","type":"comfort","z":"a1ed8ea56c7ba1f9","name":"ext comfort","tempField":"payload.ext_temperature","tempFieldType":"msg","mrtField":"payload.temperature","mrtFieldType":"operative","humidityField":"payload.ext_humidity","humidityFieldType":"msg","airspeedField":"0","airspeedFieldType":"num","metabolicRateField":"payload.ext_metabolic","metabolicRateFieldType":"msg","clothingLevelField":"0.5","clothingLevelFieldType":"num","comfortField":"ext_comfort","comfortFieldType":"msg","sensationField":"sensation","sensationFieldType":"msg","x":335,"y":240,"wires":[["c63efa760a181c5e"]],"l":false},{"id":"c63efa760a181c5e","type":"function","z":"a1ed8ea56c7ba1f9","name":"prepare int_comfort","func":"let rising = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].attributes.rising\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nmsg.payload = []\n\nfor (let area of Object.keys(temp_hum).filter(area => area != \"exterior\")) {\n    if (\n        temp_hum[area]?.[\"temperature\"]?.last_changed &&\n        temp_hum[area]?.[\"humidity\"]?.last_changed &&\n        temp_hum[area]?.[\"temperature\"]?.value &&\n        temp_hum[area]?.[\"humidity\"]?.value\n        && (new Date().getTime() - temp_hum[area][\"temperature\"].last_changed) / 1000 < 60 * 60 * 24\n        && (new Date().getTime() - temp_hum[area][\"humidity\"].last_changed) / 1000 < 60 * 60 * 24\n    ) {\n        let area_temp = temp_hum[area][\"temperature\"].value\n        msg.payload.push({\n            linked_area: area,\n            area_temperature: area_temp < 0 ? 0 : area_temp > 50 ? 50 : area_temp,\n            area_humidity: temp_hum[area][\"humidity\"].value,\n            area_metabolic: 1.1\n        })\n    }\n}\n\nif (msg.payload.length != 0) {\n    temp_hum[\"exterior\"][\"comfort\"] = Math.round(msg.ext_comfort * 100) / 100\n    global.set(\"temp_hum\", temp_hum)\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":240,"wires":[["79bc1bf28559d083"]]},{"id":"79bc1bf28559d083","type":"split","z":"a1ed8ea56c7ba1f9","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":595,"y":240,"wires":[["69518ea9e8a645cd"]],"l":false},{"id":"69518ea9e8a645cd","type":"comfort","z":"a1ed8ea56c7ba1f9","name":"area comfort","tempField":"payload.area_temperature","tempFieldType":"msg","mrtField":"payload.temperature","mrtFieldType":"operative","humidityField":"payload.area_humidity","humidityFieldType":"msg","airspeedField":"0","airspeedFieldType":"num","metabolicRateField":"payload.area_metabolic","metabolicRateFieldType":"msg","clothingLevelField":"0.5","clothingLevelFieldType":"num","comfortField":"payload.area_comfort","comfortFieldType":"msg","sensationField":"payload.sensation","sensationFieldType":"msg","x":645,"y":240,"wires":[["23c78e1e6de763dc"]],"l":false},{"id":"23c78e1e6de763dc","type":"join","z":"a1ed8ea56c7ba1f9","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":695,"y":240,"wires":[["3f635672928b342e"]],"l":false},{"id":"c93168378253bda3","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 563","links":["9b2083e9cebe44ba"],"x":55,"y":360,"wires":[["7b58ef7ea1d65ee2"]]},{"id":"7b58ef7ea1d65ee2","type":"function","z":"a1ed8ea56c7ba1f9","name":"recommendations","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nlet msgs = []\n\nlet windows = msg.windows.map(w => ({ ...w, linked_area: temp_hum[w.linked_area] ? w.linked_area : \"home\" }))\nlet humidity_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state)\nlet areas = [... new Set(windows.map(w => w.linked_area))]\n\nfor (let area of areas) {\n    if (!temp_hum[area][\"recommendation\"]) {\n        temp_hum[area][\"recommendation\"] = { count: 0 }\n    }\n\n    let windows_area_on = windows.filter(w => w.state == \"on\" && w.linked_area == area)\n    let windows_area_off = windows.filter(w => w.state == \"off\" && w.linked_area == area)\n\n    if (in_home_zone && windows_area_on.length != 0 && temp_hum[area][\"temperature\"].high && temp_hum[\"exterior\"][\"comfort\"] > temp_hum[area][\"comfort\"] && temp_hum[area][\"temperature\"].tendency > 0) {\n        setRecommendations(area)\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area, alert: \"outside_max_temp_close\", windows_alias: get_windows_alias(windows_area_on) })\n    } else if (in_home_zone && windows_area_on.length != 0 && temp_hum[area][\"temperature\"].low && temp_hum[\"exterior\"][\"comfort\"] < temp_hum[area][\"comfort\"] && temp_hum[area][\"temperature\"].tendency < 0) {\n        setRecommendations(area)\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area, alert: \"outside_min_temp_close\", windows_alias: get_windows_alias(windows_area_on) })\n    } else if (in_home_zone && windows_area_on.length == 0 && temp_hum[area][\"temperature\"].high && temp_hum[\"exterior\"][\"comfort\"] < temp_hum[area][\"comfort\"]) {\n        setRecommendations(area)\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area, alert: \"inside_max_temp_open\", windows_alias: get_windows_alias(windows_area_off) })\n    } else if (in_home_zone && windows_area_on.length == 0 && !temp_hum[area][\"temperature\"].high && !temp_hum[area][\"temperature\"].low && temp_hum[area][\"humidity\"].high\n        && dew_point_calc(temp_hum[\"exterior\"][\"temperature\"].value, temp_hum[\"exterior\"][\"humidity\"].value > humidity_max ? temp_hum[\"exterior\"][\"humidity\"].value : humidity_max) < dew_point_calc(temp_hum[area][\"temperature\"].value, temp_hum[area][\"humidity\"].value)\n    ) {\n        setRecommendations(area)\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area, alert: \"inside_max_hum_open\", windows_alias: get_windows_alias(windows_area_off) })\n    } else if (temp_hum[area][\"recommendation\"].count != 0) {\n        temp_hum[area][\"recommendation\"].count = 0\n        msgs.push({ count: temp_hum[area][\"recommendation\"].count, linked_area: area })\n    }\n    global.set(\"temp_hum\", temp_hum)\n}\nreturn [msgs]\n\nfunction get_windows_alias(windows) {\n    return windows.map(w => w.alias ?? w.linked_area)\n}\n\nfunction setRecommendations(area) {\n    temp_hum[area][\"recommendation\"].count++\n}\n\nfunction dew_point_calc(temp, hum) {\n    let gamma = (17.27 * temp) / (237.7 + temp) + Math.log(hum / 100)\n    return (237.7 * gamma) / (17.27 - gamma)\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":360,"wires":[["61710fce0498e0de"]]},{"id":"14641d23f914ef77","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 641","mode":"link","links":["e53334a6f05a9609"],"x":475,"y":360,"wires":[]},{"id":"8a049698d7f3393d","type":"function","z":"a1ed8ea56c7ba1f9","name":"set home comfort","func":"const average = array => array.reduce((a, b) => a + b) / array.length\n\nlet areas = Object.keys(msg.temp_hum).filter(a => a != \"exterior\" && a != \"home\")\nif (areas.length != 0) {\n    if (!msg.temp_hum[\"home\"]) { msg.temp_hum[\"home\"] = {} }\n    msg.temp_hum[\"home\"][\"comfort\"] = average(areas.map(area => msg.temp_hum[area][\"comfort\"]))\n    return { temp_hum: msg.temp_hum, windows: msg.windows }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":300,"wires":[["1b1a9be7de209a76"]]},{"id":"9b2083e9cebe44ba","type":"link out","z":"a1ed8ea56c7ba1f9","name":"set home temp|hum","mode":"link","links":["c93168378253bda3","a6ae2de50ab53388"],"x":735,"y":300,"wires":[]},{"id":"1eec5f3259545a8e","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 643","mode":"link","links":["e473fb03a509f4cf"],"x":915,"y":240,"wires":[]},{"id":"e473fb03a509f4cf","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 564","links":["1eec5f3259545a8e"],"x":55,"y":300,"wires":[["8a049698d7f3393d"]]},{"id":"3f635672928b342e","type":"function","z":"a1ed8ea56c7ba1f9","name":"set comforts","func":"msg.temp_hum = global.get(\"temp_hum\") ?? {}\n\nfor (let comfort of msg.payload) {\n    if (msg.temp_hum[comfort.linked_area]) {\n        msg.temp_hum[comfort.linked_area][\"comfort\"] = Math.round(comfort.area_comfort * 100) / 100\n    }\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":240,"wires":[["1eec5f3259545a8e"]]},{"id":"1b1a9be7de209a76","type":"function","z":"a1ed8ea56c7ba1f9","name":"set home temperature","func":"let temperature_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state)\nlet temperature_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state)\nconst average = array => array.reduce((a, b) => a + b) / array.length\nlet linked_area = \"home\"\n\nlet areas = Object.keys(msg.temp_hum).filter(a => a != \"exterior\" && a != \"home\")\nif (areas.length != 0) {\n    let value = average(areas.map(a => msg.temp_hum[a][\"temperature\"].value))\n\n    if (!msg.temp_hum[linked_area]) { msg.temp_hum[linked_area] = {} }\n    if (!msg.temp_hum[linked_area][\"temperature\"]) { msg.temp_hum[linked_area][\"temperature\"] = { value: value, mean_hour: value, last_changed: new Date().getTime() } }\n\n    let timeElapsed = parseInt((new Date().getTime() - msg.temp_hum[linked_area][\"temperature\"].last_changed) / 1000)\n    let mean_10min = meanCalc(timeElapsed, 600, value, msg.temp_hum[linked_area][\"temperature\"].value)\n    let mean_hour = meanCalc(timeElapsed, 3600, mean_10min, msg.temp_hum[linked_area][\"temperature\"].mean_hour)\n    let mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000\n\n    msg.temp_hum[linked_area][\"temperature\"].high = temperature_max <= (Math.ceil(10 * mean_10min) / 10)\n    msg.temp_hum[linked_area][\"temperature\"].low = (Math.ceil(10 * mean_10min) / 10) <= temperature_min\n    msg.temp_hum[linked_area][\"temperature\"].last_changed = new Date().getTime()\n    msg.temp_hum[linked_area][\"temperature\"].tendency = mean_hour_tendency\n    msg.temp_hum[linked_area][\"temperature\"].mean_hour = mean_hour\n    msg.temp_hum[linked_area][\"temperature\"].value = mean_10min\n\n    return msg\n}\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":300,"wires":[["b7d0f8f3905158fc"]]},{"id":"b7d0f8f3905158fc","type":"function","z":"a1ed8ea56c7ba1f9","name":"set home humidity","func":"let humidity_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state)\nlet humidity_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state)\nconst average = array => array.reduce((a, b) => a + b) / array.length\nlet linked_area = \"home\"\n\nlet areas = Object.keys(msg.temp_hum).filter(a => a != \"exterior\" && a != \"home\")\nif (areas.length != 0) {\n    let value = average(areas.map(a => msg.temp_hum[a][\"humidity\"].value))\n\n    if (!msg.temp_hum[linked_area]) { msg.temp_hum[linked_area] = {} }\n    if (!msg.temp_hum[linked_area][\"humidity\"]) { msg.temp_hum[linked_area][\"humidity\"] = { value: value, mean_hour: value, last_changed: new Date().getTime() } }\n\n    let timeElapsed = parseInt((new Date().getTime() - msg.temp_hum[linked_area][\"humidity\"].last_changed) / 1000)\n    let mean_10min = meanCalc(timeElapsed, 600, value, msg.temp_hum[linked_area][\"humidity\"].value)\n    let mean_hour = meanCalc(timeElapsed, 3600, mean_10min, msg.temp_hum[linked_area][\"humidity\"].mean_hour)\n    let mean_hour_tendency = 2 * Math.round((mean_10min - mean_hour) * 1000) / 1000\n\n    msg.temp_hum[linked_area][\"humidity\"].high = humidity_max <= (Math.ceil(10 * mean_10min) / 10)\n    msg.temp_hum[linked_area][\"humidity\"].low = (Math.ceil(10 * mean_10min) / 10) <= humidity_min\n    msg.temp_hum[linked_area][\"humidity\"].last_changed = new Date().getTime()\n    msg.temp_hum[linked_area][\"humidity\"].tendency = mean_hour_tendency\n    msg.temp_hum[linked_area][\"humidity\"].mean_hour = mean_hour\n    msg.temp_hum[linked_area][\"humidity\"].value = mean_10min\n\n    global.set(\"temp_hum\", msg.temp_hum)\n    return msg\n}\n\nfunction meanCalc(timeElapsed, limit, value, old_value) {\n    timeElapsed = timeElapsed > limit ? limit : timeElapsed\n    return Math.round(((timeElapsed / limit) * value + ((limit - timeElapsed) / limit) * old_value) * 100) / 100\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":300,"wires":[["9b2083e9cebe44ba"]]},{"id":"65e2d708bfd3a83c","type":"catch","z":"ba6d40c8a95e6048","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":60,"wires":[["8f7048ff96eb8578"]]},{"id":"9e7bb1628fd2bbfe","type":"subflow:ad3b29a5dd67898f","z":"ba6d40c8a95e6048","name":"","x":460,"y":60,"wires":[["959c627d953cb72a"]]},{"id":"8f7048ff96eb8578","type":"change","z":"ba6d40c8a95e6048","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Devices","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":60,"wires":[["9e7bb1628fd2bbfe"]]},{"id":"6559fc2c5de9946a","type":"function","z":"ba6d40c8a95e6048","name":"resend low battery notify","func":"let notifications = global.get(\"notifications\") ?? {}\nlet lowBatteryCount = 0\n\nfor (let notificationsKey of Object.keys(notifications)) {\n    if (notificationsKey.indexOf(\"battery_lvl\") != -1) {\n        lowBatteryCount++\n    }\n}\n\nif (lowBatteryCount != 0) {\n    msg.title = \"Niveau de batterie faible\"\n    if (lowBatteryCount == 1) {\n        msg.message = \"Vous avez un appareil avec un niveau de batterie faible\"\n    } else {\n        msg.message = \"Vous avez plusieurs appareils avec des niveaux de batterie faible\"\n    }\n    msg.speak = msg.message + \". Pour en savoir plus, regardez vos notifications\"\n    msg.send_mobile = true\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":400,"wires":[["d6afa5a2e3160716","820da6a0a92eb2d6"]]},{"id":"75b8b46b910cdff3","type":"delay","z":"ba6d40c8a95e6048","name":"","pauseType":"delay","timeout":"80","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":280,"y":400,"wires":[["6559fc2c5de9946a"]]},{"id":"820da6a0a92eb2d6","type":"subflow:dbf17bea6affd2ec","z":"ba6d40c8a95e6048","name":"","x":800,"y":400,"wires":[]},{"id":"d9af9c9a45cf1f05","type":"comment","z":"ba6d40c8a95e6048","name":"low battery level","info":"","x":120,"y":340,"wires":[]},{"id":"c3cc9c54bc3b086f","type":"server-events","z":"ba6d40c8a95e6048","name":"battery","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"state_changed","eventData":"{\"new_state\":{\"attributes\":{\"device_class\":\"battery\"}},\"old_state\":{\"attributes\":{\"device_class\":\"battery\"}}}","waitForRunning":true,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":90,"y":460,"wires":[["c3135ff11b3c51da"]]},{"id":"d753d902eb39a35a","type":"server-state-changed","z":"ba6d40c8a95e6048","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":400,"wires":[["75b8b46b910cdff3"],[]]},{"id":"4eceeb0febbac731","type":"server-state-changed","z":"ba6d40c8a95e6048","name":"low_battery_level","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.low_battery_level","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"low_battery_level","propertyType":"msg","value":"","valueType":"entityState"}],"x":460,"y":460,"wires":[["c0449feacd97696f"]]},{"id":"c103be236a96a411","type":"comment","z":"ba6d40c8a95e6048","name":"devices_controls","info":"","x":120,"y":140,"wires":[]},{"id":"549b31dea7b04ede","type":"link in","z":"ba6d40c8a95e6048","name":"devices_control","links":["5dcebeddf5b32d66"],"x":55,"y":200,"wires":[["7c30c782df0ec100"]]},{"id":"c0449feacd97696f","type":"ha-get-entities","z":"ba6d40c8a95e6048","name":"","server":"c87720f17866318d","version":1,"rules":[{"property":"attributes.device_class","logic":"is","value":"battery","valueType":"str"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"devices","outputResultsCount":1,"x":630,"y":460,"wires":[["292e3bd02ad1d797"]]},{"id":"c3135ff11b3c51da","type":"api-current-state","z":"ba6d40c8a95e6048","name":"get low_battery_level","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.low_battery_level","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"low_battery_level","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":260,"y":460,"wires":[["c0449feacd97696f"]]},{"id":"3d7c97bdf077e68d","type":"link out","z":"ba6d40c8a95e6048","name":"link out 12","mode":"link","links":["e53334a6f05a9609"],"x":935,"y":460,"wires":[]},{"id":"292e3bd02ad1d797","type":"function","z":"ba6d40c8a95e6048","name":"check battery level","func":"let notifications = global.get(\"notifications\") ?? {}\nlet low_battery_level = msg.low_battery_level\nlet regex = /^\\d+(\\.\\d+)?$/\nlet devices = msg.devices\nlet msgs = []\n\nfor (let d of devices) {\n    let battery_level = (d.state === \"on\" ? 5 : parseInt(d.state))\n    let notification_id = \"battery_lvl_\" + d.entity_id.split(\".\")[1]\n    let battery_phone = d.entity_id.includes(\"_battery_level\")\n    if (!notifications[notification_id] && (d.state === \"on\" || (regex.test(d.state) && parseInt(d.state) <= low_battery_level))) {\n        msgs.push({\n            notification_id: notification_id,\n            data: { tag: notification_id },\n            title: \"Niveau de batterie \" + (battery_level <= 5 ? \"critique\" : \"faible\"),\n            message: \"Veuillez \" + (battery_phone ? \"recharger\" : \"remplacer\") + \" la batterie \" + d.attributes.friendly_name + \" (\" + battery_level + \"%)\",\n            speak: \"Veuillez \" + (battery_phone ? \"recharger\" : \"remplacer\") + \" la batterie \" + d.attributes.friendly_name,\n            alert_type: battery_level <= 5 ? \"error\" : \"warning\",\n            send_mobile: true\n        })\n    } else if (notifications[notification_id] && (d.state === \"off\" || (regex.test(d.state) && parseInt(d.state) >= (battery_phone ? 100 : low_battery_level + 10)))) {\n        msgs.push({\n            notification_id: notification_id,\n            speak: \"Batterie \" + d.attributes.friendly_name + (d.state === \"off\" ? \" √† √©t√© remplac√©e\" : \" √† \" + battery_level + \"%\"),\n            clear_on_phone: true,\n            dismiss: true\n        })\n    }\n}\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":460,"wires":[["3d7c97bdf077e68d"]]},{"id":"d6afa5a2e3160716","type":"subflow:ba09e97f2ed22f2b","z":"ba6d40c8a95e6048","name":"","x":660,"y":400,"wires":[]},{"id":"ecff4ad6472d61c2","type":"comment","z":"ba6d40c8a95e6048","name":"disable fonctionnalities on low battery","info":"","x":190,"y":540,"wires":[]},{"id":"224493260450eaf6","type":"function","z":"ba6d40c8a95e6048","name":"check last_changed","func":"let notifications = global.get(\"notifications\") ?? {}\nlet illuminances = global.get(\"illuminances\") ?? {}\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nlet msgs = []\n\nfor (let area of Object.keys(illuminances)) {\n    if (notifications[\"disable_illuminance_\" + area] === undefined && (new Date().getTime() - illuminances[area].last_changed) / 1000 > 60 * 60 * 24) {\n        let message = \"Probl√®me capteur de luminosit√© de la zone [ \" + area + \" ] (absence de donn√©es depuis plus de 24h)\"\n        msgs.push({\n            notification_id: \"disable_illuminance_\" + area,\n            title: \"Compensation lumi√®re nuages d√©sactiv√©e\",\n            message: message,\n            speak: message,\n            alert_type: \"error\",\n            send_mobile: true\n        })\n    } else if (notifications[\"disable_illuminance_\" + area] !== undefined && (new Date().getTime() - illuminances[area].last_changed) / 1000 < 60 * 60 * 24) {\n        msgs.push({\n            notification_id: \"disable_illuminance_\" + area,\n            clear_on_phone: true,\n            dismiss: true\n        })\n    }\n}\n\nfor (let area of Object.keys(temp_hum).filter(x => x !== \"home\")) {\n    if (notifications[\"disable_temperature_\" + area] === undefined && (new Date().getTime() - temp_hum[area][\"temperature\"].last_changed) / 1000 > 60 * 60 * 24) {\n        let message = \"Probl√®me capteur de temp√©rature \" + (temp_hum[area].alias ?? (\"de la zone [ \" + area + \" ]\")) + \" (absence de donn√©es depuis plus de 24h)\"\n        msgs.push({\n            notification_id: \"disable_temperature_\" + area,\n            title: \"Recommandation temp√©ratures et humidit√©s d√©sactiv√©e\",\n            message: message,\n            speak: message,\n            alert_type: \"error\",\n            send_mobile: true\n        })\n    } else if (notifications[\"disable_temperature_\" + area] !== undefined && (new Date().getTime() - temp_hum[area][\"temperature\"].last_changed) / 1000 < 60 * 60 * 24) {\n        msgs.push({\n            notification_id: \"disable_temperature_\" + area,\n            clear_on_phone: true,\n            dismiss: true\n        })\n    }\n    if (notifications[\"disable_humidity_\" + area] === undefined && (new Date().getTime() - temp_hum[area][\"humidity\"].last_changed) / 1000 > 60 * 60 * 24) {\n        let message = \"Probl√®me capteur d'humidit√© \" + (temp_hum[area].alias ?? (\"de la zone [ \" + area + \" ]\")) + \" (absence de donn√©es depuis plus de 24h)\"\n        msgs.push({\n            notification_id: \"disable_humidity_\" + area,\n            title: \"Recommandation temp√©ratures et humidit√©s d√©sactiv√©e\",\n            message: message,\n            speak: message,\n            alert_type: \"error\",\n            send_mobile: true\n        })\n    } else if (notifications[\"disable_humidity_\" + area] !== undefined && (new Date().getTime() - temp_hum[area][\"humidity\"].last_changed) / 1000 < 60 * 60 * 24) {\n        msgs.push({\n            notification_id: \"disable_humidity_\" + area,\n            clear_on_phone: true,\n            dismiss: true\n        })\n    }\n}\n\nreturn [msgs]","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":600,"wires":[["825cf31751b11239"]]},{"id":"825cf31751b11239","type":"link out","z":"ba6d40c8a95e6048","name":"link out 13","mode":"link","links":["e53334a6f05a9609"],"x":535,"y":600,"wires":[]},{"id":"959c627d953cb72a","type":"link out","z":"ba6d40c8a95e6048","name":"link out 14","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":60,"wires":[]},{"id":"a6ae2de50ab53388","type":"link in","z":"ba6d40c8a95e6048","name":"link in 11","links":["9b2083e9cebe44ba"],"x":255,"y":600,"wires":[["224493260450eaf6"]]},{"id":"32ee818592f62579","type":"inject","z":"ba6d40c8a95e6048","name":"5 min","props":[],"repeat":"","crontab":"*/5 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":110,"y":600,"wires":[["6c97e123191ccf7e"]]},{"id":"6c97e123191ccf7e","type":"delay","z":"ba6d40c8a95e6048","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":195,"y":600,"wires":[["224493260450eaf6"]],"l":false},{"id":"5a9c7e7ff308b6a6","type":"link in","z":"ba6d40c8a95e6048","name":"link in 12","links":["f9f8f8a690320c67"],"x":235,"y":140,"wires":[["a62894f27b2fd724"]]},{"id":"a62894f27b2fd724","type":"function","z":"ba6d40c8a95e6048","name":"reinit onces global","func":"global.set(\"onces\", [])","outputs":0,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":140,"wires":[]},{"id":"0d867937449fe1b2","type":"function","z":"ba6d40c8a95e6048","name":"set controls","func":"if (msg.payload === undefined || msg.payload === \"True\") {\n    let waits = global.get(\"waits\") ?? {}\n    let then_msgs = []\n    let wait_msgs = []\n\n    if (waits[msg.wait_id]) {\n        delete waits[msg.wait_id]\n        global.set(\"waits\", waits)\n    }\n\n    for (let t of Object.keys(msg.then ?? {})) {\n        let state = Array.isArray(msg.then[t]) && msg.then[t].length == 2 ? msg.then[t][0] : msg.then[t]\n        let delay = Array.isArray(msg.then[t]) && msg.then[t].length == 2 ? msg.then[t][1] * 1000 : 0\n        let match = t.match(/wait\\s+(\\{\\{\\s*.*?\\s*\\}\\})\\s+for\\s+(\\d+)/)\n        if (match) {\n            let wait_id = `${msg.id}_${Object.keys(msg.then).indexOf(t)}`\n            waits[wait_id] = {\n                template: match[1],\n                intime: msg.then[t].intime ?? {},\n                timeout: msg.then[t].timeout ?? {},\n                expiration: new Date().getTime() + parseFloat(match[2]) * 1000\n            }\n            global.set(\"waits\", waits)\n            wait_msgs.push({\n                wait_id: wait_id,\n                template: match[1],\n                then: msg.then[t].intime ?? {},\n                timeout: msg.then[t].timeout ?? {},\n                delay: parseFloat(match[2]) * 1000\n            })\n        } else if (\n            global.get(\"homeassistant\").homeAssistant.states?.[t]?.state != msg.then[t]\n            || t.startsWith(\"emulate.\")\n            || t === \"control\"\n            || t === \"notification\"\n        ) {\n            then_msgs.push({ entity_id: t, state: state, delay: delay })\n        } else if (t.startsWith(\"once.\")) {\n            let onces = global.get(\"onces\") ?? []\n            if (!(onces.includes([t + \"_\" + state]))) {\n                onces.push([t + \"_\" + msg.then[t]])\n                then_msgs.push({ entity_id: t.substring(5), state: state, delay: delay })\n                global.set(\"onces\", onces)\n            }\n        }\n    }\n    return [wait_msgs, then_msgs]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":200,"wires":[["0e908dc16d77ef4f"],["6c7fa4ee75bcb64d"]]},{"id":"9bf1fd5101e55866","type":"api-render-template","z":"ba6d40c8a95e6048","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":105,"y":260,"wires":[["4abb33b84242ab60"]],"l":false},{"id":"69b0495e3ded25fc","type":"delay","z":"ba6d40c8a95e6048","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":155,"y":260,"wires":[["5ed88206ae42799e"]],"l":false},{"id":"4abb33b84242ab60","type":"link out","z":"ba6d40c8a95e6048","name":"link out 19","mode":"link","links":["f5d01cdf10d12c3a"],"x":355,"y":260,"wires":[]},{"id":"f5d01cdf10d12c3a","type":"link in","z":"ba6d40c8a95e6048","name":"devices control msg.then","links":["4abb33b84242ab60","0bd215ba7b8e1569","52fc40d8d193d75b","93ac910693b94091"],"x":305,"y":200,"wires":[["0d867937449fe1b2"]]},{"id":"5ed88206ae42799e","type":"function","z":"ba6d40c8a95e6048","name":"timeout","func":"let waits = global.get(\"waits\") ?? {}\n\nlet timeout = {}\nfor (let wait_id of Object.keys(waits)) {\n    if (waits[wait_id].expiration <= new Date().getTime()) {\n        if (wait_id === msg.wait_id) {\n            timeout = msg.timeout\n        }\n        delete waits[wait_id]\n    }\n}\nglobal.set(\"waits\", waits)\nif (Object.keys(timeout).length > 0) {\n    return { then: timeout }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":260,"wires":[["4abb33b84242ab60"]]},{"id":"71b56c97007bcaef","type":"subflow:723d4991c3c87385","z":"ba6d40c8a95e6048","name":"","x":730,"y":260,"wires":[]},{"id":"882246a5bfd6fb9e","type":"function","z":"ba6d40c8a95e6048","name":"notification ?","func":"if (msg.entity_id == \"notification\") {\n    msg = { ...msg.state }\n    return [msg, null]\n} else {\n    return [null, msg]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":260,"wires":[["a59613d3b7a13d66"],["71b56c97007bcaef"]]},{"id":"8633757000801880","type":"link out","z":"ba6d40c8a95e6048","name":"link out 21","mode":"link","links":["e53334a6f05a9609"],"x":835,"y":260,"wires":[]},{"id":"0e908dc16d77ef4f","type":"link out","z":"ba6d40c8a95e6048","name":"link out 23","mode":"link","links":["3554a81583dd150f"],"x":515,"y":200,"wires":[]},{"id":"3554a81583dd150f","type":"link in","z":"ba6d40c8a95e6048","name":"link in 14","links":["0e908dc16d77ef4f"],"x":55,"y":260,"wires":[["9bf1fd5101e55866","69b0495e3ded25fc"]]},{"id":"6c7fa4ee75bcb64d","type":"link out","z":"ba6d40c8a95e6048","name":"link out 24","mode":"link","links":["04f46d8dc6e4499e"],"x":515,"y":200,"wires":[]},{"id":"04f46d8dc6e4499e","type":"link in","z":"ba6d40c8a95e6048","name":"link in 15","links":["6c7fa4ee75bcb64d"],"x":405,"y":260,"wires":[["42dc679ae9726636"]]},{"id":"0ed139bb198b3221","type":"api-render-template","z":"ba6d40c8a95e6048","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":255,"y":200,"wires":[["0d867937449fe1b2"]],"l":false},{"id":"7c30c782df0ec100","type":"function","z":"ba6d40c8a95e6048","name":"conditions","func":"let home_configuration = global.get(\"home_configuration\") ?? {}\nlet entity_id = msg.entity_id\nlet state = msg.state\nlet msgs = []\n\nlet count = 0\nfor (let c of msg.control_device) {\n    msgs.push({\n        template: update_template(c[\"if\"]),\n        then: c[\"then\"],\n        id: `${msg.id}_${count}`\n    })\n    count++\n}\nreturn [msgs]\n\nfunction update_template(template) {\n    if (template.startsWith(\"raw \")) {\n        return add_globals(template) + template.substring(4)\n    }\n    let ts = template.replace(/\\{\\{|\\}\\}/g, \"\").trim().split(\" \")\n    let updated_template = []\n    for (let i = 0; i < ts.length; i++) {\n        updated_template.push((ts[i].includes(`states(\"${entity_id}\")`) ? (isNaN(state) ? `\"${state}\"` : state) : ts[i]))\n    }\n    return add_globals(template) + `{{ ${updated_template.join(\" \")} }}`\n}\n\nfunction add_globals(template) {\n    if (template.includes(\"global.\")) {\n        let included_globals = global.keys().filter(g => template.includes(\"global.\" + g))\n        return \"{% set global = {\" + included_globals.map(x => (`\"${x}\": ${JSON.stringify(global.get(x) ?? {})}`)).join(\",\") + \"} %}\"\n    }\n    return \"\"\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":200,"wires":[["0ed139bb198b3221"]]},{"id":"42dc679ae9726636","type":"delay","z":"ba6d40c8a95e6048","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":455,"y":260,"wires":[["882246a5bfd6fb9e"]],"l":false},{"id":"97bc352aaa75228c","type":"catch","z":"6838183963219fc9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["f4d1fbfec928418b"]]},{"id":"8507f5b36fb47028","type":"subflow:ad3b29a5dd67898f","z":"6838183963219fc9","name":"","x":460,"y":40,"wires":[["b925a40aca67e6ca"]]},{"id":"f4d1fbfec928418b","type":"change","z":"6838183963219fc9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Heater","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8507f5b36fb47028"]]},{"id":"5c035d30aa0eeaa4","type":"link out","z":"6838183963219fc9","name":"link out 436","mode":"link","links":["e53334a6f05a9609"],"x":515,"y":680,"wires":[]},{"id":"d41bfc19bf37e870","type":"function","z":"6838183963219fc9","name":"clean target","func":"let match = msg.payload.match(/\\b(2[0-4]|1?\\d)(\\.\\d+)?\\b/)\nmsg.notification_id = \"heater_temp_lock\"\nmatch = match ? match[0] : \"Auto\"\n\nif (match === \"Auto\") {\n    return [\n        { notification_id: \"heater_temp_lock\", speak: \"Chauffage en mode auto\", dismiss: true },\n        { entity_id: \"input_text.heat_temp\", state: match }\n    ]\n} else {\n    return [\n        {\n            notification_id: \"heater_temp_lock\",\n            alert_type: \"success\",\n            title: \"Chauffage v√©rrouill√©\",\n            message: \"Chauffage verrouill√© √† \" + match.replace(\".\", \",\") + \"¬∞C\",\n            speak: \"Chauffage verrouill√© √† \" + match.replace(\".\", \",\") + \"¬∞\",\n            send_mobile: false\n        },\n        { entity_id: \"input_text.heat_temp\", state: match }\n    ]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":680,"wires":[["c46314750c9075fb"],["0762b670d29c807b"]]},{"id":"96ac39e8656feb5c","type":"function","z":"6838183963219fc9","name":"heaters off","func":"return [msg.heaters.map(h => ({ entity_id: h.entity_id, state: \"off\" }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":180,"wires":[["771bec09a66019dd"]]},{"id":"771bec09a66019dd","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":790,"y":180,"wires":[]},{"id":"8f3b675395255275","type":"function","z":"6838183963219fc9","name":"get heat_temp","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state === \"on\"\nlet min_distance = global.get(\"homeassistant\").homeAssistant.states[\"input_number.min_distance\"].state\nlet heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"].state\nlet zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes\nlet home_configuration = global.get(\"home_configuration\") ?? {}\nlet heater_config = home_configuration.heater_config ?? {}\n\nif (in_home_zone) {\n    let heat_temp_config = heater_config[\"in_home_zone\"]?.[\"temperature\"] ?? \"Auto\"\n    if (heat_temp != heat_temp_config) {\n        return [\n            { entity_id: \"input_text.heat_temp\", state: heat_temp_config },\n            { zone: \"in_home_zone\", heat_temp: heat_temp_config }\n        ]\n    }\n} else if (zone_home.radius < min_distance && min_distance <= (heater_config[\"in_big_zone\"]?.[\"radius\"] * 1000 ?? 2000)) {\n    let heat_temp_config = heater_config[\"in_middle_zone\"]?.[\"temperature\"] ?? 17\n    if (heat_temp != heat_temp_config) {\n        return [\n            { entity_id: \"input_text.heat_temp\", state: heat_temp_config },\n            { zone: \"in_middle_zone\", heat_temp: heat_temp_config }\n        ]\n    }\n} else if ((heater_config[\"in_big_zone\"]?.[\"radius\"] * 1000 ?? 100000) < min_distance) {\n    let heat_temp_config = heater_config[\"in_big_zone\"]?.[\"temperature\"] ?? 12\n    if (heat_temp != heat_temp_config) {\n        return [\n            { entity_id: \"input_text.heat_temp\", state: heat_temp_config },\n            { zone: \"in_big_zone\", heat_temp: heat_temp_config }\n        ]\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":620,"wires":[["6153c6d661e2fc6b"],["c90b6bf0196b9043"]]},{"id":"08dcf323de916215","type":"function","z":"6838183963219fc9","name":"notification","func":"msg.notification_id = \"module_heat\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Chauffage d√©sactiv√©\"\n    msg.message = \"Module Chauffage d√©sactiv√©, les chauffages sont allum√©s\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":820,"wires":[["8d3c03ad03424be9"]]},{"id":"8d3c03ad03424be9","type":"link out","z":"6838183963219fc9","name":"link out 442","mode":"link","links":["e53334a6f05a9609"],"x":635,"y":820,"wires":[]},{"id":"4d094f27aedbb9d4","type":"function","z":"6838183963219fc9","name":"msgs heaters on","func":"return [msg.heaters.map(h => ({ entity_id: h.entity_id, state: \"on\" }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":880,"wires":[["47ba0eb8d0c9e430"]]},{"id":"47ba0eb8d0c9e430","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":550,"y":880,"wires":[]},{"id":"f4d57076103097ca","type":"link in","z":"6838183963219fc9","name":"alert temperature","links":["0dac8a656e626a27","92343d20b8540180"],"x":55,"y":240,"wires":[["74906d8bb03396e9"]]},{"id":"06d37632c6428263","type":"switch","z":"6838183963219fc9","name":"module_heat off ?","property":"module_heat","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":820,"wires":[["c6550e5457450613"]]},{"id":"6a698c348a5afd7f","type":"link out","z":"6838183963219fc9","name":"link out 447","mode":"link","links":["e53334a6f05a9609"],"x":615,"y":620,"wires":[]},{"id":"41f642fb8e8c5b67","type":"function","z":"6838183963219fc9","name":"notification","func":"let heat_temp = msg.heat_temp.toString().replace(\".\", \",\") + \"¬∞C\"\nlet zone = msg.zone\n\nlet notification = {\n    notification_id: \"heater_temp_lock\",\n    alert_type: \"success\",\n    send_mobile: true\n}\n\nif (zone === \"in_home_zone\") {\n    return {\n        notification_id: \"heater_temp_lock\",\n        clear_on_phone: true,\n        dismiss: true\n    }\n} else if (zone === \"in_middle_zone\") {\n    return {\n        title: \"Chauffage mode √©co\",\n        message: \"Chauffage verrouill√© √† \" + heat_temp,\n        ...notification\n    }\n} else if (zone === \"in_big_zone\") {\n    return {\n        title: \"Chauffage mode super √©co\",\n        message: \"Chauffage verrouill√© √† \" + heat_temp,\n        ...notification\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":620,"wires":[["6a698c348a5afd7f"]]},{"id":"fead020c09a0aa6e","type":"function","z":"6838183963219fc9","name":"heaters >","func":"msg.search = { \"is\": { linked_class: \"heater\", state: \"on\" } }\nmsg.output_name = \"heaters\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":180,"wires":[["b7a1bbe3c12c11dd"]]},{"id":"de632e789d59102b","type":"function","z":"6838183963219fc9","name":"heaters >","func":"msg.search = { \"is\": { linked_class: \"heater\" } }\nmsg.output_name = \"heaters\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":880,"wires":[["6eb6857eacfa7ad2"]]},{"id":"289b1cdf5cf523a1","type":"function","z":"6838183963219fc9","name":"check auto heat","func":"let json_exterior_average_temp = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state)\nlet temp_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state)\nlet heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.heat\"].state === \"on\"\n\nlet under_temp_min = json_exterior_average_temp[0] < temp_min\nlet has_changed = under_temp_min != heat\n\nif (has_changed) {\n    return [{ entity_id: \"input_boolean.heat\", state: under_temp_min ? \"on\" : \"off\" }, under_temp_min ? msg : null]\n} else {\n    return [null, under_temp_min ? msg : null]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":300,"wires":[["dbe29802804cc6ab","a58c778bb22dbbf1"],["5b871c278cf602d0"]]},{"id":"eb2186cf04837282","type":"function","z":"6838183963219fc9","name":"set target","func":"let notifications = global.get(\"notifications\") ?? {}\nlet temp_hum = global.get(\"temp_hum\") ?? {}\nlet linked_area = msg.linked_area\nlet entity_id = msg.entity_id\nlet windows = msg.windows\nlet state = msg.state\n\nif (temp_hum[msg.linked_area] === undefined) {\n    return [{ entity_id: entity_id, state: \"off\" }, { status: \"no_heater_in_area\", alias: msg.alias }]\n} else if (temp_hum[msg.linked_area] !== undefined) {\n    if ((new Date().getTime() - temp_hum[msg.linked_area]?.[\"temperature\"]?.last_changed) / 1000 > 20 * 60) {\n        return [{ entity_id: entity_id, state: \"off\" }, { status: \"outdated_temperature\", alias: msg.alias }]\n    } else if (windows.length > 0 && state === \"on\") {\n        return [{ entity_id: entity_id, state: \"off\" }, { status: \"window_open\", windows: msg.windows, alias: msg.alias }]\n    } else {\n        let heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"].state\n        if (heat_temp === \"Auto\") {\n            let scheduled = get_scheduled_temperature(msg.schedule, msg.current_time)\n            if (typeof scheduled.target === \"number\") {\n                return [{ entity_id: entity_id, state: (temp_hum[linked_area][\"temperature\"][\"value\"] < scheduled.target ? \"on\" : \"off\") }, null]\n            } else {\n                return [{ entity_id: entity_id, state: \"off\" }, { status: scheduled.status, alias: msg.alias, error: scheduled.error }]\n            }\n        } else if (!isNaN(parseFloat(heat_temp))) {\n            return [{ entity_id: entity_id, state: (temp_hum[linked_area][\"temperature\"][\"value\"] < parseFloat(heat_temp) ? \"on\" : \"off\") }, null]\n        }\n    }\n}\n\nfunction get_scheduled_temperature(schedule, current_time) {\n    let motion_heater = context.get(\"motion_heater\") ?? {}\n    let is_motion_class = msg.trigger_class == \"motion\"\n    let schedule_times = Object.keys(schedule)\n\n    if (schedule_times.length > 0) {\n        let schedule_time = schedule_times.find(s => s <= current_time)\n        let is_on_motion = schedule[schedule_time].includes(\"motion\")\n        let match = schedule[schedule_time].match(/-?\\d+(\\.\\d+)?/)\n        let target = match ? parseFloat(match[0]) : \"no_temp\"\n\n        if (target === \"no_temp\") {\n            return { target: \"error\", status: \"no_target\", error: schedule[schedule_time] }\n        } else {\n            if (is_motion_class && is_on_motion) {\n                motion_heater[msg.linked_area + \"_\" + schedule_time] = true\n                context.set(\"motion_heater\", motion_heater)\n            } else if (!is_on_motion) {\n                motion_heater = {}\n                context.set(\"motion_heater\", motion_heater)\n            }\n            return { target: target, status: \"\" }\n        }\n    } else {\n        return { target: \"error\", status: \"no_schedule\" }\n    }\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":420,"wires":[["f4789a90a8eeb4d0"],["f621e9781f3b4957"]]},{"id":"f4789a90a8eeb4d0","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":310,"y":420,"wires":[]},{"id":"0a45d820a250a03a","type":"function","z":"6838183963219fc9","name":"msgs heaters","func":"return [\n    msg.heaters.map(heater => ({\n        trigger_class: msg.linked_class,\n        current_time: msg.current_time,\n        ...heater\n    }))\n]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":305,"y":360,"wires":[["f8dac6913df2943a"]],"l":false},{"id":"fe7db153e4105d50","type":"link out","z":"6838183963219fc9","name":"link out 513","mode":"link","links":["e53334a6f05a9609"],"x":575,"y":420,"wires":[]},{"id":"8a955201a68a4d84","type":"function","z":"6838183963219fc9","name":"notification","func":"let notifications = global.get(\"notifications\") ?? {}\nlet notification = {\n    notification_id: \"heater_\" + msg.linked_area,\n    title: msg.alias[0].toUpperCase() + msg.alias.substring(1) + \" d√©sactiv√©\",\n    alert_type: \"warning\",\n    send_mobile: true\n}\n\nif (msg.status === \"window_open\" && msg.windows.length > 0) {\n    let message = msg.title + \". \" + setMessage(msg.windows)\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"no_target\") {\n    let message = msg.title + \". La consigne sp√©cifi√©e pour cet horaire est incorrect: \" + msg.error\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"outdated_temperature\") {\n    let message = msg.title + \". Le capteur ne renvoi plus de temp√©rature depuis plus de 20 minutes\"\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"no_heater_in_area\") {\n    let message = msg.title + \". Cette zone ne contient pas de capteur de temp√©rature\"\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"no_schedule\") {\n    let message = msg.title + \". Pas d'horaire de fonctionnement sp√©cifi√© pour ce chauffage\"\n    return {\n        ...notification,\n        message: message,\n        speak: message\n    }\n} else if (msg.status === \"heater_reactivated\" && notifications[msg.notification_id] !== undefined) {\n    return {\n        notification_id: \"heater_\" + msg.linked_area,\n        speak: msg.alias + \" r√©activ√©\",\n        dismiss: true\n    }\n}\n\nfunction setMessage(windows) {\n    let alias = []\n    for (let window of windows) {\n        alias.push(window.alias)\n    }\n    if (alias.length == 1) {\n        return \"La fen√™tre \" + alias[0] + \" est ouverte\"\n    } else {\n        let joinAlias = alias.join(\", \")\n        joinAlias = joinAlias.substring(0, joinAlias.lastIndexOf(\", \")) + \" et \" + joinAlias.substring(joinAlias.lastIndexOf(\", \") + 2)\n        return \"Les fen√™tres \" + joinAlias + \" sont ouvertes\"\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":420,"wires":[["fe7db153e4105d50"]]},{"id":"f8dac6913df2943a","type":"function","z":"6838183963219fc9","name":"windows >","func":"msg.search = { \"is\": { linked_class: \"window\", linked_area: msg.linked_area, state: \"on\" } }\nmsg.output_name = \"windows\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":360,"wires":[["9e6d0371dcff2efc"]]},{"id":"9d1e5df180bb1596","type":"link out","z":"6838183963219fc9","name":"link out 515","mode":"link","links":["9bdea07f699ed568"],"x":815,"y":300,"wires":[]},{"id":"9bdea07f699ed568","type":"link in","z":"6838183963219fc9","name":"link in 477","links":["9d1e5df180bb1596"],"x":55,"y":360,"wires":[["a92333cdb1a89159"]]},{"id":"a58c778bb22dbbf1","type":"function","z":"6838183963219fc9","name":"notification","func":"let notification_id = \"heater_auto\"\nlet alert_type = \"success\"\n\nif (msg.state === \"on\") {\n    return {\n        notification_id: notification_id,\n        alert_type: alert_type,\n        title: \"Chauffage automatique pr√™t\",\n        message: \"Chauffage automatique pr√™t, la temp√©rature est suffisamment basse\",\n        speak: msg.message,\n        send_mobile: true\n    }\n} else if (msg.state === \"off\") {\n    return {\n        notification_id: notification_id,\n        alert_type: alert_type,\n        title: \"Chauffage automatique d√©sactiv√©\",\n        message: \"Chauffage automatique d√©sactiv√©, la temp√©rature est suffisamment haute\",\n        speak: msg.message,\n        send_mobile: true\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":300,"wires":[["8ff031019adb02ce"]]},{"id":"8ff031019adb02ce","type":"link out","z":"6838183963219fc9","name":"link out 516","mode":"link","links":["e53334a6f05a9609"],"x":455,"y":300,"wires":[]},{"id":"a92333cdb1a89159","type":"function","z":"6838183963219fc9","name":"heaters >","func":"msg.search = { \"is\": { linked_class: \"heater\" } }\nmsg.output_name = \"heaters\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["68c24beaa2304246"]]},{"id":"5e73472c6012f08e","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":180,"wires":[["fead020c09a0aa6e"],[]]},{"id":"74906d8bb03396e9","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":650,"y":240,"wires":[["88a9a026a74344fe"],[]]},{"id":"eafe972177b0c41f","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":470,"y":560,"wires":[["8388fb50772457ce"],[]]},{"id":"8388fb50772457ce","type":"api-current-state","z":"6838183963219fc9","name":"heat_on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":640,"y":560,"wires":[["5f419255a67c43dd"],[]]},{"id":"93d7011fbd70b7f1","type":"server-state-changed","z":"6838183963219fc9","name":"heat_temp","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_text.heat_temp","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"Auto","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":100,"y":680,"wires":[["d41bfc19bf37e870"],[]]},{"id":"ba9acd878ee52157","type":"server-state-changed","z":"6838183963219fc9","name":"min_distance","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.min_distance","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":560,"wires":[["eafe972177b0c41f"]]},{"id":"a3982a46058980e4","type":"server-state-changed","z":"6838183963219fc9","name":"heat","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":180,"wires":[[],["5e73472c6012f08e"]]},{"id":"d91dea48227af123","type":"server-state-changed","z":"6838183963219fc9","name":"heat_temp","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.heat_temp","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"num","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"heat_temp","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":240,"wires":[["74906d8bb03396e9"]]},{"id":"716e7791eeb9e4cc","type":"server-state-changed","z":"6838183963219fc9","name":"module_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":470,"y":240,"wires":[["74906d8bb03396e9"]]},{"id":"63ecd474b475f903","type":"server-state-changed","z":"6838183963219fc9","name":"module_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_heat","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":820,"wires":[["06d37632c6428263","08dcf323de916215"]]},{"id":"b7a1bbe3c12c11dd","type":"subflow:3da7ebfd83a38899","z":"6838183963219fc9","name":"","x":515,"y":180,"wires":[["96ac39e8656feb5c"]],"l":false},{"id":"9e6d0371dcff2efc","type":"subflow:3da7ebfd83a38899","z":"6838183963219fc9","name":"","x":515,"y":360,"wires":[["29a6606aa98249a0"]],"l":false},{"id":"6eb6857eacfa7ad2","type":"subflow:3da7ebfd83a38899","z":"6838183963219fc9","name":"","x":255,"y":880,"wires":[["4d094f27aedbb9d4"]],"l":false},{"id":"68c24beaa2304246","type":"subflow:3da7ebfd83a38899","z":"6838183963219fc9","name":"","x":255,"y":360,"wires":[["0a45d820a250a03a"]],"l":false},{"id":"88a9a026a74344fe","type":"link out","z":"6838183963219fc9","name":"link out 566","mode":"link","links":["2529ee7d4b3a6ce6"],"x":775,"y":240,"wires":[]},{"id":"2529ee7d4b3a6ce6","type":"link in","z":"6838183963219fc9","name":"link in 516","links":["88a9a026a74344fe"],"x":55,"y":300,"wires":[["289b1cdf5cf523a1"]]},{"id":"29a6606aa98249a0","type":"link out","z":"6838183963219fc9","name":"link out 567","mode":"link","links":["bf2c70a02f300fcf"],"x":565,"y":360,"wires":[]},{"id":"bf2c70a02f300fcf","type":"link in","z":"6838183963219fc9","name":"link in 517","links":["29a6606aa98249a0"],"x":55,"y":420,"wires":[["eb2186cf04837282"]]},{"id":"c6550e5457450613","type":"link out","z":"6838183963219fc9","name":"link out 569","mode":"link","links":["3f48018dcc4fbd3c"],"x":415,"y":820,"wires":[]},{"id":"3f48018dcc4fbd3c","type":"link in","z":"6838183963219fc9","name":"link in 519","links":["c6550e5457450613"],"x":55,"y":880,"wires":[["de632e789d59102b"]]},{"id":"b925a40aca67e6ca","type":"link out","z":"6838183963219fc9","name":"link out 633","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"7e1da589e09923e8","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":570,"y":300,"wires":[]},{"id":"e98fd77afdd9134f","type":"function","z":"6838183963219fc9","name":"get time","func":"let d = new Date()\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n\nmsg.current_time = hour + \":\" + minute\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":300,"wires":[["9d1e5df180bb1596"]]},{"id":"6153c6d661e2fc6b","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":350,"y":620,"wires":[]},{"id":"a4ce1edeb26909ad","type":"comment","z":"6838183963219fc9","name":"module heat","info":"","x":110,"y":760,"wires":[]},{"id":"2ac75568394f822d","type":"comment","z":"6838183963219fc9","name":"distance set heat temp","info":"","x":140,"y":500,"wires":[]},{"id":"364cf7f0cc649f73","type":"comment","z":"6838183963219fc9","name":"core","info":"","x":90,"y":120,"wires":[]},{"id":"0762b670d29c807b","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":410,"y":680,"wires":[]},{"id":"4f4db780aee8760e","type":"inject","z":"6838183963219fc9","name":"@ 5min","props":[],"repeat":"","crontab":"*/5 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":180,"y":240,"wires":[["74906d8bb03396e9"]]},{"id":"6a148d1c3f8b64be","type":"server-state-changed","z":"6838183963219fc9","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":["input_boolean.in_home_zone"],"entityIdType":"list","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":280,"y":560,"wires":[["eafe972177b0c41f"]]},{"id":"5f419255a67c43dd","type":"link out","z":"6838183963219fc9","name":"link out 7","mode":"link","links":["79cb5deaeea01b6f"],"x":735,"y":560,"wires":[]},{"id":"79cb5deaeea01b6f","type":"link in","z":"6838183963219fc9","name":"link in 7","links":["5f419255a67c43dd"],"x":55,"y":620,"wires":[["8f3b675395255275"]]},{"id":"4d4b6a5f9d5a991b","type":"comment","z":"4a22965fdf64b558","name":"linked_class : water_heat","info":"","x":150,"y":120,"wires":[]},{"id":"9258d34035c742aa","type":"link in","z":"4a22965fdf64b558","name":"link in 453","links":["6ac4487e7df2d787"],"x":55,"y":300,"wires":[["dc64f91e4d65bcf5"]]},{"id":"c6459e3b13061ab7","type":"function","z":"4a22965fdf64b558","name":"prepare devices","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" }\nreturn [msg.water_heats.map(w => ({ entity_id: w.entity_id, state: inverse[w.state] }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":360,"wires":[["73f34f0150aff765"]]},{"id":"73f34f0150aff765","type":"subflow:723d4991c3c87385","z":"4a22965fdf64b558","name":"","x":750,"y":360,"wires":[]},{"id":"e8fb8feec7a4dfa5","type":"function","z":"4a22965fdf64b558","name":"notification","func":"msg.notification_id = \"water_heat\"\n\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Chauffe-eau d√©sactiv√©\"\n    msg.message = \"Module Chauffe-eau d√©sactiv√©, le chauffe eau est allum√©\"\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":360,"wires":[["ce168531822379e5"]]},{"id":"ce168531822379e5","type":"link out","z":"4a22965fdf64b558","name":"link out 479","mode":"link","links":["e53334a6f05a9609"],"x":1035,"y":360,"wires":[]},{"id":"bb6101f7fb19d8f8","type":"function","z":"4a22965fdf64b558","name":"prepare devices","func":"let water_heats = global.get(\"water_heats\") ?? {}\nlet devices = msg.water_heats\nlet msgs = []\n\nfor (let device of devices) {\n    water_heats[device.entity_id] = msg.state == \"on\" ? \"manual\" : \"\"\n    msgs.push({\n        entity_id: device.entity_id,\n        state: msg.state,\n        alias: device.alias\n    })\n}\n\nglobal.set(\"water_heats\", water_heats)\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":240,"wires":[["86f841263b9d8ac6","34949d27140eb419"]]},{"id":"86f841263b9d8ac6","type":"subflow:723d4991c3c87385","z":"4a22965fdf64b558","name":"","x":1130,"y":240,"wires":[]},{"id":"428ab7267bbfef8b","type":"subflow:723d4991c3c87385","z":"4a22965fdf64b558","name":"","x":1110,"y":180,"wires":[]},{"id":"40c697883e6c606b","type":"function","z":"4a22965fdf64b558","name":"prepare device","func":"let water_heats = global.get(\"water_heats\") ?? {}\n\nif (msg.state === \"on\") {\n    if (!msg.entity_histories.find(h => h.state == \"on\")) {\n        water_heats[msg.entity_id] = \"in_big_zone\"\n        return msg\n    }\n} else {\n    water_heats[msg.entity_id] = \"\"\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":180,"wires":[["abba11061d28fac4","428ab7267bbfef8b"]]},{"id":"abba11061d28fac4","type":"function","z":"4a22965fdf64b558","name":"notification","func":"msg.notification_id = \"water_heat\"\n\nif (msg.state == \"on\") {\n    let water_heat_duration = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state)\n    msg.title = \"Dans la grande zone: Chauffe-eau activ√©\"\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allum√© \" + water_heat_duration + \" min\"\n    msg.speak = msg.message\n    msg.alert_type = \"success\"\n    msg.send_mobile = true\n    return msg\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":180,"wires":[["088f2437bb522d14"]]},{"id":"088f2437bb522d14","type":"link out","z":"4a22965fdf64b558","name":"link out 482","mode":"link","links":["e53334a6f05a9609"],"x":1395,"y":180,"wires":[]},{"id":"ebc5272f39f732f1","type":"delay","z":"4a22965fdf64b558","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":795,"y":180,"wires":[["40c697883e6c606b"]],"l":false},{"id":"dc64f91e4d65bcf5","type":"function","z":"4a22965fdf64b558","name":"check","func":"let module_water_heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.module_water_heat\"].state == \"on\"\nlet in_big_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_big_zone\"].state == \"on\"\nlet water_heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.water_heat_temp\"].state == \"on\"\n\nif (module_water_heat && in_big_zone && !water_heat_temp) {\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":300,"wires":[["c9e944ee95454391"]]},{"id":"539dc2c4d06a7fb3","type":"function","z":"4a22965fdf64b558","name":"prepare devices","func":"let waterHeatPct = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_pct\"].state) / 100\nlet water_heats = global.get(\"water_heats\") ?? {}\nlet devices = msg.water_heats\nlet msgs = []\n\nfor (let device of devices) {\n    if (!water_heats[device.entity_id] || water_heats[device.entity_id] != \"manual\" && water_heats[device.entity_id] != \"in_big_zone\") {\n        let timeRange = calcIsScheduled(msg.current_time, device)\n        if (typeof timeRange == \"object\") {\n            let times = calcRanges(timeRange[0], timeRange[1])\n            let result = typeof calcIsScheduled(msg.current_time, times) == \"object\" ? \"on\" : \"off\"\n            water_heats[device.entity_id] = result == \"on\" ? \"scheduled\" : \"\"\n            if (device.state != result) {\n                msgs.push({ entity_id: device.entity_id, state: result, alias: device.alias })\n            }\n        } else if (device.state != (timeRange ? \"on\" : \"off\")) {\n            water_heats[device.entity_id] = timeRange ? \"scheduled\" : \"\"\n            msgs.push({ entity_id: device.entity_id, state: timeRange ? \"on\" : \"off\", alias: device.alias })\n        }\n    }\n}\n\nglobal.set(\"water_heats\", water_heats)\nreturn [msgs]\n\nfunction calcRanges(on_time, off_time) {\n    let start = time_to_minutes(on_time)\n    let end = time_to_minutes(off_time)\n    end = start > end ? 1440 + end : end\n    let times = { on_time: [], off_time: [] }\n    for (let i = 0; i < (parseInt(end - start) / 60); i++) {\n        times.on_time.push(minutes_to_time(start + (i + 1) * 60 - waterHeatPct * 60))\n        times.off_time.push(minutes_to_time(start + (i + 1) * 60))\n    }\n    return times\n}\n\nfunction calcIsScheduled(current_time, device) {\n    let isTime = false\n    if (device.on_time.length == device.off_time.length) {\n        if (device.on_time.length == 0) {\n            return true\n        }\n        for (let i = 0; i < device.on_time.length; i++) {\n            isTime = isTime || (device.on_time[i] < device.off_time[i] && device.on_time[i] <= current_time && current_time < device.off_time[i])\n            isTime = isTime || (device.on_time[i] > device.off_time[i] && (device.on_time[i] <= current_time && current_time <= \"23:59\" || \"00:00\" <= current_time && current_time < device.off_time[i]))\n            if (isTime) {\n                return [device.on_time[i], device.off_time[i]]\n            }\n        }\n    }\n    return isTime\n}\n\nfunction time_to_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\")\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1])\n}\n\nfunction minutes_to_time(time) {\n    time = time >= 1440 ? time - 1440 : time\n    let hours = parseInt(time / 60)\n    hours = hours < 10 ? \"0\" + hours : hours == 0 ? \"00\" : hours\n    let minutes = time % 60\n    minutes = minutes < 10 ? \"0\" + minutes : minutes == 0 ? \"00\" : minutes\n    return hours + \":\" + minutes\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":300,"wires":[["c4b276bd7cbbc844","370eb10450012677"]]},{"id":"370eb10450012677","type":"subflow:723d4991c3c87385","z":"4a22965fdf64b558","name":"","x":730,"y":300,"wires":[]},{"id":"c4b276bd7cbbc844","type":"function","z":"4a22965fdf64b558","name":"notification","func":"msg.notification_id = \"water_heat_\" + msg.entity_id\n\nif (msg.state == \"on\") {\n    msg.title = \"Chauffe-eau activ√© par planification\"\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allum√©\"\n    msg.alert_type = \"success\"\n    msg.send_mobile = false\n    return msg\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":300,"wires":[["840e0643e8c84153"]]},{"id":"840e0643e8c84153","type":"link out","z":"4a22965fdf64b558","name":"link out 488","mode":"link","links":["e53334a6f05a9609"],"x":1015,"y":300,"wires":[]},{"id":"1bec02e18f41cee3","type":"function","z":"4a22965fdf64b558","name":"set delay","func":"msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state) * 60 * 1000\nmsg.state = \"off\"\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":180,"wires":[["ebc5272f39f732f1"]]},{"id":"34949d27140eb419","type":"function","z":"4a22965fdf64b558","name":"notification","func":"msg.notification_id = \"water_heat\"\n\nif (msg.state == \"on\") {\n    let water_heat_duration = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state)\n    msg.title = \"Chauffe-eau activ√© manuellement\"\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allum√© \" + water_heat_duration + \" min\"\n    msg.alert_type = \"success\"\n    msg.send_mobile = true\n    return msg\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1310,"y":240,"wires":[["27ce4ecdecc58ff1"]]},{"id":"27ce4ecdecc58ff1","type":"link out","z":"4a22965fdf64b558","name":"link out 500","mode":"link","links":["e53334a6f05a9609"],"x":1415,"y":240,"wires":[]},{"id":"355dfe3a24581e4d","type":"delay","z":"4a22965fdf64b558","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":240,"wires":[["79773f6b837c02f1","85453006e9fb8796"]],"l":false},{"id":"8ea5d0179ce614e9","type":"function","z":"4a22965fdf64b558","name":"set delay","func":"msg.state = msg.payload\n\nif (msg.state == \"on\") {\n    msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state) * 60 * 1000\n    msg.state = \"off\"\n} else {\n    msg.reset = true\n}\n\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":240,"wires":[["355dfe3a24581e4d"]]},{"id":"55eac8dff698a429","type":"function","z":"4a22965fdf64b558","name":"water_heats >","func":"msg.search = { \"is\": { linked_class: \"water_heat\" } }\nmsg.output_name = \"water_heats\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":180,"wires":[["e6299150d0259d89"]]},{"id":"85453006e9fb8796","type":"function","z":"4a22965fdf64b558","name":"water_heats >","func":"msg.search = { \"is\": { linked_class: \"water_heat\" } }\nmsg.output_name = \"water_heats\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":240,"wires":[["757e30e8e072935b"]]},{"id":"c9e944ee95454391","type":"function","z":"4a22965fdf64b558","name":"water_heats >","func":"msg.search = { \"is\": { linked_class: \"water_heat\" } }\nmsg.output_name = \"water_heats\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":300,"wires":[["254727fe68e5a556"]]},{"id":"0853fac1572e1008","type":"function","z":"4a22965fdf64b558","name":"water_heats >","func":"msg.search = { \"is\": { linked_class: \"water_heat\", state: msg.payload } }\nmsg.output_name = \"water_heats\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":360,"wires":[["79ccb5d164804c7e"]]},{"id":"e674a33ab19f7c47","type":"subflow:723d4991c3c87385","z":"4a22965fdf64b558","name":"","x":850,"y":420,"wires":[]},{"id":"2ef5ba58f0befc5d","type":"function","z":"4a22965fdf64b558","name":"set water heat pct","func":"let json_exterior_average_temp = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state)\nlet water_heat_person_number = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_person_number\"].state)\nlet water_heat_adjustment = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_adjustment\"].state)\nlet temperatures = global.get(\"temperatures\") ?? {}\nlet msgs = []\n\nif (temperatures.exterior?.last_changed && ((new Date().getTime() - temperatures[\"exterior\"].last_changed) / 1000) < 40 * 60 && Array.isArray(json_exterior_average_temp)) {\n    let pct = (-0.6667 * json_exterior_average_temp[0] + 25) * (water_heat_person_number) + water_heat_adjustment\n    pct = pct > 100 ? 100 : pct < 5 ? 5 : pct\n    msgs.push({\n        entity_id: \"input_number.water_heat_pct\",\n        state: Math.round(pct)\n    })\n\n    let duration = (pct * 60 * 7 / 100) > 360 ? 360 : (pct * 60 * 7 / 100) < 0 ? 0 : Math.round(pct * 60 * 7 / 100)\n    msgs.push({\n        entity_id: \"input_number.water_heat_duration\",\n        state: duration\n    })\n\n    return [msgs]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":420,"wires":[["e674a33ab19f7c47"]]},{"id":"7527a6b217b28d20","type":"function","z":"4a22965fdf64b558","name":"devices","func":"return [msg.water_heats.map(d => ({ entity_id: d.entity_id, state: \"on\", alias: d.alias }))]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":180,"wires":[["daf177b16fa93fd7","1bec02e18f41cee3"]]},{"id":"79773f6b837c02f1","type":"api-call-service","z":"4a22965fdf64b558","name":"activate manual off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.water_heat_temp"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":240,"wires":[[]]},{"id":"86e655c54b6befaf","type":"server-state-changed","z":"4a22965fdf64b558","name":"module_water_heat","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_water_heat","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":360,"wires":[["0853fac1572e1008","e8fb8feec7a4dfa5"]]},{"id":"9c66394db68ae239","type":"server-state-changed","z":"4a22965fdf64b558","name":"water heat person number","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.water_heat_person_number","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":370,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"bc41ec7b4d0f345b","type":"server-state-changed","z":"4a22965fdf64b558","name":"water heat adjustment","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.water_heat_adjustment","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":140,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"daf177b16fa93fd7","type":"api-get-history","z":"4a22965fdf64b558","name":"","server":"c87720f17866318d","version":1,"startDate":"","endDate":"","entityId":"{{entity_id}}","entityIdType":"equals","useRelativeTime":true,"relativeTime":"1 day","flatten":true,"outputType":"array","outputLocationType":"msg","outputLocation":"entity_histories","x":595,"y":180,"wires":[["40c697883e6c606b"]],"l":false},{"id":"1f43db11c8e7d8fb","type":"trigger-state","z":"4a22965fdf64b558","name":"in_big_zone","server":"c87720f17866318d","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_big_zone","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"entity_id","targetValue":"input_boolean.module_water_heat","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"entity_id","targetValue":"input_boolean.in_big_zone","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":110,"y":180,"wires":[["55eac8dff698a429"],[]]},{"id":"37315bdc76a2adb8","type":"trigger-state","z":"4a22965fdf64b558","name":"activate manual","server":"c87720f17866318d","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.water_heat_temp","entityIdType":"exact","debugEnabled":false,"constraints":[],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":120,"y":240,"wires":[["3f3fa09655239c17","8ea5d0179ce614e9"],[]]},{"id":"e6299150d0259d89","type":"subflow:3da7ebfd83a38899","z":"4a22965fdf64b558","name":"","x":395,"y":180,"wires":[["7527a6b217b28d20"]],"l":false},{"id":"757e30e8e072935b","type":"subflow:3da7ebfd83a38899","z":"4a22965fdf64b558","name":"","x":815,"y":240,"wires":[["bb6101f7fb19d8f8"]],"l":false},{"id":"254727fe68e5a556","type":"subflow:3da7ebfd83a38899","z":"4a22965fdf64b558","name":"","x":415,"y":300,"wires":[["539dc2c4d06a7fb3"]],"l":false},{"id":"79ccb5d164804c7e","type":"subflow:3da7ebfd83a38899","z":"4a22965fdf64b558","name":"","x":435,"y":360,"wires":[["c6459e3b13061ab7"]],"l":false},{"id":"61d1172bbcfedfe7","type":"link in","z":"4a22965fdf64b558","name":"link in 571","links":["1d97dd5683519b2b"],"x":515,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"f8f06d191a8eab80","type":"catch","z":"4a22965fdf64b558","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["6ec6d35f0930824b"]]},{"id":"a6db5e393f8b2a19","type":"subflow:ad3b29a5dd67898f","z":"4a22965fdf64b558","name":"","x":460,"y":40,"wires":[["612853ee2a628cda"]]},{"id":"6ec6d35f0930824b","type":"change","z":"4a22965fdf64b558","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"WaterHeat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["a6db5e393f8b2a19"]]},{"id":"612853ee2a628cda","type":"link out","z":"4a22965fdf64b558","name":"link out 652","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"b6536d45be534fe7","type":"comment","z":"bc6acc159ab232c6","name":"linked_class : ventilation","info":"","x":140,"y":120,"wires":[]},{"id":"6a77bcc53698bdf2","type":"function","z":"bc6acc159ab232c6","name":"prepare devices","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" }\n\nreturn [\n    msg.ventilations.map(v => (\n        {\n            module_ventilation: msg.module_ventilation,\n            entity_id: v.entity_id,\n            state: inverse[v.state],\n            linked_area: v.linked_area\n        }\n    ))\n]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":300,"wires":[["f817476f6c09cf33","43a514d60ce67875"]]},{"id":"43a514d60ce67875","type":"function","z":"bc6acc159ab232c6","name":"notification","func":"let notification_id = \"vmc_\" + msg.linked_area\nlet msgs = []\n\nif (msg.module_ventilation == \"off\") {\n    msgs.push(\n        {\n            notification_id: notification_id,\n            alert_type: \"info\",\n            title: \"Module Ventilation\",\n            message: \"Module ventilation d√©sactiv√©, la ventilation est active et les alertes temp√©ratures sont d√©sactiv√©es\",\n            send_mobile: true\n        }\n    )\n} else {\n    msgs.push({ notification_id: notification_id, dismiss: true })\n}\n\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":300,"wires":[["76cea9e99f705380"]]},{"id":"f817476f6c09cf33","type":"link out","z":"bc6acc159ab232c6","name":"link out 477","mode":"link","links":["7516e795e9c61133"],"x":655,"y":300,"wires":[]},{"id":"76cea9e99f705380","type":"link out","z":"bc6acc159ab232c6","name":"link out 478","mode":"link","links":["e53334a6f05a9609"],"x":875,"y":300,"wires":[]},{"id":"3e25f16111347f71","type":"subflow:723d4991c3c87385","z":"bc6acc159ab232c6","name":"","x":1150,"y":180,"wires":[]},{"id":"faa3a5726b7782f9","type":"link in","z":"bc6acc159ab232c6","name":"link in 455","links":["6ac4487e7df2d787"],"x":55,"y":180,"wires":[["c45a2415bdcf7e98"]]},{"id":"7516e795e9c61133","type":"link in","z":"bc6acc159ab232c6","name":"link in 456","links":["f817476f6c09cf33","84cf327ba8dbb95c"],"x":1025,"y":180,"wires":[["3e25f16111347f71"]]},{"id":"756f4d593faf47cd","type":"function","z":"bc6acc159ab232c6","name":"prepare scheduled","func":"let ventilations = global.get(\"ventilations\") ?? {}\nlet devices = msg.ventilations\nlet msgs = []\n\nfor (let device of devices) {\n    let results = calcIsScheduled(msg.current_time, device)\n    if (device.linked_area in ventilations\n        && (results[1] === \"scheduled\" && ventilations[device.linked_area] !== \"scheduled\" || results[1] === \"\" && ventilations[device.linked_area] === \"scheduled\")\n        || !(device.linked_area in ventilations)) {\n        ventilations[device.linked_area] = results[1]\n        msgs.push({\n            entity_id: device.entity_id,\n            state: results[0],\n            linked_area: device.linked_area,\n            alias: device.alias\n        })\n    }\n}\nif (msgs.length !== 0) {\n    global.set(\"ventilations\", ventilations)\n    return [msgs]\n}\n\nfunction calcIsScheduled(current_time, device) {\n    if (device.on_time.length === device.off_time.length) {\n        let isTime = false\n        for (let i = 0; i < device.on_time.length; i++) {\n            isTime = isTime\n                || (device.on_time[i] < device.off_time[i] && device.on_time[i] <= current_time && current_time < device.off_time[i])\n                || (device.on_time[i] > device.off_time[i] && (\n                    device.on_time[i] <= current_time && current_time <= \"23:59\"\n                    || \"00:00\" <= current_time && current_time < device.off_time[i]))\n\n            if (isTime) {\n                return [\"on\", \"scheduled\"]\n            }\n        }\n    }\n    return [\"off\", \"\"]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":180,"wires":[["3e25f16111347f71","aeb2eff70381a653"]]},{"id":"0419929f6aea7cca","type":"link out","z":"bc6acc159ab232c6","name":"link out 485","mode":"link","links":["e53334a6f05a9609"],"x":1275,"y":240,"wires":[]},{"id":"bdb378dcde27f270","type":"function","z":"bc6acc159ab232c6","name":"notification","func":"let ventilations = global.get(\"ventilations\") ?? {}\nmsg.notification_id = \"vmc_\" + msg.linked_area\nmsg.override = true\n\nif (ventilations[msg.linked_area] == \"scheduled\") {\n    msg.alert_type = \"success\"\n    msg.title = \"Ventilation activ√©e par planification\"\n    msg.message = \"La ventilation \" + msg.alias + \" est active\"\n    msg.send_mobile = false\n    return msg\n} else if (ventilations[msg.linked_area] == \"max_humidity\") {\n    msg.alert_type = \"success\"\n    msg.title = \"Ventilation \" + msg.alias + \" activ√©e\"\n    msg.message = \"L'humidit√© est haute, la ventilation \" + msg.alias + \" est activ√©e\"\n    msg.speak = msg.message\n    msg.send_mobile = false\n    return msg\n} else if (ventilations[msg.linked_area] == \"humidity\") {\n    msg.alert_type = \"success\"\n    msg.title = \"Ventilation \" + msg.alias + \" activ√©e\"\n    msg.message = \"Circonstance favorable, la ventilation \" + msg.alias + \" est activ√©e\"\n    msg.send_mobile = false\n    return msg\n} else if (ventilations[msg.linked_area] == \"temperature_offline\") {\n    msg.alert_type = \"warning\"\n    msg.title = \"Ventilation \" + msg.alias + \" d√©sactiv√©e\"\n    msg.message = \"Le capteur de temp√©rature \" + msg.alias + \" ne renvoi plus de donn√©es depuis plus de 40 minutes\"\n    msg.send_mobile = false\n    return msg\n} else if (ventilations[msg.linked_area] == \"\") {\n    msg.dismiss = true\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1170,"y":240,"wires":[["0419929f6aea7cca"]]},{"id":"a45e1f6435f091f6","type":"function","z":"bc6acc159ab232c6","name":"prepare humidity","func":"let ventilations = global.get(\"ventilations\") ?? {}\nlet temp_hum = global.get(\"temp_hum\") ?? {}\n/*\nlet comforts = global.get(\"comforts\") ?? {}\nlet devices = msg.ventilations\nlet msgs = []\n\nfor (let device of devices) {\n    if (device.linked_area) {\n        let results = autoVentilation(device, comforts)\n        if (device.linked_area in ventilations\n            && results[1] !== ventilations[device.linked_area] && ventilations[device.linked_area] !== \"scheduled\"\n            || !(device.linked_area in ventilations)) {\n            ventilations[device.linked_area] = results[1]\n            msgs.push({\n                entity_id: device.entity_id,\n                state: results[0],\n                linked_area: device.linked_area,\n                alias: device.alias\n            })\n        }\n    }\n}\n\nif (msgs.length !== 0) {\n    global.set(\"ventilations\", ventilations)\n    return [msgs]\n}\n\nfunction autoVentilation(device, comforts) {\n    let intAreas = Object.keys(comforts).filter(area => comforts[area] != \"exterior\")\n    if (\"exterior\" in comforts && intAreas.length != 0) {\n        let mostUncomfortableArea = devices.length === 1 ?\n            intAreas.sort((a, b) => comforts[a] - comforts[b]).reverse()[0]\n            : device.linked_area in intAreas ? comforts[device.linked_area] : \"\"\n\n        if ((new Date().getTime() - humidities[\"exterior\"].lastChanged) / 1000 < 40 * 60\n            && (new Date().getTime() - humidities[mostUncomfortableArea].lastChanged) / 1000 < 40 * 60\n            && (new Date().getTime() - temperatures[mostUncomfortableArea].lastChanged) / 1000 < 40 * 60) {\n\n            if (\n                mostUncomfortableArea\n                && \"exterior\" in humidities\n                && mostUncomfortableArea in humidities\n                && mostUncomfortableArea in temperatures\n            ) {\n                if (\n                    mostUncomfortableArea in humidities\n                    && humidities[mostUncomfortableArea].high\n                    && humidities[mostUncomfortableArea].value > humidities[\"exterior\"].value\n                    && !humidities[\"exterior\"].high\n                ) {\n                    return [\"on\", \"max_humidity\"]\n                } else if (\n                    mostUncomfortableArea in temperatures\n                    && !temperatures[mostUncomfortableArea].low\n                    && comforts[\"exterior\"] < comforts[mostUncomfortableArea]) {\n                    return [\"on\", \"humidity\"]\n                }\n            }\n        } else {\n            return [\"off\", \"temperature_offline\"]\n        }\n    }\n\n    return [\"off\", \"\"]\n}\n*/","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":240,"wires":[["84cf327ba8dbb95c","bdb378dcde27f270"]]},{"id":"1a65d03fb472b147","type":"inject","z":"bc6acc159ab232c6","name":"10 min","props":[],"repeat":"","crontab":"*/10 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":120,"y":240,"wires":[["0b2998b8acb6ae64"]]},{"id":"84cf327ba8dbb95c","type":"link out","z":"bc6acc159ab232c6","name":"link out 486","mode":"link","links":["7516e795e9c61133"],"x":1015,"y":240,"wires":[]},{"id":"aeb2eff70381a653","type":"link out","z":"bc6acc159ab232c6","name":"link out 487","mode":"link","links":["0c807b7e0bfb7460"],"x":975,"y":180,"wires":[]},{"id":"0c807b7e0bfb7460","type":"link in","z":"bc6acc159ab232c6","name":"link in 457","links":["aeb2eff70381a653"],"x":1065,"y":240,"wires":[["bdb378dcde27f270"]]},{"id":"47908483fafc8782","type":"function","z":"bc6acc159ab232c6","name":"ventilations >","func":"msg.search = { \"is\": { linked_class: \"ventilation\" } }\nmsg.output_name = \"ventilations\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":180,"wires":[["00a344464754b574"]]},{"id":"b2317293f5dbab97","type":"function","z":"bc6acc159ab232c6","name":"ventilations >","func":"msg.search = { \"is\": { linked_class: \"ventilation\" } }\nmsg.output_name = \"ventilations\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":240,"wires":[["126dfe7c926a0a06"]]},{"id":"ec47075613cfdd43","type":"function","z":"bc6acc159ab232c6","name":"ventilations >","func":"msg.search = { \"is\": { linked_class: \"ventilation\" } }\nmsg.output_name = \"ventilations\"\nmsg.output_empty_results = false\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":300,"wires":[["28db9ccc6af241a1"]]},{"id":"c45a2415bdcf7e98","type":"api-current-state","z":"bc6acc159ab232c6","name":"module_ventilation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_ventilation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":410,"y":180,"wires":[["47908483fafc8782"],[]]},{"id":"0b2998b8acb6ae64","type":"api-current-state","z":"bc6acc159ab232c6","name":"module_ventilation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_ventilation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":450,"y":240,"wires":[["b2317293f5dbab97"],[]]},{"id":"e142d4fca5be15b6","type":"server-state-changed","z":"bc6acc159ab232c6","name":"module_ventilation","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_ventilation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_ventilation","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":300,"wires":[["ec47075613cfdd43"]]},{"id":"b06c1a575e85eacb","type":"server-state-changed","z":"bc6acc159ab232c6","name":"sensibility","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.sensibility","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":260,"y":240,"wires":[["0b2998b8acb6ae64"]]},{"id":"2af569a4077b0eac","type":"server-state-changed","z":"bc6acc159ab232c6","name":"module_ventilation","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_ventilation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_ventilation","propertyType":"msg","value":"","valueType":"entityState"}],"x":190,"y":180,"wires":[["c45a2415bdcf7e98"]]},{"id":"00a344464754b574","type":"subflow:3da7ebfd83a38899","z":"bc6acc159ab232c6","name":"","x":715,"y":180,"wires":[["756f4d593faf47cd"]],"l":false},{"id":"126dfe7c926a0a06","type":"subflow:3da7ebfd83a38899","z":"bc6acc159ab232c6","name":"","x":755,"y":240,"wires":[["a45e1f6435f091f6"]],"l":false},{"id":"28db9ccc6af241a1","type":"subflow:3da7ebfd83a38899","z":"bc6acc159ab232c6","name":"","x":415,"y":300,"wires":[["6a77bcc53698bdf2"]],"l":false},{"id":"612a8fce2e90c892","type":"catch","z":"bc6acc159ab232c6","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["7933df591a6c8cc3"]]},{"id":"ce69633ed2c2d53f","type":"subflow:ad3b29a5dd67898f","z":"bc6acc159ab232c6","name":"","x":460,"y":40,"wires":[["f9dca7092c092ecf"]]},{"id":"7933df591a6c8cc3","type":"change","z":"bc6acc159ab232c6","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Ventilation","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["ce69633ed2c2d53f"]]},{"id":"f9dca7092c092ecf","type":"link out","z":"bc6acc159ab232c6","name":"link out 653","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"00ede13124c44890","type":"catch","z":"eaa696a731a52b23","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["b175ee858ab93e92"]]},{"id":"38beb2359e67bda8","type":"subflow:ad3b29a5dd67898f","z":"eaa696a731a52b23","name":"","x":460,"y":40,"wires":[["ee6612b6dae35793"]]},{"id":"b175ee858ab93e92","type":"change","z":"eaa696a731a52b23","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"AlarmClock","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["38beb2359e67bda8"]]},{"id":"ee6612b6dae35793","type":"link out","z":"eaa696a731a52b23","name":"link out 635","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"0145cfe1b1917864","type":"ha-time","z":"eaa696a731a52b23","name":"next_alarm_clock","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","entityId":"input_datetime.next_alarm_clock","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"x":120,"y":180,"wires":[["649c16705f33ba81"]]},{"id":"89c830f8a088bed7","type":"function","z":"eaa696a731a52b23","name":"get alarms","func":"let next_alarms = flow.get(\"next_alarms\") ?? {}\nlet msgs = []\n\nfor (let p of msg.persons) {\n    if (next_alarms[p.entity_id] === msg.state && Object.keys(p.alarm_clock_then).length > 0) {\n        delete next_alarms[p.entity_id]\n        if (p.state === \"home\") {\n            msgs.push({ then: p.alarm_clock_then })\n        }\n    }\n}\n\nflow.set(\"next_alarms\", next_alarms)\nreturn [msgs]","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":180,"wires":[["93ac910693b94091"]]},{"id":"93ac910693b94091","type":"link out","z":"eaa696a731a52b23","name":"alarm started","mode":"link","links":["f5d01cdf10d12c3a"],"x":815,"y":180,"wires":[]},{"id":"693e35cd8fbdc9c5","type":"link in","z":"eaa696a731a52b23","name":"alarm input","links":["4a2b42ec1876278b","f9f8f8a690320c67"],"x":55,"y":120,"wires":[["16368527448dd761"]]},{"id":"3a9ea5187489f218","type":"subflow:723d4991c3c87385","z":"eaa696a731a52b23","name":"","x":950,"y":120,"wires":[]},{"id":"f4e3511b4edd6e4c","type":"subflow:3da7ebfd83a38899","z":"eaa696a731a52b23","name":"","x":675,"y":120,"wires":[["646e9260d713d610"]],"l":false},{"id":"2efc0195703e6e74","type":"function","z":"eaa696a731a52b23","name":"persons >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":120,"wires":[["f4e3511b4edd6e4c"]]},{"id":"d1ce38a015f136b3","type":"function","z":"eaa696a731a52b23","name":"persons >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":180,"wires":[["c59e99010524f359"]]},{"id":"c59e99010524f359","type":"subflow:3da7ebfd83a38899","z":"eaa696a731a52b23","name":"","x":595,"y":180,"wires":[["89c830f8a088bed7"]],"l":false},{"id":"649c16705f33ba81","type":"api-current-state","z":"eaa696a731a52b23","name":"module_alarm_clock ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_alarm_clock","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":320,"y":180,"wires":[["d1ce38a015f136b3"],[]]},{"id":"16368527448dd761","type":"api-current-state","z":"eaa696a731a52b23","name":"module_alarm_clock ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_alarm_clock","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":200,"y":120,"wires":[["cbe20c8080b9105c"],[]]},{"id":"d41a715eaeb23afd","type":"server-state-changed","z":"eaa696a731a52b23","name":"module_alarm_clock ","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_alarm_clock","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":410,"y":120,"wires":[["2efc0195703e6e74"],[]]},{"id":"646e9260d713d610","type":"function","z":"eaa696a731a52b23","name":"get alarms","func":"let regex = /^([01]\\d|2[0-3]):[0-5]\\d$/\nlet persons = msg.persons\nlet next_alarms = {}\n\nfor (let p of persons) {\n    let d = new Date()\n    if (typeof p[\"alarm_clock\"] === \"string\" && global.get(\"homeassistant\").homeAssistant?.states?.[p[\"alarm_clock\"]]?.state) {\n        let alarm = new Date(global.get(\"homeassistant\").homeAssistant.states[p[\"alarm_clock\"]].state)\n        if (alarm.getTime() > d.getTime()) {\n            next_alarms[p.entity_id] = clean_date(new Date(alarm.setHours(alarm.getHours() - d.getTimezoneOffset() / 60)))\n        }\n    } else if (typeof p[\"alarm_clock\"] === \"object\" && regex.test(p[\"alarm_clock\"][d.getDay() + 1])) {\n        let a_split = p[\"alarm_clock\"][d.getDay() + 1].split(\":\")\n        let alarm = d\n        alarm.setHours(parseInt(a_split[0]))\n        alarm.setMinutes(parseInt(a_split[1]))\n        alarm.setSeconds(0)\n        if (d.getTime() > d.getTime()) {\n            next_alarms[p.entity_id] = clean_date(new Date(alarm.setHours(alarm.getHours() - d.getTimezoneOffset() / 60)))\n        }\n    }\n}\n\nif (Object.keys(next_alarms).length > 0) {\n    flow.set(\"next_alarms\", next_alarms)\n    let next_alarm = next_alarms[Object.keys(next_alarms).sort((a, b) => new Date(next_alarms[a]).getTime() - new Date(next_alarms[b]).getTime())[0]]\n    msg = {\n        entity_id: \"input_datetime.next_alarm_clock\",\n        state: next_alarm\n    }\n    return msg\n}\n\nfunction clean_date(date) {\n    date = JSON.stringify(date)\n    let s_date = date.split(\"T\")\n    return JSON.parse(s_date[0] + \" \" + s_date[1].replace(\".000Z\", \"\"))\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":120,"wires":[["3a9ea5187489f218"]]},{"id":"66b809d75014e699","type":"catch","z":"ab914a2a493ebbf5","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["103b5b2b1d5427e7"]]},{"id":"f63c64627a69e81d","type":"subflow:ad3b29a5dd67898f","z":"ab914a2a493ebbf5","name":"","x":460,"y":40,"wires":[["537da3c87d62c330"]]},{"id":"103b5b2b1d5427e7","type":"change","z":"ab914a2a493ebbf5","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Covers","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["f63c64627a69e81d"]]},{"id":"072afd17d7adfc2a","type":"comment","z":"ab914a2a493ebbf5","name":"cover management","info":"","x":130,"y":120,"wires":[]},{"id":"537da3c87d62c330","type":"link out","z":"ab914a2a493ebbf5","name":"link out 636","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"2143636706e300db","type":"function","z":"ab914a2a493ebbf5","name":"set stores_status","func":"return { entity_id: \"input_boolean.stores_status\", state: msg.value == 100 ? \"on\" : \"off\" }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":180,"wires":[["7f82b15d9bfe38b2"]]},{"id":"7f82b15d9bfe38b2","type":"subflow:723d4991c3c87385","z":"ab914a2a493ebbf5","name":"","x":1050,"y":180,"wires":[]},{"id":"0de5ed4271bb5d0d","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"sun","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sun.sun","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":180,"wires":[["ac41bcb9258bb0ae"]]},{"id":"ac41bcb9258bb0ae","type":"api-current-state","z":"ab914a2a493ebbf5","name":"module_cover on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":180,"wires":[["047a0ab623bd2bb5"],[]]},{"id":"047a0ab623bd2bb5","type":"function","z":"ab914a2a493ebbf5","name":"set cover value","func":"let sunAngleCoverOff = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_off\"].state)\nlet sunAngleCoverOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_on\"].state)\nlet stores_status = global.get('homeassistant').homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\"\nlet sun = global.get('homeassistant').homeAssistant.states[\"sun.sun\"]\nlet elevation = sun.attributes.elevation\nlet rising = sun.attributes.rising\n\nif (rising && !stores_status && elevation > sunAngleCoverOn) {\n    msg.value = 100\n    return msg\n} else if (!rising && stores_status && elevation < sunAngleCoverOff) {\n    msg.value = 0\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":180,"wires":[["2143636706e300db","5a0d2ba7dcd1fe03"]]},{"id":"b33b7ed16b6c0484","type":"link out","z":"ab914a2a493ebbf5","name":"link out 596","mode":"link","links":["b07b94f716964e35"],"x":745,"y":180,"wires":[]},{"id":"eff62c7c6f3e9b57","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"msg.notification_id = \"module_cover\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module Volets roulant d√©sactiv√©\"\n    msg.message = \"Module Volets roulant d√©sactiv√©, les volets roulants ne sont plus control√©es\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":760,"wires":[["45cea250ce764020"]]},{"id":"45cea250ce764020","type":"link out","z":"ab914a2a493ebbf5","name":"link out 658","mode":"link","links":["e53334a6f05a9609"],"x":615,"y":760,"wires":[]},{"id":"c72ad16693e8469a","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"module_cover","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.module_cover","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":760,"wires":[["5d949c25ceb5d9ca","9f98ec66303a47f0"],["32ac3965c280620d"]]},{"id":"3d02fab92537dedc","type":"link out","z":"ab914a2a493ebbf5","name":"link out 659","mode":"link","links":["b07b94f716964e35"],"x":395,"y":760,"wires":[]},{"id":"9caa658bda8398fd","type":"comment","z":"ab914a2a493ebbf5","name":"on/off module_cover","info":"","x":130,"y":700,"wires":[]},{"id":"5d949c25ceb5d9ca","type":"function","z":"ab914a2a493ebbf5","name":"set cover value","func":"let stores_status = global.get('homeassistant').homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\"\nreturn { value: stores_status ? 0 : 100 }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":760,"wires":[["3d02fab92537dedc"]]},{"id":"54097f118e4479e1","type":"link in","z":"ab914a2a493ebbf5","name":"link in 578","links":["0646f3d0a39edf83"],"x":55,"y":420,"wires":[["1a1d9e94f045d524"]]},{"id":"1a1d9e94f045d524","type":"function","z":"ab914a2a493ebbf5","name":"cover calc","func":"let time_to_aeration = \"time_to_aeration\" in msg ? msg.time_to_aeration : 0\nlet time_to_close = \"time_to_close\" in msg ? msg.time_to_close : 0\nlet time_to_open = \"time_to_open\" in msg ? msg.time_to_open : 0\nlet old_state = msg.old_state\nlet new_state = msg.new_state\nlet msgs = []\n\nif (msg.linked_device) {\n    if (new_state == 100) {\n        msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n\n    } else if (new_state == 0) {\n        msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n    } else if (new_state == 1) {\n        if (old_state == 0) {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: time_to_aeration * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        } else {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n            msgs.push({ delay: (old_state / 100) * time_to_close * 1000 + time_to_aeration * 1000, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: (old_state / 100) * time_to_close * 1000 + time_to_aeration * 1000 + time_to_aeration * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        }\n    } else {\n        let delay = old_state == 0 ? time_to_aeration * 1000 : 0\n        if (old_state < new_state) {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"open_cover\" })\n            msgs.push({ delay: delay + ((new_state - old_state) / 100) * time_to_open * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        } else {\n            msgs.push({ delay: 0, entity_id: msg.linked_device, service: \"close_cover\" })\n            msgs.push({ delay: delay + ((old_state - new_state) / 100) * time_to_close * 1000, entity_id: msg.linked_device, service: \"stop_cover\" })\n        }\n    }\n    return [msgs]\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":420,"wires":[["17b2be8703642336"]]},{"id":"c838dde3b4d97086","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"let num_covers = msg.num_covers\n\nmsg.notification_id = \"empty_home_cover_status\"\nmsg.alert_type = \"success\"\nmsg.title = (msg.value == 100 ? \"Ouverture\" : \"Fermeture\") + \" des volets\"\nmsg.send_mobile = true\nmsg.override = true\nlet endTxt = \" pendant votre absence\"\n\nif (msg.value == 100) {\n    msg.message = (num_covers == 1 ? \"Le volet s'est ouvert\" : \"Les volets se sont ouverts\") + endTxt\n    return msg\n} else if (msg.value == 0) {\n    msg.message = (num_covers == 1 ? \"Le volet s'est ferm√©\" : \"Les volets se sont ferm√©s\") + endTxt\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":300,"wires":[["b33d9764ba16108b"]]},{"id":"b33d9764ba16108b","type":"link out","z":"ab914a2a493ebbf5","name":"link out 660","mode":"link","links":["e53334a6f05a9609"],"x":855,"y":300,"wires":[]},{"id":"446ee78e3e5ab66d","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"msg.notification_id = \"empty_home_cover_status\"\nmsg.clear_on_phone = true\nmsg.dismiss = true\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":480,"wires":[["19b6e42a74f1681a"]]},{"id":"19b6e42a74f1681a","type":"link out","z":"ab914a2a493ebbf5","name":"link out 661","mode":"link","links":["e53334a6f05a9609"],"x":395,"y":480,"wires":[]},{"id":"28562681c5f0cf42","type":"function","z":"ab914a2a493ebbf5","name":"set home notification","func":"msg.effects = { count: 5, color: 280, saturation: 100, time: 1000 }\nmsg.sound = \"stores_windows.mp3\"\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":300,"wires":[["eaeb9bc7c92663c0"]]},{"id":"5c48bacc0fbd612f","type":"link in","z":"ab914a2a493ebbf5","name":"link in 579","links":["20fdf92ff181ca3a"],"x":55,"y":300,"wires":[["e7302298a83fabe1"]]},{"id":"e7302298a83fabe1","type":"subflow:e6ac576fb4598283","z":"ab914a2a493ebbf5","name":"","x":170,"y":300,"wires":[["29b05ce92e274023"],["b7254c5cdf10e155"]]},{"id":"eaeb9bc7c92663c0","type":"subflow:dbf17bea6affd2ec","z":"ab914a2a493ebbf5","name":"","x":600,"y":300,"wires":[]},{"id":"30dd2decd1225b89","type":"link in","z":"ab914a2a493ebbf5","name":"link in 580","links":["0dac8a656e626a27"],"x":55,"y":360,"wires":[["a1389eb340d62584"]]},{"id":"a1389eb340d62584","type":"function","z":"ab914a2a493ebbf5","name":"cover >","func":"if (msg.entity_id) {\n    msg.search = { \"is\": { linked_window: msg.entity_id } }\n    msg.output_name = \"linkedCover\"\n    msg.output_empty_results = false\n    return msg\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["7e16c9550ba03328"]]},{"id":"6c1d50adcdd595aa","type":"function","z":"ab914a2a493ebbf5","name":"cover calc","func":"let stores_status = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.stores_status\"].state == \"on\"\nreturn { entity_id: msg.linkedCover[0].entity_id, state: stores_status ? 100 : (msg.new_state == \"on\" ? 100 : 0) }","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":360,"wires":[["8b7790bbfc9a9082"]]},{"id":"cce0ace48e9ffb8f","type":"api-call-service","z":"ab914a2a493ebbf5","name":"set cover","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"cover","service":"{{service}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":360,"y":420,"wires":[[]]},{"id":"1270c4619b749c2c","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"in_home_zone","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.in_home_zone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":480,"wires":[["446ee78e3e5ab66d"],[]]},{"id":"7e16c9550ba03328","type":"subflow:3da7ebfd83a38899","z":"ab914a2a493ebbf5","name":"","x":255,"y":360,"wires":[["6c1d50adcdd595aa"]],"l":false},{"id":"17b2be8703642336","type":"delay","z":"ab914a2a493ebbf5","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":255,"y":420,"wires":[["cce0ace48e9ffb8f"]],"l":false},{"id":"20fdf92ff181ca3a","type":"link out","z":"ab914a2a493ebbf5","name":"link out 662","mode":"link","links":["5c48bacc0fbd612f"],"x":855,"y":240,"wires":[]},{"id":"b07b94f716964e35","type":"link in","z":"ab914a2a493ebbf5","name":"link in 581","links":["3d02fab92537dedc","b33b7ed16b6c0484"],"x":55,"y":240,"wires":[["3cf0212e9155c0b8"]]},{"id":"b4a9828334ecb95c","type":"link in","z":"ab914a2a493ebbf5","name":"cover open in template","links":["0dac8a656e626a27","92343d20b8540180"],"x":55,"y":620,"wires":[["9d67071c8c2a9805"]]},{"id":"8b7790bbfc9a9082","type":"subflow:723d4991c3c87385","z":"ab914a2a493ebbf5","name":"","x":510,"y":360,"wires":[]},{"id":"3cf0212e9155c0b8","type":"function","z":"ab914a2a493ebbf5","name":"linked_windows >","func":"msg.search = { \"is\": { entity_id: msg.covers.filter(c => \"linked_window\" in c).map(c => c.linked_window), state: [\"on\", \"off\"] } }\nmsg.output_name = \"linked_windows\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":240,"wires":[["79ec7cf968caad7f"]]},{"id":"79ec7cf968caad7f","type":"subflow:3da7ebfd83a38899","z":"ab914a2a493ebbf5","name":"","x":315,"y":240,"wires":[["310996b3b0510416"]],"l":false},{"id":"9d67071c8c2a9805","type":"function","z":"ab914a2a493ebbf5","name":"shutters awaiting ?","func":"let sunAngleCoverOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_on\"].state)\nlet in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet sun_attributes = global.get('homeassistant').homeAssistant.states[\"sun.sun\"].attributes\nlet shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\n\nif (in_home_zone && Object.keys(shutter_awaiting).length > 0 && sunAngleCoverOn < sun_attributes.elevation) {\n    if ((msg.state ?? \"\") === \"on\") {\n        let covers = []\n        for (let key of Object.keys(shutter_awaiting)) {\n            if (msg.linked_area === shutter_awaiting[key].linked_area) {\n                covers.push({ template: setTemplateVariables(shutter_awaiting[key].morning_open_if), key: key })\n            }\n        }\n        if (covers.length > 0) {\n            return { linked_area: msg.linked_area, state: \"on\", covers: covers }\n        }\n    }\n}\n\nfunction setTemplateVariables(condition) {\n    if (condition.includes(\"global.\")) {\n        let globals_to_inject = global.keys().filter(g => condition.includes(\"global.\" + g))\n        if (globals_to_inject.length != 0) {\n            let injection = '{% set global = {'\n            for (let g of globals_to_inject) {\n                injection += '\"' + g + '\":' + JSON.stringify(global.get(g) ?? {}) + ','\n            }\n            injection = injection.slice(0, -1)\n            injection += '} %}'\n            condition = injection + condition\n            return condition\n        }\n    } else {\n        return condition\n    }\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":620,"wires":[["4f6e12f8120bd87f"]]},{"id":"8839e284ccedc92c","type":"delay","z":"ab914a2a493ebbf5","name":"","pauseType":"delayv","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":755,"y":120,"wires":[["d2561fe594537337"]],"l":false},{"id":"d2561fe594537337","type":"api-call-service","z":"ab914a2a493ebbf5","name":"set covers pct","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":120,"wires":[[]]},{"id":"590a691c1c3f2ab3","type":"function","z":"ab914a2a493ebbf5","name":"morning_open_if","func":"let shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\nlet covers = msg.covers\nlet msgs = []\n\nfor (let cover of covers) {\n    if (cover.result === \"True\") {\n        delete shutter_awaiting[cover.key]\n        msgs.push({ delay: 5000, payload: { data: { entity_id: cover.key, value: 100 } } })\n    }\n}\n\nflow.set(\"shutter_awaiting\", shutter_awaiting)\nif (msgs.length > 0) {\n    return [msgs, {}]\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":620,"wires":[["1cf5901aaabd830d"],["8442394fedda85eb"]]},{"id":"8442394fedda85eb","type":"link out","z":"ab914a2a493ebbf5","name":"link out 663","mode":"link","links":["483de433aae6aa9b"],"x":655,"y":620,"wires":[]},{"id":"483de433aae6aa9b","type":"link in","z":"ab914a2a493ebbf5","name":"link in 583","links":["8442394fedda85eb"],"x":285,"y":300,"wires":[["28562681c5f0cf42"]]},{"id":"13cbdf2519336c0e","type":"comment","z":"ab914a2a493ebbf5","name":"cover open in morning check conditions","info":"","x":190,"y":560,"wires":[]},{"id":"310996b3b0510416","type":"function","z":"ab914a2a493ebbf5","name":"prepare cover","func":"let windows = msg.linked_windows\nlet covers = []\n\nfor (let cover of msg.covers) {\n    covers.push({\n        ...cover,\n        windows_is_closed: (windows.find(a => a.entity_id == cover.linked_window)?.state ?? \"off\") == \"off\",\n        template: setTemplateVariables(cover.morning_open_if ?? \"True\")\n    })\n}\nreturn { value: msg.value, covers: covers }\n\nfunction setTemplateVariables(condition) {\n    if (condition.includes(\"global.\")) {\n        let globals_to_inject = global.keys().filter(g => condition.includes(\"global.\" + g))\n        if (globals_to_inject.length != 0) {\n            let injection = '{% set global = {'\n            for (let g of globals_to_inject) {\n                injection += '\"' + g + '\":' + JSON.stringify(global.get(g) ?? {}) + ','\n            }\n            injection = injection.slice(0, -1)\n            injection += '} %}'\n            condition = injection + condition\n            return condition\n        }\n    } else {\n        return condition\n    }\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":240,"wires":[["195d20bfb4f2a7b8"]]},{"id":"6fbe81a8d83e4afa","type":"function","z":"ab914a2a493ebbf5","name":"set covers","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\"\nlet shutter_awaiting = flow.get(\"shutter_awaiting\") ?? {}\nlet motion_areas = global.get(\"motion_areas\") ?? {}\nlet value = msg.value\nlet entity_ids = []\n\nfor (let cover of msg.covers) {\n    if (in_home_zone && value == 100) {\n        if ((motion_areas[cover.linked_area] === \"on\" || motion_areas[cover.linked_area] === \"last\") && cover.result === \"True\") {\n            entity_ids.push(cover.entity_id)\n        } else {\n            shutter_awaiting[cover.entity_id] = cover\n            flow.set(\"shutter_awaiting\", shutter_awaiting)\n        }\n    } else if (value == 100 || (value == 0 && cover.windows_is_closed)) {\n        entity_ids.push(cover.entity_id)\n    }\n}\n\nif (entity_ids.length > 0) {\n    return [{ delay: 20000, payload: { data: { entity_id: entity_ids, value: value } } }, { num_covers: entity_ids.length, value: value }]\n}","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":240,"wires":[["7ae90af559f343a8"],["20fdf92ff181ca3a"]]},{"id":"7d27ebb47456198e","type":"api-render-template","z":"ab914a2a493ebbf5","name":"","server":"c87720f17866318d","version":0,"template":"","resultsLocation":"covers.result","resultsLocationType":"msg","templateLocation":"covers.template","templateLocationType":"msg","x":460,"y":120,"wires":[["2e0a27701d8761c7"]]},{"id":"c53b44f12105b44f","type":"split","z":"ab914a2a493ebbf5","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"covers","x":315,"y":120,"wires":[["c90483bc642b8161"]],"l":false},{"id":"2f84a3595489e737","type":"join","z":"ab914a2a493ebbf5","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":605,"y":120,"wires":[["d92c38c7e8c570bb"]],"l":false},{"id":"c90483bc642b8161","type":"change","z":"ab914a2a493ebbf5","name":"","rules":[{"t":"set","p":"template","pt":"msg","to":"covers.template","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":365,"y":120,"wires":[["7d27ebb47456198e"]],"l":false},{"id":"2e0a27701d8761c7","type":"change","z":"ab914a2a493ebbf5","name":"","rules":[{"t":"delete","p":"covers.template","pt":"msg"},{"t":"delete","p":"template","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":555,"y":120,"wires":[["2f84a3595489e737"]],"l":false},{"id":"e86a2f2dc70c0409","type":"link in","z":"ab914a2a493ebbf5","name":"template","links":[],"x":255,"y":120,"wires":[["c53b44f12105b44f"]]},{"id":"d92c38c7e8c570bb","type":"link out","z":"ab914a2a493ebbf5","name":"link out 680","mode":"return","links":[],"x":655,"y":120,"wires":[]},{"id":"4f6e12f8120bd87f","type":"link call","z":"ab914a2a493ebbf5","name":"","links":["e86a2f2dc70c0409"],"linkType":"static","timeout":"30","x":360,"y":620,"wires":[["590a691c1c3f2ab3"]]},{"id":"195d20bfb4f2a7b8","type":"link call","z":"ab914a2a493ebbf5","name":"","links":["e86a2f2dc70c0409"],"linkType":"static","timeout":"30","x":600,"y":240,"wires":[["6fbe81a8d83e4afa"]]},{"id":"5a0d2ba7dcd1fe03","type":"function","z":"ab914a2a493ebbf5","name":"covers >","func":"msg.search = { \"is\": { linked_class: \"cover\" } }\nmsg.output_name = \"covers\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":180,"wires":[["a0083b9b4374f22b"]]},{"id":"a0083b9b4374f22b","type":"subflow:3da7ebfd83a38899","z":"ab914a2a493ebbf5","name":"","x":695,"y":180,"wires":[["b33b7ed16b6c0484"]],"l":false},{"id":"1cf5901aaabd830d","type":"link out","z":"ab914a2a493ebbf5","name":"link out 681","mode":"link","links":["650bedc3554a2a02"],"x":655,"y":620,"wires":[]},{"id":"650bedc3554a2a02","type":"link in","z":"ab914a2a493ebbf5","name":"link in 598","links":["1cf5901aaabd830d","7ae90af559f343a8"],"x":705,"y":120,"wires":[["8839e284ccedc92c"]]},{"id":"7ae90af559f343a8","type":"link out","z":"ab914a2a493ebbf5","name":"link out 682","mode":"link","links":["650bedc3554a2a02"],"x":855,"y":240,"wires":[]},{"id":"b020e66ae86cfbd0","type":"function","z":"a62a0ee8573c9b72","name":"receive activities states","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state)\nlet action = msg.payload.event.action\nlet persons = msg.persons\n\nfor (let p of persons) {\n    if (action.includes(p.name + \"_\")) {\n        let training = action.split(\"_\")[1]\n        if (activities[p.name]?.[training]?.[2]) {\n            if (activities[p.name][training][0] < activities[p.name][training][1]) {\n                activities[p.name][training][0]++\n            }\n            if (activities[p.name][training][0] == activities[p.name][training][1]) {\n                activities[p.name][training][2] = false\n            }\n\n        }\n    }\n}\n\nmsg.payload = { \"data\": { \"value\": JSON.stringify(activities) } }\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":300,"wires":[["e10a6ab642e72857"]]},{"id":"4b68efecf1da94d1","type":"json","z":"a62a0ee8573c9b72","name":"","property":"payload","action":"","pretty":false,"x":590,"y":360,"wires":[["fd64dae6925e84ee"]]},{"id":"b1fa06090656fd52","type":"catch","z":"a62a0ee8573c9b72","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["74f70af5292cd7f0"]]},{"id":"b5f1fd6eac80b150","type":"subflow:ba09e97f2ed22f2b","z":"a62a0ee8573c9b72","name":"","x":340,"y":240,"wires":[]},{"id":"2b8a6446b97c275d","type":"subflow:ad3b29a5dd67898f","z":"a62a0ee8573c9b72","name":"","x":460,"y":40,"wires":[["c31a6f8463401855"]]},{"id":"74f70af5292cd7f0","type":"change","z":"a62a0ee8573c9b72","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"sport","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["2b8a6446b97c275d"]]},{"id":"c437e0a422479e97","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.title = \"Module sant√©: Activ√©e\"\nmsg.message = msg.payload\nmsg.send_to = msg.persons.filter(p => p.sport).map(p => p.name)\nmsg.send_mobile = true\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":540,"wires":[["0ece54a40b22328b"]]},{"id":"0ece54a40b22328b","type":"subflow:ba09e97f2ed22f2b","z":"a62a0ee8573c9b72","name":"","x":880,"y":540,"wires":[]},{"id":"8f546715d338a376","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.notification_id = \"module_healthy\"\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module sant√© d√©sactiv√©\"\n    msg.message = \"Module sant√© d√©sactiv√©, vous ne recevrez plus de notifications d'activit√©s\"\n    msg.send_to = msg.persons.filter(p => p.sport).map(p => p.name)\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":480,"wires":[["3b3dd6b16a5c5a1d"]]},{"id":"3b3dd6b16a5c5a1d","type":"link out","z":"a62a0ee8573c9b72","name":"link out 416","mode":"link","links":["e53334a6f05a9609"],"x":855,"y":480,"wires":[]},{"id":"e10a6ab642e72857","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":710,"y":300,"wires":[[]]},{"id":"ea3fb831dea35c4d","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motiv","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_{{payload}}","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":270,"y":480,"wires":[[]]},{"id":"4020e05dc1d0c23a","type":"server-events","z":"a62a0ee8573c9b72","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":300,"wires":[["a9d7993927bc5de0"]]},{"id":"508f7fb084e67cee","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_text.json_activities","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":360,"wires":[["0408ccba95850002"]]},{"id":"8640a3a14306a54b","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motiv","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":540,"wires":[["750cd436f7187d1f"],[]]},{"id":"e7e6f923a633831a","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"module_healthy","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_healty","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":480,"wires":[["ea3fb831dea35c4d","28460c8a51f888b3"]]},{"id":"d30ddd8ce8b5dbc5","type":"function","z":"a62a0ee8573c9b72","name":"prepare trainings","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state)\nlet random = Math.random() * 100\nlet twd = two_week_day()\nlet persons = msg.persons\nlet msgs = []\n\nfor (let person of persons) {\n\n    if (!activities[person.name]) {\n        activities[person.name] = {}\n        activities[person.name][\"days\"] = 0\n    }\n\n    let objective_calendar = person.sport.objective_calendar\n    let todays_objectives = Object.keys(objective_calendar).filter(a => objective_calendar[a][twd])\n\n    for (let o of Object.keys(objective_calendar)) {\n        if (activities[person.name][o] === undefined) {\n            activities[person.name][o] = [0, 0, false]\n        }\n    }\n\n    let objective_conditions = person.sport.objective_conditions ?? []\n    objective_conditions = validate_objective_conditions(objective_conditions, todays_objectives)\n    todays_objectives = calculate_objective_conditions(objective_conditions, person, todays_objectives)\n\n    let objective_limits = person.sport.objective_limits\n\n    for (let o of todays_objectives) {\n        let translations = \"objective_translations\" in person.sport && o in person.sport.objective_translations ? person.sport.objective_translations[o] : o\n        let todays_objective_limit = []\n\n        activities[person.name][o][1]++\n        activities[person.name][o][2] = true\n\n        if (Array.isArray(objective_limits[o])) {\n            todays_objective_limit = calculate_training(person, objective_limits[o])\n        } else if (typeof objective_limits[o] === \"object\") {\n            for (let keys of Object.keys(objective_limits[o])) {\n                let objectiveName = keys.charAt(0).toUpperCase() + keys.slice(1)\n                todays_objective_limit.push(objectiveName + \": \" + calculate_training(person, objective_limits[o][keys]))\n            }\n            todays_objective_limit = todays_objective_limit.join(\"\\n\")\n        }\n        msgs.push({ objective: { name: o, translations: translations, todays_objective_limit: todays_objective_limit, person: person.name } })\n    }\n    if (activities[person.name][\"days\"] < person.sport.days_to_ojective) {\n        activities[person.name][\"days\"]++\n    }\n}\nmsg = { \"payload\": { \"data\": { \"value\": JSON.stringify(activities) } } }\nreturn [msgs, msg]\n\nfunction validate_objective_conditions(objective_conditions, todays_objectives) {\n    let vp = []\n    for (let p of objective_conditions) {\n        let count = 0\n        for (let w of p.split(\" \")) {\n            if (todays_objectives.includes(w)) {\n                count++\n            }\n        }\n        if (count == 2) {\n            vp.push(p)\n        }\n    }\n    return vp\n}\n\nfunction calculate_objective_conditions(objective_conditions, person, todays_objectives) {\n    for (let p of objective_conditions) {\n        let p_split = p.trim().split(\" \")\n        if (p_split.length == 4 && p_split.includes(\"or\")) {\n            let percentage = p_split[0].replace(\"%\", \"\")\n            todays_objectives = todays_objectives.filter(t => t != (random < parseInt(percentage) ? p_split[3] : p_split[1]))\n        } else if (p_split.length == 3 && p_split.includes(\"to\")) {\n            let percentage = ((person.sport.days_to_ojective - activities[person.name][\"days\"]) / person.sport.days_to_ojective) * 100\n            todays_objectives = todays_objectives.filter(t => t != (random < parseInt(percentage) ? p_split[2] : p_split[0]))\n        }\n    }\n    return todays_objectives\n}\n\nfunction calculate_training(person, objective_limits) {\n    let objective = \"\"\n    if (isNaN(objective_limits[0]) && isNaN(objective_limits[1])) {\n        let min_g_split = objective_limits[0].trim().split(\" \")\n        let max_g_split = objective_limits[1].trim().split(\" \")\n        let percentage = activities[person.name][\"days\"] / person.sport.days_to_ojective\n        objective = parseInt((max_g_split[0] - min_g_split[0]) * percentage + parseInt(min_g_split[0])) + \" \" + max_g_split[1]\n    } else {\n        let min_g = objective_limits[0]\n        let max_g = objective_limits[1]\n        let percentage = activities[person.name][\"days\"] / person.sport.days_to_ojective\n        let serie_number = parseInt(5 + percentage * 3.99)\n        let repetition_number = parseInt(((max_g - min_g) * percentage + min_g) / serie_number)\n        let rest_number = parseInt(((max_g - min_g) * percentage + min_g) % serie_number)\n        objective = repetition_number + \" * \" + serie_number + (rest_number == 0 ? \"\" : \" + \" + rest_number % serie_number)\n    }\n    return objective\n}\n\nfunction two_week_day() {\n    let date = new Date()\n    let p_week = Math.floor((date.getTime() - new Date(date.getFullYear() + \"-01-01\").getTime()) / (1000 * 60 * 60 * 24 * 7)) % 2\n    return (p_week === 0 ? 0 : 7) + (date.getDay() === 0 ? 7 : date.getDay())\n}","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":120,"wires":[["8356eb9f76953cee"],["4b48cea1d75de3f5"]]},{"id":"ee180b383f6fc021","type":"function","z":"a62a0ee8573c9b72","name":"send trainings","func":"let title = \"Sport: \" + (msg.objective.todays_objective_limit.length != 0 ? \"une s√©ance de \" + msg.objective.translations + \" est pr√©vue\" : msg.objective.translations)\nlet message = msg.objective.todays_objective_limit.length != 0 ? \"Votre objectif: \\n\" + msg.objective.todays_objective_limit : \"\"\n\nmsg = {\n    title: title,\n    message: message,\n    send_to: [msg.objective.person],\n    send_mobile: true,\n    data: {\n        actions: [{ \"action\": msg.objective.person + \"_\" + msg.objective.name, \"title\": \"Fait avec amour\" }],\n        timeout: 60 * 60 * 20\n    }\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":240,"wires":[["b5f1fd6eac80b150"]]},{"id":"4b48cea1d75de3f5","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":870,"y":120,"wires":[[]]},{"id":"a9d7993927bc5de0","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":300,"wires":[["5bcdeaff2377f30c"]]},{"id":"5bcdeaff2377f30c","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":355,"y":300,"wires":[["b020e66ae86cfbd0"]],"l":false},{"id":"0408ccba95850002","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":360,"wires":[["024a365e9fc9cb4f"]]},{"id":"024a365e9fc9cb4f","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":355,"y":360,"wires":[["6576fd141124102d"]],"l":false},{"id":"750cd436f7187d1f","type":"subflow:386f1888bc94b4c8","z":"a62a0ee8573c9b72","name":"","x":230,"y":540,"wires":[["c68f722f20b3c9e7"]]},{"id":"0927b670d75da52a","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motivation_reset","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation_reset","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":120,"y":420,"wires":[["e34b2780cf7d6f2d","d38f23be4a30a1a5"],[]]},{"id":"e34b2780cf7d6f2d","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motivation_reset off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_reset"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":310,"y":420,"wires":[[]]},{"id":"9a89420de8a81170","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities reset","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"{\"value\":\"{}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":420,"wires":[[]]},{"id":"49e5d163f4be72be","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motivation_resend","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.motivation_resend","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"resend","propertyType":"msg","value":"true","valueType":"bool"}],"x":130,"y":180,"wires":[["667a5bf7be337413"],[]]},{"id":"667a5bf7be337413","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motivation_resend off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_resend"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":180,"wires":[["2b3d45b8808003b1"]]},{"id":"2b3d45b8808003b1","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":180,"wires":[["898149bca31f71c4"]]},{"id":"898149bca31f71c4","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":615,"y":180,"wires":[["139a4ef42e461b9c"]],"l":false},{"id":"bb407002bae6b6ca","type":"link out","z":"a62a0ee8573c9b72","name":"link out 575","mode":"link","links":["0903a19a38bc4d0b"],"x":975,"y":120,"wires":[]},{"id":"a14109dee33a3446","type":"link out","z":"a62a0ee8573c9b72","name":"link out 576","mode":"link","links":["0903a19a38bc4d0b"],"x":995,"y":180,"wires":[]},{"id":"0903a19a38bc4d0b","type":"link in","z":"a62a0ee8573c9b72","name":"link in 525","links":["bb407002bae6b6ca","a14109dee33a3446"],"x":55,"y":240,"wires":[["ee180b383f6fc021"]]},{"id":"28460c8a51f888b3","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":480,"wires":[["c403906919704162"]]},{"id":"c403906919704162","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":495,"y":480,"wires":[["f6b7cff7effc6c38"]],"l":false},{"id":"c68f722f20b3c9e7","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":540,"wires":[["5d14dd3a4924e657"]]},{"id":"5d14dd3a4924e657","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":475,"y":540,"wires":[["b337ca541994ff7e"]],"l":false},{"id":"c31a6f8463401855","type":"link out","z":"a62a0ee8573c9b72","name":"link out 637","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"fd1fb5e279e78938","type":"link in","z":"a62a0ee8573c9b72","name":"link in 584","links":["1d97dd5683519b2b","c188d79531761c3c"],"x":55,"y":120,"wires":[["a135bb19ac1ae7da"]]},{"id":"a135bb19ac1ae7da","type":"api-current-state","z":"a62a0ee8573c9b72","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":170,"y":120,"wires":[["d255613b438357a0"],[]]},{"id":"d255613b438357a0","type":"function","z":"a62a0ee8573c9b72","name":"person >","func":"msg.search = { \"is\": { linked_class: \"person\", state: \"home\" } }\nmsg.output_name = \"persons\"\nmsg.output_empty_results = false\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":120,"wires":[["edc96e49a3960d93"]]},{"id":"edc96e49a3960d93","type":"subflow:3da7ebfd83a38899","z":"a62a0ee8573c9b72","name":"","x":425,"y":120,"wires":[["d11be89a08ab9cf6"]],"l":false},{"id":"d11be89a08ab9cf6","type":"function","z":"a62a0ee8573c9b72","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":120,"wires":[["d30ddd8ce8b5dbc5"]]},{"id":"139a4ef42e461b9c","type":"function","z":"a62a0ee8573c9b72","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":180,"wires":[["d09a37be779f5695"]]},{"id":"6576fd141124102d","type":"function","z":"a62a0ee8573c9b72","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":360,"wires":[["4b68efecf1da94d1"]]},{"id":"0429572f34c1181a","type":"function","z":"a62a0ee8573c9b72","name":"build html activities tab","func":"let activities = msg.payload\nlet persons = msg.persons\nlet html = \"\"\nlet msgs = []\n\nfor (let person of persons) {\n    html += buildHTML(person, activities)\n}\n\nlet gap = 0\nfor (let i = 0; i < 4; i++) {\n    msgs.push({ payload: { data: { entity_id: \"input_text.motivation_\" + (i + 1), value: html.substring(gap, (gap + 254)) } } })\n    gap += 254\n}\nreturn [msgs]\n\nfunction buildHTML(person, activities) {\n    let table = [\"\", \"\"]\n    let percent = [0, 0]\n    let sub_html = \"\"\n    for (let key of Object.keys(person.sport.objective_calendar)) {\n        if (activities[person.name][key]) {\n            table[0] += '<th style=\"width:20%\">' + (person.sport?.objective_translations?.[key] ?? key) + '</th>'\n            table[1] += '<td>' + (activities[person.name][key][0] === activities[person.name][key][1] ? '‚úÖ' : activities[person.name][key][0] + \"/\" + activities[person.name][key][1]) + '</td>'\n            percent[0] += activities[person.name][key][0]\n            percent[1] += activities[person.name][key][1]\n        }\n    }\n    sub_html += '<center><b>' + 'Sport et sant√© : ' + person.name + \"<b></br>\"\n    sub_html += \"<b>Jour \" + activities[person.name][\"days\"] + \"/\" + person.sport.days_to_ojective + \" : \"\n    sub_html += (percent[1] == 0 ? 0 : parseInt(100 * percent[0] / percent[1])) + '% des objectifs atteints' + '</b></center><hr>'\n    sub_html += '<table style=\"width:100%;text-align:center\"><tr>' + table[0] + '</tr><tr>' + table[1] + '</tr></table>'\n    return sub_html\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":360,"wires":[["fc225d0ed2994071"]]},{"id":"f6b7cff7effc6c38","type":"function","z":"a62a0ee8573c9b72","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":480,"wires":[["8f546715d338a376"]]},{"id":"b337ca541994ff7e","type":"function","z":"a62a0ee8573c9b72","name":"set sport","func":"let functions = global.get(\"functions\") ?? {}\nmsg.persons = functions[\"get_persons_sport\"](msg.persons)\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":540,"wires":[["c437e0a422479e97"]]},{"id":"fd64dae6925e84ee","type":"switch","z":"a62a0ee8573c9b72","name":"empty","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":685,"y":360,"wires":[["404f3882f4ffcce7"],["0429572f34c1181a"]],"l":false},{"id":"c188d79531761c3c","type":"link out","z":"a62a0ee8573c9b72","name":"link out 664","mode":"link","links":["fd1fb5e279e78938"],"x":1115,"y":360,"wires":[]},{"id":"d09a37be779f5695","type":"function","z":"a62a0ee8573c9b72","name":"resend trainings","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state)\nlet twd = two_week_day()\nlet persons = msg.persons\nlet msgs = []\n\nfor (let person of persons) {\n    let person_activities_keys = Object.keys(activities[person.name]).filter(a => a != \"days\")\n    let activities_not_finished = []\n\n    for (let activity of person_activities_keys) {\n        if (activities[person.name][activity][0] != activities[person.name][activity][1]) {\n            activities_not_finished.push({ activity: activity, number: (activities[person.name][activity][1] - activities[person.name][activity][0]) })\n        }\n    }\n\n    let person_day = activities[person.name][\"days\"]\n    let objective_calendar = person.sport.objective_calendar\n    let objective_limits = person.sport.objective_limits\n\n    for (let i = 0; i < activities_not_finished.length; i++) {\n        for (let j = person_day; j > 0; j--) {\n            let day = adjusted_day(twd - (person_day - j))\n            if (\n                activities_not_finished[i][\"number\"] > 0\n                && activities_not_finished[i][\"activity\"] in objective_calendar\n                && objective_calendar[activities_not_finished[i][\"activity\"]][day]\n            ) {\n                activities_not_finished[i][\"number\"]--\n                let activity = activities_not_finished[i][\"activity\"]\n                let translation = \"objective_translations\" in person.sport && activity in person.sport.objective_translations ? person.sport.objective_translations[activity] : activity\n\n                if (Array.isArray(objective_limits[activity]) || objective_limits[activity] === undefined) {\n                    msgs.push(\n                        {\n                            objective: {\n                                name: activity,\n                                translations: translation,\n                                todays_objective_limit: translation + (Array.isArray(objective_limits[activity]) ? \": \" + calculate_training(person, objective_limits[activity], j) : \"\"),\n                                person: person.name\n                            }\n                        }\n                    )\n                } else if (typeof objective_limits[activity] === \"object\") {\n                    let objective_limit = []\n                    for (let keys of Object.keys(objective_limits[activity])) {\n                        let objectiveName = keys.charAt(0).toUpperCase() + keys.slice(1)\n                        objective_limit.push(objectiveName + \": \" + calculate_training(person, objective_limits[activity][keys], j))\n                    }\n                    objective_limit = objective_limit.join(\"\\n\")\n                    msgs.push(\n                        {\n                            objective: {\n                                name: activity,\n                                translations: translation,\n                                todays_objective_limit: objective_limit,\n                                person: person.name\n                            }\n                        }\n                    )\n                }\n            }\n        }\n    }\n}\nreturn [msgs]\n\nfunction adjusted_day(day) {\n    return day < 1 ? adjusted_day(day + 14) : day\n}\n\nfunction calculate_training(person, objective_limits, person_day) {\n    let objective = \"\"\n    if (isNaN(objective_limits[0]) && isNaN(objective_limits[1])) {\n        let min_g_split = objective_limits[0].trim().split(\" \")\n        let max_g_split = objective_limits[1].trim().split(\" \")\n        let percentage = person_day / person.sport.days_to_ojective\n        objective = parseInt((max_g_split[0] - min_g_split[0]) * percentage + parseInt(min_g_split[0])) + \" \" + max_g_split[1]\n    } else {\n        let min_g = objective_limits[0]\n        let max_g = objective_limits[1]\n        let percentage = person_day / person.sport.days_to_ojective\n        let serie_number = parseInt(5 + percentage * 3.99)\n        let repetition_number = parseInt(((max_g - min_g) * percentage + min_g) / serie_number)\n        let rest_number = parseInt(((max_g - min_g) * percentage + min_g) % serie_number)\n        objective = repetition_number + \" * \" + serie_number + (rest_number == 0 ? \"\" : \" + \" + rest_number % serie_number)\n    }\n    return objective\n}\n\nfunction two_week_day() {\n    let date = new Date()\n    let p_week = Math.floor((date.getTime() - new Date(date.getFullYear() + \"-01-01\").getTime()) / (1000 * 60 * 60 * 24 * 7)) % 2\n    return (p_week === 0 ? 0 : 7) + (date.getDay() === 0 ? 7 : date.getDay())\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":180,"wires":[["a14109dee33a3446"]]},{"id":"fc225d0ed2994071","type":"api-call-service","z":"a62a0ee8573c9b72","name":"health_stats_","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1010,"y":360,"wires":[[]]},{"id":"0b58061cac0414bc","type":"catch","z":"22b4130fe1f6a28b","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["5628c3b6e6e05cc2"]]},{"id":"8308b45e584b06f6","type":"subflow:ad3b29a5dd67898f","z":"22b4130fe1f6a28b","name":"","x":460,"y":40,"wires":[["6b33d1d98f2bb2df"]]},{"id":"5628c3b6e6e05cc2","type":"change","z":"22b4130fe1f6a28b","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Updates","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8308b45e584b06f6"]]},{"id":"8b90ccdbc66dac03","type":"function","z":"22b4130fe1f6a28b","name":"get node-red addon","func":"let nodeRed = global.get('homeassistant').homeAssistant.states[\"update.node_red_update\"]\n\nif (nodeRed.attributes?.entity_picture) {\n    msg.addon = nodeRed.attributes.entity_picture.replace(\"/api/hassio/addons/\", \"\").replace(\"/icon\", \"\")\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":480,"wires":[["4392c27b07392a2e","a0f5e36615e385c8"]]},{"id":"19c67d2aca8dacf4","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":590,"y":300,"wires":[["a84852adfbcf0f82"],[],[]]},{"id":"a84852adfbcf0f82","type":"switch","z":"22b4130fe1f6a28b","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":720,"y":300,"wires":[["6b594e58c4deee27"]]},{"id":"6b594e58c4deee27","type":"link out","z":"22b4130fe1f6a28b","name":"link out 428","mode":"link","links":["1a58fc318d2a551d"],"x":815,"y":300,"wires":[]},{"id":"c1d14ac0a4c78950","type":"template","z":"22b4130fe1f6a28b","name":"git pull","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cd /\ncd homeassistant\ngit reset --hard HEAD\ngit pull -f https://github.com/lemuriens/combava.git","output":"str","x":470,"y":300,"wires":[["19c67d2aca8dacf4"]]},{"id":"af0c165af5996110","type":"link out","z":"22b4130fe1f6a28b","name":"link out 429","mode":"link","links":["e53334a6f05a9609"],"x":1015,"y":180,"wires":[]},{"id":"298b1c45c4d0b500","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"new_update_available\"\nmsg.title = \"Mise √† jour disponible üéâ\"\nmsg.alert_type = \"success\"\nmsg.message = \"Des nouveaut√©s sont disponibles pour votre maison connect√©e üéâ\"\nmsg.data = { actions: [{ \"action\": \"do_update\", \"title\": \"Mettre √† jour\" }] }\nmsg.send_mobile = true\n\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":180,"wires":[["af0c165af5996110"]]},{"id":"aab0f034678b38fc","type":"comment","z":"22b4130fe1f6a28b","name":"Github PULL","info":"","x":110,"y":120,"wires":[]},{"id":"110190f367ccfb85","type":"link in","z":"22b4130fe1f6a28b","name":"link in 436","links":["e0c8cc5539007c7d"],"x":55,"y":480,"wires":[["8b90ccdbc66dac03"]]},{"id":"3f58fc642c3feedb","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"new_update_available\"\nmsg.dismiss = true\n\nreturn msg\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":240,"wires":[["9a6820da31f5f8c4"]]},{"id":"9a6820da31f5f8c4","type":"link out","z":"22b4130fe1f6a28b","name":"link out 431","mode":"link","links":["e53334a6f05a9609"],"x":935,"y":240,"wires":[]},{"id":"2b3edb3f3845716f","type":"link out","z":"22b4130fe1f6a28b","name":"link out 432","mode":"link","links":["d6e719e8cc85424f"],"x":985,"y":240,"wires":[]},{"id":"d6e719e8cc85424f","type":"link in","z":"22b4130fe1f6a28b","name":"link in 437","links":["2b3edb3f3845716f"],"x":55,"y":300,"wires":[["88ce8957d8839f95"]]},{"id":"88ce8957d8839f95","type":"subflow:515fe2385f553c95","z":"22b4130fe1f6a28b","name":"","x":170,"y":300,"wires":[[],["9d4c4b04edf80d7d"]]},{"id":"d83697681a841be5","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"module_update\"\n\nif (msg.payload == \"off\") {\n    msg.alert_type = \"info\"\n    msg.title = \"Module mises √† jour automatique d√©sactiv√©\"\n    msg.message = \"Module mises √† jour automatique d√©sactiv√©, vous recevrez une notification lorsqu'une mise √† jour est disponible.\"\n    msg.send_mobile = true\n} else {\n    msg.dismiss = true\n}\n\nreturn msg","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":600,"wires":[["4d571b7c3108dd2f"]]},{"id":"4d571b7c3108dd2f","type":"link out","z":"22b4130fe1f6a28b","name":"link out 519","mode":"link","links":["e53334a6f05a9609"],"x":395,"y":600,"wires":[]},{"id":"4cc115cfe408499c","type":"link out","z":"22b4130fe1f6a28b","name":"link out 520","mode":"link","links":["f653e56d38a91ee4"],"x":595,"y":180,"wires":[]},{"id":"b130a4ed6345f4d5","type":"link in","z":"22b4130fe1f6a28b","name":"update available on","links":[],"x":55,"y":540,"wires":[["e34e640e14f1f461"]]},{"id":"cf2657d204eb2c9f","type":"link out","z":"22b4130fe1f6a28b","name":"update available on","mode":"return","links":[],"x":515,"y":540,"wires":[]},{"id":"19c209fee8b092e0","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["b130a4ed6345f4d5"],"linkType":"static","timeout":"30","x":730,"y":180,"wires":[["298b1c45c4d0b500"]]},{"id":"1b50b093ec877908","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["b130a4ed6345f4d5"],"linkType":"static","timeout":"30","x":470,"y":180,"wires":[["4cc115cfe408499c"]]},{"id":"f653e56d38a91ee4","type":"link in","z":"22b4130fe1f6a28b","name":"link in 479","links":["4cc115cfe408499c"],"x":535,"y":240,"wires":[["73e582bba532abcd"]]},{"id":"1f7e465a76157a74","type":"switch","z":"22b4130fe1f6a28b","name":"do_update","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"do_update","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":430,"y":240,"wires":[["73e582bba532abcd"]]},{"id":"b34dbefb140bec6d","type":"inject","z":"22b4130fe1f6a28b","name":"","props":[],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","x":120,"y":1080,"wires":[["a26113ff363a254e"]]},{"id":"a26113ff363a254e","type":"function","z":"22b4130fe1f6a28b","name":"first of month ?","func":"let d = new Date()\n\nif (d.getDate() == 1) {\n    let year = d.getFullYear()\n    let month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1)\n    let day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate()\n    let hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours()\n    let minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes()\n\n    msg.backup_name = \"AutoBackup \" + year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute\n    return msg\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":1080,"wires":[["430dd7d2e9b8d646"]]},{"id":"63706c58ab1c4858","type":"comment","z":"22b4130fe1f6a28b","name":"Every month backup","info":"","x":130,"y":1020,"wires":[]},{"id":"1a58fc318d2a551d","type":"link in","z":"22b4130fe1f6a28b","name":"link in 500","links":["6b594e58c4deee27"],"x":55,"y":360,"wires":[["83a24499de6edc53"]]},{"id":"b3d42b3a9f249920","type":"link out","z":"22b4130fe1f6a28b","name":"link out 554","mode":"link","links":["69034fa0ae21d5d1"],"x":755,"y":360,"wires":[]},{"id":"0d8ee2b7521ee713","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":350,"y":360,"wires":[["d198505431c980d7"],[],[]]},{"id":"83a24499de6edc53","type":"template","z":"22b4130fe1f6a28b","name":"check update folder","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cd /\ncd /homeassistant/node-red\nls","output":"str","x":190,"y":360,"wires":[["0d8ee2b7521ee713"]]},{"id":"704f7ca1331ab597","type":"function","z":"22b4130fe1f6a28b","name":"update exist ?","func":"if (msg.payload.includes(\"flows.json\")) {\n    return [msg, null]\n} else {\n    return [null, msg]\n}\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":360,"wires":[["b3d42b3a9f249920"],["f749f8e851513de0"]]},{"id":"d198505431c980d7","type":"switch","z":"22b4130fe1f6a28b","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":480,"y":360,"wires":[["704f7ca1331ab597"]]},{"id":"69034fa0ae21d5d1","type":"link in","z":"22b4130fe1f6a28b","name":"link in 501","links":["b3d42b3a9f249920"],"x":55,"y":420,"wires":[["d57ca309aac1ee9e"]]},{"id":"e0c8cc5539007c7d","type":"link out","z":"22b4130fe1f6a28b","name":"link out 555","mode":"link","links":["110190f367ccfb85"],"x":775,"y":420,"wires":[]},{"id":"e6a391cf060c277e","type":"template","z":"22b4130fe1f6a28b","name":"replace flows.json","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"mv -f /homeassistant/node-red/flows.json /config","output":"str","x":390,"y":420,"wires":[["ce832bbaa561ea36"]]},{"id":"ce832bbaa561ea36","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":550,"y":420,"wires":[["b109e4562df83a83"],[],[]]},{"id":"b109e4562df83a83","type":"switch","z":"22b4130fe1f6a28b","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":680,"y":420,"wires":[["e0c8cc5539007c7d"]]},{"id":"4a451e77abd1b596","type":"link in","z":"22b4130fe1f6a28b","name":"link in 502","links":["f749f8e851513de0"],"x":495,"y":480,"wires":[["a0f5e36615e385c8"]]},{"id":"f749f8e851513de0","type":"link out","z":"22b4130fe1f6a28b","name":"link out 556","mode":"link","links":["4a451e77abd1b596"],"x":755,"y":360,"wires":[]},{"id":"e7b4857a10952d79","type":"comment","z":"22b4130fe1f6a28b","name":"Move flow.json when updated","info":"","x":160,"y":680,"wires":[]},{"id":"3ae5c3a13f5faa40","type":"watch","z":"22b4130fe1f6a28b","name":"watch","files":"/config/flows.json","recursive":"","x":90,"y":740,"wires":[["4eb7ed3ed304827e"]]},{"id":"031b2ea614cb2c86","type":"template","z":"22b4130fe1f6a28b","name":"move flows.json","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cp /config/flows.json /homeassistant/node-red/flows.json","output":"str","x":400,"y":740,"wires":[["afd44074e6c431e0"]]},{"id":"afd44074e6c431e0","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":550,"y":740,"wires":[[],[],[]]},{"id":"4eb7ed3ed304827e","type":"subflow:515fe2385f553c95","z":"22b4130fe1f6a28b","name":"","x":230,"y":740,"wires":[["031b2ea614cb2c86"],[]]},{"id":"d57ca309aac1ee9e","type":"function","z":"22b4130fe1f6a28b","name":"get node-red addon","func":"let nodeRed = global.get('homeassistant').homeAssistant.states[\"update.node_red_update\"]\n\nif (nodeRed.attributes?.entity_picture) {\n    msg.addon = nodeRed.attributes.entity_picture.replace(\"/api/hassio/addons/\", \"\").replace(\"/icon\", \"\")\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":420,"wires":[["e6a391cf060c277e"]]},{"id":"df4af56f9ed72f66","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update available on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":390,"y":540,"wires":[["cf2657d204eb2c9f"]]},{"id":"4392c27b07392a2e","type":"api-call-service","z":"22b4130fe1f6a28b","name":"restart node-red","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"hassio","service":"addon_restart","areaId":[],"deviceId":[],"entityId":[],"data":"{\"addon\":\"{{addon}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":480,"wires":[[]]},{"id":"73e582bba532abcd","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update validated","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":660,"y":240,"wires":[["3f58fc642c3feedb","2b3edb3f3845716f"]]},{"id":"e34e640e14f1f461","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update validated off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":190,"y":540,"wires":[["df4af56f9ed72f66"]]},{"id":"a0f5e36615e385c8","type":"api-call-service","z":"22b4130fe1f6a28b","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"homeassistant","service":"restart","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":640,"y":480,"wires":[[]]},{"id":"430dd7d2e9b8d646","type":"api-call-service","z":"22b4130fe1f6a28b","name":"launch backup","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"hassio","service":"backup_full","areaId":[],"deviceId":[],"entityId":[],"data":"{\"name\": \"{{backup_name}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":460,"y":1080,"wires":[[]]},{"id":"6bca473d1c40e349","type":"api-current-state","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":280,"y":180,"wires":[["1b50b093ec877908"],["dc40d6ce64930b70"]]},{"id":"7c15527fc574823e","type":"server-events","z":"22b4130fe1f6a28b","name":"phone receive","server":"c87720f17866318d","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":270,"y":240,"wires":[["1f7e465a76157a74"]]},{"id":"3a335bfb2e72f42a","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"github update","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.lemuriens_coconut_latest_commit","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":180,"wires":[["6bca473d1c40e349"]]},{"id":"72a35a1065bd206c","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_boolean.module_update","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":600,"wires":[["d83697681a841be5"]]},{"id":"6b895c552ae1c9ed","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"make update","server":"c87720f17866318d","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.update_from_lemuriens_coconut","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":240,"wires":[["bcb6e13c9c4fbcd1"],[]]},{"id":"7019fa2e19c3b733","type":"comment","z":"22b4130fe1f6a28b","name":"Auto update","info":"","x":110,"y":820,"wires":[]},{"id":"b434c2983041d3e6","type":"function","z":"22b4130fe1f6a28b","name":"update >","func":"let entities = global.get(\"homeassistant\").homeAssistant.states\nmsg.search = { \"is\": { entity_id: Object.keys(entities).filter( key => entities[key].entity_id.includes(\"update.\")), state: \"on\" } }\nmsg.output_name = \"entities\"\nmsg.output_empty_results = true\nreturn msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":880,"wires":[["484f714d351fd5c8"]]},{"id":"484f714d351fd5c8","type":"subflow:3da7ebfd83a38899","z":"22b4130fe1f6a28b","name":"","x":695,"y":880,"wires":[["eb748c191e521571"]],"l":false},{"id":"865416a5e6388c78","type":"function","z":"22b4130fe1f6a28b","name":"set update","func":"if (msg.entities.length != 0) {\n    msg = { entity_id: msg.entities[0].entity_id }\n    return [msg, null]\n} else {\n    msg.search = { \"is\": { release_summary: \"<ha-alert alert-type='error'>Restart of Home Assistant required</ha-alert>\" } }\n    msg.output_name = \"entities\"\n    msg.output_empty_results = false\n    return [null, msg]\n}\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":940,"wires":[["e38e53bbeddd11dc"],["de709106b8d2cfce"]]},{"id":"e38e53bbeddd11dc","type":"api-call-service","z":"22b4130fe1f6a28b","name":"install update","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"update","service":"install","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":330,"y":940,"wires":[[]]},{"id":"e3f6652ef7cd2a19","type":"api-current-state","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":440,"y":880,"wires":[["b434c2983041d3e6"],[]]},{"id":"04a21079abd782c3","type":"subflow:3da7ebfd83a38899","z":"22b4130fe1f6a28b","name":"","x":435,"y":940,"wires":[["91562fdb8e8c0d0d"]],"l":false},{"id":"6b39adf0f119c05c","type":"api-call-service","z":"22b4130fe1f6a28b","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"homeassistant","service":"restart","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":740,"y":940,"wires":[[]]},{"id":"eb748c191e521571","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["39372af8f404c7d2"],"linkType":"static","timeout":"30","x":810,"y":880,"wires":[["2cd3a85863873571"]]},{"id":"6b33d1d98f2bb2df","type":"link out","z":"22b4130fe1f6a28b","name":"link out 638","mode":"link","links":["e53334a6f05a9609"],"x":595,"y":40,"wires":[]},{"id":"68da9f17106d4fef","type":"inject","z":"22b4130fe1f6a28b","name":"@2:00","props":[],"repeat":"","crontab":"*/5 2 * * 2","once":false,"onceDelay":0.1,"topic":"","x":120,"y":880,"wires":[["b3afa6ca89e62855"]]},{"id":"e0d2e39268c4c8d3","type":"function","z":"22b4130fe1f6a28b","name":"first of month ?","func":"let d = new Date()\nif (d.getDate() == 1 && d.getHours() == 2) {\n    return msg\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":820,"wires":[[]]},{"id":"2cd3a85863873571","type":"link out","z":"22b4130fe1f6a28b","name":"link out 1","mode":"link","links":["86986a5a4d9af259"],"x":915,"y":880,"wires":[]},{"id":"86986a5a4d9af259","type":"link in","z":"22b4130fe1f6a28b","name":"link in 1","links":["2cd3a85863873571"],"x":55,"y":940,"wires":[["865416a5e6388c78"]]},{"id":"b3afa6ca89e62855","type":"subflow:94b2243985840d69","z":"22b4130fe1f6a28b","name":"","x":270,"y":880,"wires":[["e3f6652ef7cd2a19"]]},{"id":"91562fdb8e8c0d0d","type":"subflow:94b2243985840d69","z":"22b4130fe1f6a28b","name":"","x":550,"y":940,"wires":[["6b39adf0f119c05c"]]},{"id":"9d4c4b04edf80d7d","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["39372af8f404c7d2"],"linkType":"static","timeout":"30","x":330,"y":300,"wires":[["c1d14ac0a4c78950"]]}]