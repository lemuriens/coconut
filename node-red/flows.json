[{"id":"27148b7bb9f62ac7","type":"tab","label":"Core âœ…","disabled":false,"info":"","env":[]},{"id":"1131f5463c30e69b","type":"tab","label":"Inputs âœ…","disabled":false,"info":"","env":[]},{"id":"b0b353ce861d908b","type":"tab","label":"Presence âœ…","disabled":false,"info":"","env":[]},{"id":"ccf1abe540a3b5a9","type":"tab","label":"Light âœ…","disabled":false,"info":"","env":[]},{"id":"6838183963219fc9","type":"tab","label":"Heaters âœ…","disabled":false,"info":"","env":[]},{"id":"a1ed8ea56c7ba1f9","type":"tab","label":"Temperature âœ…","disabled":false,"info":"","env":[]},{"id":"7cc0f49198f44c93","type":"tab","label":"Devices âœ…","disabled":false,"info":"","env":[]},{"id":"ab914a2a493ebbf5","type":"tab","label":"Covers âœ…","disabled":false,"info":"","env":[]},{"id":"eaa696a731a52b23","type":"tab","label":"Reveil âœ…","disabled":false,"info":"","env":[]},{"id":"a62a0ee8573c9b72","type":"tab","label":"Sport âœ…","disabled":false,"info":""},{"id":"22b4130fe1f6a28b","type":"tab","label":"Github update âœ…","disabled":false,"info":"","env":[]},{"id":"e95b0d12eedce5f1","type":"tab","label":"Rainmeter âœ…","disabled":false,"info":""},{"id":"45b866d1e8e0fc54","type":"subflow","name":"fiesta","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"98ecd81521e7a75e"}]}],"out":[{"x":1100,"y":120,"wires":[{"id":"c6fbfce2784fd3bc","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"d193bde43bd55f9f","type":"subflow","name":"send remote command","info":"","category":"","in":[{"x":60,"y":100,"wires":[{"id":"c5ccf59387c5ac3b"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"386f1888bc94b4c8","type":"subflow","name":"motivation","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"c4c0894d444403e2"}]}],"out":[{"x":420,"y":60,"wires":[{"id":"4c9393d44c603ea8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"5a05b9ac0289ff03","type":"subflow","name":"area light notif","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"7c64a1a9d3b6b65d"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"lightEffect.count (number)"},{"name":"2*","type":"str","value":"lightEffect.hue1 (number)"},{"name":"3*","type":"str","value":"lightEffect.hue2 (number)"},{"name":"4","type":"str","value":"lightEffect.sat1 (number)"},{"name":"5","type":"str","value":"lightEffect.sat2 (number)"}],"meta":{},"color":"#DDAA99"},{"id":"3846091448eb9a09","type":"subflow","name":"santÃ© calendrier process","info":"","category":"","in":[],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"e6ac576fb4598283","type":"subflow","name":"presence ?","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"659ed9ee25a47490"}]}],"out":[{"x":340,"y":40,"wires":[{"id":"659ed9ee25a47490","port":0}]},{"x":340,"y":120,"wires":[{"id":"659ed9ee25a47490","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ba09e97f2ed22f2b","type":"subflow","name":"send to mobile","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"ed8d55cbcd91d71a"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"dbf17bea6affd2ec","type":"subflow","name":"area speaker notif","category":"","in":[{"x":60,"y":60,"wires":[{"id":"9be1c461b95830f7"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"msg.speak || msg.sound || msg.link (string)"},{"name":"2","type":"str","value":"msg.linkedArea (string)"},{"name":"3","type":"str","value":"msg.volumeLevel (number)"}],"meta":{},"color":"#DDAA99"},{"id":"723d4991c3c87385","type":"subflow","name":"change entity state","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"955123ec73074cbf"}]}],"out":[],"env":[{"name":"1*","type":"str","value":"entity_id (string)"},{"name":"2*","type":"str","value":"state (string, number)"}],"meta":{},"color":"#DDAA99"},{"id":"ad3b29a5dd67898f","type":"subflow","name":"send bug to dashboard","info":"","category":"","in":[{"x":60,"y":40,"wires":[{"id":"f8ffcffdadd50488"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"6c4028aab794d52d","type":"subflow","name":"notification","info":"","category":"","in":[{"x":60,"y":120,"wires":[{"id":"321f2d38a11d9f17"}]}],"out":[{"x":940,"y":380,"wires":[{"id":"628251e2da9da6f5","port":0},{"id":"cc379f05a4f6474a","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"10a4bbabe046de0e","type":"subflow","name":"Lights ðŸ”’","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"6a3d5dea1ffbb2d8"}]}],"out":[{"x":280,"y":80,"wires":[{"id":"6a3d5dea1ffbb2d8","port":0}]}],"env":[{"name":"1*","type":"str","value":"msg.lock_lights (array)"},{"name":"2*","type":"str","value":"msg.lock (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"9b9bfdbe9a43dabb","type":"subflow","name":"ambiance","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"d95af1f39bdc2e43"},{"id":"2771cf6f6d945a3d"}]}],"out":[{"x":960,"y":120,"wires":[{"id":"27e428e0387cac8a","port":0}]},{"x":620,"y":240,"wires":[{"id":"c83520ded53399c4","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ea5b93cde6b1bf0a","type":"subflow","name":"get entities","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"43eb691e78e84db2"}]}],"out":[{"x":420,"y":60,"wires":[{"id":"8ad68d48c16b29ca","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"612068fa04cc8bbd","type":"subflow","name":"cube","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"188d4197be377390"},{"id":"22db9e147fb3f0bc"},{"id":"4d0457a2e27a298e"},{"id":"561d43ede593e22a"},{"id":"cd7d9f68a272e2bd"},{"id":"e0a08631094f3a1a"},{"id":"d47393f14d9d896b"}]}],"out":[{"x":960,"y":120,"wires":[{"id":"473feda77b747512","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"050c60654a910e68","type":"subflow","name":"waits until","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"1dee8c383dad1dc9"}]}],"out":[{"x":1340,"y":60,"wires":[{"id":"cbbaf5fe1d43c359","port":0}]}],"env":[{"name":"1*","type":"str","value":"waits (array)"},{"name":"2*","type":"str","value":"states (array)"},{"name":"3*","type":"str","value":"timeoutSeconds (number) seconds"},{"name":"4","type":"str","value":"sendOnTimeout (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"7166242293a03ec9","type":"subflow","name":"ambiances","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"f51dc77777d8f60b"}]}],"out":[{"x":800,"y":60,"wires":[{"id":"907c1f317e2ca3ee","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"515fe2385f553c95","type":"subflow","name":"dev enable","info":"","category":"","in":[{"x":80,"y":80,"wires":[{"id":"68969b8280827750"}]}],"out":[{"x":320,"y":40,"wires":[{"id":"68969b8280827750","port":0}]},{"x":320,"y":120,"wires":[{"id":"68969b8280827750","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"94b2243985840d69","type":"subflow","name":"config loaded","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"febc11290421c3af"}]}],"out":[{"x":420,"y":80,"wires":[{"id":"8fb791d85072ddee","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"3da7ebfd83a38899","type":"subflow","name":"get entities NEW","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"466e65d315aca28f"}]}],"out":[{"x":300,"y":60,"wires":[{"id":"466e65d315aca28f","port":0}]}],"env":[{"name":"1*","type":"str","value":"msg.search = { \"is\": { linkedClass: \"\" }, \"not\": { linkedArea: \"\" }}"},{"name":"2*","type":"str","value":"msg.output_name (string)"},{"name":"3","type":"str","value":"msg.outputEmptyResults (boolean)"}],"meta":{},"color":"#DDAA99"},{"id":"a9fcbb2aa70ea1f8","type":"junction","z":"9b9bfdbe9a43dabb","x":360,"y":180,"wires":[["52d03fb81f2ee80c"]]},{"id":"0cdd3aae865a31cf","type":"junction","z":"9b9bfdbe9a43dabb","x":360,"y":180,"wires":[["9e5c408e79ac1df8"]]},{"id":"4a0d1a73e7adcc11","type":"junction","z":"050c60654a910e68","x":740,"y":60,"wires":[["a71b128c6a11f16e","4095fa2ccd977940"]]},{"id":"5ff166ae2792d64c","type":"junction","z":"050c60654a910e68","x":280,"y":60,"wires":[["87d844bd45fccde6","1ac121c8d607267c","1d64b1cbe71c8c65","9c265cc1eaad53bb","69317bea361bf45e","9d50472878b093d6","ab3f5f1f4b645507","9147624e46fd3b8b","e6e0a2f4b0faf93f","af650c007ffa4b39"]]},{"id":"af3037a2c000ff8b","type":"junction","z":"ccf1abe540a3b5a9","x":380,"y":240,"wires":[["b1bee60d1fd3da40"]]},{"id":"68556bf00513cc3b","type":"junction","z":"ccf1abe540a3b5a9","x":260,"y":300,"wires":[["059646ead3d2a49f"]]},{"id":"4b1a090c5eac6d5d","type":"junction","z":"ccf1abe540a3b5a9","x":260,"y":360,"wires":[["39a04d72d1e9fc02"]]},{"id":"3ed9df714d540dff","type":"junction","z":"b0b353ce861d908b","x":540,"y":180,"wires":[["c0a033baef2e6d6d"]]},{"id":"e35423a2a82f9168","type":"junction","z":"ccf1abe540a3b5a9","x":200,"y":620,"wires":[["e904c7abdbd0b8c2"]]},{"id":"7dec798e895a6d15","type":"junction","z":"ccf1abe540a3b5a9","x":200,"y":620,"wires":[["793fa08398a6eb1b"]]},{"id":"0ad2fc52e05f884f","type":"junction","z":"b0b353ce861d908b","x":340,"y":780,"wires":[["85e70ba4e021ee27"]]},{"id":"6acfa8ca4b422c72","type":"junction","z":"b0b353ce861d908b","x":180,"y":480,"wires":[["2cf5a5d542aacb96","4a3b930cb95bbe93"]]},{"id":"74a232c0c54bfcd0","type":"junction","z":"ab914a2a493ebbf5","x":420,"y":180,"wires":[["f4c62d5c33445996"]]},{"id":"1734e70678e4e3fe","type":"junction","z":"050c60654a910e68","x":740,"y":600,"wires":[["a71b128c6a11f16e","263cb54347d897c3"]]},{"id":"ba726f260be33a59","type":"junction","z":"6838183963219fc9","x":1140,"y":320,"wires":[["41f642fb8e8c5b67"]]},{"id":"3f3fa09655239c17","type":"junction","z":"7cc0f49198f44c93","x":220,"y":240,"wires":[["85453006e9fb8796"]]},{"id":"a7fa1e89e29b2bc7","type":"junction","z":"6838183963219fc9","x":400,"y":320,"wires":[["fa233988bc49c813"]]},{"id":"d7d82dfd3230ef12","type":"junction","z":"eaa696a731a52b23","x":300,"y":180,"wires":[["6a2278252e8fa9b4","8e7912d6c84c4bdd"]]},{"id":"a80c33edb870c5b1","type":"junction","z":"a62a0ee8573c9b72","x":160,"y":540,"wires":[["c437e0a422479e97"]]},{"id":"e22beca65116ee37","type":"junction","z":"a1ed8ea56c7ba1f9","x":440,"y":320,"wires":[["dba11fcf0d14ada5","ebea586e913c75ec"]]},{"id":"5b871c278cf602d0","type":"junction","z":"6838183963219fc9","x":920,"y":180,"wires":[["9d1e5df180bb1596"]]},{"id":"b41a1eb9efd6146b","type":"junction","z":"6838183963219fc9","x":920,"y":180,"wires":[["a58c778bb22dbbf1"]]},{"id":"dc40d6ce64930b70","type":"junction","z":"22b4130fe1f6a28b","x":380,"y":180,"wires":[["19c209fee8b092e0"]]},{"id":"110bd61b5f805ce3","type":"junction","z":"22b4130fe1f6a28b","x":620,"y":300,"wires":[["73e582bba532abcd"]]},{"id":"fc448eba97609691","type":"junction","z":"ba09e97f2ed22f2b","x":480,"y":60,"wires":[["e08a8393f3cf6c44"]]},{"id":"8f9c279590a9a156","type":"junction","z":"1131f5463c30e69b","x":1120,"y":1260,"wires":[["7f2cec1b57f240b7"]]},{"id":"7b02eb3b9a7b888f","type":"junction","z":"1131f5463c30e69b","x":480,"y":900,"wires":[["27a69dac2b0e8f92"]]},{"id":"0467dac78e1139e0","type":"junction","z":"1131f5463c30e69b","x":840,"y":900,"wires":[["d4bd76d5ef491c1f"]]},{"id":"fd57a035593d6c66","type":"junction","z":"1131f5463c30e69b","x":460,"y":1140,"wires":[["e32c299462b85853"]]},{"id":"a11e962553e311dc","type":"junction","z":"1131f5463c30e69b","x":1120,"y":1860,"wires":[["53dfa425ed188586"]]},{"id":"3fc9805a98cfab15","type":"junction","z":"b0b353ce861d908b","x":220,"y":540,"wires":[["3d13f870ec70a3f3"]]},{"id":"9c0cce97e141ecbb","type":"junction","z":"b0b353ce861d908b","x":180,"y":600,"wires":[["23d8c2e514d46d60"]]},{"id":"3abd154e2798e85e","type":"junction","z":"1131f5463c30e69b","x":1120,"y":300,"wires":[["808562788b6f03e3"]]},{"id":"a56ef79faccc34c3","type":"junction","z":"1131f5463c30e69b","x":1120,"y":360,"wires":[["482038817b9e0cbb"]]},{"id":"5e18558ff10fb73b","type":"junction","z":"1131f5463c30e69b","x":1120,"y":480,"wires":[["f231ffba1f31bb29"]]},{"id":"76810ee208160bd5","type":"junction","z":"1131f5463c30e69b","x":1120,"y":540,"wires":[["2c0b3bb40e4d7109"]]},{"id":"54b44dc287bc9d66","type":"junction","z":"7cc0f49198f44c93","x":580,"y":180,"wires":[["1bec02e18f41cee3"]]},{"id":"c87720f17866318d","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":": ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"6dbf52fb74e0857d","type":"api-call-service","z":"45b866d1e8e0fc54","name":"stores off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.cover_chambre","input_boolean.cover_salon"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":360,"y":120,"wires":[[]]},{"id":"492d3827b1f374f5","type":"ha-wait-until","z":"45b866d1e8e0fc54","name":"wait fiesta off","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"input_boolean.fiesta","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"3","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":650,"y":120,"wires":[["c6a33b1ccb3eb6fc"],["c6a33b1ccb3eb6fc"]]},{"id":"7a18c237972bcf43","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":180,"wires":[["8bbee7aff9df337b"],["3328bb299530086c"],["736a0410bcd8ae28"]]},{"id":"c5e5dade2d8140b4","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":180,"wires":[["5dd95791799ca37b"]]},{"id":"45f3c97a1fca2055","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":180,"wires":[[]]},{"id":"736a0410bcd8ae28","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":180,"wires":[["85745f1699b5c18e"]]},{"id":"8bbee7aff9df337b","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"3328bb299530086c","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"51932102dd30e869","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":180,"wires":[["c5e5dade2d8140b4","7a18c237972bcf43"],[]]},{"id":"a83b97572d7d81f3","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":240,"wires":[["a0af6d11261c8245"],["0c7c59e3d8e89133"],["11ed8405127209f9"]]},{"id":"9c31e38fbb598b9a","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":240,"wires":[["22996ffd4a03399c"]]},{"id":"ebeb76171ceafd2c","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":240,"wires":[[]]},{"id":"11ed8405127209f9","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":240,"wires":[["dc43b5238775a1c7"]]},{"id":"a0af6d11261c8245","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"0c7c59e3d8e89133","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"7efe2fb84b3d3a4f","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":240,"wires":[["9c31e38fbb598b9a","a83b97572d7d81f3"],[]]},{"id":"9abb48c1a30a264f","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":300,"wires":[["ae562aa50f38b5c1"],["ca0da4b4f2a9f926"],["37946ec5a90342b0"]]},{"id":"e352f2f493e78666","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":300,"wires":[["ad517bdb76093d29"]]},{"id":"03765334b3c696a4","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":300,"wires":[[]]},{"id":"37946ec5a90342b0","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":300,"wires":[["18d209c95e946af2"]]},{"id":"ae562aa50f38b5c1","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"ca0da4b4f2a9f926","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"a6fd8d7d346e0c34","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":300,"wires":[["e352f2f493e78666","9abb48c1a30a264f"],[]]},{"id":"79c26f95e1cffa41","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":160,"y":420,"wires":[["dcc43a0ba67ca8f2"]]},{"id":"dcc43a0ba67ca8f2","type":"api-call-service","z":"45b866d1e8e0fc54","name":"fiesta off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.fiesta"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":300,"y":420,"wires":[[]]},{"id":"bee3e8cd6c6da8e3","type":"api-current-state","z":"45b866d1e8e0fc54","name":"stores status on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stores_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":190,"y":120,"wires":[["36a443ae8864fe22","6dbf52fb74e0857d"],["492d3827b1f374f5"]]},{"id":"36a443ae8864fe22","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":500,"y":120,"wires":[["492d3827b1f374f5","5dd95791799ca37b","22996ffd4a03399c","ad517bdb76093d29","eb7401127697b790"]]},{"id":"c6fbfce2784fd3bc","type":"api-call-service","z":"45b866d1e8e0fc54","name":"stores on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.cover_chambre","input_boolean.cover_salon"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1000,"y":120,"wires":[[]]},{"id":"c6a33b1ccb3eb6fc","type":"api-current-state","z":"45b866d1e8e0fc54","name":"stores status on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stores_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":830,"y":120,"wires":[["c6fbfce2784fd3bc"],[]]},{"id":"bec62ca95cc7c391","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":360,"wires":[["60038b3d5cff3f0a"],["c6e379682bf1b67c"],["69d2dddeafe9375e"]]},{"id":"e85165b20cb8f18a","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":460,"y":360,"wires":[["eb7401127697b790"]]},{"id":"4b39d9ca89a69090","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":360,"wires":[[]]},{"id":"69d2dddeafe9375e","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":360,"wires":[["06bc846f2668d898"]]},{"id":"60038b3d5cff3f0a","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"c6e379682bf1b67c","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"28f8e10fcd63a3c6","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":360,"wires":[["e85165b20cb8f18a","bec62ca95cc7c391"],[]]},{"id":"98ecd81521e7a75e","type":"api-call-service","z":"45b866d1e8e0fc54","name":"some autolights off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.light_ambilight","input_boolean.light_bandeau_cuisine","input_boolean.light_bureau","input_boolean.light_cuisine","input_boolean.light_deco"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":190,"y":60,"wires":[["908ae564e4806fdd"]]},{"id":"908ae564e4806fdd","type":"api-call-service","z":"45b866d1e8e0fc54","name":"some lights off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.light_salon","light.light_bandeau_cuisine"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":60,"wires":[["79c26f95e1cffa41","bee3e8cd6c6da8e3"]]},{"id":"18d209c95e946af2","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_bureau","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1290,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"06bc846f2668d898","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_cuisine","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1290,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"85745f1699b5c18e","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_deco","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1280,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"dc43b5238775a1c7","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_ambilight","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1300,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"5dd95791799ca37b","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":180,"wires":[["51932102dd30e869"]]},{"id":"22996ffd4a03399c","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":240,"wires":[["7efe2fb84b3d3a4f"]]},{"id":"ad517bdb76093d29","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":300,"wires":[["a6fd8d7d346e0c34"]]},{"id":"eb7401127697b790","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["28f8e10fcd63a3c6"]]},{"id":"c5ccf59387c5ac3b","type":"function","z":"d193bde43bd55f9f","name":"prepare remote","func":"let linkedDevice = msg.linkedDevice;\nlet entity_id = msg.entity_id;\nlet state = msg.new_state;\nlet remote = msg.remote;\nlet msgs = [];\n\nif (typeof remote == \"object\") {\n    if (\"increase\" in remote && \"decrease\" in remote) {\n        let diff = msg.new_state - msg.old_state;\n        setStateMsgs([Math.abs(diff), (diff < 0 ? remote[\"decrease\"] : remote[\"increase\"])]);\n        return [msgs, null];\n    } else if (\"on\" in remote && \"off\" in remote) {\n        setStateMsgs(remote[state].replaceAll(\" \", \"\").split(\",\"));\n        return [msgs, null];\n    }\n} else if (typeof remote == \"string\" && state == \"on\") {\n    setStateMsgs(remote.replaceAll(\" \", \"\").split(\",\"));\n    msg.state = \"off\";\n    return [msgs, msg];\n}\n\nfunction setStateMsgs(split) {\n    let loop = parseInt(split[0]);\n    let command = split[1];\n    for (let i = 0; i < loop; i++) {\n        msgs.push({\n            payload: {\n                data: {\n                    entity_id: linkedDevice,\n                    command: command\n                }\n            }\n        });\n    }\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":100,"wires":[["5ad58a2422355551"],["242576b45e519b85"]]},{"id":"7668c6d3666d5662","type":"api-call-service","z":"d193bde43bd55f9f","name":"send command to remote","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"remote","service":"send_command","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":550,"y":60,"wires":[[]]},{"id":"5ad58a2422355551","type":"delay","z":"d193bde43bd55f9f","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"2","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":350,"y":60,"wires":[["7668c6d3666d5662"]]},{"id":"242576b45e519b85","type":"subflow:723d4991c3c87385","z":"d193bde43bd55f9f","name":"","x":370,"y":140,"wires":[]},{"id":"4c9393d44c603ea8","type":"function","z":"386f1888bc94b4c8","name":"motivation","func":"switch (msg.payload) {\n  case 1:\n    msg.payload = \"Personne nâ€™est trop vieux pour se fixer un nouvel objectif ou rÃ©aliser de nouveaux rÃªves. â€“ Les Brown\";\n    break;\n  case 2:\n    msg.payload = \"La seule faÃ§on de faire du bon travail est dâ€™aimer ce que vous faites. Si vous nâ€™avez pas encore trouvÃ©, continuez Ã  chercher. - Steve Jobs\";\n    break;\n  case 3:\n    msg.payload = \"Pour rÃ©ussir, votre dÃ©sir de rÃ©ussite doit Ãªtre plus grand que votre peur de lâ€™Ã©chec. - Bill Cosby\";\n    break;\n  case 4:\n    msg.payload = \"Un Ã©norme succÃ¨s est la meilleure des vengeances. - Frank Sinatra\";\n    break;\n  case 5:\n    msg.payload = \"Je suis reconnaissant Ã  tous ceux qui mâ€™ont dit NON. Câ€™est Ã  grÃ¢ce Ã  eux que je suis moi-mÃªme. - Albert Einstein\";\n    break;\n  case 6:\n    msg.payload = \"La seule chose qui se dresse entre vous et votre rÃªve, câ€™est la volontÃ© dâ€™essayer et la conviction quâ€™il est rÃ©ellement possible. - Joel Brown\";\n    break;\n  case 7:\n    msg.payload = \"Un pessimiste voit la difficultÃ© dans chaque opportunitÃ©, un optimiste voit lâ€™opportunitÃ© dans chaque difficultÃ©. - Winston Churchill\";\n    break;\n  case 8:\n    msg.payload = \"Le succÃ¨s câ€™est dâ€™aller dâ€™Ã©chec en Ã©chec sans perdre son enthousiasme. - Winston Churchill\";\n    break;\n  case 9:\n    msg.payload = \"Le succÃ¨s nâ€™est pas la clÃ© du bonheur. Le bonheur est la clÃ© du succÃ¨s. Si vous aimez ce que vous faites, vous rÃ©ussirez. - Albert Schweitzer\";\n    break;\n  case 10:\n    msg.payload = \"Les gagnants trouvent des moyens, les perdants des excuses. -  F. D. Roosevelt\";\n    break;\n  case 11:\n    msg.payload = \"Celui qui attend que tout danger soir Ã©cartÃ© pour mettre les voiles ne prendra jamais la mer. - Thomas Fuller\";\n    break;\n  case 12:\n    msg.payload = \"Ce nâ€™est pas parce que les choses sont difficiles que nous nâ€™osons pas, câ€™est parce que nous nâ€™osons pas quâ€™elles sont difficiles. -  SÃ©nÃ¨que\";\n    break;\n  case 13:\n    msg.payload = \"Certains veulent que Ã§a arrive, dâ€™autres aimeraient que Ã§a arrive et dâ€™autres font que Ã§a arrive. - Michael Jordan\";\n    break;\n  case 14:\n    msg.payload = \"La plus grande erreur que puisse faire un homme est dâ€™avoir peur dâ€™en faire une. - Elbert Hubbard\";\n    break;\n  case 15:\n    msg.payload = \"Le gÃ©nie est fait dâ€™un pour cent dâ€™inspiration et de quatre-vingt-dix-neuf pour cent de transpiration. - Thomas Edison\";\n    break;\n  case 16:\n    msg.payload = \"Ce nâ€™est pas le vent qui dÃŒ cide de votre destination, câ€™est lâ€™orientation que vous donnez Ã  votre voile. Le vent est pareil pour tous. - Jim Rohn\";\n    break;\n  case 17:\n    msg.payload = \"Lâ€™humanitÃ© se divise en trois catÃ©gories : ceux qui ne peuvent pas bouger, ceux qui peuvent bouger, et ceux qui bougent. - Benjamin Franklin\";\n    break;\n  case 18:\n    msg.payload = \"Dans vingt ans vous serez plus dÃ©Ã§us par les choses que vous nâ€™avez pas faites que par celles que vous avez faites. Alors sortez des sentiers battus. Mettez les voiles. Explorez. RÃªvez. DÃ©couvrez. - Mark Twain\";\n    break;\n  case 19:\n    msg.payload = \"Il nâ€™y a pas de rÃ©ussites faciles ni dâ€™Ã©checs dÃ©finitifs. - Marcel Proust\";\n    break;\n  case 20:\n    msg.payload = \"Jâ€™ai dÃ©cidÃ© dâ€™Ãªtre heureux parce que câ€™est bon pour la santÃ©. - Voltaire\";\n    break;\n  case 21:\n    msg.payload = \"Celui qui veut atteindre un objectif lointain doit faire de petits pas. - Saul Bellow\";\n    break;\n  case 22:\n    msg.payload = \"La plupart des choses importantes dans le monde ont Ã©tÃ© accomplies par des personnes qui ont continuÃ© Ã  essayer quand il semblait y avoir aucun espoir. - Dale Carnegie\";\n    break;\n  case 23:\n    msg.payload = \"Pour rÃ©ussir, retenez bien ces trois maximes: voir câ€™est savoir, vouloir câ€™est pouvoir, oser câ€™est avoir. - Alfred de Musset\";\n    break;\n  case 24:\n    msg.payload = \"Les chanceux sont ceux qui arrivent Ã  tout ; Les malchanceux, ceux Ã  qui tout arrive. - EugÃ¨ne Labiche\";\n    break;\n  case 25:\n    msg.payload = \"Pour ce qui est de lâ€™avenir, il ne sâ€™agit pas de le prÃ©voir, mais de le rendre possible. - Antoine de Saint-ExupÃ©ry\";\n    break;\n  case 26:\n\tmsg.payload = \"Il faut viser la lune, parce quâ€™au moins, si vous Ã©chouez, vous finirez dans les Ã©toiles. - Oscar Wilde\";\n\tbreak;\n  case 27:\n\tmsg.payload = \"La meilleure faÃ§on de prÃ©dire lâ€™avenir est de le crÃ©er. - Peter Drucker\";\n\tbreak;\n  case 28:\n\tmsg.payload = \"Le dÃ©sir de bien faire est un puissant moteur. Celui de faire du bien est plus puissant encore. - Michael Aguilar\";\n\tbreak;\n  case 29:\n\tmsg.payload = \"Croyez en vos rÃªves et ils se rÃ©aliseront peut-Ãªtre. Croyez en vous et ils se rÃ©aliseront sÃ»rement. - Martin Luther King\";\n\tbreak;\n  case 30:\n\tmsg.payload = \"Vous ne trouverez jamais ce que vous ne cherchez pas. - Confucius\";\n\tbreak;\n  case 31:\n\tmsg.payload = \"Si vous pensez que vous ne valez pas grand-chose, vous ne trouverez personne pour augmenter votre prix. - Michael Aguilar\";\n\tbreak;\n  case 32:\n\tmsg.payload = \"La sagesse suprÃªme, câ€™est dâ€™avoir des rÃªves assez grands pour ne pas les perdre de vue pendant quâ€™on les poursuit. - Francis Scott Fitzgerald\";\n\tbreak;\n  case 33:\n\tmsg.payload = \"Si vous pouvez le rÃªver, vous pouvez le faire. - Walt Disney\";\n\tbreak;\n  case 34:\n\tmsg.payload = \"Notre vie vaut ce quâ€™elle nous a coÃ»tÃ© dâ€™efforts. - FranÃ§ois Mauriac\";\n\tbreak;\n  case 35:\n\tmsg.payload = \"Ce sont nos choix qui montrent qui nous sommes, bien  plus que nos capacitÃ©s. - Joanne K.Rowling\";\n\tbreak;\n  case 36:\n\tmsg.payload = \"On peut tout ce qui ne dÃ©pende que de notre volontÃ©. - Marcel Proust\";\n\tbreak;\n  case 37:\n\tmsg.payload = \"Le but de la vie, ce nâ€™est pas lâ€™espoir de devenir parfait, câ€™est la volontÃ© dâ€™Ãªtre toujours meilleur. - Ralph Waldo Emerson\";\n\tbreak;\n  case 38:\n\tmsg.payload = \"La persÃ©vÃ©rance, câ€™est ce qui rend lâ€™impossible possible, le possible probable et le probable rÃ©alisÃŒ . - LÃ©on Trotsky\";\n\tbreak;\n  case 39:\n\tmsg.payload = \"Il nâ€™y a quâ€™une faÃ§on dâ€™Ã©chouer, câ€™est dâ€™abandonner avant dâ€™avoir rÃ©ussi. - Georges ClÃ©menceau\";\n\tbreak;\n  case 40:\n\tmsg.payload = \"Rien de grand ne sâ€™est accompli sans passion. - Hegel\";\n\tbreak;\n  case 41:\n\tmsg.payload = \"Ne craignez pas la perfection, vous nâ€™y parviendrez jamais. - Salvador Dali\";\n\tbreak;\n  case 42:\n\tmsg.payload = \"Il vaut mieux exceller dans une seule discipline plutÃ´t que dâ€™Ãªtre mÃ©diocre dans plusieurs. - Proverbe latin\";\n\tbreak;\n  case 43:\n\tmsg.payload = \"En suivant le chemin qui sâ€™appelle plus tard, nous arrivons sur la place qui sâ€™appelle jamais. - SÃ©nÃ·  que\";\n\tbreak;\n  case 44:\n\tmsg.payload = \"La vie est comme une bicyclette, il faut avancer pour ne pas perdre lâ€™Ã©quilibre. - Albert Einstein\";\n\tbreak;\n  case 45:\n\tmsg.payload = \"Les portes de lâ€™avenir sont ouvertes Ã  ceux qui savent les pousser. - Coluche\";\n\tbreak;\n  case 46:\n\tmsg.payload = \"Le monde nâ€™a progressÃ© que grÃ¢ce aux choses impossibles qui ont Ã©tÃ© rÃ©alisÃ©es. - AndrÃ© Maurois\";\n\tbreak;\n  case 47:\n\tmsg.payload = \"Les obstacles sont ces choses effrayantes que vous apercevez lorsque vous dÃ©tournez les yeux de vos objectifs. - Henry Ford\";\n\tbreak;\n  case 48:\n\tmsg.payload = \"Pour pouvoir contempler un arc-en-ciel, il faut dâ€™abord endurer la pluie. - Proverbe chinois\";\n\tbreak;\n  case 49:\n\tmsg.payload = \"Commencez par changer en vous ce que vous voulez changer autour de vous. - Gandhi\";\n\tbreak;\n  case 50:\n\tmsg.payload = \"La folie, câ€™est de refaire la mÃªme chose et dâ€™en attendre un rÃ©sultat diffÃ©rent. - Albert Einstein\";\n\tbreak;\n  case 51:\n\tmsg.payload = \"Agissez toujours comme sâ€™il Ã©tait impossible dâ€™Ã©chouer. - Winston Churchill\";\n\tbreak;\n  case 52:\n\tmsg.payload = \"Il est difficile dâ€™Ã©chouer. Mais il est encore plus difficile de ne pas avoir essayÃ© de rÃ©ussir. - ThÃ©odore Roosevelt\";\n\tbreak;\n  case 53:\n\tmsg.payload = \"Se lamenter sur un malheur passÃ©, voilÃ  le plus sÃ»r moyen dâ€™en attirer un autre. - William Shakespeare\";\n\tbreak;\n  case 54:\n\tmsg.payload = \"Lâ€™Ã©chec nâ€™est quâ€™une opportunitÃ© pour recommencer la mÃªme chose plus intelligemment. - Henry Ford\";\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":60,"wires":[[]]},{"id":"c4c0894d444403e2","type":"random","z":"386f1888bc94b4c8","name":"random","low":"1","high":"54","inte":"true","property":"payload","x":160,"y":60,"wires":[["4c9393d44c603ea8"]]},{"id":"40ddb0cd55b355c4","type":"api-call-service","z":"5a05b9ac0289ff03","name":"light on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":300,"y":120,"wires":[["60030f42d4978295"]]},{"id":"60030f42d4978295","type":"api-call-service","z":"5a05b9ac0289ff03","name":"pulse","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"yeelight","service":"start_flow","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"count\":{{count}},\"transitions\":[{\"HSVTransition\":[{{hue1}},{{sat1}},600,1]},{\"HSVTransition\":[{{hue2}},{{sat2}},400,100]}]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":430,"y":120,"wires":[["2009d28b780871aa"]]},{"id":"2009d28b780871aa","type":"delay","z":"5a05b9ac0289ff03","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":560,"y":120,"wires":[["900e0cf7e7d0f75f"]]},{"id":"900e0cf7e7d0f75f","type":"api-call-service","z":"5a05b9ac0289ff03","name":"turn off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_{{current_state}}","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":120,"wires":[[]]},{"id":"8aea172410df69a3","type":"link out","z":"5a05b9ac0289ff03","name":"link out 495","mode":"link","links":["cb8ca4d8a9cc6dea"],"x":875,"y":60,"wires":[]},{"id":"cb8ca4d8a9cc6dea","type":"link in","z":"5a05b9ac0289ff03","name":"link in 465","links":["8aea172410df69a3"],"x":65,"y":120,"wires":[["9a9e7eba6abacb57"]]},{"id":"a538488abfbc0b01","type":"function","z":"5a05b9ac0289ff03","name":"area lights >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"light\",\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedArea\",\n        logic: \"is\",\n        value: msg.linkedArea,\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is_not\",\n        value: \"unavailable\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"lights\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":60,"wires":[["b4c54b38157aa11f"]]},{"id":"b4c54b38157aa11f","type":"subflow:ea5b93cde6b1bf0a","z":"5a05b9ac0289ff03","name":"","x":815,"y":60,"wires":[["8aea172410df69a3"]],"l":false},{"id":"7c64a1a9d3b6b65d","type":"subflow:e6ac576fb4598283","z":"5a05b9ac0289ff03","name":"","x":170,"y":60,"wires":[["499a8d0ba8c7d0f6"],[]]},{"id":"9a9e7eba6abacb57","type":"function","z":"5a05b9ac0289ff03","name":"set lights","func":"var lights = msg.lights;\nvar msgs = [];\n\nfor (let light of lights) {\n    let modes = \"supported_color_modes\" in light.attributes && Array.isArray(light.attributes.supported_color_modes) ? light.attributes.supported_color_modes : [];\n    if (modes.some(mode => mode == \"hs\")) {\n        msgs.push({\n            light: light.entity_id,\n            current_state: light.state,\n            count: msg.lightEffect.count,\n            hue1: msg.lightEffect.hue1,\n            hue2: msg.lightEffect.hue2,\n            sat1: \"sat1\" in msg.lightEffect ? msg.lightEffect.sat1 : 100,\n            sat2: \"sat2\" in msg.lightEffect ? msg.lightEffect.sat2 : 100,\n            delay: msg.lightEffect.count * 1000\n        });\n    }\n}\n\nreturn [msgs];\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":120,"wires":[["40ddb0cd55b355c4"]]},{"id":"6a1d9afcde9acf83","type":"function","z":"5a05b9ac0289ff03","name":"lightEffect ?","func":"let isLightEffect = \"lightEffect\" in msg && typeof msg.lightEffect == \"object\"\n    && \"count\" in msg.lightEffect && typeof msg.lightEffect.count == \"number\"\n    && \"hue1\" in msg.lightEffect && typeof msg.lightEffect.hue1 == \"number\"\n    && \"hue2\" in msg.lightEffect && typeof msg.lightEffect.hue2 == \"number\";\n\nif (isLightEffect) {\n    let area_motions = global.get(\"area_motions\") || {};\n    let msgs = [];\n\n    Object.entries(area_motions).forEach(([key, value]) => {\n        if (value != \"off\") {\n            msgs.push({ linkedArea: key, lightEffect: msg.lightEffect });\n        }\n    });\n\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":60,"wires":[["a538488abfbc0b01"]]},{"id":"499a8d0ba8c7d0f6","type":"api-current-state","z":"5a05b9ac0289ff03","name":"speaker day mode ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.speaker_day_night_mode","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":360,"y":60,"wires":[["6a1d9afcde9acf83"],[]]},{"id":"21c3876a5ffadcba","type":"function","z":"3846091448eb9a09","name":"fitness today","func":"msg.payload = \"fitness\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1010,"y":180,"wires":[[]]},{"id":"d4e428fe90d9434b","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":260,"y":120,"wires":[["dbef126f17678db4"],[]]},{"id":"a4ad1a83c2e750a7","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":280,"y":180,"wires":[["d3dff07a07a856c0"],[]]},{"id":"d3dff07a07a856c0","type":"api-current-state","z":"3846091448eb9a09","name":"fitness on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fitness","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":450,"y":180,"wires":[["0dbe0b3b1ee01ea8"],[]]},{"id":"0dbe0b3b1ee01ea8","type":"api-current-state","z":"3846091448eb9a09","name":"fitness %","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.fitness_chance","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"fitness_chance","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":600,"y":180,"wires":[["d5b8614813377f46"]]},{"id":"13b871eff379f1ee","type":"switch","z":"3846091448eb9a09","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"lte","v":"fitness_chance","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":180,"wires":[[],["21c3876a5ffadcba"]]},{"id":"d5b8614813377f46","type":"random","z":"3846091448eb9a09","name":"random","low":"0","high":"100","inte":"true","property":"payload","x":740,"y":180,"wires":[["13b871eff379f1ee"]]},{"id":"bf8f0796ab780d5f","type":"switch","z":"3846091448eb9a09","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"lte","v":"run_chance","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":120,"wires":[[],["73ac5c7c899c2801"]]},{"id":"07faea239a39261c","type":"random","z":"3846091448eb9a09","name":"random","low":"0","high":"100","inte":"true","property":"payload","x":680,"y":120,"wires":[["bf8f0796ab780d5f"]]},{"id":"73ac5c7c899c2801","type":"function","z":"3846091448eb9a09","name":"run today","func":"msg.payload = \"run\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":120,"wires":[[]]},{"id":"ef4645fb95957b02","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":260,"y":60,"wires":[["7553058f60f98d03"],[]]},{"id":"7553058f60f98d03","type":"api-current-state","z":"3846091448eb9a09","name":"walk on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.walk","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":420,"y":60,"wires":[["b690b298966cd658"],[]]},{"id":"b690b298966cd658","type":"api-current-state","z":"3846091448eb9a09","name":"walk %","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.walk_chance","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"walk_chance","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":560,"y":60,"wires":[["d0fe52999302aaa3"]]},{"id":"d0fe52999302aaa3","type":"random","z":"3846091448eb9a09","name":"random","low":"0","high":"100","inte":"true","property":"payload","x":700,"y":60,"wires":[["d916b632eeb303d2"]]},{"id":"d916b632eeb303d2","type":"switch","z":"3846091448eb9a09","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"lte","v":"walk_chance","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":830,"y":60,"wires":[[],["15d61d614c3efc74"]]},{"id":"15d61d614c3efc74","type":"function","z":"3846091448eb9a09","name":"walk today","func":"msg.payload = \"walk\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":60,"wires":[[]]},{"id":"dbef126f17678db4","type":"api-current-state","z":"3846091448eb9a09","name":"run on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.run","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":420,"y":120,"wires":[["1e708d0d6de0804d"],[]]},{"id":"1e708d0d6de0804d","type":"api-current-state","z":"3846091448eb9a09","name":"run %","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.run_chance","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"run_chance","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":550,"y":120,"wires":[["07faea239a39261c"]]},{"id":"c00b980c627ebde7","type":"function","z":"3846091448eb9a09","name":"mesure today","func":"msg.payload = \"mesure\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":300,"wires":[[]]},{"id":"6604a7be26d0b12b","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":280,"y":300,"wires":[["c00b980c627ebde7"],[]]},{"id":"6e673aeedf0d91f2","type":"function","z":"3846091448eb9a09","name":"stretching today","func":"msg.payload = \"stretching\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1080,"y":240,"wires":[[]]},{"id":"9e12df11d86c781c","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":300,"y":240,"wires":[["3eadaf5dd2eb5e47"],[]]},{"id":"3eadaf5dd2eb5e47","type":"api-current-state","z":"3846091448eb9a09","name":"stretching on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stretching","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":480,"y":240,"wires":[["4b2bbbb97b3590ea"],[]]},{"id":"4b2bbbb97b3590ea","type":"api-current-state","z":"3846091448eb9a09","name":"stretching %","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.stretching_chance","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"stretching_chance","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":650,"y":240,"wires":[["22cb4249e162d154"]]},{"id":"9f856953b9cf6ab8","type":"switch","z":"3846091448eb9a09","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"lte","v":"stretching_chance","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":930,"y":240,"wires":[[],["6e673aeedf0d91f2"]]},{"id":"22cb4249e162d154","type":"random","z":"3846091448eb9a09","name":"random","low":"0","high":"100","inte":"true","property":"payload","x":800,"y":240,"wires":[["9f856953b9cf6ab8"]]},{"id":"f3d1ff0829cd2ad1","type":"function","z":"3846091448eb9a09","name":"reset activities of the day","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\n\nactivities[\"walk\"][2] = false;\nactivities[\"run\"][2] = false;\nactivities[\"fitness\"][2] = false;\nactivities[\"stretching\"][2] = false;\nactivities[\"mesure\"][2] = false;\n\nmsg.payload = { \"data\": { \"value\": JSON.stringify(activities) } };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":560,"wires":[["6ad328ec2b20edcd"]]},{"id":"9cd66b2de9e90ccd","type":"complete","z":"3846091448eb9a09","name":"> get activities for today","scope":["21c3876a5ffadcba","73ac5c7c899c2801","15d61d614c3efc74","c00b980c627ebde7","6e673aeedf0d91f2"],"uncaught":false,"x":140,"y":400,"wires":[["3b6294d24561cb76"]]},{"id":"3b6294d24561cb76","type":"delay","z":"3846091448eb9a09","name":"","pauseType":"rate","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":330,"y":400,"wires":[["652226982ca7f748"]]},{"id":"652226982ca7f748","type":"function","z":"3846091448eb9a09","name":"set activities for today","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\n\nactivities[msg.payload][1]++;\nactivities[msg.payload][2] = true;\n\nmsg.payload = { \"data\": { \"value\": JSON.stringify(activities) } };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":400,"wires":[["d980c0d2ce11599a","cf867b4c7b9f2f3a"]]},{"id":"d980c0d2ce11599a","type":"trigger","z":"3846091448eb9a09","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"5","extend":true,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":700,"y":400,"wires":[["37f67ac50fb1ebc6"]]},{"id":"37f67ac50fb1ebc6","type":"function","z":"3846091448eb9a09","name":"set no walk when run","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\n\nif (activities[\"run\"][2] && activities[\"walk\"][2]) {\n    activities[\"walk\"][1]--;\n    activities[\"walk\"][2] = false;\n    \n    msg.payload = { \"data\": { \"value\": JSON.stringify(activities) } };\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":400,"wires":[["cf867b4c7b9f2f3a"]]},{"id":"cf867b4c7b9f2f3a","type":"api-call-service","z":"3846091448eb9a09","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1070,"y":400,"wires":[[]]},{"id":"6ad328ec2b20edcd","type":"api-call-service","z":"3846091448eb9a09","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":770,"y":560,"wires":[[]]},{"id":"8823f25778895e6b","type":"function","z":"3846091448eb9a09","name":"week report message","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\n\nlet totalUp = parseInt(activities[\"walk\"][0]) + parseInt(activities[\"run\"][0]) + parseInt(activities[\"fitness\"][0]) +parseInt(activities[\"stretching\"][0]) +parseInt(activities[\"mesure\"][0]);\nlet totalDo = parseInt(activities[\"walk\"][1]) + parseInt(activities[\"run\"][1]) + parseInt(activities[\"fitness\"][1]) +parseInt(activities[\"stretching\"][1]) +parseInt(activities[\"mesure\"][1]);\nlet percent = totalDo !== 0 ? parseInt(100*totalUp/totalDo) : 0;\n\nmsg.notification_id = \"resetSportWeek\";\nmsg.title = \"Sport et SantÃ© : RÃ©capitulatif de la semaine\";\nmsg.message = 'Objectifs santÃ© de la semaine: ' + percent + '% atteints ' + (percent === 100 ? 'ðŸŽŠðŸŽ‰' : '');\nmsg.alertType = \"info\";\nmsg.data = {};\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":620,"wires":[["885ad3139a71bea4","c72aaf234d681b62"]]},{"id":"885ad3139a71bea4","type":"function","z":"3846091448eb9a09","name":"","func":"msg.payload = { \"data\": { \"value\": JSON.stringify({ walk: [0, 0, false], run: [0, 0, false], fitness: [0, 0, false], stretching: [0, 0, false], mesure: [0, 0, false] }) } };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":620,"wires":[["e6637470dac740dd"]]},{"id":"e6637470dac740dd","type":"api-call-service","z":"3846091448eb9a09","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":890,"y":620,"wires":[[]]},{"id":"46c9a205f6b67401","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":360,"y":620,"wires":[["8823f25778895e6b"],[]]},{"id":"477c3d00ac985b04","type":"inject","z":"3846091448eb9a09","name":"walk","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 1,3,5","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":110,"y":60,"wires":[["ef4645fb95957b02"]]},{"id":"82d2a1259cd2e1df","type":"inject","z":"3846091448eb9a09","name":"run","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 1,3,5","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":110,"y":120,"wires":[["d4e428fe90d9434b"]]},{"id":"2a60ebdbf6ae66bd","type":"inject","z":"3846091448eb9a09","name":"fitness","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 2,4,6","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":120,"y":180,"wires":[["a4ad1a83c2e750a7"]]},{"id":"77e9feb5dce9a597","type":"inject","z":"3846091448eb9a09","name":"stretching","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 1,2,3,4,5,6","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":130,"y":240,"wires":[["9e12df11d86c781c"]]},{"id":"db6318cc99f48d3c","type":"inject","z":"3846091448eb9a09","name":"mesure","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 1","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":120,"y":300,"wires":[["6604a7be26d0b12b"]]},{"id":"1f8e8267cb4c107b","type":"inject","z":"3846091448eb9a09","name":"reset day motivation","props":[{"p":"payload"}],"repeat":"","crontab":"30 04 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":160,"y":560,"wires":[["75e221e46319f11a"]]},{"id":"5a0470944ca13eb5","type":"inject","z":"3846091448eb9a09","name":"reset week motivation","props":[{"p":"payload"}],"repeat":"","crontab":"00 22 * * 0","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":160,"y":620,"wires":[["46c9a205f6b67401"]]},{"id":"a115f9eacd8cc96f","type":"api-current-state","z":"3846091448eb9a09","name":"motivation_increment on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation_increment","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":580,"y":680,"wires":[["7e1241d0ddcf74cd"],[]]},{"id":"02f371c8856e0e56","type":"api-call-service","z":"3846091448eb9a09","name":"walk_chance+1","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"increment","areaId":[],"deviceId":[],"entityId":["input_number.walk_chance"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":740,"wires":[[]]},{"id":"eba861b1a932743d","type":"inject","z":"3846091448eb9a09","name":"increment motivation","props":[{"p":"payload"}],"repeat":"","crontab":"30 04 * * 1,2,3,4,5,6","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":160,"y":680,"wires":[["0eb0be7f3ed455fe"]]},{"id":"2d632f571cafe360","type":"api-call-service","z":"3846091448eb9a09","name":"run_chance+1","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"increment","areaId":[],"deviceId":[],"entityId":["input_number.run_chance"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":720,"y":740,"wires":[[]]},{"id":"d202f805ee5e20cc","type":"api-call-service","z":"3846091448eb9a09","name":"fitness_chance+1","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"increment","areaId":[],"deviceId":[],"entityId":["input_number.fitness_chance"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":830,"y":800,"wires":[[]]},{"id":"6207953840ddd842","type":"api-call-service","z":"3846091448eb9a09","name":"stretching_chance+1","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"increment","areaId":[],"deviceId":[],"entityId":["input_number.stretching_chance"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":400,"y":800,"wires":[[]]},{"id":"fdcb59da1549b4d3","type":"server-state-changed","z":"3846091448eb9a09","name":"motivation_reset","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.motivation_reset","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":460,"wires":[["4d7dfd92a56d6b30"],[]]},{"id":"6013e91ce887b3f3","type":"api-call-service","z":"3846091448eb9a09","name":"motivation_reset off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_reset"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1130,"y":460,"wires":[[]]},{"id":"4d7dfd92a56d6b30","type":"api-call-service","z":"3846091448eb9a09","name":"walk_chance 25%","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.walk_chance"],"data":"{\"value\":\"25\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":310,"y":460,"wires":[["65675f3ffe7414d8"]]},{"id":"65675f3ffe7414d8","type":"api-call-service","z":"3846091448eb9a09","name":"run_chance 0%","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.run_chance"],"data":"{\"value\":\"0\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":500,"y":460,"wires":[["b951dd0311d6eddf"]]},{"id":"b951dd0311d6eddf","type":"api-call-service","z":"3846091448eb9a09","name":"fitness_chance 8%","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.fitness_chance"],"data":"{\"value\":\"8\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":460,"wires":[["c838f7b3b4145325"]]},{"id":"1f01db3b11f606bd","type":"api-current-state","z":"3846091448eb9a09","name":"walk on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.walk","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":180,"y":740,"wires":[["02f371c8856e0e56"],[]]},{"id":"61f6287df8b8366c","type":"api-current-state","z":"3846091448eb9a09","name":"run on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.run","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":560,"y":740,"wires":[["2d632f571cafe360"],[]]},{"id":"1ce6220879dc5122","type":"api-current-state","z":"3846091448eb9a09","name":"fitness on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fitness","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":650,"y":800,"wires":[["d202f805ee5e20cc"],[]]},{"id":"5474ea3036791970","type":"api-current-state","z":"3846091448eb9a09","name":"stretching on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stretching","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":200,"y":800,"wires":[["6207953840ddd842"],[]]},{"id":"c838f7b3b4145325","type":"api-call-service","z":"3846091448eb9a09","name":"stretching_chance 50%","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.stretching_chance"],"data":"{\"value\":\"50\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":910,"y":460,"wires":[["6013e91ce887b3f3"]]},{"id":"0eb0be7f3ed455fe","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":360,"y":680,"wires":[["a115f9eacd8cc96f"],[]]},{"id":"c72aaf234d681b62","type":"subflow:6c4028aab794d52d","z":"3846091448eb9a09","name":"","x":1050,"y":620,"wires":[[]]},{"id":"7e1241d0ddcf74cd","type":"link out","z":"3846091448eb9a09","name":"link out 242","mode":"link","links":["c22656a177f5d650","5849b6f7b534bec7","7860fa90d977c319","e808cb12042a366c"],"x":735,"y":680,"wires":[]},{"id":"c22656a177f5d650","type":"link in","z":"3846091448eb9a09","name":"link in 240","links":["7e1241d0ddcf74cd"],"x":85,"y":740,"wires":[["1f01db3b11f606bd"]]},{"id":"5849b6f7b534bec7","type":"link in","z":"3846091448eb9a09","name":"link in 241","links":["7e1241d0ddcf74cd"],"x":465,"y":740,"wires":[["61f6287df8b8366c"]]},{"id":"7860fa90d977c319","type":"link in","z":"3846091448eb9a09","name":"link in 242","links":["7e1241d0ddcf74cd"],"x":85,"y":800,"wires":[["5474ea3036791970"]]},{"id":"e808cb12042a366c","type":"link in","z":"3846091448eb9a09","name":"link in 243","links":["7e1241d0ddcf74cd"],"x":545,"y":800,"wires":[["1ce6220879dc5122"]]},{"id":"75e221e46319f11a","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":360,"y":560,"wires":[["f3d1ff0829cd2ad1"],[]]},{"id":"659ed9ee25a47490","type":"api-current-state","z":"e6ac576fb4598283","name":"in_home_zone ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.in_home_zone","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":190,"y":80,"wires":[[],[]]},{"id":"138422f99c4bd921","type":"api-call-service","z":"ba09e97f2ed22f2b","name":"send to mobile","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"notify","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"all","x":1140,"y":60,"wires":[[]]},{"id":"bac0f6cb65e6ea92","type":"function","z":"ba09e97f2ed22f2b","name":"mobileNotifications ?","func":"let msgs = [];\n\nfor (let person of msg.persons) {\n    if (\"mobileNotifications\" in person && person.mobileNotifications != \"\") {\n        let mess = {\n            service: person.mobileNotifications,\n            payload: {\n                data: {\n                    title: \"title\" in msg ? msg.title : \"\",\n                    message: \"message\" in msg ? msg.message : \"\"\n                }\n            }\n        };\n        if (\"data\" in msg) {\n            mess.payload.data[\"data\"] = msg.data;\n        } else {\n            mess.payload.data[\"data\"] = { actions: [{ \"action\": msg.notification_id, \"title\": \"Ignorer\" }] };\n        }\n        msgs.push(mess);\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":60,"wires":[["138422f99c4bd921"]]},{"id":"e08a8393f3cf6c44","type":"function","z":"ba09e97f2ed22f2b","name":"persons >","func":"if (\"sendMobile\" in msg && msg.sendMobile) {\n    let config = {};\n\n    config.rules = [\n        {\n            property: \"attributes.config.linkedClass\",\n            logic: \"is\",\n            value: \"person\",\n            valueType: \"str\"\n        }\n    ];\n\n    config.outputType = \"array\";\n    config.outputEmptyResults = false;\n    config.outputLocationType = \"msg\";\n    config.outputLocation = \"persons\";\n\n    msg.payload = config;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":60,"wires":[["759a33273d4e9441"]]},{"id":"759a33273d4e9441","type":"subflow:ea5b93cde6b1bf0a","z":"ba09e97f2ed22f2b","name":"","x":795,"y":60,"wires":[["bac0f6cb65e6ea92"]],"l":false},{"id":"bb7937782ae7d333","type":"subflow:e6ac576fb4598283","z":"ba09e97f2ed22f2b","name":"","x":550,"y":60,"wires":[[],["e08a8393f3cf6c44"]]},{"id":"583f787b51f72a7f","type":"switch","z":"ba09e97f2ed22f2b","name":"sendMobile ?","property":"sendMobile","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":60,"wires":[["fc448eba97609691"],["bb7937782ae7d333"]]},{"id":"ed8d55cbcd91d71a","type":"api-current-state","z":"ba09e97f2ed22f2b","name":"speaker day mode ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.speaker_day_night_mode","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":200,"y":60,"wires":[["583f787b51f72a7f"],[]]},{"id":"b1a62f6969ebc721","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set vol defaultVolumeLevel","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{defaultVolumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":400,"wires":[["385d4f6f46823862"]]},{"id":"9b82d4253e2257cd","type":"api-call-service","z":"dbf17bea6affd2ec","name":"continue playing","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":180,"y":460,"wires":[["39cf43e742a8d1ba"]]},{"id":"385d4f6f46823862","type":"function","z":"dbf17bea6affd2ec","name":"music data","func":"let media_content_type = msg.data.attributes.media_content_type;\nlet media_content_id = msg.data.attributes.media_content_id;\nlet volume_level = msg.data.attributes.volume_level;\nlet entity_id = msg.data.entity_id;\n\nif (media_content_id.includes(\"https://\")) {\n    msg.payload = {\n        \"data\": {\n            \"entity_id\": entity_id,\n            \"media_content_id\": media_content_id,\n            \"media_content_type\": media_content_type\n        }\n    };\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":400,"wires":[["5c6005df6081a7b9"]]},{"id":"27bd1531081dd2fd","type":"link in","z":"dbf17bea6affd2ec","name":"link in 117","links":["eadc0b9e16656110","9331863e959391d8","ad8a9e1b14a03d40","48fe6416c2792fdb"],"x":55,"y":400,"wires":[["2a7186d6e40d7286"]]},{"id":"4f3961b90903464f","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set last vol","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":470,"y":460,"wires":[[]]},{"id":"39cf43e742a8d1ba","type":"change","z":"dbf17bea6affd2ec","name":"delete","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":460,"wires":[["4f3961b90903464f"]]},{"id":"5c6005df6081a7b9","type":"link out","z":"dbf17bea6affd2ec","name":"link out 496","mode":"link","links":["1d545ec9e2e01133"],"x":655,"y":400,"wires":[]},{"id":"1d545ec9e2e01133","type":"link in","z":"dbf17bea6affd2ec","name":"link in 466","links":["5c6005df6081a7b9"],"x":55,"y":460,"wires":[["9b82d4253e2257cd"]]},{"id":"ec29c2a0dd0ea7da","type":"function","z":"dbf17bea6affd2ec","name":"speakers >","func":"let audio_type = \"speak\" in msg ? \"speak\" : \"sound\" in msg ? \"sound\" : \"link\" in msg ? \"link\" : \"\";\n\nif (audio_type != \"\") {\n    let config = {};\n    config.rules = [\n        {\n            property: \"attributes.config.linkedClass\",\n            logic: \"is\",\n            value: \"speaker\",\n            valueType: \"str\"\n        }\n    ];\n    config.outputType = \"array\";\n    config.outputEmptyResults = false;\n    config.outputLocationType = \"msg\";\n    config.outputLocation = \"speakers\";\n\n    msg.audio_type = audio_type;\n    msg.payload = config;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":280,"wires":[["4b00031deded66ee"]]},{"id":"4b00031deded66ee","type":"subflow:ea5b93cde6b1bf0a","z":"dbf17bea6affd2ec","name":"","x":495,"y":280,"wires":[["2a607651455b0d92"]],"l":false},{"id":"48fe6416c2792fdb","type":"link out","z":"dbf17bea6affd2ec","name":"link out 507","mode":"link","links":["27bd1531081dd2fd"],"x":1075,"y":340,"wires":[]},{"id":"2a607651455b0d92","type":"function","z":"dbf17bea6affd2ec","name":"set speaker","func":"let speaker_day_night_mode = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.speaker_day_night_mode\"].state == \"on\";\nlet linkedArea = msg.linkedArea || \"\";\nlet audio_type = msg.audio_type || \"\";\nlet speakers = msg.speakers;\nlet msgs = [];\n\nif (msg.volumeLevel === undefined) {\n    if (speaker_day_night_mode) {\n        msg.volumeLevel = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_day_mode_volume\"].state) / 100;\n        msg.volumeLevel = audio_type == \"sound\" ? msg.volumeLevel * 0.75 : msg.volumeLevel;\n    } else {\n        msg.volumeLevel = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_night_mode_volume\"].state) / 100;\n        msg.volumeLevel = audio_type == \"sound\" ? msg.volumeLevel * 0.75 : msg.volumeLevel;\n    }\n}\n\nif (audio_type != \"\") {\n    if (speakers.length == 1) {\n        setSpeaker(speakers[0]);\n    } else if (linkedArea != \"\") {\n        setSpeaker(speakers.filter(s => s.linkedArea == linkedArea));\n    }\n    return [msgs];\n}\n\nfunction setSpeaker(speaker) {\n    msgs.push({\n        entity_id: speaker.entity_id,\n        volumeLevel: msg.volumeLevel,\n        defaultVolumeLevel: speaker.defaultVolumeLevel,\n        content: msg[audio_type],\n        audio_type: audio_type\n    });\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":280,"wires":[["02b538ae4401dbed"]]},{"id":"61de75a75b7da4bd","type":"api-call-service","z":"dbf17bea6affd2ec","name":"speaker","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":640,"y":340,"wires":[["b0055c6f3384e5bb"]]},{"id":"be6cb36df1176166","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set vol","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":150,"y":340,"wires":[["958af82152160955"]]},{"id":"5e44338336192f58","type":"link in","z":"dbf17bea6affd2ec","name":"link in 473","links":["1cb5c63ac769951e","02b538ae4401dbed"],"x":55,"y":340,"wires":[["be6cb36df1176166"]]},{"id":"02b538ae4401dbed","type":"link out","z":"dbf17bea6affd2ec","name":"link out 509","mode":"link","links":["5e44338336192f58"],"x":715,"y":280,"wires":[]},{"id":"958af82152160955","type":"api-current-state","z":"dbf17bea6affd2ec","name":"get current state","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{entity_id}}","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":300,"y":340,"wires":[["8dec1e1d7b8f1f83"]]},{"id":"8dec1e1d7b8f1f83","type":"function","z":"dbf17bea6affd2ec","name":"config speaker","func":"let config = global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config || {};\nlet tts_voice = \"tts_voice\" in config ? config.tts_voice : \"\";\n\nif (msg.audio_type == \"speak\" && tts_voice != \"\") {\n    msg.payload = {\n        domain: \"tts\",\n        service: tts_voice,\n        data: {\n            entity_id: msg.entity_id,\n            message: msg.content\n        }\n    };\n} else if (msg.audio_type == \"sound\") {\n    msg.payload = {\n        domain: \"media_player\",\n        service: \"play_media\",\n        data: {\n            entity_id: msg.entity_id,\n            media_content_id: \"media-source://media_source/media/\" + msg.content,\n            media_content_type: \"music\"\n        }\n    };\n} else if (msg.audio_type == \"link\") {\n    msg.payload = {\n        domain: \"media_player\",\n        service: \"play_media\",\n        data: {\n            entity_id: msg.entity_id,\n            media_content_id: msg.content,\n            media_content_type: \"music\"\n        }\n    };\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":340,"wires":[["61de75a75b7da4bd"]]},{"id":"b0055c6f3384e5bb","type":"change","z":"dbf17bea6affd2ec","name":"delete","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":770,"y":340,"wires":[["88d0ed39c8e12fc3"]]},{"id":"2a7186d6e40d7286","type":"ha-wait-until","z":"dbf17bea6affd2ec","name":"wait","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is_not","value":"playing","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":150,"y":400,"wires":[["b1a62f6969ebc721"],[]]},{"id":"b390739b79e1d7d7","type":"subflow:e6ac576fb4598283","z":"dbf17bea6affd2ec","name":"","x":170,"y":280,"wires":[["455b25fabefa1b47"],[]]},{"id":"455b25fabefa1b47","type":"delay","z":"dbf17bea6affd2ec","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"8","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":275,"y":280,"wires":[["ec29c2a0dd0ea7da"]],"l":false},{"id":"88d0ed39c8e12fc3","type":"function","z":"dbf17bea6affd2ec","name":"restore current state","func":"if (msg.data.state == \"playing\" && msg.content != \"ambiance_stop.mp3\" && !msg.content.includes(\"//storage.googleapis.com/relaxation-sounds/\")){\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":340,"wires":[["48fe6416c2792fdb"]]},{"id":"bcb46a58a0946ba5","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set vol defaultVolumeLevel","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{defaultVolumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":220,"y":180,"wires":[["8c7caf362702fa0a"]]},{"id":"1f3e41ce787aa0ed","type":"api-call-service","z":"dbf17bea6affd2ec","name":"continue playing","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":600,"y":180,"wires":[["7a603909fc29c7f8"]]},{"id":"8c7caf362702fa0a","type":"function","z":"dbf17bea6affd2ec","name":"music data","func":"let media_content_type = msg.data.attributes.media_content_type;\nlet media_content_id = msg.data.attributes.media_content_id;\nlet volume_level = msg.data.attributes.volume_level;\nlet entity_id = msg.data.entity_id;\n\nif (media_content_id.includes(\"https://\")) {\n    msg.payload = {\n        \"data\": {\n            \"entity_id\": entity_id,\n            \"media_content_id\": media_content_id,\n            \"media_content_type\": media_content_type\n        }\n    };\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":180,"wires":[["1f3e41ce787aa0ed"]]},{"id":"69249cd1988fdf79","type":"link in","z":"dbf17bea6affd2ec","name":"link in 493","links":["3a338192989d858d"],"x":55,"y":180,"wires":[["bcb46a58a0946ba5"]]},{"id":"2290850b6a3b40e8","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set last vol","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":890,"y":180,"wires":[[]]},{"id":"7a603909fc29c7f8","type":"change","z":"dbf17bea6affd2ec","name":"delete","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":180,"wires":[["2290850b6a3b40e8"]]},{"id":"ca9dbdbee0f9c9c9","type":"function","z":"dbf17bea6affd2ec","name":"speakers >","func":"let audio_type = \"speak\" in msg ? \"speak\" : \"sound\" in msg ? \"sound\" : \"link\" in msg ? \"link\" : \"\";\n\nif (audio_type != \"\") {\n    let config = {};\n    config.rules = [\n        {\n            property: \"attributes.config.linkedClass\",\n            logic: \"is\",\n            value: \"speaker\",\n            valueType: \"str\"\n        }\n    ];\n    config.outputType = \"array\";\n    config.outputEmptyResults = false;\n    config.outputLocationType = \"msg\";\n    config.outputLocation = \"speakers\";\n\n    msg.audio_type = audio_type;\n    msg.payload = config;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":60,"wires":[["661477ea168ddcfa"]]},{"id":"661477ea168ddcfa","type":"subflow:ea5b93cde6b1bf0a","z":"dbf17bea6affd2ec","name":"","x":435,"y":60,"wires":[["47723d37ba8fbb09"]],"l":false},{"id":"3a338192989d858d","type":"link out","z":"dbf17bea6affd2ec","name":"link out 547","mode":"link","links":["69249cd1988fdf79"],"x":1015,"y":120,"wires":[]},{"id":"47723d37ba8fbb09","type":"function","z":"dbf17bea6affd2ec","name":"set speaker","func":"let speaker_day_night_mode = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.speaker_day_night_mode\"].state == \"on\";\nlet linkedArea = msg.linkedArea || \"\";\nlet audio_type = msg.audio_type || \"\";\nlet speakers = msg.speakers;\nlet msgs = [];\n\nif (msg.volumeLevel === undefined) {\n    if (speaker_day_night_mode) {\n        msg.volumeLevel = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_day_mode_volume\"].state) / 100;\n        msg.volumeLevel = audio_type == \"sound\" ? msg.volumeLevel * 0.75 : msg.volumeLevel;\n    } else {\n        msg.volumeLevel = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.speaker_night_mode_volume\"].state) / 100;\n        msg.volumeLevel = audio_type == \"sound\" ? msg.volumeLevel * 0.75 : msg.volumeLevel;\n    }\n}\n\nif (audio_type != \"\") {\n    if (speakers.length == 1) {\n        setSpeaker(speakers[0]);\n    } else if (linkedArea != \"\") {\n        setSpeaker(speakers.filter(s => s.linkedArea == linkedArea));\n    }\n    return [msgs];\n}\n\nfunction setSpeaker(speaker) {\n    msgs.push({\n        entity_id: speaker.entity_id,\n        volumeLevel: msg.volumeLevel,\n        defaultVolumeLevel: speaker.defaultVolumeLevel,\n        content: msg[audio_type],\n        audio_type: audio_type\n    });\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":60,"wires":[["4fb838b31db5838d"]]},{"id":"ea8d65fa7fb96c50","type":"api-call-service","z":"dbf17bea6affd2ec","name":"speaker","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":120,"wires":[["4a6d70addb9a6a25"]]},{"id":"2e9816dcf50f800e","type":"link in","z":"dbf17bea6affd2ec","name":"link in 494","links":["188c093588f58e20"],"x":55,"y":120,"wires":[["86c72c596cc9f4c6"]]},{"id":"188c093588f58e20","type":"link out","z":"dbf17bea6affd2ec","name":"link out 548","mode":"link","links":["2e9816dcf50f800e"],"x":1075,"y":60,"wires":[]},{"id":"86c72c596cc9f4c6","type":"function","z":"dbf17bea6affd2ec","name":"config speaker","func":"let config = global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config || {};\nlet tts_voice = \"tts_voice\" in config ? config.tts_voice : \"\";\n\nif (msg.audio_type == \"speak\" && tts_voice != \"\") {\n    msg.payload = {\n        domain: \"tts\",\n        service: tts_voice,\n        data: {\n            entity_id: msg.entity_id,\n            message: msg.content\n        }\n    };\n} else if (msg.audio_type == \"sound\") {\n    msg.payload = {\n        domain: \"media_player\",\n        service: \"play_media\",\n        data: {\n            entity_id: msg.entity_id,\n            media_content_id: \"media-source://media_source/media/\" + msg.content,\n            media_content_type: \"music\"\n        }\n    };\n} else if (msg.audio_type == \"link\") {\n    msg.payload = {\n        domain: \"media_player\",\n        service: \"play_media\",\n        data: {\n            entity_id: msg.entity_id,\n            media_content_id: msg.content,\n            media_content_type: \"music\"\n        }\n    };\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":120,"wires":[["ea8d65fa7fb96c50"]]},{"id":"9be1c461b95830f7","type":"subflow:e6ac576fb4598283","z":"dbf17bea6affd2ec","name":"","x":170,"y":60,"wires":[["ca9dbdbee0f9c9c9"],[]]},{"id":"927e96584e6b562f","type":"function","z":"dbf17bea6affd2ec","name":"restore current state","func":"if (msg.data.state == \"playing\" && msg.content != \"ambiance_stop.mp3\" && !msg.content.includes(\"//storage.googleapis.com/relaxation-sounds/\")){\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":760,"y":120,"wires":[["fee88348ee9adfe3"]]},{"id":"4a6d70addb9a6a25","type":"ha-wait-until","z":"dbf17bea6affd2ec","name":"wait","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is_not","value":"playing","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":470,"y":120,"wires":[["a43b3b2843558a1f"],[]]},{"id":"4fb838b31db5838d","type":"function","z":"dbf17bea6affd2ec","name":"wait","func":"let speaker = global.get(\"homeassistant\").homeAssistant.states[msg.entity_id];\nlet speakers = global.get(\"speakers\") || {};\n\nif (!(msg.entity_id in speakers)) {\n    speakers[msg.entity_id] = {};\n    speakers[msg.entity_id].status = \"ready\";\n    speakers[msg.entity_id].queue = [];\n}\n\nif (speakers[msg.entity_id].status == \"not_ready\") {\n    speakers[msg.entity_id].queue.push({ ...msg });\n    global.set(\"speakers\", speakers);\n}\n\nif (speakers[msg.entity_id].status == \"ready\" || speaker.attributes.media_content_id.includes(\"https://\")) {\n    speakers[msg.entity_id].status = \"not_ready\";\n    global.set(\"speakers\", speakers);\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":60,"wires":[["e50a6d796d536e90"]]},{"id":"a43b3b2843558a1f","type":"function","z":"dbf17bea6affd2ec","name":"ready","func":"let speakers = global.get(\"speakers\") || {};\n\nspeakers[msg.entity_id].status = \"ready\";\nglobal.set(\"speakers\", speakers);\n\nif (speakers[msg.entity_id].queue.length != 0) {\n    msg = speakers[msg.entity_id].queue.shift();\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":120,"wires":[["4fb838b31db5838d"],["927e96584e6b562f"]]},{"id":"e50a6d796d536e90","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set vol","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":810,"y":60,"wires":[["94773e1336fa2717"]]},{"id":"94773e1336fa2717","type":"api-current-state","z":"dbf17bea6affd2ec","name":"get current state","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{entity_id}}","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":960,"y":60,"wires":[["188c093588f58e20"]]},{"id":"fee88348ee9adfe3","type":"change","z":"dbf17bea6affd2ec","name":"delete","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":120,"wires":[["3a338192989d858d"]]},{"id":"c90e53f5c4e8e1e2","type":"api-call-service","z":"723d4991c3c87385","name":"call service","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":330,"y":60,"wires":[[]]},{"id":"955123ec73074cbf","type":"function","z":"723d4991c3c87385","name":"call prepare","func":"if (msg.entity_id != undefined && msg.entity_id != \"\") {\n    let switchDomain = [\"input_boolean\", \"switch\", \"light\"];\n    let valueDomain = [\"input_number\", \"input_text\"];\n    let selectDomain = [\"input_select\"];\n    let datetimeDomain = [\"input_datetime\"];\n    msg.domain = msg.entity_id.split(\".\")[0];\n\n    if (switchDomain.includes(msg.domain) && [\"on\", \"off\"].includes(msg.state)) {\n        msg.service = \"turn_\" + msg.state;\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id\n            }\n        };\n        return msg;\n    } else if (selectDomain.includes(msg.domain) && msg.state !== undefined) {\n        msg.service = \"select_option\";\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id, option: msg.state\n            }\n        };\n        return msg;\n    } else if (valueDomain.includes(msg.domain) && (msg.domain == \"input_number\" && !isNaN(msg.state) || msg.domain == \"input_text\")) {\n        msg.service = \"set_value\";\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id, value: msg.state\n            }\n        };\n        return msg;\n    } else if (datetimeDomain.includes(msg.domain)) {\n        let type = \"time\" in msg ? \"time\" : \"date\" in msg ? \"date\" : \"datetime\" in msg ? \"datetime\" : \"\";\n        let data = msg[type] !== undefined ? msg[type] : \"\";\n        if (data != \"\") {\n            msg.service = \"set_datetime\";\n            msg.payload = {\n                data: {\n                    entity_id: msg.entity_id, [type]: data\n                }\n            };\n            return msg;\n        }\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["c90e53f5c4e8e1e2"]]},{"id":"bdd49c309e819698","type":"function","z":"ad3b29a5dd67898f","name":"send dashboard bug","func":"if (\"error\" in msg && \"source\" in msg.error && \"name\" in msg.error.source) {\n    let notifications = global.get(\"notifications\") || {};\n\n    msg.alertType = \"error\";\n    msg.title = \"Erreur dÃ©tÃ©ctÃ©e\";\n    msg.notification_id = (msg.flowTitle + \"_\" + msg.error.source.name).replaceAll(/[^A-Za-z0-9_]/g, \"\").replaceAll(/(_){2,}/g, \"_\").replaceAll(\" \", \"_\");\n    msg.message = \"Erreur : \" + msg.flowTitle + \" > \" + msg.error.source.name + \" > \" + msg.error.message;\n\n    if (msg.notification_id in notifications) {\n        msg.message += \", apparue \" + (notifications[msg.notification_id].count + 1) + \" fois.\";\n    } else {\n        msg.sendMobile = true;\n    }\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":100,"wires":[["6280166330ae9f71"]]},{"id":"2a0d685e1c4f2f92","type":"subflow:6c4028aab794d52d","z":"ad3b29a5dd67898f","name":"","x":550,"y":100,"wires":[[]]},{"id":"6280166330ae9f71","type":"delay","z":"ad3b29a5dd67898f","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":390,"y":100,"wires":[["2a0d685e1c4f2f92"]]},{"id":"756ccf0426c7087d","type":"debug","z":"ad3b29a5dd67898f","name":"debug 1","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":330,"y":40,"wires":[]},{"id":"f8ffcffdadd50488","type":"subflow:94b2243985840d69","z":"ad3b29a5dd67898f","name":"","x":170,"y":40,"wires":[["756ccf0426c7087d","9303e8f878770ce0"]]},{"id":"9303e8f878770ce0","type":"subflow:515fe2385f553c95","z":"ad3b29a5dd67898f","name":"","x":510,"y":40,"wires":[["d32dfc19aca11d6c"],["308ca84962deb508"]]},{"id":"3d465666ee7193c6","type":"file","z":"ad3b29a5dd67898f","name":"save error","filename":"/config/notifications/errors.txt","filenameType":"str","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":320,"y":160,"wires":[[]]},{"id":"517605647a36ae7a","type":"function","z":"ad3b29a5dd67898f","name":"in payload","func":"msg.payload = { ...msg };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":160,"wires":[["3d465666ee7193c6"]]},{"id":"d32dfc19aca11d6c","type":"link out","z":"ad3b29a5dd67898f","name":"link out 536","mode":"link","links":["7a46c28099b3899d"],"x":615,"y":40,"wires":[]},{"id":"7a46c28099b3899d","type":"link in","z":"ad3b29a5dd67898f","name":"link in 483","links":["d32dfc19aca11d6c"],"x":55,"y":100,"wires":[["bdd49c309e819698"]]},{"id":"308ca84962deb508","type":"link out","z":"ad3b29a5dd67898f","name":"link out 537","mode":"link","links":["044a910a51b45b80"],"x":615,"y":40,"wires":[]},{"id":"044a910a51b45b80","type":"link in","z":"ad3b29a5dd67898f","name":"link in 484","links":["308ca84962deb508"],"x":55,"y":160,"wires":[["517605647a36ae7a"]]},{"id":"b4b8c8acb4afc630","type":"function","z":"6c4028aab794d52d","name":"create notification","func":"let notifications = global.get(\"notifications\") || {};\nif (!(msg.notification_id in notifications) || msg.override) {\n    let d = new Date();\n    let local_time = (d.getMonth() + 1) + \" \" + d.getDate() + \" \" + d.getHours() + \":\" + (d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes());\n\n    notifications[msg.notification_id] = {};\n    notifications[msg.notification_id].count = 1;\n    notifications[msg.notification_id].creationDate = msg.restore ? msg.creationDate : local_time;\n} else {\n    notifications[msg.notification_id].count++;\n}\n\nnotifications[msg.notification_id].title = msg.title || \"\";\nnotifications[msg.notification_id].message = msg.message || \"\";\nnotifications[msg.notification_id].alertType = msg.alertType || \"info\";\n\nglobal.set(\"notifications\", notifications);\nmsg.notification = notifications[msg.notification_id];\nmsg.payload = notifications;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":180,"wires":[["01115ff6eea2fb4d","db39b80e5ccab19b","329b6d774407f71d"]]},{"id":"db39b80e5ccab19b","type":"api-call-service","z":"6c4028aab794d52d","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"persistent_notification","service":"create","areaId":[],"deviceId":[],"entityId":[],"data":"{\"title\":\"{{notification.title}}\",\"message\":\"{{notification.message}}\",\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":740,"y":180,"wires":[[]]},{"id":"321f2d38a11d9f17","type":"switch","z":"6c4028aab794d52d","name":"notification_id ?","property":"notification_id","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":240,"y":120,"wires":[["74ef1627ad31a835","40fb28bbf56378fe"]]},{"id":"74ef1627ad31a835","type":"switch","z":"6c4028aab794d52d","name":"dismiss ?","property":"dismiss","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":640,"y":120,"wires":[["ed73f233a30a209c","1fbb7266d0e73a79"]]},{"id":"1fbb7266d0e73a79","type":"api-call-service","z":"6c4028aab794d52d","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"persistent_notification","service":"dismiss","areaId":[],"deviceId":[],"entityId":[],"data":"{\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":850,"y":120,"wires":[[]]},{"id":"3f253902f407ad63","type":"link out","z":"6c4028aab794d52d","name":"link out 195","mode":"link","links":["fbbcce304f59d362","f645dba0f4e95e1c"],"x":535,"y":120,"wires":[]},{"id":"fbbcce304f59d362","type":"link in","z":"6c4028aab794d52d","name":"link in 211","links":["3f253902f407ad63"],"x":125,"y":180,"wires":[["b4b8c8acb4afc630"]]},{"id":"ed73f233a30a209c","type":"link out","z":"6c4028aab794d52d","name":"link out 196","mode":"link","links":["a6c8b9172e0373db","a663712effcb42a4","bf4456170c254191"],"x":1015,"y":120,"wires":[]},{"id":"9e6e87f91de1cad9","type":"link in","z":"6c4028aab794d52d","name":"link in 227","links":["01115ff6eea2fb4d"],"x":125,"y":240,"wires":[["bca42d4e03bd9757","ba2ec713942851f0","2d47b21860760270"]]},{"id":"2d47b21860760270","type":"subflow:dbf17bea6affd2ec","z":"6c4028aab794d52d","name":"","x":310,"y":240,"wires":[]},{"id":"bca42d4e03bd9757","type":"subflow:5a05b9ac0289ff03","z":"6c4028aab794d52d","name":"","env":[],"x":500,"y":240,"wires":[]},{"id":"01115ff6eea2fb4d","type":"link out","z":"6c4028aab794d52d","name":"link out 226","mode":"link","links":["f81a3cb350671e4a","9e6e87f91de1cad9","d242ce3adfd25674"],"x":375,"y":180,"wires":[]},{"id":"40fb28bbf56378fe","type":"switch","z":"6c4028aab794d52d","name":"create update ?","property":"dismiss","propertyType":"msg","rules":[{"t":"null"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":120,"wires":[["3f253902f407ad63"],["3f253902f407ad63"]]},{"id":"a663712effcb42a4","type":"link in","z":"6c4028aab794d52d","name":"link in 232","links":["ed73f233a30a209c"],"x":175,"y":240,"wires":[["bca42d4e03bd9757","ba2ec713942851f0","2d47b21860760270"]]},{"id":"ba2ec713942851f0","type":"subflow:ba09e97f2ed22f2b","z":"6c4028aab794d52d","name":"","x":680,"y":240,"wires":[]},{"id":"27be3bd3583772c1","type":"server-events","z":"6c4028aab794d52d","name":"persistent_notification","server":"c87720f17866318d","version":2,"eventType":"call_service","exposeToHomeAssistant":false,"eventData":"{\"domain\":\"persistent_notification\"}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"notification","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":140,"y":380,"wires":[["74186c0c46658fa0","628251e2da9da6f5"]]},{"id":"74186c0c46658fa0","type":"switch","z":"6c4028aab794d52d","name":"dismiss","property":"notification.event.service","propertyType":"msg","rules":[{"t":"eq","v":"dismiss","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":380,"wires":[["7e00d134f3038fd4"]]},{"id":"628251e2da9da6f5","type":"switch","z":"6c4028aab794d52d","name":"create","property":"notification.event.service","propertyType":"msg","rules":[{"t":"eq","v":"create","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":380,"wires":[[]]},{"id":"7e00d134f3038fd4","type":"function","z":"6c4028aab794d52d","name":"delete notification","func":"let notifications = global.get(\"notifications\") || {};\ndelete notifications[msg.notification.event.service_data.notification_id];\nmsg.payload = notifications;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":380,"wires":[["cc379f05a4f6474a"]]},{"id":"fe7c59f6e9b79d49","type":"yaml","z":"6c4028aab794d52d","property":"payload","name":"","x":210,"y":300,"wires":[["c16c539fd3d8eb35"]]},{"id":"c16c539fd3d8eb35","type":"file","z":"6c4028aab794d52d","name":"","filename":"/config/notifications/notifications.yaml","filenameType":"str","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":430,"y":300,"wires":[["a641e18ab6fd2b7d"]]},{"id":"9c15ed8da7f1e70d","type":"link in","z":"6c4028aab794d52d","name":"write notifications","links":[],"x":125,"y":300,"wires":[["fe7c59f6e9b79d49"]]},{"id":"a641e18ab6fd2b7d","type":"link out","z":"6c4028aab794d52d","name":"link out 450","mode":"return","links":[],"x":615,"y":300,"wires":[]},{"id":"329b6d774407f71d","type":"link call","z":"6c4028aab794d52d","name":"","links":["9c15ed8da7f1e70d"],"linkType":"static","timeout":"30","x":510,"y":180,"wires":[[]]},{"id":"cc379f05a4f6474a","type":"link call","z":"6c4028aab794d52d","name":"","links":["9c15ed8da7f1e70d"],"linkType":"static","timeout":"30","x":810,"y":380,"wires":[[]]},{"id":"23ebc4c6c318a1d6","type":"server-events","z":"6c4028aab794d52d","name":"phone receive","server":"c87720f17866318d","version":2,"eventType":"mobile_app_notification_action","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":60,"wires":[["e5671fc4552229ec"]]},{"id":"e5671fc4552229ec","type":"change","z":"6c4028aab794d52d","name":"notification_id","rules":[{"t":"set","p":"notification_id","pt":"msg","to":"payload.event.action","tot":"msg"},{"t":"set","p":"dismiss","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":60,"wires":[["acf3ac6effaf6cbb"]]},{"id":"99fea05535de10cd","type":"link out","z":"6c4028aab794d52d","name":"link out 550","mode":"link","links":["2676dfc312e38a90"],"x":615,"y":60,"wires":[]},{"id":"2676dfc312e38a90","type":"link in","z":"6c4028aab794d52d","name":"link in 496","links":["99fea05535de10cd"],"x":125,"y":120,"wires":[["321f2d38a11d9f17"]]},{"id":"acf3ac6effaf6cbb","type":"function","z":"6c4028aab794d52d","name":"notification_id exist ?","func":"let notifications = global.get(\"notifications\") || {};\n\nif (msg.notification_id in notifications) {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":60,"wires":[["99fea05535de10cd"]]},{"id":"6a3d5dea1ffbb2d8","type":"function","z":"10a4bbabe046de0e","name":"lock / unlock","func":"let locked_lights = global.get(\"locked_lights\") || [];\n\nif (\"lock\" in msg && \"lock_lights\" in msg) {\n    if (msg.lock) {\n        for (let light of msg.lock_lights) {\n            if (!locked_lights.includes(light)) {\n                locked_lights.push(light);\n            }\n        }\n    } else if (!msg.lock) {\n        for (let light of msg.lock_lights) {\n            if (locked_lights.includes(light)) {\n                locked_lights.splice(locked_lights.indexOf(light), 1);\n            }\n        }\n    }\n    global.set(\"locked_lights\", locked_lights);\n    delete msg.lock_lights;\n    delete msg.lock;\n    return msg;\n} else if (\"entity_id\" in msg) {\n    if (!locked_lights.includes(msg.entity_id)) {\n        return msg;\n    }\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":80,"wires":[[]]},{"id":"3ff07ed925623c04","type":"function","z":"10a4bbabe046de0e","name":"set lock","func":"msg.lock_lights = msg.linkedLights;\nmsg.lock = msg.cube.flip90;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":140,"wires":[[]]},{"id":"d95af1f39bdc2e43","type":"function","z":"9b9bfdbe9a43dabb","name":"msg","func":"msg.lock = !msg.restore;\nmsg.lock_lights = msg.linkedLights;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":120,"wires":[["36801bdea0fbfedd"]]},{"id":"27e428e0387cac8a","type":"function","z":"9b9bfdbe9a43dabb","name":"restore lights","func":"let area_motions = global.get(\"area_motions\");\nlet lights = msg.lights;\nlet areas = [];\nlet msgs = [];\n\nfor (let light of lights) {\n    if (!areas.includes(light.linkedArea)) {\n        areas.push(light.linkedArea);\n    }\n}\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area, state: area_motions[area] });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":120,"wires":[[]]},{"id":"4f9438c9a5b4c1b4","type":"link out","z":"9b9bfdbe9a43dabb","name":"link out 326","mode":"link","links":["01a2c1e96153b1ea"],"x":895,"y":120,"wires":[]},{"id":"01a2c1e96153b1ea","type":"link in","z":"9b9bfdbe9a43dabb","name":"link in 339","links":["4f9438c9a5b4c1b4"],"x":135,"y":180,"wires":[["f088cfce1985c89d","6a1e98f0e17b03b9"]]},{"id":"ad661360b9c48435","type":"subflow:10a4bbabe046de0e","z":"9b9bfdbe9a43dabb","name":"","x":500,"y":120,"wires":[["a9afa54b296eb45f"]]},{"id":"f088cfce1985c89d","type":"function","z":"9b9bfdbe9a43dabb","name":"prepare lights","func":"if (\"lights\" in msg && msg.lights.length != 0 && \"ambiance_config\" in msg && \"ambiances_type\" in msg.ambiance_config) {\n    if (msg.action_type != \"stop\") {\n        let msgs = [];\n        for (let light of msg.lights) {\n            if (\"attributes\" in light && \"supported_color_modes\" in light.attributes && light.attributes.supported_color_modes.includes(\"rgb\")) {\n                let ambiance_type = msg.ambiance_config.ambiances_type[msg.action_type];\n                let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360);\n                let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100);\n                let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100);\n                let delay = 1000 + Math.round(Math.random() * 14000);\n                msgs.push({\n                    entity_id: light.entity_id,\n                    action_type: msg.action_type,\n                    ambiance_config: msg.ambiance_config,\n                    delay: delay,\n                    payload: {\n                        data: {\n                            entity_id: light.entity_id,\n                            hs_color: [hs, saturation],\n                            brightness_pct: brightness,\n                            transition: Math.round(delay / 100) / 10\n                        }\n                    }\n                });\n            }\n        }\n        msg.reset = true;\n        return [msgs, msg];\n    } else {\n        msg.reset = true;\n        return [null, msg];\n    }\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance);\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance);\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":180,"wires":[["badb8d2fb8ab5aa3","a9fcbb2aa70ea1f8"],["0cdd3aae865a31cf"]]},{"id":"a9afa54b296eb45f","type":"switch","z":"9b9bfdbe9a43dabb","name":"restore","property":"restore","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":640,"y":120,"wires":[["27e428e0387cac8a"]]},{"id":"52d03fb81f2ee80c","type":"api-call-service","z":"9b9bfdbe9a43dabb","name":"control lights","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":530,"y":180,"wires":[[]]},{"id":"9e5c408e79ac1df8","type":"delay","z":"9b9bfdbe9a43dabb","name":"timer","pauseType":"delayv","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":670,"y":180,"wires":[["99fa979c22389f12"]]},{"id":"99fa979c22389f12","type":"function","z":"9b9bfdbe9a43dabb","name":"prepare light","func":"if (msg.action_type != \"stop\") {\n    let ambiance_type = msg.ambiance_config.ambiances_type[msg.action_type];\n    let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360);\n    let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100);\n    let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100);\n    let delay = 1000 + Math.round(Math.random() * 14000);\n\n    msg.delay = delay;\n    if (msg.action_type == \"thunderstorm\" && delay < 1500) {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                effect: \"Strobe epilepsy!\"\n            }\n        };        \n    } else {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                hs_color: [hs, saturation],\n                brightness_pct: brightness,\n                transition: Math.round(delay / 100) / 10\n            }\n        };\n    }\n\n    return msg;\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance);\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance);\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":180,"wires":[["df2086a6c727f6f7"]]},{"id":"df2086a6c727f6f7","type":"link out","z":"9b9bfdbe9a43dabb","name":"link out 327","mode":"link","links":["9fedc4504beff3ff"],"x":915,"y":180,"wires":[]},{"id":"9fedc4504beff3ff","type":"link in","z":"9b9bfdbe9a43dabb","name":"link in 340","links":["df2086a6c727f6f7"],"x":425,"y":180,"wires":[["52d03fb81f2ee80c","9e5c408e79ac1df8"]]},{"id":"badb8d2fb8ab5aa3","type":"delay","z":"9b9bfdbe9a43dabb","name":"","pauseType":"delay","timeout":"0.5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":180,"wires":[["9e5c408e79ac1df8"]],"l":false},{"id":"05537233af43e407","type":"delay","z":"9b9bfdbe9a43dabb","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":435,"y":240,"wires":[["c83520ded53399c4"]],"l":false},{"id":"6a1e98f0e17b03b9","type":"switch","z":"9b9bfdbe9a43dabb","name":"stop","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"stop","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":230,"y":240,"wires":[["aba5e92a0de87c53"],["05537233af43e407"]]},{"id":"aba5e92a0de87c53","type":"change","z":"9b9bfdbe9a43dabb","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":240,"wires":[["05537233af43e407"]]},{"id":"c83520ded53399c4","type":"change","z":"9b9bfdbe9a43dabb","name":"option","rules":[{"t":"set","p":"option","pt":"msg","to":"homeassistant.homeAssistant.states[\"input_select.user_configuration\"].attributes.config.ambiance_config.ambiances_type.stop.name","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":240,"wires":[[]]},{"id":"36801bdea0fbfedd","type":"function","z":"9b9bfdbe9a43dabb","name":"lights >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"entity_id\",\n        logic: \"includes\",\n        value: msg.linkedLights.join(\",\"),\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"includes\",\n        value: \"on,off\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"lights\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":120,"wires":[["f3c72fbff7a8eae1"]]},{"id":"f3c72fbff7a8eae1","type":"subflow:ea5b93cde6b1bf0a","z":"9b9bfdbe9a43dabb","name":"","x":395,"y":120,"wires":[["ad661360b9c48435","4f9438c9a5b4c1b4"]],"l":false},{"id":"5ce464135f7acf6e","type":"subflow:dbf17bea6affd2ec","z":"9b9bfdbe9a43dabb","name":"","x":370,"y":60,"wires":[]},{"id":"2771cf6f6d945a3d","type":"function","z":"9b9bfdbe9a43dabb","name":"msg speaker","func":"if (msg.action_type != undefined && \"linkedSpeaker\" in msg && msg.linkedSpeaker != \"\") {\n    let speaker = global.get(\"homeassistant\").homeAssistant.states[msg.linkedSpeaker].attributes;\n\n    if (\"ambiance_config\" in msg\n        && \"path\" in msg.ambiance_config\n        && \"start\" in msg.ambiance_config.path\n        && \"end\" in msg.ambiance_config.path\n        && msg.ambiance_config.path.start != \"\"\n        && msg.ambiance_config.path.end != \"\") {\n        if (msg.action_type == \"stop\") {\n            let sound = \"ambiance_stop.mp3\";\n            msg = {\n                linkedArea: msg.linkedArea,\n                volumeLevel: \"config\" in speaker && \"defaultVolumeLevel\" in speaker.config ? speaker.config.defaultVolumeLevel : 0.5,\n                sound: sound\n            }\n        } else {\n            msg = {\n                linkedArea: msg.linkedArea,\n                volumeLevel: \"ambianceVolumeLevel\" in msg ? msg.ambianceVolumeLevel : 0.5,\n                link: msg.ambiance_config.path.start + msg.action_type + msg.ambiance_config.path.end\n            }\n        }\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":60,"wires":[["5ce464135f7acf6e"]]},{"id":"43eb691e78e84db2","type":"ha-get-entities","z":"ea5b93cde6b1bf0a","name":"","server":"c87720f17866318d","version":0,"rules":[],"output_type":"array","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":170,"y":60,"wires":[["8ad68d48c16b29ca"]]},{"id":"8ad68d48c16b29ca","type":"function","z":"ea5b93cde6b1bf0a","name":"set config","func":"for (var i = 0; i < msg[msg.payload.outputLocation].length; i++) {\n    msg[msg.payload.outputLocation][i] = { ...msg[msg.payload.outputLocation][i], ...msg[msg.payload.outputLocation][i][\"attributes\"][\"config\"]};\n    if (!isNaN(msg[msg.payload.outputLocation][i].state)){\n        msg[msg.payload.outputLocation][i].state = parseFloat(msg[msg.payload.outputLocation][i].state);\n    }\n    delete msg[msg.payload.outputLocation][i][\"attributes\"][\"config\"];\n}\ndelete msg.payload;\nreturn msg;\n\n//logic = is, is_not, lt, lte, gt, gte, includes, does_not_include, starts_with, in_group, jsonata","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":60,"wires":[[]]},{"id":"cc392e2801ce2f2e","type":"function","z":"ea5b93cde6b1bf0a","name":"search","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"light\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"test\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":60,"wires":[[]]},{"id":"4d0457a2e27a298e","type":"switch","z":"612068fa04cc8bbd","name":"flip90","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"flip90","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":60,"wires":[["1d0a618a86abc4be","20712a615a75c746"]]},{"id":"1d0a618a86abc4be","type":"function","z":"612068fa04cc8bbd","name":"lock lights","func":"msg.lock_lights = msg.linkedLights;\nmsg.lock = true;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":60,"wires":[["93cc5a471dff46cf"]]},{"id":"93cc5a471dff46cf","type":"subflow:10a4bbabe046de0e","z":"612068fa04cc8bbd","name":"","x":1040,"y":60,"wires":[[]]},{"id":"7d1baedd2aaa770c","type":"api-call-service","z":"612068fa04cc8bbd","name":"control lights","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":670,"y":180,"wires":[[]]},{"id":"4fa4465bfee4db09","type":"function","z":"612068fa04cc8bbd","name":"prepare lights msgs","func":"let noSupportedRgbLights = [];\nlet supportedRgbLights = [];\nlet lights = msg.lights;\nlet msgs = [];\n\nfor (let light of lights) {\n    if (\"supported_color_modes\" in light.attributes && light.attributes.supported_color_modes.includes(\"rgb\")) {\n        supportedRgbLights.push(light.entity_id);\n    }\n    if (\"supported_color_modes\" in light.attributes && !light.attributes.supported_color_modes.includes(\"rgb\")) {\n        noSupportedRgbLights.push(light.entity_id);\n    }\n}\n\nif (noSupportedRgbLights.length != 0) {\n    msgs.push({\n        payload: { \"data\": { \"entity_id\": noSupportedRgbLights, \"brightness_pct\": !msg.cube.free_fall && msg.cube.shake_air ? msg.lightPower : 0, \"color_temp\": msg.colorTemp } }\n    });\n}\n\nif (supportedRgbLights.length != 0) {\n    if (msg.cube.move) {\n        msgs.push({\n            payload: { \"data\": { \"entity_id\": supportedRgbLights, \"brightness_pct\": !msg.cube.free_fall ? msg.lightPower : 0, \"hs_color\": [msg.lightColor, 100] } }\n        });\n    } else {\n        msgs.push({\n            payload: { \"data\": { \"entity_id\": supportedRgbLights, \"brightness_pct\": !msg.cube.free_fall ? msg.lightPower : 0, \"color_temp\": msg.colorTemp } }\n        });\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":180,"wires":[["7d1baedd2aaa770c"]]},{"id":"e24925e9228a946c","type":"link in","z":"612068fa04cc8bbd","name":"link in 342","links":["8e986b6814a118de","20712a615a75c746"],"x":155,"y":180,"wires":[["ec9b3b144854bc6a"]]},{"id":"20712a615a75c746","type":"link out","z":"612068fa04cc8bbd","name":"link out 329","mode":"link","links":["e24925e9228a946c"],"x":795,"y":60,"wires":[]},{"id":"188d4197be377390","type":"switch","z":"612068fa04cc8bbd","name":"tap_twice","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"tap_twice","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":200,"y":120,"wires":[["4083f149db8cfa38"]]},{"id":"473feda77b747512","type":"function","z":"612068fa04cc8bbd","name":"restore lights","func":"let area_motions = global.get(\"area_motions\");\nlet areas = [];\nlet msgs = [];\n\nfor (let light of msg.lights) {\n    if (!areas.includes(light.linkedArea)) {\n        areas.push(light.linkedArea);\n    }\n}\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area, state: area_motions[area] });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":120,"wires":[[]]},{"id":"4083f149db8cfa38","type":"function","z":"612068fa04cc8bbd","name":"unlock lights","func":"msg.lock_lights = msg.linkedLights;\nmsg.lock = false;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":120,"wires":[["8fa0b486a664301b"]]},{"id":"8fa0b486a664301b","type":"subflow:10a4bbabe046de0e","z":"612068fa04cc8bbd","name":"","x":500,"y":120,"wires":[["59637b2fa5678ea2"]]},{"id":"59637b2fa5678ea2","type":"function","z":"612068fa04cc8bbd","name":"lights >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"entity_id\",\n        logic: \"includes\",\n        value: msg.linkedLights.join(\",\"),\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"includes\",\n        value: \"on,off\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"lights\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":120,"wires":[["9a2bf291a6dd66e4"]]},{"id":"9a2bf291a6dd66e4","type":"subflow:ea5b93cde6b1bf0a","z":"612068fa04cc8bbd","name":"","x":735,"y":120,"wires":[["473feda77b747512"]],"l":false},{"id":"ec9b3b144854bc6a","type":"function","z":"612068fa04cc8bbd","name":"lights >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"entity_id\",\n        logic: \"includes\",\n        value: msg.linkedLights.join(\",\"),\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"includes\",\n        value: \"on,off\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"lights\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":180,"wires":[["8ec9f5f13309936b"]]},{"id":"8ec9f5f13309936b","type":"subflow:ea5b93cde6b1bf0a","z":"612068fa04cc8bbd","name":"","x":355,"y":180,"wires":[["4fa4465bfee4db09"]],"l":false},{"id":"22db9e147fb3f0bc","type":"subflow:dbf17bea6affd2ec","z":"612068fa04cc8bbd","name":"","x":230,"y":240,"wires":[]},{"id":"d47393f14d9d896b","type":"switch","z":"612068fa04cc8bbd","name":"free_fall","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"free_fall","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":700,"y":60,"wires":[["1d0a618a86abc4be","20712a615a75c746"]]},{"id":"e0a08631094f3a1a","type":"switch","z":"612068fa04cc8bbd","name":"shake_air","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"shake_air","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":560,"y":60,"wires":[["1d0a618a86abc4be","20712a615a75c746"]]},{"id":"cd7d9f68a272e2bd","type":"switch","z":"612068fa04cc8bbd","name":"rotate","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"rotate","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":430,"y":60,"wires":[["1d0a618a86abc4be","20712a615a75c746"]]},{"id":"561d43ede593e22a","type":"switch","z":"612068fa04cc8bbd","name":"move","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"move","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":190,"y":60,"wires":[["20712a615a75c746"]]},{"id":"1dee8c383dad1dc9","type":"function","z":"050c60654a910e68","name":"prepare waits","func":"let msgs = [];\n\nif (msg.waits.length != 0 && msg.states.length == msg.waits.length) {\n    for (let i = 0; i < msg.waits.length; i++) {\n        msgs.push({ ...msg, wait_entity_id: msg.waits[i], wait_state: msg.states[i], count: i });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[["5ff166ae2792d64c"]]},{"id":"d3ca50e2799953d7","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":60,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"a71b128c6a11f16e","type":"change","z":"050c60654a910e68","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":600,"wires":[["b08aef3e9a7c901b"]]},{"id":"300dfabdcd908fd9","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":120,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"e58d38a7afe6e5e5","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":180,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"9bdf1086b4bdec91","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":240,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"2c104887531dbd31","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":300,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"eaeda3c13f3fda3b","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":360,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"d616641422d1e85a","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":420,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"09152de118411910","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":480,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"af75c05a4a5d4955","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":540,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"e3b0c1e807acb20b","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeoutSeconds","timeoutType":"jsonata","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":610,"y":600,"wires":[["4a0d1a73e7adcc11"],["1734e70678e4e3fe"]]},{"id":"87d844bd45fccde6","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":60,"wires":[["d3ca50e2799953d7"]]},{"id":"af650c007ffa4b39","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":120,"wires":[["300dfabdcd908fd9"]]},{"id":"1ac121c8d607267c","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":180,"wires":[["e58d38a7afe6e5e5"]]},{"id":"1d64b1cbe71c8c65","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":240,"wires":[["9bdf1086b4bdec91"]]},{"id":"9c265cc1eaad53bb","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"4","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":300,"wires":[["2c104887531dbd31"]]},{"id":"69317bea361bf45e","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":360,"wires":[["eaeda3c13f3fda3b"]]},{"id":"9d50472878b093d6","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"6","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":420,"wires":[["d616641422d1e85a"]]},{"id":"ab3f5f1f4b645507","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"7","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":480,"wires":[["09152de118411910"]]},{"id":"9147624e46fd3b8b","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"8","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":540,"wires":[["af75c05a4a5d4955"]]},{"id":"e6e0a2f4b0faf93f","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"9","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":600,"wires":[["e3b0c1e807acb20b"]]},{"id":"b08aef3e9a7c901b","type":"link out","z":"050c60654a910e68","name":"link out 353","mode":"link","links":["dd24f19d09420eb6"],"x":915,"y":600,"wires":[]},{"id":"dd24f19d09420eb6","type":"link in","z":"050c60654a910e68","name":"link in 368","links":["b08aef3e9a7c901b"],"x":465,"y":60,"wires":[["d3ca50e2799953d7","300dfabdcd908fd9","e58d38a7afe6e5e5","9bdf1086b4bdec91","2c104887531dbd31","eaeda3c13f3fda3b","d616641422d1e85a","09152de118411910","af75c05a4a5d4955","e3b0c1e807acb20b"]]},{"id":"4095fa2ccd977940","type":"change","z":"050c60654a910e68","name":"","rules":[{"t":"delete","p":"wait_entity_id","pt":"msg"},{"t":"delete","p":"wait_state","pt":"msg"},{"t":"delete","p":"timeoutSeconds","pt":"msg"},{"t":"delete","p":"waits","pt":"msg"},{"t":"delete","p":"states","pt":"msg"},{"t":"delete","p":"count","pt":"msg"},{"t":"delete","p":"sendOnTimeout","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":60,"wires":[["cbbaf5fe1d43c359"]]},{"id":"cbbaf5fe1d43c359","type":"delay","z":"050c60654a910e68","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":1230,"y":60,"wires":[[]]},{"id":"263cb54347d897c3","type":"switch","z":"050c60654a910e68","name":"sendOnTimeout ?","property":"sendOnTimeout","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":870,"y":60,"wires":[["4095fa2ccd977940"]]},{"id":"7a326f951564d5db","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":60,"wires":[["cc4e9a25b741e5b5"],["983c576accbdd1a8"]]},{"id":"f51dc77777d8f60b","type":"function","z":"7166242293a03ec9","name":"count","func":"let ambiances = global.get(\"ambiances\") || {};\nlet linkedAmbiance = msg.linkedAmbiance;\n\nmsg.count = Object.keys(ambiances).indexOf(msg.linkedAmbiance);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["4f25dbc1a164f41f"]]},{"id":"7f0acd26f3c01f74","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":120,"wires":[["df96ad23721c9b37"],["c4ce766bfba99f60"]]},{"id":"939c33b32ba14e28","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":180,"wires":[["a3910fff73ce4d4b"],["02bd6203821573d6"]]},{"id":"bd39a0530a2296c9","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":240,"wires":[["3f899843af04db15"],["494b9ad847029c04"]]},{"id":"47f76380129d7466","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":300,"wires":[["c1144f4ae8809948"],["a0dc0c93931f1e10"]]},{"id":"544c5beb752c4b83","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":360,"wires":[["13014577787c3ec1"],["9c17c037cc291546"]]},{"id":"cc4e9a25b741e5b5","type":"link out","z":"7166242293a03ec9","name":"link out 376","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":60,"wires":[]},{"id":"907c1f317e2ca3ee","type":"link in","z":"7166242293a03ec9","name":"link in 384","links":["cc4e9a25b741e5b5","df96ad23721c9b37","a3910fff73ce4d4b","3f899843af04db15","c1144f4ae8809948","13014577787c3ec1","5584a83a9faa2c1b"],"x":735,"y":60,"wires":[[]]},{"id":"983c576accbdd1a8","type":"link out","z":"7166242293a03ec9","name":"link out 377","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":60,"wires":[]},{"id":"c728ac07d0d13bab","type":"link in","z":"7166242293a03ec9","name":"link in 385","links":["983c576accbdd1a8","c4ce766bfba99f60","02bd6203821573d6","494b9ad847029c04","a0dc0c93931f1e10","9c17c037cc291546","d4ac5377eff74978"],"x":735,"y":120,"wires":[["b7354c936912ab1e"]]},{"id":"df96ad23721c9b37","type":"link out","z":"7166242293a03ec9","name":"link out 378","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":120,"wires":[]},{"id":"c4ce766bfba99f60","type":"link out","z":"7166242293a03ec9","name":"link out 379","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":120,"wires":[]},{"id":"a3910fff73ce4d4b","type":"link out","z":"7166242293a03ec9","name":"link out 380","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":180,"wires":[]},{"id":"02bd6203821573d6","type":"link out","z":"7166242293a03ec9","name":"link out 381","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":180,"wires":[]},{"id":"3f899843af04db15","type":"link out","z":"7166242293a03ec9","name":"link out 382","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":240,"wires":[]},{"id":"494b9ad847029c04","type":"link out","z":"7166242293a03ec9","name":"link out 383","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":240,"wires":[]},{"id":"c1144f4ae8809948","type":"link out","z":"7166242293a03ec9","name":"link out 384","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":300,"wires":[]},{"id":"a0dc0c93931f1e10","type":"link out","z":"7166242293a03ec9","name":"link out 385","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":300,"wires":[]},{"id":"13014577787c3ec1","type":"link out","z":"7166242293a03ec9","name":"link out 386","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":360,"wires":[]},{"id":"9c17c037cc291546","type":"link out","z":"7166242293a03ec9","name":"link out 387","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":360,"wires":[]},{"id":"ae7861968403f307","type":"switch","z":"7166242293a03ec9","name":"count 1","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":120,"wires":[["7f0acd26f3c01f74"]]},{"id":"e113ddcda7707d78","type":"switch","z":"7166242293a03ec9","name":"count 2","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":180,"wires":[["939c33b32ba14e28"]]},{"id":"cface082c3f3571c","type":"switch","z":"7166242293a03ec9","name":"count 3","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":240,"wires":[["bd39a0530a2296c9"]]},{"id":"f83935731bab2f93","type":"switch","z":"7166242293a03ec9","name":"count 4","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"4","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":300,"wires":[["47f76380129d7466"]]},{"id":"7b8515b9f1fccf72","type":"switch","z":"7166242293a03ec9","name":"count 5","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":360,"wires":[["544c5beb752c4b83"]]},{"id":"4f25dbc1a164f41f","type":"link out","z":"7166242293a03ec9","name":"link out 388","mode":"link","links":["346607f7f851b121","87ebde6adf601137","3a0148158457edf5","4cd60f8b7145da89","4272daeffcf81037","fe1c9b9ece62fe4b"],"x":265,"y":60,"wires":[]},{"id":"346607f7f851b121","type":"link in","z":"7166242293a03ec9","name":"link in 386","links":["4f25dbc1a164f41f"],"x":335,"y":60,"wires":[["56f6adecc2b7c507"]]},{"id":"87ebde6adf601137","type":"link in","z":"7166242293a03ec9","name":"link in 387","links":["4f25dbc1a164f41f"],"x":335,"y":120,"wires":[["ae7861968403f307"]]},{"id":"3a0148158457edf5","type":"link in","z":"7166242293a03ec9","name":"link in 388","links":["4f25dbc1a164f41f"],"x":335,"y":180,"wires":[["e113ddcda7707d78"]]},{"id":"4cd60f8b7145da89","type":"link in","z":"7166242293a03ec9","name":"link in 389","links":["4f25dbc1a164f41f"],"x":335,"y":240,"wires":[["cface082c3f3571c"]]},{"id":"4272daeffcf81037","type":"link in","z":"7166242293a03ec9","name":"link in 390","links":["4f25dbc1a164f41f"],"x":335,"y":300,"wires":[["f83935731bab2f93"]]},{"id":"fe1c9b9ece62fe4b","type":"link in","z":"7166242293a03ec9","name":"link in 391","links":["4f25dbc1a164f41f"],"x":335,"y":360,"wires":[["7b8515b9f1fccf72"]]},{"id":"b7354c936912ab1e","type":"api-call-service","z":"7166242293a03ec9","name":"select ambiance","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"input_select.{{linkedAmbiance}}\",\"option\":\"{{option}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":860,"y":120,"wires":[[]]},{"id":"56f6adecc2b7c507","type":"switch","z":"7166242293a03ec9","name":"count 0","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":60,"wires":[["7a326f951564d5db"]]},{"id":"68969b8280827750","type":"function","z":"515fe2385f553c95","name":"mode dev ?","func":"let user_configuration = global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config;\n\nif (\"mode\" in user_configuration && user_configuration.mode == \"dev\") {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":80,"wires":[[],[]]},{"id":"8fb791d85072ddee","type":"function","z":"94b2243985840d69","name":"isRunning","func":"let is_running = global.get(\"homeassistant\").homeAssistant.isRunning;\nlet is_connected = global.get(\"homeassistant\").homeAssistant.isConnected;\n\nif (is_connected && is_running) {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":80,"wires":[[]]},{"id":"febc11290421c3af","type":"api-current-state","z":"94b2243985840d69","name":"config loaded","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"loaded","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.user_configuration","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":80,"wires":[["8fb791d85072ddee"],[]]},{"id":"466e65d315aca28f","type":"function","z":"3da7ebfd83a38899","name":"search entities","func":"let user_configuration = global.get(\"user_configuration\") || {};\nlet ha_states = global.get(\"homeassistant\").homeAssistant.states;\nlet found = [];\n\nfor (let entity_id of Object.keys(ha_states)) {\n    let entity = ha_states[entity_id];\n    if (entity_id in user_configuration) {\n        entity = { ...entity, ...user_configuration[entity_id] };\n    }\n    let entity_search = { ...entity, ...entity.attributes };\n    if (search(entity_search)) {\n        entity.state = isNaN(entity.state) ? entity.state : parseFloat(entity.state);\n        found.push(entity);\n    }\n}\n\nlet outputEmptyResults = msg.outputEmptyResults == undefined || msg.outputEmptyResults == true || msg.outputEmptyResults == false && found.length != 0;\nif (outputEmptyResults) {\n    msg[msg.output_name] = found;\n    delete msg.output_name;\n    delete msg.search;\n    return msg;\n}\n\nfunction search(entity) {\n    if (\"is\" in msg.search) {\n        for (let search_key of Object.keys(msg.search[\"is\"])) {\n            if (!(search_key in entity && entity[search_key] == msg.search[\"is\"][search_key])) {\n                return false;\n            }\n        }\n    }\n    if (\"not\" in msg.search) {\n        for (let search_key of Object.keys(msg.search[\"not\"])) {\n            if (search_key in entity && entity[search_key] == msg.search[\"not\"][search_key]) {\n                return false;\n            }\n        }\n    }\n    return true;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[[]]},{"id":"9d3ad0a23db6a2ce","type":"subflow:6c4028aab794d52d","z":"27148b7bb9f62ac7","name":"","x":170,"y":180,"wires":[["a938cb7f0804c121"]]},{"id":"e53334a6f05a9609","type":"link in","z":"27148b7bb9f62ac7","name":"notification","links":["ad446eefb7df13b9","db2a87c1d25e790a","53f20c1b123f35a2","9efffdb0ef885bb8","604d97b1c4befed2","9cbe78b2241026d2","041e52487b294778","3108493db991645d","45af9fa28332c9ea","b2f601230d55ad01","774ae1c614b41638","ec3a162f37ac727a","18d4b11011f0c20b","ba78b5e5c855646d","ced63105eee2903b","2293fd1b7eb68348","12db0960dcc59044","6be74e8ddda30b40","f02a5c5bf62e5e0c","2e001b7d46b62357","a546510700c89455","ebc79424c9266d44","b8a8b2386a16ebe3","26bf77adbe18a8c6","08c93702f30dea3a","d9c985b15cd4cd54","08aa6a694a30f006","93218896eff01151","8eef2ad2d99d780f","7ed2b9fc73f864e3","743f5fda8b689c2c","cbe89428a1bce3d2","41c03bb8a071fda7","33c24c7c52435205","2ca739e1baf94b4b","bc565cb3613c2eb8","2b960bc7d3565741","fc6f9a12ca3d3c25","c5c8bf8009943bf5","4081f75de6cc9b4f","3fc43a2dd10bba99","430ec4e954d98214","94a976c93bbf5c7c","6f459ab11a551418","0dc804fe20ae0d4a","4c7682a3d69b57a1","12947aaf7b3ad675","47e4fe779b75e0dc","2f8a3219e659722d","3b3dd6b16a5c5a1d","625506e86313414c","b968a370a50879c2","af0c165af5996110","44cc7e9e6d381e92","9a6820da31f5f8c4","6be572081dbc1f5e","52b65d8b6654ec74","5c035d30aa0eeaa4","7d3680cb51e9a73b","8d3c03ad03424be9","79bed2e01b3c45b2","76fb792d29bc5033","6a698c348a5afd7f","63efd697ac220b54","e51da1918a44be94","75d5db782b894554","1d4468c8556ba47e","a936271dd89f427d","76cea9e99f705380","ce168531822379e5","b0b79d3deb65d8fe","088f2437bb522d14","d48720fd882e22d5","a29ff8eb2add5721","0419929f6aea7cca","840e0643e8c84153","8f441bcf81b709f5","4276df6b64e92d2f","0c17e620da4e364a","27ce4ecdecc58ff1","a9f60d370046baba","e0ef49bdc4624b93","fe7db153e4105d50","8ff031019adb02ce","4eab8cffd742e405","4d571b7c3108dd2f","353c66956843b017","a3e74de8eb040f0a","fe323330d6e30f26","9b46c6b0bd9da6ae","808562788b6f03e3","482038817b9e0cbb","f231ffba1f31bb29","2c0b3bb40e4d7109","dedd25ffe23fb928"],"x":55,"y":180,"wires":[["9d3ad0a23db6a2ce"]]},{"id":"cd472edfb4e940af","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"zone.home","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"zone.home","entityidfiltertype":"exact","outputinitially":false,"state_type":"num","haltifstate":"","halt_if_type":"num","halt_if_compare":"gt","outputs":1,"output_only_on_state_change":false,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":480,"y":180,"wires":[["a938cb7f0804c121"]]},{"id":"a938cb7f0804c121","type":"function","z":"27148b7bb9f62ac7","name":"recap","func":"let notifications = global.get(\"notifications\") || {};\nlet notificationsKeys = Object.keys(notifications);\nlet msgs = [];\nlet txt = \"\";\n\nlet d = new Date();\nlet currentMonth = d.getMonth() + 1;\nlet currentDay = d.getDate();\n\nlet home_invitation = getState(\"input_boolean.home_invitation\") == \"on\";\nif (home_invitation) {\n    txt += \"<center><h2>Mode invitation actif \" + (notificationsKeys.length == 0 ? \"âœ…\" : \":\") + \"</h2>\";\n} else {\n    txt += \"<center><h2>Notifications \" + (notificationsKeys.length == 0 ? \"âœ…\" : \":\") + \"</h2>\";\n}\n\nlet first = true;\nlet alertPriority = { \"error\": 1, \"warning\": 2, \"success\": 3, \"info\": 4 };\nnotificationsKeys.sort(function (a, b) { return alertPriority[notifications[a].alertType] - alertPriority[notifications[b].alertType] });\nfor (let key of notificationsKeys) {\n    if (notifications[key].alertType != \"\") {\n        txt += (!first ? '<br>' : '') + '<ha-alert alert-type=\"' + notifications[key].alertType + '\" >' + dateToDisplay(notifications[key].creationDate) + notifications[key].message + \"</ha-alert>\";\n    } else {\n        txt += notifications[key].title;\n    }\n    first = false;\n}\ntxt += \"</center>\";\n\nlet gap = 0;\nfor (let i = 0; i < 6; i++) {\n    msgs.push({\n        payload: {\n            data: {\n                entity_id: \"input_text.recap_\" + (i + 1),\n                value: txt.substring(gap, (gap + 254))\n            }\n        }\n    });\n    gap += 254;\n}\nreturn [msgs];\n\nfunction getState(entity_id) {\n    if (entity_id in global.get(\"homeassistant\").homeAssistant.states) {\n        return global.get(\"homeassistant\").homeAssistant.states[entity_id].state;\n    } else {\n        return \"\";\n    }\n}\n\nfunction dateToDisplay(notifCreationDate) {\n    let monthTradFr = {\n        1: \"Janvier\",\n        2: \"FÃ©vrier\",\n        3: \"Mars\",\n        4: \"Avril\",\n        5: \"Mai\",\n        6: \"Juin\",\n        7: \"Juillet\",\n        8: \"AoÃ»t\",\n        9: \"Septembre\",\n        10: \"Octobre\",\n        11: \"Novembre\",\n        12: \"DÃ©cembre\"\n    };\n\n    let notifCreationDateSplit = notifCreationDate.split(\" \");\n    let notifMonth = parseInt(notifCreationDateSplit[0]);\n    let notifDay = parseInt(notifCreationDateSplit[1]);\n    let notifHour = notifCreationDateSplit[2];\n\n    if (currentDay == notifDay && currentMonth == notifMonth) {\n        return notifHour + \" : \";\n    } else if (currentDay - notifDay == 1 && currentMonth == notifMonth) {\n        return \"Hier Ã  \" + notifHour + \" : \";\n    } else if (currentDay - notifDay == 2 && currentMonth == notifMonth) {\n        return \"Avant-hier Ã  \" + notifHour + \" : \";\n    } else {\n        return \"Le \" + notifDay + \" \" + monthTradFr[notifMonth] + \" \" + notifHour + \" : \";\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":180,"wires":[["b2117e5ba2e72803"]]},{"id":"b2117e5ba2e72803","type":"api-call-service","z":"27148b7bb9f62ac7","name":"recap","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":180,"wires":[[]]},{"id":"db30a1d2a0b1285b","type":"catch","z":"27148b7bb9f62ac7","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["167b698e879b353d"]]},{"id":"e3ba334aa41a02a2","type":"subflow:ad3b29a5dd67898f","z":"27148b7bb9f62ac7","name":"","x":460,"y":40,"wires":[]},{"id":"167b698e879b353d","type":"change","z":"27148b7bb9f62ac7","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Core","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["e3ba334aa41a02a2"]]},{"id":"127167b2550a2c1c","type":"comment","z":"27148b7bb9f62ac7","name":"Notifications ++","info":"Object.entries(windows).forEach(([key, value]) => {\n    \n});\n________________________________________________________________________________\nconst array1 = [true, false, true, true];\nconst initialValue = true;\nconst sumWithInitial = array1.reduce(\n  (accumulator, currentValue) => accumulator && currentValue,\n  initialValue\n);\n________________________________________________________________________________\nlight.attributes.supported_color_modes ?? []).some(mode => mode == \"hs\")\n________________________________________________________________________________","x":120,"y":120,"wires":[]},{"id":"f2abe23402efadfd","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set ambiance options","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"options\":\"{{options}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":640,"y":900,"wires":[[]]},{"id":"48bffb9a97588b9d","type":"function","z":"27148b7bb9f62ac7","name":"prepare options","func":"let ambiance_config = global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config.ambiance_config;\nlet ambiances = msg.ambiances;\nlet options = [];\nlet msgs = [];\n\nlet ambiancesTypeKeys = Object.keys(ambiance_config.ambiances_type);\nfor (let key of ambiancesTypeKeys) {\n    options.push(ambiance_config.ambiances_type[key].name);\n}\n\nfor (let ambiance of ambiances) {\n    msgs.push({ payload: { data: { entity_id: ambiance.entity_id, options: options } } });\n}\nreturn [msgs];\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":900,"wires":[["f2abe23402efadfd"]]},{"id":"ba01e397c4ca1e22","type":"link in","z":"27148b7bb9f62ac7","name":"ambiances restore","links":["5a948d8bd3b54aed","3d2f45f48310eee2"],"x":55,"y":900,"wires":[["9cdcdc57bc2d3d28"]]},{"id":"0ed667140490b99e","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"sun","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":600,"wires":[["7cbc86e2587fe991"]]},{"id":"7cbc86e2587fe991","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set elevation","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.elevation"],"data":"{\"value\":\"{{data.new_state.attributes.elevation}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":230,"y":600,"wires":[[]]},{"id":"dd906c00889a2c63","type":"comment","z":"27148b7bb9f62ac7","name":"Elevation","info":"","x":100,"y":540,"wires":[]},{"id":"3fc94c7a8b2de5ee","type":"comment","z":"27148b7bb9f62ac7","name":"Global context management","info":"","x":160,"y":780,"wires":[]},{"id":"584269b4c105222c","type":"link in","z":"27148b7bb9f62ac7","name":"notifications restore","links":["5a948d8bd3b54aed"],"x":55,"y":1020,"wires":[["49f2b6bf5afc8498"]]},{"id":"aad51a0c3f56d775","type":"function","z":"27148b7bb9f62ac7","name":"restore notifications","func":"let notifications = msg.payload;\nlet notificationsKeys = Object.keys(notifications);\nlet msgs = [];\n\nfor (let key of notificationsKeys) {\n    msgs.push({\n        notification_id: key,\n        count: notifications[key].count,\n        alertType: \"alertType\" in notifications[key] ? notifications[key].alertType : \"info\",\n        title: \"title\" in notifications[key] ? notifications[key].title : \"\",\n        message: \"message\" in notifications[key] ? notifications[key].message : \"\",\n        zone: \"zone\" in notifications[key] ? notifications[key].zone : [\"inside\", \"outside\"],\n        creationDate: \"creationDate\" in notifications[key] ? notifications[key].creationDate : \"???\",\n        restore: true\n    });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":1020,"wires":[["63efd697ac220b54"]]},{"id":"63efd697ac220b54","type":"link out","z":"27148b7bb9f62ac7","name":"link out 448","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":655,"y":1020,"wires":[]},{"id":"49f2b6bf5afc8498","type":"file in","z":"27148b7bb9f62ac7","name":"get yaml notifications","filename":"/config/notifications/notifications.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":200,"y":1020,"wires":[["8913f23a70c4a6cc"]]},{"id":"8913f23a70c4a6cc","type":"yaml","z":"27148b7bb9f62ac7","property":"payload","name":"","x":370,"y":1020,"wires":[["aad51a0c3f56d775"]]},{"id":"7deedc3475102ca6","type":"server-events","z":"27148b7bb9f62ac7","name":"home assistant","server":"c87720f17866318d","version":2,"eventType":"home_assistant_client","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":false,"outputProperties":[],"event_type":"","x":120,"y":840,"wires":[["99bdec3abdaf5451"]]},{"id":"99bdec3abdaf5451","type":"switch","z":"27148b7bb9f62ac7","name":"services_loaded","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"services_loaded","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":300,"y":840,"wires":[["5a948d8bd3b54aed","f12cfbd15101f5d5"]]},{"id":"5a948d8bd3b54aed","type":"link out","z":"27148b7bb9f62ac7","name":"ha reload","mode":"link","links":["050b8001f7eaea33","452940835a2fedcc","584269b4c105222c","84edd99e67b149d7","ba01e397c4ca1e22","c9e86dec4531c834","8f174bd692ae791b","ca8164fd135084a0","0bd80225f89703f5"],"x":955,"y":840,"wires":[]},{"id":"9cdcdc57bc2d3d28","type":"function","z":"27148b7bb9f62ac7","name":"ambiance_select >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"ambiance_select\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"ambiances\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":900,"wires":[["5f1dc613814f6d49"]]},{"id":"5f1dc613814f6d49","type":"subflow:ea5b93cde6b1bf0a","z":"27148b7bb9f62ac7","name":"","x":315,"y":900,"wires":[["48bffb9a97588b9d"]],"l":false},{"id":"84edd99e67b149d7","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["5a948d8bd3b54aed"],"x":55,"y":960,"wires":[["b53b2b58f8931a70"]]},{"id":"b53b2b58f8931a70","type":"function","z":"27148b7bb9f62ac7","name":"persons >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"person\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"persons\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":960,"wires":[["06d427cb14259c84"]]},{"id":"06d427cb14259c84","type":"subflow:ea5b93cde6b1bf0a","z":"27148b7bb9f62ac7","name":"","x":255,"y":960,"wires":[["0b9c1b04fb16415e"]],"l":false},{"id":"0b9c1b04fb16415e","type":"function","z":"27148b7bb9f62ac7","name":"linked devices >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedPerson\",\n        logic: \"is\",\n        value: msg.persons.map(p => p.entity_id).join(\",\"),\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"persons_devices\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":960,"wires":[["bc5276def16de55f"]]},{"id":"bc5276def16de55f","type":"subflow:ea5b93cde6b1bf0a","z":"27148b7bb9f62ac7","name":"","x":495,"y":960,"wires":[["8cebe9b921fa05e3"]],"l":false},{"id":"8cebe9b921fa05e3","type":"function","z":"27148b7bb9f62ac7","name":"set devices","func":"let msgs = [];\n\nfor (let device of msg.persons_devices) {\n    if (device.linkedClass != \"phone_state\") {\n        device.new_state = device.state;\n        delete device.state;\n        msgs.push({ target: \"target_\" + device.linkedClass, ...device });\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":960,"wires":[["d3bf6d20bb25269a"]]},{"id":"d3bf6d20bb25269a","type":"link call","z":"27148b7bb9f62ac7","name":"target","links":[],"linkType":"dynamic","timeout":"30","x":750,"y":960,"wires":[[]]},{"id":"f12cfbd15101f5d5","type":"api-call-service","z":"27148b7bb9f62ac7","name":"set user_configuration","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":["input_select.user_configuration"],"data":"{\"options\":[\"loaded\"]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":700,"y":840,"wires":[[]]},{"id":"db5541dd11159b50","type":"function","z":"27148b7bb9f62ac7","name":"loaded","func":"if (msg.state == \"loaded\") {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":840,"wires":[["5a948d8bd3b54aed"]]},{"id":"03c9373f52386ad4","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"user_configuration","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_select.user_configuration","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"x":490,"y":840,"wires":[["db5541dd11159b50","f12cfbd15101f5d5"]]},{"id":"050b8001f7eaea33","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["5a948d8bd3b54aed"],"x":55,"y":1140,"wires":[["b9e8d0ecd9f0d518"]]},{"id":"b9e8d0ecd9f0d518","type":"api-call-service","z":"27148b7bb9f62ac7","name":"control_device toogle","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"toggle","areaId":[],"deviceId":[],"entityId":["input_boolean.control_device"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":200,"y":1140,"wires":[[]]},{"id":"e8d7a0d8c6db6743","type":"inject","z":"27148b7bb9f62ac7","name":"new day","props":[],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","x":340,"y":180,"wires":[["a938cb7f0804c121"]]},{"id":"db36ccd58e5e8fe5","type":"comment","z":"27148b7bb9f62ac7","name":"Purge history > 3 days","info":"","x":140,"y":660,"wires":[]},{"id":"856c82e57e2036eb","type":"api-call-service","z":"27148b7bb9f62ac7","name":"purge history > 3 days","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"recorder","service":"purge","areaId":[],"deviceId":[],"entityId":[],"data":"{\"keep_days\":\"3\",\"repack\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":720,"wires":[[]]},{"id":"41b67fc81e236cd9","type":"inject","z":"27148b7bb9f62ac7","name":"every day 4:00","props":[],"repeat":"","crontab":"00 04 * * *","once":false,"onceDelay":0.1,"topic":"","x":140,"y":720,"wires":[["856c82e57e2036eb"]]},{"id":"0bd80225f89703f5","type":"link in","z":"27148b7bb9f62ac7","name":"persons restore","links":["5a948d8bd3b54aed"],"x":55,"y":1080,"wires":[["4054e84cdc0c98b7"]]},{"id":"4054e84cdc0c98b7","type":"function","z":"27148b7bb9f62ac7","name":"jsons setup","func":"let json_entities = [\"json_exterior_average_temp\", \"json_activities\"];\nlet msgs = [];\n\nfor (let json_entity of json_entities) {\n    let entity_id = \"input_text.\" + json_entity;\n    let state = global.get(\"homeassistant\").homeAssistant.states[entity_id].state;\n    if (state == \"unknown\" || state == \"\") {\n        msgs.push({\n            entity_id: entity_id,\n            state: \"{}\",\n            stateTEST: state\n        });\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":1080,"wires":[["83418366d18d13c0"]]},{"id":"83418366d18d13c0","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":350,"y":1080,"wires":[]},{"id":"26bcf1d6a09e471e","type":"comment","z":"27148b7bb9f62ac7","name":"Silent speaker","info":"","x":110,"y":360,"wires":[]},{"id":"9dcc1ae8cc20b65a","type":"ha-time","z":"27148b7bb9f62ac7","name":"speaker_day_mode_start","server":"c87720f17866318d","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityId":"input_datetime.speaker_day_mode_start","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"on","valueType":"str"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"debugenabled":false,"x":150,"y":480,"wires":[["c5e63c48021dd824"]]},{"id":"da07923216b0a4c5","type":"ha-time","z":"27148b7bb9f62ac7","name":"speaker_night_mode_start","server":"c87720f17866318d","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityId":"input_datetime.speaker_night_mode_start","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"off","valueType":"str"}],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"debugenabled":false,"x":450,"y":480,"wires":[["b75d924f0f74062b"]]},{"id":"b75d924f0f74062b","type":"function","z":"27148b7bb9f62ac7","name":"prepare silent speaker","func":"msg.entity_id = \"input_boolean.speaker_day_night_mode\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":595,"y":480,"wires":[["d124e466c357cf58"]],"l":false},{"id":"d124e466c357cf58","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":770,"y":480,"wires":[]},{"id":"c5e63c48021dd824","type":"delay","z":"27148b7bb9f62ac7","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":295,"y":480,"wires":[["b75d924f0f74062b"]],"l":false},{"id":"b9a6aaa07ad593b3","type":"comment","z":"27148b7bb9f62ac7","name":"Exterior average temperature","info":"","x":160,"y":240,"wires":[]},{"id":"e84323b7060d35b5","type":"function","z":"27148b7bb9f62ac7","name":"average calc","func":"let average = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state);\nlet temperatures = global.get(\"temperatures\") || {};\nmsg.entity_id = \"input_text.json_exterior_average_temp\";\n\nif (\"exterior\" in temperatures && \"value\" in temperatures[\"exterior\"] && temperatures[\"exterior\"].online) {\n    if (!Array.isArray(average)) {\n        average = [temperatures[\"exterior\"].value, 1];\n    } else if (Array.isArray(average) && average.length == 2 && average[1] < 10) {\n        average[0] = calculateAverage(average);\n        average[1]++;\n    } else {\n        average[0] = calculateAverage(average);\n    }\n    msg.state = JSON.stringify(average);\n    return msg;\n}\n\nfunction calculateAverage(average) {\n    return Math.round(((average[0] * average[1] + temperatures[\"exterior\"].value) / (average[1] + 1)) * 100) / 100;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":300,"wires":[["1ad4b607c1170bc5"]]},{"id":"1ad4b607c1170bc5","type":"subflow:723d4991c3c87385","z":"27148b7bb9f62ac7","name":"","x":410,"y":300,"wires":[]},{"id":"4f4a945985181968","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"speaker_day_mode_start","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_datetime.speaker_day_mode_start","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":150,"y":420,"wires":[["d9f90fff51629bfc"]]},{"id":"0e4bb86829bf1666","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"speaker_night_mode_start","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_datetime.speaker_night_mode_start","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":390,"y":420,"wires":[["d9f90fff51629bfc"]]},{"id":"d9f90fff51629bfc","type":"function","z":"27148b7bb9f62ac7","name":"update silent speaker","func":"let speaker_day_mode_start = global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_day_mode_start\"].state;\nlet speaker_night_mode_start = global.get(\"homeassistant\").homeAssistant.states[\"input_datetime.speaker_night_mode_start\"].state;\n\nlet d = new Date();\nlet hours = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minutes = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\nlet local_time = hours + \":\" + minutes + \":00\";\n\nmsg.entity_id = \"input_boolean.speaker_day_night_mode\";\nmsg.state = speaker_day_mode_start < local_time && local_time < speaker_night_mode_start ? \"on\" : \"off\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":420,"wires":[["b143da5222c5f445"]]},{"id":"b143da5222c5f445","type":"link out","z":"27148b7bb9f62ac7","name":"link out 543","mode":"link","links":["3ef30ee4463971f3"],"x":755,"y":420,"wires":[]},{"id":"3ef30ee4463971f3","type":"link in","z":"27148b7bb9f62ac7","name":"link in 489","links":["b143da5222c5f445"],"x":645,"y":480,"wires":[["d124e466c357cf58"]]},{"id":"39e1b99a8ff7858d","type":"server-state-changed","z":"27148b7bb9f62ac7","name":"sun","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":300,"wires":[["e84323b7060d35b5"]]},{"id":"f4d89516f1e863ef","type":"catch","z":"1131f5463c30e69b","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["50b8e23913c58ae0"]]},{"id":"54e2df504c7a567e","type":"subflow:ad3b29a5dd67898f","z":"1131f5463c30e69b","name":"","x":460,"y":40,"wires":[]},{"id":"50b8e23913c58ae0","type":"change","z":"1131f5463c30e69b","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Inputs","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["54e2df504c7a567e"]]},{"id":"6fc769e69bd79c9f","type":"comment","z":"1131f5463c30e69b","name":"linkedClass : ext_temp | int_temp ","info":"","x":170,"y":240,"wires":[]},{"id":"f79396f4f67dd89e","type":"comment","z":"1131f5463c30e69b","name":"linkedClass : ext_humidity | int_humidity","info":"","x":190,"y":420,"wires":[]},{"id":"7ba3931adcd96cf3","type":"link out","z":"1131f5463c30e69b","name":"detect windows","mode":"link","links":["3c7a2e7e55e2ba48","a9d131c4dbe11860","4550f0d954a61c36","f4d57076103097ca","89757e1c8fa070bb","cef915ce5dd73305"],"x":1345,"y":780,"wires":[]},{"id":"a20a33d469d152cb","type":"comment","z":"1131f5463c30e69b","name":"linkedClass :  window","info":"","x":130,"y":720,"wires":[]},{"id":"d4bd76d5ef491c1f","type":"link out","z":"1131f5463c30e69b","name":"detect motion on","mode":"link","links":["06656b50ad8cb96f","3c7a2e7e55e2ba48","c8961e8203b2cf99","417c65de22f57c58","13a390949bac6841","7abd739d866737c4","c0617f3319a72d37","fbc1c0ac1d7bec76","20da1d1d997c0428","2ac1c7da511dbdd8","4550f0d954a61c36","f4d57076103097ca","89757e1c8fa070bb"],"x":1345,"y":900,"wires":[]},{"id":"300f88b01cfae98b","type":"comment","z":"1131f5463c30e69b","name":"linkedClass : motion","info":"","x":130,"y":840,"wires":[]},{"id":"a620a4c78de1701c","type":"server-state-changed","z":"1131f5463c30e69b","name":"in_middle_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_middle_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":1020,"wires":[[],["2e012c129f161e32"]]},{"id":"2e012c129f161e32","type":"function","z":"1131f5463c30e69b","name":"area_motions off","func":"let area_motions = global.get(\"area_motions\") || {};\nlet motions = flow.get(\"motions\") || {};\nlet msgs = [];\n\nfor (let key of Object.keys(area_motions)) {\n    if (area_motions[key] != \"off\") {\n        msgs.push({ linkedClass: \"motion\", linkedArea: key, state: \"off\" });\n        area_motions[key] = \"off\";\n\n    }\n}\n\nfor (let key of Object.keys(motions)) {\n    motions[key].state = \"off\";\n}\n\nglobal.set(\"area_motions\", area_motions);\nflow.set(\"motions\", motions);\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":1020,"wires":[["ee45f510187e296e"]]},{"id":"bc0e069e4d5ee51f","type":"link out","z":"1131f5463c30e69b","name":"detect motion all off","mode":"link","links":["c8961e8203b2cf99","13a390949bac6841","20da1d1d997c0428","fbc1c0ac1d7bec76"],"x":1345,"y":1020,"wires":[]},{"id":"f53debfbd7e61a77","type":"comment","z":"1131f5463c30e69b","name":"linkedClass : cube","info":"","x":130,"y":1200,"wires":[]},{"id":"cb0e6be6e4b65e0f","type":"server-events","z":"1131f5463c30e69b","name":"detect cubes","server":"c87720f17866318d","version":2,"eventType":"xiaomi_aqara.cube_action","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"x":110,"y":1260,"wires":[["ad7f65d73e905da5"]]},{"id":"7f2cec1b57f240b7","type":"link out","z":"1131f5463c30e69b","name":"cube","mode":"link","links":["bab2c7afb8981886","17df8120f9c53aca"],"x":1345,"y":1260,"wires":[]},{"id":"095b17c8bdaf5eaa","type":"function","z":"1131f5463c30e69b","name":"set cubes","func":"let lightColorOptions = [0, 36, 72, 108, 144, 180, 216, 252, 288, 324];\nlet cubes = global.get(\"cubes\") || {};\nlet msgs = [];\n\nif (!(msg.entity_id in cubes)) {\n    cubes[msg.entity_id] = { move: true, flip90: false, flip180: false, shake_air: false, free_fall: false, lightPower: 50, lightColor: 1 };\n    msg.action_type = \"flip90\";\n}\n\nif (msg.action_type == \"flip180\") {\n    msgs.push({\n        type: \"ambiance\",\n        entity_id: msg.linkedSelectAmbiance,\n        action_type: \"select_option\",\n        payload: { data: { option: randomAmbiance(global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config.ambiance_config.ambiances_type) } }\n    });\n    return saveAndReturn();\n} else if (msg.action_type == \"flip90\") {\n    if (!cubes[msg.entity_id].flip180) {\n        if (!cubes[msg.entity_id].flip90) {\n            cubes[msg.entity_id].flip90 = true;\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n            msg.sound = \"light_auto_off.mp3\";\n        } else if (!cubes[msg.entity_id].move) {\n            cubes[msg.entity_id].move = true;\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        } else {\n            cubes[msg.entity_id].lightColor = cubes[msg.entity_id].lightColor + 1 > 9 ? 0 : cubes[msg.entity_id].lightColor + 1;\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        }\n        cubes[msg.entity_id].lightPower = lightPower();\n        cubes[msg.entity_id].free_fall = false;\n        cubes[msg.entity_id].move = true;\n        msg.lightPower = cubes[msg.entity_id].lightPower;\n        msg.colorTemp = 300;\n        msg.cube = cubes[msg.entity_id];\n        msgs.push({ ...msg, type: \"cube\" });\n        return saveAndReturn();\n    }\n} else if (msg.action_type == \"tap_twice\") {\n    if (cubes[msg.entity_id].flip90) {\n        cubes[msg.entity_id].flip90 = false;\n        cubes[msg.entity_id].free_fall = false;\n        msg.sound = \"light_auto_on.mp3\";\n        msg.cube = cubes[msg.entity_id];\n        msgs.push({ ...msg, type: \"cube\" });\n    } else if (cubes[msg.entity_id].flip180) {\n        cubes[msg.entity_id].flip180 = false;\n        cubes[msg.entity_id].free_fall = false;\n        msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: \"select_first\" });\n    }\n    return saveAndReturn();\n} else if (msg.action_type == \"shake_air\" && !cubes[msg.entity_id].free_fall) {\n    if (!cubes[msg.entity_id].flip90) {\n        cubes[msg.entity_id].flip90 = true;\n        msg.sound = \"light_auto_off.mp3\";\n    } else {\n        msg.sound = \"fall.mp3\";\n    }\n    cubes[msg.entity_id].shake_air = !cubes[msg.entity_id].shake_air;\n    msg.lightPower = cubes[msg.entity_id].lightPower;\n    msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n    msg.colorTemp = 300;\n    msg.cube = cubes[msg.entity_id];\n    msgs.push({ ...msg, type: \"cube\" });\n    return saveAndReturn();\n} else if (msg.action_type == \"rotate\" && !cubes[msg.entity_id].free_fall) {\n    if (!cubes[msg.entity_id].flip180) {\n        if (!cubes[msg.entity_id].flip90) {\n            cubes[msg.entity_id].flip90 = true;\n            msg.sound = \"light_auto_off.mp3\";\n        }\n        cubes[msg.entity_id].lightPower = lightPower();\n        msg.lightPower = cubes[msg.entity_id].lightPower;\n        msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        msg.cube = cubes[msg.entity_id];\n        msgs.push({ ...msg, type: \"cube\" });\n    } else {\n        let action_type = msg.action_value < 0 ? \"select_previous\" : \"select_next\";\n        msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: action_type });\n    }\n    return saveAndReturn();\n} else if (msg.action_type == \"free_fall\") {\n    if (!cubes[msg.entity_id].flip90) {\n        cubes[msg.entity_id].flip90 = true;\n        msg.sound = \"light_auto_off.mp3\";\n    } else {\n        msg.sound = \"fall.mp3\";\n    }\n    cubes[msg.entity_id].free_fall = !cubes[msg.entity_id].free_fall;\n    msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n    msg.lightPower = cubes[msg.entity_id].lightPower;\n    msg.colorTemp = 300;\n    msg.cube = cubes[msg.entity_id];\n    msgs.push({ ...msg, type: \"cube\" });\n    return saveAndReturn();\n} else if (msg.action_type == \"move\" && !cubes[msg.entity_id].free_fall) {\n    if (cubes[msg.entity_id].flip90) {\n        cubes[msg.entity_id].move = !cubes[msg.entity_id].move;\n        msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        msg.colorTemp = 300;\n        msg.cube = cubes[msg.entity_id];\n        msgs.push({ ...msg, type: \"cube\" });\n        return saveAndReturn();\n    }\n}\n\nfunction lightPower() {\n    let action_value = msg.action_value * msg.rotate_ratio;\n    if (cubes[msg.entity_id].lightPower + action_value >= 1 && cubes[msg.entity_id].lightPower + action_value <= 100) {\n        return cubes[msg.entity_id].lightPower + action_value;\n    } else if (cubes[msg.entity_id].lightPower + action_value < 1) {\n        return 1;\n    } else if (cubes[msg.entity_id].lightPower + action_value > 100) {\n        return 100;\n    }\n}\n\nfunction randomAmbiance(ambiances_type) {\n    let ambiancesTypeKeys = Object.keys(ambiances_type);\n    let ambiancesType = [];\n    for (let key of ambiancesTypeKeys) {\n        ambiancesType.push(ambiances_type[key].name);\n    }\n    return ambiancesType[1 + Math.floor(Math.random() * 7)];\n}\n\nfunction saveAndReturn() {\n    global.set(\"cubes\", cubes);\n    return [msgs];\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":1260,"wires":[["beac1388867f09e9"]]},{"id":"ddb24c0b6f01c9a9","type":"comment","z":"1131f5463c30e69b","name":"linkedClass : ambiance","info":"","x":140,"y":1320,"wires":[]},{"id":"bf7d83069c530244","type":"link out","z":"1131f5463c30e69b","name":"ambiance","mode":"link","links":["57970c88e211ce04"],"x":1345,"y":1380,"wires":[]},{"id":"beac1388867f09e9","type":"switch","z":"1131f5463c30e69b","name":"type","property":"type","propertyType":"msg","rules":[{"t":"eq","v":"cube","vt":"str"},{"t":"eq","v":"ambiance","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1050,"y":1260,"wires":[["8f9c279590a9a156"],["6c2781e7c1d351ea"]]},{"id":"6c2781e7c1d351ea","type":"api-call-service","z":"1131f5463c30e69b","name":"select ambiance","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"{{action_type}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1200,"y":1260,"wires":[[]]},{"id":"9160ed0cb4b48113","type":"function","z":"1131f5463c30e69b","name":"set ambiance","func":"let ambiances_config = global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config.ambiance_config;\nlet ambiances = global.get(\"ambiances\") || {};\n\nif (!(msg.linkedAmbiance in ambiances)) {\n        ambiances[msg.linkedAmbiance] = {};\n        ambiances[msg.linkedAmbiance].current = \"stop\";\n}\n\nlet new_action_type = msg.action_type == \"stop\" ? \"stop\" : selectAmbiance(msg.action_type);\nif (ambiances[msg.linkedAmbiance].current != new_action_type) {\n        msg = { ...msg, ...global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config[msg.linkedAmbiance] };\n        msg.ambiance_config = ambiances_config;\n        msg.restore = new_action_type == \"stop\";\n        msg.action_type = new_action_type;\n        ambiances[msg.linkedAmbiance].current = new_action_type;\n        global.set(\"ambiances\", ambiances);\n        return msg;\n}\n\nfunction selectAmbiance(action_type) {\n        let ambiancesTypeKeys = Object.keys(ambiances_config.ambiances_type);\n        let ambiancesType = [];\n        for (let key of ambiancesTypeKeys) {\n                if (ambiances_config.ambiances_type[key].name == action_type) {\n                        return key;\n                }\n                ambiancesType.push(key);\n        }\n        if (action_type == \"random\") {\n                return ambiancesType[1 + Math.floor(Math.random() * 7)];\n        }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":1380,"wires":[["bf7d83069c530244","f28749b0a8207abd"]]},{"id":"4dfb2434f3561463","type":"comment","z":"1131f5463c30e69b","name":"linkedClass : phone","info":"","x":130,"y":1440,"wires":[]},{"id":"241b4911d7990cf0","type":"function","z":"1131f5463c30e69b","name":"get localTime","func":"if (msg.new_state == \"unavailable\") {\n    let date = new Date();\n    msg.localTime = cleanDate(new Date(date.setHours(date.getHours() - 24)));\n    return msg;\n} else {\n    let localTime = msg.attributes[\"Local Time\"].split(\"+\");\n    msg.localTime = cleanDate(new Date(localTime[0] + \"+00:00 \" + localTime[1].split(\" \")[1]));\n    return msg;\n}\n\nfunction cleanDate(dateString) {\n    dateString = dateString.toISOString().replace(\"T\", \" \").split(\".\")[0];\n    return dateString.substring(0, dateString.lastIndexOf(\":\"));\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1150,"y":1560,"wires":[["9661e1d948ddc449"]]},{"id":"e5241d8861c3e780","type":"inject","z":"1131f5463c30e69b","name":"inject","props":[{"p":"linkedClass","v":"time","vt":"str"}],"repeat":"","crontab":"*/1 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":110,"y":180,"wires":[["c34ea904b67d29dc"]]},{"id":"f69da4c4a60e5983","type":"link out","z":"1131f5463c30e69b","name":"detect date","mode":"link","links":["0b9796d6577bb527","fdaf52796d22e4f8"],"x":1345,"y":180,"wires":[]},{"id":"9fb49a4833d9cbdc","type":"function","z":"1131f5463c30e69b","name":"set cube","func":"let globalCubes = global.get(\"cubes\") || {};\nlet cubes = msg.cubes;\n\nif (cubes.length != 0) {\n    for (let cube of cubes) {\n        if (!(cube.entity_id in cubes)) {\n            globalCubes[cube.entity_id] = {};\n            globalCubes[cube.entity_id].move = true;\n            globalCubes[cube.entity_id].flip90 = false;\n            globalCubes[cube.entity_id].flip180 = false;\n            globalCubes[cube.entity_id].shake_air = false;\n            globalCubes[cube.entity_id].free_fall = false;\n            globalCubes[cube.entity_id].lightPower = 3;\n            globalCubes[cube.entity_id].lightColor = 0;\n        }\n        globalCubes[cube.entity_id].flip180 = msg.action_type != \"stop\";\n        globalCubes[cube.entity_id].flip90 = false;\n        globalCubes[cube.entity_id].free_fall = false;\n    }\n    global.set(\"cubes\", globalCubes);\n}","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":1380,"wires":[]},{"id":"c2b793ad8a720faa","type":"function","z":"1131f5463c30e69b","name":"set distance","func":"if (msg.new_state == \"home\") {\n    msg.payload = 0;\n    return msg;\n} else {\n    let zoneHomePosition = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes;\n    let lat1 = zoneHomePosition.latitude;\n    let lon1 = zoneHomePosition.longitude;\n    let lat2 = msg.attributes.latitude;\n    let lon2 = msg.attributes.longitude;\n\n    msg.payload = calculateDistance(lat1, lon1, lat2, lon2);\n    return msg;\n}\n\nfunction calculateDistance(lat1, lon1, lat2, lon2) {\n    let R = 6371e3;\n    lat1 = lat1 * (Math.PI / 180);\n    lon1 = lon1 * (Math.PI / 180);\n    lat2 = lat2 * (Math.PI / 180);\n    lon2 = lon2 * (Math.PI / 180);\n    let dlat = lat2 - lat1;\n    let dlon = lon2 - lon1;\n    let a = Math.pow(Math.sin(dlat / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(dlon / 2), 2);\n    let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n    let d = R * c;\n    return Math.round(d);\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1030,"y":1500,"wires":[["94dfe5afb0bea0f2"]]},{"id":"94dfe5afb0bea0f2","type":"function","z":"1131f5463c30e69b","name":"set phone_position","func":"let persons = global.get(\"persons\") || {};\n\nif (!(msg.linkedPerson in persons)) {\n    persons[msg.linkedPerson] = {};\n}\n\nif (persons[msg.linkedPerson].home_distance != msg.payload) {\n    persons[msg.linkedPerson].home_distance = msg.payload;\n    global.set(\"persons\", persons);\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":1500,"wires":[["65ee6b3542fd43e5"]]},{"id":"65ee6b3542fd43e5","type":"link out","z":"1131f5463c30e69b","name":"detect persons position","mode":"link","links":["837f5e57291454a2"],"x":1345,"y":1500,"wires":[]},{"id":"2a4f9eef86369b64","type":"comment","z":"1131f5463c30e69b","name":"linkedClass : light","info":"","x":120,"y":1080,"wires":[]},{"id":"7d7d96f425dadba3","type":"function","z":"1131f5463c30e69b","name":"light","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet area_motions = global.get(\"area_motions\") || {};\nlet locked_lights = global.get(\"locked_lights\") || [];\n\nif (in_home_zone && !(locked_lights.includes(msg.entity_id))) {\n    let state = \"linkedArea\" in msg && msg.linkedArea in area_motions ? area_motions[msg.linkedArea] : \"off\";\n    msg = {\n        entity_id: msg.entity_id,\n        linkedArea: msg.linkedArea,\n        linkedClass: msg.linkedClass,\n        state: state\n    };\n    return [msg, null];\n} else {\n    msg = { entity_id: msg.entity_id, state: \"off\" };\n    return [null, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":1140,"wires":[["fd57a035593d6c66"],["26255a7e7de21bc5"]]},{"id":"0f96dfc35694e72c","type":"function","z":"1131f5463c30e69b","name":"set global illuminance","func":"let light_time_status = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_time_status\"].state == \"on\";\nlet lightWhenCloudy = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_when_cloudy\"].state == \"on\";\nlet cloudy_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.cloudy_light\"].state);\nlet illuminances = global.get(\"illuminances\") || {};\nlet linkedArea = msg.linkedArea;\n\nif (!(linkedArea in illuminances)) {\n    illuminances[linkedArea] = {};\n    illuminances[linkedArea].dataMeanValue = [msg.value, 1];\n}\n\nlet dataMeanValue = illuminances[linkedArea].dataMeanValue;\nlet avgValue = Math.round((dataMeanValue[0] * dataMeanValue[1] + msg.value) / (dataMeanValue[1] + 1));\n\nlet send = \"\";\nif (lightWhenCloudy && avgValue < cloudy_light && illuminances[linkedArea].value > cloudy_light) {\n    send = \"on\";\n} else if (lightWhenCloudy && avgValue > cloudy_light && illuminances[linkedArea].value < cloudy_light) {\n    send = \"off\";\n}\n\nilluminances[linkedArea].dataMeanValue[0] = avgValue;\nilluminances[linkedArea].value = avgValue;\n\nglobal.set(\"illuminances\", illuminances);\nmsg = { entity_id: msg.linkedEntity, state: avgValue };\nreturn [msg, send != \"\" ? { \"lightWhenCloudy\": \"change to : \" + send } : null];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":1860,"wires":[["7c8e3b137b9de344"],["a11e962553e311dc"]]},{"id":"cb1389430fc3f0ea","type":"comment","z":"1131f5463c30e69b","name":"linkedClass : illuminance","info":"","x":150,"y":1800,"wires":[]},{"id":"b168a3be60fb27af","type":"function","z":"1131f5463c30e69b","name":"average area","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity of msg.entities) {\n    sum += parseFloat(entity.state);\n    count++;\n}\n\nif (!isNaN(sum)) {\n    msg.value = sum / count;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":1860,"wires":[["0f96dfc35694e72c"]]},{"id":"341559e77e62123c","type":"comment","z":"1131f5463c30e69b","name":"device_class: security_entrance","info":"","x":170,"y":1920,"wires":[]},{"id":"1f2f91c19b2fe9ae","type":"link out","z":"1131f5463c30e69b","name":"security_entrance","mode":"link","links":["514ddcb3e84c5765"],"x":1345,"y":1980,"wires":[]},{"id":"f5eec7a5870d28e2","type":"function","z":"1131f5463c30e69b","name":"set phone_bluetooth","func":"let persons = global.get(\"persons\") || {};\n\nif (\"connected_paired_devices\" in msg.attributes) {\n    let pairedDevices = msg.attributes.connected_paired_devices;\n    let bluetooth = {};\n\n    if (!(msg.linkedPerson in persons)) {\n        persons[msg.linkedPerson] = {};\n    }\n\n    for (let pairedDevice of pairedDevices) {\n        let splitDevice = pairedDevice.split(\" (\");\n        bluetooth[splitDevice[0]] = splitDevice[1].replaceAll(\")\", \"\");\n    }\n\n    persons[msg.linkedPerson].bluetooth = bluetooth;\n    global.set(\"persons\", persons);\n    return msg;\n}\n","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":1680,"wires":[]},{"id":"4b3da163787a95a4","type":"function","z":"1131f5463c30e69b","name":"set phone_wifi","func":"let persons = global.get(\"persons\") || {};\n\nif (!(msg.linkedPerson in persons)) {\n    persons[msg.linkedPerson] = {};\n}\npersons[msg.linkedPerson].wifi = msg.new_state;\nglobal.set(\"persons\", persons);\nreturn msg;","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":1740,"wires":[]},{"id":"64b4358d24b9fa64","type":"comment","z":"1131f5463c30e69b","name":"linkedAction: control_device","info":"","x":160,"y":2160,"wires":[]},{"id":"b2d815fa4524aaeb","type":"link out","z":"1131f5463c30e69b","name":"control_device","mode":"link","links":["fbc1c0ac1d7bec76"],"x":1345,"y":2220,"wires":[]},{"id":"ad1b8fdc045fd0dc","type":"link out","z":"1131f5463c30e69b","name":"detect motion off","mode":"link","links":["13a390949bac6841","fbc1c0ac1d7bec76","20da1d1d997c0428"],"x":1345,"y":960,"wires":[]},{"id":"527bcf15848bd8be","type":"comment","z":"1131f5463c30e69b","name":"linkedClass: remote","info":"","x":130,"y":2040,"wires":[]},{"id":"b664cf00474edc94","type":"subflow:d193bde43bd55f9f","z":"1131f5463c30e69b","name":"","x":1260,"y":2100,"wires":[]},{"id":"890a69f3c867f20e","type":"link out","z":"1131f5463c30e69b","name":"detect hour","mode":"link","links":["0a58c821fdc03b27","14b33d911438f95c","2c41d0af87e204e7","750c28d389fe672b","fbc1c0ac1d7bec76","fb43b785c9654545","f4d57076103097ca","89757e1c8fa070bb","9258d34035c742aa","faa3a5726b7782f9","d23592784ea8cb53","346fbabea8b1648f","6e17bd2eb14720ef","c4c630c7f2d519e0","19c7924cf98ca5ba","b321d8021f5cb968","e268223d58ea0a3f","a85964d824730b34","fcff1930e6bc521c","acc6764b12ad0b29"],"x":1345,"y":180,"wires":[]},{"id":"9bc7bbd42a3a90ce","type":"comment","z":"1131f5463c30e69b","name":"linkedClass: cover","info":"","x":130,"y":600,"wires":[]},{"id":"8c4bbdf67c433ded","type":"link out","z":"1131f5463c30e69b","name":"detect cover","mode":"link","links":["ff8917fbe0e53ade"],"x":1345,"y":660,"wires":[]},{"id":"7c8e3b137b9de344","type":"subflow:723d4991c3c87385","z":"1131f5463c30e69b","name":"","x":1210,"y":1860,"wires":[]},{"id":"ae269440c4a30009","type":"function","z":"1131f5463c30e69b","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let i = 0; i < msg.entities.length; i++) {\n    if (!isNaN(msg.entities[i].state)) {\n        sum += parseFloat(msg.entities[i].state);\n        count++;\n    }\n}\n\nif (sum != 0 && count != 0) {\n    msg.value = sum / count;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":300,"wires":[["1cc59508a4fdcc74"]]},{"id":"1cc59508a4fdcc74","type":"function","z":"1131f5463c30e69b","name":"set global","func":"let tempMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state);\nlet tempMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet notifications = global.get(\"notifications\") || {};\nlet temperatures = global.get(\"temperatures\") || {};\nlet linkedClass = msg.entities[0].linkedClass;\nlet linkedArea = msg.entities[0].linkedArea;\nlet alias = msg.entities[0].alias;\n\nif (!(linkedArea in temperatures)) {\n    temperatures[linkedArea] = {};\n    temperatures[linkedArea].value = msg.value;\n    temperatures[linkedArea].lastChange = new Date().getTime();\n}\n\nlet mean_value = Math.round(((temperatures[linkedArea].value * 4 + msg.value) / 5) * 100) / 100;\nlet mean_tendency = 2 * Math.round((mean_value - ((temperatures[linkedArea].value * 29 + mean_value) / 30)) * 1000) / 1000;\n\ntemperatures[linkedArea].high = tempMax <= (Math.ceil(10 * mean_value) / 10);\ntemperatures[linkedArea].low = (Math.ceil(10 * mean_value) / 10) <= tempMin;\ntemperatures[linkedArea].online = (new Date().getTime() - temperatures[linkedArea].lastChange) / 1000 < 20 * 60;\ntemperatures[linkedArea].value = mean_value;\ntemperatures[linkedArea].tendency = mean_tendency;\n\nglobal.set(\"temperatures\", temperatures);\nmsg = { entity_id: msg.entities[0].linkedEntity, state: mean_value };\n\nlet notification = \"\";\nlet notification_id = linkedClass + \"_\" + linkedArea;\nif (!temperatures[linkedArea].online && !(notification_id in notifications)) {\n    let message = \"La tempÃ©rature \" + alias + \" n'est plus recue. Certaines fonctionnalitÃ©s sont dÃ©sactivÃ©es.\";\n    notification = {\n        notification_id: notification_id,\n        title: \"âš ï¸ TempÃ©rature \" + alias,\n        message: message,\n        speak: message,\n        alertType: \"warning\",\n        sendMobile: true\n    };\n    return [notification, msg];\n} else if (temperatures[linkedArea].online && notification_id in notifications) {\n    notification = { notification_id: notification_id, dismiss: true };\n    return [notification, msg];\n}\n\nreturn [null, msg];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":300,"wires":[["3abd154e2798e85e"],["334170986c898c94"]]},{"id":"c7defae18b08a7a2","type":"function","z":"1131f5463c30e69b","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let i = 0; i < msg.entities.length; i++) {\n    if (!isNaN(msg.entities[i].state)) {\n        sum += parseFloat(msg.entities[i].state);\n        count++;\n    }\n}\n\nif (sum != 0 && count != 0) {\n    msg.value = sum / count;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":360,"wires":[["b5dd324f492cebf7"]]},{"id":"b5dd324f492cebf7","type":"function","z":"1131f5463c30e69b","name":"set global","func":"let tempMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state);\nlet tempMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet notifications = global.get(\"notifications\") || {};\nlet temperatures = global.get(\"temperatures\") || {};\nlet linkedClass = msg.entities[0].linkedClass;\nlet linkedArea = msg.entities[0].linkedArea;\nlet alias = msg.entities[0].alias;\n\nif (!(linkedArea in temperatures)) {\n    temperatures[linkedArea] = {};\n    temperatures[linkedArea].equalTemp = false;\n    temperatures[linkedArea].value = msg.value;\n    temperatures[linkedArea].lastChange = new Date().getTime();\n}\n\nlet mean_value = Math.round(((temperatures[linkedArea].value * 4 + msg.value) / 5) * 100) / 100;\nlet mean_tendency = 2 * Math.round((mean_value - ((temperatures[linkedArea].value * 29 + mean_value) / 30)) * 1000) / 1000;\n\ntemperatures[linkedArea].high = tempMax <= (Math.ceil(10 * mean_value) / 10);\ntemperatures[linkedArea].low = (Math.ceil(10 * mean_value) / 10) <= tempMin;\ntemperatures[linkedArea].online = (new Date().getTime() - temperatures[linkedArea].lastChange) / 1000 < 20 * 60;\ntemperatures[linkedArea].value = mean_value;\ntemperatures[linkedArea].tendency = mean_tendency;\n\nglobal.set(\"temperatures\", temperatures);\nmsg = { entity_id: msg.entities[0].linkedEntity, state: mean_value };\n\nlet notification = \"\";\nlet notification_id = linkedClass + \"_\" + linkedArea;\nif (!temperatures[linkedArea].online && !(notification_id in notifications)) {\n    let message = \"La tempÃ©rature \" + alias + \" n'est plus recue. Certaines fonctionnalitÃ©s sont dÃ©sactivÃ©es.\";\n    notification = {\n        notification_id: notification_id,\n        title: \"âš ï¸ TempÃ©rature \" + alias,\n        message: message,\n        speak: message,\n        alertType: \"warning\",\n        sendMobile: true\n    };\n    return [notification, msg];\n} else if (temperatures[linkedArea].online && notification_id in notifications) {\n    notification = { notification_id: notification_id, dismiss: true };\n    return [notification, msg];\n}\n\nreturn [null, msg];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":360,"wires":[["a56ef79faccc34c3"],["82b5542a3492af06"]]},{"id":"95cd3104a1bba16d","type":"function","z":"1131f5463c30e69b","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let i = 0; i < msg.entities.length; i++) {\n    if (!isNaN(msg.entities[i].state)) {\n        sum += parseFloat(msg.entities[i].state);\n        count++;\n    }\n}\n\nif (sum != 0 && count != 0) {\n    msg.value = sum / count;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":480,"wires":[["6a815b820fea607f"]]},{"id":"0ed1385355c0c24f","type":"function","z":"1131f5463c30e69b","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let i = 0; i < msg.entities.length; i++) {\n    if (!isNaN(msg.entities[i].state)) {\n        sum += parseFloat(msg.entities[i].state);\n        count++;\n    }\n}\n\nif (sum != 0 && count != 0) {\n    msg.value = sum / count;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":540,"wires":[["7367fbecb776d494"]]},{"id":"6a815b820fea607f","type":"function","z":"1131f5463c30e69b","name":"set global","func":"let humidityMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state);\nlet humidityMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state);\nlet notifications = global.get(\"notifications\") || {};\nlet humidities = global.get(\"humidities\") || {};\nlet linkedClass = msg.entities[0].linkedClass;\nlet linkedArea = msg.entities[0].linkedArea;\nlet alias = msg.entities[0].alias;\n\nif (!(linkedArea in humidities)) {\n    humidities[linkedArea] = {};\n    humidities[linkedArea].value = msg.value;\n    humidities[linkedArea].lastChange = new Date().getTime();\n}\n\nlet mean_value = Math.round(((humidities[linkedArea].value * 4 + msg.value) / 5) * 100) / 100;\nlet mean_tendency = 2 * Math.round((mean_value - ((humidities[linkedArea].value * 29 + mean_value) / 30)) * 1000) / 1000;\n\nhumidities[linkedArea].high = humidityMax <= (Math.ceil(10 * mean_value) / 10);\nhumidities[linkedArea].low = (Math.ceil(10 * mean_value) / 10) <= humidityMin;\nhumidities[linkedArea].online = (new Date().getTime() - humidities[linkedArea].lastChange) / 1000 < 20 * 60;\nhumidities[linkedArea].value = mean_value;\nhumidities[linkedArea].tendency = mean_tendency;\n\nglobal.set(\"humidities\", humidities);\nmsg = { entity_id: msg.entities[0].linkedEntity, state: mean_value };\n\nlet notification = \"\";\nlet notification_id = linkedClass + \"_\" + linkedArea;\nif (!humidities[linkedArea].online && !(notification_id in notifications)) {\n    let message = \"L'humiditÃ© \" + alias + \" n'est plus recue. Certaines fonctionnalitÃ©s sont dÃ©sactivÃ©es.\";\n    notification = {\n        notification_id: notification_id,\n        title: \"âš ï¸ HumiditÃ© \" + alias,\n        message: message,\n        speak: message,\n        alertType: \"warning\",\n        sendMobile: true\n    };\n    return [notification, msg];\n} else if (humidities[linkedArea].online && notification_id in notifications) {\n    notification = { notification_id: notification_id, dismiss: true };\n    return [notification, msg];\n}\n\nreturn [null, msg];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":480,"wires":[["5e18558ff10fb73b"],["c0e8b6e740552c34"]]},{"id":"7367fbecb776d494","type":"function","z":"1131f5463c30e69b","name":"set global","func":"let humidityMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state);\nlet humidityMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state);\nlet notifications = global.get(\"notifications\") || {};\nlet humidities = global.get(\"humidities\") || {};\nlet linkedClass = msg.entities[0].linkedClass;\nlet linkedArea = msg.entities[0].linkedArea;\nlet alias = msg.entities[0].alias;\n\nif (!(linkedArea in humidities)) {\n    humidities[linkedArea] = {};\n    humidities[linkedArea].value = msg.value;\n    humidities[linkedArea].lastChange = new Date().getTime();\n}\n\nlet mean_value = Math.round(((humidities[linkedArea].value * 4 + msg.value) / 5) * 100) / 100;\nlet mean_tendency = 2 * Math.round((mean_value - ((humidities[linkedArea].value * 29 + mean_value) / 30)) * 1000) / 1000;\n\nhumidities[linkedArea].high = humidityMax <= (Math.ceil(10 * mean_value) / 10);\nhumidities[linkedArea].low = (Math.ceil(10 * mean_value) / 10) <= humidityMin;\nhumidities[linkedArea].online = (new Date().getTime() - humidities[linkedArea].lastChange) / 1000 < 20 * 60;\nhumidities[linkedArea].value = mean_value;\nhumidities[linkedArea].tendency = mean_tendency;\n\nglobal.set(\"humidities\", humidities);\nmsg = { entity_id: msg.entities[0].linkedEntity, state: mean_value };\n\nlet notification = \"\";\nlet notification_id = linkedClass + \"_\" + linkedArea;\nif (!humidities[linkedArea].online && !(notification_id in notifications)) {\n    let message = \"L'humiditÃ© \" + alias + \" n'est plus recue. Certaines fonctionnalitÃ©s sont dÃ©sactivÃ©es.\";\n    notification = {\n        notification_id: notification_id,\n        title: \"âš ï¸ HumiditÃ© \" + alias,\n        message: message,\n        speak: message,\n        alertType: \"warning\",\n        sendMobile: true\n    };\n    return [notification, msg];\n} else if (humidities[linkedArea].online && notification_id in notifications) {\n    notification = { notification_id: notification_id, dismiss: true };\n    return [notification, msg];\n}\n\nreturn [null, msg];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":540,"wires":[["76810ee208160bd5"],["1915eb619b7a8497"]]},{"id":"334170986c898c94","type":"subflow:723d4991c3c87385","z":"1131f5463c30e69b","name":"","x":1210,"y":300,"wires":[]},{"id":"82b5542a3492af06","type":"subflow:723d4991c3c87385","z":"1131f5463c30e69b","name":"","x":1210,"y":360,"wires":[]},{"id":"c0e8b6e740552c34","type":"subflow:723d4991c3c87385","z":"1131f5463c30e69b","name":"","x":1210,"y":480,"wires":[]},{"id":"1915eb619b7a8497","type":"subflow:723d4991c3c87385","z":"1131f5463c30e69b","name":"","x":1210,"y":540,"wires":[]},{"id":"9661e1d948ddc449","type":"function","z":"1131f5463c30e69b","name":"set alarm","func":"let person = global.get(\"homeassistant\").homeAssistant.states[msg.linkedPerson].attributes;\nlet persons = global.get(\"persons\") || {};\n\nif (\"config\" in person && \"alarmClock\" in person.config && !(\"linkedManualAlarm\" in person.config.alarmClock)){\n    if (!(msg.linkedPerson in persons)) {\n        persons[msg.linkedPerson] = {};\n    }\n    persons[msg.linkedPerson].alarm = msg.localTime;\n    global.set(\"persons\", persons);\n    return msg;\n}","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1300,"y":1560,"wires":[]},{"id":"7c54326b927a0b26","type":"server-events","z":"1131f5463c30e69b","name":"","server":"c87720f17866318d","version":2,"eventType":"webhook","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":120,"y":2400,"wires":[["77f1cd06a5f32c1a"]]},{"id":"77f1cd06a5f32c1a","type":"function","z":"1131f5463c30e69b","name":"data to json","func":"let data = msg.payload.event.data;\nlet json = data.substring(data.indexOf(\"{\"), data.lastIndexOf(\"}\") + 1);\nmsg.payload.event = { ...JSON.parse(json) };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":2400,"wires":[["2c3b171b6098c1bb"]]},{"id":"9dfbce5d726ae0ae","type":"comment","z":"1131f5463c30e69b","name":"linkedAction: control_device","info":"","x":160,"y":2340,"wires":[]},{"id":"2c3b171b6098c1bb","type":"link out","z":"1131f5463c30e69b","name":"webhook","mode":"link","links":["dde6233e9fa241da","b658443c78631d97","363cd01fc9141708"],"x":1345,"y":2400,"wires":[]},{"id":"bd02992096174d14","type":"function","z":"1131f5463c30e69b","name":"set areas","func":"let areas = [...new Set(msg.entities.map(entity => entity.linkedArea))];\nlet msgs = [];\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":360,"wires":[["d1ea3624e8e0f14f"]]},{"id":"686b015b909260b0","type":"server-events","z":"1131f5463c30e69b","name":"cover","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"cover\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":90,"y":660,"wires":[["701d2b97c30cada6"]]},{"id":"701d2b97c30cada6","type":"function","z":"1131f5463c30e69b","name":"set","func":"msg.entity_id = msg.event.entity_id;\nmsg.old_state = parseInt(msg.event.old_state.state);\nmsg.new_state = parseInt(msg.event.new_state.state);\nmsg = { ...msg, ...msg.event.new_state.attributes.config };\n\ndelete msg.event;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":660,"wires":[["8c4bbdf67c433ded"]]},{"id":"f490673c43ccc3cf","type":"server-events","z":"1131f5463c30e69b","name":"window","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"window\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":90,"y":780,"wires":[["659adc3d5fd2db9d"]]},{"id":"659adc3d5fd2db9d","type":"function","z":"1131f5463c30e69b","name":"set","func":"if (msg.event.old_state.state != msg.event.new_state.state) {\n    msg.entity_id = msg.event.entity_id;\n    msg.state = msg.event.new_state.state;\n    msg = { ...msg, ...msg.event.new_state.attributes.config };\n\n    delete msg.event;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":780,"wires":[["7ba3931adcd96cf3"]]},{"id":"64f9476426928e97","type":"server-events","z":"1131f5463c30e69b","name":"light","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"old_state\":{\"state\":\"unavailable\"},\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"light\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":90,"y":1140,"wires":[["2852d136334c5464"]]},{"id":"20e3cfb7f4d272b4","type":"function","z":"1131f5463c30e69b","name":"set","func":"if (msg.event.new_state.state != \"unavailable\") {\n    msg.entity_id = msg.event.entity_id;\n    msg = { ...msg, ...msg.event.new_state.attributes.config };\n\n    delete msg.event;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":1140,"wires":[["7d7d96f425dadba3"]]},{"id":"ad7f65d73e905da5","type":"function","z":"1131f5463c30e69b","name":"set","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet entity_id = msg.payload.entity_id;\nlet entity_attributes = global.get(\"homeassistant\").homeAssistant.states[entity_id].attributes;\nlet entity_config = \"config\" in entity_attributes ? entity_attributes.config : \"\";\n\nif (in_home_zone && entity_config != \"\") {\n    let actions = {\n        tap_twice: \"tap_twice\",\n        shake_air: \"shake_air\",\n        move: \"move\",\n        free_fall: \"free_fall\",\n        rotate: \"rotate\",\n        flip180: \"flip180\",\n        flip90: \"flip90\"\n    };\n\n    if (msg.payload.event.action_type in actions) {\n        msg = {\n            entity_id: entity_id,\n            action_type: msg.payload.event.action_type,\n            action_value: \"action_value\" in msg.payload.event ? msg.payload.event.action_value : 0,\n            rotate_ratio: 1,\n            ...entity_config\n        };\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":1260,"wires":[["095b17c8bdaf5eaa"]]},{"id":"f4cc005216d30db4","type":"server-events","z":"1131f5463c30e69b","name":"ambiance_select","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"ambiance_select\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":120,"y":1380,"wires":[["a1a4ea73d7afc66b"]]},{"id":"a1a4ea73d7afc66b","type":"function","z":"1131f5463c30e69b","name":"set","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\n\nif (in_home_zone && msg.event.old_state.state != msg.event.new_state.state && msg.event.new_state.state != \"unknown\") {\n    msg.entity_id = msg.event.entity_id;\n    msg.action_type = msg.event.new_state.state;\n    msg = { ...msg, ...msg.event.new_state.attributes.config };\n\n    delete msg.event;\n    return [msg, null];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":1380,"wires":[["9160ed0cb4b48113"]]},{"id":"ef0e8cdd2b05efce","type":"server-events","z":"1131f5463c30e69b","name":"phone_position","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"phone_position\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":220,"y":1500,"wires":[["a3bff3ecca5587d8"]]},{"id":"a3bff3ecca5587d8","type":"function","z":"1131f5463c30e69b","name":"set","func":"msg.new_state = msg.event.new_state.state;\nmsg.attributes = msg.event.new_state.attributes;\nmsg = { ...msg, ...msg.event.new_state.attributes.config };\n\ndelete msg.event;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":1500,"wires":[["c2b793ad8a720faa"]]},{"id":"bd2bc2c665c8cbfe","type":"server-events","z":"1131f5463c30e69b","name":"phone_bluetooth","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"phone_bluetooth\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":220,"y":1680,"wires":[["c6d8e1db79e4ab87"]]},{"id":"c6d8e1db79e4ab87","type":"function","z":"1131f5463c30e69b","name":"set","func":"msg.new_state = msg.event.new_state.state;\nmsg.attributes = msg.event.new_state.attributes;\nmsg = { ...msg, ...msg.event.new_state.attributes.config };\n\ndelete msg.event;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":1680,"wires":[["f5eec7a5870d28e2"]]},{"id":"b2e13da8de420cf0","type":"server-events","z":"1131f5463c30e69b","name":"phone_wifi","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"phone_wifi\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":200,"y":1740,"wires":[["1c547fdf0bde0145"]]},{"id":"1c547fdf0bde0145","type":"function","z":"1131f5463c30e69b","name":"set","func":"msg.new_state = msg.event.new_state.state;\nmsg.attributes = msg.event.new_state.attributes;\nmsg = { ...msg, ...msg.event.new_state.attributes.config };\n\ndelete msg.event;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":1740,"wires":[["4b3da163787a95a4"]]},{"id":"72df205954ac07f4","type":"server-events","z":"1131f5463c30e69b","name":"phone_alarm","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"phone_alarm\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":210,"y":1560,"wires":[["76bd37de2a4611e5"]]},{"id":"76bd37de2a4611e5","type":"function","z":"1131f5463c30e69b","name":"set","func":"msg.new_state = msg.event.new_state.state;\nmsg.attributes = msg.event.new_state.attributes;\nmsg = { ...msg, ...msg.event.new_state.attributes.config };\n\ndelete msg.event;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":1560,"wires":[["241b4911d7990cf0"]]},{"id":"03eef65f5b8a98f8","type":"server-events","z":"1131f5463c30e69b","name":"illuminance","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"illuminance\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":100,"y":1860,"wires":[["ec5e39f3ac83c12f"]]},{"id":"ec5e39f3ac83c12f","type":"function","z":"1131f5463c30e69b","name":"set","func":"msg = { ...msg, ...msg.event.new_state.attributes.config };\n\ndelete msg.event;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":1860,"wires":[["a1cdb314996c7f36"]]},{"id":"3ab0dbe098c850d0","type":"server-events","z":"1131f5463c30e69b","name":"security_entrance","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"security_entrance\":true}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":130,"y":1980,"wires":[["bd90a200e2f3363b"]]},{"id":"bd90a200e2f3363b","type":"function","z":"1131f5463c30e69b","name":"set","func":"if (msg.event.new_state.state != msg.event.old_state.state) {\n    msg.entity_id = msg.event.entity_id;\n    msg = { ...msg, ...msg.event.new_state.attributes.config };\n\n    delete msg.event;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":1980,"wires":[["1f2f91c19b2fe9ae"]]},{"id":"b9336824cb69ddc5","type":"server-events","z":"1131f5463c30e69b","name":"remote","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"remote\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":90,"y":2100,"wires":[["713ba25351c8f61a"]]},{"id":"713ba25351c8f61a","type":"function","z":"1131f5463c30e69b","name":"set","func":"msg.entity_id = msg.event.entity_id;\nmsg.new_state = isNaN(msg.event.new_state.state) ? msg.event.new_state.state : parseInt(msg.event.new_state.state);\nmsg.old_state = isNaN(msg.event.old_state.state) ? msg.event.old_state.state : parseInt(msg.event.old_state.state);\nmsg = { ...msg, ...msg.event.new_state.attributes.config };\n\ndelete msg.event;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":2100,"wires":[["b664cf00474edc94"]]},{"id":"9a321ab5f0e8586b","type":"server-events","z":"1131f5463c30e69b","name":"control_device","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":110,"y":2220,"wires":[["c515a2521a01cb0e"]]},{"id":"c515a2521a01cb0e","type":"function","z":"1131f5463c30e69b","name":"set","func":"let control_device = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.control_device\"].attributes.config;\n\nif (msg.event.entity_id in control_device) {\n    msg.entity_id = msg.event.entity_id;\n    msg.new_state = msg.event.new_state.state;\n    msg.control_device = control_device[msg.event.entity_id];\n\n    delete msg.event;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":2220,"wires":[["b2d815fa4524aaeb"]]},{"id":"e42e2f46e2b5c13f","type":"server-events","z":"1131f5463c30e69b","name":"motion","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"motion\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":90,"y":900,"wires":[["bbba971f10ccca13"]]},{"id":"bbba971f10ccca13","type":"function","z":"1131f5463c30e69b","name":"set","func":"if (msg.event.old_state.state != msg.event.new_state.state) {\n    let invertedMotion = \"config\" in msg.event.new_state.attributes && \"invertedMotion\" in msg.event.new_state.attributes.config ? msg.event.new_state.attributes.config.invertedMotion : false;\n\n    msg.entity_id = msg.event.entity_id;\n    msg.state = invertedMotion ? { \"on\": \"off\", \"off\": \"on\" }[msg.event.new_state.state] : msg.event.new_state.state;\n    msg = { ...msg, ...msg.event.new_state.attributes.config };\n\n    delete msg.event;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":900,"wires":[["87c27c41158511a8"]]},{"id":"87c27c41158511a8","type":"function","z":"1131f5463c30e69b","name":"motion_area exist","func":"let area_motions = global.get(\"area_motions\") || {};\n\nif (Object.keys(area_motions).length != 0) {\n    return [msg, null];\n} else {\n    let config = {};\n\n    config.rules = [\n        {\n            property: \"attributes.config.linkedClass\",\n            logic: \"is\",\n            value: \"motion\",\n            valueType: \"str\"\n        }\n    ];\n\n    config.outputType = \"array\";\n    config.outputEmptyResults = false;\n    config.outputLocationType = \"msg\";\n    config.outputLocation = \"entities\";\n\n    msg.payload = config;\n    return [null, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":900,"wires":[["7b02eb3b9a7b888f"],["2fe28dd7b2f949f2"]]},{"id":"2cfd5ed855a5e196","type":"function","z":"1131f5463c30e69b","name":"set motion_area","func":"let motions = flow.get(\"motions\") || {};\nlet entities = msg.entities;\nlet area_motions = {};\n\nfor (let entity of entities) {\n    let state = \"invertedMotion\" in entity && entity.invertedMotion ? { \"on\": \"off\", \"off\": \"on\" }[entity.state] : entity.state;\n    if (!(entity.linkedArea in area_motions)) {\n        area_motions[entity.linkedArea] = state;\n    } else {\n        area_motions[entity.linkedArea] = area_motions[entity.linkedArea] == \"on\" ? \"on\" : state;\n    }\n    motions[entity.entity_id] = {\n        linkedClass: entity.linkedClass,\n        linkedArea: entity.linkedArea,\n        invertedMotion: entity.invertedMotion,\n        state: state\n    };\n}\n\nglobal.set(\"area_motions\", area_motions);\nflow.set(\"motions\", motions);\ndelete msg.entities;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":900,"wires":[["27a69dac2b0e8f92"]]},{"id":"27a69dac2b0e8f92","type":"function","z":"1131f5463c30e69b","name":"motion","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet area_motions = global.get(\"area_motions\") || {};\nlet motions = flow.get(\"motions\") || {};\n\nif (in_home_zone) {\n    if (msg.state == \"on\") {\n        area_motions[msg.linkedArea] = \"on\";\n        motions[msg.entity_id] = { linkedClass: msg.linkedClass, linkedArea: msg.linkedArea, invertedMotion: msg.invertedMotion, state: \"on\" };\n\n        msg = {\n            entity_id: msg.entity_id,\n            linkedArea: msg.linkedArea,\n            linkedClass: msg.linkedClass,\n            state: \"on\"\n        };\n\n        global.set(\"area_motions\", area_motions);\n        flow.set(\"motions\", motions);\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":900,"wires":[["06cfe22af4e54d2d","0467dac78e1139e0"],["170f121d25fb6110"]]},{"id":"06cfe22af4e54d2d","type":"link out","z":"1131f5463c30e69b","name":"link out 530","mode":"link","links":["93003c1fabc734ef"],"x":855,"y":900,"wires":[]},{"id":"170f121d25fb6110","type":"link out","z":"1131f5463c30e69b","name":"link out 531","mode":"link","links":["eae2027484ebd279"],"x":855,"y":900,"wires":[]},{"id":"eae2027484ebd279","type":"link in","z":"1131f5463c30e69b","name":"link in 481","links":["170f121d25fb6110"],"x":55,"y":960,"wires":[["be8545d1451facf1"]]},{"id":"be8545d1451facf1","type":"function","z":"1131f5463c30e69b","name":"add delay","func":"msg.delay = \"addNoMotionDelay\" in msg && msg.addNoMotionDelay >= 0 ? msg.addNoMotionDelay * 1000 : 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":960,"wires":[["25fdff01f2f10178"]]},{"id":"25fdff01f2f10178","type":"delay","z":"1131f5463c30e69b","name":"delay","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":255,"y":960,"wires":[["5c23abec47461758"]],"l":false},{"id":"4f252acb4ce55502","type":"function","z":"1131f5463c30e69b","name":"no motion","func":"let area_motions = global.get(\"area_motions\") || {};\nlet motions = flow.get(\"motions\") || {};\n\nif (msg.state == \"on\") {\n    for (let key of Object.keys(area_motions)) {\n        if (key != msg.linkedArea && area_motions[key] == \"last\") {\n            setMotions(key, \"off\");\n            area_motions[key] = \"off\";\n\n            msg = {\n                entity_id: msg.entity_id,\n                linkedArea: key,\n                linkedClass: msg.linkedClass,\n                state: \"off\"\n            };\n\n            global.set(\"area_motions\", area_motions);\n            return msg;\n        }\n    }\n}\n\nif (msg.state == \"off\") {\n    let noMotionInAreas = true;\n    for (let key of Object.keys(area_motions)) {\n        if (key != msg.linkedArea) {\n            noMotionInAreas = noMotionInAreas && area_motions[key] == \"off\";\n        }\n    }\n    let motionInArea = false;\n    for (let entity of msg.entities) {\n        motionInArea = motionInArea || entity.state == \"on\";\n    }\n    msg.state = motionInArea ? \"on\" : noMotionInAreas && \"lastMotion\" in msg && msg.lastMotion ? \"last\" : \"off\";\n    area_motions[msg.linkedArea] = msg.state;\n    global.set(\"area_motions\", area_motions);\n    \n    if (msg.state != \"on\") {\n        msg = {\n            entity_id: msg.entity_id,\n            linkedArea: msg.linkedArea,\n            linkedClass: msg.linkedClass,\n            state: msg.state\n        };\n        return msg;\n    }\n}\n\nfunction setMotions(linkedArea, state) {\n    for (let key of Object.keys(motions)) {\n        if (linkedArea == motions[key].linkedArea) {\n            motions[key] = { entity_id: key, ...motions[key] };\n            motions[key].state = state;\n        }\n    }\n    flow.set(\"motions\", motions);\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":960,"wires":[["ad1b8fdc045fd0dc"]]},{"id":"93003c1fabc734ef","type":"link in","z":"1131f5463c30e69b","name":"link in 482","links":["06cfe22af4e54d2d"],"x":475,"y":960,"wires":[["4f252acb4ce55502"]]},{"id":"e5845df5d73b2238","type":"comment","z":"1131f5463c30e69b","name":"time","info":"","x":90,"y":120,"wires":[]},{"id":"71fa601eebc81ba8","type":"function","z":"1131f5463c30e69b","name":"ext_temperatures >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"ext_temp\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":300,"wires":[["d1f6223550bbb641"]]},{"id":"d1f6223550bbb641","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":315,"y":300,"wires":[["ae269440c4a30009"]],"l":false},{"id":"d1ea3624e8e0f14f","type":"function","z":"1131f5463c30e69b","name":"area temperatures >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"int_temp\",\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedArea\",\n        logic: \"is\",\n        value: msg.linkedArea,\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":515,"y":360,"wires":[["805197abf6694e6e"]],"l":false},{"id":"51775bce71672772","type":"function","z":"1131f5463c30e69b","name":"ext_humidities >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"ext_humidity\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":480,"wires":[["4e460807dd7f8d05"]]},{"id":"2fe28dd7b2f949f2","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":495,"y":900,"wires":[["2cfd5ed855a5e196"]],"l":false},{"id":"f28749b0a8207abd","type":"function","z":"1131f5463c30e69b","name":"cube >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"cube\",\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedAmbiance\",\n        logic: \"is\",\n        value: msg.linkedAmbiance,\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"cubes\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":1380,"wires":[["10ce848caab35365"]]},{"id":"10ce848caab35365","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":635,"y":1380,"wires":[["9fb49a4833d9cbdc"]],"l":false},{"id":"a1cdb314996c7f36","type":"function","z":"1131f5463c30e69b","name":"illuminances >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedArea\",\n        logic: \"is\",\n        value: msg.linkedArea,\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: msg.linkedClass,\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":1860,"wires":[["023a7bd50bf45d9c"]]},{"id":"023a7bd50bf45d9c","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":495,"y":1860,"wires":[["b168a3be60fb27af"]],"l":false},{"id":"1a77ad7cbc922ac4","type":"link in","z":"1131f5463c30e69b","name":"target_phone_position","links":[],"x":55,"y":1500,"wires":[["c2b793ad8a720faa","b626b9ded98186b7"]]},{"id":"7d1536b2c3192134","type":"link in","z":"1131f5463c30e69b","name":"target_phone_alarm","links":[],"x":55,"y":1560,"wires":[["241b4911d7990cf0","4e3e041016bb2a75"]]},{"id":"47dd96475c5dcd88","type":"link in","z":"1131f5463c30e69b","name":"target_phone_bluetooth","links":[],"x":55,"y":1680,"wires":[["f5eec7a5870d28e2","78ab9659b95e2f48"]]},{"id":"9c993d611d2070e3","type":"link in","z":"1131f5463c30e69b","name":"target_phone_wifi","links":[],"x":55,"y":1740,"wires":[["4b3da163787a95a4","9efe8979f2b7a342"]]},{"id":"b626b9ded98186b7","type":"link out","z":"1131f5463c30e69b","name":"link out 532","mode":"return","links":[],"x":105,"y":1500,"wires":[]},{"id":"4e3e041016bb2a75","type":"link out","z":"1131f5463c30e69b","name":"link out 533","mode":"return","links":[],"x":105,"y":1560,"wires":[]},{"id":"78ab9659b95e2f48","type":"link out","z":"1131f5463c30e69b","name":"link out 534","mode":"return","links":[],"x":105,"y":1680,"wires":[]},{"id":"9efe8979f2b7a342","type":"link out","z":"1131f5463c30e69b","name":"link out 535","mode":"return","links":[],"x":105,"y":1740,"wires":[]},{"id":"805197abf6694e6e","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":565,"y":360,"wires":[["c7defae18b08a7a2"]],"l":false},{"id":"4e460807dd7f8d05","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":295,"y":480,"wires":[["95cd3104a1bba16d"]],"l":false},{"id":"5c23abec47461758","type":"function","z":"1131f5463c30e69b","name":"get entities","func":"let motions = flow.get(\"motions\") || {};\nlet entities = [];\nlet entity = {};\n\nfor (let key of Object.keys(motions)) {\n    if (msg.linkedArea == motions[key].linkedArea) {\n        entity = { entity_id: key, ...motions[key] };\n        if (entity.entity_id == msg.entity_id) {\n            let state = global.get(\"homeassistant\").homeAssistant.states[key].state;\n            state = \"invertedMotion\" in entity && entity.invertedMotion ? { \"on\": \"off\", \"off\": \"on\" }[state] : state;\n            entity.state = state;\n            motions[key].state = state;\n        }\n        entities.push(entity);\n    }\n}\n\nflow.set(\"motions\", motions);\nmsg.entities = entities;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":960,"wires":[["4f252acb4ce55502"]]},{"id":"c34ea904b67d29dc","type":"subflow:94b2243985840d69","z":"1131f5463c30e69b","name":"","x":250,"y":180,"wires":[["c8a51a987b98aa02","3c9a07d6fe188065"]]},{"id":"54034c9729e47e5f","type":"link out","z":"1131f5463c30e69b","name":"waits control_device","mode":"link","links":["99b74de3a8d811fc"],"x":1345,"y":2280,"wires":[]},{"id":"43207f2152d73e3c","type":"function","z":"1131f5463c30e69b","name":"set","func":"if (\n    msg.event.old_state !== null\n    && msg.event.old_state.state !== null\n    && msg.event.old_state.state != msg.event.new_state.state\n) {\n    msg.entity_id = msg.event.entity_id;\n    msg.new_state = msg.event.new_state.state;\n\n    delete msg.event;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":2280,"wires":[["54034c9729e47e5f"]]},{"id":"d2129082ac4e139a","type":"server-events","z":"1131f5463c30e69b","name":"control_device","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":110,"y":2280,"wires":[["43207f2152d73e3c"]]},{"id":"ee45f510187e296e","type":"function","z":"1131f5463c30e69b","name":"set cubes","func":"let cubes = global.get(\"cubes\") || {};\n\nfor (let key of Object.keys(cubes)) {\n    cubes[key].flip90 = false;\n    cubes[key].free_fall = false;\n    cubes[key].shake_air = false;\n}\n\nglobal.set(\"cubes\", cubes);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":1020,"wires":[["d214aa221b30a253"]]},{"id":"d214aa221b30a253","type":"function","z":"1131f5463c30e69b","name":"set locked_lights","func":"global.set(\"locked_lights\", []);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":1020,"wires":[["bc0e069e4d5ee51f"]]},{"id":"e32c299462b85853","type":"link out","z":"1131f5463c30e69b","name":"detect light","mode":"link","links":["13a390949bac6841"],"x":1345,"y":1140,"wires":[]},{"id":"26255a7e7de21bc5","type":"subflow:723d4991c3c87385","z":"1131f5463c30e69b","name":"","x":550,"y":1140,"wires":[]},{"id":"2852d136334c5464","type":"delay","z":"1131f5463c30e69b","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":175,"y":1140,"wires":[["20e3cfb7f4d272b4"]],"l":false},{"id":"53dfa425ed188586","type":"link out","z":"1131f5463c30e69b","name":"illuminance","mode":"link","links":["42bcf58ce90dbbb4"],"x":1345,"y":1860,"wires":[]},{"id":"e75cf0974097ea1a","type":"inject","z":"1131f5463c30e69b","name":"","props":[],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","x":75,"y":1620,"wires":[["90c884871b3d099c"]],"l":false},{"id":"c6f4fc617b5cbde4","type":"function","z":"1131f5463c30e69b","name":"set","func":"let persons = msg.persons;\n\nfor(let person of persons){\n    if (\"alarmClock\" in person && \"linkedManualAlarm\" in person.alarmClock){\n        let alarms = person.alarmClock.linkedManualAlarm;\n        let date = new Date();\n        let timeZoneOffset = -date.getTimezoneOffset() / 60;\n        let timeZoneDate = new Date(date.setHours(date.getHours() + timeZoneOffset));\n        if (timeZoneDate.getDay() in alarms){\n            msg.localTime = timeZoneDate.toISOString().split(\"T\")[0] + \" \" + alarms[timeZoneDate.getDay()];\n            msg.linkedPerson = person.entity_id;\n            return msg;\n        }\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":1620,"wires":[["5a1e8a6a35036941"]]},{"id":"90c884871b3d099c","type":"function","z":"1131f5463c30e69b","name":"persons >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"person\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"persons\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":1620,"wires":[["7e25faf41b278bbe"]]},{"id":"7e25faf41b278bbe","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":275,"y":1620,"wires":[["c6f4fc617b5cbde4"]],"l":false},{"id":"5a1e8a6a35036941","type":"function","z":"1131f5463c30e69b","name":"set alarm","func":"let persons = global.get(\"persons\") || {};\n\nif (!(msg.linkedPerson in persons)) {\n    persons[msg.linkedPerson] = {};\n}\npersons[msg.linkedPerson].alarm = msg.localTime;\nglobal.set(\"persons\", persons);\nreturn msg;","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1300,"y":1620,"wires":[]},{"id":"c8a51a987b98aa02","type":"function","z":"1131f5463c30e69b","name":"get date","func":"let d = new Date();\nlet year = d.getFullYear();\nlet month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1);\nlet day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n\nmsg.currentTime = year + \"-\" + month + \"-\" + day + \" \" + hour + \":\" + minute;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":180,"wires":[["f69da4c4a60e5983"]]},{"id":"3c9a07d6fe188065","type":"function","z":"1131f5463c30e69b","name":"get time","func":"let d = new Date();\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n\nmsg.currentTime = hour + \":\" + minute;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":180,"wires":[["890a69f3c867f20e"]]},{"id":"5954501f31252a63","type":"server-events","z":"1131f5463c30e69b","name":"zigbee cube","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"cube\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":390,"y":1260,"wires":[["80df2bea672fa97c"]]},{"id":"80df2bea672fa97c","type":"function","z":"1131f5463c30e69b","name":"set","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet entity_id = msg.event.entity_id;\nlet entity_attributes = global.get(\"homeassistant\").homeAssistant.states[entity_id].attributes;\nlet entity_config = \"config\" in entity_attributes ? entity_attributes.config : \"\";\n\nif (in_home_zone && entity_config != \"\") {\n    let actions = {\n        tap: \"tap_twice\",\n        shake: \"shake_air\",\n        slide: \"move\",\n        fall: \"free_fall\",\n        rotate_right: \"rotate\",\n        rotate_left: \"rotate\",\n        flip180: \"flip180\",\n        flip90: \"flip90\"\n    };\n\n    let state = msg.event.new_state.state;\n    let action_angle = msg.event.new_state.attributes.action_angle;\n    if (state in actions) {\n        msg = {\n            entity_id: entity_id,\n            action_type: actions[state],\n            action_value: action_angle == null ? 0 : action_angle,\n            rotate_ratio: 0.285,\n            ...entity_config\n        };\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":1260,"wires":[["095b17c8bdaf5eaa"]]},{"id":"89b65468391ddd44","type":"link in","z":"1131f5463c30e69b","name":"link in 485","links":["75f7ceda0c8f3b46"],"x":55,"y":300,"wires":[["71fa601eebc81ba8"]]},{"id":"65ce06cc341b4cb9","type":"link in","z":"1131f5463c30e69b","name":"link in 486","links":["75f7ceda0c8f3b46"],"x":55,"y":480,"wires":[["51775bce71672772"]]},{"id":"fd905e38b3dc148e","type":"link in","z":"1131f5463c30e69b","name":"link in 487","links":["75f7ceda0c8f3b46"],"x":55,"y":360,"wires":[["e4f5b71086178bcf"]]},{"id":"e4f5b71086178bcf","type":"function","z":"1131f5463c30e69b","name":"int_temperatures >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"int_temp\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":360,"wires":[["c860f8b72b0c28ed"]]},{"id":"c860f8b72b0c28ed","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":315,"y":360,"wires":[["bd02992096174d14"]],"l":false},{"id":"6e8a5ed956cbb3fe","type":"link in","z":"1131f5463c30e69b","name":"link in 488","links":["75f7ceda0c8f3b46"],"x":55,"y":540,"wires":[["3748a5c0820735b5"]]},{"id":"1147724e50d4dbb0","type":"function","z":"1131f5463c30e69b","name":"set areas","func":"let areas = [...new Set(msg.entities.map(entity => entity.linkedArea))];\nlet msgs = [];\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":540,"wires":[["166ac880e7881710"]]},{"id":"166ac880e7881710","type":"function","z":"1131f5463c30e69b","name":"area humidities >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"int_humidity\",\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedArea\",\n        logic: \"is\",\n        value: msg.linkedArea,\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":495,"y":540,"wires":[["44c27aef57197dcd"]],"l":false},{"id":"44c27aef57197dcd","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":545,"y":540,"wires":[["0ed1385355c0c24f"]],"l":false},{"id":"3748a5c0820735b5","type":"function","z":"1131f5463c30e69b","name":"int_humidities >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"int_humidity\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":540,"wires":[["819f14aa6a6c78ae"]]},{"id":"819f14aa6a6c78ae","type":"subflow:ea5b93cde6b1bf0a","z":"1131f5463c30e69b","name":"","x":295,"y":540,"wires":[["1147724e50d4dbb0"]],"l":false},{"id":"5b6f68812e131ffa","type":"inject","z":"1131f5463c30e69b","name":"2 min","props":[{"p":"linkedClass","v":"time","vt":"str"}],"repeat":"","crontab":"*/2 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":390,"y":240,"wires":[["75f7ceda0c8f3b46"]]},{"id":"75f7ceda0c8f3b46","type":"link out","z":"1131f5463c30e69b","name":"link out 538","mode":"link","links":["89b65468391ddd44","fd905e38b3dc148e","65ce06cc341b4cb9","6e8a5ed956cbb3fe"],"x":475,"y":240,"wires":[]},{"id":"808562788b6f03e3","type":"link out","z":"1131f5463c30e69b","name":"link out 539","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1345,"y":300,"wires":[]},{"id":"482038817b9e0cbb","type":"link out","z":"1131f5463c30e69b","name":"link out 540","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1345,"y":360,"wires":[]},{"id":"f231ffba1f31bb29","type":"link out","z":"1131f5463c30e69b","name":"link out 541","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1345,"y":480,"wires":[]},{"id":"2c0b3bb40e4d7109","type":"link out","z":"1131f5463c30e69b","name":"link out 542","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1345,"y":540,"wires":[]},{"id":"4a8d9787df871687","type":"function","z":"1131f5463c30e69b","name":"set cubes","func":"let lightColorOptions = [0, 36, 72, 108, 144, 180, 216, 252, 288, 324];\nlet lightPowerOptions = [1, 2, 6, 25, 100];\nlet cubes = global.get(\"cubes\") || {};\nlet msgs = [];\n\nif (!(msg.entity_id in cubes)) {\n    cubes[msg.entity_id] = { move: true, flip90: false, flip180: false, shake_air: false, free_fall: false, lightPower: 3, lightColor: 1 };\n    msg.action_type = \"flip90\";\n}\n\nif (msg.action_type == \"flip180\") {\n    msgs.push({\n        type: \"ambiance\",\n        entity_id: msg.linkedSelectAmbiance,\n        action_type: \"select_option\",\n        payload: { data: { option: randomAmbiance(global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config.ambiance_config.ambiances_type) } }\n    });\n    return saveAndReturn();\n} else if (msg.action_type == \"flip90\") {\n    if (!cubes[msg.entity_id].flip90 && !cubes[msg.entity_id].flip180) {\n        cubes[msg.entity_id].flip90 = true;\n        cubes[msg.entity_id].free_fall = false;\n        msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n        if (cubes[msg.entity_id].move) {\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        } else {\n            msg.colorTemp = 300;\n        }\n        msg.sound = \"light_auto_off.mp3\";\n        msg.cube = cubes[msg.entity_id];\n        msgs.push({ ...msg, type: \"cube\" });\n        return saveAndReturn();\n    }\n} else if (msg.action_type == \"tap_twice\") {\n    if (cubes[msg.entity_id].flip90) {\n        cubes[msg.entity_id].flip90 = false;\n        cubes[msg.entity_id].free_fall = false;\n        msg.sound = \"light_auto_on.mp3\";\n        msg.cube = cubes[msg.entity_id];\n        msgs.push({ ...msg, type: \"cube\" });\n    } else if (cubes[msg.entity_id].flip180) {\n        cubes[msg.entity_id].flip180 = false;\n        cubes[msg.entity_id].free_fall = false;\n        msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: \"select_first\" });\n    }\n    return saveAndReturn();\n} else if (msg.action_type == \"shake_air\" && !cubes[msg.entity_id].free_fall) {\n    if (!cubes[msg.entity_id].flip90) {\n        cubes[msg.entity_id].flip90 = true;\n        msg.sound = \"light_auto_off.mp3\";\n    } else {\n        msg.sound = \"fall.mp3\";\n    }\n    cubes[msg.entity_id].shake_air = !cubes[msg.entity_id].shake_air;\n    msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n    msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n    msg.colorTemp = 300;\n    msg.cube = cubes[msg.entity_id];\n    msgs.push({ ...msg, type: \"cube\" });\n    return saveAndReturn();\n} else if (msg.action_type == \"rotate\" && !cubes[msg.entity_id].free_fall) {\n    if (!cubes[msg.entity_id].flip90 && !cubes[msg.entity_id].flip180) {\n        cubes[msg.entity_id].flip90 = true;\n        msg.sound = \"light_auto_off.mp3\";\n    }\n    if (cubes[msg.entity_id].flip90) {\n        lights(rotate());\n        msg.cube = cubes[msg.entity_id];\n        msgs.push({ ...msg, type: \"cube\" });\n    } else if (cubes[msg.entity_id].flip180) {\n        let action_type = msg.action_value < 0 ? \"select_previous\" : \"select_next\";\n        msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: action_type });\n    }\n    return saveAndReturn();\n} else if (msg.action_type == \"free_fall\") {\n    if (!cubes[msg.entity_id].flip90) {\n        cubes[msg.entity_id].flip90 = true;\n        msg.sound = \"light_auto_off.mp3\";\n    } else {\n        msg.sound = \"fall.mp3\";\n    }\n    cubes[msg.entity_id].free_fall = !cubes[msg.entity_id].free_fall;\n    if (cubes[msg.entity_id].move) {\n        msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n    } else {\n        msg.colorTemp = 300;\n    }\n    msg.cube = cubes[msg.entity_id];\n    msgs.push({ ...msg, type: \"cube\" });\n    return saveAndReturn();\n\n} else if (msg.action_type == \"move\" && !cubes[msg.entity_id].free_fall) {\n    if (cubes[msg.entity_id].flip90) {\n        cubes[msg.entity_id].move = !cubes[msg.entity_id].move;\n        if (cubes[msg.entity_id].move) {\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        } else {\n            msg.colorTemp = 300;\n        }\n        msg.cube = cubes[msg.entity_id];\n        msgs.push({ ...msg, type: \"cube\" });\n        return saveAndReturn();\n    }\n}\n\nfunction rotate() {\n    return msg.action_value == 0 ? \"\" : msg.action_value > 0 ? msg.action_value < msg.rotate_limit ? 'rotate_pos' : 'rotate_pos_hard' : msg.action_value > -msg.rotate_limit ? 'rotate_neg' : 'rotate_neg_hard';\n}\n\nfunction lights(rotate) {\n    if (rotate == \"rotate_pos\") {\n        cubes[msg.entity_id].lightPower = cubes[msg.entity_id].lightPower + 1 > 4 ? 0 : cubes[msg.entity_id].lightPower + 1;\n        msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n        msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        msg.colorTemp = 300;\n    } else if (rotate == \"rotate_neg\") {\n        cubes[msg.entity_id].lightPower = cubes[msg.entity_id].lightPower - 1 < 0 ? 4 : cubes[msg.entity_id].lightPower - 1;\n        msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n        msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        msg.colorTemp = 300;\n    } else if (rotate == \"rotate_pos_hard\") {\n        cubes[msg.entity_id].move = true;\n        msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n        cubes[msg.entity_id].lightColor = cubes[msg.entity_id].lightColor + 1 > 9 ? 0 : cubes[msg.entity_id].lightColor + 1;\n        msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        msg.colorTemp = 300;\n    } else if (rotate == \"rotate_neg_hard\") {\n        cubes[msg.entity_id].move = true;\n        msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n        cubes[msg.entity_id].lightColor = cubes[msg.entity_id].lightColor - 1 < 0 ? 9 : cubes[msg.entity_id].lightColor - 1;\n        msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n        msg.colorTemp = 300;\n    }\n}\n\nfunction randomAmbiance(ambiances_type) {\n    let ambiancesTypeKeys = Object.keys(ambiances_type);\n    let ambiancesType = [];\n    for (let key of ambiancesTypeKeys) {\n        ambiancesType.push(ambiances_type[key].name);\n    }\n    return ambiancesType[1 + Math.floor(Math.random() * 7)];\n}\n\nfunction saveAndReturn() {\n    global.set(\"cubes\", cubes);\n    return [msgs];\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":1200,"wires":[[]]},{"id":"7d355bae08e9bcc8","type":"catch","z":"b0b353ce861d908b","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["041f4aa52ca65740"]]},{"id":"08a8d6e0e1cf9419","type":"server-events","z":"b0b353ce861d908b","name":"phone receive","server":"c87720f17866318d","version":2,"eventType":"mobile_app_notification_action","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":420,"wires":[["ac173fc7add2f604"]]},{"id":"ac173fc7add2f604","type":"switch","z":"b0b353ce861d908b","name":"invitation_off","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"invitation_off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":270,"y":420,"wires":[["fd526be7658c06c2"]]},{"id":"fd526be7658c06c2","type":"api-call-service","z":"b0b353ce861d908b","name":"home_invitation off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.invitation"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":450,"y":420,"wires":[["0a5f0f171df609dc"]]},{"id":"837f5e57291454a2","type":"link in","z":"b0b353ce861d908b","name":"set nearest","links":["22bace3b59def9cc","6b62e5e1bfab0019","a272e7ace5110c9b","2cf5a5d542aacb96","65ee6b3542fd43e5"],"x":55,"y":180,"wires":[["922083f63b657fbb"]]},{"id":"fcec0f9c2adc1980","type":"subflow:ad3b29a5dd67898f","z":"b0b353ce861d908b","name":"","x":460,"y":40,"wires":[]},{"id":"041f4aa52ca65740","type":"change","z":"b0b353ce861d908b","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Presence","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["fcec0f9c2adc1980"]]},{"id":"2293fd1b7eb68348","type":"link out","z":"b0b353ce861d908b","name":"link out 223","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":735,"y":420,"wires":[]},{"id":"0a5f0f171df609dc","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.dismiss = true;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":420,"wires":[["2293fd1b7eb68348"]]},{"id":"85b278c323f3b6c6","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.invitation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":480,"wires":[["24771a7fefeb56f5"],["6acfa8ca4b422c72"]]},{"id":"24771a7fefeb56f5","type":"function","z":"b0b353ce861d908b","name":"notification","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\n\nmsg.notification_id = \"invitation\";\nmsg.title = \"Mode invitation activÃ©\";\nmsg.alertType = \"success\";\nmsg.message = in_home_zone ? msg.title : \"En attente de l'invitÃ©\";\nmsg.sendMobile = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":480,"wires":[["08aa6a694a30f006"]]},{"id":"08aa6a694a30f006","type":"link out","z":"b0b353ce861d908b","name":"link out 232","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":515,"y":480,"wires":[]},{"id":"4a3b930cb95bbe93","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.dismiss = true;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":480,"wires":[["08aa6a694a30f006"]]},{"id":"c0a033baef2e6d6d","type":"api-call-service","z":"b0b353ce861d908b","name":"set zones","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1400,"y":180,"wires":[[]]},{"id":"922083f63b657fbb","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":180,"wires":[[],["8e288e86f9bafd46"]]},{"id":"6a3ec8b19251bf55","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.invitation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":100,"y":240,"wires":[["8590f3771a72dbdc"],[]]},{"id":"afda0ab80075878c","type":"function","z":"b0b353ce861d908b","name":"set zones","func":"let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes.config;\nlet msgs = [];\n\nfor (let key of Object.keys(zone_home)) {\n    msgs.push({ service: \"turn_on\", entity_id: key });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":180,"wires":[["c0a033baef2e6d6d"]]},{"id":"8590f3771a72dbdc","type":"subflow:e6ac576fb4598283","z":"b0b353ce861d908b","name":"","x":250,"y":240,"wires":[[],["78f8cb58b3393da3"]]},{"id":"9f8f42d514cb0054","type":"subflow:050c60654a910e68","z":"b0b353ce861d908b","name":"","x":860,"y":240,"wires":[["89b60a3c819b59ce","d30f1ac4833b6f50"]]},{"id":"a28f17b576d85af3","type":"function","z":"b0b353ce861d908b","name":"wait to enter home","func":"let linkedDoors = msg.entities;\nmsg.waits = [];\nmsg.states = [];\n\nfor (let door of linkedDoors) {\n    msg.waits.push(door.entity_id);\n    msg.states.push(\"on\");\n    msg.timeoutSeconds = 8 * 3600;\n    msg.sendOnTimeout = false;\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":240,"wires":[["9f8f42d514cb0054"]]},{"id":"ba78b5e5c855646d","type":"link out","z":"b0b353ce861d908b","name":"link out 221","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1175,"y":240,"wires":[]},{"id":"d30f1ac4833b6f50","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.title = \"Mode invitÃ©\";\nmsg.alertType = \"success\";\nmsg.message = \"L'invitÃ© est entrÃ©\";\nmsg.sendMobile = true;\nmsg.override = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1070,"y":240,"wires":[["ba78b5e5c855646d"]]},{"id":"89b60a3c819b59ce","type":"link out","z":"b0b353ce861d908b","name":"link out 355","mode":"link","links":["da541aea7280faf7"],"x":955,"y":240,"wires":[]},{"id":"da541aea7280faf7","type":"link in","z":"b0b353ce861d908b","name":"link in 370","links":["89b60a3c819b59ce"],"x":1155,"y":180,"wires":[["afda0ab80075878c"]]},{"id":"2ac1c7da511dbdd8","type":"link in","z":"b0b353ce861d908b","name":"link in 371","links":["d4bd76d5ef491c1f"],"x":55,"y":360,"wires":[["a042521ec6c5bc98"]]},{"id":"0a74831b69b5de4f","type":"function","z":"b0b353ce861d908b","name":"invitate open door","func":"let linkedDoors = msg.entities.map(e => e.entity_id);\nif (linkedDoors.includes(msg.entity_id)) {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":360,"wires":[["ea36df0e95629e52"]]},{"id":"a042521ec6c5bc98","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":360,"wires":[["6ea7ea5c7b875e1c"],[]]},{"id":"2ca739e1baf94b4b","type":"link out","z":"b0b353ce861d908b","name":"link out 356","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1055,"y":360,"wires":[]},{"id":"ea36df0e95629e52","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.title = \"Mode invitÃ©\";\nmsg.alertType = \"success\";\nmsg.message = \"L'invitÃ© est parti\";\nmsg.data = { actions: [{ \"action\": \"invitation_off\", \"title\": \"DÃ©sactiver mode invitÃ©\" }] };\nmsg.sendMobile = true;\nmsg.override = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":360,"wires":[["2ca739e1baf94b4b"]]},{"id":"0a2bed08ec229abc","type":"server-state-changed","z":"b0b353ce861d908b","name":"in_home_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":540,"wires":[["3fc9805a98cfab15"],["c0499aa622323580"]]},{"id":"464f99375855b471","type":"function","z":"b0b353ce861d908b","name":"at home ?","func":"let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes.config;\n\nif (msg.entity_id == Object.keys(zone_home)[0] && msg.service == \"turn_on\") {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":180,"wires":[["8f942dafa6e729bf"],["3ed9df714d540dff"]]},{"id":"5787289d7c4652a5","type":"subflow:050c60654a910e68","z":"b0b353ce861d908b","name":"","x":1060,"y":180,"wires":[["c0a033baef2e6d6d"]]},{"id":"2cf5a5d542aacb96","type":"link out","z":"b0b353ce861d908b","name":"link out 400","mode":"link","links":["837f5e57291454a2"],"x":565,"y":480,"wires":[]},{"id":"3dff4d53cd1e7309","type":"comment","z":"b0b353ce861d908b","name":"Zones detect","info":"","x":110,"y":840,"wires":[]},{"id":"992e0b9bf2f9a7b5","type":"function","z":"b0b353ce861d908b","name":"notification","func":"let entity_id = msg.data.entity_id;\nlet attributes = msg.data.new_state.attributes;\nlet googleKeepList = \"config\" in attributes && \"googleKeepList\" in attributes.config ? attributes.config.googleKeepList : \"\";\n\nif (entity_id != \"zone.home\" && msg.payload > 0 && googleKeepList != \"\") {\n    msg.title = \"Voici votre liste de courses\";\n    msg.data = { clickAction: googleKeepList};\n    msg.sendMobile = true;\n\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":900,"wires":[["9cbf7198f4d10a5b"]]},{"id":"9cbf7198f4d10a5b","type":"subflow:ba09e97f2ed22f2b","z":"b0b353ce861d908b","name":"","x":440,"y":900,"wires":[]},{"id":"65a5d5e9d9d9d752","type":"comment","z":"b0b353ce861d908b","name":"Security","info":"","x":100,"y":660,"wires":[]},{"id":"e5f67442c9d87639","type":"delay","z":"b0b353ce861d908b","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":320,"y":720,"wires":[["7e4840b6876573aa"]]},{"id":"7e4840b6876573aa","type":"function","z":"b0b353ce861d908b","name":"notification","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\n\nif (!in_home_zone) {\n    msg.alertType = \"error\";\n    msg.title = \"Mode surveillance ðŸ’¢\";\n    msg.message = \"Mouvement dÃ©tÃ©ctÃ© > DÃ©tection \" + msg.alias + \" ðŸ’¢\";\n    msg.notification_id = \"security_\" + msg.entity_id.split(\".\")[1];\n    msg.sendMobile = true;\n\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":720,"wires":[["ad446eefb7df13b9"]]},{"id":"85e70ba4e021ee27","type":"function","z":"b0b353ce861d908b","name":"notification","func":"if (msg.payload == \"off\") {\n    msg.notification_id = \"security_intrusion\";\n    msg.alertType = \"success\";\n    msg.title = \"Mode surveillance activÃ©\";\n    msg.message = \"La maison est en mode surveillance ðŸ›¡ï¸\";\n    msg.sendMobile = false;\n    msg.data = {};\n} else {\n    msg.notification_id = \"security_intrusion\";\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":780,"wires":[["db2a87c1d25e790a"]]},{"id":"ad446eefb7df13b9","type":"link out","z":"b0b353ce861d908b","name":"link out 203","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":575,"y":720,"wires":[]},{"id":"db2a87c1d25e790a","type":"link out","z":"b0b353ce861d908b","name":"link out 205","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":695,"y":780,"wires":[]},{"id":"9747baf2bc79243c","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.invitation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":780,"wires":[[],["50bcb623608b5268"]]},{"id":"50bcb623608b5268","type":"subflow:e6ac576fb4598283","z":"b0b353ce861d908b","name":"","x":250,"y":780,"wires":[[],["0ad2fc52e05f884f"]]},{"id":"2479895c05c38144","type":"server-state-changed","z":"b0b353ce861d908b","name":"in_home_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":420,"y":780,"wires":[["85e70ba4e021ee27"]]},{"id":"514ddcb3e84c5765","type":"link in","z":"b0b353ce861d908b","name":"security","links":["d719c2de89994314","1f2f91c19b2fe9ae"],"x":55,"y":720,"wires":[["b173e67b4c8d152f"]]},{"id":"6ea7ea5c7b875e1c","type":"api-current-state","z":"b0b353ce861d908b","name":"home empty","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"is","entity_id":"zone.home","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":330,"y":360,"wires":[["706fecd2fbcc259b"],[]]},{"id":"3acb1879e67b356b","type":"api-call-service","z":"b0b353ce861d908b","name":"home_invitation off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.invitation"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":540,"wires":[[]]},{"id":"36bffc4dfef8dea3","type":"function","z":"b0b353ce861d908b","name":"wait to enter home","func":"let linkedDoors = msg.entities;\nmsg.waits = [];\nmsg.states = [];\n\nfor (let door of linkedDoors) {\n    msg.waits.push(door.entity_id);\n    msg.states.push(\"on\");\n    msg.timeoutSeconds = 1200;\n    msg.sendOnTimeout = false;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":180,"wires":[["5787289d7c4652a5"]]},{"id":"78f8cb58b3393da3","type":"function","z":"b0b353ce861d908b","name":"security_entrance >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.security_entrance\",\n        logic: \"is\",\n        value: \"true\",\n        valueType: \"bool\"\n    },\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"motion\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":240,"wires":[["019f28f7b551d12a"]]},{"id":"019f28f7b551d12a","type":"subflow:ea5b93cde6b1bf0a","z":"b0b353ce861d908b","name":"","x":555,"y":240,"wires":[["a28f17b576d85af3"]],"l":false},{"id":"8f942dafa6e729bf","type":"function","z":"b0b353ce861d908b","name":"security_entrance >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.security_entrance\",\n        logic: \"is\",\n        value: \"true\",\n        valueType: \"bool\"\n    },\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"motion\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":180,"wires":[["a707cdcb9bbed7c4"]]},{"id":"a707cdcb9bbed7c4","type":"subflow:ea5b93cde6b1bf0a","z":"b0b353ce861d908b","name":"","x":755,"y":180,"wires":[["36bffc4dfef8dea3"]],"l":false},{"id":"706fecd2fbcc259b","type":"function","z":"b0b353ce861d908b","name":"security_entrance >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.security_entrance\",\n        logic: \"is\",\n        value: \"true\",\n        valueType: \"bool\"\n    },\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"motion\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"entities\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":360,"wires":[["3fb1db50797f2223"]]},{"id":"3fb1db50797f2223","type":"subflow:ea5b93cde6b1bf0a","z":"b0b353ce861d908b","name":"","x":635,"y":360,"wires":[["0a74831b69b5de4f"]],"l":false},{"id":"5fd3a1a12dce60d2","type":"comment","z":"b0b353ce861d908b","name":"Presence","info":"","x":100,"y":120,"wires":[]},{"id":"466d5fb08ce003ad","type":"comment","z":"b0b353ce861d908b","name":"Invitation","info":"","x":100,"y":300,"wires":[]},{"id":"8e288e86f9bafd46","type":"function","z":"b0b353ce861d908b","name":"get zones","func":"let zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes.config;\nlet persons = global.get(\"persons\") || {};\nlet msgs = [];\n\nlet distance = Object.keys(persons).map( p => persons[p].home_distance);\nif (distance.length != 0) {\n    distance.sort(function (a, b) { return a - b });\n    for (let key of Object.keys(zone_home)) {\n        if (distance[0] <= zone_home[key]) {\n            msgs.push({ service: \"turn_on\", entity_id: key });\n        } else {\n            msgs.push({ service: \"turn_off\", entity_id: key });\n        }\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":180,"wires":[["464f99375855b471"]]},{"id":"b173e67b4c8d152f","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":720,"wires":[[],["e5f67442c9d87639"]]},{"id":"a3db5013eb53fb66","type":"server-state-changed","z":"b0b353ce861d908b","name":"detect zones","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"^zone.","entityidfiltertype":"regex","outputinitially":true,"state_type":"num","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":110,"y":900,"wires":[["992e0b9bf2f9a7b5"]]},{"id":"3d13f870ec70a3f3","type":"api-current-state","z":"b0b353ce861d908b","name":"home not empty","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"is_not","entity_id":"zone.home","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":500,"y":540,"wires":[["3acb1879e67b356b"],[]]},{"id":"c0499aa622323580","type":"function","z":"b0b353ce861d908b","name":"empty locked_lights","func":"global.set(\"locked_lights\", []);","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":540,"wires":[[]]},{"id":"e0e4b731f70d927f","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.invitation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":600,"wires":[["e3a81bdc1ccb562a"],["9c0cce97e141ecbb"]]},{"id":"e3a81bdc1ccb562a","type":"api-call-service","z":"b0b353ce861d908b","name":"reveil module off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.module_alarm_clock"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":260,"y":600,"wires":[[]]},{"id":"23d8c2e514d46d60","type":"api-call-service","z":"b0b353ce861d908b","name":"reveil module on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.module_alarm_clock"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":440,"y":600,"wires":[[]]},{"id":"13a390949bac6841","type":"link in","z":"ccf1abe540a3b5a9","name":"light on/off/last","links":["01a0f34909e557d2","0489992ff2313771","1849c3d6ff1ccfb0","4ea967dc877079f0","a0ec305d313aa8f9","b8e8a6779e6eae20","e2084ffb49335b77","d4bd76d5ef491c1f","bc0e069e4d5ee51f","ad1b8fdc045fd0dc","e32c299462b85853"],"x":55,"y":180,"wires":[["a40553b9e1b431c2"]]},{"id":"c16109ee9dcc8d36","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 358","mode":"link","links":["f43547038a49e0b1","6430216584826676"],"x":1195,"y":180,"wires":[]},{"id":"5c1578eb5358a261","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"sun","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":120,"wires":[["c0c72f8e57387109"]]},{"id":"751c99b6607ee7b1","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"in_home_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":560,"wires":[[],["ad9a09b8e7b92562"]]},{"id":"0fcb5d94030ab313","type":"catch","z":"ccf1abe540a3b5a9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["d52e65e568a3244a"]]},{"id":"308dcdc841f55ee0","type":"subflow:ad3b29a5dd67898f","z":"ccf1abe540a3b5a9","name":"","x":460,"y":40,"wires":[]},{"id":"d52e65e568a3244a","type":"change","z":"ccf1abe540a3b5a9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Lights","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["308dcdc841f55ee0"]]},{"id":"b1bee60d1fd3da40","type":"function","z":"ccf1abe540a3b5a9","name":"current time status","func":"let lightTimeStatus = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_time_status\"].state == \"on\";\nlet sunAngleLightOnTime = time_to_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_angle_light_on_time\"].state);\nlet nightLightTime = time_to_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.night_light_time\"].state);\nlet riseLightTime = time_to_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.rise_light_time\"].state);\nlet sunAngleLightOffTime = time_to_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_angle_light_off_time\"].state);\nlet currentTime = time_to_minutes(new Date().toString().slice(16, 21));\n\nnightLightTime = nightLightTime <= sunAngleLightOnTime ? 1440 - sunAngleLightOnTime + nightLightTime : nightLightTime - sunAngleLightOnTime;\nriseLightTime = 1440 - sunAngleLightOnTime + riseLightTime;\nsunAngleLightOffTime = 1440 - sunAngleLightOnTime + sunAngleLightOffTime;\ncurrentTime = sunAngleLightOnTime <= currentTime ? currentTime - sunAngleLightOnTime : 1440 - sunAngleLightOnTime + currentTime;\nsunAngleLightOnTime = 0;\n\nif (lightTimeStatus && currentTime >= sunAngleLightOnTime && currentTime < nightLightTime) {\n    msg.currentTimeStatus = min_is1(pctCalc(sunAngleLightOnTime, nightLightTime, currentTime, false));\n} else if (lightTimeStatus && currentTime >= nightLightTime && currentTime < riseLightTime) {\n    msg.currentTimeStatus = 100;\n} else if (lightTimeStatus && currentTime >= riseLightTime && currentTime < sunAngleLightOffTime) {\n    msg.currentTimeStatus = min_is1(pctCalc(riseLightTime, sunAngleLightOffTime, currentTime, true));\n} else if (lightTimeStatus) {\n    msg.currentTimeStatus = 1;\n} else {\n    msg.currentTimeStatus = 0;\n}\nreturn msg;\n\nfunction time_to_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\");\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1]);\n}\n\nfunction min_is1(number) {\n    return number < 1 ? 1 : number;\n}\n\nfunction pctCalc(min, max, nb, reverse) {\n    return nb < min ? (reverse ? 100 : 0) : nb > max ? (reverse ? 0 : 100) : reverse ? (max - nb) / Math.abs(min - max) * 100 : (nb - min) / Math.abs(min - max) * 100;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":240,"wires":[["262dd804ff651dbf"]]},{"id":"262dd804ff651dbf","type":"function","z":"ccf1abe540a3b5a9","name":"brightness pct","func":"if (msg.currentTimeStatus == 0 && msg.dayLight) {\n    msg.brightnessPct = msg.brightRange[1];\n} else if (msg.currentTimeStatus == 0 && msg.lightWhenCloudy) {\n    let sunAngleLightOnTime = time_to_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_angle_light_on_time\"].state);\n    let sunAngleLightOffTime = time_to_minutes(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_angle_light_off_time\"].state);\n    let currentTime = time_to_minutes(new Date().toString().slice(16, 21));\n\n    if (sunAngleLightOffTime < currentTime && currentTime < (sunAngleLightOffTime + 90)){\n        msg.hsSaturation = pctCalc(sunAngleLightOffTime, (sunAngleLightOffTime + 90), currentTime, true);\n    } else if ((sunAngleLightOnTime - 90) < currentTime && currentTime < sunAngleLightOnTime) {\n        msg.hsSaturation = pctCalc((sunAngleLightOnTime - 90), sunAngleLightOnTime, currentTime, false);\n    } else {\n        msg.hsSaturation = 0;\n    }\n    msg.brightnessPct = cloudyLightBrightnessPctCalc();\n} else {\n    if (msg.currentTimeStatus < 50) {\n        msg.brightnessPct = 50 + 50 * Math.cos((36 * msg.currentTimeStatus / 10 - 180) * Math.PI / 180);\n        if (msg.lightWhenCloudy) {\n            let cloudyLightBrightnessPct = cloudyLightBrightnessPctCalc();\n            msg.brightnessPct = cloudyLightBrightnessPct > msg.brightnessPct ? cloudyLightBrightnessPct : msg.brightnessPct;\n        }\n    } else {\n        msg.brightnessPct = 100 * Math.cos((18 * msg.currentTimeStatus / 10 - 90) * Math.PI / 180);\n    }\n    msg.brightnessPct = msg.brightnessPct * msg.brightRange[1] / 100 + msg.brightRange[0] * (100 - msg.brightnessPct) / 100;\n}\n\nif (msg.motionState == \"on\" && (msg.currentTimeStatus != 100 || msg.nightLight)) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\nfunction pctCalc(min, max, nb, reverse) {\n    return nb < min ? (reverse ? 100 : 0) : nb > max ? (reverse ? 0 : 100) : reverse ? (max - nb) / Math.abs(min - max) * 100 : (nb - min) / Math.abs(min - max) * 100;\n}\n\nfunction cloudyLightBrightnessPctCalc() {\n    let cloudy_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.cloudy_light\"].state);\n    let illuminances = global.get(\"illuminances\") || {};\n    return pctCalc(50, cloudy_light, illuminances[\"exterior\"].value, true);\n}\n\nfunction time_to_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\");\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1]);\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":240,"wires":[["02814d30601aa3af"],["ab7efea6038a1013"]]},{"id":"02814d30601aa3af","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 363","mode":"link","links":["b1bba93bd37d5d05"],"x":955,"y":240,"wires":[]},{"id":"ab7efea6038a1013","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 364","mode":"link","links":["4bdf829a570f42ef"],"x":955,"y":240,"wires":[]},{"id":"b1bba93bd37d5d05","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 379","links":["02814d30601aa3af"],"x":95,"y":300,"wires":[["c2309ba3320c4c50"]]},{"id":"c2309ba3320c4c50","type":"switch","z":"ccf1abe540a3b5a9","name":"color ?","property":"color","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":190,"y":300,"wires":[["525315b5041cfb6e"],["68556bf00513cc3b"]]},{"id":"059646ead3d2a49f","type":"function","z":"ccf1abe540a3b5a9","name":"temp","func":"let colorTemp = msg.currentTimeStatus * (msg.colorTempRange[1] - msg.colorTempRange[0]) / 100 + msg.colorTempRange[0];\n\nmsg.payload = {\n    data: {\n        entity_id: msg.entity_id,\n        color_temp: colorTemp,\n        brightness_pct: msg.brightnessPct,\n        transition: msg.transitionRange[0]\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":300,"wires":[["f4a70f8d00443477"]]},{"id":"525315b5041cfb6e","type":"function","z":"ccf1abe540a3b5a9","name":"hs color","func":"let colorRotate = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_rotate\"].state);\nlet hsColor = [(360 * (msg.currentTimeStatus / 100) + colorRotate) % 360, msg.hsSaturation];\n\nmsg.payload = {\n    data: {\n        entity_id: msg.entity_id,\n        hs_color: hsColor,\n        brightness_pct: msg.brightnessPct,\n        transition: msg.transitionRange[0]\n    }\n};\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":300,"wires":[["f4a70f8d00443477"]]},{"id":"f4a70f8d00443477","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":600,"y":300,"wires":[[]]},{"id":"4bdf829a570f42ef","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 380","links":["ab7efea6038a1013","dc601dd0c5207b78"],"x":95,"y":360,"wires":[["79f626eba220efd3"]]},{"id":"79f626eba220efd3","type":"switch","z":"ccf1abe540a3b5a9","name":"color ?","property":"color","propertyType":"msg","rules":[{"t":"neq","v":"off","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":190,"y":360,"wires":[["28ae2d8ddeb77867"],["4b1a090c5eac6d5d"]]},{"id":"39a04d72d1e9fc02","type":"function","z":"ccf1abe540a3b5a9","name":"temp","func":"msg.payload = {\n    data: {\n        entity_id: msg.entity_id,\n        transition: msg.transitionRange[1]\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":360,"wires":[["a4b98272aabef1c3"]]},{"id":"28ae2d8ddeb77867","type":"function","z":"ccf1abe540a3b5a9","name":"hs color","func":"let colorRotate = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_rotate\"].state);\n\nmsg.hsColor = [(360 * (msg.currentTimeStatus / 100) + colorRotate) % 360, msg.hsSaturation];\nmsg.transition = msg.transitionRange[1] * 1000;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":360,"wires":[["7a9937d226a8849e"]]},{"id":"a4b98272aabef1c3","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":800,"y":360,"wires":[[]]},{"id":"7a9937d226a8849e","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control yeelight off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"yeelight","service":"start_flow","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"action\": \"off\",\"count\": \"1\",\"transitions\": [{\"HSVTransition\": [{{hsColor}},{{transition}},1]},{\"SleepTransition\": 5000}]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":490,"y":360,"wires":[[]]},{"id":"57970c88e211ce04","type":"link in","z":"ccf1abe540a3b5a9","name":"ambiance","links":["a11e52f70b3f44ee","bf7d83069c530244"],"x":615,"y":40,"wires":[["fd4956c89d222e5a"]]},{"id":"b8e8a6779e6eae20","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 372","mode":"link","links":["13a390949bac6841"],"x":1335,"y":40,"wires":[]},{"id":"ddf840aed2822269","type":"subflow:612068fa04cc8bbd","z":"ccf1abe540a3b5a9","name":"","x":1250,"y":40,"wires":[["b8e8a6779e6eae20"]]},{"id":"17df8120f9c53aca","type":"link in","z":"ccf1abe540a3b5a9","name":"cube","links":["aa868fbff20bbef5","7f2cec1b57f240b7"],"x":1005,"y":40,"wires":[["a7bc7a0c91bb60df"]]},{"id":"fd6da1a9eb3b4a30","type":"function","z":"ccf1abe540a3b5a9","name":"split lights","func":"let lightWhenCloudy = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_when_cloudy\"].state == \"on\";\nlet lightTimeStatus = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_time_status\"].state == \"on\";\nlet cloudyLight = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.cloudy_light\"].state);\nlet illuminances = global.get(\"illuminances\") || {};\nlet msgs = [];\n\nfor (let light of msg.lights) {\n    msgs.push({\n        lightWhenCloudy: lightWhenCloudy && \"exterior\" in illuminances && \"value\" in illuminances[\"exterior\"] && illuminances[\"exterior\"].value <= cloudyLight,\n        lightTimeStatus: lightTimeStatus,\n        lightState: light.state,\n        motionState: msg.state == \"last\" ? light.lastLight ? \"on\" : \"off\" : msg.state,\n        covers: msg.covers,\n        ...light\n    });\n}\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":180,"wires":[["93ba87ba312b913a"]]},{"id":"93ba87ba312b913a","type":"subflow:10a4bbabe046de0e","z":"ccf1abe540a3b5a9","name":"","x":960,"y":180,"wires":[["5890eb33250f72d1"]]},{"id":"5890eb33250f72d1","type":"function","z":"ccf1abe540a3b5a9","name":"light state","func":"if (msg.dayLight || msg.lightWhenCloudy || msg.lightTimeStatus || msg.covers.length != 0) {\n    return msg;\n} else if (msg.lightState == \"on\") {\n    msg.motionState = \"off\";\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1100,"y":180,"wires":[["c16109ee9dcc8d36"]]},{"id":"6430216584826676","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 382","links":["ad9cf82da7b8d9d5","c16109ee9dcc8d36"],"x":55,"y":240,"wires":[["40a3a62c1d267568"]]},{"id":"06801e5b53e8a439","type":"function","z":"ccf1abe540a3b5a9","name":"light ?","func":"if (\"attributes\" in msg && \"supported_color_modes\" in msg.attributes && !(msg.attributes.supported_color_modes.includes(\"onoff\"))) {\n    return [null, msg];\n} else {\n    msg.domain = msg.entity_id.split(\".\")[0];\n    msg.service = \"turn_\" + msg.motionState;\n    return [msg, null];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":240,"wires":[["d86d8527b58936dd"],["af3037a2c000ff8b"]]},{"id":"d86d8527b58936dd","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control device","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":460,"y":240,"wires":[[]]},{"id":"3d427e9849b65be2","type":"function","z":"ccf1abe540a3b5a9","name":"restore lights from motions","func":"let area_motions = global.get(\"area_motions\");\nlet areas = [];\nlet msgs = [];\n\nfor (let light of msg.lights) {\n    if (!areas.includes(light.linkedArea)) {\n        areas.push(light.linkedArea);\n    }\n}\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area, state: area_motions[area] });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":780,"y":500,"wires":[["a0ec305d313aa8f9"]]},{"id":"a0ec305d313aa8f9","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 373","mode":"link","links":["13a390949bac6841"],"x":935,"y":500,"wires":[]},{"id":"a8aedad4f45a3e9c","type":"delay","z":"ccf1abe540a3b5a9","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":300,"y":440,"wires":[["96fcc71316f08920"]]},{"id":"830aa417e845e28d","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":370,"y":500,"wires":[["e6fdc8b9ecf9094b"],[]]},{"id":"2e22c3522e999a5b","type":"ha-time","z":"ccf1abe540a3b5a9","name":"night_light_time","server":"c87720f17866318d","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityId":"input_datetime.night_light_time","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"debugenabled":false,"x":800,"y":440,"wires":[["96fcc71316f08920"]]},{"id":"3b11cb01c3e36fd8","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"light time status","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.light_time_status","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":620,"y":440,"wires":[["96fcc71316f08920"]]},{"id":"f6d7b10b4473bc19","type":"ha-time","z":"ccf1abe540a3b5a9","name":"rise_light_time","server":"c87720f17866318d","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityId":"input_datetime.rise_light_time","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"debugenabled":false,"x":450,"y":440,"wires":[["96fcc71316f08920"]]},{"id":"42bcf58ce90dbbb4","type":"link in","z":"ccf1abe540a3b5a9","name":"light restore","links":["65edb6875e6621bb","96fcc71316f08920","09c4d412366ddaa5","dd7a207b8276bacd","946e692a37fbda1a","7d5ce6802db864f6","53dfa425ed188586"],"x":55,"y":500,"wires":[["587a2f970b774dec"]]},{"id":"1e13104782559c9c","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"light_when_cloudy","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.light_when_cloudy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":130,"y":440,"wires":[["a8aedad4f45a3e9c"]]},{"id":"96fcc71316f08920","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 374","mode":"link","links":["af71798a4268cb52","42bcf58ce90dbbb4"],"x":915,"y":440,"wires":[]},{"id":"d90fc0e521e76bb6","type":"function","z":"ccf1abe540a3b5a9","name":"restore lights to off","func":"let areas = [];\nlet msgs = [];\n\nfor (let light of msg.lights) {\n    if (!areas.includes(light.linkedArea)) {\n        areas.push(light.linkedArea);\n    }\n}\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area, state: \"off\" });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":560,"wires":[["01a0f34909e557d2"]]},{"id":"01a0f34909e557d2","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 375","mode":"link","links":["13a390949bac6841"],"x":835,"y":560,"wires":[]},{"id":"3def32a14603ce09","type":"subflow:7166242293a03ec9","z":"ccf1abe540a3b5a9","name":"","x":890,"y":40,"wires":[["b8e8a6779e6eae20"]]},{"id":"a40553b9e1b431c2","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":190,"y":180,"wires":[["81bc2142a3005244"],[]]},{"id":"587a2f970b774dec","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":190,"y":500,"wires":[["830aa417e845e28d"],[]]},{"id":"ad9a09b8e7b92562","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":310,"y":560,"wires":[["e493ad8a541f9cf5"],[]]},{"id":"c984c4aec56dc82b","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"module_lights","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_lights","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":620,"wires":[["946e692a37fbda1a","e35423a2a82f9168"],["e35423a2a82f9168","7dec798e895a6d15"]]},{"id":"e904c7abdbd0b8c2","type":"function","z":"ccf1abe540a3b5a9","name":"notification","func":"msg.notification_id = \"module_light\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module LumiÃ¨res dÃ©sactivÃ©\";\n    msg.message = \"Module LumiÃ¨res dÃ©sactivÃ©, les lumiÃ¨res sont allumÃ©es\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":620,"wires":[["4c7682a3d69b57a1"]]},{"id":"4c7682a3d69b57a1","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 411","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":935,"y":620,"wires":[]},{"id":"946e692a37fbda1a","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 413","mode":"link","links":["42bcf58ce90dbbb4"],"x":215,"y":620,"wires":[]},{"id":"5687a334154dd78b","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":670,"y":620,"wires":[[]]},{"id":"39c5c048d2a868a7","type":"function","z":"ccf1abe540a3b5a9","name":"lights on","func":"let msgs = [];\n\nfor (let light of msg.lights) {\n    if (light.entity_id.includes(\"light.\")) {\n        msgs.push({\n            payload: {\n                data: {\n                    entity_id: light.entity_id,\n                    brightness_pct: 100,\n                    color_temp: 300\n                }\n            }\n        });\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":620,"wires":[["5687a334154dd78b"]]},{"id":"81bc2142a3005244","type":"function","z":"ccf1abe540a3b5a9","name":"area lights >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"light\",\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedArea\",\n        logic: \"is\",\n        value: msg.linkedArea,\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"includes\",\n        value: \"on,off\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is_not\",\n        value: \"unavailable\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"lights\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":180,"wires":[["ce9f55405f5e998a"]]},{"id":"ce9f55405f5e998a","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":475,"y":180,"wires":[["6fa27568c479e069"]],"l":false},{"id":"6fa27568c479e069","type":"function","z":"ccf1abe540a3b5a9","name":"area covers >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"cover\",\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedArea\",\n        logic: \"is\",\n        value: msg.linkedArea,\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is\",\n        value: \"0\",\n        valueType: \"num\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"covers\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":180,"wires":[["8bed546eba104e3e"]]},{"id":"8bed546eba104e3e","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":715,"y":180,"wires":[["fd6da1a9eb3b4a30"]],"l":false},{"id":"e6fdc8b9ecf9094b","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"light\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is_not\",\n        value: \"unavailable\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"lights\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":500,"wires":[["e4f78c59bc879b46"]]},{"id":"e4f78c59bc879b46","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":615,"y":500,"wires":[["3d427e9849b65be2"]],"l":false},{"id":"e493ad8a541f9cf5","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"light\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"includes\",\n        value: \"on,off\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is_not\",\n        value: \"unavailable\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"lights\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":560,"wires":[["5eee0eaca67bfd41"]]},{"id":"5eee0eaca67bfd41","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":575,"y":560,"wires":[["d90fc0e521e76bb6"]],"l":false},{"id":"793fa08398a6eb1b","type":"function","z":"ccf1abe540a3b5a9","name":"lights >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"light\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"includes\",\n        value: \"on,off\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is_not\",\n        value: \"unavailable\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"lights\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":620,"wires":[["c9c78ba06bf9056c"]]},{"id":"c9c78ba06bf9056c","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":415,"y":620,"wires":[["39c5c048d2a868a7"]],"l":false},{"id":"fd4956c89d222e5a","type":"subflow:94b2243985840d69","z":"ccf1abe540a3b5a9","name":"","x":730,"y":40,"wires":[["3def32a14603ce09"]]},{"id":"a7bc7a0c91bb60df","type":"subflow:94b2243985840d69","z":"ccf1abe540a3b5a9","name":"","x":1110,"y":40,"wires":[["ddf840aed2822269"]]},{"id":"40a3a62c1d267568","type":"subflow:94b2243985840d69","z":"ccf1abe540a3b5a9","name":"","x":170,"y":240,"wires":[["06801e5b53e8a439"]]},{"id":"c0c72f8e57387109","type":"function","z":"ccf1abe540a3b5a9","name":"sun calc","func":"let sunAngleLightOff = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_light_off\"].state);\nlet sunAngleLightOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_light_on\"].state);\nlet oldElevation = msg.data.old_state.attributes.elevation;\nlet newElevation = msg.data.new_state.attributes.elevation;\nlet rising = msg.data.new_state.attributes.rising;\nlet msgs = [];\n\nlet d = new Date();\nlet local_time = d.getHours() + \":\" + d.getMinutes();\n\nif(rising && oldElevation < 0 && newElevation > 0){\n    msgs.push({ entity_id: \"input_datetime.rise_light_time\", time: local_time });\n    msgs.push({ entity_id: \"input_boolean.light_time_status\", state: \"on\" });\n}\n\nif (rising && oldElevation < sunAngleLightOff && newElevation > sunAngleLightOff){\n    msgs.push({ entity_id: \"input_datetime.sun_angle_light_off_time\", time: local_time });\n    msgs.push({ entity_id: \"input_boolean.light_time_status\", state: \"off\" });\n}\n\nif (!rising && oldElevation > sunAngleLightOn && newElevation < sunAngleLightOn) {\n    msgs.push({ entity_id: \"input_datetime.sun_angle_light_on_time\", time: local_time });\n    msgs.push({ entity_id: \"input_boolean.light_time_status\", state: \"on\" });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":120,"wires":[["152ed9bb96332850"]]},{"id":"152ed9bb96332850","type":"subflow:723d4991c3c87385","z":"ccf1abe540a3b5a9","name":"","x":390,"y":120,"wires":[]},{"id":"97bc352aaa75228c","type":"catch","z":"6838183963219fc9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["f4d1fbfec928418b"]]},{"id":"5cde44458366c210","type":"server-events","z":"6838183963219fc9","name":"receive heat_temp","server":"c87720f17866318d","version":2,"eventType":"ifttt_webhook_received","exposeToHomeAssistant":false,"eventData":"{\"entity_id\":\"heat_temp\"}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"$outputData(\"eventData\").event_type.value","valueType":"jsonata"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":130,"y":440,"wires":[["af5ea85654738078"]]},{"id":"93d7011fbd70b7f1","type":"server-state-changed","z":"6838183963219fc9","name":"heat_temp","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_text.heat_temp","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"num","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":100,"y":380,"wires":[["d41bfc19bf37e870"]]},{"id":"8507f5b36fb47028","type":"subflow:ad3b29a5dd67898f","z":"6838183963219fc9","name":"","x":460,"y":40,"wires":[]},{"id":"f4d1fbfec928418b","type":"change","z":"6838183963219fc9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Heaters","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8507f5b36fb47028"]]},{"id":"5c035d30aa0eeaa4","type":"link out","z":"6838183963219fc9","name":"link out 436","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":755,"y":380,"wires":[]},{"id":"a3c5af234ae25394","type":"function","z":"6838183963219fc9","name":"notification","func":"let heat_temp = msg.payload.toString();\nmsg.notification_id = \"heater_temp_lock\";\n\nif (heat_temp == \"Auto\") {\n    let temperatures = global.get(\"temperatures\") || {};\n    let temperaturesKeys = Object.keys(temperatures);\n    let avgData = [0, 0];\n    for (let key of temperaturesKeys) {\n        if (key != \"exterior\") {\n            avgData[0] = temperatures[key].value;\n            avgData[1]++;\n        }\n    }\n    let globalTemp = avgData[1] != 0 ? (avgData[0] / avgData[1]) : 0;\n\n    if (globalTemp <= heat_temp) {\n        msg.speak = \"Chauffage en mode auto\";\n    }\n    msg.dismiss = true;\n} else {\n    msg.alertType = \"success\";\n    msg.title = \"Chauffage vÃ©rrouillÃ©\";\n    msg.message = \"Chauffage verrouillÃ© Ã  \" + heat_temp.replace(\".\", \",\") + \"Â°C\";\n    msg.speak = \"Chauffage verrouillÃ© Ã  \" + heat_temp.replace(\".\", \",\") + \"Â°\";\n    msg.sendMobile = false;\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":380,"wires":[["5c035d30aa0eeaa4"]]},{"id":"d41bfc19bf37e870","type":"function","z":"6838183963219fc9","name":"clean target","func":"let heat_temp = parseFloat(msg.payload.replace(/[^\\d|,.]/g, \"\").replace(\",\", \".\"));\n\nif (isNaN(heat_temp)) {\n    msg.payload = \"Auto\";\n} else {\n    msg.payload = heat_temp > 22 ? 22 : heat_temp;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":380,"wires":[["ad9b6957ee63a8ab"]]},{"id":"5112f376ade581d9","type":"api-call-service","z":"6838183963219fc9","name":"set heat_temp","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":380,"wires":[["a3c5af234ae25394"]]},{"id":"505a65afa55c41df","type":"api-call-service","z":"6838183963219fc9","name":"set heat_temp","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":440,"wires":[[]]},{"id":"af5ea85654738078","type":"function","z":"6838183963219fc9","name":"clean target","func":"let heat_temp = parseFloat(msg.payload.replace(/[^\\d|,.]/g, \"\").replace(\",\", \".\"));\n\nif (isNaN(heat_temp)) {\n    msg.payload = \"Auto\";\n} else {\n    msg.payload = heat_temp > 22 ? 22 : heat_temp;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":440,"wires":[["505a65afa55c41df"]]},{"id":"ba9acd878ee52157","type":"server-state-changed","z":"6838183963219fc9","name":"in_home_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":320,"wires":[["eafe972177b0c41f"]]},{"id":"a3982a46058980e4","type":"server-state-changed","z":"6838183963219fc9","name":"heat","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":120,"wires":[[],["5e73472c6012f08e"]]},{"id":"ad9b6957ee63a8ab","type":"trigger","z":"6838183963219fc9","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":355,"y":380,"wires":[["5112f376ade581d9"]],"l":false},{"id":"96ac39e8656feb5c","type":"function","z":"6838183963219fc9","name":"msgs convectors off","func":"let msgs = [];\n\nif (msg.convectors.length != 0) {\n    for (let convector of msg.convectors) {\n        msgs.push({ entity_id: convector.entity_id, state: \"off\" });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":120,"wires":[["771bec09a66019dd"]]},{"id":"771bec09a66019dd","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":890,"y":120,"wires":[]},{"id":"8f3b675395255275","type":"function","z":"6838183963219fc9","name":"get heat_temp","func":"let user_configuration = global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes;\nlet zone_home = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes;\n\nif (\"ray_zone\" in zone_home && \"convector_config\" in user_configuration && msg.entity_id in user_configuration.convector_config) {\n    msg.value = user_configuration.convector_config[msg.entity_id];\n    if (msg.entity_id == Object.keys(zone_home.ray_zone)[0]) {\n        return [msg, null];\n    } else {\n        msg.txtZone = msg.entity_id == Object.keys(zone_home.ray_zone)[1] ? \"Dans la zone moyenne\" : \"Dans la grande zone\";\n        return [null, msg];\n    }\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":320,"wires":[["08a77a7ed58eedc7"],["08a77a7ed58eedc7","ba726f260be33a59"]]},{"id":"82bb928be71cd17a","type":"server-state-changed","z":"6838183963219fc9","name":"in_middle_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_middle_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":320,"wires":[[],["a7fa1e89e29b2bc7"]]},{"id":"502fe40a2d496315","type":"server-state-changed","z":"6838183963219fc9","name":"in_big_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_big_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":470,"y":320,"wires":[[],["fa233988bc49c813"]]},{"id":"fa233988bc49c813","type":"delay","z":"6838183963219fc9","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":575,"y":320,"wires":[["eafe972177b0c41f"]],"l":false},{"id":"08dcf323de916215","type":"function","z":"6838183963219fc9","name":"notification","func":"msg.notification_id = \"module_heat\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Chauffage dÃ©sactivÃ©\";\n    msg.message = \"Module Chauffage dÃ©sactivÃ©, les chauffages sont allumÃ©s\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1110,"y":500,"wires":[["8d3c03ad03424be9"]]},{"id":"8d3c03ad03424be9","type":"link out","z":"6838183963219fc9","name":"link out 442","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1215,"y":500,"wires":[]},{"id":"4d094f27aedbb9d4","type":"function","z":"6838183963219fc9","name":"msgs convectors on","func":"let msgs = [];\n\nif (msg.convectors.length != 0) {\n    for (let convector of msg.convectors) {\n        msgs.push({ entity_id: convector.entity_id, state: \"on\" });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":500,"wires":[["47ba0eb8d0c9e430"]]},{"id":"47ba0eb8d0c9e430","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":930,"y":500,"wires":[]},{"id":"5e73472c6012f08e","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":120,"wires":[["fead020c09a0aa6e"],[]]},{"id":"f4d57076103097ca","type":"link in","z":"6838183963219fc9","name":"alert temperature","links":["0489992ff2313771","cb44cde26ee31290","f9bc064b194c9654","7ba3931adcd96cf3","d4bd76d5ef491c1f","890a69f3c867f20e"],"x":55,"y":180,"wires":[["74906d8bb03396e9"]]},{"id":"74906d8bb03396e9","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":630,"y":180,"wires":[["289b1cdf5cf523a1"],[]]},{"id":"d91dea48227af123","type":"server-state-changed","z":"6838183963219fc9","name":"heat_temp","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_text.heat_temp","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"num","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"heat_temp","propertyType":"msg","value":"","valueType":"entityState"}],"x":160,"y":180,"wires":[["e98fd77afdd9134f"]]},{"id":"716e7791eeb9e4cc","type":"server-state-changed","z":"6838183963219fc9","name":"module_heat","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":310,"y":180,"wires":[["e98fd77afdd9134f"]]},{"id":"63ecd474b475f903","type":"server-state-changed","z":"6838183963219fc9","name":"module_heat","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_heat","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":500,"wires":[["06d37632c6428263","08dcf323de916215"]]},{"id":"06d37632c6428263","type":"switch","z":"6838183963219fc9","name":"module_heat off ?","property":"module_heat","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":500,"wires":[["de632e789d59102b"]]},{"id":"eafe972177b0c41f","type":"api-current-state","z":"6838183963219fc9","name":"module_heat on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":710,"y":320,"wires":[["8388fb50772457ce"],[]]},{"id":"08a77a7ed58eedc7","type":"api-call-service","z":"6838183963219fc9","name":"set heat_temp","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{value}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1220,"y":320,"wires":[[]]},{"id":"6a698c348a5afd7f","type":"link out","z":"6838183963219fc9","name":"link out 447","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1495,"y":320,"wires":[]},{"id":"41f642fb8e8c5b67","type":"function","z":"6838183963219fc9","name":"notification","func":"let heat_temp = msg.value.toString();\n\nmsg.notification_id = \"heater_temp_lock\";\nif (heat_temp == \"Auto\") {\n    msg.dismiss = true;\n} else {\n    msg.alertType = \"success\";\n    msg.title = \"Chauffage en mode Ã©co\";\n    msg.message = msg.txtZone + \", Chauffage verrouillÃ© Ã  \" + heat_temp.replace(\".\", \",\") + \"Â°C\";\n    msg.sendMobile = true;\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1390,"y":320,"wires":[["6a698c348a5afd7f"]]},{"id":"8388fb50772457ce","type":"api-current-state","z":"6838183963219fc9","name":"heat_on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":880,"y":320,"wires":[["8f3b675395255275"],[]]},{"id":"fead020c09a0aa6e","type":"function","z":"6838183963219fc9","name":"convectors >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"convector\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is_not\",\n        value: \"off\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"convectors\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":120,"wires":[["13445531945f7a82"]]},{"id":"13445531945f7a82","type":"subflow:ea5b93cde6b1bf0a","z":"6838183963219fc9","name":"","x":535,"y":120,"wires":[["96ac39e8656feb5c"]],"l":false},{"id":"de632e789d59102b","type":"function","z":"6838183963219fc9","name":"convectors >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"convector\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"convectors\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":500,"wires":[["f324581ad01e494f"]]},{"id":"f324581ad01e494f","type":"subflow:ea5b93cde6b1bf0a","z":"6838183963219fc9","name":"","x":575,"y":500,"wires":[["4d094f27aedbb9d4"]],"l":false},{"id":"289b1cdf5cf523a1","type":"function","z":"6838183963219fc9","name":"check auto heat","func":"let json_exterior_average_temp = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state);\nlet tempMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.heat\"].state == \"on\";\n\nlet isUnderTempMin = json_exterior_average_temp[0] < tempMin;\nlet heatState = isUnderTempMin && !heat ? \"on\" : !isUnderTempMin && heat ? \"off\" : \"\";\n\nif (heatState !== \"\") {\n    msg.entity_id = \"input_boolean.heat\";\n    msg.state = heatState;\n    return [msg, null];\n}\nreturn [null, msg];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":180,"wires":[["b41a1eb9efd6146b","ce15b84a3b2a877d"],["5b871c278cf602d0"]]},{"id":"127dd27364ca7d75","type":"api-current-state","z":"6838183963219fc9","name":"heat_on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":160,"y":240,"wires":[["a92333cdb1a89159"],[]]},{"id":"eb2186cf04837282","type":"function","z":"6838183963219fc9","name":"set target","func":"let notifications = global.get(\"notifications\") || {};\nlet temperatures = global.get(\"temperatures\") || {};\nlet offsetTemp = 0;\n\nif (msg.linkedArea in temperatures) {\n    let convectorState = global.get(\"homeassistant\").homeAssistant.states[msg.entity_id].state == \"on\";\n    if (msg.windows.length > 0 && convectorState) {\n        msg.notification = \"window_open\";\n        msg.state = \"off\";\n        return msg;\n    } else if (temperatures[msg.linkedArea].online) {\n        let heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"].state;\n        let targetTemp = heat_temp == \"Auto\" ? getTargetTemp(msg.schedule || [], msg.currentTime) : parseFloat(heat_temp);\n        if (targetTemp != 0) {\n            if (temperatures[msg.linkedArea].value < (targetTemp + offsetTemp)) {\n                msg.state = \"on\";\n            } else {\n                msg.state = \"off\";\n            }\n            if ((\"heater_\" + msg.linkedArea) in notifications) {\n                msg.notification = \"heater_reactivated\";\n            }\n            return msg;\n        } else {\n            msg.notification = \"heater_no_target\";\n            msg.state = \"off\";\n            return msg;\n        }\n    } else {\n        msg.notification = \"heater_offline\";\n        msg.state = \"off\";\n        return msg;        \n    }\n}\n\nfunction getTargetTemp(schedule, currentTime) {\n    let mvt = msg.originalLinkedClass == \"motion\";\n    let motionHeater = context.get(\"motionHeater\") || {};\n    let scheduleHour = \"\";\n    let target = 0;\n    let wait = false;\n    for (let s of schedule) {\n        if (currentTime < Object.keys(s)[0]) {\n            break;\n        }\n        scheduleHour = Object.keys(s)[0];\n        wait = s[Object.keys(s)[0]][1];\n        if (!s[Object.keys(s)[0]][1] || mvt || motionHeater[msg.linkedArea + \"_\" + scheduleHour]) {\n            target = s[Object.keys(s)[0]][0];\n        }\n    }\n    if (mvt && wait) {\n        motionHeater[msg.linkedArea + \"_\" + scheduleHour] = true;\n        context.set(\"motionHeater\", motionHeater);\n    } else if (!wait) {\n        motionHeater = {};\n        context.set(\"motionHeater\", motionHeater);\n    }\n    return target;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":240,"wires":[["f4789a90a8eeb4d0","0eb5d66f836a244e"]]},{"id":"f4789a90a8eeb4d0","type":"subflow:723d4991c3c87385","z":"6838183963219fc9","name":"","x":970,"y":240,"wires":[]},{"id":"0a45d820a250a03a","type":"function","z":"6838183963219fc9","name":"msgs convectors","func":"let msgs = [];\n\nif (msg.convectors.length != 0) {\n    for (let convector of msg.convectors) {\n        msgs.push({ originalLinkedClass: (\"linkedClass\" in msg ? msg.linkedClass : \"\"), ...convector, currentTime: msg.currentTime });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":475,"y":240,"wires":[["f8dac6913df2943a"]],"l":false},{"id":"fe7db153e4105d50","type":"link out","z":"6838183963219fc9","name":"link out 513","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1315,"y":240,"wires":[]},{"id":"8a955201a68a4d84","type":"function","z":"6838183963219fc9","name":"notification","func":"msg.notification_id = \"heater_\" + msg.linkedArea;\n\nif (msg.notification == \"window_open\" && \"originalLinkedClass\" in msg && msg.originalLinkedClass == \"window\") {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \" dÃ©sactivÃ©\";\n    msg.message = msg.title + \". \" + setMessage(msg.windows);\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.notification == \"heater_no_target\") {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \" dÃ©sactivÃ©\";\n    msg.message = msg.title + \". Pas de consigne recue\";\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.notification == \"heater_offline\") {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \" dÃ©sactivÃ©\";\n    msg.message = msg.title + \". Le capteur de tempÃ©rature n'est pas accessible\";\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n}else if (msg.notification == \"heater_reactivated\") {\n    msg.speak = msg.alias + \" rÃ©activÃ©\";\n    msg.sendMobile = true;\n    msg.dismiss = true;\n    return msg;\n}\n\nfunction setMessage(windows) {\n    let alias = [];\n    for (let window of windows) {\n        alias.push(window.alias);\n    }\n    if (alias.length == 1) {\n        return \"La fenÃªtre \" + alias[0] + \" est ouverte\";\n    } else {\n        let joinAlias = alias.join(\", \");\n        joinAlias = joinAlias.substring(0, joinAlias.lastIndexOf(\", \")) + \" et \" + joinAlias.substring(joinAlias.lastIndexOf(\", \") + 2);\n        return \"Les fenÃªtres \" + joinAlias + \" sont ouvertes\";\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":240,"wires":[["fe7db153e4105d50"]]},{"id":"0eb5d66f836a244e","type":"switch","z":"6838183963219fc9","name":"notification ?","property":"notification","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":1095,"y":240,"wires":[["8a955201a68a4d84"]],"l":false},{"id":"f8dac6913df2943a","type":"function","z":"6838183963219fc9","name":"windows >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"window\",\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedArea\",\n        logic: \"is\",\n        value: msg.linkedArea,\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is\",\n        value: \"on\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"windows\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":240,"wires":[["6285ab86e33c3de1"]]},{"id":"6285ab86e33c3de1","type":"subflow:ea5b93cde6b1bf0a","z":"6838183963219fc9","name":"","x":695,"y":240,"wires":[["eb2186cf04837282"]],"l":false},{"id":"9d1e5df180bb1596","type":"link out","z":"6838183963219fc9","name":"link out 515","mode":"link","links":["9bdea07f699ed568"],"x":1105,"y":180,"wires":[]},{"id":"9bdea07f699ed568","type":"link in","z":"6838183963219fc9","name":"link in 477","links":["9d1e5df180bb1596"],"x":55,"y":240,"wires":[["127dd27364ca7d75"]]},{"id":"a58c778bb22dbbf1","type":"function","z":"6838183963219fc9","name":"notification","func":"msg.notification_id = \"heater_auto\";\nmsg.alertType = \"success\";\n\nif (msg.state === \"on\") {\n    msg.title = \"Chauffage automatique prÃªt\";\n    msg.message = \"Chauffage automatique prÃªt, la tempÃ©rature est suffisamment basse\";\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.state === \"off\") {\n    msg.title = \"Chauffage automatique dÃ©sactivÃ©\";\n    msg.message = \"Chauffage automatique dÃ©sactivÃ©, la tempÃ©rature est suffisamment haute\";\n    msg.speak = msg.message;\n    msg.sendMobile = true;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1210,"y":180,"wires":[["8ff031019adb02ce"]]},{"id":"8ff031019adb02ce","type":"link out","z":"6838183963219fc9","name":"link out 516","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1315,"y":180,"wires":[]},{"id":"a92333cdb1a89159","type":"function","z":"6838183963219fc9","name":"convectors >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"convector\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is_not\",\n        value: \"unavailable\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"convectors\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":240,"wires":[["5eec1935f64ab35d"]]},{"id":"5eec1935f64ab35d","type":"subflow:ea5b93cde6b1bf0a","z":"6838183963219fc9","name":"","x":415,"y":240,"wires":[["0a45d820a250a03a"]],"l":false},{"id":"ce15b84a3b2a877d","type":"api-call-service","z":"6838183963219fc9","name":"heat","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_{{state}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":970,"y":180,"wires":[["c2cdf1db033f525f"]]},{"id":"c2cdf1db033f525f","type":"change","z":"6838183963219fc9","name":"delete","rules":[{"t":"delete","p":"entity_id","pt":"msg"},{"t":"delete","p":"state","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1055,"y":180,"wires":[["9d1e5df180bb1596"]],"l":false},{"id":"e98fd77afdd9134f","type":"function","z":"6838183963219fc9","name":"get time","func":"let d = new Date();\nlet hour = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\nlet minute = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n\nmsg.currentTime = hour + \":\" + minute;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":180,"wires":[["74906d8bb03396e9"]]},{"id":"0a58c821fdc03b27","type":"link in","z":"a1ed8ea56c7ba1f9","name":"alert temperature","links":["cb44cde26ee31290","890a69f3c867f20e"],"x":55,"y":200,"wires":[["c998dc8531f83616"]]},{"id":"64e37aeabacaf05d","type":"catch","z":"a1ed8ea56c7ba1f9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["c26fcca6989cf4f3"]]},{"id":"a9d131c4dbe11860","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 403","links":["f9bc064b194c9654","7ba3931adcd96cf3"],"x":515,"y":200,"wires":[["83f17bcf7ce1a25a"]]},{"id":"482a9536d24b4218","type":"subflow:ad3b29a5dd67898f","z":"a1ed8ea56c7ba1f9","name":"","x":460,"y":40,"wires":[]},{"id":"c26fcca6989cf4f3","type":"change","z":"a1ed8ea56c7ba1f9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Temperature","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["482a9536d24b4218"]]},{"id":"ebea586e913c75ec","type":"subflow:dbf17bea6affd2ec","z":"a1ed8ea56c7ba1f9","name":"","x":770,"y":320,"wires":[]},{"id":"dba11fcf0d14ada5","type":"subflow:5a05b9ac0289ff03","z":"a1ed8ea56c7ba1f9","name":"","env":[],"x":580,"y":320,"wires":[]},{"id":"84e57cca5619edcb","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 491","mode":"link","links":["1a90a5ef77f5e192","2a568e364b20dd38","154f138241025956"],"x":1045,"y":200,"wires":[]},{"id":"355950fd1e7c52a2","type":"function","z":"a1ed8ea56c7ba1f9","name":"windows >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"window\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"includes\",\n        value: \"on,off\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"windows\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":200,"wires":[["b6877b52de4736c8"]]},{"id":"b6877b52de4736c8","type":"subflow:ea5b93cde6b1bf0a","z":"a1ed8ea56c7ba1f9","name":"","x":995,"y":200,"wires":[["84e57cca5619edcb"]],"l":false},{"id":"0ffd54ad21d55849","type":"function","z":"a1ed8ea56c7ba1f9","name":"area windows >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"window\",\n        valueType: \"str\"\n    },\n    {\n        property: \"attributes.config.linkedArea\",\n        logic: \"is\",\n        value: msg.linkedArea,\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"includes\",\n        value: \"on,off\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = true;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"windows\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":200,"wires":[["b6877b52de4736c8"]]},{"id":"790b8d8b50e2da22","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"let alert_speaker = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_speaker\"].state == \"on\";\nlet alert_light = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_light\"].state == \"on\";\nlet notifications = global.get(\"notifications\") || {};\n\nmsg.notification_id = \"temperature_alert_\" + msg.linkedArea;\nmsg.alertType = \"info\";\nmsg.sendMobile = false;\n\nif (msg.alert == \"equal\") {\n    setMessage({ \"count\": 10, \"hue1\": 40, \"hue2\": 40 }, \"sound\", \"equal.mp3\");\n    return [null, msg];\n} else if (!(msg.notification_id in notifications) && msg.alert == \"outside_max_temp_close\") {\n    msg.title = \"TempÃ©rature haute\";\n    msg.message = \"Fermez\" + setText() + \"pour rester au frais\";\n    setMessage({ \"count\": 10, \"hue1\": 0, \"hue2\": 0 }, \"speak\", msg.message);\n    return [msg, null];\n} else if (!(msg.notification_id in notifications) && msg.alert == \"outside_min_temp_close\") {\n    msg.title = \"TempÃ©rature basse\";\n    msg.message = \"Fermez\" + setText() + \"pour rester au chaud\";\n    setMessage({ \"count\": 10, \"hue1\": 240, \"hue2\": 240 }, \"speak\", msg.message);\n    msg.topic = msg.notification_id;\n    return [msg, null];\n} else if (!(msg.notification_id in notifications) && msg.alert == \"inside_max_temp_open\") {\n    msg.title = \"TempÃ©rature haute\";\n    msg.message = \"Ouvrez\" + setText() + \"pour baisser la tempÃ©rature\";\n    setMessage({ \"count\": 10, \"hue1\": 240, \"hue2\": 240 }, \"speak\", msg.message);\n    msg.topic = msg.notification_id;\n    return [msg, null];\n} else if (!(msg.notification_id in notifications) && msg.alert == \"inside_max_hum_open\") {\n    msg.title = \"HumiditÃ© haute\";\n    msg.message = \"Ouvrez\" + setText() + \"pour baisser l'humiditÃ©\";\n    setMessage({ \"count\": 10, \"hue1\": 0, \"hue2\": 0 }, \"speak\", msg.message);\n    msg.topic = msg.notification_id;\n    return [msg, null];\n} else if (msg.notification_id in notifications && msg.alert == \"\") {\n    msg.dismiss = true;\n    return [msg, null];\n}\n\nfunction setMessage(light, audioType, speaker) {\n    if (alert_light) {\n        msg.lightEffect = light;\n    }\n    if (alert_speaker) {\n        msg[audioType] = speaker;\n    }\n}\n\nfunction setText() {\n    let alias = msg.windows.map(w => w.alias);\n    if (alias.length == 1) {\n        return \" la fenÃªtre \" + alias[0] + \" \";\n    } else {\n        let joined = alias.slice(0, -1).join(\", \") + \" et \" + alias[alias.length - 1];\n        return \" les fenÃªtres \" + joined + \" \";\n    }\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":320,"wires":[["a9f60d370046baba"],["e22beca65116ee37"]]},{"id":"a9f60d370046baba","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 511","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":455,"y":320,"wires":[]},{"id":"3db2c51a82615f14","type":"function","z":"a1ed8ea56c7ba1f9","name":"alerte temp hum","func":"let in_home_zone = global.get('homeassistant').homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet temperatures = global.get(\"temperatures\") || {};\nlet humidities = global.get(\"humidities\") || {};\nlet comforts = msg.comforts;\n\nif (\"exterior\" in temperatures && \"exterior\" in humidities && temperatures[\"exterior\"].online && humidities[\"exterior\"].online) {\n    let msgs = [];\n    let windowsState = {};\n    for (let w of msg.windows) {\n        if (w.linkedArea in temperatures && w.linkedArea in humidities) {\n            if (!(w.linkedArea in windowsState)) {\n                windowsState[w.linkedArea] = { \"on\": [], \"off\": [] };\n            }\n            windowsState[w.linkedArea][w.state].push(w);\n        }\n    }\n\n    for (let area of Object.keys(windowsState)) {\n        if (area in temperatures && area in humidities && temperatures[area].online && humidities[area].online) {\n            if (temperatures[area].value < temperatures[\"exterior\"].value && !temperatures[area].equalTemp && temperatures[\"exterior\"].tendency > 0) {\n                temperatures[area].equalTemp = true;\n                msgs.push({ \"linkedArea\": area, \"alert\": \"equal\" });\n            } else if (temperatures[area].value > temperatures[\"exterior\"].value && temperatures[area].equalTemp && temperatures[\"exterior\"].tendency < 0) {\n                temperatures[area].equalTemp = false;\n                msgs.push({ \"linkedArea\": area, \"alert\": \"equal\" });\n            } else if ( \n                in_home_zone\n                && windowsState[area].on.length > 0\n                && temperatures[area].high\n                && comforts[area].ext_comfort > comforts[area].area_comfort\n                && temperatures[area].tendency > 0\n            ) {\n                msgs.push({ \"linkedArea\": area, alert: \"outside_max_temp_close\", \"windows\": windowsState[area].on });\n            } else if (\n                in_home_zone\n                && windowsState[area].on.length > 0\n                && temperatures[area].low\n                && comforts[area].ext_comfort < comforts[area].area_comfort\n                && temperatures[area].tendency < 0\n            ) {\n                msgs.push({ \"linkedArea\": area, alert: \"outside_min_temp_close\", windows: windowsState[area].on });\n            } else if (\n                in_home_zone\n                && windowsState[area].on.length === 0\n                && temperatures[area].high\n                && comforts[area].ext_comfort < comforts[area].area_comfort\n            ) {\n                msgs.push({ \"linkedArea\": area, alert: \"inside_max_temp_open\", windows: windowsState[area].off });\n            } else if (\n                in_home_zone\n                && windowsState[area].on.length === 0\n                && !temperatures[area].high\n                && !temperatures[area].low\n                && humidities[area].high\n            ) {\n                msgs.push({ \"linkedArea\": area, alert: \"inside_max_hum_open\", windows: windowsState[area].off });\n            } else {\n                msgs.push({ \"linkedArea\": area, alert: \"\" });\n            }\n        }\n    }\n    global.set(\"temperatures\", temperatures);\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":320,"wires":[["790b8d8b50e2da22"]]},{"id":"89125181594851ae","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 474","links":["074855a5536395ac"],"x":55,"y":320,"wires":[["3db2c51a82615f14"]]},{"id":"a6ba23620056cd74","type":"server-state-changed","z":"a1ed8ea56c7ba1f9","name":"modules_temp_hum","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_temp_hum","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":400,"wires":[["0c1bc4bca64606a1"]]},{"id":"0c1bc4bca64606a1","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"msg.notification_id = \"module_temp_hum\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Alertes tempÃ©rature dÃ©sactivÃ©\";\n    msg.message = \"Module Alertes tempÃ©rature dÃ©sactivÃ©, vous ne recevrez plus d'alerte pour l'optimisation du flux d'air dans votre domicile\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":400,"wires":[["4eab8cffd742e405"]]},{"id":"4eab8cffd742e405","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 517","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":415,"y":400,"wires":[]},{"id":"c998dc8531f83616","type":"api-current-state","z":"a1ed8ea56c7ba1f9","name":"module_temp_hum on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temp_hum","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":210,"y":200,"wires":[["355950fd1e7c52a2"],[]]},{"id":"83f17bcf7ce1a25a","type":"api-current-state","z":"a1ed8ea56c7ba1f9","name":"module_temp_hum on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temp_hum","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":670,"y":200,"wires":[["0ffd54ad21d55849"],[]]},{"id":"0c754dbb4d89f587","type":"split","z":"a1ed8ea56c7ba1f9","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":275,"y":260,"wires":[["bc0aaa608a491c5e"]],"l":false},{"id":"bc0aaa608a491c5e","type":"comfort","z":"a1ed8ea56c7ba1f9","name":"area comfort","tempField":"payload.area_temperature","tempFieldType":"msg","mrtField":"payload.temperature","mrtFieldType":"operative","humidityField":"payload.area_humidity","humidityFieldType":"msg","airspeedField":"0","airspeedFieldType":"num","metabolicRateField":"payload.area_metabolic","metabolicRateFieldType":"msg","clothingLevelField":"0.5","clothingLevelFieldType":"num","comfortField":"payload.area_comfort","comfortFieldType":"msg","sensationField":"payload.sensation","sensationFieldType":"msg","x":390,"y":260,"wires":[["a42bb7c4289a9b13"]]},{"id":"b7f5f334b9bf4f44","type":"function","z":"a1ed8ea56c7ba1f9","name":"prepare data","func":"let rising = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].attributes.rising;\nlet temperatures = global.get(\"temperatures\") || {};\nlet humidities = global.get(\"humidities\") || {};\nlet comforts = global.get(\"comforts\") || {};\nmsg.payload = [];\n\nif (\"exterior\" in temperatures && \"exterior\" in humidities && temperatures[\"exterior\"].online && humidities[\"exterior\"].online) {\n    for (let area of Object.keys(temperatures).filter( area => area != \"exterior\")) {\n        if (area in humidities) {\n            msg.payload.push({\n                linkedArea: area,\n                area_temperature: temperatures[area].value,\n                area_humidity: humidities[area].value,\n                area_metabolic: 1.1,\n                ext_temperature: temperatures[\"exterior\"].value,\n                ext_humidity: humidities[\"exterior\"].value,\n                ext_metabolic: rising ? 1.25 : 1.1\n            });\n        }\n    }\n}\n\nif (msg.payload.length != 0) {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":260,"wires":[["0c754dbb4d89f587"]]},{"id":"248b3c4918ec7f01","type":"function","z":"a1ed8ea56c7ba1f9","name":"set comforts","func":"msg.comforts = global.get(\"comforts\") || {};\n\nfor (let comfort of msg.payload) {\n    if (!(comfort.linkedArea in msg.comforts)) {\n        msg.comforts[comfort.linkedArea] = {};\n    }\n    msg.comforts[comfort.linkedArea].area_comfort = Math.round(comfort.area_comfort * 100) / 100;\n    msg.comforts[comfort.linkedArea].ext_comfort = Math.round(comfort.ext_comfort * 100) / 100;\n}\n\nglobal.set(\"comforts\", msg.comforts);\ndelete msg.payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":260,"wires":[["074855a5536395ac"]]},{"id":"6d4e36ce84f26e1f","type":"join","z":"a1ed8ea56c7ba1f9","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":655,"y":260,"wires":[["248b3c4918ec7f01"]],"l":false},{"id":"154f138241025956","type":"link in","z":"a1ed8ea56c7ba1f9","name":"get comforts","links":["84e57cca5619edcb"],"x":55,"y":260,"wires":[["b7f5f334b9bf4f44"]]},{"id":"a42bb7c4289a9b13","type":"comfort","z":"a1ed8ea56c7ba1f9","name":"ext comfort","tempField":"payload.ext_temperature","tempFieldType":"msg","mrtField":"payload.temperature","mrtFieldType":"operative","humidityField":"payload.ext_humidity","humidityFieldType":"msg","airspeedField":"0","airspeedFieldType":"num","metabolicRateField":"payload.ext_metabolic","metabolicRateFieldType":"msg","clothingLevelField":"0.5","clothingLevelFieldType":"num","comfortField":"payload.ext_comfort","comfortFieldType":"msg","sensationField":"payload.sensation","sensationFieldType":"msg","x":550,"y":260,"wires":[["6d4e36ce84f26e1f"]]},{"id":"074855a5536395ac","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 529","mode":"link","links":["1a90a5ef77f5e192","2a568e364b20dd38","89125181594851ae"],"x":875,"y":260,"wires":[]},{"id":"eecff82876dd3de7","type":"server-events","z":"a1ed8ea56c7ba1f9","name":"ext_temp","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"ext_temp\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":100,"y":120,"wires":[["cba8c1048ec7addd"]]},{"id":"24c3e101524bf480","type":"server-events","z":"a1ed8ea56c7ba1f9","name":"int_temp","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"int_temp\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":240,"y":120,"wires":[["cba8c1048ec7addd"]]},{"id":"0412ea4842069bd6","type":"server-events","z":"a1ed8ea56c7ba1f9","name":"ext_humidity","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"ext_humidity\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":390,"y":120,"wires":[["cba8c1048ec7addd"]]},{"id":"0e0a641f3c0ae1b5","type":"server-events","z":"a1ed8ea56c7ba1f9","name":"int_humidity","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"config\":{\"linkedClass\":\"int_humidity\"}}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"event","propertyType":"msg","value":"$outputData(\"eventData\").event","valueType":"jsonata"}],"event_type":"","x":550,"y":120,"wires":[["cba8c1048ec7addd"]]},{"id":"cba8c1048ec7addd","type":"function","z":"a1ed8ea56c7ba1f9","name":"set lastChange","func":"let type = { int_temp: \"temperatures\", ext_temp: \"temperatures\", int_humidity: \"humidities\", ext_humidity: \"humidities\" };\nlet linkedClass = msg.event.new_state.attributes.config.linkedClass;\nlet linkedArea = msg.event.new_state.attributes.config.linkedArea || \"\";\n\nlet data = global.get(type[linkedClass]) || {};\nif (linkedArea in data) {\n    data[linkedArea].lastChange = new Date().getTime();\n    global.set(type[linkedClass], data);\n}","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":120,"wires":[]},{"id":"77e530deb7bf581d","type":"catch","z":"7cc0f49198f44c93","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["5a7b5ddea88e190c"]]},{"id":"3c7ed0693727de58","type":"subflow:ad3b29a5dd67898f","z":"7cc0f49198f44c93","name":"","x":460,"y":40,"wires":[]},{"id":"5a7b5ddea88e190c","type":"change","z":"7cc0f49198f44c93","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Devices","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["3c7ed0693727de58"]]},{"id":"b6536d45be534fe7","type":"comment","z":"7cc0f49198f44c93","name":"linkedClass : ventilation","info":"","x":140,"y":480,"wires":[]},{"id":"4d4b6a5f9d5a991b","type":"comment","z":"7cc0f49198f44c93","name":"linkedClass : water_heat","info":"","x":150,"y":120,"wires":[]},{"id":"fbc1c0ac1d7bec76","type":"link in","z":"7cc0f49198f44c93","name":"link in 408","links":["0489992ff2313771","1849c3d6ff1ccfb0","26abb5af0922722f","cb44cde26ee31290","e2084ffb49335b77","d4bd76d5ef491c1f","bc0e069e4d5ee51f","b2d815fa4524aaeb","ad1b8fdc045fd0dc","890a69f3c867f20e"],"x":55,"y":780,"wires":[["802bd482120f594c"]]},{"id":"bd500f79237a0f09","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":1130,"y":780,"wires":[]},{"id":"bfb175b03433a260","type":"comment","z":"7cc0f49198f44c93","name":"controle_device","info":"","x":120,"y":720,"wires":[]},{"id":"2b4fd97f1ef896db","type":"function","z":"7cc0f49198f44c93","name":"control_devices","func":"let user_config_control_device = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.control_device\"].attributes.config;\nlet events = [];\nlet msgs = [];\n\nif (\"control_device\" in msg) {\n    events = events.concat(msg.control_device);\n} else if (\"linkedClass\" in msg && msg.linkedClass === \"time\" && \"time\" in user_config_control_device && Array.isArray(user_config_control_device.time)) {\n    events = events.concat(user_config_control_device.time);\n} else if (\"linkedClass\" in msg && \"linkedArea\" in msg) {\n    let globalClass = \"linkedClass_\" + msg.linkedClass + \"_\" + msg.linkedArea;\n    if (globalClass in user_config_control_device) {\n        events = events.concat(user_config_control_device[globalClass]);\n    }\n}\n\nfor (let event of events) {\n    if (logicalOperator(event[\"if\"])) {\n        for (let actions of event[\"then\"]) {\n            //WAIT\n            if (typeof actions[0] == \"string\" && actions[0].search(/wait [0-9]/g) != -1 && typeof actions[1] == \"string\" && typeof actions[2] == \"object\") {\n                let result = logicalOperator(actions[1]);\n                if (result) {\n                    controlDevice(actions[2]);\n                } else {\n                    let waits = global.get(\"waits\") || {};\n                    waits[actions[1]] = { then: actions[2] };\n                    global.set(\"waits\", waits);\n                    msgs.push({ waitsId: actions[1], delay: parseFloat(actions[0].split(\" \")[1]) * 1000 });\n                }\n                // CONDITION\n            } else if (typeof actions[0] == \"string\" && typeof actions[1] == \"object\") {\n                let result = logicalOperator(actions[0]);\n                if (result && actions.length > 1) {\n                    controlDevice(actions[1]);\n                } else if (!result && actions.length > 2) {\n                    controlDevice(actions[2]);\n                }\n                // ACTION\n            } else if (typeof actions[0] == \"object\") {\n                controlDevice(actions);\n            }\n        }\n    }\n}\n\nreturn [msgs];\n\nfunction controlDevice(actions) {\n    for (let action of actions) {\n        let state = global.get(\"homeassistant\").homeAssistant.states[action[0]].state;\n        action[1] = typeof action[1] === \"boolean\" ? action[1] ? \"on\" : \"off\" : action[1];\n        if (state != action[1]) {\n            msgs.push({\n                entity_id: action[0],\n                state: action[1],\n                delay: action.length == 3 ? action[2] * 1000 : 0\n            });\n        }\n    }\n}\n\nfunction logicalOperator(condition) {\n    let resultOR = false;\n    if (condition != \"\") {\n        let operatorORSplit = condition.split(\"OR\");\n        let countORLength = operatorORSplit.length - 1;\n        for (let i = 0; i < operatorORSplit.length; i++) {\n            let operatorANDSplit = operatorORSplit[i].split(\"AND\");\n            let resultAND = true;\n            for (let i = 0; i < operatorANDSplit.length; i++) {\n                let operatorAND = operatorANDSplit[i];\n                let csplit = operatorAND.trim().split(\" \").slice(0, 2);\n                csplit.push(operatorAND.substring(operatorAND.indexOf(csplit[1]) + csplit[1].length).trim());\n                resultAND = resultAND && comparisonOperator(getHaState(csplit[0]), csplit[1], csplit[2]);\n                if (countORLength == i && !resultAND) {\n                    return resultAND;\n                }\n            }\n            resultOR = resultOR || resultAND;\n        }\n    }\n    return resultOR;\n}\n\nfunction comparisonOperator(haState, operator, userState) {\n    userState = isNaN(userState) ? userState : parseFloat(userState);\n    let result = false;\n    if (operator == \"==\") {\n        result = haState == userState;\n    } else if (operator == \"!=\") {\n        result = haState != userState;\n    } else if (operator == \"<\") {\n        result = haState < userState;\n    } else if (operator == \"<=\") {\n        result = haState <= userState;\n    } else if (operator == \">\") {\n        result = haState > userState;\n    } else if (operator == \">=\") {\n        result = haState >= userState;\n    }\n    return result;\n}\n\nfunction getHaState(haState) {\n    if (haState.startsWith(\"global.\")) {\n        let ha_state_split = haState.replace(\"global.\", \"\").split(\".\");\n        let gbl_ha_state = global.get(ha_state_split[0]) || {};\n        for (let i = 1; i < ha_state_split.length; i++) {\n            gbl_ha_state = ha_state_split[i] in gbl_ha_state ? gbl_ha_state[ha_state_split[i]] : undefined;\n        }\n        return gbl_ha_state != undefined ? isNaN(gbl_ha_state) ? gbl_ha_state : parseFloat(gbl_ha_state) : null;\n    } else if (haState.startsWith(\"time\")) {\n        let date = new Date();\n        let hours = date.getHours() < 10 ? \"0\" + date.getHours() : date.getHours();\n        let minutes = date.getMinutes() < 10 ? \"0\" + date.getMinutes() : date.getMinutes();\n        return hours + \":\" + minutes;\n    } else {\n        let ha_state_split = haState.split(\".\");\n        let gbl_ha_state = global.get(\"homeassistant\").homeAssistant.states[ha_state_split[0] + \".\" + ha_state_split[1]] || {};\n        if (ha_state_split.length > 2) {\n            for (let i = 2; i < ha_state_split.length; i++) {\n                gbl_ha_state = ha_state_split[i] in gbl_ha_state ? gbl_ha_state[ha_state_split[i]] : undefined;\n            }\n        } else {\n            gbl_ha_state = \"state\" in gbl_ha_state ? gbl_ha_state.state : undefined;\n        }\n        return gbl_ha_state != undefined ? isNaN(gbl_ha_state) ? gbl_ha_state : parseFloat(gbl_ha_state) : null;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":780,"wires":[["ef2536cf856a81d2"]]},{"id":"ef2536cf856a81d2","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":840,"y":780,"wires":[["754803cc902fbd8f"]]},{"id":"e142d4fca5be15b6","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_ventilation","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_ventilation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_ventilation","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":660,"wires":[["ec47075613cfdd43"]]},{"id":"6a77bcc53698bdf2","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" };\nlet devices = msg.ventilations;\nlet msgs = [];\n\nfor (let device of devices) {\n    msgs.push({\n        module_ventilation: msg.module_ventilation,\n        entity_id: device.entity_id,\n        state: inverse[device.state],\n        linkedArea: device.linkedArea\n    });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":660,"wires":[["f817476f6c09cf33","43a514d60ce67875"]]},{"id":"43a514d60ce67875","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"let notification_id = \"vmc_\" + msg.linkedArea;\nlet msgs = [];\n\nif (msg.module_ventilation == \"off\") {\n    msgs.push(\n        {\n            notification_id: notification_id,\n            alertType: \"info\",\n            title: \"Module Ventilation\",\n            message: \"Module ventilation dÃ©sactivÃ©, la ventilation est active et les alertes tempÃ©ratures sont dÃ©sactivÃ©es\",\n            sendMobile: true\n        }\n    );\n} else {\n    msgs.push({ notification_id: notification_id, dismiss: true });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":660,"wires":[["76cea9e99f705380"]]},{"id":"bacdad7c8a83142f","type":"function","z":"7cc0f49198f44c93","name":"resend low battery notify","func":"let notifications = global.get(\"notifications\") || {};\nlet lowBatteryCount = 0;\n\nfor (let notificationsKey of Object.keys(notifications)) {\n    if (notificationsKey.indexOf(\"battery_lvl\") != -1) {\n        lowBatteryCount++;\n    }\n}\n\nif (lowBatteryCount != 0) {\n    if (lowBatteryCount == 1) {\n        msg.speak = \"Vous avez un capteur avec un niveau de batterie faible.\";\n    } else {\n        msg.speak = \"Vous avez plusieurs capteurs avec des niveaux de batterie faible.\";\n    }\n    msg.speak += \" Pour en savoir plus, regardez vos notifications.\";\n    return msg;\n\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":900,"wires":[["56d769fc796ea088"]]},{"id":"21e9ce7eda339017","type":"server-state-changed","z":"7cc0f49198f44c93","name":"in_home_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":900,"wires":[["34c3b26f84cb0b80"],[]]},{"id":"34c3b26f84cb0b80","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":280,"y":900,"wires":[["bacdad7c8a83142f"]]},{"id":"9efffdb0ef885bb8","type":"link out","z":"7cc0f49198f44c93","name":"link out 207","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":895,"y":960,"wires":[]},{"id":"56d769fc796ea088","type":"subflow:dbf17bea6affd2ec","z":"7cc0f49198f44c93","name":"","x":690,"y":900,"wires":[]},{"id":"5a1bf07e167f1a1d","type":"comment","z":"7cc0f49198f44c93","name":"alert : low battery","info":"","x":120,"y":840,"wires":[]},{"id":"a3bef21201367a5b","type":"function","z":"7cc0f49198f44c93","name":"wait","func":"let entity_id = msg.entity_id;\nlet state = msg.new_state;\nlet waits = global.get(\"waits\") || {};\nlet msgs = [];\n\nfor (let key of Object.keys(waits)) {\n    if (key.includes(entity_id)) {\n        let result = logicalOperator(key);\n        if (result) {\n            controlDevice(waits[key].then);\n            delete waits[key];\n            global.set(\"waits\", waits);\n            return [msgs];\n        }\n    }\n}\n\nfunction controlDevice(actions) {\n    for (let action of actions) {\n        let state = global.get(\"homeassistant\").homeAssistant.states[action[0]].state;\n        action[1] = typeof action[1] === \"boolean\" ? action[1] ? \"on\" : \"off\" : action[1];\n        if (state != action[1]) {\n            msgs.push({\n                entity_id: action[0],\n                state: action[1],\n                delay: action.length == 3 ? action[2] * 1000 : 0\n            });\n        }\n    }\n}\n\nfunction logicalOperator(condition) {\n    let resultOR = false;\n    if (condition != \"\") {\n        let operatorORSplit = condition.split(\"OR\");\n        let countORLength = operatorORSplit.length - 1;\n        for (let i = 0; i < operatorORSplit.length; i++) {\n            let operatorANDSplit = operatorORSplit[i].split(\"AND\");\n            let resultAND = true;\n            for (let i = 0; i < operatorANDSplit.length; i++) {\n                let operatorAND = operatorANDSplit[i];\n                let csplit = operatorAND.trim().split(\" \").slice(0, 2);\n                csplit.push(operatorAND.substring(operatorAND.indexOf(csplit[1]) + csplit[1].length).trim());\n                resultAND = resultAND && comparisonOperator(getHaState(csplit[0]), csplit[1], csplit[2]);\n                if (countORLength == i && !resultAND) {\n                    return resultAND;\n                }\n            }\n            resultOR = resultOR || resultAND;\n        }\n    }\n    return resultOR;\n}\n\nfunction comparisonOperator(haState, operator, userState) {\n    userState = isNaN(userState) ? userState : parseFloat(userState);\n    let result = false;\n    if (operator == \"==\") {\n        result = haState == userState;\n    } else if (operator == \"!=\") {\n        result = haState != userState;\n    } else if (operator == \"<\") {\n        result = haState < userState;\n    } else if (operator == \"<=\") {\n        result = haState <= userState;\n    } else if (operator == \">\") {\n        result = haState > userState;\n    } else if (operator == \">=\") {\n        result = haState >= userState;\n    }\n    return result;\n}\n\nfunction getHaState(haState) {\n    if (haState.startsWith(\"global.\")) {\n        let ha_state_split = haState.replace(\"global.\", \"\").split(\".\");\n        let gbl_ha_state = global.get(ha_state_split[0]) || {};\n        for (let i = 1; i < ha_state_split.length; i++) {\n            gbl_ha_state = ha_state_split[i] in gbl_ha_state ? gbl_ha_state[ha_state_split[i]] : undefined;\n        }\n        return gbl_ha_state != undefined ? isNaN(gbl_ha_state) ? gbl_ha_state : parseFloat(gbl_ha_state) : null;\n    } else if (haState.startsWith(\"time\")) {\n        let date = new Date();\n        let hours = date.getHours() < 10 ? \"0\" + date.getHours() : date.getHours();\n        let minutes = date.getMinutes() < 10 ? \"0\" + date.getMinutes() : date.getMinutes();\n        return hours + \":\" + minutes;\n    } else {\n        let ha_state_split = haState.split(\".\");\n        let gbl_ha_state = global.get(\"homeassistant\").homeAssistant.states[ha_state_split[0] + \".\" + ha_state_split[1]] || {};\n        if (ha_state_split.length > 2) {\n            for (let i = 2; i < ha_state_split.length; i++) {\n                gbl_ha_state = ha_state_split[i] in gbl_ha_state ? gbl_ha_state[ha_state_split[i]] : undefined;\n            }\n        } else {\n            gbl_ha_state = \"state\" in gbl_ha_state ? gbl_ha_state.state : undefined;\n        }\n        return gbl_ha_state != undefined ? isNaN(gbl_ha_state) ? gbl_ha_state : parseFloat(gbl_ha_state) : null;\n    }\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":780,"wires":[["ef2536cf856a81d2"]]},{"id":"754803cc902fbd8f","type":"function","z":"7cc0f49198f44c93","name":"wait ?","func":"if (\"waitsId\" in msg) {\n    let waits = global.get(\"waits\") || {};\n    if (msg.waitsId in waits) {\n        delete waits[msg.waitsId];\n        global.set(\"waits\", waits);\n    }\n} else {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":780,"wires":[["bd500f79237a0f09"]]},{"id":"99b74de3a8d811fc","type":"link in","z":"7cc0f49198f44c93","name":"link in 444","links":["51f8014713eaece3","54034c9729e47e5f"],"x":455,"y":780,"wires":[["ab235c6e005b9dba"]]},{"id":"f817476f6c09cf33","type":"link out","z":"7cc0f49198f44c93","name":"link out 477","mode":"link","links":["068da256e16f3fcf","7516e795e9c61133","48051bfb384dfbd3"],"x":655,"y":660,"wires":[]},{"id":"76cea9e99f705380","type":"link out","z":"7cc0f49198f44c93","name":"link out 478","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":875,"y":660,"wires":[]},{"id":"86e655c54b6befaf","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_water_heat","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_water_heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":360,"wires":[["e8fb8feec7a4dfa5","0853fac1572e1008"]]},{"id":"9258d34035c742aa","type":"link in","z":"7cc0f49198f44c93","name":"link in 453","links":["cb44cde26ee31290","33d0fdd326f277f0","890a69f3c867f20e"],"x":55,"y":300,"wires":[["dc64f91e4d65bcf5"]]},{"id":"c6459e3b13061ab7","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" };\nlet devices = msg.water_heats;\nlet msgs = [];\n\nfor (let device of devices) {\n    msgs.push({\n        entity_id: device.entity_id,\n        state: inverse[device.state]\n    });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":360,"wires":[["73f34f0150aff765"]]},{"id":"73f34f0150aff765","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":750,"y":360,"wires":[]},{"id":"e8fb8feec7a4dfa5","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"water_heat\";\n\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Chauffe-eau dÃ©sactivÃ©\";\n    msg.message = \"Module Chauffe-eau dÃ©sactivÃ©, le chauffe eau est allumÃ©\";\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":930,"y":360,"wires":[["ce168531822379e5"]]},{"id":"ce168531822379e5","type":"link out","z":"7cc0f49198f44c93","name":"link out 479","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1035,"y":360,"wires":[]},{"id":"bb6101f7fb19d8f8","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let water_heats = global.get(\"water_heats\") || {};\nlet devices = msg.water_heats;\nlet msgs = [];\n\nfor (let device of devices) {\n    water_heats[device.entity_id] = msg.state == \"on\" ? \"manual\" : \"\";\n    msgs.push({\n        entity_id: device.entity_id,\n        state: msg.state,\n        alias: device.alias\n    });\n}\n\nglobal.set(\"water_heats\", water_heats);\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":240,"wires":[["86f841263b9d8ac6","34949d27140eb419"]]},{"id":"86f841263b9d8ac6","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":1130,"y":240,"wires":[]},{"id":"428ab7267bbfef8b","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":1110,"y":180,"wires":[]},{"id":"40c697883e6c606b","type":"function","z":"7cc0f49198f44c93","name":"prepare device","func":"let water_heats = global.get(\"water_heats\") || {};\n\nif (msg.state === \"on\") {\n    let entity_histories = msg.entity_histories;\n    let find = false;\n    for (let history of entity_histories) {\n        if (history.state == \"on\") {\n            find = true;\n            break;\n        }\n    }\n    if (!find) {\n        water_heats[msg.entity_id] = \"in_big_zone\";\n        return msg;\n    }\n} else {\n    water_heats[msg.entity_id] = \"\";\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":180,"wires":[["428ab7267bbfef8b","abba11061d28fac4"]]},{"id":"abba11061d28fac4","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"water_heat\";\n\nif (msg.state == \"on\") {\n    let water_heat_duration = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state);\n    msg.title = \"Dans la grande zone: Chauffe-eau activÃ©\";\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allumÃ© \" + water_heat_duration + \" min\";\n    msg.speak = msg.message;\n    msg.alertType = \"success\";\n    msg.sendMobile = true;\n    return msg;\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":180,"wires":[["088f2437bb522d14"]]},{"id":"088f2437bb522d14","type":"link out","z":"7cc0f49198f44c93","name":"link out 482","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1395,"y":180,"wires":[]},{"id":"ebc5272f39f732f1","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":795,"y":180,"wires":[["40c697883e6c606b"]],"l":false},{"id":"1f43db11c8e7d8fb","type":"trigger-state","z":"7cc0f49198f44c93","name":"in_big_zone","server":"c87720f17866318d","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"input_boolean.in_big_zone","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"entity_id","targetValue":"input_boolean.module_water_heat","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"entity_id","targetValue":"input_boolean.in_big_zone","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"inputs":0,"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","enableInput":false,"x":110,"y":180,"wires":[["55eac8dff698a429"],[]]},{"id":"37315bdc76a2adb8","type":"trigger-state","z":"7cc0f49198f44c93","name":"activate manual","server":"c87720f17866318d","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"input_boolean.water_heat_temp","entityidfiltertype":"exact","debugenabled":false,"constraints":[],"inputs":0,"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","enableInput":false,"x":120,"y":240,"wires":[["3f3fa09655239c17","8ea5d0179ce614e9"],[]]},{"id":"dc64f91e4d65bcf5","type":"function","z":"7cc0f49198f44c93","name":"check","func":"let module_water_heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.module_water_heat\"].state == \"on\";\nlet in_big_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_big_zone\"].state == \"on\";\nlet water_heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.water_heat_temp\"].state == \"on\";\n\nif (module_water_heat && in_big_zone && !water_heat_temp) {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":300,"wires":[["c9e944ee95454391"]]},{"id":"539dc2c4d06a7fb3","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let waterHeatPct = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_pct\"].state) / 100;\nlet water_heats = global.get(\"water_heats\") || {};\nlet devices = msg.water_heats;\nlet msgs = [];\n\nfor (let device of devices) {\n    if (!(device.entity_id in water_heats) || water_heats[device.entity_id] != \"manual\" && water_heats[device.entity_id] != \"in_big_zone\") {\n        let timeRange = calcIsScheduled(msg.currentTime, device);\n        if (typeof timeRange == \"object\") {\n            let times = calcRanges(timeRange[0], timeRange[1]);\n            let result = typeof calcIsScheduled(msg.currentTime, times) == \"object\" ? \"on\" : \"off\";\n            water_heats[device.entity_id] = result == \"on\" ? \"scheduled\" : \"\";\n            if (device.state != result) {\n                msgs.push({ entity_id: device.entity_id, state: result, alias: device.alias });\n            }\n        } else if (device.state != (timeRange ? \"on\" : \"off\")) {\n            water_heats[device.entity_id] = timeRange ? \"scheduled\" : \"\";\n            msgs.push({ entity_id: device.entity_id, state: timeRange ? \"on\" : \"off\", alias: device.alias });\n        }\n    }\n}\n\nglobal.set(\"water_heats\", water_heats);\nreturn [msgs];\n\nfunction calcRanges(onTime, offTime) {\n    let start = time_to_minutes(onTime);\n    let end = time_to_minutes(offTime);\n    end = start > end ? 1440 + end : end;\n    let times = { onTime: [], offTime: [] };\n    for (let i = 0; i < (parseInt(end - start) / 60); i++) {\n        times.onTime.push(minutes_to_time(start + (i + 1) * 60 - waterHeatPct * 60));\n        times.offTime.push(minutes_to_time(start + (i + 1) * 60));\n    }\n    return times;\n}\n\nfunction calcIsScheduled(currentTime, device) {\n    let isTime = false;\n    if (device.onTime.length == device.offTime.length) {\n        if (device.onTime.length == 0) {\n            return true;\n        }\n        for (let i = 0; i < device.onTime.length; i++) {\n            isTime = isTime || (device.onTime[i] < device.offTime[i] && device.onTime[i] <= currentTime && currentTime < device.offTime[i]); \n            isTime = isTime || (device.onTime[i] > device.offTime[i] && (device.onTime[i] <= currentTime && currentTime <= \"23:59\" || \"00:00\" <= currentTime && currentTime < device.offTime[i]));\n            if (isTime) {\n                return [device.onTime[i], device.offTime[i]];\n            }\n        }\n    }\n    return isTime;\n}\n\nfunction time_to_minutes(timeTxt) {\n    timeTxt = timeTxt.split(\":\");\n    return parseInt(timeTxt[0]) * 60 + parseInt(timeTxt[1]);\n}\n\nfunction minutes_to_time(time) {\n    time = time >= 1440 ? time - 1440 : time;\n    let hours = parseInt(time / 60);\n    hours = hours < 10 ? \"0\" + hours : hours == 0 ? \"00\" : hours;\n    let minutes = time % 60;\n    minutes = minutes < 10 ? \"0\" + minutes : minutes == 0 ? \"00\" : minutes;\n    return hours + \":\" + minutes;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":300,"wires":[["c4b276bd7cbbc844","370eb10450012677"]]},{"id":"370eb10450012677","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":730,"y":300,"wires":[]},{"id":"3e25f16111347f71","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":1150,"y":540,"wires":[]},{"id":"faa3a5726b7782f9","type":"link in","z":"7cc0f49198f44c93","name":"link in 455","links":["cb44cde26ee31290","33d0fdd326f277f0","890a69f3c867f20e"],"x":55,"y":540,"wires":[["c45a2415bdcf7e98"]]},{"id":"c45a2415bdcf7e98","type":"api-current-state","z":"7cc0f49198f44c93","name":"module_ventilation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_ventilation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":410,"y":540,"wires":[["47908483fafc8782"],[]]},{"id":"7516e795e9c61133","type":"link in","z":"7cc0f49198f44c93","name":"link in 456","links":["f817476f6c09cf33","84cf327ba8dbb95c"],"x":1025,"y":540,"wires":[["3e25f16111347f71"]]},{"id":"756f4d593faf47cd","type":"function","z":"7cc0f49198f44c93","name":"prepare scheduled","func":"let ventilations = global.get(\"ventilations\") || {};\nlet devices = msg.ventilations;\nlet msgs = [];\n\nfor (let device of devices) {\n    let results = calcIsScheduled(msg.currentTime, device);\n    if (device.linkedArea in ventilations\n        && (results[1] === \"scheduled\" && ventilations[device.linkedArea] !== \"scheduled\" || results[1] === \"\" && ventilations[device.linkedArea] === \"scheduled\")\n        || !(device.linkedArea in ventilations)) {\n        ventilations[device.linkedArea] = results[1];\n        msgs.push({\n            entity_id: device.entity_id,\n            state: results[0],\n            linkedArea: device.linkedArea,\n            alias: device.alias\n        });\n    }\n}\nif (msgs.length !== 0) {\n    global.set(\"ventilations\", ventilations);\n    return [msgs];\n}\n\nfunction calcIsScheduled(currentTime, device) {\n    if (device.onTime.length === device.offTime.length) {\n        let isTime = false;\n        for (let i = 0; i < device.onTime.length; i++) {\n            isTime = isTime\n                || (device.onTime[i] < device.offTime[i] && device.onTime[i] <= currentTime && currentTime < device.offTime[i])\n                || (device.onTime[i] > device.offTime[i] && (\n                    device.onTime[i] <= currentTime && currentTime <= \"23:59\"\n                    || \"00:00\" <= currentTime && currentTime < device.offTime[i]))\n                ;\n            if (isTime) {\n                return [\"on\", \"scheduled\"];\n            }\n        }\n    }\n    return [\"off\", \"\"];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":540,"wires":[["3e25f16111347f71","aeb2eff70381a653"]]},{"id":"0b2998b8acb6ae64","type":"api-current-state","z":"7cc0f49198f44c93","name":"module_ventilation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_ventilation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":430,"y":600,"wires":[["b2317293f5dbab97"],[]]},{"id":"0419929f6aea7cca","type":"link out","z":"7cc0f49198f44c93","name":"link out 485","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1255,"y":600,"wires":[]},{"id":"bdb378dcde27f270","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"let ventilations = global.get(\"ventilations\") || {};\nmsg.notification_id = \"vmc_\" + msg.linkedArea;\n\nif (ventilations[msg.linkedArea] == \"scheduled\") {\n    msg.alertType = \"success\";\n    msg.title = \"Ventilation activÃ©e par planification\";\n    msg.message = \"La ventilation \" + msg.alias + \" est active\";\n    msg.sendMobile = false;\n    return msg;\n} else if (ventilations[msg.linkedArea] == \"max_humidity\") {\n    msg.alertType = \"success\";\n    msg.title = \"Ventilation \" + msg.alias + \" activÃ©e\";\n    msg.message = \"L'humiditÃ© est haute, la ventilation \" + msg.alias + \" est activÃ©e\";\n    msg.speak = msg.message;\n    msg.sendMobile = false;\n    return msg;\n} else if (ventilations[msg.linkedArea] == \"humidity\") {\n    msg.alertType = \"success\";\n    msg.title = \"Ventilation \" + msg.alias + \" activÃ©e\";\n    msg.message = \"Circonstance favorable, la ventilation \" + msg.alias + \" est activÃ©e\";\n    msg.sendMobile = false;\n    return msg;\n} else if (ventilations[msg.linkedArea] == \"\") {\n    msg.dismiss = true;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1150,"y":600,"wires":[["0419929f6aea7cca"]]},{"id":"a45e1f6435f091f6","type":"function","z":"7cc0f49198f44c93","name":"prepare humidity","func":"let ventilations = global.get(\"ventilations\") || {};\nlet temperatures = global.get(\"temperatures\") || {};\nlet humidities = global.get(\"humidities\") || {};\nlet comforts = global.get(\"comforts\") || {};\nlet devices = msg.ventilations;\nlet msgs = [];\n\nfor (let device of devices) {\n    if (\"linkedArea\" in device) {\n        let results = autoVentilation(device, comforts);\n        if (device.linkedArea in ventilations\n            && results[1] !== ventilations[device.linkedArea] && ventilations[device.linkedArea] !== \"scheduled\"\n            || !(device.linkedArea in ventilations)) {\n            ventilations[device.linkedArea] = results[1];\n            msgs.push({\n                entity_id: device.entity_id,\n                state: results[0],\n                linkedArea: device.linkedArea,\n                alias: device.alias\n            });\n        }\n    }\n}\n\nif (msgs.length !== 0) {\n    global.set(\"ventilations\", ventilations);\n    return [msgs];\n}\n\nfunction autoVentilation(device, comforts) {\n    if (Object.keys(comforts).length > 0) {\n        let mostUncomfortArea = devices.length === 1\n            ? Object.keys(comforts).sort((a, b) => comforts[a].area_comfort - comforts[b].area_comfort).reverse()[0]\n            : device.linkedArea in comforts ? comforts[device.linkedArea].area_comfort : \"\";\n\n        if (mostUncomfortArea != \"\"){\n            if (humidities[mostUncomfortArea].high && comforts[mostUncomfortArea].ext_comfort < comforts[mostUncomfortArea].area_comfort) {\n                return [\"on\", \"max_humidity\"];\n            } else if (!temperatures[mostUncomfortArea].low && comforts[mostUncomfortArea].ext_comfort < comforts[mostUncomfortArea].area_comfort) {\n                return [\"on\", \"humidity\"];\n            }\n        }\n    }\n    \n    return [\"off\", \"\"];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":600,"wires":[["84cf327ba8dbb95c","bdb378dcde27f270"]]},{"id":"1a65d03fb472b147","type":"inject","z":"7cc0f49198f44c93","name":"","props":[],"repeat":"","crontab":"*/10 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":110,"y":600,"wires":[["0b2998b8acb6ae64"]]},{"id":"84cf327ba8dbb95c","type":"link out","z":"7cc0f49198f44c93","name":"link out 486","mode":"link","links":["068da256e16f3fcf","7516e795e9c61133","48051bfb384dfbd3"],"x":995,"y":600,"wires":[]},{"id":"aeb2eff70381a653","type":"link out","z":"7cc0f49198f44c93","name":"link out 487","mode":"link","links":["0c807b7e0bfb7460"],"x":975,"y":540,"wires":[]},{"id":"0c807b7e0bfb7460","type":"link in","z":"7cc0f49198f44c93","name":"link in 457","links":["aeb2eff70381a653"],"x":1045,"y":600,"wires":[["bdb378dcde27f270"]]},{"id":"c4b276bd7cbbc844","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"water_heat_\" + msg.entity_id;\n\nif (msg.state == \"on\") {\n    msg.title = \"Chauffe-eau activÃ© par planification\";\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allumÃ©\";\n    msg.alertType = \"success\";\n    msg.sendMobile = false;\n    return msg;\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":300,"wires":[["840e0643e8c84153"]]},{"id":"840e0643e8c84153","type":"link out","z":"7cc0f49198f44c93","name":"link out 488","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1015,"y":300,"wires":[]},{"id":"1bec02e18f41cee3","type":"function","z":"7cc0f49198f44c93","name":"set delay","func":"msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state) * 60 * 1000;\nmsg.state = \"off\";\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":180,"wires":[["ebc5272f39f732f1"]]},{"id":"79773f6b837c02f1","type":"api-call-service","z":"7cc0f49198f44c93","name":"activate manual off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.water_heat_temp"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":240,"wires":[[]]},{"id":"34949d27140eb419","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"water_heat\";\n\nif (msg.state == \"on\") {\n    let water_heat_duration = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state);\n    msg.title = \"Chauffe-eau activÃ© manuellement\";\n    msg.message = \"Le chauffe-eau \" + msg.alias + \" est allumÃ© \" + water_heat_duration + \" min\";\n    msg.alertType = \"success\";\n    msg.sendMobile = true;\n    return msg;\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1310,"y":240,"wires":[["27ce4ecdecc58ff1"]]},{"id":"27ce4ecdecc58ff1","type":"link out","z":"7cc0f49198f44c93","name":"link out 500","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1415,"y":240,"wires":[]},{"id":"355dfe3a24581e4d","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":240,"wires":[["79773f6b837c02f1","85453006e9fb8796"]],"l":false},{"id":"8ea5d0179ce614e9","type":"function","z":"7cc0f49198f44c93","name":"set delay","func":"msg.state = msg.payload;\n\nif (msg.state == \"on\") {\n    msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state) * 60 * 1000;\n    msg.state = \"off\";\n} else {\n    msg.reset = true;\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":240,"wires":[["355dfe3a24581e4d"]]},{"id":"b06c1a575e85eacb","type":"server-state-changed","z":"7cc0f49198f44c93","name":"sensibility","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.sensibility","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":240,"y":600,"wires":[["0b2998b8acb6ae64"]]},{"id":"55eac8dff698a429","type":"function","z":"7cc0f49198f44c93","name":"water_heats >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"water_heat\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"water_heats\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":180,"wires":[["4597fe7225ab909c"]]},{"id":"4597fe7225ab909c","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":395,"y":180,"wires":[["7527a6b217b28d20"]],"l":false},{"id":"85453006e9fb8796","type":"function","z":"7cc0f49198f44c93","name":"water_heats >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"water_heat\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"water_heats\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":240,"wires":[["08fe96468d0a7095"]]},{"id":"08fe96468d0a7095","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":815,"y":240,"wires":[["bb6101f7fb19d8f8"]],"l":false},{"id":"c9e944ee95454391","type":"function","z":"7cc0f49198f44c93","name":"water_heats >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"water_heat\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"water_heats\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":300,"wires":[["d3bb52ef753841f6"]]},{"id":"d3bb52ef753841f6","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":415,"y":300,"wires":[["539dc2c4d06a7fb3"]],"l":false},{"id":"0853fac1572e1008","type":"function","z":"7cc0f49198f44c93","name":"water_heats >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"water_heat\",\n        valueType: \"str\"\n    },\n    {\n        property: \"state\",\n        logic: \"is\",\n        value: msg.payload,\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"water_heats\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":360,"wires":[["38d8fdf8f1273da6"]]},{"id":"38d8fdf8f1273da6","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":435,"y":360,"wires":[["c6459e3b13061ab7"]],"l":false},{"id":"47908483fafc8782","type":"function","z":"7cc0f49198f44c93","name":"ventilations >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"ventilation\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"ventilations\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":540,"wires":[["757b53891fac2c52"]]},{"id":"757b53891fac2c52","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":715,"y":540,"wires":[["756f4d593faf47cd"]],"l":false},{"id":"b2317293f5dbab97","type":"function","z":"7cc0f49198f44c93","name":"ventilations >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"ventilation\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"ventilations\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":600,"wires":[["dfeaf0ec082bebb3"]]},{"id":"dfeaf0ec082bebb3","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":735,"y":600,"wires":[["a45e1f6435f091f6"]],"l":false},{"id":"ec47075613cfdd43","type":"function","z":"7cc0f49198f44c93","name":"ventilations >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"ventilation\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"ventilations\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":660,"wires":[["b78ccbb4f595c6f6"]]},{"id":"b78ccbb4f595c6f6","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":415,"y":660,"wires":[["6a77bcc53698bdf2"]],"l":false},{"id":"802bd482120f594c","type":"subflow:94b2243985840d69","z":"7cc0f49198f44c93","name":"","x":170,"y":780,"wires":[["2b4fd97f1ef896db"]]},{"id":"ab235c6e005b9dba","type":"subflow:94b2243985840d69","z":"7cc0f49198f44c93","name":"","x":570,"y":780,"wires":[["a3bef21201367a5b"]]},{"id":"60962951fc197bb6","type":"server-events","z":"7cc0f49198f44c93","name":"battery","server":"c87720f17866318d","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"{\"new_state\":{\"attributes\":{\"device_class\":\"battery\"}},\"old_state\":{\"attributes\":{\"device_class\":\"battery\"}}}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":90,"y":960,"wires":[["bafa5d55d2c3d20b"]]},{"id":"bafa5d55d2c3d20b","type":"function","z":"7cc0f49198f44c93","name":"set","func":"let old_state = msg.data.event.old_state.state;\nlet new_state = msg.data.event.new_state.state;\n\nif (old_state != \"unavailable\" && new_state != \"unavailable\" && old_state != new_state) {\n    msg.entity_id = msg.data.event.entity_id;\n    msg.new_state = isNaN(new_state) ? new_state : parseInt(new_state);\n    msg.friendly_name = msg.data.event.new_state.attributes.friendly_name;\n\n    delete msg.data;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":210,"y":960,"wires":[["f156cfb1302b4c43"]]},{"id":"f156cfb1302b4c43","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"let low_batteries = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.low_batteries\"].state);\nlet notifications = global.get(\"notifications\") || {};\n\nif (isNaN(msg.new_state)) {\n    msg.state = onOff(msg.new_state);\n} else {\n    msg.state = msg.new_state;\n}\n\nmsg.notification_id = \"battery_lvl\" + msg.entity_id.substring(msg.entity_id.lastIndexOf(\"_\"));\nif (msg.state < low_batteries) {\n    if (!(msg.notification_id in notifications)) {\n        if (msg.state == 0) {\n            msg.title = \"Alerte batterie vide\";\n            msg.alertType = \"error\";\n            msg.message = \"Batterie du capteur: \" + msg.friendly_name + \" Ã  0%\";\n            msg.speak = \"La batterie du capteur: \" + msg.friendly_name + \" est Ã  0%\";\n        } else {\n            msg.title = \"Alerte batterie faible\";\n            msg.alertType = \"warning\";\n            msg.message = \"Batterie du capteur: \" + msg.friendly_name + \" en dessous de \" + low_batteries + \"%\";\n            msg.speak = \"La batterie du capteur \" + msg.friendly_name + \" est en dessous de \" + low_batteries + \"%\";\n        }\n        msg.sendMobile = true;\n        return msg;\n    }\n} else if (msg.notification_id in notifications) {\n    msg.speak = \"La batterie du capteur \" + msg.friendly_name + (isNaN(msg.state) ? \" Ã  Ã©tÃ© remplacÃ©e\" : \"est Ã  \" + msg.state + \"%\");\n    msg.dismiss = true;\n    return msg;\n}\n\nfunction onOff(new_state) {\n    return new_state == \"off\" ? low_batteries + 1 : new_state == \"on\" ? low_batteries - 1 : 0;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":960,"wires":[["9efffdb0ef885bb8"]]},{"id":"07fb6e19c1eb63d6","type":"server-state-changed","z":"7cc0f49198f44c93","name":"low_batteries","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.low_batteries","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":350,"y":960,"wires":[["1bc0595b549eb74c"]]},{"id":"1bc0595b549eb74c","type":"ha-get-entities","z":"7cc0f49198f44c93","name":"","server":"c87720f17866318d","version":0,"rules":[{"property":"entity_id","logic":"is","value":"^sensor.battery_|^sensor.ble_battery_|^sensor.*_bat_level$|^binary_sensor.*battery_low$","valueType":"re"},{"property":"attributes.device_class","logic":"is","value":"battery","valueType":"str"},{"property":"state","logic":"is_not","value":"None","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":510,"y":960,"wires":[["d7e76ca94f363631"]]},{"id":"d7e76ca94f363631","type":"function","z":"7cc0f49198f44c93","name":"set","func":"msg.entity_id = msg.payload.entity_id;\nmsg.new_state = isNaN(msg.payload.state) ? msg.payload.state : parseInt(msg.payload.state);\nmsg.friendly_name = msg.payload.attributes.friendly_name;\n\ndelete msg.data;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":960,"wires":[["f156cfb1302b4c43"]]},{"id":"1f9bcc8cde75a5ef","type":"inject","z":"7cc0f49198f44c93","name":"4h","props":[],"repeat":"","crontab":"00 04 * * *","once":false,"onceDelay":0.1,"topic":"","x":570,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"e674a33ab19f7c47","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":930,"y":420,"wires":[]},{"id":"2ef5ba58f0befc5d","type":"function","z":"7cc0f49198f44c93","name":"set water heat pct","func":"let json_exterior_average_temp = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_exterior_average_temp\"].state);\nlet water_heat_person_number = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_person_number\"].state);\nlet water_heat_adjustment = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_adjustment\"].state);\nlet temperatures = global.get(\"temperatures\") || {};\nlet msgs = [];\n\nif (temperatures.exterior.online && Array.isArray(json_exterior_average_temp)) {\n    let pct = -0.6667 * json_exterior_average_temp[0] + 25 + 10 * (water_heat_person_number - 1) + water_heat_adjustment;\n    pct = pct > 100 ? 100 : pct < 5 ? 5 : pct;\n    msgs.push({ entity_id: \"input_number.water_heat_pct\", state: Math.round(pct) });\n    let duration = (pct * 60 * 7 / 100) > 360 ? 360 : (pct * 60 * 7 / 100) < 0 ? 0 : Math.round(pct * 60 * 7 / 100);\n    msgs.push({ entity_id: \"input_number.water_heat_duration\", state: duration });\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":420,"wires":[["e674a33ab19f7c47"]]},{"id":"9c66394db68ae239","type":"server-state-changed","z":"7cc0f49198f44c93","name":"water heat person number","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.water_heat_person_number","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":370,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"bc41ec7b4d0f345b","type":"server-state-changed","z":"7cc0f49198f44c93","name":"water heat adjustment","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.water_heat_adjustment","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":140,"y":420,"wires":[["2ef5ba58f0befc5d"]]},{"id":"2af569a4077b0eac","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_ventilation","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_ventilation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"module_ventilation","propertyType":"msg","value":"","valueType":"entityState"}],"x":190,"y":540,"wires":[["c45a2415bdcf7e98"]]},{"id":"daf177b16fa93fd7","type":"api-get-history","z":"7cc0f49198f44c93","name":"","server":"c87720f17866318d","version":0,"startdate":"","enddate":"","entityid":"{{entity_id}}","entityidtype":"is","useRelativeTime":true,"relativeTime":"1 day","flatten":true,"output_type":"array","output_location_type":"msg","output_location":"entity_histories","x":595,"y":180,"wires":[["40c697883e6c606b"]],"l":false},{"id":"7527a6b217b28d20","type":"function","z":"7cc0f49198f44c93","name":"devices","func":"let devices = msg.water_heats;\nlet msgs = [];\n\nfor (let device of devices) {\n    msgs.push({ entity_id: device.entity_id, state: \"on\", alias: device.alias });\n}\n\nreturn msgs;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":180,"wires":[["daf177b16fa93fd7","54b44dc287bc9d66"]]},{"id":"66b809d75014e699","type":"catch","z":"ab914a2a493ebbf5","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["103b5b2b1d5427e7"]]},{"id":"f63c64627a69e81d","type":"subflow:ad3b29a5dd67898f","z":"ab914a2a493ebbf5","name":"","x":460,"y":40,"wires":[]},{"id":"103b5b2b1d5427e7","type":"change","z":"ab914a2a493ebbf5","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Covers","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["f63c64627a69e81d"]]},{"id":"e3c8c262ba8d76ac","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"sun","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":90,"y":120,"wires":[["d9f739b9cbc83e44"]]},{"id":"f12c94f0300ac8f9","type":"function","z":"ab914a2a493ebbf5","name":"set cover value","func":"let sunAngleCoverOff = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_off\"].state);\nlet sunAngleCoverOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_on\"].state);\nlet newStateElevation = msg.data.new_state.attributes.elevation;\nlet oldStateElevation = msg.data.old_state.attributes.elevation;\n\nif (oldStateElevation <= sunAngleCoverOn && sunAngleCoverOn <= newStateElevation) {\n    msg.value = 100;\n    return msg;\n} else if (oldStateElevation >= sunAngleCoverOff && sunAngleCoverOff >= newStateElevation) {\n    msg.value = 0;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":120,"wires":[["3540e23ca74be6f1"]]},{"id":"ff8917fbe0e53ade","type":"link in","z":"ab914a2a493ebbf5","name":"link in 420","links":["b7ac33720a1cbe49","8c4bbdf67c433ded"],"x":55,"y":360,"wires":[["d79e1a2d57bb756f"]]},{"id":"edcc162b29c8a8af","type":"function","z":"ab914a2a493ebbf5","name":"cover calc","func":"let timeToAeration = \"timeToAeration\" in msg ? msg.timeToAeration : 0;\nlet timeToClose = \"timeToClose\" in msg ? msg.timeToClose : 0;\nlet timeToOpen = \"timeToOpen\" in msg ? msg.timeToOpen : 0;\nlet old_state = msg.old_state;\nlet new_state = msg.new_state;\n\nif (msg.linkedDevice != \"\") {\n    if (new_state == 100) {\n        msg = { entity_id: msg.linkedDevice, service: \"open_cover\", delay: (timeToOpen + timeToAeration) * 1000 };\n    } else if (new_state == 0) {\n        msg = { entity_id: msg.linkedDevice, service: \"close_cover\", delay: (timeToClose + timeToAeration) * 1000 };\n    } else if (new_state == 1) {\n        if (old_state == 0) {\n            msg = { entity_id: msg.linkedDevice, service: \"open_cover\", delay: (timeToAeration) * 1000 };\n        } else {\n            msg = { entity_id: msg.linkedDevice, service: \"close_cover\", delay: (old_state + 1) * timeToClose * 10 + timeToAeration * 1000, nextService: \"open_cover\", nextDelay: (timeToAeration) * 1000 };\n        }\n    } else {\n        msg.delay = old_state == 0 ? timeToAeration : 0;\n        if (old_state < new_state) {\n            msg = { entity_id: msg.linkedDevice, service: \"open_cover\", delay: msg.delay + (new_state - old_state) * timeToOpen * 10 };\n        } else {\n            msg = { entity_id: msg.linkedDevice, service: \"close_cover\", delay: msg.delay + (old_state - new_state) * timeToClose * 10 };\n        }\n    }\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":360,"wires":[["cfff980d5a10bb6e"]]},{"id":"cfff980d5a10bb6e","type":"api-call-service","z":"ab914a2a493ebbf5","name":"set cover","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"cover","service":"{{service}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":580,"y":360,"wires":[["4cbf989b56c4b52f"]]},{"id":"8453250c55071464","type":"api-call-service","z":"ab914a2a493ebbf5","name":"stop cover","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"cover","service":"stop_cover","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":790,"y":360,"wires":[["2d2a95039320e5b1"]]},{"id":"4cbf989b56c4b52f","type":"delay","z":"ab914a2a493ebbf5","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":675,"y":360,"wires":[["8453250c55071464"]],"l":false},{"id":"2d2a95039320e5b1","type":"function","z":"ab914a2a493ebbf5","name":"next calc","func":"if (\"nextService\" in msg && \"nextDelay\" in msg) {\n    msg = {\n        service: msg.nextService,\n        delay: msg.nextDelay\n    };\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":360,"wires":[["c1e32b8d5dd68fbf"]]},{"id":"c1e32b8d5dd68fbf","type":"link out","z":"ab914a2a493ebbf5","name":"link out 414","mode":"link","links":["06c8167483650701"],"x":1035,"y":360,"wires":[]},{"id":"06c8167483650701","type":"link in","z":"ab914a2a493ebbf5","name":"link in 421","links":["c1e32b8d5dd68fbf"],"x":475,"y":360,"wires":[["cfff980d5a10bb6e"]]},{"id":"d9f739b9cbc83e44","type":"api-current-state","z":"ab914a2a493ebbf5","name":"module_cover on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":120,"wires":[["f12c94f0300ac8f9"],[]]},{"id":"d79e1a2d57bb756f","type":"api-current-state","z":"ab914a2a493ebbf5","name":"module_covers on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":200,"y":360,"wires":[["edcc162b29c8a8af"],[]]},{"id":"0a74c79fa2b26337","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"modules_covers","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_cover","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":500,"wires":[["b930ded2b8ae45b5"]]},{"id":"b930ded2b8ae45b5","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"msg.notification_id = \"module_cover\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Volets roulant dÃ©sactivÃ©\";\n    msg.message = \"Module Volets roulant dÃ©sactivÃ©, les volets roulants ne sont plus controlÃ©es\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":500,"wires":[["47e4fe779b75e0dc"]]},{"id":"47e4fe779b75e0dc","type":"link out","z":"ab914a2a493ebbf5","name":"link out 415","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":395,"y":500,"wires":[]},{"id":"fc248d2e80a1c866","type":"function","z":"ab914a2a493ebbf5","name":"get alarms","func":"let persons = global.get(\"persons\") || {};\nlet cover = msg.payload.data.entity_id;\nlet value = msg.payload.data.value;\n\nfor (let key of Object.keys(persons)) {\n    let person_config = global.get(\"homeassistant\").homeAssistant.states[key].attributes.config;\n    let linkedCoversAlarm = \"alarmClock\" in person_config && \"linkedCovers\" in person_config.alarmClock ? person_config.alarmClock.linkedCovers : [];\n    if (!(persons[key].alarm.split(\" \")[0] == msg.currentDate && linkedCoversAlarm.includes(cover)) && value == 100) {\n        return msg;\n    } else if (value == 0) {\n        return msg;\n    }\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":180,"wires":[["f4c62d5c33445996"]]},{"id":"fd18f3ab2a134595","type":"link out","z":"ab914a2a493ebbf5","name":"link out 417","mode":"link","links":["f17e11ed7c016f8b","1f0132a2fbee311c","42c3215cdd62d3ab"],"x":755,"y":120,"wires":[]},{"id":"f17e11ed7c016f8b","type":"link in","z":"ab914a2a493ebbf5","name":"link in 423","links":["fd18f3ab2a134595"],"x":55,"y":180,"wires":[["138be8f8608ac91c"]]},{"id":"4744f099b52ffeb9","type":"subflow:e6ac576fb4598283","z":"ab914a2a493ebbf5","name":"","x":330,"y":180,"wires":[["4b94560071a5dab5"],["74a232c0c54bfcd0"]]},{"id":"138be8f8608ac91c","type":"function","z":"ab914a2a493ebbf5","name":"set covers","func":"let state = msg.state;\nlet msgs = [];\n\nfor (let cover of msg.covers) {\n    msgs.push({\n        payload: {\n            data: {\n                entity_id: cover.entity_id, value: msg.value\n            }\n        }\n    });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":180,"wires":[["4744f099b52ffeb9"]]},{"id":"1f0132a2fbee311c","type":"link in","z":"ab914a2a493ebbf5","name":"link in 426","links":["fd18f3ab2a134595"],"x":55,"y":300,"wires":[["eaec0d325d79696a"]]},{"id":"a861d8b07880a2e2","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"let covers = msg.covers;\n\nif (covers.length != 0) {\n    msg.notification_id = \"empty_home_cover_status\";\n    msg.alertType = \"success\";\n    msg.title = (msg.value == 100 ? \"Ouverture\" : \"Fermeture\") + \" des volets\";\n    msg.sendMobile = true;\n    let endTxt = \" pendant votre absence\";\n    if (msg.value == 100) {\n        msg.message = (covers.length == 1 ? \"Le volet s'est ouvert\" : \"Les volets ce sont ouverts\") + endTxt;\n        return msg;\n    } else if (msg.value == 0) {\n        msg.message = (covers.length == 1 ? \"Le volet s'est fermÃ©\" : \"Les volets ce sont fermÃ©s\") + endTxt;\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":300,"wires":[["625506e86313414c"]]},{"id":"625506e86313414c","type":"link out","z":"ab914a2a493ebbf5","name":"link out 421","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":435,"y":300,"wires":[]},{"id":"eaec0d325d79696a","type":"subflow:e6ac576fb4598283","z":"ab914a2a493ebbf5","name":"","x":170,"y":300,"wires":[[],["a861d8b07880a2e2"]]},{"id":"f32dd6019bb04292","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"in_home_zone","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":440,"wires":[["249f4fb1ec363df2"],[]]},{"id":"249f4fb1ec363df2","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"msg.notification_id = \"empty_home_cover_status\";\nmsg.dismiss = true;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":440,"wires":[["b968a370a50879c2"]]},{"id":"b968a370a50879c2","type":"link out","z":"ab914a2a493ebbf5","name":"link out 422","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":395,"y":440,"wires":[]},{"id":"3540e23ca74be6f1","type":"function","z":"ab914a2a493ebbf5","name":"covers >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"attributes.config.linkedClass\",\n        logic: \"is\",\n        value: \"cover\",\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"covers\";\n\nmsg.payload = config;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":120,"wires":[["ca25a537afcf275d"]]},{"id":"ca25a537afcf275d","type":"subflow:ea5b93cde6b1bf0a","z":"ab914a2a493ebbf5","name":"","x":695,"y":120,"wires":[["fd18f3ab2a134595"]],"l":false},{"id":"f4c62d5c33445996","type":"api-current-state","z":"ab914a2a493ebbf5","name":"module_covers on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":820,"y":180,"wires":[["15085a2365082a87"],[]]},{"id":"3580dd15a74a7655","type":"function","z":"ab914a2a493ebbf5","name":"set sound and light effect","func":"msg.lightEffect = { \"count\": 2, \"hue1\": 180, \"hue2\": 180, \"sat1\": 20, \"sat2\": 100 };\nmsg.sound = \"stores_windows.mp3\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":240,"wires":[["cd6ffbe8e1134c53","c7102552715b9515"]]},{"id":"42c3215cdd62d3ab","type":"link in","z":"ab914a2a493ebbf5","name":"link in 480","links":["ec95116847dfc37f","fd18f3ab2a134595"],"x":55,"y":240,"wires":[["25bd49ccf484f3f6"]]},{"id":"25bd49ccf484f3f6","type":"subflow:e6ac576fb4598283","z":"ab914a2a493ebbf5","name":"","x":170,"y":240,"wires":[["3580dd15a74a7655"],[]]},{"id":"c7102552715b9515","type":"subflow:dbf17bea6affd2ec","z":"ab914a2a493ebbf5","name":"","x":590,"y":240,"wires":[]},{"id":"15085a2365082a87","type":"delay","z":"ab914a2a493ebbf5","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":955,"y":180,"wires":[["2ab2ba04b14a404d"]],"l":false},{"id":"2ab2ba04b14a404d","type":"api-call-service","z":"ab914a2a493ebbf5","name":"set covers pct","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1080,"y":180,"wires":[[]]},{"id":"cd6ffbe8e1134c53","type":"subflow:5a05b9ac0289ff03","z":"ab914a2a493ebbf5","name":"","env":[],"x":780,"y":240,"wires":[]},{"id":"4b94560071a5dab5","type":"function","z":"ab914a2a493ebbf5","name":"get date","func":"let d = new Date();\nlet year = d.getFullYear();\nlet month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1);\nlet day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n\nmsg.currentTime = year + \"-\" + month + \"-\" + day;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":180,"wires":[["fc248d2e80a1c866"]]},{"id":"00ede13124c44890","type":"catch","z":"eaa696a731a52b23","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["b175ee858ab93e92"]]},{"id":"0b9796d6577bb527","type":"link in","z":"eaa696a731a52b23","name":"link in 88","links":["08a2e534e6dd4397","f69da4c4a60e5983"],"x":55,"y":120,"wires":[["b9a51bce4e5b801e"]]},{"id":"38beb2359e67bda8","type":"subflow:ad3b29a5dd67898f","z":"eaa696a731a52b23","name":"","x":460,"y":40,"wires":[]},{"id":"b175ee858ab93e92","type":"change","z":"eaa696a731a52b23","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Reveil","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["38beb2359e67bda8"]]},{"id":"064fb128dde2efef","type":"delay","z":"eaa696a731a52b23","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":425,"y":240,"wires":[["d05051316ec66cd6","55c14ffc8b8ac1b9"]],"l":false},{"id":"d05051316ec66cd6","type":"link out","z":"eaa696a731a52b23","name":"link out 334","mode":"link","links":["de52115cdb597d40","727e84e5749fbbf6"],"x":475,"y":240,"wires":[]},{"id":"de52115cdb597d40","type":"link in","z":"eaa696a731a52b23","name":"link in 348","links":["d05051316ec66cd6","b06b58bde6a6be58"],"x":55,"y":300,"wires":[["274123f900d11b04"]]},{"id":"0b477e7910fca0f6","type":"function","z":"eaa696a731a52b23","name":"set waits","func":"msg.waits = [];\nmsg.states = [];\n\nif (msg.delay != 0) {\n    for (let motion of msg.motions) {\n        msg.waits.push(motion.entity_id);\n        msg.states.push(\"invertedMotion\" in motion && motion.invertedMotion ? \"off\" : \"on\");\n        msg.timeoutSeconds = msg.delay / 1000;\n        msg.sendOnTimeout = false;\n    }\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":180,"wires":[["ce50f43acef72ede"]]},{"id":"a40c3173ed69eae1","type":"subflow:050c60654a910e68","z":"eaa696a731a52b23","name":"","x":160,"y":240,"wires":[["caf7c088c9670934","d05051316ec66cd6","55c14ffc8b8ac1b9"]]},{"id":"caf7c088c9670934","type":"change","z":"eaa696a731a52b23","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"},{"t":"delete","p":"delay","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":240,"wires":[["064fb128dde2efef"]]},{"id":"ce50f43acef72ede","type":"link out","z":"eaa696a731a52b23","name":"link out 354","mode":"link","links":["dc898bfab5de97de"],"x":895,"y":180,"wires":[]},{"id":"dc898bfab5de97de","type":"link in","z":"eaa696a731a52b23","name":"link in 369","links":["ce50f43acef72ede"],"x":55,"y":240,"wires":[["a40c3173ed69eae1"]]},{"id":"b9a51bce4e5b801e","type":"subflow:e6ac576fb4598283","z":"eaa696a731a52b23","name":"","x":170,"y":120,"wires":[["699d5211bed69d84"],[]]},{"id":"699d5211bed69d84","type":"api-current-state","z":"eaa696a731a52b23","name":"module_alarm_clock ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_alarm_clock","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":360,"y":120,"wires":[["52cb722945f66586"],[]]},{"id":"af6f9b05d26ce6b7","type":"api-call-service","z":"eaa696a731a52b23","name":"select ambiance","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{ambiance.linkedSelect}}\",\"option\":\"{{option}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":780,"y":240,"wires":[[]]},{"id":"55c14ffc8b8ac1b9","type":"change","z":"eaa696a731a52b23","name":"set stop option","rules":[{"t":"set","p":"option","pt":"msg","to":"homeassistant.homeAssistant.states[\"input_select.user_configuration\"].attributes.config.ambiance_config.ambiances_type.stop.name","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":240,"wires":[["af6f9b05d26ce6b7"]]},{"id":"efcfefbd4cbdc989","type":"link in","z":"eaa696a731a52b23","name":"link in 394","links":["85614de5574496b9"],"x":375,"y":240,"wires":[["064fb128dde2efef"]]},{"id":"646b3ecc40cac7d6","type":"link in","z":"eaa696a731a52b23","name":"link in 395","links":["b475d377c44c136b"],"x":55,"y":180,"wires":[["a4ca12c58591b1ed"]]},{"id":"727e84e5749fbbf6","type":"link in","z":"eaa696a731a52b23","name":"link in 422","links":["d05051316ec66cd6","b06b58bde6a6be58"],"x":55,"y":360,"wires":[["1c34d77d8ecec0ef"]]},{"id":"8e7912d6c84c4bdd","type":"api-call-service","z":"eaa696a731a52b23","name":"select ambiance","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{ambiance.linkedSelect}}\",\"option\":\"{{ambiance.option}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":440,"y":180,"wires":[[]]},{"id":"354f9cbcd636e108","type":"function","z":"eaa696a731a52b23","name":"covers open","func":"let msgs = [];\n\nfor (let cover of msg.covers) {\n    msgs.push({ payload: { data: { entity_id: cover.entity_id, value: 100 } } });\n}\n\nif (msgs.length != 0) {\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":360,"wires":[["93d65c346eab5746"]]},{"id":"93d65c346eab5746","type":"api-call-service","z":"eaa696a731a52b23","name":"set covers pct","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":760,"y":360,"wires":[[]]},{"id":"a4ca12c58591b1ed","type":"function","z":"eaa696a731a52b23","name":"validate ambiance","func":"if (\"ambiance\" in msg\n    && \"person_alarm\" in msg\n    && \"linkedSelect\" in msg.ambiance && msg.ambiance.linkedSelect != \"\"\n    && \"option\" in msg.ambiance && msg.ambiance.option != \"\"\n    && \"linkedAmbianceDurationMinutes\" in msg.person_alarm\n    && msg.person_alarm.linkedAmbianceDurationMinutes != 0) {\n    msg.delay = msg.person_alarm.linkedAmbianceDurationMinutes * 60 * 1000;\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":180,"wires":[["85614de5574496b9","d7d82dfd3230ef12"],["b06b58bde6a6be58"]]},{"id":"6a2278252e8fa9b4","type":"function","z":"eaa696a731a52b23","name":"motions >","func":"if (\"delay\" in msg && msg.delay != 0) {\n    let config = {};\n    config.rules = [\n        {\n            property: \"attributes.config.linkedClass\",\n            logic: \"is\",\n            value: \"motion\",\n            valueType: \"str\"\n        },\n        {\n            property: \"attributes.config.linkedArea\",\n            logic: \"is\",\n            value: msg.person_alarm.linkedArea,\n            valueType: \"str\"\n        }\n    ];\n    config.outputType = \"array\";\n    config.outputEmptyResults = false;\n    config.outputLocationType = \"msg\";\n    config.outputLocation = \"motions\";\n\n    msg.payload = config;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":180,"wires":[["013af297cba6e6e5"]]},{"id":"013af297cba6e6e5","type":"subflow:ea5b93cde6b1bf0a","z":"eaa696a731a52b23","name":"","x":695,"y":180,"wires":[["0b477e7910fca0f6"]],"l":false},{"id":"1c4fd3b78caf9e3c","type":"function","z":"eaa696a731a52b23","name":"covers >","func":"let config = {};\n\nconfig.rules = [\n    {\n        property: \"entity_id\",\n        logic: \"includes\",\n        value: msg.person_alarm.linkedCovers.join(\",\"),\n        valueType: \"str\"\n    }\n];\n\nconfig.outputType = \"array\";\nconfig.outputEmptyResults = false;\nconfig.outputLocationType = \"msg\";\nconfig.outputLocation = \"covers\";\n\nmsg.payload = config;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":360,"wires":[["fe3e97cae477a7ed"]]},{"id":"fe3e97cae477a7ed","type":"subflow:ea5b93cde6b1bf0a","z":"eaa696a731a52b23","name":"","x":475,"y":360,"wires":[["354f9cbcd636e108"]],"l":false},{"id":"82a220882942a511","type":"subflow:dbf17bea6affd2ec","z":"eaa696a731a52b23","name":"","x":410,"y":300,"wires":[]},{"id":"4af74c7e37388864","type":"function","z":"eaa696a731a52b23","name":"set speaker","func":"if (\"ambiance\" in msg && \"radioVolumeLevel\" in msg.ambiance) {\n    msg.volumeLevel = msg.ambiance.radioVolumeLevel;\n}\n\nif (\"person_alarm\" in msg && \"linkedRadio\" in msg.person_alarm) {\n    msg.link = msg.person_alarm.linkedRadio;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":300,"wires":[["82a220882942a511"]]},{"id":"52cb722945f66586","type":"function","z":"eaa696a731a52b23","name":"get alarms","func":"let config = global.get(\"homeassistant\").homeAssistant.states[\"input_select.user_configuration\"].attributes.config || {};\nlet persons = global.get(\"persons\") || {};\nlet msgs = [];\n\n\nfor (let key of Object.keys(persons)) {\n    if (\"alarm\" in persons[key] && persons[key].alarm == msg.currentTime) {\n        let ambiances_type = \"ambiance_config\" in config && \"ambiances_type\" in config.ambiance_config ? config.ambiance_config.ambiances_type : {};\n        let person = global.get(\"homeassistant\").homeAssistant.states[key].attributes.config;\n\n        if (\"alarmClock\" in person) {\n            msg.person_alarm = {\n                ...person.alarmClock,\n                linkedArea: \"linkedArea\" in person ? person.linkedArea : \"\"\n            };\n            if (\"linkedAmbiance\" in person.alarmClock && person.alarmClock.linkedAmbiance in config) {\n                msg.ambiance = {\n                    ...config[person.alarmClock.linkedAmbiance],\n                    linkedSpeaker: \"linkedSpeaker\" in config[person.alarmClock.linkedAmbiance] ? global.get(\"homeassistant\").homeAssistant.states[config[person.alarmClock.linkedAmbiance].linkedSpeaker].attributes.config : {},\n                    option: randomAmbiance(ambiances_type)\n                };\n            }\n        }\n        msgs.push(msg);\n    }\n}\n\nreturn [msgs];\n\nfunction randomAmbiance(ambiances_type) {\n    let ambiances_name = [];\n    for (let key of Object.keys(ambiances_type)) {\n        ambiances_name.push(ambiances_type[key].name);\n    }\n    return ambiances_name[1 + Math.floor(Math.random() * 7)];\n} ","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":120,"wires":[["b475d377c44c136b"]]},{"id":"b475d377c44c136b","type":"link out","z":"eaa696a731a52b23","name":"alarm started","mode":"link","links":["646b3ecc40cac7d6"],"x":655,"y":120,"wires":[]},{"id":"85614de5574496b9","type":"link out","z":"eaa696a731a52b23","name":"alarm started","mode":"link","links":["efcfefbd4cbdc989"],"x":315,"y":180,"wires":[]},{"id":"b06b58bde6a6be58","type":"link out","z":"eaa696a731a52b23","name":"alarm started","mode":"link","links":["de52115cdb597d40","727e84e5749fbbf6"],"x":315,"y":180,"wires":[]},{"id":"274123f900d11b04","type":"delay","z":"eaa696a731a52b23","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":115,"y":300,"wires":[["4af74c7e37388864"]],"l":false},{"id":"1c34d77d8ecec0ef","type":"api-current-state","z":"eaa696a731a52b23","name":"module_covers on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":200,"y":360,"wires":[["1c4fd3b78caf9e3c"],[]]},{"id":"4020e05dc1d0c23a","type":"server-events","z":"a62a0ee8573c9b72","name":"phone receive","server":"c87720f17866318d","version":2,"eventType":"mobile_app_notification_action","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":460,"wires":[["aa5c03271a7254d9","23bdf19660fa3754","a14b364f488d51a0","b4c1c5b35af21b97","2a33384c6bcb8786"]]},{"id":"aa5c03271a7254d9","type":"switch","z":"a62a0ee8573c9b72","name":"mesure","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"mesure","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":760,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"23bdf19660fa3754","type":"switch","z":"a62a0ee8573c9b72","name":"walk","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"walk","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":250,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"a14b364f488d51a0","type":"switch","z":"a62a0ee8573c9b72","name":"run","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"run","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":370,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"b4c1c5b35af21b97","type":"switch","z":"a62a0ee8573c9b72","name":"fitness","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"fitness","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"2a33384c6bcb8786","type":"switch","z":"a62a0ee8573c9b72","name":"stretching","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"stretching","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"b020e66ae86cfbd0","type":"function","z":"a62a0ee8573c9b72","name":"receive activities states","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\nlet type = msg.payload.event.action;\n\nif (activities[type][0] + 1 <= activities[type][1] && type !== \"\") {\n    switch (type) {\n        case \"walk\":\n            activities[\"walk\"][0]++;\n            activities[\"walk\"][2] = false;\n            break;\n        case \"run\":\n            activities[\"run\"][0]++;\n            activities[\"run\"][2] = false;\n            break;\n        case \"fitness\":\n            activities[\"fitness\"][0]++;\n            activities[\"fitness\"][2] = false;\n            break;\n        case \"stretching\":\n            activities[\"stretching\"][0]++;\n            activities[\"stretching\"][2] = false;\n            break;\n        case \"mesure\":\n            activities[\"mesure\"][0]++;\n            activities[\"mesure\"][2] = false;\n            break;\n    }\n    msg.payload = { \"data\": { \"value\": JSON.stringify(activities) } };\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":460,"wires":[["e10a6ab642e72857"]]},{"id":"0429572f34c1181a","type":"function","z":"a62a0ee8573c9b72","name":"build html activities tab","func":"let activities = msg.payload;\nlet totalUp = 0;\nlet totalDo = 0;\nlet txt = \"\";\nlet td = \"\";\nlet th = \"\"; \n\ntd += buildHtml(getPercent('walk','Marche'));\ntd += buildHtml(getPercent('run','Course'));\ntd += buildHtml(getPercent('fitness','Musculation'));\ntd += buildHtml(getPercent('stretching','Ã‰tirement'));\ntd += buildHtml(getPercent('mesure','PesÃ©e'));\n\nlet total = isNaN(parseInt(100*totalUp/totalDo)) ? 0 : parseInt(100*totalUp/totalDo);\ntxt = '<center><b>' + 'Objectifs santÃ©: ' + total + '% atteints' + '</b></center><hr>';\ntxt += '<table style=\"width:100%;text-align:center\"><tr>' + th + '</tr><tr>' + td + '</tr></table>';\n\nmsg.total = total;\nmsg.txt1 = {\"data\":{\"value\":txt.substring(0,254)}};\nmsg.txt2 = {\"data\":{\"value\":txt.substring(254)}};\n\nreturn msg;\n\nfunction getUp(type){\n    totalUp += parseInt(activities[type][0]);\n    return activities[type][0];\n}\n\nfunction getDo(type){\n    totalDo += parseInt(activities[type][1]);\n    return activities[type][1];\n}\n\nfunction getPercent(type,name){\n    th += '<th style=\"width:20%\">' + name + '</th>';\n    return getUp(type) + \"/\" + getDo(type);\n}\n\nfunction buildHtml(i){\n    return '<td>' + (i.split(\"/\")[0] === i.split(\"/\")[1] ? 'âœ…': i) + '</td>';\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":260,"wires":[["467ecbfa6d0fc6f5","34b0f91244589587"]]},{"id":"605a6fcdec6e7dea","type":"switch","z":"a62a0ee8573c9b72","name":"100% complete","property":"total","propertyType":"msg","rules":[{"t":"eq","v":"100","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":840,"y":260,"wires":[["78dba95788419f7e"]]},{"id":"fc225d0ed2994071","type":"api-call-service","z":"a62a0ee8573c9b72","name":"health_stats_1","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.health_stats_1"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":300,"y":380,"wires":[[]]},{"id":"967453ce60bb4ed4","type":"api-call-service","z":"a62a0ee8573c9b72","name":"health_stats_2","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.health_stats_2"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":660,"y":380,"wires":[[]]},{"id":"581bd663e32209c1","type":"change","z":"a62a0ee8573c9b72","name":"txt1","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt1","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":380,"wires":[["fc225d0ed2994071"]]},{"id":"4c2b1b5ac50cc378","type":"change","z":"a62a0ee8573c9b72","name":"txt2","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt2","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":510,"y":380,"wires":[["967453ce60bb4ed4"]]},{"id":"e10a6ab642e72857","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1150,"y":460,"wires":[[]]},{"id":"508f7fb084e67cee","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_text.json_activities","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":260,"wires":[["4b68efecf1da94d1"]]},{"id":"4b68efecf1da94d1","type":"json","z":"a62a0ee8573c9b72","name":"","property":"payload","action":"","pretty":false,"x":250,"y":260,"wires":[["0429572f34c1181a"]]},{"id":"1774a2b5f618d01d","type":"subflow:3846091448eb9a09","z":"a62a0ee8573c9b72","name":"","env":[],"x":710,"y":40,"wires":[]},{"id":"b1fa06090656fd52","type":"catch","z":"a62a0ee8573c9b72","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["74f70af5292cd7f0"]]},{"id":"467ecbfa6d0fc6f5","type":"subflow:e6ac576fb4598283","z":"a62a0ee8573c9b72","name":"","x":670,"y":260,"wires":[["605a6fcdec6e7dea"],[]]},{"id":"80e4c7b3fed93d58","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"sun","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"above_horizon","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":180,"wires":[["4738db7b46027420"],[]]},{"id":"565a47b4c56c5090","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motivation_resend","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.motivation_resend","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":130,"y":120,"wires":[["b7272d98fbf8706e"],[]]},{"id":"b7272d98fbf8706e","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motivation_resend off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_resend"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":120,"wires":[["4d734662885861d4"]]},{"id":"195ea958794de3f1","type":"function","z":"a62a0ee8573c9b72","name":"prepare activities for today","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\nlet title = \"Sport & SantÃ©\";\nlet msgs = [];\n\nif (activities[\"mesure\"][2]) {\n    msgs.push({ title: title, message: \"Se peser\", type: \"mesure\" });\n}\n\nif (activities[\"stretching\"][2]) {\n    msgs.push({ title: title, message: \"Une sÃ©ance d'Ã©tirement est prÃ©vue\", type: \"stretching\" });\n}\n\nif (activities[\"walk\"][2]) {\n    msgs.push({ title: title, message: \"Une marche est prÃ©vue\", type: \"walk\" });\n}\n\nif (activities[\"run\"][2]) {\n    msgs.push({ title: title, message: \"Une course est prÃ©vue\", type: \"run\" });\n}\n\nif (activities[\"fitness\"][2]) {\n    msgs.push({ title: title, message: \"Une sÃ©ance de musculation est prÃ©vue\", type: \"fitness\" });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":180,"wires":[["6981cbd208078aa7"]]},{"id":"4a161c195a4c8183","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.data = { actions: [{ \"action\": msg.type, \"title\": \"Fait avec amour\" }, { \"action\": \"0\", \"title\": \"pas fait\" }] };\nmsg.sendMobile = true;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":120,"wires":[["b5f1fd6eac80b150"]]},{"id":"b5f1fd6eac80b150","type":"subflow:ba09e97f2ed22f2b","z":"a62a0ee8573c9b72","name":"","x":1040,"y":120,"wires":[]},{"id":"4d734662885861d4","type":"function","z":"a62a0ee8573c9b72","name":"resend week activities","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\nlet title = \"SantÃ©: \";\nlet msgs = [];\n\nloadActivities(\"mesure\", \"Se peser\");\nloadActivities(\"stretching\", \"Une sÃ©ance d'Ã©tirement est prÃ©vue\");\nloadActivities(\"walk\", \"Une marche est prÃ©vue\");\nloadActivities(\"run\", \"Une course est prÃ©vue\");\nloadActivities(\"fitness\", \"Une sÃ©ance de musculation est prÃ©vue\");\n\nreturn [msgs];\n\nfunction loadActivities(activityType, message) {\n    for (let i = activities[activityType][0]; i < activities[activityType][1]; i++) {\n        msgs.push({ title: title, message: message, type: activityType });\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":120,"wires":[["271c98b81e4c60be"]]},{"id":"2b8a6446b97c275d","type":"subflow:ad3b29a5dd67898f","z":"a62a0ee8573c9b72","name":"","x":460,"y":40,"wires":[]},{"id":"74f70af5292cd7f0","type":"change","z":"a62a0ee8573c9b72","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"sport","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["2b8a6446b97c275d"]]},{"id":"271c98b81e4c60be","type":"link out","z":"a62a0ee8573c9b72","name":"link out 238","mode":"link","links":["0ab7eb9ee8e849b9"],"x":695,"y":120,"wires":[]},{"id":"0ab7eb9ee8e849b9","type":"link in","z":"a62a0ee8573c9b72","name":"link in 236","links":["271c98b81e4c60be","6981cbd208078aa7"],"x":755,"y":120,"wires":[["4a161c195a4c8183"]]},{"id":"6981cbd208078aa7","type":"link out","z":"a62a0ee8573c9b72","name":"link out 239","mode":"link","links":["594562288aa3dadd","0ab7eb9ee8e849b9"],"x":1335,"y":180,"wires":[]},{"id":"3c216bb3ba5c50da","type":"subflow:dbf17bea6affd2ec","z":"a62a0ee8573c9b72","name":"","x":890,"y":320,"wires":[]},{"id":"b079abeb62017956","type":"change","z":"a62a0ee8573c9b72","name":"sound","rules":[{"t":"set","p":"sound","pt":"msg","to":"win.mp3","tot":"str"},{"t":"set","p":"volumeLevel","pt":"msg","to":"0.6","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":320,"wires":[["a04b624c11672d09"]]},{"id":"34b0f91244589587","type":"link out","z":"a62a0ee8573c9b72","name":"link out 240","mode":"link","links":["d0a58f4c96e9c4e3","1ac9e1f9d270db35"],"x":555,"y":260,"wires":[]},{"id":"d0a58f4c96e9c4e3","type":"link in","z":"a62a0ee8573c9b72","name":"link in 237","links":["34b0f91244589587"],"x":415,"y":380,"wires":[["4c2b1b5ac50cc378"]]},{"id":"1ac9e1f9d270db35","type":"link in","z":"a62a0ee8573c9b72","name":"link in 238","links":["49947236b125db38","34b0f91244589587"],"x":55,"y":380,"wires":[["581bd663e32209c1"]]},{"id":"c437e0a422479e97","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.title = \"Option SantÃ©: ActivÃ©e\";\nmsg.message = \"Tu fais le bon choix. Reste motivÃ©.\";\nmsg.sendMobile = true;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":540,"wires":[["0ece54a40b22328b"]]},{"id":"8640a3a14306a54b","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motiv","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.motivation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":540,"wires":[["7dd9d25ba50a5fa4","a80c33edb870c5b1"],[]]},{"id":"7dd9d25ba50a5fa4","type":"function","z":"a62a0ee8573c9b72","name":"reinit activities","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state);\nlet init = [0, 0, false];\n\nif (Object.keys(activities).length == 0) {\n    activities = { \"walk\": [0, 0, false], \"run\": [0, 0, false], \"fitness\": [0, 0, false], \"stretching\": [0, 0, false], \"mesure\": [0, 0, false] };\n}\n\nactivities[\"walk\"] = init;\nactivities[\"run\"] = init;\nactivities[\"fitness\"] = init;\nactivities[\"stretching\"] = init;\nactivities[\"mesure\"] = init;\n\nmsg.payload = { \"data\": { \"value\": JSON.stringify(activities) } };\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":540,"wires":[["0f303a07aee53ece"]]},{"id":"0f303a07aee53ece","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":410,"y":540,"wires":[[]]},{"id":"0ece54a40b22328b","type":"subflow:ba09e97f2ed22f2b","z":"a62a0ee8573c9b72","name":"","x":740,"y":540,"wires":[]},{"id":"a04b624c11672d09","type":"ha-wait-until","z":"a62a0ee8573c9b72","name":"wait until home","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"input_boolean.in_home_zone","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"4","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":560,"y":320,"wires":[["77dd447fc12f94fb"],[]]},{"id":"47ed8e2b327dccf0","type":"delay","z":"a62a0ee8573c9b72","name":"","pauseType":"delay","timeout":"9","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":280,"y":320,"wires":[["0c3f3ed299e670ca"]]},{"id":"0c3f3ed299e670ca","type":"change","z":"a62a0ee8573c9b72","name":"speak","rules":[{"t":"set","p":"speak","pt":"msg","to":"Vous avez terminÃ© vos objectifs de la journÃ©e. Ohhh hiÃ¨Ã¨Ã¨Ã¨Ã¨ bro !","tot":"str"},{"t":"set","p":"volumeLevel","pt":"msg","to":"0.6","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":320,"wires":[["a04b624c11672d09"]]},{"id":"78dba95788419f7e","type":"link out","z":"a62a0ee8573c9b72","name":"link out 241","mode":"link","links":["35f30657dc9a7253"],"x":955,"y":260,"wires":[]},{"id":"35f30657dc9a7253","type":"link in","z":"a62a0ee8573c9b72","name":"link in 239","links":["78dba95788419f7e"],"x":55,"y":320,"wires":[["b079abeb62017956","47ed8e2b327dccf0"]]},{"id":"77dd447fc12f94fb","type":"delay","z":"a62a0ee8573c9b72","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":720,"y":320,"wires":[["3c216bb3ba5c50da"]]},{"id":"fdaf52796d22e4f8","type":"link in","z":"a62a0ee8573c9b72","name":"link in 418","links":["08a2e534e6dd4397","f69da4c4a60e5983"],"x":675,"y":180,"wires":[["ee994c7a4cf2b1e5"]]},{"id":"b301563aef7664dc","type":"function","z":"a62a0ee8573c9b72","name":"get alarms","func":"let persons = global.get(\"persons\") || {};\n\nfor (let key of Object.keys(persons)) {\n    if (\"alarm\" in persons[key] && persons[key].alarm == msg.currentTime) {\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":180,"wires":[["195ea958794de3f1"]]},{"id":"f38f72a9a33e9329","type":"function","z":"a62a0ee8573c9b72","name":"no alarm today","func":"let persons = global.get(\"persons\") || {};\n\nfor (let key of Object.keys(persons)) {\n    let validAlarm = \"alarm\" in persons[key] && persons[key].alarm.search(/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}/g) != -1;\n    if (validAlarm && persons[key].alarm.split(\" \")[0] != msg.payload) {\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":180,"wires":[["195ea958794de3f1"]]},{"id":"e7e6f923a633831a","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"module_healthy","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_healty","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":600,"wires":[["8f546715d338a376","ea3fb831dea35c4d"]]},{"id":"8f546715d338a376","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.notification_id = \"module_healthy\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module Sport et santÃ© dÃ©sactivÃ©\";\n    msg.message = \"Module Sport et santÃ© dÃ©sactivÃ©, vous ne recevrez plus de notifications\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":600,"wires":[["3b3dd6b16a5c5a1d"]]},{"id":"3b3dd6b16a5c5a1d","type":"link out","z":"a62a0ee8573c9b72","name":"link out 416","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":515,"y":600,"wires":[]},{"id":"ea3fb831dea35c4d","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motiv","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_{{payload}}","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":270,"y":600,"wires":[[]]},{"id":"ee994c7a4cf2b1e5","type":"api-current-state","z":"a62a0ee8573c9b72","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":800,"y":180,"wires":[["b301563aef7664dc"],[]]},{"id":"4738db7b46027420","type":"api-current-state","z":"a62a0ee8573c9b72","name":"motivation on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":240,"y":180,"wires":[["fe45daa9a9301e7b"],[]]},{"id":"fe45daa9a9301e7b","type":"function","z":"a62a0ee8573c9b72","name":"get date","func":"let d = new Date();\nlet year = d.getFullYear();\nlet month = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1);\nlet day = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n\nmsg.currentTime = year + \"-\" + month + \"-\" + day;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":180,"wires":[["f38f72a9a33e9329"]]},{"id":"3a335bfb2e72f42a","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"github update","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.lemuriens_coconut_latest_commit","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":180,"wires":[["6bca473d1c40e349"]]},{"id":"0b58061cac0414bc","type":"catch","z":"22b4130fe1f6a28b","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["5628c3b6e6e05cc2"]]},{"id":"8308b45e584b06f6","type":"subflow:ad3b29a5dd67898f","z":"22b4130fe1f6a28b","name":"","x":460,"y":40,"wires":[]},{"id":"5628c3b6e6e05cc2","type":"change","z":"22b4130fe1f6a28b","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Github","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8308b45e584b06f6"]]},{"id":"df4af56f9ed72f66","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update available on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":390,"y":480,"wires":[["cf2657d204eb2c9f"]]},{"id":"4392c27b07392a2e","type":"api-call-service","z":"22b4130fe1f6a28b","name":"restart node-red","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"hassio","service":"addon_restart","areaId":[],"deviceId":[],"entityId":[],"data":"{\"addon\":\"{{addon}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":620,"y":420,"wires":[[]]},{"id":"8b90ccdbc66dac03","type":"function","z":"22b4130fe1f6a28b","name":"get node-red addon","func":"let nodeRed = global.get('homeassistant').homeAssistant.states[\"update.node_red_update\"];\nlet checkPass = \"attributes\" in nodeRed && \"entity_picture\" in nodeRed.attributes && nodeRed.attributes.entity_picture != \"\";\n\nif (checkPass) {\n    msg.addon = nodeRed.attributes.entity_picture.replace(\"/api/hassio/addons/\", \"\").replace(\"/icon\", \"\");\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":420,"wires":[["4392c27b07392a2e"]]},{"id":"19c67d2aca8dacf4","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":430,"y":360,"wires":[["a84852adfbcf0f82"],[],[]]},{"id":"a84852adfbcf0f82","type":"switch","z":"22b4130fe1f6a28b","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":560,"y":360,"wires":[["6b594e58c4deee27"]]},{"id":"6b594e58c4deee27","type":"link out","z":"22b4130fe1f6a28b","name":"link out 428","mode":"link","links":["e88b205d1a3b0ecc","db6ed825fa8ec8e2","110190f367ccfb85"],"x":655,"y":360,"wires":[]},{"id":"c1d14ac0a4c78950","type":"template","z":"22b4130fe1f6a28b","name":"git pull","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cd /config\ngit reset --hard HEAD\ngit pull -f https://github.com/lemuriens/combava.git","output":"str","x":310,"y":360,"wires":[["19c67d2aca8dacf4"]]},{"id":"af0c165af5996110","type":"link out","z":"22b4130fe1f6a28b","name":"link out 429","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1015,"y":180,"wires":[]},{"id":"298b1c45c4d0b500","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"new_update_available\";\nmsg.title = \"Mise Ã  jour disponible ðŸŽ‰\";\nmsg.alertType = \"success\";\nmsg.message = \"Des nouveautÃ©s sont disponibles pour ðŸ¥¥\";\nmsg.data = { actions: [{ \"action\": \"do_update\", \"title\": \"Mettre Ã  jour\" }] };\nmsg.sendMobile = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":180,"wires":[["af0c165af5996110"]]},{"id":"a0f5e36615e385c8","type":"api-call-service","z":"22b4130fe1f6a28b","name":"","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"homeassistant","service":"reload_all","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":210,"y":420,"wires":[["8b90ccdbc66dac03"]]},{"id":"aab0f034678b38fc","type":"comment","z":"22b4130fe1f6a28b","name":"Github PULL","info":"","x":110,"y":120,"wires":[]},{"id":"110190f367ccfb85","type":"link in","z":"22b4130fe1f6a28b","name":"link in 436","links":["523bebf570571714","6b594e58c4deee27"],"x":55,"y":420,"wires":[["a0f5e36615e385c8"]]},{"id":"73e582bba532abcd","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update validated","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":300,"wires":[["3f58fc642c3feedb","2b3edb3f3845716f"]]},{"id":"3f58fc642c3feedb","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"new_update_available\";\nmsg.dismiss = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":300,"wires":[["9a6820da31f5f8c4"]]},{"id":"9a6820da31f5f8c4","type":"link out","z":"22b4130fe1f6a28b","name":"link out 431","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":1155,"y":300,"wires":[]},{"id":"2b3edb3f3845716f","type":"link out","z":"22b4130fe1f6a28b","name":"link out 432","mode":"link","links":["d6e719e8cc85424f"],"x":1205,"y":300,"wires":[]},{"id":"d6e719e8cc85424f","type":"link in","z":"22b4130fe1f6a28b","name":"link in 437","links":["2b3edb3f3845716f"],"x":55,"y":360,"wires":[["88ce8957d8839f95"]]},{"id":"88ce8957d8839f95","type":"subflow:515fe2385f553c95","z":"22b4130fe1f6a28b","name":"","x":170,"y":360,"wires":[[],["c1d14ac0a4c78950"]]},{"id":"e34e640e14f1f461","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update validated off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":190,"y":480,"wires":[["df4af56f9ed72f66"]]},{"id":"a68c58a2f555156f","type":"link out","z":"22b4130fe1f6a28b","name":"link out 518","mode":"link","links":["36f37724270a3883"],"x":775,"y":240,"wires":[]},{"id":"36f37724270a3883","type":"link in","z":"22b4130fe1f6a28b","name":"link in 478","links":["a68c58a2f555156f","d19000a767ba5e72"],"x":635,"y":300,"wires":[["73e582bba532abcd"]]},{"id":"cd33a20bd7aa444d","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"update","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.update_from_lemuriens_coconut","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":730,"y":300,"wires":[["73e582bba532abcd"],[]]},{"id":"72a35a1065bd206c","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_update","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":560,"wires":[["d83697681a841be5"]]},{"id":"d83697681a841be5","type":"function","z":"22b4130fe1f6a28b","name":"notification","func":"msg.notification_id = \"module_update\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"info\";\n    msg.title = \"Module mises Ã  jour automatique dÃ©sactivÃ©\";\n    msg.message = \"Module mises Ã  jour automatique dÃ©sactivÃ©, vous recevrez une notification lorsqu'une mise Ã  jour est disponible.\";\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":560,"wires":[["4d571b7c3108dd2f"]]},{"id":"4d571b7c3108dd2f","type":"link out","z":"22b4130fe1f6a28b","name":"link out 519","mode":"link","links":["4fcc3b49d98a2c1f","e53334a6f05a9609"],"x":395,"y":560,"wires":[]},{"id":"e328f1a3be2dcdfa","type":"ha-time","z":"22b4130fe1f6a28b","name":"update_at","server":"c87720f17866318d","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityId":"input_datetime.update_at","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"debugenabled":false,"x":100,"y":240,"wires":[["7d21153d9385e445"]]},{"id":"695cc55f54dc799f","type":"api-current-state","z":"22b4130fe1f6a28b","name":"update_available ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.update_available_on_lemuriens_coconut","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":650,"y":240,"wires":[["a68c58a2f555156f"],[]]},{"id":"6bca473d1c40e349","type":"api-current-state","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":280,"y":180,"wires":[["1b50b093ec877908"],["dc40d6ce64930b70"]]},{"id":"4cc115cfe408499c","type":"link out","z":"22b4130fe1f6a28b","name":"link out 520","mode":"link","links":["f653e56d38a91ee4"],"x":595,"y":180,"wires":[]},{"id":"b130a4ed6345f4d5","type":"link in","z":"22b4130fe1f6a28b","name":"update available on","links":[],"x":55,"y":480,"wires":[["e34e640e14f1f461"]]},{"id":"cf2657d204eb2c9f","type":"link out","z":"22b4130fe1f6a28b","name":"update available on","mode":"return","links":[],"x":515,"y":480,"wires":[]},{"id":"19c209fee8b092e0","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["b130a4ed6345f4d5"],"linkType":"static","timeout":"30","x":730,"y":180,"wires":[["298b1c45c4d0b500"]]},{"id":"1b50b093ec877908","type":"link call","z":"22b4130fe1f6a28b","name":"","links":["b130a4ed6345f4d5"],"linkType":"static","timeout":"30","x":470,"y":180,"wires":[["4cc115cfe408499c"]]},{"id":"1ffe1e68b6d07b6b","type":"api-current-state","z":"22b4130fe1f6a28b","name":"immediate_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.immediate_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":510,"y":300,"wires":[["110bd61b5f805ce3"],[]]},{"id":"f653e56d38a91ee4","type":"link in","z":"22b4130fe1f6a28b","name":"link in 479","links":["4cc115cfe408499c"],"x":375,"y":300,"wires":[["1ffe1e68b6d07b6b"]]},{"id":"efb5047ece0891e1","type":"api-current-state","z":"22b4130fe1f6a28b","name":"immediate_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.immediate_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":450,"y":240,"wires":[[],["695cc55f54dc799f"]]},{"id":"7d21153d9385e445","type":"api-current-state","z":"22b4130fe1f6a28b","name":"module_update","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_update","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":260,"y":240,"wires":[["efb5047ece0891e1"],[]]},{"id":"7c15527fc574823e","type":"server-events","z":"22b4130fe1f6a28b","name":"phone receive","server":"c87720f17866318d","version":2,"eventType":"mobile_app_notification_action","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":300,"wires":[["1f7e465a76157a74"]]},{"id":"1f7e465a76157a74","type":"switch","z":"22b4130fe1f6a28b","name":"do_update","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"do_update","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":270,"y":300,"wires":[["73e582bba532abcd"]]},{"id":"f0144973b310a2bd","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.ambiance","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":470,"y":140,"wires":[["b4d134869fbfd37a"]]},{"id":"54829fc517976dce","type":"function","z":"e95b0d12eedce5f1","name":"data output html","func":"var txt = \"\";\ntxt += \"<data>\";\n\n// TEMPERATURE MAISON\nvar temp_int = global.get(\"temperatures\").salon.value || \"\";\ntxt += wrap(\"temp_int\", Math.round(temp_int * 10) / 10);\n\nvar temp_tend = global.get(\"temperatures\").salon.tendency || \"\";\ntxt += wrap(\"temp_tend\", temp_tend == 0 ? \"\" : temp_tend > 0 ? \"â†—\" : \"â†˜\");\n\n// MODE CHAUFFAGE\nvar heat_ = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.heat\"].state || \"\";\nvar heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"].state || \"\";\nif (heat_ === \"on\" && heat_temp != \"\") {\n    txt += wrap(\"warm\", \"Chauffage rÃ©glÃ© \" + (heat_temp != \"Auto\" ? \"Ã  \" + heat_temp + \"Â°C\" : \"en auto\"));\n} else {\n    txt += wrap(\"warm\", \"\");\n}\n\n// FENETRES\nvar windows_txt = global.get(\"windows_txt\") || \"\";\ntxt += wrap(\"windows_txt\", windows_txt);\n\n// DETECTION\nvar detect_time = global.get(\"detect_txt\") || \"\";\ntxt += wrap(\"detect_time\", detect_time);\n\n// STORES\nvar stores = global.get(\"stores_txt\") || \"\";\ntxt += wrap(\"stores\", stores);\n\n// BATTERIE TEL\nvar tel_bat = global.get(\"homeassistant\").homeAssistant.states[\"sensor.erwan_phone_battery_level\"].state;\ntxt += wrap(\"tel_bat\", tel_bat);\n\n// BATTERIE TAB\nvar tab_bat = global.get(\"homeassistant\").homeAssistant.states[\"sensor.lenovo_tb_x606f_bat_level\"].state;\ntxt += wrap(\"tab_bat\", tab_bat);\n\n// WEATHER CONDITION\nvar day_night = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].state === \"above_horizon\" ? \"-d\" : \"-n\";\nvar weather_condition = global.get(\"homeassistant\").homeAssistant.states[\"sensor.openweathermap_condition\"].state;\nweather_condition = (weather_condition == \"sunny\" || \"clear-night\" ? \"clear\" : weather_condition) + day_night;\ntxt += wrap(\"weather_condition\", weather_condition);\n\n// WEATHER TEMP\n//var weather_temperature = global.get(\"homeassistant\").homeAssistant.states[\"sensor.openweathermap_temperature\"].state;\nvar weather_temperature = global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_ext\"].state || \"\";\ntxt += wrap(\"weather_temperature\", Math.round(weather_temperature * 10) / 10);\n\nfunction wrap(xname, x) {\n    return \"<\" + xname + \">\" + x + \"</\" + xname + \">\";\n}\n\ntxt += \"</data>\";\nmsg.payload = txt;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":320,"wires":[["a16cd238feb3285b"]]},{"id":"a16cd238feb3285b","type":"file","z":"e95b0d12eedce5f1","name":"output file","filename":"/config/www/data_output.html","filenameType":"str","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"utf8","x":840,"y":320,"wires":[[]]},{"id":"fb592c3ab3282599","type":"api-current-state","z":"e95b0d12eedce5f1","name":"pc power on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.pc_power","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":480,"y":280,"wires":[["54829fc517976dce"],[]]},{"id":"4b590ce967a4cb52","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.headset","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":200,"wires":[["3e65cbca90000453"]]},{"id":"3e65cbca90000453","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.headset","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":770,"y":200,"wires":[["adc183ec48306d93"],["2a514dd26c44a0be"]]},{"id":"adc183ec48306d93","type":"api-call-service","z":"e95b0d12eedce5f1","name":"headset on","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.headset"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":910,"y":200,"wires":[[]]},{"id":"2a514dd26c44a0be","type":"api-call-service","z":"e95b0d12eedce5f1","name":"headset off","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.headset"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":910,"y":260,"wires":[[]]},{"id":"ec6cbe8654c945b4","type":"api-current-state","z":"e95b0d12eedce5f1","name":"pc power on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.pc_power","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":500,"y":200,"wires":[["4b590ce967a4cb52"],[]]},{"id":"9204e7f3dbc8e8b1","type":"inject","z":"e95b0d12eedce5f1","name":"when pc is off","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1800","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":360,"wires":[["43250a3f8ade7e27"]]},{"id":"9c0d86726b790cce","type":"inject","z":"e95b0d12eedce5f1","name":"when pc is on","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"600","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":280,"wires":[["56279145958839cc"]]},{"id":"579a3b8b6998fbda","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.gsound","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":470,"y":440,"wires":[["abb8708d1dc3e2e1","259d65aecdf17fbf"]]},{"id":"abb8708d1dc3e2e1","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.gsound","propertyType":"msg","rules":[{"t":"eq","v":"plus","vt":"str"},{"t":"eq","v":"minus","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":590,"y":440,"wires":[["b3935767ad51d33a"],["cbb0d8cf07f8b882"]]},{"id":"b3935767ad51d33a","type":"api-call-service","z":"e95b0d12eedce5f1","name":"google_home plus","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":750,"y":440,"wires":[[]]},{"id":"cbb0d8cf07f8b882","type":"api-call-service","z":"e95b0d12eedce5f1","name":"google_home minus","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_down","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":960,"y":440,"wires":[[]]},{"id":"c8dad96f217ca187","type":"api-call-service","z":"e95b0d12eedce5f1","name":"google_home mute","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"{\"is_volume_muted\":{{payload}}}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":570,"y":500,"wires":[["218464f8b007c52d"]]},{"id":"f3cf41499bf744f4","type":"api-current-state","z":"e95b0d12eedce5f1","name":"google home ?","server":"c87720f17866318d","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.google_home","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":240,"y":500,"wires":[["c9d1f6de4f45ce6b"]]},{"id":"259d65aecdf17fbf","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.gsound","propertyType":"msg","rules":[{"t":"eq","v":"mute","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":90,"y":500,"wires":[["f3cf41499bf744f4"]]},{"id":"c9d1f6de4f45ce6b","type":"function","z":"e95b0d12eedce5f1","name":"","func":"msg.payload = !msg.data.attributes.is_volume_muted;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":500,"wires":[["c8dad96f217ca187"]]},{"id":"218464f8b007c52d","type":"ha-wait-until","z":"e95b0d12eedce5f1","name":"","server":"c87720f17866318d","version":2,"outputs":2,"entityId":"input_select.ambiance","entityIdFilterType":"exact","property":"state","comparator":"is","value":"ArrÃªt","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":740,"y":500,"wires":[["df630f4194f2812d"],["df630f4194f2812d"]]},{"id":"df630f4194f2812d","type":"api-call-service","z":"e95b0d12eedce5f1","name":"google_home unmute","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"{\"is_volume_muted\":false}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":500,"wires":[["5cfba14dd6398fbb"]]},{"id":"5cfba14dd6398fbb","type":"api-call-service","z":"e95b0d12eedce5f1","name":"vol 0.4","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"{\"volume_level\":\"0.4\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":500,"wires":[[]]},{"id":"a954b64cd31251d2","type":"catch","z":"e95b0d12eedce5f1","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["b1484d7f72503893"]]},{"id":"41184a6508b50019","type":"subflow:e6ac576fb4598283","z":"e95b0d12eedce5f1","name":"","x":330,"y":140,"wires":[["f0144973b310a2bd"],[]]},{"id":"482280cd4ac3293d","type":"subflow:e6ac576fb4598283","z":"e95b0d12eedce5f1","name":"","x":330,"y":200,"wires":[["ec6cbe8654c945b4"],[]]},{"id":"a7084d2b1ae17538","type":"subflow:e6ac576fb4598283","z":"e95b0d12eedce5f1","name":"","x":330,"y":440,"wires":[["579a3b8b6998fbda"],[]]},{"id":"b4d134869fbfd37a","type":"change","z":"e95b0d12eedce5f1","name":"","rules":[{"t":"set","p":"ambiance_type","pt":"msg","to":"payload.event.ambiance","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":140,"wires":[["911592d8210d2318"]]},{"id":"911592d8210d2318","type":"change","z":"e95b0d12eedce5f1","name":"delete","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":140,"wires":[["7bbb76382f27c5a7"]]},{"id":"7bbb76382f27c5a7","type":"api-call-service","z":"e95b0d12eedce5f1","name":"set ambiance","server":"c87720f17866318d","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":["input_select.ambiance_salon"],"data":"{\"option\":\"{{ambiance_type}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":970,"y":140,"wires":[[]]},{"id":"8296e43d9698045c","type":"subflow:ad3b29a5dd67898f","z":"e95b0d12eedce5f1","name":"","x":460,"y":40,"wires":[]},{"id":"b1484d7f72503893","type":"change","z":"e95b0d12eedce5f1","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Rainmeter","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8296e43d9698045c"]]},{"id":"7b55ab76ade5ab83","type":"api-current-state","z":"e95b0d12eedce5f1","name":"pc power on ?","server":"c87720f17866318d","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.pc_power","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":480,"y":360,"wires":[[],["54829fc517976dce"]]},{"id":"c167de7c43c4df58","type":"subflow:515fe2385f553c95","z":"e95b0d12eedce5f1","name":"","x":170,"y":140,"wires":[["41184a6508b50019"],[]]},{"id":"f48a802df42dde73","type":"subflow:515fe2385f553c95","z":"e95b0d12eedce5f1","name":"","x":170,"y":200,"wires":[["482280cd4ac3293d"],[]]},{"id":"56279145958839cc","type":"subflow:515fe2385f553c95","z":"e95b0d12eedce5f1","name":"","x":310,"y":280,"wires":[["fb592c3ab3282599"],[]]},{"id":"43250a3f8ade7e27","type":"subflow:515fe2385f553c95","z":"e95b0d12eedce5f1","name":"","x":310,"y":360,"wires":[["7b55ab76ade5ab83"],[]]},{"id":"f081c12a018f74ae","type":"subflow:515fe2385f553c95","z":"e95b0d12eedce5f1","name":"","x":170,"y":440,"wires":[["a7084d2b1ae17538"],[]]},{"id":"dde6233e9fa241da","type":"link in","z":"e95b0d12eedce5f1","name":"link in 458","links":["4273df0f344b10d3","2c3b171b6098c1bb"],"x":55,"y":140,"wires":[["c167de7c43c4df58"]]},{"id":"b658443c78631d97","type":"link in","z":"e95b0d12eedce5f1","name":"link in 459","links":["4273df0f344b10d3","2c3b171b6098c1bb"],"x":55,"y":200,"wires":[["f48a802df42dde73"]]},{"id":"363cd01fc9141708","type":"link in","z":"e95b0d12eedce5f1","name":"link in 460","links":["4273df0f344b10d3","2c3b171b6098c1bb"],"x":55,"y":440,"wires":[["f081c12a018f74ae"]]}]